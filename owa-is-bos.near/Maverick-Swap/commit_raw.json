{"tx_hash": "3rGzqTg8XWAhPpSr3gMaJz9pbG1YE3u5Y77n4AMDaR8W", "action_id_social": "GuLX5CEsyn9PRS2GycWWJmDuvTZctJX5csLP5Kkh5EAi-0-widget", "block_id": 99886255, "block_timestamp": "2023-08-28T23:26:42.993Z", "signer_id": "owa-is-bos.near", "widget_name": "Maverick-Swap", "source_code": "const routerAbi = fetch(\n  \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/maverick-router.txt\"\n);\nif (!routerAbi.ok) {\n  return \"Loading\";\n}\n\nconst TOKENS = [\n  //{\n  //name: \"ETH\",\n  //icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/eth.svg\",\n  //address: \"0x5AEa5775959fBC2557Cc8789bC1bf90A239D9a91\",\n  //coinGeckoId: \"ethereum\",\n  //decimals: 18,\n  //},\n  {\n    name: \"USDC\",\n    icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/usdc.svg\",\n    address: \"0x3355df6D4c9C3035724Fd0e3914dE96A5a83aaf4\",\n    coinGeckoId: \"usd-coin\",\n    decimals: 6,\n  },\n  {\n    name: \"CBUSD\",\n    icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/busd.png\",\n    address: \"0x2039bb4116B4EFc145Ec4f0e2eA75012D6C0f181\",\n    coinGeckoId: \"binance-usd\",\n    decimals: 18,\n  },\n  {\n    name: \"MAV\",\n    icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/mav.png\",\n    address: \"0x787c09494Ec8Bcb24DcAf8659E7d5D69979eE508\",\n    coinGeckoId: \"maverick-protocol\",\n    decimals: 18,\n  },\n  {\n    name: \"LUSD\",\n    icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/lusd.svg\",\n    address: \"0x503234F203fC7Eb888EEC8513210612a43Cf6115\",\n    coinGeckoId: \"liquity-usd\",\n    decimals: 18,\n  },\n  {\n    name: \"RETH\",\n    icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/reth.png\",\n    address: \"0x32Fd44bB869620C0EF993754c8a00Be67C464806\",\n    coinGeckoId: \"rocket-pool-eth\",\n    decimals: 18,\n  },\n  {\n    name: \"CBETH\",\n    icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/cbeth.png\",\n    address: \"0x75Af292c1c9a37b3EA2E6041168B4E48875b9ED5\",\n    coinGeckoId: \"coinbase-wrapped-staked-eth\",\n    decimals: 18,\n  },\n  {\n    name: \"USD+\",\n    icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/usd+.png\",\n    address: \"0x8E86e46278518EFc1C5CEd245cBA2C7e3ef11557\",\n    coinGeckoId: \"usd\",\n    decimals: 6,\n  },\n  {\n    name: \"GRAI\",\n    icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/grai.png\",\n    address: \"0x5FC44E95eaa48F9eB84Be17bd3aC66B6A82Af709\",\n    coinGeckoId: \"grai\",\n    decimals: 18,\n  },\n  {\n    name: \"FRAX\",\n    icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/frax.png\",\n    address: \"0xb4C1544cb4163f4C2ECa1aE9Ce999F63892d912A\",\n    coinGeckoId: \"frax\",\n    decimals: 18,\n  },\n  {\n    name: \"WETH\",\n    icon: \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/weth.png\",\n    address: \"0x5AEa5775959fBC2557Cc8789bC1bf90A239D9a91\",\n    coinGeckoId: \"ethereum\",\n    decimals: 18,\n  },\n];\n\nconst POOLS = [\n  { name: \"WETH-USDC\", address: \"0x41c8cf74c27554a8972d3bf3d2bd4a14d8b604ab\" },\n  { name: \"WETH-CBUSD\", address: \"0x3Ae63FB198652E294B8DE4C2EF659D95D5ff28BE\" },\n  { name: \"WETH-MAV\", address: \"0x4D47167e66e86d1a1083f52136832d4f1eF5809A\" },\n  { name: \"WETH-LUSD\", address: \"0xB1338207DE233aE6a9A6D63309221b577F8Cd6E8\" },\n  { name: \"WETH-RETH\", address: \"0x07e1F845819D7CABc03684fdb4Bf99D5cd2B2964\" },\n  { name: \"WETH-CBETH\", address: \"0x23e8d6269717C567e4A2E9680491C8c65B67Ad0d\" },\n  { name: \"WETH-USD+\", address: \"0x15461e7D0d6061e082b2c9B641634BB096527679\" },\n  { name: \"WETH-GRAI\", address: \"\" },\n  { name: \"WETH-FRAX\", address: \"\" },\n  { name: \"USDC-CBUSD\", address: \"0x88D29317A355d8586bd0D98E8745ec3171d68F56\" },\n  { name: \"USDC-MAV\", address: \"0xbf90be5bbc07fbf548d3bceed34f1d471c018f34\" },\n  { name: \"USDC-LUSD\", address: \"0x6A9143A5f9BaF73841992DCB737844e5ad16A283\" },\n  { name: \"USDC-RETH\", address: \"\" },\n  { name: \"USDC-CBETH\", address: \"\" },\n  { name: \"USDC-USD+\", address: \"0xaCA5d8805D6f160Eb46E273e28169DDBF703eCdc\" },\n  { name: \"USDC-GRAI\", address: \"\" },\n  { name: \"USDC-FRAX\", address: \"0x4e1852cf46b24940412e13C358B4f19eC92b9eaE\" },\n  { name: \"CBUSD-MAV\", address: \"0x9f4A993b3120e52044810F1c91088a5630a8bF63\" },\n  { name: \"CBUSD-LUSD\", address: \"\" },\n  { name: \"CBUSD-RETH\", address: \"\" },\n  { name: \"CBUSD-CBETH\", address: \"\" },\n  { name: \"CBUSD-USD+\", address: \"\" },\n  { name: \"CBUSD-GRAI\", address: \"\" },\n  { name: \"CBUSD-FRAX\", address: \"\" },\n  { name: \"MAV-LUSD\", address: \"\" },\n  { name: \"MAV-RETH\", address: \"\" },\n  { name: \"MAV-CBETH\", address: \"\" },\n  { name: \"MAV-USD+\", address: \"\" },\n  { name: \"MAV-GRAI\", address: \"\" },\n  { name: \"MAV-FRAX\", address: \"\" },\n  { name: \"LUSD-RETH\", address: \"\" },\n  { name: \"LUSD-CBETH\", address: \"\" },\n  { name: \"LUSD-USD+\", address: \"\" },\n  { name: \"LUSD-GRAI\", address: \"0x28f57e5c2823183280CC9B3B45d746A2943111C3\" },\n  { name: \"LUSD-FRAX\", address: \"\" },\n  { name: \"RETH-CBETH\", address: \"\" },\n  { name: \"RETH-USD+\", address: \"\" },\n  { name: \"RETH-GRAI\", address: \"\" },\n  { name: \"RETH-FRAX\", address: \"\" },\n  { name: \"CBETH-USD+\", address: \"\" },\n  { name: \"CBETH-GRAI\", address: \"\" },\n  { name: \"CBETH-FRAX\", address: \"\" },\n  { name: \"USD+-GRAI\", address: \"\" },\n  { name: \"USD+-FRAX\", address: \"\" },\n  { name: \"GRAI-FRAX\", address: \"\" },\n];\n\nState.init({\n  isZkSync: false,\n  poolSelected: null,\n  tokenSendSelected: null,\n  tokenRecieveSelected: null,\n  amountInput: null,\n  amountRecieve: 0,\n  rate: 0,\n  routerContract: \"0x39E098A153Ad69834a9Dac32f0FCa92066aD03f4\",\n  onApproving: false,\n  onSwap: false,\n  needMoreAllowance: false,\n  reloadTransactions: false,\n});\n\nconst getNetwork = () => {\n  let chainId = 324;\n  Ethers.provider()\n    .getNetwork()\n    .then((res) => {\n      if (res.chainId == chainId) {\n        State.update({ isZkSync: true });\n      } else {\n        switchNetwork(324);\n      }\n    });\n};\n\nfunction handleReloadTransactions() {\n  console.log();\n  State.update({ reloadTransactions: false });\n}\n\nconst switchNetwork = (chainId) => {\n  Ethers.provider().send(\"wallet_switchEthereumChain\", [\n    { chainId: `0x${chainId.toString(16)}` },\n  ]);\n};\n\nconst getErc20Balance = (tokenId, receiver, decimals, asset) => {\n  if (state.sender === undefined) {\n    return;\n  }\n  if (asset == \"ETH\") {\n    Ethers.provider()\n      .getBalance(state.sender)\n      .then((balance) => {\n        State.update({\n          inputBalance: (\n            parseFloat(ethers.utils.formatUnits(balance, decimals)).toFixed(6) -\n            0.000001\n          ).toString(),\n          unFixedInputBalance: balance.toHexString(),\n        });\n      });\n  } else {\n    asyncFetch(\n      \"https://gist.githubusercontent.com/veox/8800debbf56e24718f9f483e1e40c35c/raw/f853187315486225002ba56e5283c1dba0556e6f/erc20.abi.json\"\n    )\n      .catch((res) => {\n        console.log(err);\n      })\n      .then((res) => {\n        const contract = new ethers.Contract(\n          tokenId,\n          res.body,\n          Ethers.provider().getSigner()\n        );\n        contract.balanceOf(receiver).then((res) => {\n          let balance = ethers.utils.formatUnits(res, decimals);\n          State.update({\n            inputBalance: parseFloat(balance - 0.000001)\n              .toFixed(6)\n              .toString(),\n            unFixedInputBalance: res.toHexString(),\n          });\n        });\n      });\n  }\n};\n\nfunction getPrice(type, data) {\n  let tokenIdForCoingeckoAPI;\n  tokenIdForCoingeckoAPI = data.coinGeckoId;\n  if (type) {\n    getErc20Balance(data.address, state.sender, data.decimals, data.name);\n  }\n  let dataUrl = `https://api.coingecko.com/api/v3/coins/${tokenIdForCoingeckoAPI}`;\n  asyncFetch(dataUrl).then((res) => {\n    const tokenData = res.body;\n    const price = Number(tokenData.market_data.current_price.usd);\n    if (\n      (state.tokenSendSelected != null || type) &&\n      (state.tokenRecieveSelected != null || !type)\n    ) {\n      type\n        ? State.update({ rate: price / state.tokenRecieveSelected.price })\n        : State.update({ rate: state.tokenSendSelected.price / price });\n    }\n    type\n      ? State.update({ tokenSendSelected: { price: price, ...data } })\n      : State.update({ tokenRecieveSelected: { price: price, ...data } });\n  });\n}\n\nconst tokenInApprovaleNeededCheck = (data) => {\n  if (data.name == \"ETH\") {\n    State.update({\n      approvalNeeded: false,\n    });\n  } else {\n    asyncFetch(\n      \"https://gist.githubusercontent.com/veox/8800debbf56e24718f9f483e1e40c35c/raw/f853187315486225002ba56e5283c1dba0556e6f/erc20.abi.json\"\n    ).then((res) => {\n      const ifaceErc20 = new ethers.utils.Interface(res.body);\n      const encodedTokenAllowancesData = ifaceErc20.encodeFunctionData(\n        \"allowance\",\n        [state.sender, state.routerContract]\n      );\n      return Ethers.provider()\n        .call({\n          to: data.address,\n          data: encodedTokenAllowancesData,\n        })\n        .then((encodedTokenAllowanceHex) => {\n          const tokenAllowance = ifaceErc20.decodeFunctionResult(\n            \"allowance\",\n            encodedTokenAllowanceHex\n          );\n          if (tokenAllowance) {\n            State.update({\n              approvalNeeded: new Big(tokenAllowance).toFixed() == \"0\",\n            });\n          } else {\n            State.update({\n              approvalNeeded: false,\n            });\n          }\n        });\n    });\n  }\n};\n\nconst getAccountAllowance = (token, vAllowance) => {\n  asyncFetch(\n    \"https://gist.githubusercontent.com/veox/8800debbf56e24718f9f483e1e40c35c/raw/f853187315486225002ba56e5283c1dba0556e6f/erc20.abi.json\"\n  ).then((res) => {\n    const approveContract = new ethers.Contract(\n      token.address,\n      res.body,\n      Ethers.provider().getSigner()\n    );\n    approveContract\n      .allowance(state.sender, state.routerContract)\n      .then((res) => {\n        State.update({ tokenAllowance: parseInt(res.toString()) });\n        if (vAllowance) {\n          validateAllowance(state.amountInput, parseInt(res.toString()));\n        }\n        console.log(\"Allowance actual: \" + parseInt(res.toString()));\n      });\n  });\n};\n\nconst approveErc20Token = () => {\n  asyncFetch(\n    \"https://gist.githubusercontent.com/veox/8800debbf56e24718f9f483e1e40c35c/raw/f853187315486225002ba56e5283c1dba0556e6f/erc20.abi.json\"\n  ).then((res) => {\n    const value = state.unFixedInputBalance;\n\n    const approveContract = new ethers.Contract(\n      state.tokenSendSelected.address,\n      res.body,\n      Ethers.provider().getSigner()\n    );\n\n    let gasArgs = {};\n\n    if (gweiPrice !== undefined && gasLimit !== undefined) {\n      gasArgs.gasPrice = ethers.utils.parseUnits(gweiPrice ?? \"0.26\", \"gwei\");\n      gasArgs.gasLimit = gasLimit ?? 20000000;\n    }\n\n    approveContract\n      .approve(state.routerContract, value, gasArgs)\n      .then((transactionHash) => {\n        State.update({\n          onApproving: true,\n        });\n        setTimeout(() => {\n          State.update({\n            onApproving: false,\n            approvalNeeded: false,\n          });\n          getAccountAllowance(state.tokenSendSelected, true);\n        }, 20000);\n      });\n  });\n};\n\nif (state.sender === undefined) {\n  const accounts = Ethers.send(\"eth_requestAccounts\", []);\n  if (accounts.length) {\n    State.update({ sender: accounts[0] });\n    getNetwork();\n  }\n}\n\nconst handleSendSelect = (data) => {\n  State.update({\n    amountInput: \"\",\n  });\n  const token = TOKENS.find((token) => token.name === data.target.value);\n  getPrice(true, token);\n  tokenInApprovaleNeededCheck(token);\n  getAccountAllowance(token, true);\n};\n\nconst handleRecieveSelect = (data) => {\n  const token = TOKENS.find((token) => token.name === data.target.value);\n  getPrice(false, token);\n};\n\nconst turnTokens = () => {\n  const tokenSendSelected = state.tokenSendSelected;\n  const tokenRecieveSelected = state.tokenRecieveSelected;\n  getAccountAllowance(tokenRecieveSelected);\n  if (tokenSendSelected && tokenRecieveSelected) {\n    State.update({ tokenSendSelected: null, tokenRecieveSelected: null });\n    setTimeout(() => {\n      State.update({\n        amountInput: \"\",\n        tokenSendSelected: tokenRecieveSelected,\n        tokenRecieveSelected: tokenSendSelected,\n      });\n      getErc20Balance(\n        tokenRecieveSelected.address,\n        state.sender,\n        tokenRecieveSelected.decimals,\n        tokenRecieveSelected.name\n      );\n      const price = Number(tokenRecieveSelected.price);\n      State.update({ rate: price / tokenSendSelected.price });\n      tokenInApprovaleNeededCheck(tokenRecieveSelected);\n    });\n  }\n};\n\nconst cantSwap = () => {\n  return (\n    state.tokenSendSelected && state.tokenRecieveSelected && state.amountInput\n  );\n};\n\nconst existPool = () => {\n  const poolName1 = `${state.tokenSendSelected.name}-${state.tokenRecieveSelected.name}`;\n  const poolName2 = `${state.tokenRecieveSelected.name}-${state.tokenSendSelected.name}`;\n\n  if (!state.tokenSendSelected.name || !state.tokenRecieveSelected.name) {\n    return true;\n  }\n\n  const pool = POOLS.find((p) => p.name === poolName1 || p.name === poolName2);\n\n  if (pool && pool.address != \"\") {\n    State.update({ poolSelected: pool.address });\n    return true;\n  } else {\n    return false;\n  }\n};\n\nconst isSufficientBalance = () => {\n  if (!state.amountInput) {\n    return true;\n  } else if (state.amountInput > state.inputBalance) {\n    return false;\n  }\n  return true;\n};\n\nconst setMaxBalance = () => {\n  if (state.inputBalance > 0) {\n    State.update({ amountInput: state.inputBalance });\n    validateAllowance(state.inputBalance);\n  }\n};\n\nconst confirmTransaction = () => {\n  const router = new ethers.Contract(\n    state.routerContract,\n    routerAbi.body,\n    Ethers.provider().getSigner()\n  );\n  let amountIn = ethers.utils.parseUnits(\n    state.amountInput,\n    state.tokenSendSelected.decimals\n  );\n  let paramsv2 = {\n    tokenIn: state.tokenSendSelected.address,\n    tokenOut: state.tokenRecieveSelected.address,\n    pool: state.poolSelected,\n    recipient: state.sender,\n    deadline: 1e13,\n    amountIn: amountIn,\n    amountOutMinimum: 0,\n    sqrtPriceLimitD18: 0,\n  };\n  let amountIn2 = ethers.utils.parseUnits(\n    \"0\",\n    state.tokenSendSelected.decimals\n  );\n  const overrides = {\n    value: amountIn2,\n    gasLimit: 2303039,\n  };\n  try {\n    router.exactInputSingle(paramsv2, overrides).then((res) => {\n      State.update({\n        onSwap: true,\n        reloadTransactions: true,\n      });\n      setTimeout(() => {\n        State.update({\n          tokenSendSelected: null,\n          tokenRecieveSelected: null,\n          amountInput: 0,\n          inputBalance: 0,\n          amountRecieve: 0,\n          rate: 0,\n          poolSelected: null,\n          onSwap: false,\n          reloadTransactions: true,\n        });\n      }, 15000);\n    });\n  } catch (err) {\n    console.log(err);\n  }\n};\n\nconst getRecipient = () => {\n  return (\n    state.sender.substring(0, 5) +\n    \"...\" +\n    state.sender.substring(state.sender.length - 4, state.sender.length)\n  ).toUpperCase();\n};\n\nconst validateAllowance = (input, allowanceAmount) => {\n  State.update({ amountInput: input });\n  const divider =\n    state.tokenSendSelected.decimals == 18 ? 1000000000000000000 : 1000000;\n  const tokenAllowance = allowanceAmount\n    ? allowanceAmount / divider\n    : state.tokenAllowance / divider;\n  if (input * 1 > tokenAllowance) {\n    console.log(\"Necesitas m\u00e1s allowance\");\n    State.update({ needMoreAllowance: true });\n  } else {\n    console.log(\"No necesitas m\u00e1s allowance\");\n    State.update({ needMoreAllowance: false });\n  }\n};\n\nconst css = fetch(\n  \"https://raw.githubusercontent.com/yaairnaavaa/Maverick/main/widget.css\"\n).body;\n\nif (!css) return \"\";\n\nif (!state.theme) {\n  State.update({\n    theme: styled.div`\n    ${css}\n`,\n  });\n}\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/owa-is-bos.near/widget/Maverick-Swap", "fact_widget_deployments_id": "af52b748e5c4e626043674857a0c5440", "inserted_timestamp": "2023-08-29T01:04:16.210Z", "modified_timestamp": "2023-08-29T01:04:16.210Z", "__row_index": 13}