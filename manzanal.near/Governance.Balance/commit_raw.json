{"tx_hash": "3kvyn3aVKzPwPBWygdzL9MG2wxFYYB4NPN44wxmRnUG8", "action_id_social": "BnRguVjwjhQokS2Cpd61Y9rnyJhekF71rCDeMn5XqPR1-0-widget", "block_id": 96158654, "block_timestamp": "2023-07-10T16:38:47.628Z", "signer_id": "manzanal.near", "widget_name": "Governance.Balance", "source_code": "const accountId = props.accountId ?? context.accountId;\nconst META_VOTE_CONTRACT_ID = \"meta-vote.near\";\nconst contractId = \"v003.mpip.near\";\n\nif (!accountId) return <></>;\n\nState.init({\n  inUseVotingPower: null,\n  inUseVotingPowerIsFetched: false,\n  allVotingPower: null,\n  allVotingPowerIsFetched: false,\n  nearBalance: null,\n  nearBalanceIsFetched: false,\n});\nconst yoctoToNear = (amountYocto) =>\n  new Big(amountYocto).div(new Big(10).pow(24)).toFixed(0);\n\nconst numberWithCommas = (x) =>\n  x.toString().replace(/\\B(?<!\\.\\d*)(?=(\\d{3})+(?!\\d))/g, \",\");\n\nif (!state.allVotingPowerIsFetched) {\n  Near.asyncView(\n    META_VOTE_CONTRACT_ID,\n    \"get_all_locking_positions\",\n    { voter_id: context.accountId },\n    \"final\",\n    false\n  ).then((allLockingPositions) => {\n    const voting_power = allLockingPositions.reduce(\n      (accumulator, lockingPosition) =>\n        accumulator + parseInt(lockingPosition.voting_power),\n      0\n    );\n    State.update({\n      allVotingPower: yoctoToNear(voting_power),\n      allVotingPowerIsFetched: true,\n    });\n  });\n}\n\nif (!state.inUseVotingPowerIsFetched) {\n  Near.asyncView(\n    contractId,\n    \"get_voter_used_voting_power\",\n    { voter_id: context.accountId },\n    \"final\",\n    false\n  ).then((inUseVotingPower) =>\n    State.update({\n      inUseVotingPower: yoctoToNear(inUseVotingPower),\n      inUseVotingPowerIsFetched: true,\n    })\n  );\n}\n\nif (!state.nearBalanceIsFetched) {\n  const account = fetch(\"https://rpc.mainnet.near.org\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      jsonrpc: \"2.0\",\n      id: \"dontcare\",\n      method: \"query\",\n      params: {\n        request_type: \"view_account\",\n        finality: \"final\",\n        account_id: accountId,\n      },\n    }),\n  });\n  const { amount, storage_usage } = account.body.result;\n  const NEAR_DECIMALS = 24;\n  const COMMON_MIN_BALANCE = 0.05;\n  if (!amount) return \"-\";\n  const availableBalance = Big(amount || 0).minus(\n    Big(storage_usage).mul(Big(10).pow(19))\n  );\n  const balance = availableBalance\n    .div(Big(10).pow(NEAR_DECIMALS))\n    .minus(COMMON_MIN_BALANCE);\n\n  State.update({\n    nearBalance: balance.lt(0) ? \"0\" : balance.toFixed(5, BIG_ROUND_DOWN),\n    nearBalanceIsFetched: true,\n  });\n}\n\nconst Balances = styled.div`\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  padding: 1em 1em;\n  gap: 1em;\n  background: #eceef0;\n  border-radius: 100px;\n  flex: none;\n  order: 0;\n  flex-grow: 0;\n  font-style: normal;\n  font-weight: 600;\n  font-size: 0.9em;\n  line-height: 1em;\n  color: #11181c;\n`;\nconst wallet = (\n  <svg\n    xmlns=\"http://www.w3.org/2000/svg\"\n    width=\"24\"\n    height=\"24\"\n    fill=\"currentColor\"\n    class=\"bi bi-wallet\"\n    viewBox=\"0 0 16 16\"\n  >\n    <path d=\"M0 3a2 2 0 0 1 2-2h13.5a.5.5 0 0 1 0 1H15v2a1 1 0 0 1 1 1v8.5a1.5 1.5 0 0 1-1.5 1.5h-12A2.5 2.5 0 0 1 0 12.5V3zm1 1.732V12.5A1.5 1.5 0 0 0 2.5 14h12a.5.5 0 0 0 .5-.5V5H2a1.99 1.99 0 0 1-1-.268zM1 3a1 1 0 0 0 1 1h12V2H2a1 1 0 0 0-1 1z\" />\n  </svg>\n);\n\nif (\n  !state.allVotingPowerIsFetched ||\n  !state.inUseVotingPowerIsFetched ||\n  !state.nearBalanceIsFetched\n)\n  return <>Loading...</>;\n\nreturn (\n  <Balances>\n    {wallet}\n    <span>\n      {numberWithCommas(state.allVotingPower - state.inUseVotingPower)} VP\n    </span>\n    <span>{state.nearBalance} \u24c3</span>\n  </Balances>\n);\n", "metadata": null, "branch": {"draft": null}, "widget_modules_used": null, "widget_url": "https://near.social/#/manzanal.near/widget/Governance.Balance", "fact_widget_deployments_id": "0cb81657a3e40b470127c9056336ec89", "inserted_timestamp": "2000-01-01T00:00:00.000Z", "modified_timestamp": "2000-01-01T00:00:00.000Z", "__row_index": 4}