{"tx_hash": "4rejdLHRq1Fx7CKUBuZ6Js8kGLewVZ3yV3yy2zwXPFsx", "action_id_social": "5KFq1p6p9R7phKnEHZ4Gykz16pt7Cka8UZ2nre1CEUHK-0-widget", "block_id": 96159168, "block_timestamp": "2023-07-10T16:48:13.643Z", "signer_id": "manzanal.near", "widget_name": "Governance.Proposals", "source_code": "const accountId = props.accountId ?? context.accountId;\nconst contractId = props.contractId ?? \"v003.mpip.near\";\nconst META_VOTE_CONTRACT_ID = \"meta-vote.near\";\nconst authorId = \"manzanal.near\";\nconst proposalsPerPage = props.proposalsPerPage ?? 10; // Number of proposals to fetch at a time\n\nState.init({\n  contractId,\n  proposals: [],\n  proposalsAreFetched: false,\n  lastProposalId: null, // To keep track of the last loaded proposal\n  lastProposalIdIsFetched: false,\n  hasMore: true, // Boolean to know if there are more proposals to load\n  showCreateProposal: false,\n  quorum: null,\n  quorumIsFetched: false,\n  threshold: null,\n  thresholdIsFetched: false,\n  voters: null,\n  votersAreFetched: false,\n  totalHolders: null,\n  totalHoldersIsFetched: false,\n  totalVotingPower: null,\n  totalVotingPowerIsFetched: false,\n});\n\nconst yoctoToNear = (amountYocto) =>\n  new Big(amountYocto).div(new Big(10).pow(24)).toFixed(0);\n\nconst numberWithCommas = (x) =>\n  x.toString().replace(/\\B(?<!\\.\\d*)(?=(\\d{3})+(?!\\d))/g, \",\");\n\nconst loadProposals = () => {\n  // Prevents multiple calls to loadProposals() before the first call is finished\n  if (state.proposals.length > 0 && state.proposals[0].id === lastProposalId)\n    return;\n\n  const fromIndex = Math.max(0, lastProposalId - proposalsPerPage + 1); // Ensures fromIndex is never less than 0\n  const limit = fromIndex === 0 ? lastProposalId + 1 : proposalsPerPage; // Ensure we don't fetch the same proposals twice if fromIndex is 0\n\n  const newProposals = Near.view(contractId, \"get_proposals\", {\n    from_index: fromIndex,\n    limit: limit,\n  });\n  if (newProposals === null) return;\n\n  State.update({\n    ...state,\n    hasMore: fromIndex > 0,\n    proposals: [...state.proposals, ...newProposals.reverse()],\n    filteredData: [...state.proposals, ...newProposals.reverse()],\n    lastProposalId: fromIndex - 1,\n    isLoading: false,\n  });\n};\n\nconst onChangeData = (_data) => {\n  State.update({ filteredData: _data.result });\n};\n\nif (!state.totalVotingPowerIsFetched) {\n  Near.asyncView(\n    META_VOTE_CONTRACT_ID,\n    \"get_total_voting_power\",\n    {},\n    \"final\",\n    false\n  ).then((totalVotingPower) =>\n    State.update({ totalVotingPower, totalVotingPowerIsFetched: true })\n  );\n}\n\nif (!state.lastProposalIdIsFetched) {\n  Near.asyncView(contractId, \"get_last_proposal_id\", {}, \"final\", false).then(\n    (lastProposalId) =>\n      State.update({ lastProposalId, lastProposalIdIsFetched: true })\n  );\n}\n\nif (!state.proposalsAreFetched) {\n  Near.asyncView(\n    contractId,\n    \"get_proposals\",\n    { from_index: 0, limit: proposalsPerPage },\n    \"final\",\n    false\n  ).then((proposals) => {\n    console.log(\"proposals\", proposals);\n    State.update({ proposals, proposalsAreFetched: true });\n  });\n}\n\nif (!state.quorumIsFetched) {\n  Near.asyncView(contractId, \"get_quorum_floor\", {}, \"final\", false).then(\n    (quorum) =>\n      State.update({ quorum: parseInt(quorum), quorumIsFetched: true })\n  );\n}\n\nif (!state.thresholdIsFetched) {\n  Near.asyncView(contractId, \"get_proposal_threshold\", {}, \"final\", false).then(\n    (threshold) =>\n      State.update({\n        threshold: yoctoToNear(threshold),\n        thresholdIsFetched: true,\n      })\n  );\n}\n\nif (!state.votersAreFetched) {\n  Near.asyncView(contractId, \"get_total_voters\", {}, \"final\", false).then(\n    (voters) =>\n      State.update({ voters: parseInt(voters), votersAreFetched: true })\n  );\n}\n\nif (!state.totalHoldersIsFetched) {\n  Near.asyncView(\n    META_VOTE_CONTRACT_ID,\n    \"get_voters_count\",\n    {},\n    \"final\",\n    false\n  ).then((totalHolders) => {\n    console.log(\"total holders\", totalHolders);\n    State.update({\n      totalHolders: parseInt(totalHolders),\n      totalHoldersIsFetched: true,\n    });\n  });\n}\n\nconst ListContainer = styled.div`\n  display: flex;\n  flex-direction: row;\n  align-items: stretch;\n  justify-content: space-between;\n  flex-wrap: wrap;\n  gap: 0.5em;\n  row-gap: 1.25em;\n  width: 100%;\n\n  & > div {\n    display: flex;\n    flex-direction: row;\n    align-items: stretch;\n    justify-content: center;\n    flex-shrink: 0;\n    width: 100%;\n\n    @media (min-width: 768px) {\n      width: ${({ full }) => (full ? \"100%\" : \"49%\")};\n    }\n\n    @media (min-width: 2560px) {\n      width: ${({ full }) => (full ? \"100%\" : \"32%\")};\n    }\n  }\n`;\n\nconst Container = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: stretch;\n  justify-content: flex-start;\n`;\n\nconst Filters = styled.div`\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  justify-content: space-between;\n  font-size: 0.9em;\n`;\n\nconst Filter = styled.div`\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  justify-content: space-between;\n  gap: 1em;\n`;\nconst Metrics = styled.div`\n  display: flex;\n  flex-direction: row;\n  align-items: stretch;\n  gap: 0.5em;\n  width: 100%;\n  max-width: 1300px;\n\n  div {\n    width: 20%;\n  }\n\n  @media (max-width: 768px) {\n    flex-wrap: wrap;\n\n    div {\n      width: 49%;\n    }\n\n    div:last-child {\n      width: 100%;\n    }\n  }\n`;\n\nconst Section = styled.div`\n  display: flex;\n  justify-content: space-between;\n  flex-wrap: wrap;\n  padding-bottom: 1.5em;\n  gap: 1.5em;\n  h3 {\n    font-style: normal;\n    font-weight: 700;\n    font-size: 1.5em;\n    line-height: 36px;\n    color: #000000;\n  }\n`;\n\nif (\n  !state.proposalsAreFetched ||\n  !state.quorumIsFetched ||\n  !state.thresholdIsFetched ||\n  !state.votersAreFetched ||\n  !state.totalHoldersIsFetched ||\n  !state.totalVotingPowerIsFetched\n) {\n  return <>Loading...</>;\n}\nconst quorumToReach =\n  (parseInt(yoctoToNear(state.totalVotingPower)) * state.quorum) / 100 / 100;\nconst quorumToReachPercentage = state.quorum / 100;\nreturn (\n  <Container>\n    <Section>\n      <h3>Proposals metrics</h3>\n      <Metrics>\n        <Widget\n          src={`${authorId}/widget/Governance.Metric.Card`}\n          props={{\n            value: (\n              <>{numberWithCommas(parseInt(quorumToReach.toFixed(0)))} VP </>\n            ),\n            label: (\n              <>\n                Quorum ({quorumToReachPercentage}% of total VP){\" \"}\n                <i class=\"bi bi-info-circle\" />\n              </>\n            ),\n          }}\n        />\n        <Widget\n          src={`${authorId}/widget/Governance.Metric.Card`}\n          props={{\n            value: <>{numberWithCommas(state.threshold)} VP</>,\n            label: (\n              <>\n                Proposal threshold {q} <i class=\"bi bi-info-circle\" />\n              </>\n            ),\n          }}\n        />\n        <Widget\n          src={`${authorId}/widget/Governance.Metric.Card`}\n          props={{\n            value: (\n              <>\n                {numberWithCommas(state.voters)} /{\" \"}\n                {numberWithCommas(state.totalHolders)}\n              </>\n            ),\n            label: (\n              <>\n                Voters / VP Holders <i class=\"bi bi-info-circle\" />\n              </>\n            ),\n          }}\n        />\n      </Metrics>\n    </Section>\n    <Section>\n      <h3>All Proposals</h3>\n\n      <Widget\n        src={`${authorId}/widget/Common.Button`}\n        props={{\n          children: (\n            <>\n              <i className=\"bi bi-16 bi-plus-lg\"></i>\n              Create Proposal\n            </>\n          ),\n          onClick: () => State.update({ tab: \"createproposal\", content: \"\" }),\n          variant: \"success\",\n          href: `/${authorId}/widget/Governance.Index?tab=createproposal`,\n        }}\n      />\n    </Section>\n    <div class=\"table-responsive w-100 mt-2\">\n      <Widget\n        src={`${authorId}/widget/Governance.ProposalsTable`}\n        props={{ proposals: state.proposals, update: props.update }}\n      />\n    </div>\n  </Container>\n);\n", "metadata": {"platform": "Components.gg"}, "branch": {"draft": null}, "widget_modules_used": null, "widget_url": "https://near.social/#/manzanal.near/widget/Governance.Proposals", "fact_widget_deployments_id": "79d3efe7d39481c8610fb5210b16446b", "inserted_timestamp": "2000-01-01T00:00:00.000Z", "modified_timestamp": "2000-01-01T00:00:00.000Z", "__row_index": 0}