{"tx_hash": "ERtnvDSsJMyGPZ1ixhFFwhAk5me1bepBmj6Aodt7HDDX", "action_id_social": "GZJosJieH3hMWeFNhVN7tXv4hADgkbU5vdDMrUZRhPZA-0-widget", "block_id": 120157839, "block_timestamp": "2024-05-31T20:42:47.268Z", "signer_id": "infrastructure-committee.near", "widget_name": "components.rfps.Rfp", "source_code": "import {\n  REPL_INFRASTRUCTURE_COMMITTEE,\n  REPL_DEVHUB,\n  REPL_INFRASTRUCTURE_COMMITTEE_CONTRACT,\n  REPL_RPC_URL,\n  RFP_TIMELINE_STATUS,\n  RFP_IMAGE,\n  PROPOSAL_TIMELINE_STATUS,\n  PROPOSAL_FEED_INDEXER_QUERY_NAME,\n  fetchGraphQL,\n  RFP_INDEXER_QUERY_NAME,\n  parseJSON,\n  PROPOSALS_APPROVED_STATUS_ARRAY,\n} from \"@/includes/common\";\n\nconst { href } = VM.require(`${REPL_DEVHUB}/widget/core.lib.url`) || {\n  href: () => {},\n};\nconst { readableDate } = VM.require(\n  `${REPL_DEVHUB}/widget/core.lib.common`\n) || { readableDate: () => {} };\n\nconst { getGlobalLabels } = VM.require(\n  `${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.core.lib.contract`\n) || { getGlobalLabels: () => {} };\n\nconst accountId = context.accountId;\n/*\n  ---props---\n  props.id: number;\n  props.timestamp: number; optional\n  accountId: string\n  blockHeight:number\n  */\n\nconst { id, timestamp } = props;\n\nconst Container = styled.div`\n  .full-width-div {\n    width: 100vw;\n    position: relative;\n    left: 50%;\n    right: 50%;\n    margin-left: -50vw;\n    margin-right: -50vw;\n  }\n\n  .fw-bold {\n    font-weight: 600 !important;\n  }\n\n  .card.no-border {\n    border-left: none !important;\n    border-right: none !important;\n    margin-bottom: -3.5rem;\n  }\n\n  .description-box {\n    font-size: 14px;\n  }\n\n  .accept-submission-info-container {\n    background-color: #ecf8fb;\n  }\n\n  .text-sm {\n    font-size: 13px !important;\n  }\n\n  .flex-1 {\n    flex: 1;\n  }\n\n  .flex-3 {\n    flex: 3;\n  }\n\n  .circle {\n    width: 20px;\n    height: 20px;\n    border-radius: 50%;\n    border: 1px solid grey;\n  }\n\n  .green-fill {\n    background-color: rgb(4, 164, 110) !important;\n    border-color: rgb(4, 164, 110) !important;\n    color: white !important;\n  }\n\n  .yellow-fill {\n    border-color: #ff7a00 !important;\n  }\n\n  .vertical-line {\n    width: 2px;\n    height: 180px;\n    background-color: lightgrey;\n  }\n\n  @media screen and (max-width: 970px) {\n    .vertical-line {\n      height: 135px !important;\n    }\n\n    .vertical-line-sm {\n      height: 70px !important;\n    }\n\n    .gap-6 {\n      gap: 0.5rem !important;\n    }\n  }\n\n  @media screen and (max-width: 570px) {\n    .vertical-line {\n      height: 180px !important;\n    }\n\n    .vertical-line-sm {\n      height: 75px !important;\n    }\n\n    .gap-6 {\n      gap: 0.5rem !important;\n    }\n  }\n\n  .vertical-line-sm {\n    width: 2px;\n    height: 70px;\n    background-color: lightgrey;\n  }\n\n  .form-check-input:disabled ~ .form-check-label,\n  .form-check-input[disabled] ~ .form-check-label {\n    opacity: 1;\n  }\n\n  .form-check-input {\n    border-color: black !important;\n  }\n\n  .grey-btn {\n    background-color: #687076;\n    border: none;\n    color: white;\n  }\n\n  .blue-btn {\n    background-color: #3c697d;\n    border: none;\n    color: white;\n  }\n\n  .form-check-input:checked {\n    background-color: #3c697d !important;\n    border-color: #3c697d !important;\n  }\n\n  .dropdown-toggle:after {\n    position: absolute;\n    top: 46%;\n    right: 5%;\n  }\n\n  .drop-btn {\n    max-width: none !important;\n  }\n\n  .dropdown-menu {\n    width: 100%;\n    border-radius: 0.375rem !important;\n  }\n\n  .green-btn {\n    background-color: #04a46e !important;\n    border: none;\n    color: white;\n\n    &:active {\n      color: white;\n    }\n  }\n\n  .gap-6 {\n    gap: 2.5rem;\n  }\n\n  .border-vertical {\n    border-top: var(--bs-border-width) var(--bs-border-style)\n      var(--bs-border-color) !important;\n    border-bottom: var(--bs-border-width) var(--bs-border-style)\n      var(--bs-border-color) !important;\n  }\n\n  button.px-0 {\n    padding-inline: 0px !important;\n  }\n\n  red-icon i {\n    color: red;\n  }\n\n  input[type=\"radio\"] {\n    min-width: 13px;\n  }\n`;\n\nconst RfpContainer = styled.div`\n  border: 1px solid lightgrey;\n  overflow: auto;\n`;\n\nconst Header = styled.div`\n  position: relative;\n  background-color: #f4f4f4;\n  height: 50px;\n\n  .menu {\n    position: absolute;\n    right: 10px;\n    top: 4px;\n    font-size: 30px;\n  }\n`;\n\nconst Text = styled.p`\n  display: block;\n  margin: 0;\n  font-size: 14px;\n  line-height: 20px;\n  font-weight: 400;\n  color: #687076;\n  white-space: nowrap;\n`;\n\nconst Actions = styled.div`\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  margin: -6px -6px 6px;\n`;\n\nconst Avatar = styled.div`\n  width: 40px;\n  height: 40px;\n  pointer-events: none;\n\n  img {\n    object-fit: cover;\n    border-radius: 40px;\n    width: 100%;\n    height: 100%;\n  }\n`;\n\nconst rfpLabelOptions = getGlobalLabels();\n\nconst LinkProfile = ({ account, children }) => {\n  return (\n    <Link href={`/near/widget/ProfilePage?accountId=${account}`}>\n      {children}\n    </Link>\n  );\n};\n\nconst [snapshotHistory, setSnapshotHistory] = useState([]);\n\nconst rfp = Near.view(REPL_INFRASTRUCTURE_COMMITTEE_CONTRACT, \"get_rfp\", {\n  rfp_id: parseInt(id),\n});\n\nconst queryName = RFP_INDEXER_QUERY_NAME;\nconst query = `query GetLatestSnapshot($offset: Int = 0, $limit: Int = 10, $where: ${queryName}_bool_exp = {}) {\n  ${queryName}(\n    offset: $offset\n    limit: $limit\n    order_by: {rfp_id: desc}\n    where: $where\n  ) {\n    editor_id\n    name\n    summary\n    description\n    ts\n    rfp_id\n    timeline\n    labels\n    submission_deadline\n    linked_proposals\n  }\n}`;\n\nconst fetchSnapshotHistory = () => {\n  const variables = {\n    where: { rfp_id: { _eq: id } },\n  };\n  fetchGraphQL(query, \"GetLatestSnapshot\", variables).then(async (result) => {\n    if (result.status === 200) {\n      if (result.body.data) {\n        const data = result.body.data?.[queryName];\n        const history = data.map((item) => {\n          const rfpData = {\n            ...item,\n            timestamp: item.ts,\n            timeline: parseJSON(item.timeline),\n          };\n          delete rfpData.ts;\n          return rfpData;\n        });\n        setSnapshotHistory(history);\n      }\n    }\n  });\n};\n\nuseEffect(() => {\n  fetchSnapshotHistory();\n}, [id]);\n\nif (!rfp) {\n  return (\n    <div\n      style={{ height: \"50vh\" }}\n      className=\"d-flex justify-content-center align-items-center w-100\"\n    >\n      <Widget\n        src={`${REPL_DEVHUB}/widget/devhub.components.molecule.Spinner`}\n      />\n    </div>\n  );\n}\nif (timestamp && rfp) {\n  rfp.snapshot =\n    snapshotHistory.find((item) => item.timestamp === timestamp) ??\n    rfp.snapshot;\n}\n\nconst { snapshot } = rfp;\nsnapshot.timeline = parseJSON(snapshot.timeline);\n\nconst authorId = rfp.author_id;\nconst blockHeight = parseInt(rfp.social_db_post_block_height);\nconst item = {\n  type: \"social\",\n  path: `${REPL_INFRASTRUCTURE_COMMITTEE_CONTRACT}/post/main`,\n  blockHeight,\n};\nconst rfpURL = `https://near.org/${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.pages.app?page=rfp&id=${rfp.id}&timestamp=${snapshot.timestamp}`;\n\nconst SidePanelItem = ({ title, children, hideBorder, ishidden }) => {\n  return (\n    <div\n      style={{ gap: \"8px\" }}\n      className={\n        ishidden\n          ? \"d-none\"\n          : \"d-flex flex-column pb-3 \" + (!hideBorder && \" border-bottom\")\n      }\n    >\n      <div className=\"h6 mb-0\">{title} </div>\n      <div className=\"text-muted\">{children}</div>\n    </div>\n  );\n};\n\nconst isAllowedToWriteRfp = Near.view(\n  REPL_INFRASTRUCTURE_COMMITTEE_CONTRACT,\n  \"is_allowed_to_write_rfps\",\n  {\n    editor: accountId,\n  }\n);\n\nconst link = href({\n  widgetSrc: `${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.pages.app`,\n  params: {\n    page: \"create-rfp\",\n    id: rfp.id,\n    timestamp: timestamp,\n  },\n});\n\nconst createdDate = snapshotHistory[0].timestamp ?? snapshot.timestamp;\n\nconst [approvedProposals, setApprovedProposals] = useState([]);\n\nfunction fetchApprovedRfpProposals() {\n  const queryName = PROPOSAL_FEED_INDEXER_QUERY_NAME;\n  const query = `query GetLatestSnapshot($offset: Int = 0, $limit: Int = 10, $where: ${queryName}_bool_exp = {}) {\n    ${queryName}(\n      offset: $offset\n      limit: $limit\n      order_by: {proposal_id: desc}\n      where: $where\n    ) {\n      proposal_id\n      name\n      timeline\n    }\n  }`;\n\n  const FETCH_LIMIT = 50;\n  const variables = {\n    limit: FETCH_LIMIT,\n    offset,\n    where: {\n      proposal_id: { _in: rfp.snapshot.linked_proposals },\n    },\n  };\n  fetchGraphQL(query, \"GetLatestSnapshot\", variables).then(async (result) => {\n    if (result.status === 200) {\n      if (result.body.data) {\n        const data = result.body.data?.[queryName];\n        const approved = [];\n        data.map((item) => {\n          const timeline = parseJSON(item.timeline);\n          if (PROPOSALS_APPROVED_STATUS_ARRAY.includes(timeline.status)) {\n            approved.push(item);\n          }\n        });\n        setApprovedProposals(approved);\n      }\n    }\n  });\n}\n\nconst accessControlInfo =\n  Near.view(\n    REPL_INFRASTRUCTURE_COMMITTEE_CONTRACT,\n    \"get_access_control_info\"\n  ) ?? null;\nconst moderatorList =\n  accessControlInfo?.members_list?.[\"team:moderators\"]?.children;\n\nfetchApprovedRfpProposals();\n\nconst SubmitProposalBtn = () => {\n  return (\n    <div style={{ minWidth: \"fit-content\" }}>\n      <Link\n        to={href({\n          widgetSrc: `${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.pages.app`,\n          params: { page: \"create-proposal\", rfp_id: rfp.id },\n        })}\n      >\n        <Widget\n          src={`${REPL_DEVHUB}/widget/devhub.components.molecule.Button`}\n          props={{\n            label: (\n              <div className=\"d-flex align-items-center gap-2\">\n                <i className=\"bi bi-plus-circle\"></i>Submit Proposal\n              </div>\n            ),\n            classNames: { root: \"blue-btn\" },\n          }}\n        />\n      </Link>\n    </div>\n  );\n};\nreturn (\n  <Container className=\"d-flex flex-column gap-2 w-100 mt-4\">\n    <div className=\"d-flex px-3 px-lg-0 justify-content-between\">\n      <div className=\"d-flex gap-2 align-items-center h3\">\n        <div>{snapshot.name}</div>\n        <div className=\"text-muted\">#{rfp.id}</div>\n      </div>\n      <div className=\"d-flex gap-2 align-items-center\">\n        <Widget\n          src={`${REPL_NEAR}/widget/ShareButton`}\n          props={{\n            postType: \"post\",\n            url: rfpURL,\n          }}\n        />\n        {isAllowedToWriteRfp && (\n          <Link to={link} style={{ textDecoration: \"none\" }}>\n            <Widget\n              src={`${REPL_DEVHUB}/widget/devhub.components.molecule.Button`}\n              props={{\n                label: \"Edit\",\n                classNames: { root: \"grey-btn btn-sm\" },\n              }}\n            />\n          </Link>\n        )}\n      </div>\n    </div>\n    <div className=\"d-flex flex-wrap flex-md-nowrap px-3 px-lg-0 gap-2 align-items-center text-sm pb-3 w-100\">\n      <Widget\n        src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.rfps.StatusTag`}\n        props={{\n          timelineStatus: snapshot.timeline.status,\n          size: \"sm\",\n        }}\n      />\n      <div className=\"w-100 d-flex flex-wrap flex-md-nowrap gap-1 align-items-center\">\n        <div className=\"fw-bold text-truncate\">\n          <LinkProfile account={authorId}>{authorId}</LinkProfile>\n        </div>\n        <div>created on {readableDate(createdDate / 1000000)}</div>\n      </div>\n    </div>\n    <div className=\"card no-border rounded-0 full-width-div px-3 px-lg-0\">\n      <div className=\"container-xl py-4\">\n        {snapshot.timeline.status ===\n          RFP_TIMELINE_STATUS.ACCEPTING_SUBMISSIONS && (\n          <div className=\"accept-submission-info-container p-3 p-sm-4 d-flex flex-wrap flex-sm-nowrap justify-content-between align-items-center gap-2 rounded-2\">\n            <div style={{ minWidth: \"300px\" }}>\n              <b>This RFP is accepting submissions.</b>\n              <p className=\"text-sm text-muted mt-2\">\n                Click Submit Proposal if you want to submit a proposal.\n              </p>\n            </div>\n            <SubmitProposalBtn />\n          </div>\n        )}\n        <div className=\"my-4\">\n          <div className=\"d-flex flex-wrap gap-6\">\n            <div\n              style={{ minWidth: \"350px\" }}\n              className=\"flex-3 order-2 order-md-1\"\n            >\n              <div\n                className=\"d-flex gap-2 flex-1\"\n                style={{\n                  zIndex: 99,\n                  background: \"white\",\n                  position: \"relative\",\n                }}\n              >\n                <div className=\"d-none d-sm-flex\">\n                  <img src={RFP_IMAGE} height={35} width={35} />\n                </div>\n                <RfpContainer className=\"rounded-2 flex-1\">\n                  <Header className=\"d-flex gap-1 align-items-center p-2 px-3 \">\n                    <div\n                      className=\"fw-bold text-truncate\"\n                      style={{ maxWidth: \"60%\" }}\n                    >\n                      <LinkProfile account={authorId}>{authorId}</LinkProfile>\n                    </div>\n                    <div\n                      className=\"text-muted\"\n                      style={{ minWidth: \"fit-content\" }}\n                    >\n                      \uff65{\" \"}\n                      <Widget\n                        src={`${REPL_NEAR}/widget/TimeAgo`}\n                        props={{\n                          blockHeight,\n                          blockTimestamp: createdDate,\n                        }}\n                      />\n                      {context.accountId && (\n                        <div className=\"menu\">\n                          <Widget\n                            src={`${REPL_NEAR}/widget/Posts.Menu`}\n                            props={{\n                              accountId: authorId,\n                              blockHeight: blockHeight,\n                            }}\n                          />\n                        </div>\n                      )}\n                    </div>\n                  </Header>\n                  <div className=\"d-flex flex-column gap-1 p-2 px-3 description-box\">\n                    <div className=\"text-muted h6 border-bottom pb-1 mt-3\">\n                      RFP CATEGORY\n                      <div className=\"my-2\">\n                        <Widget\n                          src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.molecule.MultiSelectCategoryDropdown`}\n                          props={{\n                            selected: snapshot.labels,\n                            disabled: true,\n                            hideDropdown: true,\n                            onChange: () => {},\n                            availableOptions: rfpLabelOptions,\n                          }}\n                        />\n                      </div>\n                    </div>\n                    <div className=\"text-muted h6 border-bottom pb-1 mt-3\">\n                      SUMMARY\n                    </div>\n                    <div>{snapshot.summary}</div>\n                    <div className=\"text-muted h6 border-bottom pb-1 mt-3 mb-4\">\n                      DESCRIPTION\n                    </div>\n                    <Widget\n                      src={`${REPL_DEVHUB}/widget/devhub.components.molecule.MarkdownViewer`}\n                      props={{ text: snapshot.description }}\n                    />\n\n                    <div className=\"d-flex gap-2 align-items-center mt-4\">\n                      <Widget\n                        src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.molecule.LikeButton`}\n                        props={{\n                          item,\n                          rfpId: rfp.id,\n                          notifyAccountIds: moderatorList,\n                        }}\n                      />\n                      <Widget\n                        src={`${REPL_DEVHUB}/widget/devhub.entity.proposal.CommentIcon`}\n                        props={{\n                          item,\n                          showOverlay: false,\n                          onClick: () => {},\n                        }}\n                      />\n                      <Widget\n                        src={`${REPL_NEAR}/widget/CopyUrlButton`}\n                        props={{\n                          url: rfpURL,\n                        }}\n                      />\n                    </div>\n                  </div>\n                </RfpContainer>\n              </div>\n              <div className=\"border-bottom pb-4 mt-4\">\n                <Widget\n                  src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.rfps.CommentsAndLogs`}\n                  props={{\n                    ...props,\n                    id: rfp.id,\n                    item: item,\n                    approvedProposals: approvedProposals,\n                    snapshotHistory: snapshotHistory,\n                  }}\n                />\n              </div>\n              <div\n                style={{\n                  position: \"relative\",\n                  zIndex: 99,\n                  backgroundColor: \"white\",\n                }}\n                className=\"pt-4\"\n              >\n                <Widget\n                  src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.molecule.ComposeComment`}\n                  props={{\n                    ...props,\n                    item: item,\n                    notifyAccountIds: moderatorList,\n                    rfpId: rfp.id,\n                  }}\n                />\n                {snapshot.timeline.status ===\n                  RFP_TIMELINE_STATUS.ACCEPTING_SUBMISSIONS && (\n                  <div className=\"accept-submission-info-container mt-3 p-3 p-sm-4 d-flex flex-wrap flex-md-nowrap justify-content-between align-items-center gap-2 rounded-2\">\n                    <div style={{ minWidth: \"350px\" }}>\n                      <b>Want to respond to this RFP? </b> This RFP is accepting\n                      submissions.\n                    </div>\n                    <SubmitProposalBtn />\n                  </div>\n                )}\n              </div>\n            </div>\n            <div\n              style={{ minWidth: \"300px\" }}\n              className=\"d-flex flex-column gap-4 flex-1 order-1 order-md-2\"\n            >\n              <SidePanelItem title=\"Submission Deadline\">\n                <h5 className=\"text-black\">\n                  {readableDate(\n                    parseFloat(snapshot.submission_deadline / 1000000)\n                  )}\n                </h5>\n              </SidePanelItem>\n              <SidePanelItem title=\"Timeline\">\n                <Widget\n                  src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.rfps.TimelineConfigurator`}\n                  props={{\n                    timeline: snapshot.timeline,\n                    disabled: true,\n                  }}\n                />\n              </SidePanelItem>\n              <SidePanelItem\n                title={\n                  \"Selected Proposal\" + \" (\" + approvedProposals.length + \")\"\n                }\n                ishidden={!approvedProposals.length}\n              >\n                <Widget\n                  src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.molecule.LinkedProposals`}\n                  props={{\n                    linkedProposalIds: (approvedProposals ?? []).map(\n                      (i) => i.proposal_id\n                    ),\n                    showStatus: false,\n                  }}\n                />\n              </SidePanelItem>\n              <SidePanelItem\n                title={\n                  \"All Proposals\" +\n                  \" (\" +\n                  snapshot.linked_proposals.length +\n                  \")\"\n                }\n                ishidden={!snapshot.linked_proposals.length}\n              >\n                <Widget\n                  src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/near-prpsls-bos.components.molecule.LinkedProposals`}\n                  props={{\n                    linkedProposalIds: snapshot.linked_proposals,\n                    showStatus:\n                      snapshot.timeline.status !==\n                      RFP_TIMELINE_STATUS.PROPOSAL_SELECTED,\n                  }}\n                />\n              </SidePanelItem>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/infrastructure-committee.near/widget/components.rfps.Rfp", "fact_widget_deployments_id": "18b7ba4e0e4e29d81d47fa283a634d1e", "inserted_timestamp": "2024-05-31T22:39:53.745Z", "modified_timestamp": "2024-05-31T22:39:53.745Z", "__row_index": 2}