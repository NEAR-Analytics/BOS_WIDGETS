{"tx_hash": "F6WndupRrm2pyPsgL3E9MiNumbfjyig9R8G5ePkonLYQ", "action_id_social": "8LpZA5xtzu6wZ2sFm18TMQF3PG3QSZKbFAsQJ7Je4Adc-0-widget", "block_id": 120923161, "block_timestamp": "2024-06-11T10:37:35.133Z", "signer_id": "infrastructure-committee.near", "widget_name": "components.molecule.ComposeComment", "source_code": "/*\nLicense: MIT\nAuthor: devhub.near\nHomepage: https://github.com/NEAR-DevHub/near-prpsls-bos#readme\n*/\n/* INCLUDE: \"includes/common.jsx\" */\nconst REPL_DEVHUB = \"devhub.near\";\nconst REPL_INFRASTRUCTURE_COMMITTEE = \"infrastructure-committee.near\";\nconst REPL_INFRASTRUCTURE_COMMITTEE_CONTRACT =\n  \"infrastructure-committee.near\";\nconst REPL_RPC_URL = \"https://rpc.mainnet.near.org\";\nconst REPL_NEAR = \"near\";\nconst RFP_IMAGE =\n  \"https://ipfs.near.social/ipfs/bafkreicbygt4kajytlxij24jj6tkg2ppc2dw3dlqhkermkjjfgdfnlizzy\";\n\nconst RFP_FEED_INDEXER_QUERY_NAME =\n  \"polyprogrammist_near_devhub_ic_v1_rfps_with_latest_snapshot\";\n\nconst RFP_INDEXER_QUERY_NAME =\n  \"polyprogrammist_near_devhub_ic_v1_rfp_snapshots\";\n\nconst PROPOSAL_FEED_INDEXER_QUERY_NAME =\n  \"polyprogrammist_near_devhub_ic_v1_proposals_with_latest_snapshot\";\n\nconst PROPOSAL_QUERY_NAME =\n  \"polyprogrammist_near_devhub_ic_v1_proposal_snapshots\";\nconst RFP_TIMELINE_STATUS = {\n  ACCEPTING_SUBMISSIONS: \"ACCEPTING_SUBMISSIONS\",\n  EVALUATION: \"EVALUATION\",\n  PROPOSAL_SELECTED: \"PROPOSAL_SELECTED\",\n  CANCELLED: \"CANCELLED\",\n};\n\nconst PROPOSAL_TIMELINE_STATUS = {\n  DRAFT: \"DRAFT\",\n  REVIEW: \"REVIEW\",\n  APPROVED: \"APPROVED\",\n  REJECTED: \"REJECTED\",\n  CANCELED: \"CANCELLED\",\n  APPROVED_CONDITIONALLY: \"APPROVED_CONDITIONALLY\",\n  PAYMENT_PROCESSING: \"PAYMENT_PROCESSING\",\n  FUNDED: \"FUNDED\",\n};\n\nconst QUERYAPI_ENDPOINT = `https://near-queryapi.api.pagoda.co/v1/graphql`;\n\nasync function fetchGraphQL(operationsDoc, operationName, variables) {\n  return asyncFetch(QUERYAPI_ENDPOINT, {\n    method: \"POST\",\n    headers: { \"x-hasura-role\": `polyprogrammist_near` },\n    body: JSON.stringify({\n      query: operationsDoc,\n      variables: variables,\n      operationName: operationName,\n    }),\n  });\n}\n\nconst CANCEL_RFP_OPTIONS = {\n  CANCEL_PROPOSALS: \"CANCEL_PROPOSALS\",\n  UNLINK_PROPOSALS: \"UNLINK_PROPOSALSS\",\n  NONE: \"NONE\",\n};\n\nfunction parseJSON(json) {\n  if (typeof json === \"string\") {\n    try {\n      return JSON.parse(json);\n    } catch (error) {\n      return json;\n    }\n  } else {\n    return json;\n  }\n}\n\nfunction isNumber(value) {\n  return typeof value === \"number\";\n}\n\nconst PROPOSALS_APPROVED_STATUS_ARRAY = [\n  PROPOSAL_TIMELINE_STATUS.APPROVED,\n  PROPOSAL_TIMELINE_STATUS.APPROVED_CONDITIONALLY,\n  PROPOSAL_TIMELINE_STATUS.PAYMENT_PROCESSING,\n  PROPOSAL_TIMELINE_STATUS.FUNDED,\n];\n\nfunction getLinkUsingCurrentGateway(url) {\n  const data = fetch(`https://httpbin.org/headers`);\n  const gatewayURL = data?.body?.headers?.Origin ?? \"\";\n  return `https://${\n    gatewayURL.includes(\"near.org\") ? \"dev.near.org\" : \"near.social\"\n  }/${url}`;\n}\n/* END_INCLUDE: \"includes/common.jsx\" */\n\nconst proposalId = props.proposalId;\nconst rfpId = props.rfpId;\nconst draftKey = \"INFRA_COMMENT_DRAFT\" + proposalId;\nlet draftComment = \"\";\n\nconst ComposeEmbeddCSS = `\n  .CodeMirror {\n    border: none !important;\n    min-height: 50px !important;\n  }\n\n  .editor-toolbar {\n    border: none !important;\n  }\n\n  .CodeMirror-scroll{\n    min-height: 50px !important;\n    max-height: 300px !important;\n  }\n`;\n\nconst notifyAccountIds = props.notifyAccountIds ?? [];\nconst accountId = context.accountId;\nconst item = props.item;\nconst [allowGetDraft, setAllowGetDraft] = useState(true);\nconst [comment, setComment] = useState(null);\nconst [isTxnCreated, setTxnCreated] = useState(false);\nconst [handler, setHandler] = useState(\"update\"); // to update editor state on draft and txn approval\nconst [showCommentToast, setCommentToast] = useState(false);\n\nif (allowGetDraft) {\n  draftComment = Storage.privateGet(draftKey);\n}\n\nuseEffect(() => {\n  if (draftComment) {\n    setComment(draftComment);\n    setAllowGetDraft(false);\n    setHandler(\"refreshEditor\");\n  }\n}, [draftComment]);\n\nuseEffect(() => {\n  if (draftComment === comment) {\n    return;\n  }\n  const handler = setTimeout(() => {\n    Storage.privateSet(draftKey, comment);\n  }, 1000);\n\n  return () => {\n    clearTimeout(handler);\n  };\n}, [comment]);\n\nuseEffect(() => {\n  if (handler === \"update\") {\n    return;\n  }\n  const handler = setTimeout(() => {\n    setHandler(\"update\");\n  }, 3000);\n\n  return () => {\n    clearTimeout(handler);\n  };\n}, [handler]);\n\nif (!accountId) {\n  return (\n    <div\n      style={{\n        marginLeft: 10,\n        backgroundColor: \"#ECF8FB\",\n        border: \"1px solid #E2E6EC\",\n      }}\n      className=\"d-flex align-items-center gap-1 p-4 rounded-2 flex-wrap flex-md-nowrap\"\n    >\n      <Link to=\"https://near.org/signup\">\n        <Widget\n          src={`${REPL_DEVHUB}/widget/devhub.components.molecule.Button`}\n          props={{\n            classNames: { root: \"grey-btn\" },\n            label: \"Sign up\",\n          }}\n        />\n      </Link>\n      <div className=\"fw-bold\">to join this conversation.</div>\n      <div>Already have an account?</div>\n      <a className=\"text-decoration-underline\" href=\"https://near.org/signin\">\n        Log in to comment\n      </a>\n    </div>\n  );\n}\n\nfunction extractMentions(text) {\n  const mentionRegex =\n    /@((?:(?:[a-z\\d]+[-_])*[a-z\\d]+\\.)*(?:[a-z\\d]+[-_])*[a-z\\d]+)/gi;\n  mentionRegex.lastIndex = 0;\n  const accountIds = new Set();\n  for (const match of text.matchAll(mentionRegex)) {\n    if (\n      !/[\\w`]/.test(match.input.charAt(match.index - 1)) &&\n      !/[/\\w`]/.test(match.input.charAt(match.index + match[0].length)) &&\n      match[1].length >= 2 &&\n      match[1].length <= 64\n    ) {\n      accountIds.add(match[1].toLowerCase());\n    }\n  }\n  return [...accountIds];\n}\n\nfunction extractTagNotifications(text, item) {\n  return extractMentions(text || \"\")\n    .filter((accountId) => accountId !== context.accountId)\n    .map((accountId) => ({\n      key: accountId,\n      value: {\n        type: \"mention\",\n        item,\n      },\n    }));\n}\n\nfunction composeData() {\n  setTxnCreated(true);\n  const data = {\n    post: {\n      comment: JSON.stringify({\n        type: \"md\",\n        text: comment,\n        item,\n      }),\n    },\n    index: {\n      comment: JSON.stringify({\n        key: item,\n        value: {\n          type: \"md\",\n        },\n      }),\n    },\n  };\n\n  const notifications = extractTagNotifications(comment, {\n    type: \"social\",\n    path: `${accountId}/post/comment`,\n  });\n\n  if (notifyAccountIds.length > 0) {\n    notifyAccountIds.map((account) => {\n      if (account !== context.accountId) {\n        notifications.push({\n          key: account,\n          value: proposalId\n            ? {\n                type: \"proposal/reply\",\n                item,\n                proposal: proposalId,\n                widgetAccountId: REPL_INFRASTRUCTURE_COMMITTEE,\n              }\n            : {\n                type: \"rfp/reply\",\n                item,\n                rfp: rfpId,\n                widgetAccountId: REPL_INFRASTRUCTURE_COMMITTEE,\n              },\n        });\n      }\n    });\n  }\n\n  if (notifications.length) {\n    data.index.notify = JSON.stringify(\n      notifications.length > 1 ? notifications : notifications[0]\n    );\n  }\n\n  Social.set(data, {\n    force: true,\n    onCommit: () => {\n      setCommentToast(true);\n      setComment(\"\");\n      setHandler(\"refreshEditor\");\n      setTxnCreated(false);\n    },\n    onCancel: () => {\n      setTxnCreated(false);\n    },\n  });\n}\n\nuseEffect(() => {\n  if (props.transactionHashes && comment) {\n    setComment(\"\");\n  }\n}, [props.transactionHashes]);\n\nconst LoadingButtonSpinner = (\n  <span\n    class=\"comment-btn-spinner spinner-border spinner-border-sm\"\n    role=\"status\"\n    aria-hidden=\"true\"\n  ></span>\n);\n\nconst Compose = useMemo(() => {\n  return (\n    <Widget\n      src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/components.molecule.Compose`}\n      props={{\n        data: comment,\n        onChangeKeyup: setComment,\n        autocompleteEnabled: true,\n        placeholder: \"Add your comment here...\",\n        height: \"250\",\n        embeddCSS: ComposeEmbeddCSS,\n        handler: handler,\n        showProposalIdAutoComplete: true,\n      }}\n    />\n  );\n}, [draftComment, handler]);\n\nreturn (\n  <div className=\"d-flex gap-2\">\n    <Widget\n      src={`${REPL_NEAR}/widget/DIG.Toast`}\n      props={{\n        title: \"Comment Submitted Successfully\",\n        type: \"success\",\n        open: showCommentToast,\n        onOpenChange: (v) => setCommentToast(v),\n        trigger: <></>,\n        providerProps: { duration: 3000 },\n      }}\n    />\n    <Widget\n      src={`${REPL_DEVHUB}/widget/devhub.entity.proposal.Profile`}\n      props={{\n        accountId: accountId,\n      }}\n    />\n    <div className=\"d-flex flex-column gap-2 w-100\">\n      <b className=\"mt-1\">Add a comment</b>\n      {Compose}\n      <div className=\"d-flex gap-2 align-content-center justify-content-end\">\n        <Widget\n          src={`${REPL_DEVHUB}/widget/devhub.components.molecule.Button`}\n          props={{\n            label: isTxnCreated ? LoadingButtonSpinner : \"Comment\",\n            [\"data-testid\"]: \"compose-comment\",\n            disabled: !comment || isTxnCreated,\n            classNames: { root: \"green-btn btn-sm\" },\n            onClick: () => {\n              composeData();\n            },\n          }}\n        />\n      </div>\n    </div>\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/infrastructure-committee.near/widget/components.molecule.ComposeComment", "fact_widget_deployments_id": "4d5d1e44005f8f0f0646000dc9b5ed4b", "inserted_timestamp": "2024-06-11T12:05:37.054Z", "modified_timestamp": "2024-06-11T12:05:37.054Z", "__row_index": 3}