{"tx_hash": "4Q7yr7KcLx9Lo5dYuoRNksVBuKn1VBMVXBJ5js3AuFgs", "action_id_social": "4Uh472Ftkv8JVat6ucETB7n9vzWyX9pJXmYximN4dFYq-0-widget", "block_id": 120709548, "block_timestamp": "2024-06-08T12:38:26.705Z", "signer_id": "infrastructure-committee.near", "widget_name": "components.rfps.CommentsAndLogs", "source_code": "/*\nLicense: MIT\nAuthor: devhub.near\nHomepage: https://github.com/NEAR-DevHub/near-prpsls-bos#readme\n*/\n/* INCLUDE: \"includes/common.jsx\" */\nconst REPL_DEVHUB = \"devhub.near\";\nconst REPL_INFRASTRUCTURE_COMMITTEE = \"infrastructure-committee.near\";\nconst REPL_INFRASTRUCTURE_COMMITTEE_CONTRACT =\n  \"infrastructure-committee.near\";\nconst REPL_RPC_URL = \"https://rpc.mainnet.near.org\";\nconst REPL_NEAR = \"near\";\nconst RFP_IMAGE =\n  \"https://ipfs.near.social/ipfs/bafkreicbygt4kajytlxij24jj6tkg2ppc2dw3dlqhkermkjjfgdfnlizzy\";\n\nconst RFP_FEED_INDEXER_QUERY_NAME =\n  \"polyprogrammist_near_devhub_ic_v1_rfps_with_latest_snapshot\";\n\nconst RFP_INDEXER_QUERY_NAME =\n  \"polyprogrammist_near_devhub_ic_v1_rfp_snapshots\";\n\nconst PROPOSAL_FEED_INDEXER_QUERY_NAME =\n  \"polyprogrammist_near_devhub_ic_v1_proposals_with_latest_snapshot\";\n\nconst PROPOSAL_QUERY_NAME =\n  \"polyprogrammist_near_devhub_ic_v1_proposal_snapshots\";\nconst RFP_TIMELINE_STATUS = {\n  ACCEPTING_SUBMISSIONS: \"ACCEPTING_SUBMISSIONS\",\n  EVALUATION: \"EVALUATION\",\n  PROPOSAL_SELECTED: \"PROPOSAL_SELECTED\",\n  CANCELLED: \"CANCELLED\",\n};\n\nconst PROPOSAL_TIMELINE_STATUS = {\n  DRAFT: \"DRAFT\",\n  REVIEW: \"REVIEW\",\n  APPROVED: \"APPROVED\",\n  REJECTED: \"REJECTED\",\n  CANCELED: \"CANCELLED\",\n  APPROVED_CONDITIONALLY: \"APPROVED_CONDITIONALLY\",\n  PAYMENT_PROCESSING: \"PAYMENT_PROCESSING\",\n  FUNDED: \"FUNDED\",\n};\n\nconst QUERYAPI_ENDPOINT = `https://near-queryapi.api.pagoda.co/v1/graphql`;\n\nasync function fetchGraphQL(operationsDoc, operationName, variables) {\n  return asyncFetch(QUERYAPI_ENDPOINT, {\n    method: \"POST\",\n    headers: { \"x-hasura-role\": `polyprogrammist_near` },\n    body: JSON.stringify({\n      query: operationsDoc,\n      variables: variables,\n      operationName: operationName,\n    }),\n  });\n}\n\nconst CANCEL_RFP_OPTIONS = {\n  CANCEL_PROPOSALS: \"CANCEL_PROPOSALS\",\n  UNLINK_PROPOSALS: \"UNLINK_PROPOSALSS\",\n  NONE: \"NONE\",\n};\n\nfunction parseJSON(json) {\n  if (typeof json === \"string\") {\n    try {\n      return JSON.parse(json);\n    } catch (error) {\n      return json;\n    }\n  } else {\n    return json;\n  }\n}\n\nfunction isNumber(value) {\n  return typeof value === \"number\";\n}\n\nconst PROPOSALS_APPROVED_STATUS_ARRAY = [\n  PROPOSAL_TIMELINE_STATUS.APPROVED,\n  PROPOSAL_TIMELINE_STATUS.APPROVED_CONDITIONALLY,\n  PROPOSAL_TIMELINE_STATUS.PAYMENT_PROCESSING,\n  PROPOSAL_TIMELINE_STATUS.FUNDED,\n];\n\nfunction getLinkUsingCurrentGateway(url) {\n  const data = fetch(`https://httpbin.org/headers`);\n  const gatewayURL = data?.body?.headers?.Origin ?? \"\";\n  return `https://${\n    gatewayURL.includes(\"near.org\") ? \"dev.near.org\" : \"near.social\"\n  }/${url}`;\n}\n/* END_INCLUDE: \"includes/common.jsx\" */\n\nconst { href } = VM.require(`${REPL_DEVHUB}/widget/core.lib.url`);\nhref || (href = () => {});\n\nconst snapshotHistory = props.snapshotHistory;\nconst approvedProposals = props.approvedProposals ?? [];\n\nconst Wrapper = styled.div`\n  position: relative;\n  .log-line {\n    position: absolute;\n    left: 7%;\n    top: -30px;\n    bottom: 0;\n    z-index: 1;\n    width: 1px;\n    background-color: var(--bs-border-color);\n    z-index: 1;\n  }\n\n  .text-wrap {\n    overflow: hidden;\n    white-space: normal;\n  }\n\n  .fw-bold {\n    font-weight: 600 !important;\n  }\n\n  .inline-flex {\n    display: -webkit-inline-box !important;\n    align-items: center !important;\n    gap: 0.25rem !important;\n    margin-right: 2px;\n    flex-wrap: wrap;\n  }\n`;\n\nconst CommentContainer = styled.div`\n  border: 1px solid lightgrey;\n  overflow: auto;\n`;\n\nconst Header = styled.div`\n  position: relative;\n  background-color: #f4f4f4;\n  height: 50px;\n\n  .menu {\n    position: absolute;\n    right: 10px;\n    top: 4px;\n    font-size: 30px;\n  }\n`;\n\n// check snapshot history all keys and values for differences\nfunction getDifferentKeysWithValues(obj1, obj2) {\n  return Object.keys(obj1)\n    .filter((key) => {\n      if (key !== \"editor_id\" && obj2.hasOwnProperty(key)) {\n        const value1 = obj1[key];\n        const value2 = obj2[key];\n        if (Array.isArray(value1) && Array.isArray(value2)) {\n          const sortedValue1 = [...value1].sort();\n          const sortedValue2 = [...value2].sort();\n          return JSON.stringify(sortedValue1) !== JSON.stringify(sortedValue2);\n        } else if (typeof value1 === \"object\" && typeof value2 === \"object\") {\n          return JSON.stringify(value1) !== JSON.stringify(value2);\n        } else {\n          return value1 !== value2;\n        }\n      }\n      return false;\n    })\n    .map((key) => ({\n      key,\n      originalValue: obj1[key],\n      modifiedValue: obj2[key],\n    }));\n}\n\nState.init({\n  data: null,\n  socialComments: null,\n  changedKeysListWithValues: null,\n});\n\nfunction sortTimelineAndComments() {\n  const comments = Social.index(\"comment\", props.item);\n\n  if (state.changedKeysListWithValues === null) {\n    const changedKeysListWithValues = snapshotHistory\n      .slice(1)\n      .map((item, index) => {\n        const startingPoint = snapshotHistory[index]; // Set comparison to the previous item\n        return {\n          editorId: item.editor_id,\n          ...getDifferentKeysWithValues(startingPoint, item),\n        };\n      });\n    State.update({ changedKeysListWithValues });\n  }\n\n  // sort comments and timeline logs by time\n  const snapShotTimeStamp = Array.isArray(snapshotHistory)\n    ? snapshotHistory.map((i) => {\n        return { blockHeight: null, timestamp: parseFloat(i.timestamp / 1e6) };\n      })\n    : [];\n\n  const commentsTimeStampPromise = Array.isArray(comments)\n    ? Promise.all(\n        comments.map((item) => {\n          return asyncFetch(\n            `https://api.near.social/time?blockHeight=${item.blockHeight}`\n          ).then((res) => {\n            const timeMs = parseFloat(res.body);\n            return {\n              blockHeight: item.blockHeight,\n              timestamp: timeMs,\n            };\n          });\n        })\n      ).then((res) => res)\n    : Promise.resolve([]);\n\n  commentsTimeStampPromise.then((commentsTimeStamp) => {\n    const combinedArray = [...snapShotTimeStamp, ...commentsTimeStamp];\n    combinedArray.sort((a, b) => a.timestamp - b.timestamp);\n    State.update({ data: combinedArray, socialComments: comments });\n  });\n}\n\nif ((snapshotHistory ?? []).length > 0) {\n  sortTimelineAndComments();\n}\n\nconst Comment = ({ commentItem }) => {\n  const { accountId, blockHeight } = commentItem;\n  const item = {\n    type: \"social\",\n    path: `${accountId}/post/comment`,\n    blockHeight,\n  };\n  const content = JSON.parse(Social.get(item.path, blockHeight) ?? \"null\");\n  const link = getLinkUsingCurrentGateway(\n    `${REPL_INFRASTRUCTURE_COMMITTEE}/widget/app?page=rfp&id=${props.id}&accountId=${accountId}&blockHeight=${blockHeight}`\n  );\n  function getHighlightCommentStyle() {\n    const highlightComment =\n      parseInt(props.blockHeight ?? \"\") === blockHeight &&\n      props.accountId === accountId;\n\n    return {\n      border: highlightComment ? \"2px solid black\" : \"\",\n    };\n  }\n\n  return (\n    <div style={{ zIndex: 99, background: \"white\" }}>\n      <div className=\"d-flex gap-2 flex-1\">\n        <div className=\"d-none d-sm-flex\">\n          <Widget\n            src={`${REPL_DEVHUB}/widget/devhub.entity.proposal.Profile`}\n            props={{\n              accountId: accountId,\n            }}\n          />\n        </div>\n        <CommentContainer\n          style={getHighlightCommentStyle()}\n          className=\"rounded-2 flex-1\"\n        >\n          <Header className=\"d-flex gap-3 align-items-center p-2 px-3\">\n            <div className=\"text-muted\">\n              <Link href={`/near/widget/ProfilePage?accountId=${accountId}`}>\n                <span className=\"fw-bold text-black\">{accountId}</span>\n              </Link>\n              commented \uff65{\" \"}\n              <Widget\n                src={`${REPL_NEAR}/widget/TimeAgo`}\n                props={{\n                  blockHeight: blockHeight,\n                }}\n              />\n            </div>\n            {context.accountId && (\n              <div className=\"menu\">\n                <Widget\n                  src={`${REPL_NEAR}/widget/Posts.Menu`}\n                  props={{\n                    accountId: accountId,\n                    blockHeight: blockHeight,\n                    contentPath: `/post/comment`,\n                    contentType: \"comment\",\n                  }}\n                />\n              </div>\n            )}\n          </Header>\n          <div className=\"p-2 px-3\">\n            <Widget\n              src={`${REPL_DEVHUB}/widget/devhub.components.molecule.MarkdownViewer`}\n              props={{\n                text: content.text,\n              }}\n            />\n\n            <div className=\"d-flex gap-2 align-items-center mt-4\">\n              <Widget\n                src={`${REPL_DEVHUB}/widget/devhub.entity.proposal.LikeButton`}\n                props={{\n                  item: item,\n                  notifyAccountId: accountId,\n                }}\n              />\n              <Widget\n                src={`${REPL_NEAR}/widget/CopyUrlButton`}\n                props={{\n                  url: link,\n                }}\n              />\n            </div>\n          </div>\n        </CommentContainer>\n      </div>\n    </div>\n  );\n};\n\nfunction capitalizeFirstLetter(string) {\n  const updated = string.replace(\"_\", \" \");\n  return updated.charAt(0).toUpperCase() + updated.slice(1).toLowerCase();\n}\n\nfunction parseTimelineKeyAndValue(timeline, originalValue, modifiedValue) {\n  const oldValue = originalValue[timeline];\n  const newValue = modifiedValue[timeline];\n  switch (timeline) {\n    case \"status\":\n      if (newValue === RFP_TIMELINE_STATUS.PROPOSAL_SELECTED) {\n        return (\n          <span className=\"inline-flex\">\n            moved RFP to{\" \"}\n            <Widget\n              src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/components.rfps.StatusTag`}\n              props={{\n                timelineStatus: newValue,\n              }}\n            />\n            \uff65 selected proposal(s) are{\" \"}\n            {approvedProposals.map((i, index) => (\n              <span>\n                <LinkToProposal id={i.proposal_id}>\n                  {\" \"}\n                  #{i.proposal_id} {i.name}\n                </LinkToProposal>\n                {index < approvedProposals.length - 1 && \", \"}\n              </span>\n            ))}\n          </span>\n        );\n      }\n      return (\n        oldValue !== newValue && (\n          <span className=\"inline-flex\">\n            moved RFP from{\" \"}\n            <Widget\n              src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/components.rfps.StatusTag`}\n              props={{\n                timelineStatus: oldValue,\n              }}\n            />\n            to{\" \"}\n            <Widget\n              src={`${REPL_INFRASTRUCTURE_COMMITTEE}/widget/components.rfps.StatusTag`}\n              props={{\n                timelineStatus: newValue,\n              }}\n            />\n            stage\n          </span>\n        )\n      );\n\n    default:\n      return null;\n  }\n}\n\nconst AccountProfile = ({ accountId }) => {\n  return (\n    <span className=\"inline-flex fw-bold text-black\">\n      <Widget\n        src={`${REPL_DEVHUB}/widget/devhub.entity.proposal.Profile`}\n        props={{\n          accountId: accountId,\n          size: \"sm\",\n          showAccountId: true,\n        }}\n      />\n    </span>\n  );\n};\n\nfunction symmetricDifference(arr1, arr2) {\n  const diffA = arr1.filter((item) => !arr2.includes(item));\n  const diffB = arr2.filter((item) => !arr1.includes(item));\n  return [...diffA, ...diffB];\n}\n\nconst LinkToProposal = ({ id, children }) => {\n  return (\n    <a\n      className=\"text-decoration-underline flex-1\"\n      href={href({\n        widgetSrc: `${REPL_INFRASTRUCTURE_COMMITTEE}/widget/app`,\n        params: {\n          page: \"proposal\",\n          id: id,\n        },\n      })}\n      target=\"_blank\"\n      rel=\"noopener noreferrer\"\n    >\n      {children}\n    </a>\n  );\n};\n\nconst parseProposalKeyAndValue = (key, modifiedValue, originalValue) => {\n  switch (key) {\n    case \"name\":\n      return <span>changed title</span>;\n    case \"summary\":\n    case \"description\":\n      return <span>changed {key}</span>;\n    case \"labels\":\n      return <span>changed labels to {(modifiedValue ?? []).join(\", \")}</span>;\n    case \"linked_proposals\": {\n      const newProposals = modifiedValue || [];\n      const oldProposals = originalValue || [];\n      const difference = symmetricDifference(oldProposals, newProposals).join(\n        \",\"\n      );\n\n      const isUnlinked = oldProposals.length > newProposals.length;\n      const actionText = isUnlinked\n        ? \"unlinked a proposal\"\n        : \"linked a proposal\";\n\n      return (\n        <span>\n          {actionText}{\" \"}\n          <LinkToProposal id={difference}> #{difference}</LinkToProposal>\n        </span>\n      );\n    }\n    case \"timeline\": {\n      const modifiedKeys = Object.keys(modifiedValue);\n      const originalKeys = Object.keys(originalValue);\n      return modifiedKeys.map((i, index) => {\n        const text = parseTimelineKeyAndValue(i, originalValue, modifiedValue);\n        return (\n          text && (\n            <span key={index} className=\"inline-flex\">\n              {text}\n              {text &&\n                originalKeys.length > 1 &&\n                index < modifiedKeys.length - 1 &&\n                \"\uff65\"}\n            </span>\n          )\n        );\n      });\n    }\n    default:\n      return null;\n  }\n};\n\nconst LogIconContainer = styled.div`\n  margin-left: 50px;\n  z-index: 99;\n\n  @media screen and (max-width: 768px) {\n    margin-left: 10px;\n  }\n`;\n\nconst Log = ({ timestamp }) => {\n  const updatedData = useMemo(\n    () =>\n      state.changedKeysListWithValues.find((obj) =>\n        Object.values(obj).some(\n          (value) =>\n            value && parseFloat(value.modifiedValue / 1e6) === timestamp\n        )\n      ),\n    [state.changedKeysListWithValues, timestamp]\n  );\n\n  const editorId = updatedData.editorId;\n  const valuesArray = Object.values(updatedData ?? {});\n  // if valuesArray length is 2 that means it only has timestamp and editorId\n  if (!updatedData || valuesArray.length === 2) {\n    return <></>;\n  }\n\n  return valuesArray.map((i, index) => {\n    if (i.key && i.key !== \"timestamp\") {\n      return (\n        <LogIconContainer\n          className=\"d-flex gap-3 align-items-center\"\n          key={index}\n        >\n          <img\n            src=\"https://ipfs.near.social/ipfs/bafkreiffqrxdi4xqu7erf46gdlwuodt6dm6rji2jtixs3iionjvga6rhdi\"\n            height={30}\n          />\n          <div\n            className={\n              \"flex-1 gap-1 w-100 text-wrap text-muted align-items-center \" +\n              (i.key === \"timeline\" &&\n              Object.keys(i.originalValue ?? {}).length > 1\n                ? \"\"\n                : \"inline-flex\")\n            }\n          >\n            <span className=\"inline-flex fw-bold text-black\">\n              <AccountProfile accountId={editorId} showAccountId={true} />\n            </span>\n            {parseProposalKeyAndValue(i.key, i.modifiedValue, i.originalValue)}\n            \uff65\n            <Widget\n              src={`${REPL_NEAR}/widget/TimeAgo`}\n              props={{\n                blockTimestamp: timestamp * 1000000,\n              }}\n            />\n          </div>\n        </LogIconContainer>\n      );\n    }\n  });\n};\n\nif (Array.isArray(state.data)) {\n  return (\n    <Wrapper>\n      <div\n        className=\"log-line\"\n        style={{ height: state.data.length > 2 ? \"110%\" : \"150%\" }}\n      ></div>\n      <div className=\"d-flex flex-column gap-4\">\n        {state.data.map((i, index) => {\n          if (i.blockHeight) {\n            const item = state.socialComments.find(\n              (t) => t.blockHeight === i.blockHeight\n            );\n            return <Comment commentItem={item} />;\n          } else {\n            return <Log timestamp={i.timestamp} key={index} />;\n          }\n        })}\n      </div>\n    </Wrapper>\n  );\n}\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/infrastructure-committee.near/widget/components.rfps.CommentsAndLogs", "fact_widget_deployments_id": "93b5cea792f8cb43dd08bca35cc345f5", "inserted_timestamp": "2024-06-08T14:04:05.979Z", "modified_timestamp": "2024-06-08T14:04:05.979Z", "__row_index": 1}