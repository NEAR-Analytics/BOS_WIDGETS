{"tx_hash": "AjtAvUCh9GYLzcPkpDJ2VRg95qTCmHFa21vCby9tutYh", "action_id_social": "DMT48ov8er4CAb6u2nTpyYGcB9e2G8osiWqgmD66GgRD-0-widget", "block_id": 104396795, "block_timestamp": "2023-10-28T15:45:38.950Z", "signer_id": "fcff4038fecb38b0e63ee9e865f363886415006ec9413ea70dbae598207f201c", "widget_name": "Map.Mapbox", "source_code": "const mydata = fetch(\n  \"https://jessiejessje.github.io/hackoween/mydata_clean.json\"\n);\nconst street_name_data = JSON.stringify(mydata.body);\n\nconst token = `pk.eyJ1IjoiZWpsYnJhZW0iLCJhIjoiY2xrbmIwaW53MGE0NTNtbGsydWd2MmpyZSJ9.m1ZfEqv2fGet2zblGknT8A`;\n\nif (!street_name_data) {\n  return <p>Loading...</p>;\n}\n\nconst Container = styled.div`\n  height: 100vh;\n  display: flex;\n\n  /* reset */\n  button,\n  fieldset,\n  input {\n    all: unset;\n  }\n`;\n\nconst code = `\n\n<!DOCTYPE html>\n<html>\n    <head>\n        <meta charset='utf-8'/>\n        <title>Mapbox Directions API Example</title>\n        <meta name='viewport' content='width=device-width, initial-scale=1'>\n        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>\n        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet'/>\n        <style>\n            body {\n                margin: 0;\n                padding: 0;\n            }\n            #map {\n                position: absolute;\n                top: 0;\n                bottom: 0;\n                width: 100%;\n                height: 100%\n            }\n            #instructions {\n                position: absolute;\n                margin: 20px;\n                width: 25%;\n                top: 0;\n                bottom: 20%;\n                padding: 20px;\n                background-color: #fff;\n                overflow-y: scroll;\n                font-family: sans-serif;\n            }\n        </style>\n    </head>\n    <body>\n        <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js'></script>\n        <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css' type='text/css'>\n        <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>\n\n\n        <div id='map'></div>\n\n        <div id='instructions'></div>\n\n        <script>\n            const accessToken = 'pk.eyJ1IjoiZWpsYnJhZW0iLCJhIjoiY2xrbmIwaW53MGE0NTNtbGsydWd2MmpyZSJ9.m1ZfEqv2fGet2zblGknT8A';\n            mapboxgl.accessToken = accessToken;\n\n            const map = new mapboxgl.Map({\n                container: 'map',\n                style: 'mapbox://styles/mapbox/streets-v11',\n                center: [\n                    -73.981997, 40.712776\n                ], // New York City coordinates\n                zoom: 12\n            });\n\n\n            const start = [-73.9783516, 40.7871829];\n            const instructions = document.getElementById('instructions');\n            let catalog = '';\n\n            async function getRoute(end) {\n\n                // make a directions request using cycling profile\n                // an arbitrary start will always be the same\n                // only the end or destination will change\n\n                // const queryurl = 'https://api.mapbox.com/directions/v5/mapbox/cycling/' + start[0] + ',' + start[1]+ ';' + end[0] + ',' + end[1] +'?steps=true&geometries=geojson&access_token='+mapboxgl.accessToken+'}';\n                // console.log(queryurl);\n\n                const query = await fetch('https://api.mapbox.com/directions/v5/mapbox/cycling/' + start[0] + ',' + start[1]+ ';' + end[0] + ',' + end[1] +'?steps=true&geometries=geojson&access_token='+mapboxgl.accessToken);\n                const json = await query.json();\n                const data = json.routes[0];\n\n\n                const route = data.geometry.coordinates;\n                const geojson = {\n                    type: 'Feature',\n                    properties: {},\n                    geometry: {\n                        type: 'LineString',\n                        coordinates: route\n                    }\n                };\n\n\n                // if the route already exists on the map, we'll reset it using setData\n                if (map.getSource('route')) {\n                    map.getSource('route').setData(geojson);\n                }\n\n                // otherwise, we'll make a new request else {\n                map.addLayer({\n                    id: 'route',\n                    type: 'line',\n                    source: {\n                        type: 'geojson',\n                        data: geojson\n                    },\n                    layout: {\n                        'line-join': 'round',\n                        'line-cap': 'round'\n                    },\n                    paint: {\n                        'line-color': '#3887be',\n                        'line-width': 5,\n                        'line-opacity': 0.75\n                    }\n                });\n\n\n                if (map.getSource('route')) {\n                    // const response = await fetch('https://jessiejessje.github.io/hackoween/mydata_clean.json');\n                    // const street_name_data = await response.json();\n\n\n                    const bufferDistance = 0.5;\n                    const buffer = turf.buffer(geojson, bufferDistance, {units: 'kilometers'});\n                    const poly = turf.polygon([buffer.geometry.coordinates[0]])\n\n                    instructions.innerHTML = \"<p><strong>Trip summary: </strong></p>\";\n\n                    for (let d of ${street_name_data}) {\n                        const spot = {\n                            type: 'Feature',\n                            geometry: {\n                                type: 'Point',\n                                coordinates: [d.long, d.lat]\n                            }\n                        };\n\n                        const isNearRoute = turf.booleanPointInPolygon(spot.geometry.coordinates, poly);\n\n                        if (isNearRoute) {\n                            const marker = new mapboxgl.Marker({color: '#ff7518'}).setLngLat([d.long, d.lat]).addTo(map);\n                            instructions.innerHTML += \"<li>\" + d.coname + \"</li>\";\n                        } else {\n                            const marker = new mapboxgl.Marker({color: '#efefef'}).setLngLat([d.long, d.lat]).addTo(map);\n                        }\n                    }\n                    // add turn instructions here at the end\n                    console.log(instructions.innerHTML ,'html')\n\n                } // end of markers\n            }\n            \n            map.on('load', () => {\n                // make an initial directions request that\n                // starts and ends at the same location\n                getRoute(start);\n\n                // Add starting point to the map\n                map.addLayer({\n                    id: 'point',\n                    type: 'circle',\n                    source: {\n                        type: 'geojson',\n                        data: {\n                            type: 'FeatureCollection',\n                            features: [\n                                {\n                                    type: 'Feature',\n                                    properties: {},\n                                    geometry: {\n                                        type: 'Point',\n                                        coordinates: start\n                                    }\n                                }\n                            ]\n                        }\n                    },\n                    paint: {\n                        'circle-radius': 10,\n                        'circle-color': '#3887be'\n                    }\n                });\n                // this is where the code from the next step will go\n                map.on('click', (event) => {\n                    const coords = Object.keys(event.lngLat).map((key) => event.lngLat[key]);\n                    const end = {\n                        type: 'FeatureCollection',\n                        features: [\n                            {\n                                type: 'Feature',\n                                properties: {},\n                                geometry: {\n                                    type: 'Point',\n                                    coordinates: coords\n                                }\n                            }\n                        ]\n                    };\n                    if (map.getLayer('end')) {\n                        map.getSource('end').setData(end);\n\n                    } else {\n                        map.addLayer({\n                            id: 'end',\n                            type: 'circle',\n                            source: {\n                                type: 'geojson',\n                                data: {\n                                    type: 'FeatureCollection',\n                                    features: [\n                                        {\n                                            type: 'Feature',\n                                            properties: {},\n                                            geometry: {\n                                                type: 'Point',\n                                                coordinates: coords\n                                            }\n                                        }\n                                    ]\n                                }\n                            },\n                            paint: {\n                                'circle-radius': 10,\n                                'circle-color': '#f30'\n                            }\n                        });\n                    } getRoute(coords);\n\n\n                });\n            });\n        </script>\n    </body>\n</html>\n\n\n\n`;\n\nreturn (\n  <Container>\n    <iframe id=\"myMap\" className=\"w-100 h-100\" srcDoc={code} />\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/fcff4038fecb38b0e63ee9e865f363886415006ec9413ea70dbae598207f201c/widget/Map.Mapbox", "fact_widget_deployments_id": "96811aa7f4e992c981c6297b70c30748", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 1}