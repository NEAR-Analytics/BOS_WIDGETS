{"tx_hash": "BqeM3Ywrc6fsJGRBfTmgj9VLZufr74kUFAWeWG4uzbeu", "action_id_social": "CbcXWw3Bg8VRMuq2gTqPrRBAjKnvCgLnqJrKCkR4mXx5-0-widget", "block_id": 115722656, "block_timestamp": "2024-03-29T14:20:36.213Z", "signer_id": "potlock.near", "widget_name": "Project.PotlockFunding", "source_code": "const {\n  hrefWithParams,\n  donations,\n  directDonations,\n  matchingRoundDonations,\n  potPayouts,\n  sponsorships,\n  projectId,\n  totalDonationAmountNear,\n  uniqueDonors,\n  totalMatched,\n} = props;\n\nconst { ownerId, SUPPORTED_FTS } = VM.require(\"potlock.near/widget/constants\") || {\n  ownerId: \"\",\n  SUPPORTED_FTS: {},\n};\n\nconst { _address, getTimePassed } = VM.require(`potlock.near/widget/Components.DonorsUtils`) || {\n  _address: () => \"\",\n  getTimePassed: () => \"\",\n};\nconst { nearToUsd } = VM.require(\"potlock.near/widget/utils\");\n\nconst [filter, setFilter] = useState({\n  date: false, // false === ascending\n  price: false, // false === ascending\n});\nconst [currentFilter, setCurrentFilter] = useState(\"date\");\nconst [sort, setSort] = useState(\"all\");\nconst [currentPage, setCurrentPage] = useState(1);\nconst [totalDonations, setTotalDonations] = useState(donations);\nconst [filteredDonations, setFilteredDonations] = useState(donations);\nconst [search, setSearch] = useState(\"\");\n\nconst perPage = 30; // need to be less than 50\n\nuseEffect(() => {\n  setTotalDonations(donations);\n  setFilteredDonations(donations);\n}, [donations]);\n\nconst sortList = {\n  all: {\n    label: \"All donations\",\n    val: \"all\",\n    count: donations?.length,\n  },\n  direct: {\n    label: \"Direct donations\",\n    val: \"direct\",\n    count: directDonations?.length,\n  },\n  matched: {\n    label: \"Matched donations\",\n    val: \"matched\",\n    count: matchingRoundDonations?.length,\n  },\n  ...(projectId\n    ? {\n        payout: {\n          label: \"Matching pool allocations\",\n          val: \"payout\",\n          count: potPayouts?.length,\n        },\n      }\n    : {\n        sponsorship: {\n          label: \"Sponsorships\",\n          val: \"sponsorship\",\n          count: sponsorships?.length,\n        },\n      }),\n};\n\nconst searchDonations = (searchTerm) => {\n  const filteredApplications = totalDonations.filter((item) => {\n    const searchIn = [\n      item.pot_name || \"\",\n      item.recipient_id || \"\",\n      item.project_id || \"\",\n      item.donor_id || \"\",\n      item.pot_id || \"\",\n    ];\n    return searchIn.some((item) => item.toLowerCase().includes(searchTerm.toLowerCase()));\n  });\n  return filteredApplications;\n};\n\nconst getDate = (donation) => donation.donated_at_ms || donation.donated_at;\n\nconst sortDonation = (type) => {\n  setCurrentFilter(type);\n  const sort = !filter[type];\n  setFilter({ ...filter, [type]: sort });\n  if (type === \"price\") {\n    const sortedDonations = filteredDonations.sort((a, b) =>\n      sort ? b.total_amount - a.total_amount : a.total_amount - b.total_amount\n    );\n    setFilteredDonations(sortedDonations);\n  } else if (type === \"date\") {\n    const sortedDonations = filteredDonations.sort((a, b) => {\n      return sort ? getDate(a) - getDate(b) : getDate(b) - getDate(a);\n    });\n    setFilteredDonations(sortedDonations);\n  }\n};\n\nconst filterDonations = (sortVal) => {\n  const displayedDonations = searchDonations(search);\n  let filtered;\n  if (sortVal && sortVal !== \"all\") {\n    filtered = displayedDonations.filter((donation) => {\n      return sortList[donation.type].val === sortVal;\n    });\n    return filtered;\n  } else {\n    return displayedDonations;\n  }\n};\n\nconst getName = (donation) => {\n  switch (donation.type) {\n    case \"direct\":\n      return projectId ? donation.donor_id : donation.recipient_id;\n    case \"sponsorship\":\n      return donation.pot_name;\n    case \"payout\":\n      return donation.pot_name;\n    case \"matched\":\n      return projectId ? donation.donor_id : donation.project_id;\n    default:\n      return projectId ? donation.donor_id : donation.recipient_id;\n  }\n};\n\nconst Container = styled.div`\n  display: flex;\n  flex-direction: column;\n  gap: 1.5rem;\n`;\nconst Title = styled.div`\n  font-size: 24px;\n  font-weight: 600;\n`;\nconst PotlockFunding = styled.div`\n  display: flex;\n  flex-direction: column;\n  width: 100%;\n  border-radius: 6px;\n  border: 1px solid #7b7b7b;\n  background: #fff;\n  overflow: hidden;\n  .header {\n    border-bottom: 0.5px solid #7b7b7b;\n    padding: 0.5rem 1rem;\n    div {\n      font-weight: 600;\n    }\n    @media screen and (max-width: 768px) {\n      .tab {\n        display: none;\n      }\n      .funding {\n        display: block;\n      }\n    }\n  }\n  .funding-row {\n    padding: 1rem;\n  }\n  .header,\n  .funding-row {\n    display: flex;\n    justify-content: space-between;\n    gap: 2rem;\n    font-size: 14px;\n    flex-wrap: wrap;\n    @media screen and (max-width: 768px) {\n      gap: 4px;\n    }\n  }\n  .tab {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    width: 156px;\n    justify-content: left;\n    &.sort {\n      cursor: pointer;\n      svg {\n        transition: rotate 300ms;\n      }\n    }\n    @media screen and (max-width: 768px) {\n      white-space: nowrap;\n      width: 60px;\n    }\n  }\n  .funding {\n    flex: 1;\n  }\n  .price {\n    gap: 1rem;\n    font-weight: 600;\n    justify-content: left;\n    svg {\n      width: 1.5em;\n    }\n  }\n  .date {\n    justify-content: right;\n  }\n  @media screen and (max-width: 768px) {\n    .price {\n      gap: 0.5rem;\n    }\n    .date {\n      width: 100%;\n      justify-content: left;\n      color: #7b7b7b;\n      margin-left: 2.5rem;\n    }\n  }\n`;\n\nconst FundingSrc = styled.div`\n  display: flex;\n  align-items: center;\n  gap: 1rem;\n  flex: 1;\n  max-width: 100%;\n  gap: 1rem;\n  .profile-image {\n    width: 24px;\n    height: 24px;\n  }\n  .funding-src {\n    display: flex;\n    flex-direction: column;\n    .pot-name {\n      color: inherit;\n      font-weight: inherit;\n      display: none;\n    }\n    a {\n      color: #292929;\n      transition: 300ms;\n      font-weight: 600;\n      :hover {\n        text-decoration: none;\n        color: #dd3345;\n      }\n    }\n    .type {\n      color: #7b7b7b;\n    }\n  }\n  @media screen and (max-width: 768px) {\n    .funding-src .type {\n      display: none;\n    }\n    .funding-src .pot-name {\n      display: inline-block;\n    }\n  }\n`;\n\nconst SearchBar = styled.div`\n  display: flex;\n  align-items: center;\n  background: #f6f5f3;\n  position: relative;\n  svg {\n    width: 18px;\n    left: 1rem;\n    top: 50%;\n    transform: translateY(-50%);\n    position: absolute;\n    pointer-events: none;\n  }\n  input {\n    width: 100%;\n    height: 100%;\n    padding: 1rem;\n    padding-left: 50px;\n    border: none;\n    background: transparent;\n    :focus {\n      outline: none;\n    }\n  }\n`;\n\nconst Stats = styled.div`\n  display: flex;\n  flex-wrap: wrap;\n  margin: 24px 0;\n  align-items: center;\n  .item {\n    display: flex;\n    height: fit-content;\n    gap: 8px;\n    padding-right: 1rem;\n    align-items: center;\n    :nth-child(2) {\n      border-right: 1px solid #7b7b7b;\n      border-left: 1px solid #7b7b7b;\n      padding-left: 1rem;\n    }\n    :nth-child(3) {\n      padding-left: 1rem;\n    }\n    .item-value {\n      font-weight: 600;\n    }\n    @media screen and (max-width: 768px) {\n      display: none;\n    }\n  }\n  .dropdown {\n    margin-left: auto;\n    @media screen and (max-width: 480px) {\n      margin-right: auto;\n      margin-left: 0;\n    }\n  }\n`;\n\nconst Sort = styled.div`\n  display: none;\n  justify-content: space-between;\n  width: 100%;\n  div {\n    display: flex;\n    align-items: center;\n    font-weight: 500;\n    cursor: pointer;\n    gap: 8px;\n    color: #7b7b7b;\n    svg {\n      transition: rotate 300ms;\n    }\n    &.active {\n      color: #292929;\n    }\n  }\n  @media screen and (max-width: 768px) {\n    display: flex;\n  }\n`;\n\nconst DropdownLabel = styled.div`\n  display: flex;\n  gap: 10px;\n  align-items: center;\n  .label {\n    font-weight: 500;\n  }\n  .count {\n    display: flex;\n    width: ${({ digit }) => 24 + (digit - 1) * 6}px;\n    height: ${({ digit }) => 24 + (digit - 1) * 6}px;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n    background: #ebebeb;\n  }\n`;\n\nconst ImgIcon = styled.img`\n  width: 21px;\n  height: 21px;\n`;\nconst stats = {\n  ...(totalDonationAmountNear\n    ? {\n        Donated: (\n          <>\n            {totalDonationAmountNear}N\n            {nearToUsd && <span>~${(totalDonationAmountNear * nearToUsd).toFixed(2)}</span>}\n          </>\n        ),\n      }\n    : {}),\n  ...(uniqueDonors ? { [`Unique donor${uniqueDonors === 1 ? \"\" : \"s\"}`]: uniqueDonors } : {}),\n  ...(uniqueDonors ? { \"Total Matched\": totalMatched + \"N\" } : {}),\n};\n\nconst NearIcon = (props) => (\n  <svg {...props} viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" id=\"near-logo\">\n    <rect width=\"24\" height=\"24\" rx=\"12\" fill=\"#CECECE\" />\n    <path\n      d=\"M15.616 6.61333L13.1121 10.3333C12.939 10.5867 13.2719 10.8933 13.5117 10.68L15.9756 8.53333C16.0422 8.48 16.1354 8.52 16.1354 8.61333V15.32C16.1354 15.4133 16.0155 15.4533 15.9623 15.3867L8.50388 6.45333C8.26415 6.16 7.91787 6 7.53163 6H7.26526C6.5727 6 6 6.57333 6 7.28V16.72C6 17.4267 6.5727 18 7.27858 18C7.71809 18 8.13097 17.7733 8.3707 17.3867L10.8746 13.6667C11.0477 13.4133 10.7148 13.1067 10.475 13.32L8.0111 15.4533C7.94451 15.5067 7.85128 15.4667 7.85128 15.3733V8.68C7.85128 8.58667 7.97114 8.54667 8.02442 8.61333L15.4828 17.5467C15.7225 17.84 16.0821 18 16.4551 18H16.7214C17.4273 18 18 17.4267 18 16.72V7.28C18 6.57333 17.4273 6 16.7214 6C16.2686 6 15.8557 6.22667 15.616 6.61333Z\"\n      fill=\"black\"\n    />\n  </svg>\n);\n\nconst ProfileImg = ({ address }) => (\n  <Widget src=\"mob.near/widget/ProfileImage\" props={{ accountId: address, style: {} }} />\n);\n\nconst PotIcon = () => (\n  <svg width=\"20\" height=\"21\" viewBox=\"0 0 20 21\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n    <path\n      fill-rule=\"evenodd\"\n      clip-rule=\"evenodd\"\n      d=\"M10 3C10.5523 3 11 2.55228 11 2C11 1.44772 10.5523 1 10 1C9.44772 1 9 1.44772 9 2C9 2.55228 9.44772 3 10 3ZM12 2C12 2.37912 11.8945 2.7336 11.7113 3.03569C14.6721 3.33449 17.0882 5.47841 17.7921 8.3C17.9279 8.84425 18 9.41371 18 10H16.3H3.7H2C2 9.41371 2.07208 8.84425 2.20786 8.3C2.9118 5.47841 5.3279 3.33449 8.28871 3.03569C8.10549 2.7336 8 2.37912 8 2C8 0.895431 8.89543 0 10 0C11.1046 0 12 0.895431 12 2ZM9 4.7C6.66751 4.7 4.68694 6.20674 3.97852 8.3H16.0215C15.3131 6.20674 13.3325 4.7 11 4.7H9ZM0 11H2H4H16H18H20V13H18V19C18 20.1046 17.1046 21 16 21H4C2.89543 21 2 20.1046 2 19V13H0V11ZM4 19V13H16V19H4Z\"\n      fill=\"#7B7B7B\"\n    />\n  </svg>\n);\n\nconst Arrow = (props) => (\n  <svg\n    {...props}\n    style={{ rotate: !props.active ? \"0deg\" : \"180deg\" }}\n    width=\"12\"\n    height=\"12\"\n    viewBox=\"0 0 12 12\"\n    fill=\"none\"\n    xmlns=\"http://www.w3.org/2000/svg\"\n  >\n    <path\n      d=\"M0 6L1.0575 7.0575L5.25 2.8725V12H6.75V2.8725L10.935 7.065L12 6L6 0L0 6Z\"\n      fill=\"#7B7B7B\"\n    />\n  </svg>\n);\n\nconst [ftMetadata, setFtMetadata] = useState({});\n\nuseEffect(() => {\n  // Fetches FT metadata (required for icons & decimals)\n  const metadata = {};\n  const ftIds = totalDonations.reduce((acc, donation) => {\n    if (donation.ft_id && donation.ft_id !== \"near\") {\n      acc.add(donation.ft_id);\n    }\n    return acc;\n  }, new Set());\n  ftIds.forEach((ftId) => {\n    Near.asyncView(ftId, \"ft_metadata\", {})\n      .then((ftMetadata) => {\n        metadata[ftId] = ftMetadata;\n        if (Object.keys(metadata).length === ftIds.size) {\n          setFtMetadata(metadata);\n        }\n      })\n      .catch((e) => {\n        console.error(\"error getting ft metadata: \", e);\n      });\n  });\n}, [totalDonationa]);\n\nreturn (\n  <Container>\n    {projectId && <Title>Potlock Funding</Title>}\n    <Stats>\n      {Object.keys(stats).map((k) => (\n        <div className=\"item\">\n          <div className=\"item-value\">{stats[k]}</div>\n          <div className=\"item-label\">{k}</div>\n        </div>\n      ))}\n      <div className=\"dropdown\">\n        <Widget\n          src={`${ownerId}/widget/Inputs.Dropdown`}\n          props={{\n            sortVal: (\n              <DropdownLabel digit={sortList[sort].count.toString().length}>\n                <div className=\"label\">{sortList[sort].label}</div>\n                <div className=\"count\">{sortList[sort].count}</div>\n              </DropdownLabel>\n            ),\n            showCount: true,\n            sortList: Object.values(sortList),\n            FilterMenuCustomStyle: `left:auto; right:0;`,\n            handleSortChange: ({ val }) => {\n              const filtered = filterDonations(val);\n              setFilteredDonations(filtered);\n              setSort(val);\n            },\n          }}\n        />\n      </div>\n    </Stats>\n    <Sort>\n      <div\n        onClick={() => sortDonation(\"date\")}\n        className={`${currentFilter === \"date\" ? \"active\" : \"\"}`}\n      >\n        Sort Date {currentFilter === \"date\" && <Arrow active={!filter.date} />}\n      </div>\n      <div\n        onClick={() => sortDonation(\"price\")}\n        className={`${currentFilter === \"price\" ? \"active\" : \"\"}`}\n      >\n        Sort Amount {currentFilter === \"price\" && <Arrow active={filter.price} />}\n      </div>\n    </Sort>\n    <PotlockFunding>\n      <div className=\"header\">\n        <div className=\"funding tab\">{projectId ? \"Funding Source\" : \"Project Name\"}</div>\n        <div className=\"tab sort\" onClick={() => sortDonation(\"price\")}>\n          Amount {currentFilter === \"price\" && <Arrow active={filter.price} />}\n        </div>\n        <div className=\"tab sort date\" onClick={() => sortDonation(\"date\")}>\n          Date {currentFilter === \"date\" && <Arrow active={!filter.date} />}\n        </div>\n      </div>\n      <SearchBar>\n        <svg viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n          <path\n            d=\"M15.7549 14.2549H14.9649L14.6849 13.9849C15.6649 12.8449 16.2549 11.3649 16.2549 9.75488C16.2549 6.16488 13.3449 3.25488 9.75488 3.25488C6.16488 3.25488 3.25488 6.16488 3.25488 9.75488C3.25488 13.3449 6.16488 16.2549 9.75488 16.2549C11.3649 16.2549 12.8449 15.6649 13.9849 14.6849L14.2549 14.9649V15.7549L19.2549 20.7449L20.7449 19.2549L15.7549 14.2549ZM9.75488 14.2549C7.26488 14.2549 5.25488 12.2449 5.25488 9.75488C5.25488 7.26488 7.26488 5.25488 9.75488 5.25488C12.2449 5.25488 14.2549 7.26488 14.2549 9.75488C14.2549 12.2449 12.2449 14.2549 9.75488 14.2549Z\"\n            fill=\"#C7C7C7\"\n          />\n        </svg>\n        <input\n          className=\"\"\n          placeholder=\"Search funding\"\n          onChange={(e) => {\n            if (currentPage !== 1) setCurrentPage(1);\n            setSearch(e.target.value);\n            const filtered = searchDonations(e.target.value);\n            setFilteredDonations(filtered);\n          }}\n          type=\"text\"\n        />\n      </SearchBar>\n      {filteredDonations\n        .slice((currentPage - 1) * perPage, currentPage * perPage)\n        .map((donation) => {\n          const {\n            donor_id,\n            total_amount,\n            amount,\n            pot_id,\n            recipient_id,\n            project_id,\n            paid_at,\n            base_currency,\n            ft_id,\n            type,\n            donated_at,\n            donated_at_ms,\n          } = donation;\n\n          const ftId = ft_id || base_currency;\n\n          const donationAmount = parseFloat(\n            Big(total_amount || amount)\n              .div(Big(10).pow(ftId === \"near\" ? 24 : ftMetadata[ftId]?.decimals || 24))\n              .toFixed(2)\n          );\n          const addTrailingZeros = (number) => {\n            if ((number < 100) & (number >= 0.1)) return number.toFixed(1);\n            return number;\n          };\n          const isPot = type === \"payout\" || type === \"sponsorship\";\n\n          const url = isPot\n            ? `?tab=pot&potId=${pot_id}`\n            : projectId\n            ? `?tab=profile&accountId=${donor_id}`\n            : `?tab=project&projectId=${project_id || recipient_id}`;\n\n          const name = _address(getName(donation), 15);\n\n          return (\n            <div className=\"funding-row\">\n              <FundingSrc>\n                {isPot ? (\n                  <PotIcon className=\"profile-image\" />\n                ) : (\n                  <ProfileImg address={projectId ? donor_id : recipient_id || project_id} />\n                )}\n                <div className=\"funding-src\">\n                  <a href={hrefWithParams(url)} target=\"_blank\">\n                    {isPot && (\n                      <span className=\"pot-name\"> {projectId ? \"Matching Pool\" : \"Sponsor\"} :</span>\n                    )}{\" \"}\n                    {name}\n                  </a>\n                  <div className=\"type\">{sortList[type].label?.slice(0, -1)}</div>\n                </div>\n              </FundingSrc>\n              <div className=\"price tab\">\n                <div className=\"near-icon\">\n                  {ftId === \"near\" ? <NearIcon /> : <ImgIcon src={ftMetadata[ftId]?.icon} />}\n                </div>\n                {addTrailingZeros(donationAmount)}\n              </div>\n              <div className=\"tab date\">\n                {getTimePassed(donated_at_ms || donated_at || paid_at, true)} ago\n              </div>\n            </div>\n          );\n        })}\n      {filteredDonations.length === 0 && <div className=\"funding-row\">No Donations</div>}\n    </PotlockFunding>\n    <Widget\n      src={`${ownerId}/widget/Components.Pagination`}\n      props={{\n        onPageChange: (page) => {\n          setCurrentPage(page);\n        },\n        data: filteredDonations,\n        currentPage,\n        perPage: perPage,\n        bgColor: \"#7B7B7B\",\n      }}\n    />\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/potlock.near/widget/Project.PotlockFunding", "fact_widget_deployments_id": "3d143aebe180d0e0bec2e980db48d289", "inserted_timestamp": "2024-03-29T15:31:57.070Z", "modified_timestamp": "2024-03-29T15:31:57.070Z", "__row_index": 4}