{"tx_hash": "CZ4cNi8MpWt6tbUTw5D4u1mvGKmyRdNnjM2vVy4dH1Kq", "action_id_social": "DfDbPxXJ3LTLKotXcbmk8aSwpLtPBycCL7LSTQBgEYNK-0-widget", "block_id": 117690964, "block_timestamp": "2024-04-26T21:13:56.629Z", "signer_id": "potlock.near", "widget_name": "Pots.PoolAllocationTable", "source_code": "const {\n  potId,\n  env,\n  hrefWithParams,\n  allDonations,\n  potDetail: {\n    base_currency,\n    total_public_donations,\n    matching_pool_balance,\n    public_donations_count,\n  },\n} = props;\n\nconst { ownerId, NADA_BOT_URL, SUPPORTED_FTS } = VM.require(\"potlock.near/widget/constants\") || {\n  ownerId: \"\",\n  NADA_BOT_URL: \"\",\n  SUPPORTED_FTS: {},\n};\n\nconst { _address } = VM.require(`${ownerId}/widget/Components.DonorsUtils`) || {\n  _address: (address) => address,\n};\n\nconst {\n  calculatePayouts,\n  nearToUsdWithFallback,\n  yoctosToUsdWithFallback,\n  formatWithCommas,\n  nearToUsd,\n} = VM.require(\"potlock.near/widget/utils\") || {\n  nearToUsdWithFallback: () => \"\",\n  yoctosToUsdWithFallback: () => \"\",\n  calculatePayouts: () => {},\n  getFlaggedAccounts: () => {},\n  formatWithCommas: () => \"\",\n  nearToUsd: 1,\n};\n\nconst PotSDK = VM.require(\"potlock.near/widget/SDK.pot\") || {\n  asyncGetDonationsForDonor: () => {},\n  asyncGetApprovedApplications: () => {},\n  getMatchingPoolDonations: () => {},\n};\n\nconst [projectsId, setProjectsId] = useState(null);\nconst [projectsDonations, setProjectsDonations] = useState({});\nconst [usdToggle, setUsdToggle] = useState(false);\nconst [allPayouts, setAllPayouts] = useState(null);\nconst [flaggedAddresses, setFlaggedAddresses] = useState(null);\n\nif (!projectsId) {\n  PotSDK.asyncGetApprovedApplications(potId).then((projects) => {\n    setProjectsId(projects);\n  });\n}\n\nlet sponsorshipDonations = PotSDK.getMatchingPoolDonations(potId);\nif (sponsorshipDonations) sponsorshipDonations.sort((a, b) => b.net_amount - a.net_amount);\n\nconst lastProject = projectsId[projectsId.length - 1].project_id;\n\nconst calcUniqueDonors = (donations) => {\n  // Get the count of unique donors\n  const uniqueDonorIds = new Set();\n  // Iterate through each object and collect unique donor_id values\n  donations.forEach((project) => {\n    project.donations.forEach((donation) => {\n      uniqueDonorIds.add(donation.donor_id);\n    });\n  });\n  // Get the number of unique donor_id values\n  return uniqueDonorIds.size;\n};\n\nconst calcMatchedAmount = (donations) => {\n  const total = Big(0);\n  donations.forEach((donation) => {\n    total = total.plus(Big(donation.net_amount));\n  });\n  const amount = SUPPORTED_FTS[base_currency.toUpperCase()].fromIndivisible(total.toString());\n  return amount;\n};\n\nconst uniqueDonorIds = allDonations\n  ? new Set(allDonations.map((donation) => donation.donor_id))\n  : new Set([]);\n\nconst donorsCount = uniqueDonorIds.size;\n\nif (!flaggedAddresses) {\n  PotSDK.getFlaggedAccounts(potDetail, potId)\n    .then((data) => {\n      const listOfFlagged = [];\n      data.forEach((adminFlaggedAcc) => {\n        const addresses = Object.keys(adminFlaggedAcc.potFlaggedAcc);\n        listOfFlagged.push(...addresses);\n      });\n      setFlaggedAddresses(listOfFlagged);\n    })\n    .catch((err) => console.log(\"error getting the flagged accounts \", err));\n}\n\nconst sortAndSetPayouts = (payouts) => {\n  payouts.sort((a, b) => {\n    // sort by matching pool allocation, highest to lowest\n    return b.matchingAmount - a.matchingAmount;\n  });\n  setAllPayouts(payouts.slice(0, 5));\n};\n\nif (!allPayouts && allDonations?.length > 0 && flaggedAddresses) {\n  let allPayouts = [];\n\n  if (potDetail.payouts.length) {\n    allPayouts = potDetail.payouts.map((payout) => {\n      const { project_id, amount } = payout;\n      return {\n        projectId: project_id,\n        matchingAmount: amount,\n      };\n    });\n    sortAndSetPayouts(allPayouts);\n  } else {\n    calculatePayouts(allDonations, matching_pool_balance, flaggedAddresses).then(\n      (calculatedPayouts) => {\n        allPayouts = Object.entries(calculatedPayouts).map(([projectId, { matchingAmount }]) => {\n          return {\n            projectId,\n            matchingAmount,\n          };\n        });\n        sortAndSetPayouts(allPayouts);\n      }\n    );\n  }\n}\n\nconst ProfileImg = ({ profile }) => (\n  <Widget src=\"mob.near/widget/ProfileImage\" props={{ profile, style: {} }} />\n);\n\nconst Container = styled.div`\n  display: flex;\n  flex-direction: column;\n  width: 100%;\n  border-radius: 12px;\n  border-top: 1px solid #292929;\n  border-right: 1px solid #292929;\n  border-bottom: 2px solid #292929;\n  border-left: 1px solid #292929;\n  overflow: hidden;\n  .header {\n    font-size: 18px;\n    font-weight: 600;\n    background: #fef6ee;\n    padding: 1rem;\n    span {\n      color: #ee8949;\n    }\n  }\n  .sort {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 0.5rem 1rem;\n    font-size: 11px;\n    background: #fef6ee;\n    .title {\n      font-weight: 500;\n      letter-spacing: 0.44px;\n      text-transform: uppercase;\n    }\n    .sort-btn {\n      font-weight: 500;\n      display: flex;\n      align-items: center;\n      gap: 0.5rem;\n      cursor: pointer;\n    }\n  }\n`;\n\nconst Row = styled.div`\n  display: flex;\n  align-items: center;\n  font-size: 14px;\n  padding: 1rem;\n  gap: 8px;\n  border-bottom: 1px solid #c7c7c7;\n  &:last-of-type {\n    border-bottom: none;\n  }\n\n  .address {\n    display: flex;\n    text-decoration: none;\n    align-items: center;\n    font-weight: 600;\n    gap: 8px;\n    margin-left: 24px;\n    flex: 1;\n    color: #292929;\n    transition: color 200ms ease-in;\n    :hover {\n      color: #dd3345;\n    }\n  }\n  .profile-image {\n    width: 18px;\n    height: 18px;\n  }\n`;\n\nconst publicRoundStarted = projectsTotalDonations.length > 0;\n\nconst Table = ({ donations, totalAmount, totalUniqueDonors, title }) => (\n  <Container>\n    <div className=\"header\">\n      {totalAmount}\n      <span>raised from</span>\n      {totalUniqueDonors}\n      <span>{allPayouts?.length > 0 ? \"donors\" : \"sponsors\"}</span>\n    </div>\n    <div className=\"sort\">\n      <div className=\"title\">Top {title} </div>\n      <div\n        className=\"sort-btn\"\n        style={{\n          cursor: nearToUsd ? \"pointer\" : \"default\",\n        }}\n        onClick={() => (nearToUsd ? setUsdToggle(!usdToggle) : \"\")}\n      >\n        {nearToUsd && (\n          <svg\n            width=\"12\"\n            height=\"14\"\n            viewBox=\"0 0 12 14\"\n            fill=\"none\"\n            xmlns=\"http://www.w3.org/2000/svg\"\n          >\n            <path\n              d=\"M9 10.7575V5.5H7.5V10.7575H5.25L8.25 13.75L11.25 10.7575H9ZM3.75 0.25L0.75 3.2425H3V8.5H4.5V3.2425H6.75L3.75 0.25ZM9 10.7575V5.5H7.5V10.7575H5.25L8.25 13.75L11.25 10.7575H9ZM3.75 0.25L0.75 3.2425H3V8.5H4.5V3.2425H6.75L3.75 0.25Z\"\n              fill=\"#7B7B7B\"\n            />\n          </svg>\n        )}\n        {usdToggle ? \"USD\" : \"NEAR\"}\n      </div>\n    </div>\n    {donations.map(({ projectId, donor_id, matchingAmount, net_amount }, idx) => {\n      const id = donor_id || projectId;\n      const nearAmount = formatWithCommas(\n        SUPPORTED_FTS[base_currency.toUpperCase()].fromIndivisible(net_amount || matchingAmount)\n      );\n\n      const profile = Social.getr(`${id}/profile`);\n      const matchedAmout = usdToggle\n        ? yoctosToUsdWithFallback(matchingAmount || net_amount, true)\n        : nearAmount;\n      return (\n        <Row>\n          <div>#{idx + 1}</div>\n          <a className=\"address\" href={hrefWithParams(`?tab=project&projectId=${id}`)}>\n            <ProfileImg profile={profile} />\n            {_address(profile.name || id, 15)}\n          </a>\n          <div>\n            {matchedAmout} {usdToggle ? \" \" : \"N\"}\n          </div>\n        </Row>\n      );\n    })}\n  </Container>\n);\n\nreturn allPayouts?.length > 0 ? (\n  <Table\n    title=\"matching pool allocations\"\n    totalAmount={yoctosToUsdWithFallback(total_public_donations, true)}\n    totalUniqueDonors={donorsCount}\n    donations={allPayouts}\n  />\n) : sponsorshipDonations.length > 0 ? (\n  <Table\n    title=\"sponsors\"\n    totalAmount={nearToUsdWithFallback(calcMatchedAmount(sponsorshipDonations))}\n    totalUniqueDonors={new Set(sponsorshipDonations.map((obj) => obj.donor_id)).size}\n    donations={sponsorshipDonations.slice(0, 5)}\n  />\n) : (\n  \"\"\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/potlock.near/widget/Pots.PoolAllocationTable", "fact_widget_deployments_id": "37f1824062d227b2fbf3dc61c7c3984b", "inserted_timestamp": "2024-04-26T22:40:24.736Z", "modified_timestamp": "2024-04-26T22:40:24.736Z", "__row_index": 4}