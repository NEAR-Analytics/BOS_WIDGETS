{"tx_hash": "AXMX6yzADPj8xJmTSy3EJVicUf8kjAoKBC3AtHUAGXgz", "action_id_social": "5pPBeKbg6pc5eU6ce7ngKCydvaoyLb7ZHh9hC4GXcTfW-0-widget", "block_id": 105405836, "block_timestamp": "2023-11-10T22:20:52.922Z", "signer_id": "potlock.near", "widget_name": "Index", "source_code": "const ownerId = \"potlock.near\";\nconst registryContractId = \"registry.potlock.near\";\n\nconst CREATE_PROJECT_TAB = \"createproject\";\nconst EDIT_PROJECT_TAB = \"editproject\";\nconst PROJECTS_LIST_TAB = \"projects\";\nconst PROJECT_DETAIL_TAB = \"project\";\nconst CART_TAB = \"cart\";\nconst FEED_TAB = \"feed\";\n\nconst Theme = styled.div`\n  * {\n    font-family: \"Mona-Sans\";\n    font-style: normal;\n    font-weight: 400;\n  }\n  @font-face {\n    font-family: mona-sans;\n    font-style: normal;\n    font-weight: 400;\n    src: local(\"Mona-Sans\"),\n      url(https://fonts.cdnfonts.com/s/91271/Mona-Sans-Regular.woff) format(\"woff\");\n  }\n  @font-face {\n    font-family: mona-sans;\n    font-style: normal;\n    font-weight: 500;\n    src: local(\"Mona-Sans\"),\n      url(https://fonts.cdnfonts.com/s/91271/Mona-Sans-Medium.woff) format(\"woff\");\n  }\n  @font-face {\n    font-family: mona-sans;\n    font-style: normal;\n    font-weight: 600;\n    src: local(\"Mona-Sans\"),\n      url(https://fonts.cdnfonts.com/s/91271/Mona-Sans-SemiBold.woff) format(\"woff\");\n  }\n  @font-face {\n    font-family: mona-sans;\n    font-style: normal;\n    font-weight: 700;\n    src: local(\"Mona-Sans\"),\n      url(https://fonts.cdnfonts.com/s/91271/Mona-Sans-Bold.woff) format(\"woff\");\n  }\n`;\n\nState.init({\n  registeredProjects: null,\n  cart: null,\n  // previousCart: null,\n  nearToUsd: null,\n  // nearToUsd: useCache(\n  //   () =>\n  //     asyncFetch(\"https://api.coingecko.com/api/v3/simple/price?ids=near&vs_currencies=usd\").then(\n  //       (res) => {\n  //         console.log(\"congecko res: \", res);\n  //         return res.body.near.usd;\n  //       }\n  //     ),\n  //   \"nearToUsd\",\n  //   { subscribe: false }\n  // ),\n  isCartModalOpen: false,\n  isNavMenuOpen: false,\n  registryAdmins: null,\n  registeredProjects: null,\n});\n\nif (!state.nearToUsd) {\n  asyncFetch(\"https://api.coingecko.com/api/v3/simple/price?ids=near&vs_currencies=usd\").then(\n    (res) => {\n      console.log(\"congecko res: \", res);\n      State.update({ nearToUsd: res.body.near.usd });\n    }\n  );\n}\n\nconsole.log(\"state in Index: \", state);\n\nif (!state.registeredProjects) {\n  State.update({ registeredProjects: Near.view(registryContractId, \"get_projects\", {}) });\n}\n\nif (!state.registeredProjects) return \"\";\n\nconst IPFS_BASE_URL = \"https://nftstorage.link/ipfs/\";\n\nconst getImageUrlFromSocialImage = (image) => {\n  if (image.url) {\n    return image.url;\n  } else if (image.ipfs_cid) {\n    return IPFS_BASE_URL + image.ipfs_cid;\n  }\n};\n\nif (!state.registeredProjects) {\n  Near.asyncView(registryContractId, \"get_projects\", {})\n    .then((projects) => {\n      // get social data for each project\n      // name\n      // description\n      // bannerImage\n      // profileImage\n      // category\n      // horizon stuff, e.g. tags\n      Near.asyncView(\"social.near\", \"get\", {\n        keys: projects.map((project) => `${project.id}/profile/**`),\n      }).then((socialData) => {\n        const formattedProjects = projects.map((project) => {\n          const profileData = socialData[project.id]?.profile;\n          let profileImageUrl = DEFAULT_PROFILE_IMAGE_URL;\n          if (profileData.image) {\n            const imageUrl = getImageUrlFromSocialImage(profileData.image);\n            if (imageUrl) profileImageUrl = imageUrl;\n          }\n          // get banner image URL\n          let bannerImageUrl = DEFAULT_BANNER_IMAGE_URL;\n          if (profileData.backgroundImage) {\n            const imageUrl = getImageUrlFromSocialImage(profileData.backgroundImage);\n            if (imageUrl) bannerImageUrl = imageUrl;\n          }\n          const formatted = {\n            id: project.id,\n            name: profileData.name ?? \"\",\n            description: profileData.description ?? \"\",\n            bannerImageUrl,\n            profileImageUrl,\n            status: project.status,\n            tags: [profileData.category.text ?? CATEGORY_MAPPINGS[profileData.category] ?? \"\"], // TODO: change this to get tags from horizon/social\n          };\n          return formatted;\n        });\n        State.update({\n          registeredProjects: formattedProjects,\n        });\n      });\n    })\n    .catch((e) => {\n      console.log(\"error getting projects: \", e);\n      State.update({ getRegisteredProjectsError: e });\n    });\n}\n\nif (state.registryAdmins === null) {\n  const registryAdmins = Near.view(registryContractId, \"get_admins\", {});\n  State.update({ registryAdmins });\n}\n\nconst tabContentWidget = {\n  [CREATE_PROJECT_TAB]: \"Project.Create\",\n  [EDIT_PROJECT_TAB]: \"Project.Create\",\n  [PROJECTS_LIST_TAB]: \"Project.ListPage\",\n  [PROJECT_DETAIL_TAB]: \"Project.Detail\",\n  [CART_TAB]: \"Cart.Checkout\",\n  [FEED_TAB]: \"Feed\",\n};\n\nconst getWidget = (props) => {\n  if (props.tab in tabContentWidget) {\n    return tabContentWidget[props.tab];\n  }\n  // backup (TODO: review)\n  return tabContentWidget[PROJECTS_LIST_TAB];\n};\n\nconst getTabWidget = (tab) => {\n  if (tab in tabContentWidget) {\n    return tabContentWidget[tab];\n  }\n\n  return tabContentWidget[PROJECTS_LIST_TAB];\n};\n\nconst props = {\n  ...props,\n  ...state,\n  addProjectsToCart: (projects) => {\n    const cart = state.cart ?? {};\n    projects.forEach(({ id, amount, ft, referrerId }) => {\n      cart[id] = { amount, ft: ft ?? \"NEAR\", referrerId }; // default to NEAR\n    });\n    State.update({ cart });\n    Storage.set(CART_KEY, JSON.stringify(cart));\n  },\n  removeProjectsFromCart: (projectIds) => {\n    const cart = state.cart ?? {};\n    projectIds.forEach((projectId) => {\n      delete cart[projectId];\n    });\n    State.update({ cart });\n    Storage.set(CART_KEY, JSON.stringify(cart));\n  },\n  updateCartItem: (projectId, amount, ft, referrerId) => {\n    const cart = state.cart ?? {};\n    const updated = {};\n    // if (amount === \"\") updated.amount = \"0\";\n    if (amount || amount === \"\") updated.amount = amount;\n    if (ft) updated.ft = ft;\n    if (referrerId) updated.referrerId = referrerId;\n    cart[projectId] = updated;\n    State.update({ cart });\n    Storage.set(CART_KEY, JSON.stringify(cart));\n  },\n  checkoutSuccess: props.tab === CART_TAB && props.transactionHashes,\n  checkoutSuccessTxHash: props.tab === CART_TAB ? props.transactionHashes : \"\",\n  setIsCartModalOpen: (isOpen) => {\n    State.update({ isCartModalOpen: isOpen });\n  },\n  setIsNavMenuOpen: (isOpen) => {\n    State.update({ isNavMenuOpen: isOpen });\n  },\n  CATEGORY_MAPPINGS: {\n    \"social-impact\": \"Social Impact\",\n    \"non-profit\": \"NonProfit\",\n    climate: \"Climate\",\n    \"public-good\": \"Public Good\",\n    \"de-sci\": \"DeSci\",\n    \"open-source\": \"Open Source\",\n    community: \"Community\",\n    education: \"Education\",\n  },\n};\n\nconst CART_KEY = \"cart\";\n// const PREVIOUS_CART_KEY = \"previousCart\";\nconst storageCart = Storage.get(CART_KEY);\n// const storagePreviousCart = Storage.get(PREVIOUS_CART_KEY);\nconst DEFAULT_CART = {};\n\nif (state.cart === null && storageCart !== null) {\n  // cart hasn't been set on state yet, and storageCart has been fetched\n  // if storageCart isn't undefined, set it on state\n  // otherwise, set default cart on state\n  let cart = DEFAULT_CART;\n  if (storageCart) {\n    cart = JSON.parse(storageCart);\n  }\n  State.update({ cart });\n}\n\n// if (state.previousCart === null && storagePreviousCart !== null) {\n//   // previousCart hasn't been set on state yet, and storagePreviousCart has been fetched\n//   // if storagePreviousCart isn't undefined, set it on state\n//   if (storagePreviousCart && Object.keys(JSON.parse(storagePreviousCart)).length > 0) {\n//     console.log(\"updating previous cart\");\n//     State.update({ previousCart: JSON.parse(storagePreviousCart) });\n//   }\n// }\n\n// console.log(\"state in Index: \", state);\n\nif (props.checkoutSuccess && state.cart && Object.keys(state.cart).length > 0) {\n  // if checkout was successful, clear cart\n  // store previous cart in local storage to show success message\n  // console.log(\"previous cart: \", state.cart);\n  State.update({ cart: {} });\n  Storage.set(CART_KEY, JSON.stringify(DEFAULT_CART));\n  // Storage.set(PREVIOUS_CART_KEY, JSON.stringify(state.cart));\n}\n\nif (props.tab === EDIT_PROJECT_TAB) {\n  props.edit = true;\n}\n\nconst tabContent = <Widget src={`${ownerId}/widget/${getTabWidget(props.tab)}`} props={props} />;\n\nconst Content = styled.div`\n  width: 100%;\n  height: 100%;\n  background: #ffffff;\n  // padding: 3em;\n  border-radius: 0rem 0rem 1.5rem 1.5rem;\n  border-top: 1px solid var(--ui-elements-light, #eceef0);\n  background: var(--base-white, #fff);\n\n  &.form {\n    border: none;\n    background: #fafafa;\n  }\n`;\n\nconst isForm = [CREATE_PROJECT_TAB].includes(props.tab);\n\nif (!state.cart || !state.registeredProjects) {\n  return \"\";\n}\n\nreturn (\n  <Theme>\n    <Widget src={`${ownerId}/widget/Nav`} props={props} />\n    <Content className={isForm ? \"form\" : \"\"}>{tabContent}</Content>\n  </Theme>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/potlock.near/widget/Index", "fact_widget_deployments_id": "6751f30d02c2a79bf549aa9e2bfb97d4", "inserted_timestamp": "2023-11-11T00:25:35.914Z", "modified_timestamp": "2023-11-11T00:25:35.914Z", "__row_index": 32}