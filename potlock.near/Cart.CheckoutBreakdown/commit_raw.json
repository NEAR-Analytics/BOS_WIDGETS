{"tx_hash": "BqeM3Ywrc6fsJGRBfTmgj9VLZufr74kUFAWeWG4uzbeu", "action_id_social": "CbcXWw3Bg8VRMuq2gTqPrRBAjKnvCgLnqJrKCkR4mXx5-0-widget", "block_id": 115722656, "block_timestamp": "2024-03-29T14:20:36.213Z", "signer_id": "potlock.near", "widget_name": "Cart.CheckoutBreakdown", "source_code": "const { yoctosToNear } = VM.require(\"potlock.near/widget/utils\") || { yoctosToNear: () => \"\" };\nconst { SUPPORTED_FTS } = VM.require(\"potlock.near/widget/constants\") || {\n  SUPPORTED_FTS: {},\n};\n\nconst { getCart, clearCart } = VM.require(\"potlock.near/widget/SDK.cart\") || {\n  getCart: () => {},\n  clearCart: () => {},\n};\n\nconst cart = getCart();\n\nconst PotSDK = VM.require(\"potlock.near/widget/SDK.pot\") || {\n  asyncGetDonationsForDonor: () => {},\n};\n\nlet DonateSDK =\n  VM.require(\"potlock.near/widget/SDK.donate\") ||\n  (() => ({\n    asyncGetDonationsForDonor: () => {},\n    getContractId: () => \"\",\n  }));\n\nDonateSDK = DonateSDK({ env: props.env });\n\nconst DONATION_CONTRACT_ID = DonateSDK.getContractId();\n\nconst IPFS_BASE_URL = \"https://nftstorage.link/ipfs/\";\nBig.PE = 100;\n\nconst Container = styled.div`\n  display: flex;\n  flex-direction: column;\n  gap: 24px;\n  margin-top: 20px;\n  width: 380px;\n  //   background: white;\n\n  @media screen and (max-width: 768px) {\n    width: 100%;\n    margin-bottom: 50px;\n  }\n`;\n\nconst Title = styled.div`\n  color: #2e2e2e;\n  font-size: 24px;\n  font-weight: 600;\n  line-height: 32px;\n  word-wrap: break-word;\n`;\n\nconst CurrencyHeader = styled.div`\n  display: flex;\n  flex-direction: row;\n  justify-content: space-between;\n  align-items: center;\n  padding: 8px;\n  border-radius: 5px;\n  background: #f0f0f0;\n`;\n\nconst CurrencyHeaderText = styled.div`\n  color: #7b7b7b;\n  font-size: 12px;\n  font-weight: 400;\n  line-height: 14px;\n  word-wrap: break-word;\n`;\n\nconst BreakdownItemContainer = styled.div`\n  display: flex;\n  flex-direction: row;\n  justify-content: space-between;\n  align-items: center;\n  padding: 8px;\n`;\n\nconst BreakdownItemLeft = styled.div`\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  justify-content: flex-start;\n  width: 50%;\n  gap: 8px;\n`;\n\nconst BreakdownItemRight = styled.div`\n  display: flex;\n  flex: 1;\n  flex-direction: row;\n  align-items: center;\n  justify-content: flex-end;\n`;\n\nconst BreakdownItemText = styled.div`\n  color: #2e2e2e;\n  font-size: 14px;\n  font-weight: 400;\n  line-height: 16px;\n  word-wrap: break-word;\n`;\n\nconst CurrencyIcon = styled.img`\n  width: 20px;\n  height: 20px;\n`;\n\nconst TotalContainer = styled.div`\n  display: flex;\n  flex-direction: row;\n  justify-content: space-between;\n  align-items: center;\n  padding: 8px;\n  border-top: 1px #7b7b7b solid;\n`;\n\nconst TotalText = styled.div`\n  color: #2e2e2e;\n  font-size: 14px;\n  font-weight: 600;\n  line-height: 20px;\n  word-wrap: break-word;\n`;\n\nconst ErrorText = styled.div`\n  color: #dd3345;\n  font-size: 14px;\n  font-weight: 400;\n  line-height: 20px;\n  word-wrap: break-word;\n  width: 100%;\n  text-align: center;\n`;\n\nconst MIN_REQUIRED_DONATION_AMOUNT_PER_PROJECT = 0.1;\n\nconst [tokens, amountsByFt, totalAmount, donationTooSmall] = useMemo(() => {\n  const tokens = {};\n  const amountsByFt = {};\n  let donationTooSmall = false;\n  Object.entries(cart || {}).forEach(([projectId, { token, amount }]) => {\n    const ft = token.text;\n    if (!amountsByFt[ft]) amountsByFt[ft] = 0;\n    amountsByFt[ft] += parseFloat(amount || 0);\n    if (amountsByFt[ft] < MIN_REQUIRED_DONATION_AMOUNT_PER_PROJECT) donationTooSmall = true;\n    tokens[ft] = token;\n  });\n  const totalAmount = Object.values(amountsByFt).reduce((acc, amount) => acc + amount, 0);\n  return [tokens, amountsByFt, totalAmount, donationTooSmall];\n}, [props]);\n\n// console.log(\"amountsByFt: \", amountsByFt);\n// console.log(\"tokens: \", tokens);\n\nconst handleDonate = () => {\n  const transactions = [];\n  let potIdContained;\n\n  Object.entries(cart).forEach(([projectId, { token, amount, referrerId, note, potId }]) => {\n    const isFtDonation = token.text != \"NEAR\";\n    const amountIndivisible = Big(parseFloat(amount)).mul(\n      Big(10).pow(isFtDonation ? token.decimals : 24)\n    );\n    const args = {};\n    if (isFtDonation) {\n      args.receiver_id = DONATION_CONTRACT_ID;\n      args.amount = amountIndivisible.toString();\n      args.memo = JSON.stringify({\n        recipient_id: projectId,\n        referrer_id: referrerId || null,\n        bypass_protocol_fee: false,\n        message: note || null,\n      });\n    } else {\n      // pot & generic contract args\n      args.project_id = projectId;\n      args.referrer_id = referrerId;\n      args.message = note;\n      // donation contract args\n      args.recipient_id = projectId;\n      // other\n      potIdContained = potId;\n    }\n    transactions.push({\n      contractName: isFtDonation ? token.id : potId ?? DONATION_CONTRACT_ID,\n      methodName: isFtDonation ? \"ft_transfer_call\" : \"donate\",\n      args,\n      deposit: isFtDonation ? \"1\" : amountIndivisible.toString(),\n      gas: \"300000000000000\",\n    });\n  });\n\n  // if cart contains a non-NEAR token, add storage_deposit to beginning of transactions\n  // for each non-NEAR donation: 0.008 base amount for donation storage + 0.0001 NEAR per character in message\n  if (Object.keys(amountsByFt).some((ft) => ft !== \"NEAR\")) {\n    const requiredDepositFloat = transactions.reduce((acc, { methodName, args }) => {\n      if (methodName === \"donate\") return acc;\n      const baseAmount = 0.008;\n      const argsAmount = (args.message.length || 0) * 0.0001;\n      return acc + baseAmount + argsAmount;\n    }, 0);\n    transactions.unshift({\n      contractName: DONATION_CONTRACT_ID,\n      methodName: \"storage_deposit\",\n      args: {},\n      deposit: Big(requiredDepositFloat).mul(Big(10).pow(24)),\n      gas: \"100000000000000\",\n    });\n  }\n\n  const now = Date.now();\n  Near.call(transactions);\n  // NB: we won't get here if user used a web wallet, as it will redirect to the wallet\n  // <-------- EXTENSION WALLET HANDLING -------->\n  // poll for updates\n  // TODO: update this to also poll Pot contract\n  const pollIntervalMs = 1000;\n  // const totalPollTimeMs = 60000; // consider adding in to make sure interval doesn't run indefinitely\n  const pollId = setInterval(() => {\n    (potIdContained\n      ? PotSDK.asyncGetDonationsForDonor(potIdContained, context.accountId)\n      : DonateSDK.asyncGetDonationsForDonor(context.accountId)\n    ).then((donations) => {\n      // for each project, there should be a matching donation that occurred since now()\n      const foundDonations = [];\n      // go through donations, add to foundDonations list\n      for (const donation of donations) {\n        const { recipient_id, project_id, donated_at_ms, donated_at, total_amount } = donation;\n        const matchingCartItem = cart[project_id || recipient_id];\n        if (matchingCartItem && (donated_at_ms > now || donated_at > now)) {\n          foundDonations.push(donation);\n        }\n      }\n      if (foundDonations.length) {\n        // donations found\n        // display success message & clear cart\n        clearInterval(pollId);\n        props.updateSuccessfulDonationRecipientId(foundDonations[0].recipient_id);\n        clearCart();\n      }\n    });\n  }, pollIntervalMs);\n};\n// console.log(\"props\", props);\n\n// console.log(\"supported fts: \", SUPPORTED_FTS);\n// console.log(\"props.cart: \", props.cart);\n// console.log(\"props.projectId: \", props.projectId);\nreturn (\n  <Container>\n    <Title>Breakdown summary</Title>\n    <CurrencyHeader>\n      <CurrencyHeaderText>Currency</CurrencyHeaderText>\n      <CurrencyHeaderText>Amount</CurrencyHeaderText>\n    </CurrencyHeader>\n    {Object.entries(amountsByFt).map(([ft, amount]) => {\n      const amountFloat = parseFloat(amount || 0);\n      return (\n        <BreakdownItemContainer>\n          <BreakdownItemLeft>\n            {ft == \"NEAR\" ? (\n              <CurrencyIcon src={SUPPORTED_FTS.NEAR.iconUrl} />\n            ) : (\n              <CurrencyIcon src={tokens[ft].icon} />\n            )}\n            <BreakdownItemText>{tokens[ft].text}</BreakdownItemText>\n          </BreakdownItemLeft>\n          <BreakdownItemRight>\n            <BreakdownItemText>{amountFloat.toFixed(2)}</BreakdownItemText>\n          </BreakdownItemRight>\n        </BreakdownItemContainer>\n      );\n    })}\n    {Object.keys(amountsByFt).length <= 1 &&\n      amountsByFt.NEAR && ( // only show total if NEAR is the only currency being donated (otherwise it is inaccurate and confusing)\n        <TotalContainer>\n          <TotalText>Total</TotalText>\n          <TotalText>{totalAmount.toFixed(2)}</TotalText>\n        </TotalContainer>\n      )}\n    <Widget\n      src={\"potlock.near/widget/Components.Button\"}\n      props={{\n        type: \"primary\",\n        text: `Process Donation`,\n        disabled: !Object.keys(cart).length || donationTooSmall || !context.accountId,\n        onClick: handleDonate,\n        style: {\n          width: \"100%\",\n        },\n      }}\n    />\n    {donationTooSmall && (\n      <ErrorText>\n        Minimum required donation per project is {MIN_REQUIRED_DONATION_AMOUNT_PER_PROJECT} N\n      </ErrorText>\n    )}\n    {!context.accountId && <ErrorText>Please sign in to donate</ErrorText>}\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/potlock.near/widget/Cart.CheckoutBreakdown", "fact_widget_deployments_id": "20ffc4c32bc3887abb93ef0a912e1cc4", "inserted_timestamp": "2024-03-29T15:31:57.070Z", "modified_timestamp": "2024-03-29T15:31:57.070Z", "__row_index": 7}