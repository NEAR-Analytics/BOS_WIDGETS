{"tx_hash": "6DEAdNkQ4R48jRfJdDGzoaCukW8KpEYLbRqTgVVXuMsu", "action_id_social": "53J6fyQCzq9sZCMGxhYVU1SjDJNy9Yqu9ftJY8Q3S8ib-0-widget", "block_id": 97100466, "block_timestamp": "2023-07-22T22:39:45.559Z", "signer_id": "4ac12ee4ebd5536d7b130a9c5f8eebb1136145312c9e523289bf346268aeebfd", "widget_name": "Customer.view", "source_code": "const USER = \"4ac12ee4ebd5536d7b130a9c5f8eebb1136145312c9e523289bf346268aeebfd\";\n\nif (!props.sender) {\n  return (\n    <Widget\n      src={`${USER}/widget/Common.error`}\n      props={{ message: \"No user connected.\" }}\n    />\n  );\n}\n\nif (!props.factory) {\n  return (\n    <Widget\n      src={`${USER}/widget/Common.error`}\n      props={{ message: \"Factory address missing.\" }}\n    />\n  );\n}\n\nconst collectionABI = fetch(\n  \"https://raw.githubusercontent.com/knwtechs/subscript.io-contracts/main/artifacts/contracts/SubscriptionsCollection.sol/SubscriptionsCollection.json\"\n);\n\nif (!collectionABI.ok) {\n  return (\n    <Widget\n      src={`${USER}/widget/Common.error`}\n      props={{ message: \"Collection ABI unavailable.\" }}\n    />\n  );\n}\n\nconst factoryABI = fetch(\n  \"https://raw.githubusercontent.com/knwtechs/subscript.io-contracts/main/artifacts/contracts/SubscriptionsFactory.sol/SubscriptionsFactory.json\"\n);\n\nif (!factoryABI.ok) {\n  return (\n    <Widget\n      src={`${USER}/widget/Common.error`}\n      props={{ message: \"Factory ABI unavailable.\" }}\n    />\n  );\n}\nconst factoryAddress = props.factory;\n\nconst subscriptionsFactoryContract = new ethers.Contract(\n  factoryAddress,\n  JSON.parse(factoryABI.body)[\"abi\"],\n  Ethers.provider().getSigner()\n);\n\nState.init({\n  widgets: [],\n});\n\nconst getSubscriptionEvents = (user) => {\n  const filter = {\n    address: factoryAddress,\n    topics: [\n      ethers.utils.id(\"NewSubscription(address,address,uint256)\"),\n      null,\n      ethers.utils.hexZeroPad(ethers.utils.getAddress(user), 32),\n    ],\n    fromBlock: 0,\n    toBlock: \"latest\",\n  };\n\n  Ethers.provider()\n    .getLogs(filter)\n    .then((logs) => {\n      const widgets = [];\n      for (let i = 0; i < logs.length; i++) {\n        const parsedLog = subscriptionsFactoryContract.interface.parseLog(\n          logs[i]\n        );\n        widgets.push(\n          <Widget\n            src={`${USER}/widget/Customer.token`}\n            props={{\n              collectionAddress: parsedLog.args[0],\n              abi: JSON.parse(collectionABI.body)[\"abi\"],\n              owner: props.sender,\n            }}\n          />\n        );\n      }\n      State.update({ widgets: widgets });\n    })\n    .catch((err) => console.log(err));\n};\n\ngetSubscriptionEvents(props.sender);\n\nreturn (\n  <div class=\"container-fluid bg-dark h-100\">\n    <div class=\"row d-flex justify-content-center mt-2\">\n      {state.widgets.map((w) => (\n        <div class=\"col-10 col-md-4 mt-2\">{w}</div>\n      ))}\n    </div>\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/4ac12ee4ebd5536d7b130a9c5f8eebb1136145312c9e523289bf346268aeebfd/widget/Customer.view", "fact_widget_deployments_id": "fe7297d30f0f224c04d5d0f84c2ba23a", "inserted_timestamp": "2000-01-01T00:00:00.000Z", "modified_timestamp": "2000-01-01T00:00:00.000Z", "__row_index": 1}