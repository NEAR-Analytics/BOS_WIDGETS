{"tx_hash": "HtPpcXq97ftQp2BTboaDVLaPH6sQMR7vregoq5TV7p7V", "action_id_social": "6KzSQ5XwQU8EQNzGT4J8VcNjbVhw76fQe82qsu4Hw6K9-0-widget", "block_id": 97095198, "block_timestamp": "2023-07-22T21:00:45.976Z", "signer_id": "4ac12ee4ebd5536d7b130a9c5f8eebb1136145312c9e523289bf346268aeebfd", "widget_name": "Customer.token", "source_code": "const USER = \"4ac12ee4ebd5536d7b130a9c5f8eebb1136145312c9e523289bf346268aeebfd\";\n\nif (!props.collectionAddress || !props.abi || !props.owner || !props.name)\n  return (\n    <Widget\n      src={`${USER}/widget/Common.error`}\n      props={{ message: \"Missing data\" }}\n    />\n  );\n\nconst tier = props.tier ?? 0;\n\nState.init({\n  amount: 0,\n  price: 0,\n  deadline: 0,\n  totalPaid: 0,\n  image: \"\",\n});\n\nconst iface = new ethers.utils.Interface(props.abi);\n\nconst timestampToDateTime = (timestampInSeconds) => {\n  const timestampInMillis = timestampInSeconds * 1000;\n  const date = new Date(timestampInMillis);\n  return date.toLocaleString();\n};\n\nconst getCollectionName = () => {\n  const encodedData = iface.encodeFunctionData(\"collectionName\", []);\n\n  return Ethers.provider()\n    .call({\n      to: props.collectionAddress,\n      data: encodedData,\n    })\n    .then((n) => {\n      const name = iface.decodeFunctionResult(\"collectionName\", n)[0];\n      State.update({ name: name });\n    });\n};\n\nconst getCollectionImage = () => {\n  try {\n    const encodedData = iface.encodeFunctionData(\"uri\", [0]);\n\n    return Ethers.provider()\n      .call({\n        to: props.collectionAddress,\n        data: encodedData,\n      })\n      .then((url) => {\n        const uri = iface.decodeFunctionResult(\"uri\", url);\n        const real_uri = uri[0].slice(0, uri[0].length - 1);\n        //console.log(\"url: \", real_uri);\n        const metas = fetch(real_uri);\n        if (metas.ok) {\n          const jsonmeta = JSON.parse(metas.body);\n          State.update({ image: jsonmeta[\"image\"] });\n        } else {\n          console.log(metas);\n        }\n      });\n  } catch (err) {\n    console.log(err);\n  }\n};\n\nconst getPrice = () => {\n  const encodedData = iface.encodeFunctionData(\"getTierPrice\", [tier]);\n\n  return Ethers.provider()\n    .call({\n      to: props.collectionAddress,\n      data: encodedData,\n    })\n    .then((p) => {\n      const price = iface.decodeFunctionResult(\"getTierPrice\", p);\n      const _price = Big(price.toString()).div(Big(10).pow(18)).toString();\n      State.update({ price: _price });\n    });\n};\n\nconst getAmount = () => {\n  const encodedData = iface.encodeFunctionData(\"balanceOf\", [\n    props.owner,\n    tier,\n  ]);\n\n  return Ethers.provider()\n    .call({\n      to: props.collectionAddress,\n      data: encodedData,\n    })\n    .then((amt) => {\n      const amount = iface.decodeFunctionResult(\"balanceOf\", amt);\n      State.update({ amount: amount });\n    });\n};\n\nconst getDeadline = () => {\n  const encodedData = iface.encodeFunctionData(\"getSubscriptionDeadline\", [\n    tier,\n    props.owner,\n  ]);\n\n  return Ethers.provider()\n    .call({\n      to: props.collectionAddress,\n      data: encodedData,\n    })\n    .then((ts) => {\n      const dl = iface.decodeFunctionResult(\"getSubscriptionDeadline\", ts);\n      const deadline = timestampToDate(Big(dl).toString());\n      State.update({ deadline: deadline });\n    });\n};\n\nconst fetchData = () => {\n  getCollectionName();\n  getCollectionImage();\n  getPrice();\n  getAmount();\n  getDeadline();\n};\n\nfetchData();\n\nreturn (\n  <div class=\"card bg-light mb-3 d-flex w-100\">\n    <div class=\"card-header\">\n      <img src={state.image} class=\"img-fluid\" />\n    </div>\n    <ul class=\"list-group list-group-flush\">\n      <li class=\"list-group-item\">Amount: {state.amount}</li>\n      <li class=\"list-group-item\">Price: {state.price}</li>\n      <li class=\"list-group-item\">Next billing: {state.deadline}</li>\n      <li class=\"list-group-item\">Total paid: {state.totalPaid}</li>\n    </ul>\n    <div class=\"card-body\">\n      <h5 class=\"card-title\">{props.name}</h5>\n    </div>\n  </div>\n);\n", "metadata": {"platform": "nearpad"}, "branch": {"draft": null}, "widget_modules_used": null, "widget_url": "https://near.social/#/4ac12ee4ebd5536d7b130a9c5f8eebb1136145312c9e523289bf346268aeebfd/widget/Customer.token", "fact_widget_deployments_id": "b5f7fccbb0d2081d47d5c9e98ceffa84", "inserted_timestamp": "2000-01-01T00:00:00.000Z", "modified_timestamp": "2000-01-01T00:00:00.000Z", "__row_index": 6}