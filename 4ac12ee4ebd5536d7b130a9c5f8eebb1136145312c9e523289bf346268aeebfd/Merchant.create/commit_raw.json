{"tx_hash": "EMtyRbeEANfQZhLvghNg9L9e1aHynNchj9HL9DFmCWD9", "action_id_social": "7b68Brp3DdGyuNhWzyqwTKHHuBmAdY9F3i4hjcmx5fcC-0-widget", "block_id": 97109726, "block_timestamp": "2023-07-23T01:32:43.008Z", "signer_id": "4ac12ee4ebd5536d7b130a9c5f8eebb1136145312c9e523289bf346268aeebfd", "widget_name": "Merchant.create", "source_code": "// STYLED\nconst APP_TITLE = \"SubScript.io\";\nconst USER = \"4ac12ee4ebd5536d7b130a9c5f8eebb1136145312c9e523289bf346268aeebfd\";\n\nif (!props.factory) {\n  return (\n    <Widget\n      src={`${USER}/widget/Common.error`}\n      props={{ message: \"Factory address missing\" }}\n    />\n  );\n}\nconst contractAddress = props.factory;\n\nconst Box = styled.div`\ndisplay: flex;\nflex-direction: row;\njustify-content: flex-start;\nalign-items: center;\ngap: 0.5em;\n\n\nbutton {\nborder: none;\nbackground: none;\npadding: 0;\nwidth: 1.5em;\nheight: 1.5em;\ndisplay: flex;\njustify-content: center;\nalign-items: center;\nborder: 1.5px solid #a8acb3;\ntransition: background 200ms ease-out;\noutline: none!important;\n\n\n&[data-state=\"checked\"] {\nbackground: #a59bdb;\n}\n}\n`;\n\nconst Container = styled.div`\nbackground-color: #1c1f2a;\n`;\n\nconst Heading = styled.h1`\ntext-align: center;\ncolor: #8f73ff;\nfont-weight: 700;\nfont-size: 24pt;\nletter-spacing: 3pt;\ntext-transform: uppercase;\ndisplay: flex;\njustify-content: center;\npadding-top: 10px\n`;\n\nconst MainCard = styled.div`\nborder: 2px solid rgba(255,255,255,.7);\nborder-radius: 25px;\nbackground-color: #1c1f2a;\npadding: 2rem;\nwidth: 32rem\n`;\n\nconst factoryABI = fetch(\n  \"https://raw.githubusercontent.com/knwtechs/subscript.io-contracts/main/artifacts/contracts/SubscriptionsFactory.sol/SubscriptionsFactory.json\"\n);\n\nif (!factoryABI.ok) {\n  console.log(\"ABI unavailable.\");\n  return \"ABI unavailable.\";\n}\n\n// INIT STATE\nState.init({\n  product_name,\n  timeframe,\n  uri,\n  startTimestamp,\n  price: 0,\n  usdPrice: 0,\n  supply: -1,\n  cap_supply: false,\n  metadata: null,\n  waiting: false,\n  collectionCreated: null,\n});\n\nif (!state.supply) {\n  State.update({ supply: -1 });\n}\n\nif (!state.cap_supply) {\n  State.update({ cap_supply: false });\n}\n\n// PRODUCT NAME\nconst onNameChange = ({ target }) => {\n  State.update({ product_name: target.value });\n};\nconst validateName = () => {\n  return state.product_name.length > 0;\n};\n\n// TIMEFRAME\nconst onTimeframeChange = ({ target }) => {\n  State.update({ timeframe: target.value });\n};\nconst validateTimeframe = () => {\n  return state.timeframe >= 1;\n};\n\n// URI\nconst onUriChange = ({ target }) => {\n  State.update({ uri: target.value });\n};\nconst validateUri = () => {\n  return state.uri.length > 0;\n};\n\n// START TIMESTAMP\nconst onStartTimestampChange = ({ target }) => {\n  console.log(target.value);\n  State.update({ startTimestamp: target.value });\n};\nconst validateStartTimestamp = () => {\n  const timestamp = new Date(state.startTimestamp).getTime();\n  return timestamp >= 0;\n};\n\n// PRICE\nconst onPriceChange = ({ target }) => {\n  State.update({\n    price: target.value,\n    usdPrice: (target.value * state.ethusd).toFixed(2),\n  });\n};\nconst validatePrice = () => {\n  return state.price > 0;\n};\n\n// SUPPLY\nconst onCheckboxChange = (checked) => {\n  State.update({ cap_supply: checked, supply: checked ? 5000 : -1 });\n};\nconst onSupplyChange = ({ target }) => {\n  State.update({ supply: target.value });\n};\nconst validateSupply = () => {\n  return state.supply >= -1;\n};\n\nconst isFormValid = () => {\n  console.log({\n    name: state.product_name,\n    price: state.price,\n    timeframe: state.timeframe,\n    uri: state.uri,\n    cap_supply: state.cap_supply,\n    supply: state.supply,\n  });\n\n  return (\n    (state.product_name.length > 0 &&\n      state.price > 0 &&\n      state.timeframe > 0 &&\n      state.uri.length > 0 &&\n      state.sender.length > 0 &&\n      state.cap_supply &&\n      state.supply >= -1) ||\n    (!state.cap_supply && state.supply == -1)\n  );\n};\n\n// CONTRACT INTERACTION\nconst createCollection = async () => {\n  if (isFormValid()) {\n    console.log(\"form valid, performing contract call.\");\n\n    try {\n      // CREATE JSON METADATA\n      const jsonData = {\n        name: state.product_name,\n        description: \"SubScript.io\",\n        image: state.uri,\n        external_url: \"\",\n        attributes: [],\n      };\n\n      const jsonString = JSON.stringify(jsonData, null, 2);\n\n      asyncFetch(\"https://ipfs.near.social/add\", {\n        method: \"POST\",\n        headers: { Accept: \"application/json\" },\n        body: jsonString,\n      }).then((res) => {\n        console.log(\"Upload result: \", res);\n        const cid = res.body.cid;\n        const meta_uri = `https://ipfs.io/ipfs/${cid}`;\n        console.log(\"Meta URI: \", meta_uri);\n\n        const amount = Big(state.price).mul(Big(10).pow(18)).toString();\n        const start = Big(\n          Math.floor(new Date(state.startTimestamp).getTime() / 1000)\n        ).toString();\n        const frame = Big(state.timeframe).mul(86400).toString();\n\n        console.log(\"Amount: \", amount);\n        console.log(\"Start: \", start);\n        console.log(\"Frame: \", frame);\n        console.log(\"Sender: \", props.sender);\n        console.log(\"Supply: \", Big(state.supply).toString());\n\n        const subscriptionsFactoryContract = new ethers.Contract(\n          contractAddress,\n          JSON.parse(factoryABI.body)[\"abi\"],\n          Ethers.provider().getSigner()\n        );\n\n        State.update({ waiting: true });\n        subscriptionsFactoryContract\n          .createCollection(\n            state.product_name,\n            [amount],\n            [Big(state.supply).toString()],\n            frame,\n            props.sender,\n            meta_uri,\n            start\n          )\n          .catch((err) => {\n            console.log(err);\n            State.update({ waiting: false });\n          })\n          .then((tx) => {\n            console.log(\"Waiting for confirmation: \", tx);\n            tx.wait().then((hash) => {\n              State.update({\n                waiting: false,\n                collectionCreated: hash.events[0].address,\n              });\n            });\n          });\n      });\n    } catch (err) {\n      console.log(err);\n    }\n  } else {\n    console.log(\"form not ready\");\n  }\n};\n\n// ETH/USD PRICE\nconst cg_ethusd = fetch(\n  \"https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd\",\n  {\n    mode: \"no-cors\",\n  }\n);\nif (!cg_ethusd.ok) {\n  /*return (\n    <Widget\n      src={`${USER}/widget/Common.error`}\n      props={{ message: `PRICE_API ${cg_ethusd.error}` }}\n    />\n  );\n  */\n  if (!state.ethusd) {\n    State.update({ ethusd: 1800 });\n  }\n} else {\n  if (!state.ethusd) {\n    State.update({ ethusd: cg_ethusd[\"ethereum\"][\"usd\"] });\n  }\n}\n\nreturn (\n  <Container>\n    <div class=\"row d-flex justify-content-center w-100\">\n      <Heading class=\"my-5\">{APP_TITLE}</Heading>\n      <p class=\"text-light text-center font-italic\">\n        Handling subscriptions with ERC-1155 it&apos;s never been that easy.\n      </p>\n    </div>\n\n    {state.collectionCreated && (\n      <div class=\"row d-flex justify-content-center w-100\">\n        <div class=\"alert alert-success\" role=\"alert\">\n          Product successfully created! Check it&nbsp;\n          <a href={`${USER}/widget/Merchant.view?merchant=${props.sender}`}>\n            here\n          </a>\n          !\n        </div>\n      </div>\n    )}\n\n    <div class=\"row d-flex justify-content-center\">\n      <MainCard onSubmit={handleSubmit}>\n        <div class=\"row d-flex justify-content-center\">\n          <div class=\"col\">\n            <h2 class=\"text-white text-center\">Create a new product</h2>\n          </div>\n        </div>\n        {/* PRODUCT NAME */}\n        <div class=\"row d-flex justify-content-center\">\n          <div class=\"col-12\">\n            <div class=\"form-group\">\n              <label for=\"product_name\" class=\"text-white\">\n                Product Name\n              </label>\n              <input\n                type=\"text\"\n                value={state.product_name}\n                onChange={onNameChange}\n                class=\"form-control\"\n                id=\"product_name\"\n                placeholder=\"Netflix\"\n                active={\n                  !state.product_name\n                    ? \"blank\"\n                    : validateName()\n                    ? \"valid\"\n                    : \"invalid\"\n                }\n              />\n            </div>\n          </div>\n        </div>\n        {/* PRODUCT PRICE + TIMEFRAME */}\n        <div class=\"row d-flex justify-content-center\">\n          <div class=\"col-6\">\n            <div class=\"form-group\">\n              <label for=\"price\" class=\"text-white\">\n                Recurrent price\n              </label>\n\n              <div class=\"input-group mb-3\">\n                <div class=\"input-group-prepend\">\n                  <span class=\"input-group-text\" id=\"basic-addon1\">\n                    \u039e\n                  </span>\n                </div>\n                <input\n                  type=\"number\"\n                  class=\"form-control\"\n                  value={state.price}\n                  onChange={onPriceChange}\n                  id=\"price\"\n                  placeholder=\"0.011\"\n                  active={\n                    !state.price\n                      ? \"blank\"\n                      : validatePrice()\n                      ? \"valid\"\n                      : \"invalid\"\n                  }\n                />\n                <div class=\"input-group-append\">\n                  <span class=\"input-group-text\">{state.usdPrice} $</span>\n                </div>\n              </div>\n            </div>\n          </div>\n          <div class=\"col-6\">\n            <div class=\"form-group\">\n              <label for=\"timeframe\" class=\"text-white\">\n                Billing period\n              </label>\n              <div class=\"input-group mb-3\">\n                <input\n                  type=\"number\"\n                  class=\"form-control\"\n                  value={state.timeframe}\n                  onChange={onTimeframeChange}\n                  step={1}\n                  id=\"timeframe\"\n                  placeholder=\"30\"\n                  active={\n                    !state.price\n                      ? \"blank\"\n                      : validateTimeframe()\n                      ? \"valid\"\n                      : \"invalid\"\n                  }\n                />\n                <div class=\"input-group-append\">\n                  <span class=\"input-group-text\" id=\"basic-addon1\">\n                    Days\n                  </span>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* URI */}\n        <div class=\"row d-flex justify-content-center\">\n          <div class=\"col-12\">\n            <div class=\"form-group\">\n              <label for=\"uri\" class=\"text-white\">\n                Image URI\n              </label>\n              <OverlayTrigger\n                key={placement}\n                placement={placement}\n                overlay={\n                  <Tooltip id={`tooltip-${placement}`}>\n                    Subscription tokens will have this image.\n                  </Tooltip>\n                }\n              >\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  width=\"16\"\n                  height=\"16\"\n                  fill=\"white\"\n                  class=\"bi bi-info-circle\"\n                  viewBox=\"0 0 16 16\"\n                >\n                  <path d=\"M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z\" />\n                  <path d=\"m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z\" />\n                </svg>\n              </OverlayTrigger>\n\n              <input\n                type=\"text\"\n                class=\"form-control\"\n                value={state.uri}\n                onChange={onUriChange}\n                id=\"uri\"\n                name=\"uri\"\n                placeholder=\"ipfs://.../my_image.png\"\n                active={\n                  !state.uri ? \"blank\" : validateUri() ? \"valid\" : \"invalid\"\n                }\n              />\n            </div>\n          </div>\n        </div>\n        {/* START TIMESTAMP */}\n        <div class=\"row d-flex justify-content-center\">\n          <div class=\"col-12\">\n            <div class=\"form-group\">\n              <label for=\"startTimestamp\" class=\"text-white\">\n                Mint starts at\n              </label>\n              <input\n                type=\"datetime-local\"\n                class=\"form-control\"\n                value={state.startTimestamp}\n                onChange={onStartTimestampChange}\n                id=\"startTimestamp\"\n                active={\n                  !state.startTimestamp\n                    ? \"blank\"\n                    : validateStartTimestamp()\n                    ? \"valid\"\n                    : \"invalid\"\n                }\n              />\n            </div>\n          </div>\n        </div>\n\n        {/* SUPPLY CHECKBOX */}\n        <div class=\"row d-flex justify-content-center\">\n          <div class=\"col-12\">\n            <div class=\"form-check px-0\">\n              <Box>\n                <Checkbox.Root\n                  checked={state.cap_supply}\n                  onCheckedChange={onCheckboxChange}\n                  id={\"cap_supply_checkbox\"}\n                >\n                  <Checkbox.Indicator>\n                    <svg\n                      width=\"20\"\n                      height=\"20\"\n                      viewBox=\"0 0 15 15\"\n                      fill=\"none\"\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                    >\n                      <path\n                        d=\"M11.4669 3.72684C11.7558 3.91574 11.8369 4.30308 11.648 4.59198L7.39799 11.092C7.29783 11.2452 7.13556 11.3467 6.95402 11.3699C6.77247 11.3931 6.58989 11.3355 6.45446 11.2124L3.70446 8.71241C3.44905 8.48022 3.43023 8.08494 3.66242 7.82953C3.89461 7.57412 4.28989 7.55529 4.5453 7.78749L6.75292 9.79441L10.6018 3.90792C10.7907 3.61902 11.178 3.53795 11.4669 3.72684Z\"\n                        fill=\"currentColor\"\n                        fill-rule=\"evenodd\"\n                        clip-rule=\"evenodd\"\n                      ></path>\n                    </svg>\n                  </Checkbox.Indicator>\n                </Checkbox.Root>\n                <span htmlFor={\"cap_supply_checkbox\"} class=\"text-white\">\n                  I want to cap the token supply\n                </span>\n              </Box>\n            </div>\n          </div>\n        </div>\n\n        {/* MAX SUPPLY */}\n        {state.cap_supply && (\n          <div class=\"row d-flex justify-content-center mt-2\">\n            <div class=\"col-12\">\n              <div class=\"form-group\">\n                <input\n                  type=\"number\"\n                  value={state.supply}\n                  onChange={onSupplyChange}\n                  class=\"form-control\"\n                  id=\"supply\"\n                  placeholder=\"5000\"\n                  active={\n                    !state.supply\n                      ? \"blank\"\n                      : validateSupply()\n                      ? \"valid\"\n                      : \"invalid\"\n                  }\n                />\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* SUBMIT */}\n        <div class=\"row d-flex justify-content-center mt-2\">\n          <div class=\"col-12 text-center\">\n            {Ethers.provider() ? (\n              <button\n                class=\"btn btn-secondary btn-block\"\n                style={{ fontWeight: 500, minWidth: \"10vw\" }}\n                type=\"submit\"\n                onClick={createCollection}\n                disabled={!isFormValid || state.waiting}\n              >\n                {state.waiting ? (\n                  <div class=\"spinner-border text-light\" role=\"status\"></div>\n                ) : (\n                  \"Create Product\"\n                )}\n              </button>\n            ) : (\n              <Web3Connect connectLabel=\"Connect with Web3\" />\n            )}\n          </div>\n        </div>\n      </MainCard>\n    </div>\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/4ac12ee4ebd5536d7b130a9c5f8eebb1136145312c9e523289bf346268aeebfd/widget/Merchant.create", "fact_widget_deployments_id": "efd14aee53308612444d8e42b3e58098", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 2}