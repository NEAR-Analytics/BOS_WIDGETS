{"tx_hash": "JARKyLxD44eRtQMkjjcNsg4LDkV1e2bCgrRxDXgpBzUg", "action_id_social": "DJ6EJfLdGExypw3Lf7FRsYagFtf5xYN1rFzCU84Gy5tZ-0-widget", "block_id": 125157752, "block_timestamp": "2024-08-06T15:14:40.606Z", "signer_id": "treasury-devdao.near", "widget_name": "lib.common", "source_code": "const treasuryDaoID = \"testing.sputnik-dao.near\";\nfunction getTransferApproversAndThreshold() {\n  const daoPolicy = Near.view(treasuryDaoID, \"get_policy\", {});\n  const groupWithTransferPermission = (daoPolicy.roles ?? []).filter((role) => {\n    const transferPermissions = [\n      \"*:*\",\n      \"transfer:*\",\n      \"transfer:VoteApprove\",\n      \"transfer:VoteReject\",\n      \"transfer:VoteRemove\",\n      \"*:VoteApprove\",\n      \"*:VoteReject\",\n      \"*:VoteRemove\",\n    ];\n    return (role?.permissions ?? []).some((i) =>\n      transferPermissions.includes(i)\n    );\n  });\n  let approversGroup = [];\n  let ratios = [];\n  groupWithTransferPermission.map((i) => {\n    approversGroup = approversGroup.concat(i.kind.Group);\n    if (i.vote_policy[\"transfer\"].weight_kind === \"RoleWeight\") {\n      ratios = ratios.concat(i.vote_policy[\"transfer\"].threshold);\n      ratios = ratios.concat(i.vote_policy[\"transfer\"].threshold);\n    }\n  });\n  let numerator = 0;\n  let denominator = 0;\n  if (ratios.length > 0) {\n    ratios.forEach((value, index) => {\n      if (index == 0 || index % 2 === 0) {\n        // Even index -> numerator\n        numerator += value;\n      } else {\n        // Odd index -> denominator\n        denominator += value;\n      }\n    });\n  } else {\n    numerator = 1;\n    denominator = 2;\n  }\n  return {\n    approverAccounts: approversGroup,\n    threshold: numerator / denominator,\n  };\n}\nconst filterFunction = (item, filterStatusArray, filterKindArray) => {\n  const kind =\n    typeof item.kind === \"string\" ? item.kind : Object.keys(item.kind)[0];\n  if (filterStatusArray.length > 0 && filterKindArray.length > 0) {\n    return (\n      filterStatusArray.includes(item.status) && filterKindArray.includes(kind)\n    );\n  } else if (filterKindArray.length > 0) {\n    return filterKindArray.includes(kind);\n  } else if (filterStatusArray.length > 0) {\n    return filterStatusArray.includes(item.status);\n  }\n  return true;\n};\nfunction getFilteredProposalsByStatusAndkind({\n  resPerPage,\n  reverse,\n  filterKindArray,\n  filterStatusArray,\n  offset,\n  lastProposalId,\n}) {\n  let newLastProposalId = offset ?? 0;\n  let filteredProposals = [];\n  const limit = 30;\n  if (reverse && !offset) {\n    newLastProposalId = lastProposalId;\n  }\n  const promiseArray = [];\n  while (\n    (reverse && newLastProposalId > 0) ||\n    (!reverse && newLastProposalId < lastProposalId)\n  ) {\n    promiseArray.push(\n      Near.asyncView(treasuryDaoID, \"get_proposals\", {\n        from_index:\n          newLastProposalId - limit > 0 ? newLastProposalId - limit : 0,\n        limit: limit,\n      })\n    );\n    if (reverse) {\n      newLastProposalId -= limit;\n    } else {\n      newLastProposalId += limit;\n    }\n  }\n  return Promise.all(promiseArray).then((res) => {\n    const proposals = [].concat(...res);\n    filteredProposals = proposals.filter((item) =>\n      filterFunction(item, filterStatusArray, filterKindArray)\n    );\n    const uniqueFilteredProposals = Array.from(\n      new Map(filteredProposals.map((item) => [item.id, item])).values()\n    );\n    const newArray = uniqueFilteredProposals.slice(0, resPerPage);\n    if (reverse) {\n      newArray.reverse();\n    }\n    return {\n      filteredProposals: newArray,\n      totalLength: filteredProposals.length,\n    };\n  });\n}\nreturn {\n  getTransferApproversAndThreshold,\n  getFilteredProposalsByStatusAndkind,\n};\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/treasury-devdao.near/widget/lib.common", "fact_widget_deployments_id": "6d6bd3d8ca5882606f3dcfa4b0f22b2c", "inserted_timestamp": "2024-08-06T16:55:57.928Z", "modified_timestamp": "2024-08-06T16:55:57.928Z", "__row_index": 5}