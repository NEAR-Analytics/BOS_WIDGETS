{"tx_hash": "7aHywzG3nyUzmpYdRjhMDGFVfVZk9R3eW1TcWDdg2WrG", "action_id_social": "GYbXDjv5ticmxXsF4bmMYTy3pRoVZVLXLwejkMHxSsVe-0-widget", "block_id": 100415319, "block_timestamp": "2023-09-05T02:04:02.986Z", "signer_id": "genadrop.near", "widget_name": "GenaDrop.DAO.NFTMint", "source_code": "/**\n * To Do\n * Check if policies get updated for different dao\n * Check if gas is right amount\n * Error happening inside of funcition call\n * can propose is not updating correctly\n */\nconst nearContract = \"nft.genadrop.near\";\nconst nft_gas = 200000000000000;\nconst nft_deposit = 10000000000000000000000;\nconst proposal_gas = 219000000000000;\nconst method_name = \"nft_mint\";\nconst daoId = props.daoId ?? \"drop.sputnik-dao.near\";\nconst nearOnly = true;\nlet accountId = context.accountId;\nconst contractAddresses = {\n  0: [nearContract, \"Near\"],\n};\nconst chains = [\n  {\n    id: \"0\",\n    name: \"Near\",\n    url: \"https://ipfs.near.social/ipfs/bafkreigv55ubnx3tfhbf56toihekuxvgzfqn5c3ndbfjcg3e4uvaeuy5cm\",\n  },\n];\n\nconst proposalKinds = {\n  ChangeConfig: \"config\",\n  ChangePolicy: \"policy\",\n  AddMemberToRole: \"add_member_to_role\",\n  RemoveMemberFromRole: \"remove_member_from_role\",\n  FunctionCall: \"call\",\n  UpgradeSelf: \"upgrade_self\",\n  UpgradeRemote: \"upgrade_remote\",\n  Transfer: \"transfer\",\n  SetStakingContract: \"set_vote_token\",\n  AddBounty: \"add_bounty\",\n  BountyDone: \"bounty_done\",\n  Vote: \"vote\",\n  FactoryInfoUpdate: \"factory_info_update\",\n  ChangePolicyAddOrUpdateRole: \"policy_add_or_update_role\",\n  ChangePolicyRemoveRole: \"policy_remove_role\",\n  ChangePolicyUpdateDefaultVotePolicy: \"policy_update_default_vote_policy\",\n  ChangePolicyUpdateParameters: \"policy_update_parameters\",\n};\n\nconst actions = {\n  AddProposal: \"AddProposal\",\n  VoteApprove: \"VoteApprove\",\n  VoteReject: \"VoteReject\",\n  VoteRemove: \"VoteRemove\",\n};\n\n// -- Get all the roles from the DAO policy\nlet roles = Near.view(daoId, \"get_policy\");\nconst daoBond = roles.proposal_bond;\n\nroles = roles === null ? [] : roles.roles;\n// state update roles\nconst isUserAllowedTo = (roles, user, kind, action) => {\n  // -- Filter the user roles\n  const userRoles = [];\n  for (const role of roles) {\n    if (role.kind === \"Everyone\") {\n      userRoles.push(role);\n      continue;\n    }\n    if (!role.kind.Group) continue;\n    if (user && role.kind.Group && role.kind.Group.includes(user)) {\n      userRoles.push(role);\n    }\n  }\n\n  // -- Check if the user is allowed to perform the action\n  let allowed = false;\n\n  userRoles\n    .filter(({ permissions }) => {\n      const allowedRole =\n        permissions.includes(`${kind.toString()}:${action.toString()}`) ||\n        permissions.includes(`${kind.toString()}:*`) ||\n        permissions.includes(`*:${action.toString()}`) ||\n        permissions.includes(\"*:*\");\n      allowed = allowed || allowedRole;\n      return allowedRole;\n    })\n    .map((role) => role.name);\n    console.log(\"inside is user allowed to\")\n\n  return allowed;\n};\n\nconst canPropose = isUserAllowedTo(\n  state.roles ?? roles,\n  context.accountId,\n  proposalKinds.FunctionCall,\n  actions.AddProposal\n); // logic not working for some reason\nconsole.log(\n  \"Can Propose Function call  for \" +daoId + \" |  \" + context.accountId + \" \" + canPropose\n);\n// move this to helper function\n\nconst updateUserArgs = () => {\n  if (!state.image.cid) {\n    return;\n  }\n  if (!accountId) {\n    console.log(\"Please login\"); // add share dogvwallet\n    State.update({\n      showAlert: true,\n      toastMessage: \"Please log in before continuing\",\n    });\n    setTimeout(() => {\n      State.update({\n        showAlert: false,\n      });\n    }, 3000);\n  } else if (!state.title) {\n    console.log(\"Please Enter title\");\n    State.update({\n      showAlert: true,\n      toastMessage: \"Please enter a title for the NFT\",\n    });\n\n    setTimeout(() => {\n      State.update({\n        showAlert: false,\n      });\n    }, 3000);\n  } else if (!state.description) {\n    State.update({\n      showAlert: true,\n      toastMessage: \"Please enter a description for the NFT\",\n    });\n    setTimeout(() => {\n      State.update({\n        showAlert: false,\n      });\n    }, 3000);\n  } else {\n    const metadata = {\n      name: state.title,\n      description: state.description,\n      properties: [],\n      image: `ipfs://${state.image.cid}`,\n    };\n    console.log(\"come\", metadata);\n    asyncFetch(\"https://ipfs.near.social/add\", {\n      method: \"POST\",\n      headers: {\n        Accept: \"application/json\",\n      },\n      body: metadata,\n    }).then((res) => {\n      console.log(\"GO ON SOUN\", res);\n      const cid = res.body.cid;\n      const gas = nft_gas;\n      const deposit = nft_deposit;\n      console.log(\"State Image CID: \" + state.image.cid);\n      console.log(\"Reference CID: \" + cid);\n      const post_args = JSON.stringify({\n        token_id: `${Date.now()}`,\n        metadata: {\n          title: state.title,\n          description: state.description,\n          media: `https://ipfs.io/ipfs/${state.image.cid}`,\n          reference: `ipfs://${cid}`,\n        },\n        receiver_id: state.recipient,\n      });\n      console.log(\"Post args: \" + post_args);\n      const proposal_args = Buffer.from(post_args, \"utf-8\").toString(\"base64\");\n      State.update({\n        proposal_args,\n      });\n    });\n  }\n  console.log(\"Should be end of update userArgs\");\n};\n\nconst proposeMint = () => {\n  Near.call([\n    {\n      contractName: state.daoId,\n      methodName: \"add_proposal\",\n      args: {\n        proposal: {\n          description: \"create proposal to mint NFT\",\n          kind: {\n            FunctionCall: {\n              receiver_id: nearContract,\n              actions: [\n                {\n                  method_name: method_name,\n                  args: state.proposal_args,\n                  deposit: \"10000000000000000000000\",\n                  gas: \"\" + nft_gas,\n                  receiver_id: `${state.recipient ?? context.accountId}`,\n                },\n              ],\n            },\n          },\n        },\n      },\n      deposit: state.daoBond ?? daoBond,\n      gas: \"\" + proposal_gas,\n    },\n  ]);\n};\nconst handleMint = () => {\n  if (!state.image.cid) {\n    return;\n  }\n  if (!context.accountId) {\n    console.log(\"Please login\"); // add share dogvwallet\n    State.update({\n      showAlert: true,\n      toastMessage: \"Please log in before continuing\",\n    });\n    setTimeout(() => {\n      State.update({\n        showAlert: false,\n      });\n    }, 3000);\n  } else if (!state.title) {\n    console.log(\"Please Enter title\");\n    State.update({\n      showAlert: true,\n      toastMessage: \"Please enter a title for the NFT\",\n    });\n\n    setTimeout(() => {\n      State.update({\n        showAlert: false,\n      });\n    }, 3000);\n  } else if (!state.description) {\n    State.update({\n      showAlert: true,\n      toastMessage: \"Please enter a description for the NFT\",\n    });\n    setTimeout(() => {\n      State.update({\n        showAlert: false,\n      });\n    }, 3000);\n  } else {\n    const metadata = {\n      name: state.title,\n      description: state.description,\n      properties: [],\n      image: `ipfs://${state.image.cid}`,\n    };\n    console.log(\"come\", metadata);\n    asyncFetch(\"https://ipfs.near.social/add\", {\n      method: \"POST\",\n      headers: {\n        Accept: \"application/json\",\n      },\n      body: metadata,\n    }).then((res) => {\n      console.log(\"GO ON SOUN\", res);\n      const cid = res.body.cid;\n      const gas = 200000000000000;\n      const deposit = 10000000000000000000000;\n      console.log(\"State Image CID: \" + state.image.cid);\n      console.log(\"Reference CID: \" + cid);\n      Near.call([\n        {\n          contractName: \"nft.genadrop.near\",\n          methodName: method_name,\n          args: {\n            token_id: `${Date.now()}`,\n            metadata: {\n              title: state.title,\n              description: state.description,\n              media: `https://ipfs.io/ipfs/${state.image.cid}`,\n              reference: `ipfs://${cid}`,\n            },\n            receiver_id: state.recipient,\n          },\n          gas: gas,\n          deposit: deposit,\n        },\n      ]);\n    });\n  }\n};\n\nState.init({\n  title: \"\",\n  description: \"\",\n  recipient: context.accountId,\n  isSoulBound: false,\n  showAlert: false,\n  toastMessage: \"\",\n  selectIsOpen: false,\n  selectedChain: \"0\",\n  daoId: daoId,\n  daoBond: daoBond,\n  roles: roles,\n  canPropose: canPropose,\n  proposal_args: null,\n});\n\n//select tag\nconst handleSelectClick = () => {\n  State.update({\n    selectIsOpen: !state.selectIsOpen,\n  });\n};\n\n// const handleOptionClick = (option) => {\n//   setSelectedOption(option);\n//   setIsOpen(false);\n// };\n\nconst handleOutsideClick = (e) => {\n  if (!e.target.closest(\".select-replica__select\")) {\n    State.update({\n      selectIsOpen: false,\n    });\n  }\n};\n\nconst onChangeTitle = (title) => {\n  console.log(\"onChange title: \" + title);\n  State.update({\n    title,\n  });\n  updateUserArgs();\n};\n\nconst data = Social.keys(\"*/profile\", \"final\");\n\nif (!data) {\n  return \"Loading\";\n}\n\nconst accounts = Object.entries(data);\n\nconst allWidgets = [];\n\nfor (let i = 0; i < accounts.length; ++i) {\n  const accountId = accounts[i][0];\n  allWidgets.push(accountId);\n}\n\nconst onChangeRecipient = (recipient) => {\n  state.selectedChain === \"0\"\n    ? State.update({\n        recipient: recipient[0],\n      })\n    : State.update({\n        recipient,\n      });\n  updateUserArgs();\n};\nconst onChangeDAO = (daoId) => {\n  // add policy change and all this logic\n  let roles = Near.view(daoId, \"get_policy\");\n  const daoBond = roles.proposal_bond;\n  roles = roles === null ? [] : roles.roles;\n  const canPropose = isUserAllowedTo(\n    roles,\n    context.accountId,\n    proposalKinds.FunctionCall,\n    actions.AddProposal\n  ); // logic not working for some reason\n  console.log(\n    \"Can Propose Function call for \" +\n      daoId +\n      \" inside onchangedao \" +\n      context.accountId +\n      \" \" +\n      canPropose\n  );\n  State.update({\n    daoId,\n    roles,\n    canPropose,\n    daoBond,\n  });\n};\n\nconst handleChainChange = (chain_id) => {\n  console.log(\n    \"get what we doing:\",\n    chain_id || \"no value from event?\",\n    chain_id == \"0\",\n    !accountId\n  );\n  if (chain_id == \"0\") {\n    if (!accountId) {\n      console.log(\"not what we thought,:\", accountId);\n      State.update({\n        showAlert: true,\n        toastMessage: \"Please log in before continuing\",\n      });\n      return;\n    }\n    State.update({\n      selectedChain: chain_id,\n    });\n  }\n  console.log(\"encts here\", Ethers.send);\n  Ethers.send(\"wallet_switchEthereumChain\", [\n    {\n      chainId: \"0x\" + Number(chain_id).toString(16),\n    },\n  ]).then((data) => console.log(\"done!!!\", data));\n  console.log(\"what happens after\");\n  State.update({\n    selectedChain: chain_id,\n  });\n  console.log(\"afters\", state.selectedChain);\n};\n\nconst onChangeDesc = (description) => {\n  console.log(\"Log ciritcal critics:\", state.selectedChain, state.title);\n  State.update({\n    description,\n  });\n  updateUserArgs();\n};\n\nconst handleToggle = () => {\n  State.update({\n    isSoulBound: !state.isSoulBound,\n  });\n};\n// if (state.sender === undefined) {\n//   console.log(\"of course it's undefined\", ethers);\n//   const accounts = Ethers.send(\"eth_requestAccounts\", []);\n//   console.log(\"account\", accounts);\n//   if (accounts.length) {\n//     State.update({ sender: accounts[0] });\n//     console.log(\"set sender\", accounts[0]);\n//   }\n// }\n\nconst Heading = styled.p`\n  margin: 3rem auto 0px auto;\n  font-size: 1em;\n  color:#0f1d40;\n  line-height:2.1rem;\n  width:60%;\n  text-align: center;\n  font-family: \"SF Pro Display\",sans-serif;\n`;\nconst SubHeading = styled.p`\n  margin: 0 auto 3px auto;\n  font-size: 1em;\n  color:#0f1d40;\n  line-height:1.4rem;\n  width:60%;\n  text-align: center;\n  font-family: \"SF Pro Display\",sans-serif;\n`;\n\nconst ImageUploadCard = styled.div`\ndisplay:flex;\nflex-flow: column nowrap;\nalign-items: center;\n  width:80%;\n  border: 2px dashed #0d99ff;\n  border-radius: 1rem;\n  box-shadow: 4px 4px 20px 6px rgba(0,0,0,.2);\n  margin:30px auto;\n  padding:1.5rem;\n  text-align: center;\n`;\n\nconst Main = styled.div`\n  display: grid;\n  gap: 3rem;\n  align-content:center;\n  grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));\n  justify-content: center;\n  margin-top: 5px;\n  width:100%;\n  padding: 1rem;\n  .button{\n    padding: .75em 2em;\n    border-radius: .7em;\n    border: 1px solid #0d99ff;\n    transition: all .3s;\n    cursor: pointer;\n    color: #fff;\n    background: #0d99ff;\n    &:hover{\n        color: #0d99ff;\n        background:#fff;\n    }\n  @media screen and (max-width: 540px){\n      padding: .5em 2em;    \n      }\n  }\n`;\n\nconst Text = styled.p`\nfont-size: .9rem;\ncolor: #525c76;\nline-height:1.rem;\nmargin: 3px;\n`;\n\nconst Elipse = styled.div`\nbackground-color:#dff3f9;\nheight: 100px;\nwidth: 100px;\nborder-radius: 50%;\n`;\n\nconst Card = styled.div`\npadding: 1em;\nborder: 1px solid #e5e8eb;\ngap: 2em;\nmargin: 10px auto;\nborder-radius: .7em;\n& input{\n  display: block;\n  padding:.5em;\n  width:100%;\n  border: 1px solid #e5e8eb;\n  border-radius: 10px;\n  outline: none;\n  background: #f4f5f6;\n  color: #525c76;\n  :focus{\n  box-shadow:none;\n    border:1px solid #0d99ff;\n  }\n  &::placeholder {\n    color: palevioletred;\n  }\n  }\n  .soulbound{\n    display: flex;\n    justify-content: space-between;\n    width: 100%;\n  }\n`;\n\nconst ImageCard = styled.div`\n  box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);\n  height:100%;\n  max-height:100%;\n  width: 90%;\n  max-width: 500px;\n  border-radius: 1rem;\n  &>img{\n  object-fit: cover;\n  width: 100%;\n  height: 100%;\n  }\n`;\n\nconst Input = styled.input`\n  display: block;\n  padding:.5em;\n  width:100%;\n  border: 1px solid #e5e8eb;\n  border-radius: 10px;\n  outline: none;\n  background: #f4f5f6;\n  color: #525c76;\n  :focus{\n    border:1px solid #0d99ff;\n  }\n  ::placeholder {\n    color: palevioletred;\n  }\n`;\n\nconst TextArea = styled.textarea`\n  display: block;\n  padding:.5em;\n  width:100%;\n  border: 1px solid #e5e8eb;\n  border-radius: 10px;\n  outline: none;\n  background: #f4f5f6;\n  color: #525c76;\n  :focus{\n    border:1px solid #0d99ff;\n  }\n`;\n\nconst SelectTag = styled.select`\n  height: fit-content;\n  width: 300px;\n`;\n\nconst ChainIcon = styled.option`\n  display: flex;\n  height: 130px;\n  padding: 1rem auto;\n  &>img{\n    height:100px;\n    width: 100px;\n    object-fit: contain;\n  }\n`;\n\nconst SelectReplicaContainer = styled.div`\n  position: relative;\n  display: inline-block;\n  background-color: #fff;\n  z-index: 1;\n  & .select-replica__select {\n    position: relative;\n  }\n\n  & .select-replica__selected {\n    cursor: pointer;\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    // padding: 3px;\n    border: 1px solid #ccc;\n    gap: 10px;\n    border-radius: 4px;\n    background-color: #fff;\n    width: 200px;\n    & > img {\n      height: 100%;\n      width: 100px;\n      object-fit: contain;\n    }\n  }\n\n  & .select-replica__options {\n    position: absolute;\n    top: 100%;\n    left: 0;\n    width: 100%;\n    /* height: fit-content; */\n    overflow-y: auto;\n    border: 1px solid #ccc;\n    border-top: none;\n    border-radius: 0 0 4px 4px;\n    background-color: #fff;\n    max-height: 250px;\n    display: none;\n  }\n\n  & .select-replica__options.open {\n    display: block;\n  }\n\n  & .select-replica__option {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    cursor: pointer;\n    background-color: #fff;\n    padding: 3px;\n    border-bottom: 1px solid gray;\n  }\n\n  & .select-replica__option.selected {\n    background-color: #f0f0f0;\n  }\n\n  & .select-replica__option img {\n    height: 60px;\n    width: 100px;\n    object-fit: contain;\n  }\n`;\n\nconst SelectGroup = styled.div`\n  display: flex;\n  flex-flow: column nowrap;\n  justify-content: center;\n  gap: 1rem;\n  margin: 2rem auto;\n`;\n\nconst ToggleButton = styled.div`\n   /* The switch - the box around the slider */\n.switch {\n  position: relative;\n  display: inline-block;\n  width: 60px;\n  height: 34px;\n}\n\n/* Hide default HTML checkbox */\n.switch input {\n  opacity: 0;\n  width: 0;\n  height: 0;\n}\n\n/* The slider */\n.slider {\n  position: absolute;\n  cursor: pointer;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background-color: #ccc;\n  -webkit-transition: .4s;\n  transition: .4s;\n}\n\n.slider:before {\n  position: absolute;\n  content: \"\";\n  height: 26px;\n  width: 26px;\n  left: 4px;\n  bottom: 4px;\n  background-color: white;\n  -webkit-transition: .4s;\n  transition: .4s;\n}\n\ninput:checked + .slider {\n  background-color: #2196F3;\n}\n\ninput:focus + .slider {\n  box-shadow: 0 0 1px #2196F3;\n}\n\ninput:checked + .slider:before {\n  -webkit-transform: translateX(26px);\n  -ms-transform: translateX(26px);\n  transform: translateX(26px);\n}\n\n/* Rounded sliders */\n.slider.round {\n  border-radius: 34px;\n}\n\n.slider.round:before {\n  border-radius: 50%;\n} \n`;\n\nconsole.log(\n  \"Here \ud83e\udd14 \" +\n    state.selectedChain +\n    \" \" +\n    chains\n      .filter((chain) => {\n        return state.selectedChain.toString() == chain.id;\n      })\n      .map((c) => c.url)\n);\n\nreturn (\n  <>\n    {state.showAlert && (\n      <Widget src=\"jgodwill.near/widget/genalert\" props={state} />\n    )}\n    <Heading className=\"text-center fs-2 fw-bold\">\n      Mint NFT / DAO Propose on NEAR\n    </Heading>\n\n    <Main className=\"container-fluid\">\n      {!state.image.cid ? (\n        <div className=\"flex-grow-1\">\n          <SubHeading>Upload an image to create an NFT on NEAR</SubHeading>\n          <ImageUploadCard className=\"flex-grow-1\">\n            <Elipse />\n            <>\n              <IpfsImageUpload\n                image={state.image}\n                className=\"btn text-decoration-none link-primary pe-auto\"\n              />\n              <div>\n                <Text>\n                  We support .jpg, .jpeg, .png, .svg files and mint to Near\n                </Text>\n              </div>\n            </>\n          </ImageUploadCard>\n        </div>\n      ) : (\n        <>\n          <Card className=\"d-flex flex-column align-items-center w-100\">\n            <div>\n              <IpfsImageUpload\n                image={state.image}\n                onChange={() => updateUserArgs()}\n                className=\"btn btn-outline-primary border-0 rounded-3\"\n              />\n            </div>\n            <ImageCard>\n              <img\n                src={`https://ipfs.io/ipfs/` + state.image.cid}\n                alt=\"uploaded image\"\n                width=\"100%\"\n                height=\"100%\"\n                className=\"rounded-3\"\n              />\n            </ImageCard>\n          </Card>\n          <div>\n            <Card>\n              <Card>\n                Title:\n                <Input\n                  type=\"text\"\n                  value={state.title || \"\"}\n                  onChange={(e) => onChangeTitle(e.target.value)}\n                />\n              </Card>\n              <Card>\n                Description:\n                <TextArea\n                  type=\"text\"\n                  value={state.description || \"\"}\n                  onChange={(e) => onChangeDesc(e.target.value)}\n                />\n              </Card>\n              <Card>\n                Propose to Mint To:\n                <Typeahead\n                  id=\"async-example\"\n                  className=\"type-ahead\"\n                  isLoading={isLoading}\n                  labelKey=\"search\"\n                  minLength={1}\n                  options={allWidgets}\n                  onChange={(value) => onChangeRecipient(value)}\n                  placeholder={\n                    state.selectedChain == \"0\" ? accountId : state.sender\n                  }\n                />\n              </Card>\n              <Card>\n                DAO to Propose to Mint\n                <Typeahead\n                  id=\"async-example\"\n                  className=\"type-ahead\"\n                  isLoading={isLoading}\n                  labelKey=\"search\"\n                  minLength={1}\n                  options={allWidgets}\n                  onChange={(value) => onChangeDAO(value)}\n                  placeholder={state.daoId}\n                />\n              </Card>\n            </Card>\n            <button\n              type=\"button\"\n              className=\"btn btn-primary d-flex flex-column align-items-center mx-auto\"\n              onClick={handleMint}\n            >\n              Mint to {contractAddresses[state.selectedChain][1]}\n            </button>\n            {(true || state.canPropose) && state.proposal_args ? (\n              <button\n                type=\"button\"\n                className=\"btn btn-primary d-flex flex-column align-items-center mx-auto\"\n                onClick={state.canPropose === true ? proposeMint : null}\n              >\n                {state.canPropose === true ? \"\" : \"Cannot \"}Propose to Mint to\n                NEAR to {state.daoId ?? daoId}\n              </button>\n            ) : (\n              <button\n                type=\"button\"\n                className=\"btn btn-danger d-flex flex-column align-items-center mx-auto\"\n              >\n                Finish User Args To Propose to Mint to NEAR to{\" \"}\n                {state.daoId ?? daoId}\n              </button>\n            )}\n          </div>\n        </>\n      )}\n    </Main>\n    <Widget src=\"jgodwill.near/widget/GenaDrop.Footer\" />\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/genadrop.near/widget/GenaDrop.DAO.NFTMint", "fact_widget_deployments_id": "c3878ca3476b39a5d4a233097a8ea5a8", "inserted_timestamp": "2023-09-05T03:31:36.134Z", "modified_timestamp": "2023-09-05T03:31:36.134Z", "__row_index": 11}