{"tx_hash": "GDSnSfq3XKcDVuKq9m4Dia11SNsP45YjaACJSpbeitfV", "action_id_social": "AgDN21cxoerWoeVL6vkCa3rFvjJk46A4FiB9XjbacXG2-0-widget", "block_id": 112771021, "block_timestamp": "2024-02-13T21:31:06.302Z", "signer_id": "dropcast.near", "widget_name": "discord", "source_code": "const accountId = context.accountId;\nconst Owner = \"dropcast.near\";\nconst CLIENT_ID = \"1206878767633534976\";\nconst CLIENT_SECRET = \"GhYxHW-FZyo0pqK26xx7BVgwTa5VCLn6\";\nconst BASE_URL = \"https://near.org/dropcast.near/widget/\";\nconst OAuthScope = [\"identify\", \"guilds\"].join(\" \");\nconst API_URL = \"http://localhost:3000/api\";\n\nconst discordCode = props.code || \"\";\n\nState.init({\n  loaded: false,\n});\n\nconst convertObject = (params) => {\n  return Object.keys(params)\n    .map((param) => `${param}=${params[param]}`)\n    .join(\"&\");\n};\n\nconst fetchData = () => {\n  State.update({\n    loaded: true,\n  });\n\n  const params = {\n    client_id: CLIENT_ID,\n    client_secret: CLIENT_SECRET,\n    grant_type: \"authorization_code\",\n    code: discordCode,\n    redirect_uri: `${BASE_URL}discord`,\n    scope: OAuthScope,\n  };\n\n  const urlSearchParams = convertObject(params);\n\n  let promise = asyncFetch(`https://discordapp.com/api/v9/oauth2/token`, {\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n    },\n    method: \"POST\",\n    body: urlSearchParams,\n  });\n\n  promise.then((data) => {\n    if (data.status === 200) {\n      asyncFetch(`${API_URL}/auth/discord`, {\n        headers: {\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n        },\n        method: \"POST\",\n        body: convertObject(data.body),\n      }).then((res) => {\n        const result = res.body;\n        if (result.user)\n          return <Widget src={`${Owner}/widget/main`} props={result} />;\n        else if (result.error) return result.message;\n      });\n    } else {\n      return <Widget src={`${Owner}/widget/login`} />;\n    }\n  });\n};\n\nif (!discordCode || !accountId) return <Widget src={`${Owner}/widget/login`} />;\nelse if (!state.loaded) fetchData();\n", "metadata": {"fork_of": "dropcast.near/widget/discord@112761392"}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/dropcast.near/widget/discord", "fact_widget_deployments_id": "32f94597e0905e0e15424e52439b5e6b", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 57}