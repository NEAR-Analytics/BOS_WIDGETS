{"tx_hash": "PhT4e438T2XjurhVFfbqSdz34DveVLNJ2EnyRydT9Lt", "action_id_social": "2owLTjQb2HcJTByoXzKWwdRJzjWnABr9BTx6oNQiBnR3-0-widget", "block_id": 119703597, "block_timestamp": "2024-05-25T11:18:30.207Z", "signer_id": "dropcast.near", "widget_name": "discord", "source_code": "const accountId = context.accountId;\nconst Owner = \"dropcast.near\";\nconst CLIENT_ID = \"1206878767633534976\";\nconst CLIENT_SECRET = \"GhYxHW-FZyo0pqK26xx7BVgwTa5VCLn6\";\nconst BASE_URL = \"https://dev.near.org/dropcast.near/widget/\";\nconst OAuthScope = [\"identify\", \"guilds\"].join(\" \");\nconst API_URL = \"https://dropcast.nearverselabs.com\";\n// const API_URL = \"http://localhost:2402\";\nconst discordCode = props.code || \"\";\n\nlet TOKEN = Storage.get(\"token\", `${Owner}/widget/discord`);\nlet USER = Storage.get(\"user\", `${Owner}/widget/discord`);\n\nState.init({\n  error: \"\",\n  loaded: false,\n  go_login: false,\n  token: TOKEN,\n  user: USER,\n});\n\nconst convertObject = (params) => {\n  return Object.keys(params)\n    .map((param) => `${param}=${params[param]}`)\n    .join(\"&\");\n};\n\nconst fetchData = () => {\n  State.update({ ...state, loaded: true });\n  if (TOKEN) return;\n  const params = {\n    client_id: CLIENT_ID,\n    client_secret: CLIENT_SECRET,\n    grant_type: \"authorization_code\",\n    code: discordCode,\n    redirect_uri: `${BASE_URL}discord`,\n    scope: OAuthScope,\n  };\n\n  const urlSearchParams = convertObject(params);\n\n  let promise = asyncFetch(`https://discordapp.com/api/v9/oauth2/token`, {\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n    },\n    method: \"POST\",\n    body: urlSearchParams,\n  });\n\n  promise\n    .then((data) => {\n      if (data.status === 200) {\n        asyncFetch(`${API_URL}/api/auth/discord`, {\n          headers: {\n            \"Content-Type\": \"application/x-www-form-urlencoded\",\n          },\n          method: \"POST\",\n          body: convertObject({ ...data.body, wallet: accountId }),\n        }).then((res) => {\n          const result = res.body;\n\n          if (result.token) {\n            Storage.set(\"token\", result.token);\n            Storage.set(\"user\", result.user);\n            State.update({\n              ...state,\n              token: result.token,\n              user: result.user,\n            });\n          } else if (result.error)\n            State.update({ ...state, error: result.error });\n          setTimeout(() => {\n            State.update({ ...state, go_login: true });\n          }, 10000);\n        });\n      } else {\n        if (!TOKEN) State.update({ ...state, go_login: true });\n        return;\n      }\n    })\n    .catch((error) => {\n      if (!TOKEN) State.update({ ...state, go_login: true });\n    });\n};\n\nconst Logout = () => {\n  Storage.set(\"token\", null);\n  Storage.set(\"user\", null);\n};\n\nif (state.token || TOKEN)\n  return (\n    <Widget\n      src={`${Owner}/widget/main`}\n      props={{\n        API_URL,\n        USER: state.user || USER,\n        TOKEN: state.token || TOKEN,\n        Logout,\n        transactionHashes: props.transactionHashes,\n      }}\n    />\n  );\n\nif (!discordCode || !accountId || state.go_login)\n  return <Widget src={`${Owner}/widget/login`} />;\nelse if (!state.loaded && !state.token) fetchData();\n\nreturn <div>{state.error || `Loading`}</div>;\n", "metadata": {"fork_of": "dropcast.near/widget/discord@117511674"}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/dropcast.near/widget/discord", "fact_widget_deployments_id": "342261cee2eb0a3128621d3ad1717cb1", "inserted_timestamp": "2024-05-25T12:58:38.052Z", "modified_timestamp": "2024-05-25T12:58:38.052Z", "__row_index": 1}