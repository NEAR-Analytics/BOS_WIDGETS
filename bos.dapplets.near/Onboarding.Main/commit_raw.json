{"tx_hash": "3J7FXqhG6cH4fFx54W3CfHqTNQX5KoXSwihdnveUzZpm", "action_id_social": "3m4GsSfgGEBiciPvebTE8ndrirLHqSvUYGFLmqBmD9FT-0-widget", "block_id": 118980229, "block_timestamp": "2024-05-15T15:24:58.232Z", "signer_id": "bos.dapplets.near", "widget_name": "Onboarding.Main", "source_code": "// const TIME_UNTIL_RESHOW = 1000 * 60 // TESTING\nconst TIME_UNTIL_RESHOW = 1000 * 60 * 60 * 3 // PROD\n\nconst [show, setShow] = useState(false)\nconst [start, setStart] = useState(false)\nconst [showFrom, setShowFrom] = useState(0)\n\nconst response = Near.view('app.webguide.near', 'get_guide', { guide_id: props?.link?.id })\nconst data = response && JSON.parse(response)\nconst lastShow = data && data?.reduce((acc, chapter) => {\n  acc[chapter.id] = Storage.privateGet(chapter.id + '/lastShow')\n  return acc\n}, {})\n\nuseEffect(() => {\n  if (\n    !start && (\n      lastShow === null || (\n        lastShow && Object.values(lastShow).every(a => a === null)\n      )\n    )\n  ) return;\n  // here if (start || (lastShow && Object.values(lastShow).some(a => a !== null))) -- ToDo: replace?\n\n  if (!start) {\n    setStart(true)\n    return\n  }\n  \n  // *** DISPLAY LOGIC ***\n\n  if (lastShow) {\n    const currentMutation = data.find((ch) => ch?.id.includes('mutation'))?.id\n    const currentTime = Date.now()\n\n    for (const key of Object.keys(lastShow)) {\n      if (!lastShow[key]) continue\n\n      // TESTING\n      // if (lastShow[key].doNotShowAgain && currentTime - lastShow[key].time > TIME_UNTIL_RESHOW * 3) {\n      //   lastShow[key].doNotShowAgain = false\n      //   lastShow[key].isViewed = false\n      // }\n      //\n\n      // DO NOT refactor the following code block to stay the logic clear!!!\n      if (currentMutation === lastShow[key].mutation) {\n        if (!lastShow[key].doNotShowAgain) {\n          lastShow[key].show = currentTime - lastShow[key].time > TIME_UNTIL_RESHOW\n        } else {\n          if (lastShow[key].isViewed) {\n            lastShow[key].show = false\n          } else {\n            lastShow[key].show = currentTime - lastShow[key].time > TIME_UNTIL_RESHOW\n          }\n        }\n      } else {\n        if (!lastShow[key].doNotShowAgain) {\n          if (lastShow[key].isViewed) {\n            lastShow[key].show = currentTime - lastShow[key].time > TIME_UNTIL_RESHOW\n          } else {\n            lastShow[key].show = true\n          }\n        } else {\n          if (lastShow[key].isViewed) {\n            lastShow[key].show = false\n          } else {\n            lastShow[key].show = true\n          }\n        }\n      }\n    }\n  }\n\n  // *** SORT LOGIC ***\n\n  if (!lastShow && context.accountId === props?.link?.authorId) {\n    // show form to the author\n    setShow(true)\n  } else if (lastShow && Object.values(lastShow).some((a) => a === undefined || a?.show)) {\n    // with sort - some chapters have been displayed or new\n    data.sort(\n      (a, b) =>\n        !lastShow[a.id] && !lastShow[b.id]\n          ? 0\n          : !lastShow[a.id]\n            ? lastShow[b.id].show ? 0 : 1\n            : !lastShow[b.id]\n              ? lastShow[a.id].show ? 0 : -1\n              : lastShow[a.id].show - lastShow[b.id].show\n    )\n    const index = Object.values(lastShow).filter((a) => a && !a.show)?.length\n    setShowFrom(index)\n    setShow(true)\n  }\n}, [start, lastShow])\n\nsetTimeout(() => setStart(true), 10000)\n\nconst OverlayTriggerWrapper = styled.div`\n  display: flex;\n  z-index: 500;\n\n  .OverlayTrigger {\n    position: absolute;\n    background: #db504a;\n    border: 1px solid #db504a;\n    width: 6px;\n    height: 49px;\n    right: -6px;\n    top: 10px;\n    border-radius: 0px 4px 4px 0px;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    box-sizing: border-box;\n    z-index: 79;\n  }\n`\n\nconst Onboarding = styled.div`\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n\n  animation: falling-animation 0.3s linear forwards;\n\n  @keyframes falling-animation {\n    from {\n      transform: translate(-50%, -200%);\n    }\n\n    to {\n      transform: translate(-50%, -50%);\n    }\n  }\n`;\n\nconst handleClose = (isDoNotShowAgainChecked, viewedPages) => {\n  if (data) {\n    const time = Date.now()\n    const mutation = data.find((ch) => ch?.id.includes('mutation'))?.id\n    data.forEach((chapter) => {\n      const isViewed = !!(viewedPages.includes(chapter.id) || lastShow[chapter.id].isViewed)\n      const doNotShowAgain = !!((isDoNotShowAgainChecked && viewedPages.includes(chapter.id)) || lastShow[chapter.id].doNotShowAgain)\n      Storage.privateSet(\n        chapter.id + '/lastShow',\n        {\n          time,\n          doNotShowAgain,\n          mutation,\n          isViewed,\n        }\n      )\n    })\n  }\n  setShow(false)\n}\n\nconst saveData = (inputData) => {\n  if (context?.accountId) {\n    Near.call(\n      'app.webguide.near',\n      'set_guide',\n      {\n        guide_id: props.link.id,\n        data: inputData,\n      }\n    )\n  }\n}\n\nreturn (\n  <OverlayTriggerWrapper>\n    {show ? (\n      <DappletOverlay>\n        <Onboarding>\n          <Widget\n           loading={<></>}\n            props={{\n              handleClose,\n              data,\n              saveData,\n              setShow,\n              link: props.link,\n              showFrom,\n              oldRawData: response\n            }}\n            src=\"bos.dapplets.near/widget/Onboarding.SandboxOnboarding\"\n          />\n        </Onboarding>\n      </DappletOverlay>\n    ) : null}\n  </OverlayTriggerWrapper>\n)\n", "metadata": {"image": {"ipfs_cid": "bafkreih235nlz4vricl2h5s3ti7fmwsrkqerrqhspcan7z2vzhh5ebjk7y"}, "name": "Onboarding"}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bos.dapplets.near/widget/Onboarding.Main", "fact_widget_deployments_id": "0c2b0753a9471f9e75c4fde6cbe9a9e5", "inserted_timestamp": "2024-05-15T16:55:31.288Z", "modified_timestamp": "2024-05-15T17:51:14.266Z", "__row_index": 0}