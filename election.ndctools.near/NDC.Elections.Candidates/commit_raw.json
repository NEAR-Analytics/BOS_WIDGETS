{"tx_hash": "9Z1mi1iEWkHzSxrU2N8Q99raFti7a2NE178YBzwSaG6w", "action_id_social": "8F2LX4G3mZvS4oWkTWmm7xesLAd9J6MZ1DaiWC9rmFJ7-0-widget", "block_id": 98208132, "block_timestamp": "2023-08-06T14:51:44.941Z", "signer_id": "election.ndctools.near", "widget_name": "NDC.Elections.Candidates", "source_code": "const {\n  electionContract,\n  ndcOrganization,\n  myVotes,\n  id,\n  typ,\n  ref_link,\n  winnerIds,\n  quorum,\n  seats,\n  voters_num,\n  result,\n  isIAmHuman,\n  candidateId,\n} = props;\n\nconst widgets = {\n  voters: \"election.ndctools.near/widget/NDC.Elections.Voters\",\n  styledComponents: \"nomination.ndctools.near/widget/NDC.StyledComponents\",\n  modal: \"nomination.ndctools.near/widget/NDC.Modal\",\n  verifyHuman: \"nomination.ndctools.near/widget/NDC.VerifyHuman\",\n};\n\nconst H4 = styled.h4`\n  margin-bottom: 0;\n`;\n\nconst H3 = styled.h3`\n  margin-bottom: 0;\n`;\n\nconst Container = styled.div`\n  position: relative:\n  font-family: Avenir;\n  font-size: 16px;\n`;\n\nconst StyledLink = styled.a`\n  color: inherit !important;\n  width: 90px;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 14px;\n  padding-top: 2px;\n`;\n\nconst CandidateItem = styled.div`\n  padding: 0 20px;\n  height: 48px;\n  border-radius: 12px;\n  margin-bottom: 8px;\n  border: 1px solid;\n  background: ${(props) =>\n    props.winnerId\n      ? \"#239F28\"\n      : props.selected\n      ? \"linear-gradient(90deg, #9333EA 0%, #4F46E5 100%)\"\n      : \"#F8F8F9\"};\n  border-color: ${(props) =>\n    props.selected ? \"#4F46E5\" : props.winnerId ? \"#239F28\" : \"#F8F8F9\"};\n  color: ${(props) => (props.selected || props.winnerId ? \"white\" : \"inherit\")};\n\n  &:hover {\n    cursor: pointer;\n    background: ${(props) =>\n      props.selected\n        ? \"linear-gradient(90deg, #9333EA 0%, #4F46E5 100%)\"\n        : props.winnerId\n        ? \"#239F28\"\n        : \"linear-gradient(90deg, rgba(147, 51, 234, 0.08) 0%, rgba(79, 70, 229, 0.08) 100%)\"};\n  }\n`;\n\nconst Bookmark = styled.div`\n  width: 100px;\n\n  #bookmark.bi-bookmark-fill {\n    color: ${(props) =>\n      props.selected || props.winnerId ? \"#fff\" : \"#4F46E5\"};\n  }\n`;\n\nconst Votes = styled.div`\n  width: 90px;\n  margin-left: 20px;\n  text-align: center;\n`;\n\nconst Action = styled.div`\n  width: 90px;\n  min-width: 20px;\n  margin-left: 20px;\n  text-align: center;\n`;\n\nconst Nomination = styled.div`\n  width: 102px;\n`;\n\nconst FilterRow = styled.div`\n  padding: 15px 20px;\n`;\n\nconst Info = styled.i`\n  font-size: 12px;\n  margin: 0 !important;\n`;\n\nconst CandidatesContainer = styled.div`\n  overflow-y: scroll;\n  max-height: 490px;\n  width: 100%;\n`;\n\nconst StickyContainer = styled.div`\n  position: \"fixed\",\n  left: 0;\n  bottom: 0;\n  height: 60px;\n  width: 100%;\n`;\n\nconst Icon = styled.i`\n  font-size: 14px;\n`;\n\nconst CastVotesSection = styled.div`\n  background: #fdfeff;\n  box-shadow: 0px 0px 30px rgba(0, 0, 0, 0.2);\n  border-radius: 8px;\n  padding: 16px;\n\n  h3,\n  h4 {\n    margin: 0 3px;\n  }\n\n  h3 {\n    font-weight: 900;\n  }\n\n  .text-secondary {\n    margin: 0 10px;\n  }\n\n  &.not-verified {\n    h4 {\n      font-size: 16px;\n      margin: 0 0 5px 0;\n      font-weight: 600;\n    }\n\n    h5 {\n      margin: 0;\n      font-size: 12px;\n    }\n  }\n`;\n\nconst Winner = styled.i`\n  margin-left: 10px;\n  font-size: 14px;\n`;\n\nconst Section = styled.div`\n  gap: 8px;\n  margin-bottom: 10px;\n`;\n\nconst currentUser = context.accountId;\nconst housesMapping = {\n  CouncilOfAdvisors: \"Council Of Advisors\",\n  HouseOfMerit: \"House of Merit\",\n  TransparencyCommission: \"Transparency Commission\",\n};\n\nconst alreadyVoted = (candidateId) =>\n  myVotes.some((voter) => voter.candidate === candidateId);\n\nconst filteredCandidates = () => {\n  let candidates = result.filter(([candidate, _vote], _index) =>\n    candidate.toLowerCase().includes(candidateId.toLowerCase())\n  );\n\n  if (state.filter.bookmark !== null)\n    candidates = state.filter.bookmark\n      ? state.candidates.filter(([candidateId, _votes], _index) =>\n          state.bookmarked.includes(candidateId)\n        )\n      : result;\n  if (state.filter.votes !== null)\n    candidates = candidates.sort((a, b) =>\n      state.filter.votes ? a[1] - b[1] : b[1] - a[1]\n    );\n  if (state.filter.my_votes !== null)\n    candidates = state.filter.my_votes\n      ? state.candidates.filter(([candidateId, _votes], _index) =>\n          alreadyVoted(candidateId)\n        )\n      : result;\n\n  return candidates;\n};\n\nconst handleSelectCandidate = (candidateId) => {\n  const selectedItems = state.selectedCandidates.includes(candidateId)\n    ? state.selectedCandidates.filter((el) => el !== candidateId)\n    : [...state.selectedCandidates, candidateId];\n\n  const currentVotes = seats - myVotesForHouse().length - selectedItems.length;\n  if (currentVotes < 0) return;\n\n  State.update({\n    selectedCandidates: selectedItems,\n    availableVotes: currentVotes,\n  });\n};\n\nconst selectedBookmarks = (candidateId) => {\n  let selectedItems = state.bookmarked.includes(candidateId)\n    ? state.bookmarked.filter((el) => el !== candidateId)\n    : [...state.bookmarked, candidateId];\n\n  return [...new Set(selectedItems)];\n};\n\nconst handleBookmarkCandidate = (candidateId) => {\n  let selectedItems = selectedBookmarks(candidateId);\n  State.update({ loading: candidateId });\n\n  Social.set(\n    {\n      index: {\n        [currentUser]: JSON.stringify({\n          key: `${ndcOrganization}/${typ}`,\n          value: selectedBookmarks(candidateId),\n        }),\n      },\n    },\n    {\n      force: true,\n      onCommit: () => {\n        if (selectedItems.length === 0)\n          State.update({ selectedCandidates: result });\n        State.update({ bookmarked: selectedItems, loading: false });\n      },\n      onCancel: () => State.update({ loading: false }),\n    }\n  );\n};\n\nconst handleVote = () =>\n  Near.call(\n    electionContract,\n    \"vote\",\n    { prop_id: id, vote: state.selectedCandidates },\n    \"70000000000000\",\n    2000000000000000000000\n  ).then((data) => State.update({ bountyProgramModal: false }));\n\nconst handleAcceptToS = () => {\n  State.update({ loading: true });\n\n  Social.set(\n    {\n      index: {\n        [currentUser]: JSON.stringify({\n          key: \"ndc_election_tos\",\n          value: true,\n        }),\n      },\n    },\n    {\n      force: true,\n      onCommit: () =>\n        State.update({\n          showToSModal: false,\n          bountyProgramModal: true,\n          loading: false,\n        }),\n      onCancel: () =>\n        State.update({\n          loading: false,\n        }),\n    }\n  );\n};\n\nconst filterBy = (option) => {\n  let filter = { bookmark: false, my_votes: false };\n\n  if (option.bookmark) filter = { bookmark: !state.filter.bookmark };\n  if (option.votes) filter = { votes: !state.filter.votes };\n  if (option.my_votes) filter = { my_votes: !state.filter.my_votes };\n\n  State.update({ filter });\n};\n\nconst loadInitData = () => {\n  State.update({ candidates: filteredCandidates() });\n};\n\nconst loadSocialDBData = () => {\n  let _bookmarked = Social.index(currentUser, `${ndcOrganization}/${typ}`);\n  let _tosAccepted = Social.index(currentUser, \"ndc_election_tos\");\n\n  State.update({\n    bookmarked:\n      _bookmarked && _bookmarked[_bookmarked.length - 1]\n        ? _bookmarked[_bookmarked.length - 1].value\n        : [],\n    tosAgreement:\n      _tosAccepted && _tosAccepted[_tosAccepted.length - 1]\n        ? _tosAccepted[_tosAccepted.length - 1].value\n        : false,\n  });\n};\n\nconst myVotesForHouse = () => myVotes.filter((vote) => vote.house === typ);\n\nState.init({\n  start: true,\n  loading: false,\n  availableVotes: seats - myVotesForHouse().length,\n  selected: null,\n  bookmarked: [],\n  tosAgreement: false,\n  selectedCandidates: [],\n  voters: [],\n  candidates: result,\n  filter: {\n    bookmark: null,\n    candidate: null,\n    votes: null,\n    my_votes: null,\n  },\n  showToSModal: false,\n  bountyProgramModal: false,\n});\n\nloadInitData();\nloadSocialDBData();\n\nconst UserLink = ({ title, src }) => (\n  <>\n    <StyledLink href={src} target=\"_blank\">\n      {title}\n    </StyledLink>\n    <div>\n      <Icon className=\"bi bi-arrow-up-right\" />\n    </div>\n  </>\n);\n\nconst Loader = () => (\n  <span\n    className=\"spinner-grow spinner-grow-sm me-1\"\n    role=\"status\"\n    aria-hidden=\"true\"\n  />\n);\n\nconst CandidateList = ({ candidateId, votes }) => (\n  <div>\n    <CandidateItem\n      className=\"d-flex align-items-center justify-content-between\"\n      onClick={(e) => {\n        if (\n          ![\"input\", \"bookmark\", \"link\"].includes(e.target.id) &&\n          !e.target.href\n        )\n          State.update({\n            selected: state.selected === candidateId ? null : candidateId,\n          });\n      }}\n      selected={state.selected === candidateId}\n      winnerId={winnerIds.includes(candidateId)}\n    >\n      <div className=\"d-flex\">\n        {isIAmHuman && (\n          <Bookmark\n            selected={state.selected === candidateId}\n            winnerId={winnerIds.includes(candidateId)}\n          >\n            {state.loading === candidateId ? (\n              <Loader />\n            ) : (\n              <i\n                id=\"bookmark\"\n                onClick={() => handleBookmarkCandidate(candidateId)}\n                className={`bi ${\n                  state.bookmarked.includes(candidateId)\n                    ? \"bi-bookmark-fill\"\n                    : \"bi-bookmark\"\n                }`}\n              />\n            )}\n          </Bookmark>\n        )}\n        <div className=\"d-flex\">\n          <Widget\n            src=\"mob.near/widget/ProfileImage\"\n            props={{\n              accountId: candidateId,\n              imageClassName: \"rounded-circle w-100 h-100\",\n              style: { width: \"24px\", height: \"24px\", marginRight: 4 },\n            }}\n          />\n          <UserLink\n            src={`https://www.near.org/near/widget/ProfilePage?accountId=${candidateId}`}\n            title={candidateId}\n          />\n          {winnerIds.includes(candidateId) && (\n            <Winner className=\"bi bi-trophy p-1\" />\n          )}\n        </div>\n      </div>\n      <div className=\"d-flex\">\n        <Widget\n          src={widgets.styledComponents}\n          props={{\n            Link: {\n              size: \"sm\",\n              className: \"secondary dark\",\n              text: \"Nomination\",\n              icon: <i id=\"link\" className=\"bi bi-arrow-up-right\" />,\n              href: ref_link,\n              inverse: state.selected === candidateId,\n            },\n          }}\n        />\n        <Votes>{votes}</Votes>\n        {isIAmHuman && (\n          <Votes>\n            <input\n              id=\"input\"\n              disabled={alreadyVoted(candidateId)}\n              onClick={() => handleSelectCandidate(candidateId)}\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              checked={\n                state.selectedCandidates.includes(candidateId) ||\n                alreadyVoted(candidateId)\n              }\n            />\n          </Votes>\n        )}\n      </div>\n    </CandidateItem>\n    {state.selected === candidateId && (\n      <Widget src={widgets.voters} props={{ candidateId }} />\n    )}\n  </div>\n);\n\nconst Filters = () => (\n  <FilterRow className=\"d-flex align-items-center justify-content-between\">\n    <div className=\"d-flex\">\n      {isIAmHuman && (\n        <Bookmark\n          role=\"button\"\n          className=\"text-secondary\"\n          onClick={() => filterBy({ bookmark: true })}\n        >\n          <small>Bookmark</small>\n          <i className=\"bi bi-funnel\" />\n        </Bookmark>\n      )}\n      <div className=\"text-secondary\">\n        <small>Candidate</small>\n      </div>\n    </div>\n    <div className=\"d-flex\">\n      <Nomination className=\"text-secondary text-end text-md-start\">\n        <small>Nomination</small>\n      </Nomination>\n      <Votes\n        role=\"button\"\n        className=\"text-secondary\"\n        onClick={() => filterBy({ votes: true })}\n      >\n        <small>Total votes</small>\n        <i\n          className={`bi ${\n            state.filter.votes ? \"bi-arrow-down\" : \"bi-arrow-up\"\n          }`}\n        />\n      </Votes>\n      {isIAmHuman && (\n        <Action\n          role=\"button\"\n          className=\"text-secondary\"\n          onClick={() => filterBy({ my_votes: true })}\n        >\n          <small>My votes</small>\n          <i className=\"bi bi-funnel\" />\n        </Action>\n      )}\n    </div>\n  </FilterRow>\n);\n\nconst CastVotes = () => (\n  <CastVotesSection className=\"d-flex align-items-center justify-content-between\">\n    <div>\n      <div className=\"d-flex align-items-end\">\n        <H3>\n          {seats - myVotesForHouse().length - state.selectedCandidates.length}\n        </H3>\n        <span>/</span>\n        <H4>{seats}</H4>\n        <span className=\"text-secondary\">votes left</span>\n        {state.selectedCandidates.length > 0 && (\n          <Widget\n            src={widgets.styledComponents}\n            props={{\n              Button: {\n                size: \"sm\",\n                className: \"secondary\",\n                text: \"Reset Selection\",\n                onClick: () =>\n                  State.update({\n                    selectedCandidates: [],\n                    availableVotes: seats - myVotesForHouse().length,\n                  }),\n              },\n            }}\n          />\n        )}\n      </div>\n      <Info className=\"text-secondary\">\n        <i class=\"bi bi-info-circle\"></i>\n        Make sure you selected all {seats} candidates\n      </Info>\n    </div>\n    <Widget\n      src={widgets.styledComponents}\n      props={{\n        Button: {\n          // disabled: state.selectedCandidates.length === 0,\n          text: `Cast ${state.selectedCandidates.length || \"\"} Votes`,\n          onClick: () =>\n            state.tosAgreement\n              ? handleVote()\n              : State.update({ showToSModal: true }),\n        },\n      }}\n    />\n  </CastVotesSection>\n);\n\nconst ALink = ({ title, href }) => (\n  <a href={href} target={\"_blank\"} rel={\"noopener\"}>\n    {title}\n  </a>\n);\n\nreturn (\n  <>\n    {state.showToSModal && (\n      <Widget\n        src={widgets.modal}\n        props={{\n          title: (\n            <div>\n              <img src=\"https://bafkreidmuyeawyqduaotd27jozw5czdrm7t7w5hlcx5nfjzjjxxzvyhkyi.ipfs.nftstorage.link/\" />\n              <div className=\"mt-4\">\n                Before you vote, please review the Fair Voting Policy.\n              </div>\n            </div>\n          ),\n          description: (\n            <>\n              Please make sure to read and understand the{\" \"}\n              <ALink\n                title=\"Fair Voting Policy.\"\n                href=\"https://bafkreieiqabf6k675f3doqdztej53qmiybmhiaqgjaqmj673wbxxq5muke.ipfs.nftstorage.link/\"\n              />\n              which outlines the responsibilities of each voter.\n            </>\n          ),\n          content: (\n            <Section className=\"d-flex justify-content-center w-100 my-4\">\n              <input\n                type=\"checkbox\"\n                className=\"form-check-input\"\n                checked={state.tosAgreement}\n                onClick={() =>\n                  State.update({ tosAgreement: !state.tosAgreement })\n                }\n              />\n              I agree with{\" \"}\n              <ALink\n                title=\"Fair Voting Policy.\"\n                href=\"https://bafkreieiqabf6k675f3doqdztej53qmiybmhiaqgjaqmj673wbxxq5muke.ipfs.nftstorage.link/\"\n              />\n            </Section>\n          ),\n          Button: {\n            title: state.loading ? (\n              <Loader />\n            ) : (\n              <>Agree to Fair Voting Policy</>\n            ),\n            disabled: !state.tosAgreement,\n            onCancel: () =>\n              State.update({ showToSModal: false, tosAgreement: false }),\n            onSubmit: handleAcceptToS,\n          },\n        }}\n      />\n    )}\n    {state.bountyProgramModal && (\n      <Widget\n        src={widgets.modal}\n        props={{\n          title: (\n            <div>\n              <img src=\"https://bafkreidmuyeawyqduaotd27jozw5czdrm7t7w5hlcx5nfjzjjxxzvyhkyi.ipfs.nftstorage.link/\" />\n              <div className=\"mt-4\">You are about to cast your votes.</div>\n            </div>\n          ),\n          description: (\n            <>\n              <p>\n                Do you know about the{\" \"}\n                <ALink\n                  title=\"Whistleblower Bounty Program\"\n                  href=\"https://www.notion.so/NDC-Whistleblower-Program-and-Bounty-Framework-for-the-Election-b91e8d34a8cb4f17a6b9a9a7e7b5fa5c\"\n                />\n                ? The Whistleblower Bounty Program offers up to 2,000 NEAR for\n                whistleblowers who come forward to share instances of vote\n                buying, account buying, election fraud, and other violations of\n                the{\" \"}\n                <ALink\n                  title=\"Fair Voting Policy\"\n                  href=\"https://bafkreieiqabf6k675f3doqdztej53qmiybmhiaqgjaqmj673wbxxq5muke.ipfs.nftstorage.link/\"\n                />\n                .\n              </p>\n              <p>\n                You will be bonding xN during the election period. This bond\n                will be returned to you after the election results are reviewed\n                and validated.\n              </p>\n              <p>\n                Make sure you vote for all the seats in this house. You can only\n                vote once and past votes cannot be changed.\n              </p>\n            </>\n          ),\n          content: (\n            <Section className=\"d-flex d-flex justify-content-center w-100 my-4\">\n              I understand the{\" \"}\n              <ALink\n                title=\"Whistleblower Bounty Program\"\n                href=\"https://www.notion.so/NDC-Whistleblower-Program-and-Bounty-Framework-for-the-Election-b91e8d34a8cb4f17a6b9a9a7e7b5fa5c\"\n              />\n              .\n            </Section>\n          ),\n          Button: {\n            title: \"Cast Votes\",\n            onCancel: () => State.update({ bountyProgramModal: false }),\n            onSubmit: handleVote,\n          },\n        }}\n      />\n    )}\n\n    <Container>\n      <h1>{housesMapping[typ]}</h1>\n      {state.candidates.length > 0 ? (\n        <>\n          <Filters />\n          <CandidatesContainer>\n            {state.candidates.map(([candidateId, votes], index) => (\n              <CandidateList\n                candidateId={candidateId}\n                votes={votes}\n                key={index}\n              />\n            ))}\n          </CandidatesContainer>\n        </>\n      ) : (\n        <div className=\"d-flex p-5 justify-content-center\">\n          There are no candidates found\n        </div>\n      )}\n      <div>\n        {isIAmHuman ? (\n          <CastVotes />\n        ) : (\n          <Widget\n            src={widgets.verifyHuman}\n            props={{\n              title: \"Want to vote?\",\n              description: \"Click on Verify as a Human to proceed.\",\n            }}\n          />\n        )}\n      </div>\n    </Container>\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/election.ndctools.near/widget/NDC.Elections.Candidates", "fact_widget_deployments_id": "e42fb6bc25db6aadf7c40bcfc7fb9b4c", "inserted_timestamp": "2023-08-06T16:23:40.404Z", "modified_timestamp": "2023-08-06T16:23:40.404Z", "__row_index": 397}