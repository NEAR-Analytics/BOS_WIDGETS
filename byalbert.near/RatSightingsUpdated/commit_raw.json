{"tx_hash": "3kty6duoQak9X5o6h3qzs98K76oC8pkeqmRkLhCqHLmE", "action_id_social": "9FeURomGFMAvp74jkHiXKBdoxeyi4SzgJhfR3CABbAPK-0-widget", "block_id": 104578866, "block_timestamp": "2023-10-31T01:38:19.582Z", "signer_id": "byalbert.near", "widget_name": "RatSightingsUpdated", "source_code": "const dataTemp = fetch(\"https://data.cityofnewyork.us/resource/3q43-55fe.json\");\nconst resultData = dataTemp?.body;\n\nconst dataDic = {};\nresultData.forEach((item) => {\n  const obj = {\n    address: item.incident_address,\n    status: item.status,\n    id: item.unique_key,\n    lng: item.longitude,\n    lat: item.latitude,\n    descriptor: item.descriptor,\n    incident_zip: item.incident_zip,\n    x_coordinate_state_plane_: item.x_coordinate_state_plane_,\n    created_date: item.created_date,\n    city: item.city,\n    intersection_street_1: item.intersection_street_1,\n    landmark: item.landmark,\n    y_coordinate_state_plane_: item.y_coordinate_state_plane_,\n    agency_name: item.agency_name,\n    location_type: item.location_type,\n    cross_street_1: item.cross_street_1,\n    community_board: item.community_board,\n    agency: item.agency,\n    park_borough: item.park_borough,\n    borough: item.borough,\n    street_name: item.street_name,\n    complaint_type: item.complaint_type,\n    address_type: item.address_type,\n    intersection_street_2: item.intersection_street_2,\n  };\n  if (!dataDic[item.unique_key]) {\n    dataDic[item.unique_key] = obj;\n    dataDic[item.unique_key].count = 1;\n  } else {\n    dataDic[item.unique_key].count++;\n  }\n});\nconst cleanData = Object.values(dataDic);\n\nconst markers = Social.get(`*/thing/reviewMarker`, \"final\", {\n  subscribe: \"true\",\n});\n\nif (!markers) {\n  return <></>;\n}\nconst dataMap = {};\nObject.keys(markers).forEach((accountId) => {\n  if (markers[accountId].thing && markers[accountId].thing.reviewMarker) {\n    const markerObj = JSON.parse(markers[accountId].thing.reviewMarker);\n    dataMap[accountId] = { accountId, ...markerObj };\n  }\n});\n\nState.init({\n  variant: \"\",\n  title: \"\",\n  open: false,\n  isShowMore: false,\n  img: \"\",\n  locations: [],\n  description: \"\",\n  edit: false,\n  currentLocation: (dataMap[accountId] && dataMap[accountId].coordinates) || {},\n});\n\nconst handleSave = () => {\n  const data = {\n    post: {\n      main: JSON.stringify({\n        description: state.description,\n        img: state.img,\n        id: state.currentLocation.id,\n      }),\n    },\n    index: {\n      post: JSON.stringify({\n        key: state.currentLocation.id,\n        value: {\n          type: \"md\",\n        },\n      }),\n    },\n  };\n\n  Social.set(data, {\n    force: true,\n    onCommit: () => {\n      State.update({\n        edit: false,\n        showForm: false,\n        showInspect: false,\n        open: true,\n        variant: \"success\",\n        title: \"Success!\",\n        description: \"Your review has been successfully save to the contract.\",\n      });\n    },\n    onCancel: () =>\n      State.update({\n        edit: false,\n        showForm: false,\n        showInspect: false,\n        variant: error,\n        open: true,\n        title: \"Failed!\",\n        description:\n          \"We could not  save your review, please try one more time.\",\n      }),\n  });\n};\n\n// IMAGEUPLOADER\nconst uploadFileUpdateState = (body) => {\n  asyncFetch(\"https://ipfs.near.social/add\", {\n    method: \"POST\",\n    headers: { Accept: \"application/json\" },\n    body,\n  }).then((res) => {\n    const cid = res.body.cid;\n    State.update({ img: { cid } });\n  });\n};\nconst filesOnChange = (files) => {\n  if (files) {\n    State.update({ img: { uploading: true, cid: null } });\n    uploadFileUpdateState(files[0]);\n  }\n};\n\nfunction Inspect(p) {\n  const { Feed } = VM.require(\"devs.near/widget/Module.Feed\");\n  Feed = Feed || (() => <></>); // make sure you have this or else it can break\n\n  return (\n    <div\n      style={{\n        backgroundColor: \"white\",\n        padding: \"1rem\",\n        height: \"750px\",\n        overflowY: \"scroll\",\n        paddingBottom: \"5rem\",\n      }}\n    >\n      <h2>\n        {p.address}, {p.city} , {p.incident_zip}\n      </h2>\n\n      <p style={{ fontSize: \"14px\" }}>\n        <strong> Incident issue:</strong>\n        {p.descriptor}\n      </p>\n      <p style={{ fontSize: \"14px\" }}>\n        <strong> Incident status:</strong>\n        {p.status}\n      </p>\n\n      <p style={{ paddingTop: \"6px\", fontSize: \"14px\" }}>\n        <strong> Near to:</strong>\n        {p.cross_street_2} {p.intersection_street_1}\n      </p>\n      <p style={{ paddingTop: \"6px\", fontSize: \"14px\" }}>\n        <strong> Created date:</strong>\n        {p.created_date}\n      </p>\n      <p style={{ paddingTop: \"6px\", fontSize: \"14px\" }}>\n        <strong>Complaint type:</strong>\n        {p.complaint_type}\n      </p>\n\n      <pre\n        style={{ color: \"white\" }}\n        onClick={() => {\n          State.update({ isShowMore: false });\n        }}\n      >\n        {state.isShowMore ? (\n          <button style={buttonBlueStyle}>See less</button>\n        ) : (\n          \"\"\n        )}\n      </pre>\n      <pre\n        style={{ backgroundColor: \"black\", color: \"white\" }}\n        onClick={() => {\n          State.update({ isShowMore: true });\n        }}\n      >\n        {state.isShowMore ? JSON.stringify(p, null, 2) : \"Show all\"}{\" \"}\n      </pre>\n\n      <h2 style={{ fontSize: \"25px\", fontWeight: \"bold\" }}>Reviews</h2>\n      <Feed\n        index={{\n          action: \"post\",\n          key: state.currentLocation.id,\n          options: {\n            limit: 10,\n            order: \"desc\",\n            accountId: undefined,\n          },\n        }}\n        Item={(p) => {\n          const id = state.currentLocation.id;\n          return <Widget src=\"byalbert.near/widget/card\" props={p} />;\n        }}\n      />\n    </div>\n  );\n}\n\nfunction Form() {\n  const buttonBlueStyle = {\n    backgroundColor: \"blue\",\n    color: \"white\",\n    padding: \"10px 20px\",\n    border: \"none\",\n    borderRadius: \"5px\",\n    cursor: \"pointer\",\n  };\n  const formContainerStyle = {\n    display: \"flex\",\n    flexDirection: \"column\",\n    alignItems: \"center\",\n  };\n  const descriptionTextareaStyle = {\n    width: \"100%\",\n    height: \"100px\", // Adjust the height as needed\n    padding: \"10px\",\n    margin: \"10px 0\",\n    border: \"1px solid #ccc\",\n    borderRadius: \"5px\",\n  };\n\n  const formTitleStyle = {\n    fontSize: \"24px\",\n    paddingTop: \"1rem\",\n  };\n\n  const descriptionInputStyle = {\n    width: \"100%\",\n    padding: \"10px\",\n    margin: \"10px 0\",\n    border: \"1px solid #ccc\",\n    borderRadius: \"5px\",\n  };\n\n  const saveButtonStyle = {\n    background: \"#007bff\",\n    color: \"white\",\n    border: \"none\",\n    padding: \"10px 20px\",\n    borderRadius: \"5px\",\n    cursor: \"pointer\",\n  };\n\n  return (\n    <div style={{ backgroundColor: \"white\", padding: \"1rem\" }}>\n      <h1 style={formTitleStyle}>Submit Ticket</h1>\n      <div className=\"d-inline-block\">\n        {state.img ? (\n          <img\n            class=\"rounded w-100 h-100\"\n            style={{ objectFit: \"cover\" }}\n            src={`https://ipfs.near.social/ipfs/${state.img.cid}`}\n            alt=\"upload preview\"\n          />\n        ) : (\n          \"\"\n        )}\n        <Files\n          multiple={false}\n          accepts={[\"image/*\"]}\n          minFileSize={1}\n          clickable\n          className=\"btn btn-outline-primary\"\n          onChange={filesOnChange}\n        >\n          {state.img?.uploading ? <> Uploading </> : \"Upload an Image\"}\n        </Files>\n      </div>\n\n      <textarea\n        style={descriptionTextareaStyle}\n        placeholder=\"Enter description\"\n        value={description}\n        onChange={(e) => State.update({ description: e.target.value })}\n      ></textarea>\n      <button style={saveButtonStyle} onClick={handleSave}>\n        Save\n      </button>\n    </div>\n  );\n}\n\nconst toggleClosed = () => {\n  State.update({ open: false, img: \"\", description: \"\" });\n};\nreturn (\n  <div>\n    <Widget\n      src=\"byalbert.near/widget/Map.index\"\n      props={{\n        markerAsset:\n          \"https://creazilla-store.fra1.digitaloceanspaces.com/emojis/57992/rat-emoji-clipart-md.png\",\n        reviewData: reviews,\n        markers: cleanData,\n        myMarkers: myData,\n        onMapClick: (e) => console.log(\"map click\", e),\n        onMarkerClick: (e) => {\n          // onclick pass address & query supabase, return everything from reports  where  address = passedAddress\n          // get the data and display using reviews widget\n          State.update({\n            currentLocation: e,\n          });\n        },\n        inspect: (p) => <Inspect {...p} />,\n        form: (p) => <Form {...p} />,\n      }}\n    />\n\n    <Widget\n      src=\"byalbert.near/widget/toast\"\n      props={{\n        variant: state.variant,\n        open: state.open,\n        toggleClosed,\n        title: state.title,\n        description: state.description,\n      }}\n    />\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/byalbert.near/widget/RatSightingsUpdated", "fact_widget_deployments_id": "399e3d900c7d72f52d9713faa6aeb08f", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}