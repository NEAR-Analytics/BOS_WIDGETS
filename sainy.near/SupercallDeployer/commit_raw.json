{"tx_hash": "5fM2zEwLzpA27TYwPMjAm3TEEw1jffSzX2eaVDahAG4Z", "action_id_social": "Hxvoegwj5d6MKfwpuiJBSKqv99y2qRRowGH4Q7b6jxJE-0-widget", "block_id": 108257013, "block_timestamp": "2023-12-18T14:32:23.006Z", "signer_id": "sainy.near", "widget_name": "SupercallDeployer", "source_code": "State.init({\n  accountNumber: props.accountNumber,\n  contractAddress: \"\",\n  isDeployed: false,\n  isFetched: false,\n  isSupportedChain: true,\n  multicallAddr: \"0xEa5363305017B2A6fD0d72Ba830513c678a2f1fE\",\n  create2DeployerAddr: \"0x2DA1A7AaB838960a49AC0D62480aD3412b2E8B5B\",\n});\n\n// Data sources\nconst CREATE2DEPLOYER_ABI_URL =\n  \"https://raw.githubusercontent.com/SainyTK/contract-list/main/abis/Create2Deployer.json\";\nconst CREATE2DEPLOYER_ABI = fetch(CREATE2DEPLOYER_ABI_URL).body;\n\nconst OWNABLE_PROXY_ABI_URL =\n  \"https://raw.githubusercontent.com/SainyTK/contract-list/main/abis/OwnableProxy.json\";\nconst OWNABLE_PROXY_ABI = fetch(OWNABLE_PROXY_ABI_URL).body;\n\nconst OWNABLE_PROXY_BYTECODE_URL =\n  \"https://raw.githubusercontent.com/SainyTK/contract-list/main/bytecodes/OwnableProxy.txt\";\nconst OWNABLE_PROXY_BYTECODE = fetch(OWNABLE_PROXY_BYTECODE_URL).body;\n\n// Preparation\nconst signer = Ethers.send(\"eth_requestAccounts\", [])[0];\n\n// Functions\nfunction getSalt(input) {\n  const utf8BytesValue = ethers.utils.toUtf8Bytes(input);\n  return ethers.utils.keccak256(utf8BytesValue);\n}\n\nfunction getCodeData(abi, bytecode, args) {\n  const iface = new ethers.utils.Interface(abi);\n  bytecode = bytecode.startsWith(\"0x\") ? bytecode : \"0x\" + bytecode;\n  return ethers.utils.concat([bytecode, iface.encodeDeploy(args)]);\n}\n\nfunction getCodeHash(abi, bytecode, args) {\n  const data = getCodeData(abi, bytecode, args);\n  return ethers.utils.keccak256(data);\n}\n\nfunction checkIsContract(address) {\n  try {\n    const code = Ethers.send(\"eth_getCode\", [address]);\n    const isContract = code !== undefined && code !== null && code !== \"0x\";\n    return isContract;\n  } catch (error) {}\n}\n\nfunction checkContractAddress() {\n  try {\n    const computedSalt = getSalt(props.accountNumber || \"0\");\n    const codeHash = getCodeHash(OWNABLE_PROXY_ABI, OWNABLE_PROXY_BYTECODE, [\n      state.multicallAddr,\n      signer,\n    ]);\n    const create2Deployer = new ethers.Contract(\n      state.create2DeployerAddr,\n      CREATE2DEPLOYER_ABI,\n      Ethers.provider().getSigner()\n    );\n    create2Deployer.computeAddress(computedSalt, codeHash).then((address) => {\n      const isContract = checkIsContract(address);\n      State.update({\n        accountNumber: props.accountNumber || \"0\",\n        contractAddress: address,\n        isDeployed: isContract,\n        isFetched: true,\n        isError: false,\n      });\n      Storage.set(`contractAddress:${props.accountNumber || \"0\"}`, address);\n      Storage.set(`isDeployed:${props.accountNumber || \"0\"}`, isContract);\n    });\n  } catch (e) {\n    State.update({ isError: true, error: \"Check address error\" });\n  }\n}\n\nfunction deploySuperCall() {\n  const create2Deployer = new ethers.Contract(\n    state.create2DeployerAddr,\n    CREATE2DEPLOYER_ABI,\n    Ethers.provider().getSigner()\n  );\n  const computedSalt = getSalt(props.accountNumber);\n  const codeData = getCodeData(OWNABLE_PROXY_ABI, OWNABLE_PROXY_BYTECODE, [\n    state.multicallAddr,\n    signer,\n  ]);\n  create2Deployer.deploy(0, computedSalt, codeData);\n}\n\nif (ethers && signer) {\n  Ethers.provider()\n    .getNetwork()\n    .then((chainIdData) => {\n      if (chainIdData?.chainId) {\n        const supportedChainsCreate2Deployer = fetch(\n          `https://raw.githubusercontent.com/SainyTK/contract-list/main/addresses/create2Deployer/supported-chains.json`\n        );\n        const supportedChainsMulticall = fetch(\n          `https://raw.githubusercontent.com/SainyTK/contract-list/main/addresses/multicall/supported-chains.json`\n        );\n        if (\n          !supportedChainsCreate2Deployer.error &&\n          !supportedChainsMulticall.error\n        ) {\n          const supportedChains1 = JSON.parse(\n            supportedChainsCreate2Deployer.body\n          );\n          const supportedChains2 = JSON.parse(supportedChainsMulticall.body);\n\n          if (\n            [...supportedChains1, ...supportedChains2].includes(\n              chainIdData?.chainId.toString()\n            )\n          ) {\n            const create2DeployerAddr = fetch(\n              `https://raw.githubusercontent.com/SainyTK/contract-list/main/addresses/create2Deployer/${chainIdData?.chainId}.json`\n            );\n            const multicallAddr = fetch(\n              `https://raw.githubusercontent.com/SainyTK/contract-list/main/addresses/multicall/${chainIdData?.chainId}.json`\n            );\n            if (!create2DeployerAddr.error && !multicallAddr.error) {\n              console.log({\n                multicallAddr: JSON.parse(multicallAddr.body).Multicall,\n                create2DeployerAddr: JSON.parse(create2DeployerAddr.body)\n                  .Create2Deployer,\n              });\n              State.update({\n                multicallAddr: JSON.parse(multicallAddr.body).Multicall,\n                create2DeployerAddr: JSON.parse(create2DeployerAddr.body)\n                  .Create2Deployer,\n                isDeployed: true,\n                isFetched: true,\n              });\n            } else {\n              State.update({ isDeployed: true, isFetched: true });\n            }\n          } else {\n            State.update({ isSupportedChain: false });\n          }\n        } else {\n          State.update({ isError: true, error: \"Fetch chains error\" });\n        }\n      }\n    });\n}\n\ncheckContractAddress();\n\nif (!signer) {\n  return (\n    <div>\n      <h3>Please connect your wallet</h3>\n      <Web3Connect />\n    </div>\n  );\n}\n\nif (!state.isSupportedChain) {\n  return <div>This chain is not supported</div>;\n}\n\nif (state.isError) {\n  return <div>{state.error || \"Something went wrong\"}</div>;\n}\n\nreturn (\n  <div>\n    {state.isFetched && !state.isDeployed && (\n      <div>\n        <button className=\"mb-2 bg-blue-400 rounded\" onClick={deploySuperCall}>\n          Create\n        </button>\n      </div>\n    )}\n  </div>\n);\n", "metadata": {"fork_of": "sainy.near/widget/SupercallDeployer@108143595"}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/sainy.near/widget/SupercallDeployer", "fact_widget_deployments_id": "eff30ba31c16e4fb24fa4f3e3904b1f6", "inserted_timestamp": "2023-12-18T16:54:40.747Z", "modified_timestamp": "2023-12-20T03:22:11.422Z", "__row_index": 11}