{"tx_hash": "49AxaTadZjqpJYpoYyVbqu6XtdNSr7xmz3SybDSbnkRD", "action_id_social": "DVowR2URzU9L6eo4VnCTo5Gfs2Qqt4h1J7KPQDcZXiwC-0-widget", "block_id": 108141056, "block_timestamp": "2023-12-17T04:15:20.889Z", "signer_id": "sainy.near", "widget_name": "SupercallDeployer", "source_code": "// Data sources\nconst CREATE2DEPLOYER_ABI_URL =\n  \"https://gist.githubusercontent.com/SainyTK/92a39e1e9b2c15d1d4a0cc48ca699266/raw/ea246a9999580aa4ec03f9cf193f299fb078820d/create2deployer-abi.json\";\nconst CREATE2DEPLOYER_ABI = fetch(CREATE2DEPLOYER_ABI_URL).body;\n\nconst OWNABLE_PROXY_ABI_URL =\n  \"https://gist.githubusercontent.com/SainyTK/cdbc9ba5715f4df12ff1dd05fa75c5af/raw/ec374671ff9b2ce86d3f126e2d85b5b026525f30/ownable-proxy-abi.json\";\nconst OWNABLE_PROXY_ABI = fetch(OWNABLE_PROXY_ABI_URL).body;\n\nconst OWNABLE_PROXY_BYTECODE_URL =\n  \"https://gist.githubusercontent.com/SainyTK/29eb181fd3eabec3460d8aaddcd2d859/raw/5bbc0602250d6b8f72047e363675c3b6028eacbf/ownable-proxy-bytecode.txt\";\nconst OWNABLE_PROXY_BYTECODE = fetch(OWNABLE_PROXY_BYTECODE_URL).body;\n\nconst multicallAddr = \"0xcA11bde05977b3631167028862bE2a173976CA11\";\nconst create2DeployerAddr = \"0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2\";\n\n// Util functions\nfunction _getBytes(value, name, copy) {\n  if (value) {\n    return \"0x\" + value;\n  }\n  if (typeof value === \"string\" && value.match(/^0x([0-9a-f][0-9a-f])*$/i)) {\n    const result = new Uint8Array((value.length - 2) / 2);\n    let offset = 2;\n    for (let i = 0; i < result.length; i++) {\n      result[i] = parseInt(value.substring(offset, offset + 2), 16);\n      offset += 2;\n    }\n    return result;\n  }\n}\n\nfunction getBytes(value, name) {\n  return _getBytes(value, name, false);\n}\n\n// Preparation\nconst signer = Ethers.send(\"eth_requestAccounts\", [])[0];\n\n// Functions\nfunction getSalt(input) {\n  const utf8BytesValue = ethers.utils.toUtf8Bytes(input);\n  return ethers.utils.keccak256(utf8BytesValue);\n}\n\nfunction getCodeData(abi, bytecode, args) {\n  const iface = new ethers.utils.Interface(abi);\n  bytecode = bytecode.startsWith(\"0x\") ? bytecode : \"0x\" + bytecode;\n  return ethers.utils.concat([bytecode, iface.encodeDeploy(args)]);\n}\n\nfunction getCodeHash(abi, bytecode, args) {\n  const data = getCodeData(abi, bytecode, args);\n  return ethers.utils.keccak256(data);\n}\n\nfunction checkIsContract(address) {\n  try {\n    const code = Ethers.send(\"eth_getCode\", [address]);\n    const isContract = code !== undefined && code !== null && code !== \"0x\";\n    return isContract;\n  } catch (error) {}\n}\n\nfunction checkContractAddress() {\n  if (props.accountNumber !== state.accountNumber) {\n    const computedSalt = getSalt(props.accountNumber);\n    const codeHash = getCodeHash(OWNABLE_PROXY_ABI, OWNABLE_PROXY_BYTECODE, [\n      multicallAddr,\n      signer,\n    ]);\n    const create2Deployer = new ethers.Contract(\n      create2DeployerAddr,\n      CREATE2DEPLOYER_ABI,\n      Ethers.provider().getSigner()\n    );\n    create2Deployer.computeAddress(computedSalt, codeHash).then((address) => {\n      const isContract = checkIsContract(address);\n      State.update({\n        accountNumber: props.accountNumber,\n        contractAddress: address,\n        isDeployed: isContract,\n        isFetched: true,\n      });\n      Storage.set(\"contractAddress\", address);\n      Storage.set(\"isDeployed\", isContract);\n    });\n  }\n}\n\nfunction deploySuperCall() {\n  const create2Deployer = new ethers.Contract(\n    create2DeployerAddr,\n    CREATE2DEPLOYER_ABI,\n    Ethers.provider().getSigner()\n  );\n  const computedSalt = getSalt(props.accountNumber);\n  const codeData = getCodeData(OWNABLE_PROXY_ABI, OWNABLE_PROXY_BYTECODE, [\n    multicallAddr,\n    signer,\n  ]);\n\n  create2Deployer.deploy(0, computedSalt, codeData);\n}\n\nif (!signer) {\n  return (\n    <div>\n      <h3>Please connect your wallet</h3>\n      <Web3Connect />\n    </div>\n  );\n}\n\nif (state.chainId === undefined && ethers !== undefined && signer) {\n  Ethers.provider()\n    .getNetwork()\n    .then((chainIdData) => {\n      if (chainIdData?.chainId) {\n        State.update({\n          chainId: chainIdData.chainId,\n          isDeployed: true,\n          isFetched: true,\n        });\n      }\n    });\n}\n\n// Main part\ninitState({\n  accountNumber: props.accountNumber,\n  contractAddress: \"\",\n  isDeployed: false,\n  isFetched: false,\n});\n\ncheckContractAddress();\n\nreturn (\n  <div>\n    {state.isFetched && !state.isDeployed && (\n      <div>\n        <button className=\"mb-2 bg-blue-400 rounded\" onClick={deploySuperCall}>\n          Create\n        </button>\n      </div>\n    )}\n  </div>\n);\n", "metadata": {"fork_of": "sainy.near/widget/SupercallDeployer@108141002"}, "branch": {"draft": null}, "widget_modules_used": null, "widget_url": "https://near.social/#/sainy.near/widget/SupercallDeployer", "fact_widget_deployments_id": "56f85eeef15a211e597e564c1824273d", "inserted_timestamp": "2023-12-17T06:21:45.172Z", "modified_timestamp": "2023-12-20T03:22:11.422Z", "__row_index": 6}