{"tx_hash": "GVWUS2weXGDQ5Tw2t8AZRSRhDHKGo1LRjjwwtrcAjXht", "action_id_social": "HsvZrii3kM19t5tmGWiNW4p5SdVzM28m9KPymfP8z87E-0-widget", "block_id": 101455519, "block_timestamp": "2023-09-19T06:18:28.332Z", "signer_id": "vadim.near", "widget_name": "elections", "source_code": "State.init({\n  accountId: props.accountId,\n  propsAccountId: props.accountId,\n  whitelisted: [],\n  blacklisted: [],\n});\n\nif (state.propsAccountId !== props.accountId) {\n  State.update({ accountId: props.accountId, propsAccountId: props.accountId });\n}\n\nconst blacklisted = fetch(\n  \"https://gist.githubusercontent.com/zavodil/49c5188913cd76b2a20861a4e4e91855/raw/0f7b273a5b259a3a77672500d9cc5317ba0dbccb/blacklisted.txt\"\n);\nif (blacklisted.ok) {\n  State.update({ blacklisted: JSON.parse(blacklisted.body) });\n}\n\nconst whitelisted = fetch(\n  \"https://gist.githubusercontent.com/zavodil/20e4ae896e1f6053e1d66a398e1026c9/raw/0363976f86bb067c142b1d8912ad37e639b876cf/whitelisted.txt\"\n);\nif (whitelisted.ok) {\n  State.update({ whitelisted: JSON.parse(whitelisted.body) });\n}\n\nconst data = fetch(\n  \"https://raw.githubusercontent.com/zavodil/near-nft-owners-list/main/output_election_votes.txt\"\n);\n\nif (data.ok) {\n  let voters = {};\n  Object.values(\n    data.body\n      .split(\"\\n\")\n      .map((line) => line.split(\"|\"))\n      .filter((data) => data.length === 5)\n  ).map((item) => {\n    const account_id = item[0];\n    if (voters[account_id] == undefined) {\n      voters[account_id] = {};\n    }\n    voters[account_id][item[3]] = item[4].toLowerCase();\n  });\n\n  State.update({ voters });\n} else return \"Loading\";\n\nconst countKeys = (obj) => {\n  return Object.keys(obj).reduce((count, key) => {\n    const value = obj[key];\n\n    return count + JSON.parse(value).length;\n  }, 0);\n};\n\nconst candidateFriendsObject = state.accountId\n  ? Social.get(`${state.accountId}/graph/follow/*`, \"final\") ?? {}\n  : {};\nconst candidateFriends = Object.keys(candidateFriendsObject);\n\nconst containsSearchBy = (account_id) => {\n  return !account_id || !state.searchBy || account_id.includes(state.searchBy);\n};\n\nconst svgBlack = (\n  <svg width=\"14px\" height=\"14px\" viewBox=\"0 0 116.8 122.88\">\n    <path\n      fill=\"#000000\"\n      d=\"M18,81.08l-5.78-56.9A4.3,4.3,0,0,1,14.39,20C41.59,2.6,54.66,9.66,66.7,16.16,76.22,21.3,84.92,26,103.75,10a4.45,4.45,0,0,1,6.2.44,4.22,4.22,0,0,1,1,2.42l5.78,56.89a4.23,4.23,0,0,1-1.38,3.57c-21.79,19.84-35,13.16-48.6,6.27C55.74,74,44.35,68.25,25.21,84.12a4.47,4.47,0,0,1-6.21-.5,4.26,4.26,0,0,1-1-2.54Z\"\n    />\n    <path\n      fill=\"#696969\"\n      d=\"M17.89,16.71l9.88,98.6a6.89,6.89,0,1,1-13.71,1.35L4.21,18.38a10.15,10.15,0,1,1,13.68-1.67Z\"\n    />\n  </svg>\n);\n\nconst svgGrey = (\n  <svg width=\"14px\" height=\"14px\" viewBox=\"0 0 116.8 122.88\">\n    <path\n      fill=\"#A9A9A9\"\n      d=\"M18,81.08l-5.78-56.9A4.3,4.3,0,0,1,14.39,20C41.59,2.6,54.66,9.66,66.7,16.16,76.22,21.3,84.92,26,103.75,10a4.45,4.45,0,0,1,6.2.44,4.22,4.22,0,0,1,1,2.42l5.78,56.89a4.23,4.23,0,0,1-1.38,3.57c-21.79,19.84-35,13.16-48.6,6.27C55.74,74,44.35,68.25,25.21,84.12a4.47,4.47,0,0,1-6.21-.5,4.26,4.26,0,0,1-1-2.54Z\"\n    />\n    <path\n      fill=\"#696969\"\n      d=\"M17.89,16.71l9.88,98.6a6.89,6.89,0,1,1-13.71,1.35L4.21,18.38a10.15,10.15,0,1,1,13.68-1.67Z\"\n    />\n  </svg>\n);\n\nconst greyTitle = \"This account wasn't initially on the whitelist\";\nconst blackTitle = \"This account was initially blacklisted\";\n\nconst accounts = Object.keys(state.voters ?? [])\n  .filter((account_id) => containsSearchBy(account_id))\n  .map((account_id) => {\n    return (\n      <div class=\"row align-items-start\">\n        <a\n          onClick={() => {\n            State.update({ accountId: account_id });\n            return false;\n          }}\n          style={{ cursor: \"pointer\" }}\n        >\n          <div\n            class=\"col ps-0 overflow-hidden d-flex\"\n            style={{\n              gap: \"3px\",\n              backgroundColor:\n                account_id !== state.accountId ? \"white\" : \"lightblue\",\n            }}\n          >\n            <div\n              class=\"overflow-hidden\"\n              style={{ maxWidth: \"100vw\" }}\n              title={account_id}\n            >\n              <Widget\n                src=\"mob.near/widget/N.ProfileLine\"\n                props={{\n                  accountId: account_id,\n                  link: false,\n                  hideAccountId: true,\n                  hideImage: false,\n                }}\n              />\n            </div>\n\n            <div class=\"text-secondary text-nowrap\">\n              {state.blacklisted.includes(account_id) && (\n                <span title={blackTitle}>{svgBlack}</span>\n              )}\n              {!state.blacklisted.includes(account_id) &&\n                !state.whitelisted.includes(account_id) && (\n                  <span title={greyTitle}>{svgGrey}</span>\n                )}\n              ({countKeys(state.voters[account_id])})\n            </div>\n          </div>\n        </a>\n      </div>\n    );\n  });\n\nconst followerSVG = (\n  <svg\n    x=\"00px\"\n    y=\"0px\"\n    viewBox=\"0 0 256 256\"\n    enable-background=\"new 0 0 256 256\"\n    width=\"14px\"\n    height=\"14px\"\n  >\n    <g>\n      <g>\n        <path\n          fill=\"#000000\"\n          d=\"M100,20.6c0,0-49,4.5-46.6,58.4c1.4,11.6,9,70.4,47.8,80.2c4.3,0.8,37.2,9.4,55.5-44.1c1.2-3.5,16.1-40.6,2.2-67.4C155.5,41.6,143.5,17.1,100,20.6z\"\n        />\n        <path\n          fill=\"#000000\"\n          d=\"M140.2,173.9c0,0-44.4-6.1-91.1,5.5c-11.2,3.3-38.6,9.6-39,32.7c-0.4,23.1,0,23.7,0,23.7h168C178.2,235.8,139.4,220.7,140.2,173.9z\"\n        />\n        <path fill=\"#000000\" d=\"M160.5,165.5H246v25.1h-85.5V165.5z\" />\n        <path fill=\"#000000\" d=\"M190.5,135.5H216v85.3h-25.5V135.5z\" />\n      </g>\n    </g>\n  </svg>\n);\n\nconst getVotes = (house) => {\n  return (JSON.parse(state.voters[state.accountId][house]) ?? []).map(\n    (account_id) => {\n      currentAccountVotes.push(account_id);\n      return (\n        <div class=\"row align-items-start\">\n          <div class=\"col ps-2 overflow-hidden d-flex\" style={{ gap: \"3px\" }}>\n            <div class=\"overflow-hidden\" style={{ maxWidth: \"100vw\" }}>\n              <Widget\n                src=\"mob.near/widget/N.ProfileLine\"\n                props={{\n                  accountId: account_id,\n                  link: true,\n                  hideAccountId: true,\n                  hideImage: false,\n                }}\n              />\n            </div>\n            <div>\n              {candidateFriends.includes(account_id) ? followerSVG : \"\"}\n            </div>\n          </div>\n        </div>\n      );\n    }\n  );\n};\nconst titles = [\n  \"House of Merit\",\n  \"Council Of Advisors\",\n  \"Transparency Commission\",\n];\n\nconst currentAccountVotes = [];\nconst userSimilarity = [];\nconst votes = Object.keys(state.voters[state.accountId] ?? []).map((house) => {\n  return (\n    <div class=\"col col-4 overflow-hidden\">\n      <h5>{titles[house - 1]}</h5>\n      {getVotes(house)}\n    </div>\n  );\n});\n\nObject.keys(state.voters ?? []).map((accountId) => {\n  const accountVotes = Object.keys(state.voters[accountId]).reduce(\n    (votes, house) => {\n      return [...JSON.parse(state.voters[accountId][house]), ...votes];\n    },\n    []\n  );\n\n  const commonVotes = accountVotes.filter((vote) =>\n    currentAccountVotes.includes(vote)\n  ).length;\n  const accountVotesNumber = accountVotes.length;\n  const currentAccountVotesNumber = currentAccountVotes.length;\n  if (accountId !== state.accountId) {\n    userSimilarity.push({\n      accountId,\n      similarity:\n        commonVotes / Math.max(accountVotesNumber, currentAccountVotesNumber),\n      commonVotes,\n      accountVotesNumber,\n      currentAccountVotesNumber,\n    });\n  }\n});\n\nuserSimilarity = Object.values(\n  userSimilarity.sort((a, b) => b.similarity - a.similarity)\n);\n\nconst userWithSimilarVotes = userSimilarity.slice(0, 30).map((item) => {\n  return (\n    <div class=\"col col-4 ps-2 overflow-hidden d-flex\" style={{ gap: \"3px\" }}>\n      <div class=\"overflow-hidden\" style={{ maxWidth: \"100vw\" }}>\n        <Widget\n          src=\"mob.near/widget/N.ProfileLine\"\n          props={{\n            accountId: item.accountId,\n            link: true,\n            hideAccountId: true,\n            hideImage: false,\n          }}\n        />\n      </div>\n      <div class=\"text-nowrap\">\n        {candidateFriends.includes(item.accountId) ? followerSVG : \"\"}\n        {state.blacklisted.includes(item.accountId) && (\n          <span title={blackTitle}>{svgBlack}</span>\n        )}\n        {!state.blacklisted.includes(item.accountId) &&\n          !state.whitelisted.includes(item.accountId) && (\n            <span title={greyTitle}>{svgGrey}</span>\n          )}\n        <span class=\"text-secondary\">\n          ({item.commonVotes}/{item.accountVotesNumber})\n        </span>\n      </div>\n    </div>\n  );\n});\n\nreturn (\n  <div class=\"container\">\n    <div class=\"row\">\n      <div\n        class=\"col col-3 align-self-start overflow-auto\"\n        style={{ height: \"calc(100vh - 7rem)\" }}\n      >\n        <h4>Users ({Object.keys(state.voters).length})</h4>\n        <div class=\"input-group mb-1\">\n          <input\n            type=\"text\"\n            class=\"form-control\"\n            placeholder=\"Search by NEAR Account ID\"\n            onChange={(e) =>\n              State.update({\n                searchBy: e.target.value,\n              })\n            }\n            value={state.searchBy}\n          />\n\n          <button\n            class=\"btn btn-outline-secondary\"\n            type=\"button\"\n            onClick={() => State.update({ searchBy: \"\" })}\n            title=\"Reset Search\"\n          >\n            X\n          </button>\n        </div>\n\n        {accounts}\n      </div>\n      <div class=\"col col-9 align-self-start text-center\">\n        {!state.accountId && (\n          <h6 class=\"pt-3\">\n            Select a user from the left to view their voting history\n          </h6>\n        )}\n        {state.accountId && (\n          <>\n            <h4 class=\"text-nowrap text-center\">\n              Votes of{\" \"}\n              <Widget\n                src=\"mob.near/widget/N.ProfileLine\"\n                props={{\n                  accountId: state.accountId,\n                  link: true,\n                  hideAccountId: true,\n                  hideImage: false,\n                }}\n              />{\" \"}\n              <Widget\n                src=\"mob.near/widget/FollowButton\"\n                props={{ accountId: state.accountId }}\n              />\n            </h4>\n            <hr />\n\n            <div class=\"row text-start\">\n              {votes.length ? (\n                votes\n              ) : (\n                <h3 class=\"text-center\">Votes not found</h3>\n              )}\n            </div>\n\n            {!!votes.length && (\n              <>\n                <h6 class=\"pt-5\">Users with similar vote sequences:</h6>\n                <div class=\"row text-start\">{userWithSimilarVotes}</div>\n                <div class=\"row text-center text-secondary mt-3\">\n                  <small>\n                    (number of similar votes / number of user votes)\n                  </small>\n                  <small>\n                    Users followed by{\" \"}\n                    <a\n                      href={`/vadim.near/widget/elections?accountId=${state.accountId}`}\n                    >\n                      {state.accountId}\n                    </a>{\" \"}\n                    are marked with {followerSVG}\n                  </small>\n                </div>\n              </>\n            )}\n          </>\n        )}\n      </div>\n    </div>\n\n    <hr />\n    <p>\n      <small>\n        Account marked with {svgGrey} wasn't initially on the whitelist, account\n        marked with {svgBlack} was initially blacklisted\n      </small>\n    </p>\n    <p>\n      <small>\n        Data is retrieved automatically from the NEAR Indexer using Github\n        worker with a slight delay ||{\" \"}\n        <a href=\"/nearukraineguild.near/widget/NDC.Elections.Main?house=1\">\n          Election stats\n        </a>\n      </small>\n    </p>\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/vadim.near/widget/elections", "fact_widget_deployments_id": "6bbb1a9fe4a17e6553df341168f1cc84", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}