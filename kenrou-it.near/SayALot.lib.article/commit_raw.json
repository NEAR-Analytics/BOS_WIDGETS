{"tx_hash": "EPGqbfXh2WraHJyTYuYnBYsxkeTrtvhopuxQ3hQ71nBq", "action_id_social": "GP7yqBkUj8jnue8HkiCnkQsvaHVYdxae3hHza59AR7Y9-0-widget", "block_id": 98446919, "block_timestamp": "2023-08-09T21:13:37.810Z", "signer_id": "kenrou-it.near", "widget_name": "SayALot.lib.article", "source_code": "const { isTest, stateUpdate, libCalls } = props;\r\n\r\nconst prodAction = \"sayALotArticle\";\r\nconst testAction = `test_${prodAction}`;\r\nconst action = isTest ? testAction : prodAction;\r\n\r\n// const initLibCalls = [\r\n//   {\r\n//     functionName: \"get1\",\r\n//     key: \"test\",\r\n//     props: {},\r\n//   },\r\n//   {\r\n//     functionName: \"getWritersWhitelist\",\r\n//     key: \"writersWhitelist\",\r\n//     props: { env: \"test\" },\r\n//   },\r\n// ];\r\n\r\nfunction getWritersWhitelist(env) {\r\n  if (env === \"test\") {\r\n    return [\r\n      \"silkking.near\",\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      \"blaze.near\",\r\n      \"ayelen.near\",\r\n      \"kenrou-it.near\",\r\n    ];\r\n  } else {\r\n    return [\r\n      \"neardigitalcollective.near\",\r\n      \"blaze.near\",\r\n      \"jlw.near\",\r\n      \"kazanderdad.near\",\r\n      \"joep.near\",\r\n      \"sarahkornfeld.near\",\r\n      \"yuensid.near\",\r\n      \"shubham007.near\",\r\n      \"fiftycent.near\",\r\n      \"ozymandius.near\",\r\n      \"chloe.near\",\r\n    ];\r\n  }\r\n}\r\n\r\nfunction canUserCreateArticle(props) {\r\n  const { env, accountId } = props;\r\n  return getWritersWhitelist(env).includes(accountId);\r\n}\r\n\r\nfunction canUserEditArticle(props) {\r\n  const { article, accountId } = props;\r\n  return false;\r\n}\r\n\r\nfunction createArticle(props) {\r\n  const { accountId, article } = props;\r\n}\r\n\r\n// const args = {\r\n//     articleId: editArticleData.articleId ?? state.articleId,\r\n//     author: editArticleData.articleId ?? accountId,\r\n//     lastEditor: accountId,\r\n//     timeLastEdit: Date.now(),\r\n//     timeCreate: editArticleData.timeCreate ?? Date.now(),\r\n//     body: state.articleBody,\r\n//     version: editArticleData ? editArticleData.version + 1 : 0,\r\n//     navigation_id: null,\r\n//     tags: tagsArray,\r\n//     realArticleId:\r\n//       editArticleData.realArticleId ?? ${accountId}-${Date.now()},\r\n//   };\r\n\r\nfunction getArticlesIndexes(props) {\r\n  const { accountId } = props;\r\n  return Social.index(action, \"main\", {\r\n    order: \"desc\",\r\n    accountId,\r\n  });\r\n}\r\n\r\nfunction getArticleBlackList() {\r\n  return [91092435, 91092174, 91051228, 91092223, 91051203, 98372095];\r\n}\r\n\r\nfunction filterInvalidArticlesIndexes(props, articlesIndexes) {\r\n  const { env } = props;\r\n\r\n  return articlesIndexes\r\n    .filter((articleIndex) => articleIndex.value.id) // Has realArticleId\r\n    .filter(\r\n      (articleIndex) =>\r\n        articleIndex.value.id.split(\"-\")[0] === articleIndex.accountId\r\n    ) // realArticleId begins with same accountId as index object\r\n    .filter((articleIndex) =>\r\n      getWritersWhitelist(env).includes(articleIndex.accountId)\r\n    ) // Account is in whitelist\r\n    .filter(\r\n      (articleIndex) =>\r\n        !getArticleBlackList().includes(articleIndex.blockHeight) // Article is not in blacklist\r\n    );\r\n}\r\n\r\nfunction getLatestEdits(newFormatArticlesIndexes) {\r\n  return newFormatArticlesIndexes.filter((articleIndex) => {\r\n    const latestEditForThisArticle = newFormatArticlesIndexes.find(\r\n      (newArticleData) => newArticleData.value.id === articleIndex.value.id\r\n    );\r\n    return (\r\n      JSON.stringify(articleIndex) === JSON.stringify(latestEditForThisArticle)\r\n    );\r\n  });\r\n}\r\n\r\nfunction getArticle(articleIndex) {\r\n  const article = Social.get(\r\n    `${articleIndex.accountId}/${action}/main`,\r\n    articleIndex.blockHeight\r\n  );\r\n\r\n  let articleParsed = undefined;\r\n  if (article) {\r\n    articleParsed = JSON.parse(article);\r\n    articleParsed.blockHeight = articleIndex.blockHeight;\r\n    articleParsed.realArticleId = articleIndex.value.id;\r\n  }\r\n\r\n  return articleParsed;\r\n}\r\n\r\nfunction getOldArticleBasicDataArray(props) {\r\n  const { env } = props;\r\n  if (env === \"test\") {\r\n    return [\r\n      {\r\n        accountId:\r\n          \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n        blockHeight: 97325392,\r\n      },\r\n      {\r\n        accountId:\r\n          \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n        blockHeight: 97317287,\r\n      },\r\n      { accountId: \"ayelen.near\", blockHeight: 96927579 },\r\n      { accountId: \"kenrou-it.near\", blockHeight: 96924422 },\r\n      {\r\n        accountId:\r\n          \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n        blockHeight: 96879470,\r\n      },\r\n      {\r\n        accountId:\r\n          \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n        blockHeight: 96878182,\r\n      },\r\n      {\r\n        accountId:\r\n          \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n        blockHeight: 96643643,\r\n      },\r\n      { accountId: \"silkking.near\", blockHeight: 96491128 },\r\n    ];\r\n  } else {\r\n    return [\r\n      { accountId: \"ozymandius.near\", blockHeight: 97329049 },\r\n      { accountId: \"fiftycent.near\", blockHeight: 97322138 },\r\n      { accountId: \"blaze.near\", blockHeight: 97255023 },\r\n      { accountId: \"jlw.near\", blockHeight: 97250015 },\r\n      { accountId: \"kazanderdad.near\", blockHeight: 96692435 },\r\n      { accountId: \"blaze.near\", blockHeight: 96414482 },\r\n      { accountId: \"blaze.near\", blockHeight: 96412953 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 96402919 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 96402476 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 96402330 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 96401880 },\r\n      { accountId: \"ozymandius.near\", blockHeight: 95810612 },\r\n      { accountId: \"blaze.near\", blockHeight: 95766756 },\r\n      { accountId: \"blaze.near\", blockHeight: 95766700 },\r\n      { accountId: \"jlw.near\", blockHeight: 95705034 },\r\n      { accountId: \"blaze.near\", blockHeight: 95413943 },\r\n      { accountId: \"blaze.near\", blockHeight: 94936576 },\r\n      { accountId: \"yuensid.near\", blockHeight: 94866690 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 94863580 },\r\n      { accountId: \"blaze.near\", blockHeight: 94801223 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 94344236 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 94188387 },\r\n      { accountId: \"jlw.near\", blockHeight: 93986868 },\r\n      { accountId: \"blaze.near\", blockHeight: 92999498 },\r\n    ];\r\n  }\r\n}\r\n\r\nfunction getNewFormatValidArticles(props) {\r\n  const articlesIndexes = getArticlesIndexes(props);\r\n  const validArticlesIndexes = filterInvalidArticlesIndexes(\r\n    props,\r\n    articlesIndexes\r\n  );\r\n  const validLatestEdits = getLatestEdits(validArticlesIndexes);\r\n  return validLatestEdits.map(getArticle);\r\n}\r\n\r\nfunction getOldFormatArticles(props) {\r\n  const oldBasicDataArray = getOldArticleBasicDataArray(props);\r\n  return oldBasicDataArray.map(getArticle);\r\n}\r\n\r\nfunction getLastEditArticles(props) {\r\n  const oldFormatArticles = getOldFormatArticles(props);\r\n  const newFormatArticles = getNewFormatValidArticles(props);\r\n\r\n  const finalOldFormatArticles = oldFormatArticles.filter(\r\n    (oldFormatArticle) => {\r\n      return !newFormatArticles.find(\r\n        (newFormatArticle) =>\r\n          newFormatArticle.articleId === oldFormatArticle.articleId\r\n      );\r\n    }\r\n  );\r\n\r\n  const lastEditionArticles = newFormatArticles.concat(finalOldFormatArticles);\r\n  const filteredArticles = filterArticles(props, lastEditionArticles);\r\n\r\n  return filteredArticles;\r\n}\r\n\r\nfunction filterArticlesByTag(props, articles) {\r\n  const { tag } = props;\r\n  if (!tag) return articles;\r\n\r\n  return articles.filter((article) => {\r\n    return article.tags.includes(tag);\r\n  });\r\n}\r\n\r\nfunction filterArticles(props, articles) {\r\n  const byTag = filterArticlesByTag(props, articles);\r\n\r\n  return byTag;\r\n}\r\n\r\nfunction libCall(call) {\r\n  if (call.functionName === \"canUserCreateArticle\") {\r\n    return canUserCreateArticle(call.props);\r\n  } else if (call.functionName === \"canUserEditArticle\") {\r\n    return canUserEditArticle(call.props);\r\n  } else if (call.functionName === \"getLastEditArticles\") {\r\n    return getLastEditArticles(call.props);\r\n  }\r\n}\r\n\r\nfunction getComments(args) {\r\n  const { realArticleId } = args;\r\n  const key = realArticleId;\r\n  return Social.index(action, key);\r\n}\r\n\r\nfunction setComment(args) {\r\n  const { realArticleId, text, previousCommentId } = args;\r\n  const data = {\r\n    index: {\r\n      [action]: JSON.stringify({\r\n        key: realArticleId,\r\n        value: {\r\n          text,\r\n          id: `${realArticleId}-${Date.now()}`,\r\n          previousCommentId,\r\n        },\r\n      }),\r\n    },\r\n  };\r\n  Social.set(data);\r\n\r\n  resultLibCalls = resultLibCalls.filter((call) => {\r\n    return call.functionName !== \"setComment\";\r\n  });\r\n\r\n  return text;\r\n}\r\n\r\nif (libCalls && libCalls.length > 0) {\r\n  const updateObj = {};\r\n  const resultLibCalls = [...libCalls];\r\n  libCalls.forEach((call) => {\r\n    updateObj[call.key] = libCall(call);\r\n  });\r\n\r\n  updateObj.libCalls = resultLibCalls;\r\n  stateUpdate(updateObj);\r\n}\r\n\r\nreturn <></>;\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/kenrou-it.near/widget/SayALot.lib.article", "fact_widget_deployments_id": "eb47454de6afb7876b48b8a5c5cef444", "inserted_timestamp": "2023-08-09T22:39:04.014Z", "modified_timestamp": "2023-08-09T22:39:04.014Z", "__row_index": 0}