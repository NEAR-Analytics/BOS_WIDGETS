{"tx_hash": "Fwhc4KKYqgJXvhUHNRaAfp1L2C7RsDuvza27iyapJbxb", "action_id_social": "AFibP3zippr4xDz9GZjk8Z8XCz3pG3bZmd3oAuzNeBdg-0-widget", "block_id": 110534163, "block_timestamp": "2024-01-16T08:45:34.114Z", "signer_id": "create.near", "widget_name": "widget.stats", "source_code": "const accountId = props.accountId ?? \"hack.near\";\nconst widgetName = props.widgetName ?? \"DAO.Members\";\n\nconst GRAPHQL_ENDPOINT = \"https://near-queryapi.api.pagoda.co\";\nconst STORE = \"storage.googleapis.com\";\nconst BUCKET = \"databricks-near-query-runner\";\nconst BASE_URL = `https://${STORE}/${BUCKET}/output/near_bos_component_details/component_rpc_loads`;\nconst dataset = `${BASE_URL}/${accountId}/widget/${widgetName}`;\n\nconst [isLoadingRpcImpressions, setLoadingRpcImpressions] = useState(true);\nconst [componentImpressionsData, setComponentImpressionsData] = useState({\n  impressions: undefined,\n  weekly_chart_data_config: undefined,\n  executed_at: undefined,\n});\n\nconst normalizeMarkdown = (text) => {\n  // convert headers to normal text (remove # symbols)\n  text = text.replace(/^#+\\s*/gm, \"\");\n  // convert bold and italic to normal text (remove * and _ symbols)\n  text = text.replace(/(\\*\\*|__)(.*?)\\1/g, \"$2\");\n  text = text.replace(/(\\*|_)(.*?)\\1/g, \"$2\");\n  // remove links\n  text = text.replace(/\\[(.*?)\\]\\(.*?\\)/g, \"$1\");\n  // remove images\n  text = text.replace(/!\\[(.*?)\\]\\(.*?\\)/g, \"$1\");\n  return text.trim();\n};\n\nconst formatDate = (date) => {\n  return date.toISOString().split(\"T\")[0];\n};\n\nconst computeWeekLabel = (weekDateString) => {\n  let startDate = new Date(weekDateString);\n  let endDate = new Date(startDate);\n  endDate.setDate(startDate.getDate() + 6);\n  let label = `${formatDate(startDate)} - ${formatDate(endDate)}`;\n  return label;\n};\n\nconst getComponentImpressions = () => {\n  try {\n    const url = `${dataset}.json`;\n    const res = fetch(url);\n    if (res.ok) {\n      const parsedResults = JSON.parse(res.body);\n      const weekly_chart_data = parsedResults.data.rpc_loads\n        .sort((a, b) => new Date(a.week) - new Date(b.week))\n        .map((row) => ({\n          \"RPC Impressions\": row.number_of_rpc_loads,\n          Week: computeWeekLabel(row.week),\n        }));\n\n      const weekly_chart_data_config = {\n        tooltip: {\n          trigger: \"axis\",\n          confine: true,\n        },\n        grid: {\n          left: \"3%\",\n          right: \"4%\",\n          containLabel: true,\n        },\n        xAxis: {\n          type: \"category\",\n          boundaryGap: false,\n          data: weekly_chart_data.map((r) => r.Week),\n          axisLine: { show: false },\n          axisTick: { show: false },\n          axisLabel: { show: false },\n        },\n        yAxis: {\n          type: \"value\",\n          splitLine: { show: false },\n          axisLine: { show: false },\n          axisTick: { show: false },\n          axisLabel: { show: false },\n        },\n        series: [\n          {\n            name: \"Number of Views\",\n            type: \"line\",\n            smooth: true,\n            data: weekly_chart_data.map((r) => r[\"RPC Impressions\"]),\n            areaStyle: {},\n            color: \"#59e691\",\n            showSymbol: false,\n          },\n        ],\n      };\n      setLoadingRpcImpressions(false);\n      setComponentImpressionsData({\n        impressions: parsedResults.data.total_rpc_loads,\n        weekly_chart_data_config,\n        executed_at: parsedResults.executed_at,\n      });\n    }\n  } catch (error) {\n    console.error(\n      \"Error on fetching component impression data: \",\n      error.message\n    );\n  }\n};\n\nfunction fetchGraphQL(operationsDoc, operationName, variables) {\n  return asyncFetch(`${GRAPHQL_ENDPOINT}/v1/graphql`, {\n    method: \"POST\",\n    headers: { \"x-hasura-role\": \"eduohe_near\" },\n    body: JSON.stringify({\n      query: operationsDoc,\n      variables: variables,\n      operationName: operationName,\n    }),\n  });\n}\n\nconst Wrapper = styled.div`\n  > div {\n    padding-bottom: 32px;\n    border-bottom: 1px solid #eceef0;\n    margin-bottom: 32px;\n\n    &:last-child {\n      padding-bottom: 0;\n      border-bottom: none;\n      margin-bottom: 0;\n    }\n  }\n\n  @media (max-width: 995px) {\n    grid-row: 1;\n  }\n`;\n\nconst StatsContainer = styled.div`\n  @media (max-width: 995px) {\n    margin-top: 10px;\n  }\n`;\n\nconst SmallTitle = styled.h3`\n  color: #687076;\n  font-weight: 600;\n  font-size: 12px;\n  line-height: 15px;\n  margin-bottom: 20px;\n  text-transform: uppercase;\n\n  @media (max-width: 770px) {\n    margin-bottom: 16px;\n  }\n`;\n\nconst Bio = styled.div`\n  color: #11181c;\n  font-size: 14px;\n  line-height: 20px;\n  margin-bottom: 15px;\n  margin-top: 20px;\n\n  > *:last-child {\n    margin-bottom: 15 !important;\n  }\n\n  @media (max-width: 900px) {\n    margin-bottom: 15px;\n  }\n`;\n\nconst Text = styled.p`\n  margin: 0;\n  font-size: 14px;\n  line-height: 20px;\n  color: ${(p) => (p.bold ? \"#11181C\" : \"#687076\")};\n  font-weight: ${(p) => (p.bold ? \"600\" : \"400\")};\n  font-size: ${(p) => (p.small ? \"12px\" : \"14px\")};\n\n  i {\n    margin-right: 4px;\n  }\n`;\n\nconst Container = styled.div`\n  display: flex;\n  flex-direction: column;\n  margin-top: 25px;\n  padding-bottom: 25px;\n`;\n\nconst Stats = styled.div`\n  display: flex;\n  flex-direction: row;\n`;\n\nconst StatsBadge = styled.div`\n  display: flex;\n  align-items: center;\n  margin-right: 20px;\n`;\n\nconst Icon = styled.i`\n  font-size: 15px;\n  fill: currentColor;\n  padding-right: 5px;\n`;\n\nconst StatsText = styled.p`\n  margin: 0;\n  font-size: 14px;\n  line-height: 20px;\n  color: \"#11181C\";\n  font-weight: ${(p) => (p.bold ? \"600\" : \"400\")};\n  font-size: ${(p) => (p.small ? \"12px\" : \"14px\")};\n  border-radius: 12px;\n`;\n\nconst GraphContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n\n  @media (min-width: 450px) {\n    flex-direction: row;\n  }\n`;\n\nconst Graph = styled.div`\n  display: flex;\n  margin-top: -24px;\n  @media (min-width: 450px) {\n    margin-left: 30px;\n  }\n`;\n\nconst ItemsWrapper = styled.div`\n  display: flex;\n  flex-direction: column;\n  gap: 24px;\n`;\n\nconst code = Social.get(`${accountId}/widget/${widgetName}`);\nconst dependencyMatch =\n  code && code.matchAll(/<Widget[\\s\\S]*?src=.*?\"(.+)\"[\\s\\S]*?\\/>/g);\nlet dependencySources = [...(dependencyMatch || [])]\n  .map((r) => r[1])\n  .filter((r) => !!r);\ndependencySources = dependencySources.filter(\n  (r, i) => dependencySources.indexOf(r) === i && r !== \"(.+)\"\n);\n\nconst accountProfileDescription =\n  Social.getr(`${accountId}/profile`).description ?? \"\";\n\nif (accountProfileDescription) {\n  const text = normalizeMarkdown(accountProfileDescription).split(\" \");\n  accountProfileDescription = text.slice(0, DESC_MAX_WORDS);\n  if (text.length >= DESC_MAX_WORDS) {\n    accountProfileDescription.push(\"...\");\n  }\n  accountProfileDescription = accountProfileDescription.join(\" \");\n}\n\nif (isLoadingRpcImpressions) {\n  getComponentImpressions();\n}\n\nreturn (\n  <Wrapper>\n    <StatsContainer>\n      <Container>\n        <GraphContainer>\n          <div\n            className=\"ms-3\"\n            style={{ display: \"flex\", flexDirection: \"column\" }}\n          >\n            <Text small style={{ marginBottom: \"10px\" }}>\n              Views\n            </Text>\n            <Text medium bold style={{ marginBottom: \"10px\" }}>\n              {componentImpressionsData.impressions ?? \"...\"}\n            </Text>\n          </div>\n          <div\n            className=\"ms-3\"\n            style={{ display: \"flex\", flexDirection: \"column\" }}\n          >\n            <Text small style={{ marginBottom: \"10px\" }}>\n              Updated\n            </Text>\n            <Text medium bold style={{ marginBottom: \"10px\" }}>\n              <Widget\n                src=\"mob.near/widget/TimeAgo@97556750\"\n                props={{ keyPath: `${accountId}/widget/${widgetName}` }}\n              />\n              ago\n            </Text>\n          </div>\n          {componentImpressionsData.weekly_chart_data_config && (\n            <Graph>\n              <Widget\n                src=\"near/widget/Chart\"\n                props={{\n                  definition: componentImpressionsData.weekly_chart_data_config,\n                  width: \"180px\",\n                  height: \"100px\",\n                }}\n              />\n            </Graph>\n          )}\n        </GraphContainer>\n      </Container>\n    </StatsContainer>\n  </Wrapper>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/create.near/widget/widget.stats", "fact_widget_deployments_id": "ff39dbf4bc060dd347c49d5c2152a6c4", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}