{"tx_hash": "9SXadfnL1vdbTrxu4hWJcTWEAGDzFBF1msBU2TXvoLJX", "action_id_social": "H79GZj6JrN54HKDLRVU1FYMVvtjQBrnvPmwR19v28q5b-0-widget", "block_id": 117898564, "block_timestamp": "2024-04-29T18:05:22.807Z", "signer_id": "buildcommons.near", "widget_name": "thing.context", "source_code": "// adapted from the `PublicTags` widget by zavodil.near\n\nconst accountId = props.accountId ?? context.accountId ?? \"every.near\";\n\nconst src = props.src ?? \"apps.near/widget/demo\";\nconst [creatorId, namespace, thingId] = src.split(\"/\");\n\nconst blockheight = props.blockheight ?? \"final\";\n\nconst thingExists = Social.get(`${src}`, \"final\");\n\nconst tagsObject = Social.get(`${src}/metadata/tags/*`, blockheight);\n\nif (!tagsObject) {\n  return \"\";\n}\n\nconst contextObject = Social.get(\n  `*/${creatorId}/${namespace}/${thingId}/metadata/tags/*`,\n  blockheight\n);\n\nif (!contextObject) {\n  return \"\";\n}\n\nState.init({\n  tagsObject,\n});\n\nconst normalizeTag = (tag) =>\n  tag\n    .replaceAll(/[- \\.]/g, \"_\")\n    .replaceAll(/[^\\w]+/g, \"\")\n    .replaceAll(/_+/g, \"-\")\n    .replace(/^-+/, \"\")\n    .replace(/-+$/, \"\")\n    .toLowerCase()\n    .trim(\"-\");\n\nconst tagsCount = {};\n\nconst processTagsObject = (obj) => {\n  Object.keys(obj).forEach((key) => {\n    const normalizedKey = normalizeTag(key);\n    if (obj[key] === null) {\n      tagsCount[normalizedKey] = (tagsCount[normalizedKey] || 0) - 1;\n    } else if (typeof obj[key] === \"object\") {\n      processTagsObject(obj[key]);\n    } else {\n      tagsCount[normalizedKey] = (tagsCount[normalizedKey] || 0) + 1;\n    }\n  });\n};\n\nprocessTagsObject(State.update(tagsObject));\n\nconst getTags = () => {\n  processTagsObject(contextObject);\n  const tags = Object.entries(tagsCount);\n  tags.sort((a, b) => b[1] - a[1]);\n  return tags.map((t) => {\n    return {\n      name: t[0],\n      count: t[1] - 1,\n    };\n  });\n};\n\nfunction updateTags(tags) {\n  const newTagsObject = {};\n  tags.forEach((tag) => {\n    newTagsObject[normalizeTag(tag.name)] = \"\";\n  });\n  State.update({ tagsObject: newTagsObject });\n}\n\nconst publicTags = getTags();\n\nreturn (\n  <>\n    <div className=\"m-2\">\n      {publicTags.length > 0 ? (\n        publicTags.map((tag) => (\n          <a\n            href={`/apps.near/widget/every.thing?context=${tag.name}`}\n            className=\"text-white btn p-0 lh-1 m-1\"\n            key={tag.name}\n          >\n            <span\n              className=\"badge bg-primary position-relative\"\n              style={{\n                marginRight: tag.count > 1 ? \"0.9em\" : \"0.25em\",\n                paddingRight: tag.count > 1 ? \"0.85em\" : undefined,\n              }}\n            >\n              #{tag.name}\n              {tag.count > 1 && (\n                <span className=\"ms-1 badge translate-middle rounded-pill bg-dark position-absolute top-50 start-100\">\n                  {tag.count}\n                </span>\n              )}\n            </span>\n          </a>\n        ))\n      ) : (\n        <p>No tags found.</p>\n      )}\n    </div>\n    {thingExists && (\n      <div className=\"m-1 d-flex flex-row\">\n        <div className=\"m-1\">\n          <Typeahead\n            id={`tag-selector-${Date.now()}`}\n            multiple\n            labelKey=\"name\"\n            onChange={updateTags}\n            options={publicTags}\n            placeholder=\"dev, art, gov, edu, social\"\n            positionFixed\n            allowNew\n          />\n        </div>\n        <div className=\"m-1\">\n          {accountId === creatorId ? (\n            <CommitButton\n              disabled={state.tagsObject === null}\n              data={{\n                [namespace]: {\n                  metadata: {\n                    tags: state.tagsObject,\n                  },\n                },\n              }}\n            >\n              <i className=\"bi bi-plus-lg\" />\n            </CommitButton>\n          ) : (\n            <CommitButton\n              disabled={state.tagsObject === null}\n              data={{\n                [creatorId]: {\n                  [namespace]: {\n                    [thingId]: {\n                      metadata: {\n                        tags: state.tagsObject,\n                      },\n                    },\n                  },\n                },\n              }}\n            >\n              <i className=\"bi bi-plus-lg\"></i>\n            </CommitButton>\n          )}\n        </div>\n      </div>\n    )}\n  </>\n);\n", "metadata": {"fork_of": "hack.near/widget/thing.context@107099401"}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/buildcommons.near/widget/thing.context", "fact_widget_deployments_id": "9a8b42e63b38425c4099995fe8fe36d1", "inserted_timestamp": "2024-04-29T18:57:41.317Z", "modified_timestamp": "2024-04-29T18:57:41.317Z", "__row_index": 1}