{"tx_hash": "3p2BwE5fKXcJtGVkAQSbZtuRW5baXuyrKHrLAudDorm8", "action_id_social": "CvS7nheCtKjyYdyT1HhJeD1aWeqFat8mUPFgb9ZGP3Hw-0-widget", "block_id": 99077225, "block_timestamp": "2023-08-18T08:44:29.873Z", "signer_id": "ref-admin.near", "widget_name": "XREF.Unstake", "source_code": "/** state init start */\nState.init({\n  inputValue: \"\",\n  inputError: \"\",\n  unstakeMax: false,\n});\n/** state init end */\n// load config\nconst config = props.config;\nif (!config) {\n  return \"Component not be loaded. Missing `config` props\";\n}\n\nconst accountId = props.accountId || context.accountId;\nconst isSignedIn = !!accountId;\nconst REF_DECIMALS = 18;\nconst XREF_DECIMALS = 18;\nconst DECIMALS_XREF_REF_TRANSTER = 8;\nconst BIG_ROUND_DOWN = 0;\nconst storageToken = Near.view(config.REF_TOKEN_ID, \"storage_balance_of\", {\n  account_id: accountId,\n});\nconst shrinkToken = (value, decimals) => {\n  return new Big(value).div(new Big(10).pow(decimals)).toFixed();\n};\nconst expandToken = (value, decimals) => {\n  return new Big(value).mul(new Big(10).pow(decimals)).toFixed();\n};\nfunction isValid(a) {\n  if (!a) return false;\n  if (isNaN(Number(a))) return false;\n  if (a === \"\") return false;\n  return true;\n}\n\n/** common lib end */\nfunction getxRefBalance(accountId) {\n  const balanceRaw = Near.view(config.XREF_TOKEN_ID, \"ft_balance_of\", {\n    account_id: accountId,\n  });\n  if (!balanceRaw) return \"-\";\n  const balance = Big(balanceRaw).div(Big(10).pow(XREF_DECIMALS));\n  return [\n    balance.lt(0) ? \"0\" : balance.toFixed(5, BIG_ROUND_DOWN),\n    balance.lt(0) ? \"0\" : balance.toFixed(),\n  ];\n}\nfunction getRate() {\n  const rateRow = Near.view(config.XREF_TOKEN_ID, \"get_virtual_price\");\n  if (!rateRow) return 0;\n  const rate = Big(rateRow)\n    .div(Big(10).pow(DECIMALS_XREF_REF_TRANSTER))\n    .toFixed();\n  return rate;\n}\n\nconst [xrefBalance, xrefBalanceWhole] = getxRefBalance(accountId);\nconst refToxrefRate = getRate();\n/** events start */\nconst onChange = (e) => {\n  // Has user signed in?\n  if (!isSignedIn) {\n    State.update({\n      unstakeMax: false,\n      inputError: \"Sign in please\",\n    });\n    return;\n  }\n  const targetValue = e.target.value;\n  if (targetValue !== \"\" && !targetValue.match(/^\\d*(\\.\\d*)?$/)) {\n    return;\n  }\n  let stakeAmount = targetValue.replace(/^0+/, \"0\"); // remove prefix 0\n  // limit 18 decimals\n  const most18DecimalsPattern = /^-?\\d+(\\.\\d{0,18})?/;\n  let values = stakeAmount.match(most18DecimalsPattern);\n  if (values) {\n    stakeAmount = values[0];\n  }\n  if (\n    xrefBalance &&\n    (isNaN(Number(stakeAmount)) ||\n      stakeAmount === \"\" ||\n      Big(stakeAmount).gt(Big(xrefBalance)))\n  ) {\n    if (\n      isNaN(Number(stakeAmount)) ||\n      stakeAmount === \"\" ||\n      Big(stakeAmount).lte(0)\n    ) {\n      State.update({\n        unstakeMax: false,\n        inputValue: stakeAmount,\n        inputError: \"Stake at least greater than zero xREF\",\n      });\n    } else {\n      State.update({\n        unstakeMax: false,\n        inputValue: stakeAmount,\n        inputError: `Max is ${xrefBalance} REF`,\n      });\n    }\n    return;\n  }\n  State.update({\n    unstakeMax: false,\n    inputValue: stakeAmount,\n    inputError: \"\",\n  });\n};\n\nconst onClickMax = () => {\n  if (\n    isNaN(Number(xrefBalance)) ||\n    xrefBalance === \"\" ||\n    Big(xrefBalance).lte(0)\n  ) {\n    State.update({\n      unstakeMax: true,\n      inputValue: xrefBalance,\n      inputError: \"Stake at least greater than zero xREF\",\n    });\n    return;\n  } else {\n    State.update({\n      unstakeMax: true,\n      inputValue: xrefBalance,\n      inputError: \"\",\n    });\n  }\n};\n\nconst onClickUnStake = async () => {\n  const { inputValue, unstakeMax } = state;\n  const stakeAmount = inputValue;\n  if (\n    xrefBalance &&\n    (isNaN(Number(stakeAmount)) ||\n      stakeAmount === \"\" ||\n      Big(stakeAmount).lte(0) ||\n      Big(stakeAmount).gt(Big(xrefBalanceWhole)))\n  ) {\n    if (\n      isNaN(Number(stakeAmount)) ||\n      stakeAmount === \"\" ||\n      Big(stakeAmount).lte(0)\n    ) {\n      State.update({ inputError: \"Stake at least greater than zero xREF\" });\n    } else if (Big(stakeAmount).gt(Big(xrefBalanceWhole))) {\n      State.update({\n        inputError: `Max is ${xrefBalance} xREF`,\n      });\n    } else {\n      State.update({\n        inputError: \"\",\n      });\n    }\n    return;\n  }\n  const transactions = [\n    {\n      contractName: config.XREF_TOKEN_ID,\n      methodName: \"unstake\",\n      args: {\n        amount: expandToken(\n          unstakeMax ? xrefBalanceWhole : stakeAmount,\n          XREF_DECIMALS\n        ),\n        msg: \"\",\n      },\n      deposit: new Big(\"1\").toFixed(),\n      gas: expandToken(50, 12),\n    },\n  ];\n  if (!storageToken || storageToken.total === \"0\") {\n    transactions.unshift({\n      contractName: config.REF_TOKEN_ID,\n      methodName: \"storage_deposit\",\n      args: {\n        account_id: accountId,\n        registration_only: true,\n      },\n      deposit: expandToken(0.0125, 24),\n      gas: expandToken(50, 12),\n    });\n  }\n  Near.call(transactions);\n};\n/** events end */\n\nconst disabledStakeButton =\n  !isValid(state.inputValue) || Big(state.inputValue).eq(0) || state.inputError;\n\nconst youWillReceive = (\n  Big(refToxrefRate || 0).lte(0)\n    ? Big(0).toFixed(5, BIG_ROUND_DOWN)\n    : Big(isValid(state.inputValue) ? state.inputValue : 0).mul(refToxrefRate)\n).toFixed(5, BIG_ROUND_DOWN);\nconst StakeFormWrapper = styled.div`\n  width: 100%;\n  max-width: 500px;\n  padding-top: 10px;\n  background: #25283A;\n  border-radius: 16px;\n  margin-top:20px;\n  padding-bottom:20px;\n  .contentArea{\n    background: #25283A;\n    border-radius: 16px;\n    padding:20px 30px 0 30px;\n  }\n  .contentArea p{\n    color: #7C7F96;\n    font-size:14px;\n  }\n  .contentArea hr{\n    background: #373A53;\n    height:2px;\n  }\n  .arr .bigIcon{\n    background: #373A53;\n  }\n  .arr .boldText{\n    font-weight: 500;\n  }\n  .arr .apr{\n    color: #7C7F96;\n  }\n  .arr .apr .value{\n    color:#FFFFFF;\n    font-weight: 500;\n  }\n  .footer p{\n    color:#FFFFFF;\n  }\n`;\n\nreturn (\n  <StakeFormWrapper>\n    <div class=\"arr\">\n      <Widget\n        src={`${config.ownerId}/widget/stake-bannerIcon`}\n        props={{\n          firstIconName: \"xREF\",\n          firstIconUrl:\n            \"https://ipfs.near.social/ipfs/bafkreierdf2ykpfcctanlt7s5xcd5jp7cydnvm3vztdl7ywlwowvuspg4e\",\n          secondIconName: \"\",\n          secondIconUrl:\n            \"https://ipfs.near.social/ipfs/bafkreiauvwi7qjcy2ddzcjobr274vshstk7up22fnr3dbul2lypp755j44\",\n          componentType: \"xref\",\n        }}\n      ></Widget>\n    </div>\n    <div class=\"contentArea\">\n      <Widget\n        src={`${config.ownerId}/widget/LiNEAR.Input`}\n        props={{\n          firstIconName: \"xREF\",\n          placeholder: \"0\",\n          value: state.inputValue,\n          onChange,\n          onClickMax,\n          inputError: state.inputError,\n          balance: xrefBalance,\n        }}\n      />\n      <Widget\n        src={`${config.ownerId}/widget/LiNEAR.Button`}\n        props={{\n          onClick: onClickUnStake,\n          disabled: disabledStakeButton,\n          text: \"Unstake\",\n          type: \"outline\",\n          firstIconName: \"xREF\",\n        }}\n      />\n      <div class='footer'>\n        <Widget\n          src={`${config.ownerId}/widget/LiNEAR.Message.YouWillReceive`}\n          props={{\n            text: `${youWillReceive} REF`, secondIconName: \"REF\",\n            secondIconUrl: \"https://ipfs.near.social/ipfs/bafkreiauvwi7qjcy2ddzcjobr274vshstk7up22fnr3dbul2lypp755j44\",\n          }}\n        />\n      </div>\n    </div>\n  </StakeFormWrapper>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/ref-admin.near/widget/XREF.Unstake", "fact_widget_deployments_id": "b87da4a0d48e4d590b49443327ccd173", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}