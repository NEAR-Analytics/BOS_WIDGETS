{"tx_hash": "CGfyPnpHG4We1X15RW1o6pejz6rYZh8TNspFhZxvgtPL", "action_id_social": "EgJhBHLeNEd3LBikxL5v9FU6ZbcNNnP6JzVQTrj1u5EG-0-widget", "block_id": 102986329, "block_timestamp": "2023-10-09T15:24:27.678Z", "signer_id": "astraplusplus.ndctools.near", "widget_name": "DAO.Proposal.Create.FunctionCall", "source_code": "const accountId = props.accountId ?? context.accountId;\nconst contractId = props.contractId;\nconst onClose = props.onClose;\nconst daoId = props.daoId;\nconst isCongressDaoID = props.isCongressDaoID;\nconst registry = \"registry.i-am-human.near\";\n\nconst CoADaoId = \"coa.gwg-testing.near\";\nconst VotingBodyDaoId = \"\";\nconst TCDaoId = \"tc.gwg-testing.near\";\nconst HoMDaoId = \"hom.gwg-testing.near\";\n\nif (!accountId) {\n    return \"Please connect your NEAR wallet :)\";\n}\n\nfunction isEmpty(value) {\n    return !value || value === \"\";\n}\n\nState.init({\n    contractId: state.contractId,\n    method_name: state.method_name,\n    args: state.args || \"{}\",\n    deposit: state.deposit || \"0\",\n    gas: \"200000000000000\",\n    error: undefined,\n    receiver_id: null,\n    description: null,\n    powerType: null,\n    member: null, // for dismiss and ban hook\n    house: null, // for dismiss and ban hook\n    accounts: null, // for unban hook\n    memo: null // for unban hook\n});\n\n// only for UI\nconst powerTypes =\n    daoId === CoADaoId\n        ? [\n              {\n                  text: \"Veto House of Merit motion\",\n                  value: \"Veto\"\n              },\n              {\n                  text: \"Unban member previously banned\",\n                  value: \"Unban\"\n              }\n          ]\n        : daoId === TCDaoId\n        ? [\n              {\n                  text: \"Dismiss member from an house\",\n                  value: \"Dismiss\"\n              },\n              {\n                  text: \"Ban member from an house\",\n                  value: \"DismissAndBan\"\n              }\n          ]\n        : daoId === VotingBodyDaoId\n        ? [] // TODO :  after VB contract is ready\n        : [];\n\nconst fc_args = Buffer.from(state.args, \"utf-8\").toString(\"base64\");\n\nfunction isNearAddress(address) {\n    const ACCOUNT_ID_REGEX =\n        /^(([a-z\\d]+[-_])*[a-z\\d]+\\.)*([a-z\\d]+[-_])*[a-z\\d]+$/;\n    return (\n        address.length >= 2 &&\n        address.length <= 64 &&\n        ACCOUNT_ID_REGEX.test(address)\n    );\n}\n\nconst handleFunctionCall = () => {\n    if (!isCongressDaoID) {\n        if (isEmpty(state.contractId) || !isNearAddress(state.contractId)) {\n            State.update({\n                error: \"Please enter a valid contract ID\"\n            });\n            return;\n        }\n    }\n    if (state.powerType !== \"Unban\") {\n        if (isEmpty(state.method_name)) {\n            State.update({\n                error: \"Please enter a valid method name\"\n            });\n            return;\n        }\n\n        const is_valid_json = (str) => {\n            try {\n                JSON.parse(str);\n            } catch (e) {\n                return false;\n            }\n            return true;\n        };\n\n        if (isEmpty(state.args) || !is_valid_json(state.args)) {\n            State.update({\n                error: \"Please enter a valid JSON arguments\"\n            });\n            return;\n        }\n        if (isEmpty(state.deposit) || state.deposit < 0) {\n            State.update({\n                error: \"Please enter a valid deposit\"\n            });\n            return;\n        }\n        if (isEmpty(state.gas) || state.gas <= 0) {\n            State.update({\n                error: \"Please enter a valid gas\"\n            });\n            return;\n        }\n    }\n\n    const deposit = Big(state.deposit).mul(Big(10).pow(24)).toFixed();\n\n    if (isCongressDaoID) {\n        if (state.powerType === \"Unban\") {\n            const accountsArray = state.accounts\n                ?.split(\",\")\n                .map((item) => item.trim());\n            if (\n                !accountsArray?.length ||\n                accountsArray?.some((item) => !isNearAddress(item))\n            ) {\n                State.update({\n                    error: \"Please enter valid account IDs\"\n                });\n                return;\n            }\n            Near.call([\n                {\n                    contractName: registry,\n                    methodName: \"admin_unflag_accounts\",\n                    args: { accounts: accountsArray, memo: state.memo },\n                    deposit: 0,\n                    gas: 200000000000000\n                }\n            ]);\n            return;\n        } else {\n            let args = {};\n            if (state.powerType === \"DismissAndBan\") {\n                if (isEmpty(state.house) || !isNearAddress(state.house)) {\n                    State.update({\n                        error: \"Please enter a valid house contract ID\"\n                    });\n                    return;\n                }\n                if (isEmpty(state.member) || !isNearAddress(state.member)) {\n                    State.update({\n                        error: \"Please enter a valid member ID\"\n                    });\n                    return;\n                }\n                args = {\n                    kind: {\n                        DismissAndBan: {\n                            member: state.member,\n                            house: state.house\n                        }\n                    },\n                    description: state.description\n                };\n            } else {\n                if (\n                    isEmpty(state.receiver_id) ||\n                    !isNearAddress(state.receiver_id)\n                ) {\n                    State.update({\n                        error: \"Please enter a valid recipient address\"\n                    });\n                    return;\n                }\n                if (isEmpty(state.description)) {\n                    State.update({\n                        error: \"Please enter a description\"\n                    });\n                    return;\n                }\n\n                args = {\n                    kind: {\n                        FunctionCall: {\n                            receiver_id: state.receiver_id,\n                            actions: [\n                                {\n                                    method_name: state.method_name,\n                                    args: fc_args,\n                                    deposit: deposit,\n                                    gas: state.gas\n                                }\n                            ]\n                        }\n                    },\n                    description: state.description\n                };\n            }\n\n            Near.call([\n                {\n                    contractName: daoId,\n                    methodName: \"create_proposal\",\n                    args: args,\n                    deposit: 100000000000000000000000,\n                    gas: 200000000000000\n                }\n            ]);\n        }\n    } else {\n        Near.call([\n            {\n                contractName: state.contractId,\n                methodName: state.method_name,\n                args: {\n                    Arguments: fc_args\n                },\n                deposit: deposit,\n                gas: state.gas ?? \"200000000000000\"\n            }\n        ]);\n    }\n};\n\nconst onChangeContract = (contractId) => {\n    State.update({\n        contractId,\n        error: undefined\n    });\n};\n\nconst onChangeMethod = (method_name) => {\n    State.update({\n        method_name,\n        error: undefined\n    });\n};\n\nconst onChangeArgs = (args) => {\n    State.update({\n        args,\n        error: undefined\n    });\n};\n\nconst onChangeGas = (gas) => {\n    State.update({\n        gas,\n        error: undefined\n    });\n};\n\nconst onChangeDeposit = (deposit) => {\n    State.update({\n        deposit,\n        error: undefined\n    });\n};\n\nconst onChangeDescription = (description) => {\n    State.update({\n        description,\n        error: undefined\n    });\n};\n\nconst onChangeRecipient = (receiver_id) => {\n    State.update({\n        receiver_id,\n        error: undefined\n    });\n};\n\nconst onChangeHouse = (house) => {\n    State.update({\n        house,\n        error: undefined\n    });\n};\n\nconst onChangeMember = (member) => {\n    State.update({\n        member,\n        error: undefined\n    });\n};\n\nconst onChangeAccounts = (accounts) => {\n    State.update({\n        accounts,\n        error: undefined\n    });\n};\n\nconst onChangeMemo = (memo) => {\n    State.update({\n        memo,\n        error: undefined\n    });\n};\n\nconst onChangePowerType = (power) => {\n    switch (power?.value) {\n        case \"Dismiss\": {\n            State.update({\n                method_name: \"dismiss_hook\",\n                args: JSON.stringify({\n                    member: \"\"\n                })\n            });\n            break;\n        }\n        case \"Veto\": {\n            State.update({\n                method_name: \"veto_hook\",\n                args: JSON.stringify({\n                    id: \"\"\n                })\n            });\n            break;\n        }\n        case \"Ban\": {\n            break;\n        }\n        case \"Unban\": {\n            State.update({\n                accounts: null,\n                memo: null\n            });\n            break;\n        }\n        case \"DismissAndBan\": {\n            State.update({\n                house: null,\n                member: null\n            });\n            break;\n        }\n        default: {\n            break;\n        }\n    }\n};\n\nconst defaultDescription =\n    \"# [Your Title Here]\\n\\n## Description\\n\\n[Detailed description of what the proposal is about.]\\n\\n## Why This Proposal?\\n\\n[Explanation of why this proposal is necessary or beneficial.]\\n\\n## Execution Plan\\n\\n[Description of how the proposal will be implemented.]\\n\\n## Budget\\n\\n[If applicable, outline the budget required to execute this proposal.]\\n\\n## Timeline\\n\\n[Proposed timeline for the execution of the proposal.]\";\n\nreturn (\n    <>\n        {(daoId === CoADaoId || daoId === TCDaoId) && (\n            <div className=\"mb-3\">\n                <Widget\n                    src={`sking.near/widget/Common.Inputs.Select`}\n                    props={{\n                        label: \"Power\",\n                        noLabel: false,\n                        placeholder: \"Can propose motion\",\n                        options: powerTypes,\n                        value: state.powerType,\n                        onChange: (powerType) => {\n                            State.update({\n                                ...state,\n                                powerType: powerType.value\n                            });\n                            onChangePowerType(powerType);\n                        },\n\n                        error: undefined\n                    }}\n                />\n            </div>\n        )}\n\n        {state.powerType === \"DismissAndBan\" ? (\n            <>\n                <div className=\"mb-3\">\n                    <h5>Member</h5>\n                    <input\n                        type=\"text\"\n                        value={state.member}\n                        onChange={(e) => onChangeMember(e.target.value)}\n                        placeholder=\"Specify member account\"\n                    />\n                </div>\n                <div className=\"mb-3\">\n                    <h5>House</h5>\n                    <input\n                        type=\"text\"\n                        value={state.house}\n                        onChange={(e) => onChangeHouse(e.target.value)}\n                        placeholder=\"Specify house account\"\n                    />\n                </div>\n            </>\n        ) : (\n            <>\n                {state.powerType === \"Unban\" ? (\n                    <>\n                        <div className=\"mb-3\">\n                            <h5>Accounts List (separated by comma)</h5>\n                            <input\n                                type=\"text\"\n                                value={state.accounts}\n                                onChange={(e) =>\n                                    onChangeAccounts(e.target.value)\n                                }\n                            />\n                        </div>\n                        <div className=\"mb-3\">\n                            <h5>Memo</h5>\n                            <input\n                                type=\"text\"\n                                value={state.memo}\n                                onChange={(e) => onChangeMemo(e.target.value)}\n                            />\n                        </div>\n                    </>\n                ) : (\n                    <>\n                        {!isCongressDaoID && (\n                            <div className=\"mb-3\">\n                                <h5>Contract</h5>\n                                <input\n                                    type=\"text\"\n                                    value={state.contractId}\n                                    onChange={(e) =>\n                                        onChangeContract(e.target.value)\n                                    }\n                                />\n                            </div>\n                        )}\n                        <div className=\"mb-3\">\n                            <h5>Method</h5>\n                            <input\n                                disabled={state.powerType && state.method_name}\n                                type=\"text\"\n                                value={state.method_name}\n                                onChange={(e) => onChangeMethod(e.target.value)}\n                            />\n                        </div>\n                        <div className=\"mb-3\">\n                            <h5>Deposit</h5>\n                            <input\n                                type=\"number\"\n                                value={state.deposit}\n                                onChange={(e) =>\n                                    onChangeDeposit(e.target.value)\n                                }\n                                defaultValue={0}\n                            />\n                        </div>\n                        <div className=\"mb-3\">\n                            <h5>Gas</h5>\n                            <input\n                                type=\"number\"\n                                value={state.gas}\n                                onChange={(e) => onChangeGas(e.target.value)}\n                                defaultValue=\"200000000000000\"\n                            />\n                        </div>\n                        <div className=\"mb-3\">\n                            <h5>Arguments (JSON)</h5>\n                            <textarea\n                                type=\"text\"\n                                value={state.args}\n                                onChange={(e) => onChangeArgs(e.target.value)}\n                                className=\"form-control\"\n                                defaultValue={state.args}\n                            />\n                        </div>\n                        {isCongressDaoID && (\n                            <div className=\"mb-3\">\n                                <h5>Recipient</h5>\n                                <input\n                                    type=\"text\"\n                                    value={state.receiver_id}\n                                    onChange={(e) =>\n                                        onChangeRecipient(e.target.value)\n                                    }\n                                    placeholder=\"Specify target account\"\n                                />\n                            </div>\n                        )}\n                    </>\n                )}\n            </>\n        )}\n        {isCongressDaoID && state.powerType !== \"Unban\" && (\n            <div className=\"mb-3\">\n                <h5>Description</h5>\n                <Widget\n                    src=\"sking.near/widget/Common.Inputs.Markdown\"\n                    props={{\n                        value: state.description,\n                        onChange: (value) => onChangeDescription(value),\n                        height: \"270px\",\n                        initialText: defaultDescription\n                    }}\n                />\n            </div>\n        )}\n        {state.error && <div className=\"text-danger\">{state.error}</div>}\n        <div className=\"ms-auto\">\n            <Widget\n                src=\"sking.near/widget/Common.Button\"\n                props={{\n                    children: \"Propose Function Call\",\n                    onClick: handleFunctionCall,\n                    className: \"mt-2\",\n                    variant: \"success\"\n                }}\n            />\n            {onClose && (\n                <Widget\n                    src=\"sking.near/widget/Common.Button\"\n                    props={{\n                        children: \"Close\",\n                        onClick: onClose,\n                        className: \"mt-2\"\n                    }}\n                />\n            )}\n        </div>\n    </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/astraplusplus.ndctools.near/widget/DAO.Proposal.Create.FunctionCall", "fact_widget_deployments_id": "e9328735be5c85a6c171d4e563638ac6", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 15}