{"tx_hash": "BGiWYxnTVbhD3MhRPtGoASG6mgSwgzQbzZ1F4fGiYk2v", "action_id_social": "F5WyTYxyer9t6jRLZ8g5qQYypzuDCUTaFmQ5JaMXwYu7-0-widget", "block_id": 111601786, "block_timestamp": "2024-01-29T10:55:56.284Z", "signer_id": "astraplusplus.ndctools.near", "widget_name": "CreateDAO.Step4", "source_code": "const {\n  formState,\n  errors,\n  renderFooter,\n  showSteps,\n  isConfigScreen,\n  updateParentState\n} = props;\nconst { accountId } = context;\n\nupdateParentState || (updateParentState = () => {});\n\nconst initialAnswers = {\n  policy: formState.policy\n};\n\nconst [showAccountAutocompleteIndex, setShowAccountAutocompleteIndex] =\n  useState(null);\n\nfunction isNearAddress(address) {\n  const ACCOUNT_ID_REGEX =\n    /^(([a-z\\d]+[-_])*[a-z\\d]+\\.)*([a-z\\d]+[-_])*[a-z\\d]+$/;\n  return (\n    address.length >= 2 &&\n    address.length <= 64 &&\n    ACCOUNT_ID_REGEX.test(address)\n  );\n}\n\n// not using formState because, the formState doesn't match the ui state\n\nconst initialMembers = [];\n\nfor (const role of initialAnswers.policy.roles) {\n  if (!role.kind.Group) continue;\n  for (const member of role.kind.Group) {\n    initialMembers.push({\n      role: role.name,\n      name: member\n    });\n  }\n}\n\nconst initialState = {\n  roles: initialAnswers.policy.roles.length\n    ? initialAnswers.policy.roles.map((r) => r.name)\n    : [\"council\"],\n  members: initialMembers.length\n    ? initialMembers\n    : [{ role: \"council\", name: accountId }]\n};\n\nState.init({\n  answers: initialState,\n  error: null\n});\n\n// -- roles\nconst onAddEmptyRole = () => {\n  State.update({\n    answers: {\n      ...state.answers,\n      roles: [...state.answers.roles, \"\"]\n    }\n  });\n};\n\nconst onRemoveRole = (index) => {\n  State.update({\n    answers: {\n      ...state.answers,\n      roles: state.answers.roles.filter((role, i) => i !== index)\n    }\n  });\n};\n\nconst onSetRoleName = (index, name) => {\n  State.update({\n    answers: {\n      ...state.answers,\n      roles: state.answers.roles.map((role, i) => (i === index ? name : role))\n    }\n  });\n};\n\n// -- members\nconst onAddEmptyMember = () => {\n  setShowAccountAutocompleteIndex(null);\n  State.update({\n    answers: {\n      ...state.answers,\n      members: [\n        ...state.answers.members,\n        { name: \"\", role: state.answers.roles[1] }\n      ]\n    }\n  });\n};\n\nconst onRemoveMember = (index) => {\n  setShowAccountAutocompleteIndex(null);\n  State.update({\n    answers: {\n      ...state.answers,\n      members: state.answers.members.filter((member, i) => i !== index)\n    }\n  });\n};\n\nconst onSetMemberName = (index, name) => {\n  if (!isNearAddress(name)) {\n    State.update({\n      error: { [index]: \"Please add a valid near address.\" }\n    });\n  } else {\n    State.update({\n      error: null\n    });\n  }\n  State.update({\n    answers: {\n      ...state.answers,\n      members: state.answers.members.map((member, i) =>\n        i === index ? { ...member, name } : member\n      )\n    }\n  });\n};\n\nconst onSetMemberRole = (index, role) => {\n  State.update({\n    answers: {\n      ...state.answers,\n      members: state.answers.members.map((member, i) =>\n        i === index ? { ...member, role } : member\n      )\n    }\n  });\n};\n\n// Make the state back to formState format\nconst finalState = {\n  policy: {\n    ...formState.policy,\n    roles: state.answers.roles\n      .filter((role, i) => role !== null && role !== \"\")\n      .map((role, i) => {\n        return {\n          name: role,\n          kind: {\n            Group: state.answers.members\n              .filter((m) => m.role === role && m !== null && m.name !== \"\")\n              .map((m) => m.name)\n          },\n          permissions:\n            formState.policy.roles[i]?.permissions || role === \"council\"\n              ? [\"*:*\"]\n              : [],\n          vote_policy: formState.policy.roles[i]?.vote_policy || {}\n        };\n      })\n  }\n};\n\nuseEffect(() => {\n  let timeoutId;\n\n  // Debounced function to update parent state\n  const debouncedUpdate = (value) => {\n    clearTimeout(timeoutId);\n    timeoutId = setTimeout(() => {\n      updateParentState(value);\n    }, 300); // Adjust the debounce delay as needed\n  };\n\n  // Call the debounced function when local value changes\n  debouncedUpdate(finalState);\n\n  return () => {\n    // Cleanup on unmount\n    clearTimeout(timeoutId);\n  };\n}, [state.answers]);\n\nconst Container = styled.div`\n  .flex-1 {\n    flex: 1;\n  }\n`;\n\nreturn (\n  <Container className=\"mt-4 ndc-card p-4\">\n    <div className=\"d-flex flex-column gap-2\">\n      {showSteps && (\n        <h2 className=\"h5 fw-bold\">\n          <span\n            className=\"rounded-circle d-inline-flex align-items-center justify-content-center fw-bolder h5 me-2\"\n            style={{\n              width: \"48px\",\n              height: \"48px\",\n              border: \"1px solid #82E299\"\n            }}\n          >\n            4\n          </span>\n          Add Groups & Members\n        </h2>\n      )}\n      <div className=\"mb-3\">\n        <div className=\"d-flex gap-2 justify-content-between\">\n          <div>\n            <h3 className=\"h6 fw-bold\">Add Groups</h3>\n            <p className=\"text-black-50 fw-light small\">\n              Adding groups to DAO during creation is not supported using web\n              based wallets. Anyway, you can add more groups later in DAO\n              settings\n            </p>\n          </div>\n          <Widget\n            src=\"nearui.near/widget/Input.Button\"\n            props={{\n              children: <i className=\"bi bi-plus-lg\" />,\n              variant: \"icon info outline\",\n              size: \"lg\",\n              onClick: onAddEmptyRole\n            }}\n          />\n        </div>\n        {state.answers.roles.map((r, i) => (\n          <div\n            className={[\n              \"d-flex align-items-center gap-2 mt-2\",\n              r === null ? \"d-none\" : \"\"\n            ].join(\" \")}\n            key={i}\n          >\n            <Widget\n              src=\"nearui.near/widget/Input.ExperimentalText\"\n              props={{\n                placeholder: \"Group 1\",\n                size: \"lg\",\n                disabled: !isConfigScreen && i < 1,\n                value: r,\n                onChange: (v) => onSetRoleName(i, v),\n                error:\n                  errors.policy.roles[\n                    finalState.policy.roles.findIndex((role) => role.name === r)\n                  ].name,\n                inputProps: { defaultValue: r }\n              }}\n            />\n            {(isConfigScreen ? state.answers.roles.length > 1 : i >= 1) && (\n              <Widget\n                src=\"nearui.near/widget/Input.Button\"\n                props={{\n                  children: <i className=\"bi bi-trash\" />,\n                  variant: \"icon danger outline\",\n                  size: \"lg\",\n                  onClick: () => onRemoveRole(i)\n                }}\n              />\n            )}\n          </div>\n        ))}\n      </div>\n\n      <div>\n        <div className=\"d-flex gap-2 justify-content-between\">\n          <div>\n            <h3 className=\"h6 fw-bold\">Add Members</h3>\n            <p className=\"text-black-50 fw-light small\">\n              Add members to the DAO and set their{\" \"}\n              <a\n                href=\"\"\n                target=\"_blank\"\n                style={{\n                  color: \"#4498E0\"\n                }}\n              >\n                roles\n              </a>\n              .\n            </p>\n          </div>\n          <Widget\n            src=\"nearui.near/widget/Input.Button\"\n            props={{\n              children: <i className=\"bi bi-plus-lg\" />,\n              variant: \"icon info outline\",\n              size: \"lg\",\n              onClick: onAddEmptyMember\n            }}\n          />\n        </div>\n\n        {state.answers.members.map((member, i) => {\n          const trueRoleIndex =\n            member !== null &&\n            finalState.policy.roles.findIndex(\n              (role) => role.name === member.role\n            );\n          const trueMemberIndex =\n            member !== null &&\n            trueRoleIndex !== -1 &&\n            typeof finalState.policy.roles[trueRoleIndex].kind === \"object\"\n              ? finalState.policy.roles[trueRoleIndex].kind.Group.findIndex(\n                  (m) => m === member.name\n                )\n              : null;\n\n          return (\n            <div\n              className={[\n                \"d-flex gap-2 mt-2\",\n                member === null ? \"d-none\" : \"\"\n              ].join(\" \")}\n              key={i}\n            >\n              <div className=\"d-flex flex-column gap-2 flex-1\">\n                <Widget\n                  src=\"nearui.near/widget/Input.ExperimentalText\"\n                  props={{\n                    placeholder: \"user.near\",\n                    size: \"lg\",\n                    value: member.name,\n                    onChange: (v) => {\n                      if (showAccountAutocompleteIndex !== i) {\n                        setShowAccountAutocompleteIndex(i);\n                      }\n                      onSetMemberName(i, v);\n                    },\n                    disabled: !isConfigScreen && i === 0,\n                    error:\n                      state.error[i] ||\n                      (trueMemberIndex !== null &&\n                        errors.policy.roles[trueRoleIndex].kind.Group[\n                          trueMemberIndex\n                        ])\n                  }}\n                />\n                {showAccountAutocompleteIndex === i && (\n                  <Widget\n                    src=\"devhub.near/widget/devhub.components.molecule.AccountAutocomplete\"\n                    props={{\n                      term: member.name,\n                      onSelect: (v) => {\n                        onSetMemberName(i, v);\n                        setShowAccountAutocompleteIndex(null);\n                      },\n                      onClose: () => setShowAccountAutocompleteIndex(null)\n                    }}\n                  />\n                )}\n              </div>\n              <div className=\"flex-1\">\n                <Widget\n                  src=\"nearui.near/widget/Input.Select\"\n                  props={{\n                    placeholder: \"Role\",\n                    size: \"lg\",\n                    options: state.answers.roles\n                      .filter((r) => r !== null && r !== \"\")\n                      .map((r) => ({\n                        title: r,\n                        value: r\n                      })),\n                    value: member.role,\n                    onChange: (v) => onSetMemberRole(i, v),\n                    disabled: !isConfigScreen && i === 0\n                  }}\n                />\n              </div>\n              {(isConfigScreen ? state.answers.members.length > 1 : i >= 1) && (\n                <Widget\n                  src=\"nearui.near/widget/Input.Button\"\n                  props={{\n                    children: <i className=\"bi bi-trash\" />,\n                    variant: \"icon danger outline\",\n                    size: \"lg\",\n                    onClick: () => onRemoveMember(i)\n                  }}\n                />\n              )}\n            </div>\n          );\n        })}\n      </div>\n    </div>\n\n    {renderFooter(finalState)}\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/astraplusplus.ndctools.near/widget/CreateDAO.Step4", "fact_widget_deployments_id": "1825eace40da13065307eaee319df94e", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 11}