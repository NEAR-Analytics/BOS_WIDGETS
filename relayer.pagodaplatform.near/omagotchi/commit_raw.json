{"tx_hash": "GHEy2WDPrxhCSBPfLgSJjeeNQbuuqY2v2CZRZcCwBu2E", "action_id_social": "Eau3Pkm4vdm41pSbGgP3kD1iQo7qaxsJcUVzBg5H5phi-0-widget", "block_id": 108197407, "block_timestamp": "2023-12-17T20:53:46.698Z", "signer_id": "relayer.pagodaplatform.near", "widget_name": "omagotchi", "source_code": null, "metadata": null, "branch": {"draft": {"": "const CHAIN_IDS = {\n  BITKUB_TESTNET: 25925,\n  ETH_JFIN: 3502,\n};\n\nconst SUPPORT_CHAIN = [\n  {\n    chainIdNumber: CHAIN_IDS.BITKUB_TESTNET,\n    chainName: \"Bitkub Chain Testnet\",\n    chainId: \"0x\" + CHAIN_IDS.BITKUB_TESTNET.toString(16),\n    rpcUrl: [\"https://rpc-testnet.bitkubchain.io\"],\n    currencySymbol: \"tKUB\",\n    nativeCurrency: {\n      name: \"Ethereum\",\n      symbol: \"ETH\",\n      decimals: 18,\n    },\n  },\n  {\n    chainIdNumber: CHAIN_IDS.ETH_JFIN,\n    chainName: \"JFIN Chain\",\n    chainId: \"0x\" + CHAIN_IDS.ETH_JFIN.toString(16),\n    rpcUrl: [\"https://rpc.testnet.jfinchain.com\"],\n    currencySymbol: \"jfin\",\n    nativeCurrency: {\n      name: \"Ethereum\",\n      symbol: \"ETH\",\n      decimals: 18,\n    },\n  },\n];\n\nconst CONTRACT_ADDRESS = \"0xD2f7f5F32e0CEf1900E1Fe9e19fA71c9Fbb5B0a9\";\n\nconst ABI = [\n  {\n    inputs: [\n      {\n        internalType: \"address\",\n        name: \"owner\",\n        type: \"address\",\n      },\n    ],\n    name: \"balanceOf\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [],\n    name: \"faucet\",\n    outputs: [],\n    stateMutability: \"nonpayable\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"address\",\n        name: \"owner\",\n        type: \"address\",\n      },\n      {\n        internalType: \"uint256\",\n        name: \"index\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"tokenOfOwnerByIndex\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"uint256\",\n        name: \"tokenId\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"tokenURI\",\n    outputs: [\n      {\n        internalType: \"string\",\n        name: \"\",\n        type: \"string\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"uint256\",\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"cards\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"tokenId\",\n        type: \"uint256\",\n      },\n      {\n        internalType: \"enum MonsterLib.MonsterState\",\n        name: \"state\",\n        type: \"uint8\",\n      },\n      {\n        components: [\n          {\n            internalType: \"string\",\n            name: \"name\",\n            type: \"string\",\n          },\n          {\n            internalType: \"string\",\n            name: \"teenagerURI\",\n            type: \"string\",\n          },\n          {\n            internalType: \"string\",\n            name: \"adultURI\",\n            type: \"string\",\n          },\n          {\n            internalType: \"uint256\",\n            name: \"power\",\n            type: \"uint256\",\n          },\n          {\n            internalType: \"uint8\",\n            name: \"version\",\n            type: \"uint8\",\n          },\n        ],\n        internalType: \"struct MonsterLib.Monster\",\n        name: \"monster\",\n        type: \"tuple\",\n      },\n      {\n        internalType: \"uint256\",\n        name: \"exp\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"uint256\",\n        name: \"tokenId\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"feed\",\n    outputs: [],\n    stateMutability: \"payable\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"uint256\",\n        name: \"tokenId\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"play\",\n    outputs: [],\n    stateMutability: \"payable\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"uint256\",\n        name: \"tokenId\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"evolve\",\n    outputs: [],\n    stateMutability: \"nonpayable\",\n    type: \"function\",\n  },\n];\n\nconst MONSTER_STATE = {\n  0: \"Larva\",\n  1: \"Teenager\",\n  2: \"Adult\",\n};\n\nconst Container = styled.div`\n  margin-top: 5px;\n  width: 800px;\n  height: 800px;\n  outline: 5px solid rgba(0, 0, 0, 1);\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  align-items: center;\n`;\n\nconst GameContainer = styled.div`\n  position: relative;\n  width: 100%;\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  justify-content: space-between;\n  align-items: center;\n  padding: 10px;\n`;\n\nconst Background = styled.div`\n  position: absolute;\n  top: 0;\n  left: 0;\n  z-index: -1;\n`;\n\nconst SelectContainer = styled.div`\n  width: 100%;\n`;\n\nconst StatCardContainer = styled.div`\n  width: 100%;\n`;\n\nconst StatContainer = styled.div`\n  background-color: #ffffff;\n\n  h3 {\n    font-size: 18px;\n    line-height: 1.5;\n    font-weight: 800;\n  }\n\n  p {\n    font-size: 10px;\n    line-height: 1;\n    font-weight: 800;\n  }\n`;\n\nconst ActionButton = styled.div`\n  display: flex;\n  gap: 6px;\n  margin-top: 10px;\n`;\n\nconst ActionContainer = styled.div`\n  position: absolute;\n  bottom: 50%;\n  right: 55%;\n`;\n\n// State\n\nconst [walletAddress, setWalletAddress] = useState(\"\");\nconst [chainId, setChainId] = useState(\"\");\nconst [showLoader, setIsShowLoader] = useState(true);\nconst [isFauceting, setIsFauceting] = useState(false);\nconst [isError, setIsError] = useState(false);\nconst [nftOptions, setNftOptions] = useState([]);\nconst [selectedNft, setSelectedNft] = useState(null);\nconst [isFeeding, setIsFeeding] = useState(false);\nconst [isPlaying, setIsPlaying] = useState(false);\nconst [isEvolving, setIsEvolving] = useState(false);\n\nconst disableActionButton = isFeeding || isPlaying || isEvolving;\n\nfunction handleSetupSignerInfo() {\n  const addressPromise = Ethers.provider()\n    .getSigner()\n    .getAddress()\n    .then((address) => address);\n\n  const chainPromise = Ethers.provider()\n    .getNetwork()\n    .then((chain) => chain);\n\n  Promise.all([chainPromise, addressPromise]).then(([chain, address]) => {\n    setWalletAddress(address);\n    setChainId(chain.chainId);\n    setIsShowLoader(false);\n  });\n}\n\nfunction isSupportChain(targetChainId) {\n  return Object.values(CHAIN_IDS).includes(targetChainId);\n}\n\nfunction handleSwitchChain(chainId) {\n  Ethers.send(\"wallet_switchEthereumChain\", [{ chainId }]);\n}\n\nfunction getContract() {\n  const signer = Ethers.provider().getSigner();\n  const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);\n  return contract;\n}\n\nfunction faucetNft() {\n  setIsFauceting(true);\n  const contract = getContract();\n  contract\n    .faucet()\n    .then((tx) => {\n      tx.wait()\n        .catch((error) => {\n          throw error;\n        })\n        .finally(() => setIsFauceting(false));\n    })\n    .catch((error) => {\n      console.error(error);\n      setIsError(true);\n    });\n}\n\nfunction getNftOptions(totalNft, walletAddress) {\n  const contract = getContract();\n  const promises = [];\n\n  for (let i = 0; i < totalNft; i++) {\n    const promise = contract.callStatic\n      .tokenOfOwnerByIndex(walletAddress, i)\n      .then((tokenId) => tokenId.toNumber());\n    promises.push(promise);\n  }\n\n  Promise.all(promises)\n    .then((nftOptions) => {\n      const options = nftOptions.map((option) => {\n        const opt = getNftDetail(option).then(([stat, uri]) => {\n          const detail = fetch(uri).body;\n          return {\n            label: `${detail.name} #${option}`,\n            value: option,\n          };\n        });\n        return opt;\n      });\n      return Promise.all(options);\n    })\n    .then((detailedOptions) => {\n      setNftOptions(detailedOptions);\n    })\n    .catch((error) => {\n      console.error(\"Error:\", error);\n      setIsError(true);\n    })\n    .finally(() => setIsShowLoader(false));\n}\n\nfunction getNftDetail(tokenId) {\n  const contract = getContract();\n  const statPromise = contract.cards(tokenId).then((cardDetails) => {\n    const result = {\n      tokenId: cardDetails[0].toNumber(),\n      state: cardDetails[1],\n      monster: {\n        name: cardDetails[2][0],\n        teenagerURI: cardDetails[2][1],\n        adultURI: cardDetails[2][2],\n        power: cardDetails[2][3].toNumber(),\n        version: cardDetails[2][4],\n      },\n      exp: cardDetails[3].toNumber(),\n    };\n    return result;\n  });\n\n  const tokenUriPromise = contract.tokenURI(tokenId).then((tokenUri) => {\n    return tokenUri;\n  });\n\n  return Promise.all([statPromise, tokenUriPromise]);\n}\n\nfunction onSelectNft(e) {\n  if (!!e.target.value || !disableActionButton) {\n    setIsShowLoader(true);\n    getNftDetail(e.target.value)\n      .then(([stat, uri]) => {\n        const detail = fetch(uri).body;\n        setSelectedNft({\n          detail,\n          stat,\n        });\n      })\n      .catch((error) => {\n        console.error(error);\n        setIsError(error);\n      })\n      .finally(() => setIsShowLoader(false));\n  }\n}\n\nfunction feedMonster() {\n  if (disableActionButton) return;\n  setIsFeeding(true);\n  const contract = getContract();\n\n  const amountToSendInEther = \"0.1\";\n  const options = {\n    value: ethers.utils.parseEther(amountToSendInEther),\n  };\n\n  contract\n    .feed(selectedNft.stat.tokenId, options)\n    .then((tx) => {\n      tx.wait()\n        .then(() => {\n          getNftDetail(e.target.value)\n            .then(([stat, uri]) => {\n              const detail = fetch(uri).body;\n              console.log(\"feeded\");\n              setSelectedNft({\n                detail,\n                stat,\n              });\n              setIsFeeding(false);\n            })\n            .catch((error) => {\n              console.error(error);\n              setIsError(true);\n            });\n        })\n        .catch((error) => {\n          console.error(error);\n          setIsError(true);\n        });\n    })\n    .catch((error) => {\n      console.error(error);\n      setIsError(true);\n    });\n}\n\nfunction playMonster() {\n  if (disableActionButton) return;\n  setIsPlaying(true);\n  const contract = getContract();\n\n  const amountToSendInEther = \"0.1\";\n  const options = {\n    value: ethers.utils.parseEther(amountToSendInEther),\n  };\n\n  contract\n    .play(selectedNft.stat.tokenId, options)\n    .then((tx) => {\n      tx.wait()\n        .then(() => {\n          getNftDetail(e.target.value)\n            .then(([stat, uri]) => {\n              const detail = fetch(uri).body;\n              console.log(\"feeded\");\n              setSelectedNft({\n                detail,\n                stat,\n              });\n              setIsPlaying(false);\n            })\n            .catch((error) => {\n              console.error(error);\n              setIsError(true);\n            });\n        })\n        .catch((error) => {\n          console.error(error);\n          setIsError(true);\n        });\n    })\n    .catch((error) => {\n      console.error(error);\n      setIsError(true);\n    });\n}\n\nfunction evolveMonster() {\n  if (disableActionButton) return;\n  setIsEvolving(true);\n  const contract = getContract();\n\n  const amountToSendInEther = \"0.1\";\n  const options = {\n    value: ethers.utils.parseEther(amountToSendInEther),\n  };\n\n  contract\n    .evolve(selectedNft.stat.tokenId, options)\n    .then((tx) => {\n      tx.wait()\n        .then(() => {\n          getNftDetail(e.target.value)\n            .then(([stat, uri]) => {\n              const detail = fetch(uri).body;\n              console.log(\"evolve\");\n              setSelectedNft({\n                detail,\n                stat,\n              });\n              setIsEvolving(false);\n            })\n            .catch((error) => {\n              console.error(error);\n              setIsError(true);\n            });\n        })\n        .catch((error) => {\n          console.error(error);\n          setIsError(true);\n        });\n    })\n    .catch((error) => {\n      console.error(error);\n      setIsError(true);\n    });\n}\n\nfunction backgroundSelector() {\n  if (selectedNft.stat.state === 2) {\n    return \"arena\";\n  }\n\n  const backgrounds = [\n    \"necromancer-lab\",\n    \"city-square\",\n    \"forest\",\n    \"magical-forest\",\n  ];\n  const randomNumber = Math.floor(Math.random() * backgrounds.length);\n  return backgrounds[randomNumber];\n}\n\nuseEffect(() => {\n  handleSetupSignerInfo();\n}, []);\n\nuseEffect(() => {\n  if (walletAddress && isSupportChain(chainId) && !isFauceting) {\n    setIsShowLoader(true);\n    const contract = getContract();\n    contract\n      .balanceOf(walletAddress)\n      .then((balance) => {\n        const totalNft = balance.toNumber();\n        getNftOptions(totalNft, walletAddress);\n      })\n      .catch((error) => {\n        console.error(\"Error:\", error);\n        setIsError(true);\n      });\n  }\n}, [walletAddress, chainId, isFauceting]);\n\nfunction Router() {\n  if (showLoader || isFauceting) {\n    return <p>Loading...</p>;\n  }\n\n  if (!walletAddress) {\n    return <Widget src=\"a3r0nz.near/widget/Omagotji-WalletConnectButton\" />;\n  }\n\n  if (!isSupportChain(chainId)) {\n    return (\n      <>\n        <p>You are on the wrong chain please switch to supported chain.</p>\n        {SUPPORT_CHAIN.map((chain) => (\n          <button onClick={() => handleSwitchChain(chain.chainId)}>\n            Switch to {chain.chainName}\n          </button>\n        ))}\n      </>\n    );\n  }\n\n  if (!selectedNft) {\n    return (\n      <div>\n        <div>Select your nft to start</div>\n        <Widget\n          src=\"a3r0nz.near/widget/Omagotji-Select\"\n          props={{\n            selectPlaceholder: \"Select NFT\",\n            options: nftOptions,\n            onChange: (e) => onSelectNft(e),\n          }}\n        />\n        <div>Don\u2019t have NFT ?</div>\n        <div onClick={() => faucetNft()}>\n          <Widget\n            src=\"a3r0nz.near/widget/Omagotji-GeneralButton\"\n            props={{ label: \"Faucet\" }}\n          />\n        </div>\n      </div>\n    );\n  }\n\n  console.log(selectedNft);\n\n  return (\n    <>\n      <GameContainer>\n        <ActionContainer>\n          {isFeeding && (\n            <Widget\n              src=\"a3r0nz.near/widget/Omagotji-ActionAnimation\"\n              props={{ action: \"feed\" }}\n            />\n          )}\n          {isPlaying && (\n            <Widget\n              src=\"a3r0nz.near/widget/Omagotji-ActionAnimation\"\n              props={{ action: \"play\" }}\n            />\n          )}\n        </ActionContainer>\n        <Background>\n          <Widget\n            src=\"a3r0nz.near/widget/Omagotji-Scene\"\n            props={{ scene: backgroundSelector() }}\n          />\n        </Background>\n        <SelectContainer>\n          <Widget\n            src=\"a3r0nz.near/widget/Omagotji-Select\"\n            props={{\n              selectPlaceholder: `${selectedNft.detail.name} #${selectedNft.stat.tokenId}`,\n              options: nftOptions,\n              onChange: (e) => onSelectNft(e),\n            }}\n          />\n        </SelectContainer>\n        <img src={selectedNft.detail.image} width={200} height={200} />\n        <StatCardContainer>\n          <Widget\n            src=\"a3r0nz.near/widget/Omagotji-Card\"\n            props={{\n              children: (\n                <StatContainer>\n                  <h3>{selectedNft.detail.name}</h3>\n                  <p>State: {MONSTER_STATE[selectedNft.stat.state]}</p>\n                  <p>Monster EXP ({selectedNft.stat.exp}/100)</p>\n                  <Widget\n                    src=\"a3r0nz.near/widget/Omagotji-ProgressBar\"\n                    props={{ percent: selectedNft.stat.exp, height: 20 }}\n                  />\n                  <ActionButton>\n                    <div onClick={() => feedMonster()}>\n                      <Widget\n                        src=\"a3r0nz.near/widget/Omagotji-GeneralButton\"\n                        props={{ label: \"Feed Him\", color: \"primary\" }}\n                      />\n                    </div>\n                    <div onClick={() => playMonster()}>\n                      <Widget\n                        src=\"a3r0nz.near/widget/Omagotji-GeneralButton\"\n                        props={{ label: \"Play with Him\", color: \"primary\" }}\n                      />\n                    </div>\n                    <div onClick={() => {}}>\n                      <Widget\n                        src=\"a3r0nz.near/widget/Omagotji-GeneralButton\"\n                        props={{ label: \"Evolve\", color: \"primary\" }}\n                      />\n                    </div>\n                  </ActionButton>\n                </StatContainer>\n              ),\n            }}\n          />\n        </StatCardContainer>\n      </GameContainer>\n    </>\n  );\n}\n\nif (isError) {\n  return <>error</>;\n}\n\nreturn (\n  <Container>\n    <Router />\n  </Container>\n);\n"}}, "widget_modules_used": null, "widget_url": "https://near.social/#/relayer.pagodaplatform.near/widget/omagotchi", "fact_widget_deployments_id": "76dd2060a515e3ee17db0e08925f2674", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}