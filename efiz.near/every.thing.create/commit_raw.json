{"tx_hash": "86h1ChWNBK1WYdtVv6PyRLisQrkFhWnqt1oE98kPYXLk", "action_id_social": "5SV8JbEmX1Yz9VtXEsSacqzL1TSKbceWkfD7dWsW6V8p-0-widget", "block_id": 93621109, "block_timestamp": "2023-06-06T23:49:09.653Z", "signer_id": "efiz.near", "widget_name": "every.thing.create", "source_code": "const postThing = props.postThing;\nconst availableTypes =\n  JSON.parse(props.availableTypes) ||\n  Social.get(\"every.near/type/**\", \"final\") ||\n  [];\n\nconst types = Social.get(\"every.near/type/**\", \"final\");\ntypes = Object.keys(types).map((it) => `every.near/type/${it}`);\n\n// const type = props.type || \"\";\n// if (availableTypes.length === 1) {\n//   type = availableTypes[0];\n// }\n\nlet type;\n\navailableTypes = types;\nState.init({\n  selectedType: \"\",\n  expanded: false,\n});\n\nfunction extractMentions(text) {\n  const mentionRegex =\n    /@((?:(?:[a-z\\d]+[-_])*[a-z\\d]+\\.)*(?:[a-z\\d]+[-_])*[a-z\\d]+)/gi;\n  mentionRegex.lastIndex = 0;\n  const accountIds = new Set();\n  for (const match of text.matchAll(mentionRegex)) {\n    if (\n      !/[\\w`]/.test(match.input.charAt(match.index - 1)) &&\n      !/[/\\w`]/.test(match.input.charAt(match.index + match[0].length)) &&\n      match[1].length >= 2 &&\n      match[1].length <= 64\n    ) {\n      accountIds.add(match[1].toLowerCase());\n    }\n  }\n  return [...accountIds];\n}\n\nfunction extractTagNotifications(text, item) {\n  return extractMentions(text || \"\")\n    .filter((accountId) => accountId !== context.accountId)\n    .map((accountId) => ({\n      key: accountId,\n      value: {\n        type: \"mention\",\n        item,\n      },\n    }));\n}\n\nconst composeData = () => {\n  // generate a random id\n  const thingId = state.thingId || Math.random();\n  const data = {\n    thing: {\n      ...state.extra,\n      [thingId]: JSON.stringify({\n        data: state.thing,\n        type: state.selectedType,\n      }),\n    },\n    index: {\n      thing: JSON.stringify({\n        key: thingId,\n        value: {\n          type: state.selectedType,\n        },\n      }),\n    },\n  };\n\n  // TODO: What other types can we extract mentions from?\n  // How can this be better associated with the type?\n  if (state.selectedType === \"md\") {\n    const notifications = extractTagNotifications(state.thing.text, {\n      type: \"social\",\n      path: `${context.accountId}/thing/${thingId}`,\n    });\n\n    if (notifications.length) {\n      data.index.notify = JSON.stringify(\n        notifications.length > 1 ? notifications : notifications[0]\n      );\n    }\n  }\n\n  if (postThing) {\n    data = postThing(data);\n  }\n  return data;\n};\n\nconst Container = styled.div`\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n`;\n\nconst Row = styled.div`\n  display: flex;\n  align-items: center;\n  margin-bottom: 10px;\n  width: 100%;\n`;\n\nconst SwitchButton = styled.button`\n  padding: 5px 10px;\n  background-color: ${({ active }) => (active ? \"#5fba7d\" : \"#ccc\")};\n  color: white;\n  border: none;\n  border-radius: 4px;\n  cursor: pointer;\n`;\n\nconst ButtonContainer = styled.div`\n  display: flex;\n  align-items: center;\n  width: 100px;\n`;\n\nconst TextContainer = styled.div`\n    margin-left: 4px;\n`;\n\nconst FormContainer = styled.div`\n  margin: 20px;\n`;\n\nconst Select = styled.select`\n  height: 30px;\n  width: 300px;\n`;\n\nconst Button = styled.button`\n  height: 30px;\n`;\n\nconst Text = styled.p`\n  display: inline-block;\n  margin-right: 10px;\n`;\n\nconst Input = styled.input`\n  width: 300px;\n  height: 30px;\n`;\n\nconst handleTypeChange = (e) => {\n  State.update({ selectedType: e.target.value });\n};\n\nif (state.selectedType !== \"\") {\n  type = JSON.parse(Social.get(state.selectedType, \"final\") || null);\n  if (type === null) {\n    return <></>;\n  }\n}\n\nconst handleThingData = (value, extra) => {\n  State.update({ thing: value, extra });\n};\n\nfunction RenderTypeCreate() {\n  const properties = type.properties || [];\n\n  const handleInputChange = (name, value) => {\n    handleThingData({ [name]: value });\n  };\n\n  function Property({ item }) {\n    if (item.type === \"string\") {\n      return (\n        <Input\n          key={item.name}\n          onChange={(e) => handleInputChange(item.name, e.target.value)}\n          value={state[item.name] || \"\"}\n          placeholder={item.name}\n        />\n      );\n    } else if (item.type === \"boolean\") {\n      return (\n        <Select\n          key={item.name}\n          onChange={(e) => handleInputChange(item.name, e.target.value)}\n          value={state[item.name] || \"\"}\n        >\n          <option value=\"true\">true</option>\n          <option value=\"false\">false</option>\n        </Select>\n      );\n    } else if (item.type === \"number\") {\n      return (\n        <Input\n          key={item.name}\n          type=\"number\"\n          onChange={(e) =>\n            handleInputChange(item.name, parseInt(e.target.value, 10))\n          }\n          value={state[item.name] || \"\"}\n          placeholder={item.name}\n        />\n      );\n    } else {\n      const itemType = JSON.parse(Social.get(item.type, \"final\") || \"null\");\n      const widgetSrc = itemType?.widgets?.create;\n      // it would be great to modify the onChange function\n      return <Widget src={widgetSrc} onChange={onChange} />;\n    }\n  }\n\n  return (\n    <Container>\n      {properties.map((item) => (\n        <Property item={item} />\n      ))}\n    </Container>\n  );\n\n  if (state.selectedType !== \"\") {\n    return (\n      <Widget\n        src={type?.widgets?.create}\n        props={{ onChange: handleThingData, type }} // onChange\n      />\n    );\n  }\n}\n\nreturn (\n  <>\n    <Container>\n      {props.type === undefined && availableTypes.length !== 1 ? (\n        <>\n          <Row>\n            <TextContainer>create a thing of type:</TextContainer>\n          </Row>\n          <Row>\n            <Select value={state.selectedType} onChange={handleTypeChange}>\n              <option value=\"\">Select a type</option>\n              {availableTypes.map((it) => (\n                <option value={it} key={it}>\n                  {it}\n                </option>\n              ))}\n            </Select>\n          </Row>\n        </>\n      ) : null}\n\n      <RenderTypeCreate />\n    </Container>\n    <Button onClick={() => State.update({ expanded: !state.expanded })}>\n      optional {state.expanded ? \"-\" : \"+\"}\n    </Button>\n    <Row>\n      {state.expanded ? (\n        <>\n          <Input\n            onChange={(e) => State.update({ thingId: e.target.value })}\n            placeholder=\"file name\"\n          />\n        </>\n      ) : null}\n    </Row>\n    <CommitButton\n      force\n      data={composeData()}\n      disabled={!state.thing}\n      className=\"styless\"\n    >\n      create\n    </CommitButton>\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/efiz.near/widget/every.thing.create", "fact_widget_deployments_id": "5a2e054bee90bdfa227d23d15120157b", "inserted_timestamp": "2000-01-01T00:00:00.000Z", "modified_timestamp": "2000-01-01T00:00:00.000Z", "__row_index": 4}