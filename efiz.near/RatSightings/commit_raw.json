{"tx_hash": "6H1wpQnDVXPy3b9ewZsLY5sDRDZo8kWz9mUyWNZy3CuY", "action_id_social": "Ga72HTz6NmoB25f4TJdQ3tYHF6H1dYzzKPYJsJd1bXBd-0-widget", "block_id": 104411197, "block_timestamp": "2023-10-28T20:15:10.767Z", "signer_id": "efiz.near", "widget_name": "RatSightings", "source_code": "const dataTemp = fetch(\"https://data.cityofnewyork.us/resource/3q43-55fe.json\");\nconst data1 = dataTemp?.body;\n\n// const dataDic = {}\nconst dataDic = [];\ndata1.forEach((item) => {\n  const obj = {\n    address: item.incident_address,\n    id: item.unique_key,\n    lng: item.longitude,\n    lat: item.latitude,\n    descriptor: item.descriptor,\n    incident_zip: item.incident_zip,\n    x_coordinate_state_plane_: item.x_coordinate_state_plane_,\n    created_date: item.created_date,\n    city: item.city,\n    intersection_street_1: item.intersection_street_1,\n    landmark: item.landmark,\n    y_coordinate_state_plane_: item.y_coordinate_state_plane_,\n    agency_name: item.agency_name,\n    location_type: item.location_type,\n    cross_street_1: item.cross_street_1,\n    community_board: item.community_board,\n    agency: item.agency,\n    park_borough: item.park_borough,\n    borough: item.borough,\n    street_name: item.street_name,\n    complaint_type: item.complaint_type,\n    address_type: item.address_type,\n    intersection_street_2: item.intersection_street_2,\n  };\n  dataDic.push(obj);\n  // if (!dataDic[incident_address]) {\n  //   dataDic[incident_address] = obj\n  //   dataDic[incident_address].count = 1\n  // } else {\n  //   dataDic[incident_address].count++\n  // }\n});\n\nconst data = [\n  {\n    address: \"2136 FREDRICK DOUGLAS BOULEVARD\",\n    id: \"59221403\",\n    lng: -73.95566524448962,\n    lat: 40.80400000828247,\n  },\n  {\n    address: \"219 SPENCER STREET\",\n    id: \"2\",\n    lng: -73.95459320290446,\n    lat: 40.6917064422596,\n  },\n];\n\nconst reviews = [\n  {\n    id: \"1\",\n    author: \"bear.near\",\n    description: \"This bulding has rats\",\n    img: {\n      url: \"https://cloudflare-ipfs.com/ipfs/QmQqzMTavQgT4f4T5v6PWBp7XNKtoPmC9jvn12WPT3gkSE\",\n    },\n  },\n  {\n    id: \"2\",\n    author: \"jay.near\",\n    description: \"This bulding has more rats\",\n    img: {\n      url: \"https://cloudflare-ipfs.com/ipfs/QmQqzMTavQgT4f4T5v6PWBp7XNKtoPmC9jvn12WPT3gkSE\",\n    },\n  },\n];\nconst myData = [\n  {\n    id: \"1\",\n    lng: -73.93799209472691,\n    lat: 40.70073671683767,\n  },\n];\n\nconst markers = Social.get(`*/thing/reviewMarker`, \"final\", {\n  subscribe: \"true\",\n});\n\nif (!markers) {\n  return <></>;\n}\nconst dataMap = {};\n\nObject.keys(markers).forEach((accountId) => {\n  if (markers[accountId].thing && markers[accountId].thing.reviewMarker) {\n    const markerObj = JSON.parse(markers[accountId].thing.reviewMarker);\n    dataMap[accountId] = { accountId, ...markerObj };\n  }\n});\n\nState.init({\n  img: \"\",\n  locations: [],\n  description: \"\",\n  edit: false,\n  currentLocation: (dataMap[accountId] && dataMap[accountId].coordinates) || {},\n});\n\nconst handleSave = () => {\n  const data = {\n    post: {\n      main: JSON.stringify({\n        description: state.description,\n        img: state.img,\n        id: state.currentLocation.id,\n      }),\n    },\n    index: {\n      post: JSON.stringify({\n        key: state.currentLocation.id,\n        value: {\n          type: \"md\",\n        },\n      }),\n    },\n  };\n\n  Social.set(data, {\n    force: true,\n    onCommit: () => {\n      State.update({ edit: false, showForm: false, showInspect: false });\n    },\n    onCancel: () =>\n      State.update({ edit: false, showForm: false, showInspect: false }),\n  });\n};\n\n// IMAGEUPLOADER\nconst uploadFileUpdateState = (body) => {\n  asyncFetch(\"https://ipfs.near.social/add\", {\n    method: \"POST\",\n    headers: { Accept: \"application/json\" },\n    body,\n  }).then((res) => {\n    const cid = res.body.cid;\n    State.update({ img: { cid } });\n  });\n};\nconst filesOnChange = (files) => {\n  if (files) {\n    State.update({ img: { uploading: true, cid: null } });\n    uploadFileUpdateState(files[0]);\n  }\n};\n\n// Inspect is a local component\nfunction Inspect(p) {\n  const { Feed } = VM.require(\"devs.near/widget/Module.Feed\");\n  Feed = Feed || (() => <></>); // make sure you have this or else it can break\n\n  return (\n    <div\n      style={{\n        backgroundColor: \"white\",\n        padding: \"1rem\",\n        height: \"750px\",\n        overflowY: \"scroll\",\n        paddingBottom: \"5rem\",\n      }}\n    >\n      <p>{p.address}</p>\n      <pre>{JSON.stringify(p, null, 2)}</pre>\n      <h2 style={{ fontSize: \"25px\", fontWeight: \"bold\" }}>Reviews</h2>\n      <Feed\n        index={{\n          action: \"post\",\n          key: state.currentLocation.id,\n          options: {\n            limit: 10,\n            order: \"desc\",\n            accountId: undefined,\n          },\n        }}\n        Item={(p) => {\n          console.log(\"__p:\", p);\n          const id = state.currentLocation.id;\n          return <Widget src=\"rats.near/widget/card\" props={p} />;\n        }}\n      />\n    </div>\n  );\n}\n\nfunction Form({ data }) {\n  // const loc = fetch(\n  //   'https://api.geoapify.com/v1/ipinfo?&apiKey=0485481476634b4d98f7d337d4821f52',\n  // )\n  // if (loc.ok) {\n  //   const location = loc.body.location\n  //   console.log('\ud83d\ude80 ~ file: myMap.jsx:38 ~ Form ~ location:', location)\n  // }\n\n  const formContainerStyle = {\n    display: \"flex\",\n    flexDirection: \"column\",\n    alignItems: \"center\",\n  };\n  const descriptionTextareaStyle = {\n    width: \"100%\",\n    height: \"100px\", // Adjust the height as needed\n    padding: \"10px\",\n    margin: \"10px 0\",\n    border: \"1px solid #ccc\",\n    borderRadius: \"5px\",\n  };\n\n  const formTitleStyle = {\n    fontSize: \"24px\",\n    paddingTop: \"1rem\",\n  };\n\n  const descriptionInputStyle = {\n    width: \"100%\",\n    padding: \"10px\",\n    margin: \"10px 0\",\n    border: \"1px solid #ccc\",\n    borderRadius: \"5px\",\n  };\n\n  const saveButtonStyle = {\n    background: \"#007bff\",\n    color: \"white\",\n    border: \"none\",\n    padding: \"10px 20px\",\n    borderRadius: \"5px\",\n    cursor: \"pointer\",\n  };\n\n  return (\n    <div style={{ backgroundColor: \"white\", padding: \"1rem\" }}>\n      <h1 style={formTitleStyle}>Submit Ticket</h1>\n      {/* UPLODER */}\n      <div className=\"d-inline-block\">\n        {state.img ? (\n          <img\n            class=\"rounded w-100 h-100\"\n            style={{ objectFit: \"cover\" }}\n            src={`https://ipfs.near.social/ipfs/${state.img.cid}`}\n            alt=\"upload preview\"\n          />\n        ) : (\n          \"\"\n        )}\n        <Files\n          multiple={false}\n          accepts={[\"image/*\"]}\n          minFileSize={1}\n          clickable\n          className=\"btn btn-outline-primary\"\n          onChange={filesOnChange}\n        >\n          {state.img?.uploading ? <> Uploading </> : \"Upload an Image\"}\n        </Files>\n      </div>\n\n      {/* FORM */}\n      <textarea\n        style={descriptionTextareaStyle}\n        placeholder=\"Enter description\"\n        value={description}\n        onChange={(e) => State.update({ description: e.target.value })}\n      ></textarea>\n      <button style={saveButtonStyle} onClick={handleSave}>\n        Save\n      </button>\n      {/*\n      <h1>Form</h1>\n      <pre>{JSON.stringify(data, null, 2)}</pre>\n      <button onClick={() => handleSave('hello')}>Save</button> */}\n    </div>\n  );\n}\n\nreturn (\n  <Widget\n    src=\"byalbert.near/widget/Map.index\"\n    props={{\n      markerAsset: \"https://cdn-icons-png.flaticon.com/512/47/47240.png\",\n      reviewData: reviews,\n      markers: dataDic,\n      myMarkers: myData,\n      onMapClick: (e) => console.log(\"map click\", e),\n      onMarkerClick: (e) => {\n        // onclick pass address & query supabase, return everything from reports  where  address = passedAddress\n        // get the data and display using reviews widget\n        State.update({\n          currentLocation: e,\n        });\n        console.log(\"state.currentLocation.id,\", e);\n        // console.log('marker click___', e)\n      },\n      inspect: (p) => <Inspect {...p} />,\n      form: (p) => <Form {...p} />,\n    }}\n  />\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/efiz.near/widget/RatSightings", "fact_widget_deployments_id": "caa60413d1d27a92ed4932c91dc6afdd", "inserted_timestamp": "2023-10-28T22:20:52.687Z", "modified_timestamp": "2023-10-28T22:20:52.687Z", "__row_index": 0}