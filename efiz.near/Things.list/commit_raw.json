{"tx_hash": "B7MrjvRjZKCgJrPKJYYoF7ejszPRJDtySevbFYsDdk7c", "action_id_social": "XWzHFxLwCMajmcZTL6XFebDgnvzNHcWL8ML2XnbwN88-0-widget", "block_id": 99273656, "block_timestamp": "2023-08-20T22:31:16.228Z", "signer_id": "efiz.near", "widget_name": "Things.list", "source_code": "const currentPage = (props.page && parseInt(props.page)) || 1;\nconst resPerPage = props.resPerPage ?? 16;\nconst typeName = props.typeName || \"widget\";\nconst metadataTemplate = props.metadataTemplate || \"efiz.near/widget/docs.card\";\n\nState.init({\n  currentPage: currentPage,\n  search: null,\n  selectedOption: \"all\",\n  accountId: props.accountId || null,\n  tag: props.tag || null,\n});\n\nfunction handleFilter({ accountId, tag }) {\n  if (tag && state.selectedOption === \"all\") {\n    // this is a hack for now\n    State.update({\n      accountId,\n      tag,\n      selectedOption: \"taggedByCreator\",\n      filtersOpen: false,\n      currentPage: 1,\n    });\n  } else {\n    State.update({ accountId, tag, filtersOpen: false, currentPage: 1 });\n  }\n}\n\nconst handleRadioChange = (event) => {\n  State.update({ selectedOption: event.target.value, filtersOpen: false });\n};\n\nconst renderSubheader = () => (\n  <div className=\"d-flex align-items-center gap-2 mt-4\">\n    <Widget\n      key=\"search\"\n      src=\"nui.sking.near/widget/Input.Text\"\n      props={{\n        placeholder: \"Search by name\",\n        type: \"search\",\n        size: \"md\",\n        icon: (\n          <i\n            className=\"bi bi-search\"\n            style={{\n              color: \"#4498E0\",\n            }}\n          />\n        ),\n        onChange: (v) => {\n          State.update({\n            search: v,\n            currentPage: 1,\n          });\n        },\n        value: state.search,\n        inputProps: {\n          autoFocus: true,\n        },\n      }}\n    />\n    <Widget\n      src=\"nui.sking.near/widget/Layout.Modal\"\n      props={{\n        open: state.filtersOpen,\n        onOpenChange: (open) => {\n          State.update({\n            ...state,\n            filtersOpen: open,\n          });\n        },\n        toggle: (\n          <Widget\n            src=\"nui.sking.near/widget/Input.Button\"\n            props={{\n              children: (\n                <>\n                  Filter\n                  <i className=\"bi bi-funnel\"></i>\n                </>\n              ),\n              variant: \"info outline\",\n              size: \"md\",\n            }}\n          />\n        ),\n        content: (\n          <div className=\"ndc-card p-4 bg-white rounded\">\n            <Widget\n              src=\"efiz.near/widget/every.thing.filters\"\n              props={{\n                handleFilter,\n                accountId: state.accountId,\n                tag: state.tag,\n              }}\n            />\n            <div className=\"form-check mt-2\">\n              <input\n                className=\"form-check-input\"\n                type=\"radio\"\n                name=\"filterOption\"\n                id=\"allOption\"\n                value=\"all\"\n                checked={state.selectedOption === \"all\"}\n                onChange={handleRadioChange}\n              />\n\n              <label htmlFor=\"allOption\">All</label>\n            </div>\n            <div className=\"form-check mt-2\">\n              <input\n                className=\"form-check-input\"\n                type=\"radio\"\n                name=\"filterOption\"\n                id=\"taggedByCreatorOption\"\n                value=\"taggedByCreator\"\n                checked={state.selectedOption === \"taggedByCreator\"}\n                onChange={handleRadioChange}\n              />\n\n              <label htmlFor=\"taggedByCreatorOption\">Tagged by Creator</label>\n            </div>\n            <div className=\"form-check mt-2\">\n              <input\n                className=\"form-check-input\"\n                type=\"radio\"\n                name=\"filterOption\"\n                id=\"taggedByCommunityOption\"\n                value=\"taggedByCommunity\"\n                checked={state.selectedOption === \"taggedByCommunity\"}\n                onChange={handleRadioChange}\n              />\n\n              <label htmlFor=\"taggedByCommunityOption\">\n                Tagged by Community\n              </label>\n            </div>\n            <div className=\"form-check mt-2\">\n              <input\n                className=\"form-check-input\"\n                type=\"radio\"\n                name=\"filterOption\"\n                id=\"curatedByCategoryOption\"\n                value=\"curatedByCategory\"\n                checked={state.selectedOption === \"curatedByCategory\"}\n                onChange={handleRadioChange}\n              />\n\n              <label htmlFor=\"curatedByCategoryOption\">\n                Curated by Category\n              </label>\n            </div>\n          </div>\n        ),\n      }}\n    />\n    <Widget\n      src=\"nui.sking.near/widget/Input.Button\"\n      props={{\n        children: (\n          <>\n            Share\n            <i className=\"bi bi-share\"></i>\n          </>\n        ),\n        onClick: () => {\n          clipboard.writeText(constructURL());\n        },\n        variant: \"info outline\",\n        size: \"md\",\n      }}\n    />\n  </div>\n);\n\nfunction constructURL() {\n  const gateway = \"https://near.social/\";\n  const widget = \"efiz.near/widget/Things.index\";\n  const standardParams = `?defaultType=${typeName}&page=${state.currentPage}`;\n  let url = `${gateway}${widget}${standardParams}`;\n  if (state.tag !== null) {\n    url += `&tag=${state.tag}`;\n  }\n  if (state.accountId !== null) {\n    url += `&accountId=${state.accountId}`;\n  }\n  return url;\n}\n\nconst renderEmpty = () => (\n  <div\n    className=\"d-flex flex-column justify-content-center align-content-center text-center gap-3 m-auto\"\n    style={{\n      height: \"max(50vh, 400px)\",\n      maxWidth: \"460px\",\n    }}\n  >\n    <i\n      className=\"bi bi-exclamation-circle\"\n      style={{ fontSize: \"4rem\", color: \"#4498E0\" }}\n    />\n    <p className=\"h6\">Nothing found. Would you like to create something now?</p>\n    <Widget\n      src=\"nui.sking.near/widget/Input.Button\"\n      props={{\n        children: \"Create a new Thing\",\n        variant: \"info w-100\",\n        size: \"lg\",\n      }}\n    />\n    <Widget\n      src=\"nui.sking.near/widget/Input.Button\"\n      props={{\n        children: \"Go to home\",\n        variant: \"info outline w-100\",\n        size: \"lg\",\n        href: \"#/astro.sking.near/widget/index\",\n      }}\n    />\n  </div>\n);\n\nconst renderLoading = () => <>loading</>;\nlet data = {};\nswitch (state.selectedOption) {\n  case \"all\": {\n    // This is duplicated code, a bit of a hack rn\n    if (state.tag) {\n      const pattern = `${state.accountId ?? \"*\"}/${typeName}/*/metadata/tags/${\n        state.tag ?? \"*\"\n      }`;\n      const keys = Social.keys(pattern, \"final\");\n\n      if (keys) {\n        keys = Object.entries(keys).flatMap(([key, value]) =>\n          Object.keys(value[typeName]).map((w) => `${key}/${typeName}/${w}`)\n        );\n        data = Social.keys(keys, \"final\", {\n          return_type: \"BlockHeight\",\n          limit: 1,\n        });\n      }\n    } else {\n      const pattern = `${state.accountId ?? \"*\"}/${typeName}/*`;\n      data = Social.keys(pattern, \"final\", {\n        return_type: \"BlockHeight\",\n        limit: 1,\n      });\n    }\n    break;\n  }\n  case \"taggedByCreator\": {\n    const pattern = `${state.accountId ?? \"*\"}/${typeName}/*/metadata/tags/${\n      state.tag ?? \"*\"\n    }`;\n    const keys = Social.keys(pattern, \"final\");\n\n    if (keys) {\n      keys = Object.entries(keys).flatMap(([key, value]) =>\n        Object.keys(value[typeName]).map((w) => `${key}/${typeName}/${w}`)\n      );\n      data = Social.keys(keys, \"final\", {\n        return_type: \"BlockHeight\",\n        limit: 1,\n      });\n    }\n    break;\n  }\n  case \"taggedByCommunity\": {\n    const pattern = `*/every/${typeName}/${state.accountId ?? \"*\"}/*/tags/${\n      state.tag ?? \"*\"\n    }`;\n    const keys = Social.keys(pattern, \"final\");\n\n    if (keys) {\n      keys = Object.entries(keys).flatMap(([key, value]) =>\n        Object.entries(value.every[typeName]).flatMap(([w, it]) =>\n          Object.keys(it).map((itKey) => `${w}/${typeName}/${itKey}`)\n        )\n      );\n      data = Social.keys(keys, \"final\", {\n        return_type: \"BlockHeight\",\n        limit: 1,\n      });\n    }\n    break;\n  }\n  case \"curatedByCategory\": {\n    const category = \"test\";\n    const pattern = `*/thing/*/categories/${category}`;\n    const keys = Social.get(pattern, \"final\");\n    if (keys) {\n      keys = Object.entries(keys).flatMap(([k, v]) => {\n        return Object.entries(v.test.thing).flatMap(([ka, kn]) =>\n          Object.entries(kn.categories).flatMap(([key, value]) => value)\n        );\n      });\n      data = Social.keys(keys, \"final\", {\n        return_type: \"BlockHeight\",\n        limit: 1,\n      });\n    }\n    break;\n  }\n}\n\nconst processData = (data) => {\n  const accounts = Object.entries(data);\n\n  const allItems = accounts\n    .map((account) => {\n      const accountId = account[0];\n      return Object.entries(account[1][typeName]).map((kv) => ({\n        accountId,\n        typeName: kv[0],\n        blockHeight: kv[1],\n      }));\n    })\n    .flat();\n\n  allItems.sort((a, b) => b.blockHeight - a.blockHeight);\n  return allItems;\n};\n\nlet things = [];\nif (data) {\n  things = processData(data);\n}\n\nlet filteredThings = [];\nlet paginatedThings = [];\n\nif (things) {\n  filteredThings = things.filter((d) => {\n    if (state.search == null) {\n      return true;\n    }\n\n    return d.typeName.toLowerCase().includes(state.search.toLowerCase());\n  });\n  paginatedThings = filteredThings.slice(\n    (state.currentPage - 1) * resPerPage,\n    state.currentPage * resPerPage\n  );\n}\n\nconst renderThingsRows = () => {\n  return (\n    <div className=\"row g-3 flex-wrap\">\n      {paginatedThings.map((thing) => (\n        <div\n          key={thing}\n          className=\"flex-grow-1 col-12 col-md-6 col-lg-4 col-xl-3\"\n          style={{\n            minWidth: \"320px\",\n          }}\n        >\n          <Widget\n            src={metadataTemplate}\n            props={{\n              path: `${thing.accountId}/${typeName}/${thing.typeName}`,\n            }}\n          />\n        </div>\n      ))}\n      {paginatedThings.length < resPerPage &&\n        [...Array(resPerPage - paginatedThings.length)].map((_, i) => (\n          <div\n            key={`empty-${i}`}\n            className=\"flex-grow-1 col-12 col-md-6 col-lg-4 col-xl-3\"\n            style={{\n              minWidth: \"320px\",\n            }}\n          ></div>\n        ))}\n    </div>\n  );\n};\nconst renderPagination = () => (\n  <div className=\"d-flex justify-content-center align-items-center gap-2 mb-4\">\n    <Widget\n      src=\"nui.sking.near/widget/Navigation.Paginate\"\n      props={{\n        pageSize: resPerPage,\n        currentPage: state.currentPage,\n        totalPageCount: Math.ceil(filteredThings.length / resPerPage),\n        onPageChange: (page) => {\n          State.update({\n            currentPage: page,\n          });\n        },\n        revaluateOnRender: true,\n      }}\n    />\n  </div>\n);\n\nreturn (\n  <>\n    {renderSubheader()}\n    {things != null &&\n      (!things || things.length < 1 || filteredThings.length < 1) &&\n      renderEmpty()}\n    {things == null && renderLoading()}\n    {((things != null && things) || things.length > 0) && (\n      <div className=\"my-4\">{renderThingsRows()}</div>\n    )}\n    {((things != null && things) ||\n      things.length > resPerPage ||\n      filteredThings.length > resPerPage) &&\n      renderPagination()}\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/efiz.near/widget/Things.list", "fact_widget_deployments_id": "c10132d2c8b0e06ca846e84ce7dd8175", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}