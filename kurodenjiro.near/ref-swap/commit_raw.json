{"tx_hash": "7d8ruyzWHwJW1Y97PmfP8Cx9m7inGzgZzPiFqrvCoFyh", "action_id_social": "J2i264rP6sYdsCv2LPLLgDFPE7bdD54hRUce5vh2LXyv-0-widget", "block_id": 116418798, "block_timestamp": "2024-04-08T21:06:06.162Z", "signer_id": "kurodenjiro.near", "widget_name": "ref-swap", "source_code": "const accountId = context.accountId;\r\n\r\nconst shrinkToken = (value, decimals) => {\r\n  return new Big(value || 0).div(new Big(10).pow(decimals || 24));\r\n};\r\n\r\nconst expandToken = (value, decimals) => {\r\n  return new Big(value).mul(new Big(10).pow(decimals));\r\n};\r\n\r\nconst LONK_TOKEN_META = {\r\n  decimals: 8,\r\n  icon: \"data:image/png;base64,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\",\r\n  id: \"token.lonkingnearbackto2024.near\",\r\n  name: \"LONK fungible token\",\r\n  symbol: \"LONK\",\r\n};\r\n\r\nconst NEAR_META = {\r\n  decimals: 24,\r\n  icon: \"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAzNiAzNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTgiIGN5PSIxOCIgcj0iMTcuNSIgZmlsbD0id2hpdGUiIHN0cm9rZT0iYmxhY2siLz4KPGNpcmNsZSBjeD0iMTgiIGN5PSIxOCIgcj0iMTcuNSIgZmlsbD0id2hpdGUiIHN0cm9rZT0iYmxhY2siLz4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xMC42MDc4IDEyLjUwMjlWMjMuNjE5M0wxNi4yOTIgMTkuMzcyMUwxNi44NjA0IDE5Ljg3MDZMMTIuMDkzOCAyNi41ODQ0QzEwLjMyMjggMjguMjA5MiA3LjE5NzI3IDI3LjEwOTkgNy4xOTcyNyAyNC44NjIyVjExLjEzNzFDNy4xOTcyNyA4LjgxMjI4IDEwLjUwNTggNy43NTMzNCAxMi4yMTMzIDkuNTMxNkwyNS4zODY3IDIzLjI1MDRWMTIuNTkwMkwyMC4yNzEgMTYuMzgxMkwxOS43MDI1IDE1Ljg4MjdMMjMuNzU2NyA5LjYxNTZDMjUuNDQ4OSA3LjgwNDQyIDI4Ljc5NzMgOC44NTM3NiAyOC43OTczIDExLjE5NTNWMjQuNjE2M0MyOC43OTczIDI2Ljk0MTEgMjUuNDg4OCAyOCAyMy43ODEyIDI2LjIyMThMMTAuNjA3OCAxMi41MDI5WiIgZmlsbD0iIzBGMUQyNyIvPgo8L3N2Zz4K\",\r\n  id: \"NEAR\",\r\n  name: \"NEAR\",\r\n  symbol: \"NEAR\",\r\n};\r\n\r\nconst ExchangeIcon = (\r\n  <svg\r\n    xmlns=\"http://www.w3.org/2000/svg\"\r\n    width=\"14\"\r\n    height=\"14\"\r\n    viewBox=\"0 0 14 14\"\r\n    fill=\"none\"\r\n    style={{\r\n      cursor: \"pointer\",\r\n    }}\r\n    onClick={() => {\r\n      State.update({\r\n        tokenIn: state.tokenOut,\r\n        tokenOut: state.tokenIn,\r\n      });\r\n      loadBalance();\r\n    }}\r\n  >\r\n    <path\r\n      opacity=\"0.5\"\r\n      fill-rule=\"evenodd\"\r\n      clip-rule=\"evenodd\"\r\n      d=\"M8.25977 12.9751C8.25977 13.5274 8.70748 13.9751 9.25977 13.9751C9.81205 13.9751 10.2598 13.5274 10.2598 12.9751L10.2598 3.3924L12.2975 5.40399C12.6905 5.79199 13.3237 5.7879 13.7117 5.39487C14.0997 5.00183 14.0956 4.36868 13.7025 3.98068L9.9623 0.288376C9.6753 0.00505281 9.2462 -0.0781458 8.87411 0.077387C8.50202 0.232919 8.25977 0.596739 8.25977 1.00003L8.25977 12.9751ZM5.27273 1.02496C5.27273 0.472672 4.82501 0.0249573 4.27273 0.0249573C3.72044 0.0249573 3.27273 0.472672 3.27273 1.02496V10.6077L1.70253 9.0576C1.30949 8.6696 0.676343 8.67369 0.288346 9.06672C-0.0996505 9.45976 -0.0955657 10.0929 0.29747 10.4809L3.5702 13.7117C3.8572 13.995 4.2863 14.0782 4.65839 13.9227C5.03048 13.7671 5.27273 13.4033 5.27273 13V1.02496Z\"\r\n      fill=\"#91A2AE\"\r\n    />\r\n  </svg>\r\n);\r\n\r\nconst ExchangeWrapper = styled.div`\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  margin-bottom: 16px;\r\n`;\r\n\r\nconst Exchange = <ExchangeWrapper>{ExchangeIcon}</ExchangeWrapper>;\r\n\r\nState.init({\r\n  tokenIn: NEAR_META,\r\n  tokenOut: LONK_TOKEN_META,\r\n  amountIn: \"1\",\r\n  amountOut: \"\",\r\n  showSetting: false,\r\n  slippagetolerance: \"0.5\",\r\n  estimate: {},\r\n  balanceTokenIn: \"\",\r\n  balanceTokenOut: \"\",\r\n  notEnough: \"\",\r\n  timerIntervalSet: false,\r\n  reloadPools: false,\r\n  count: 5,\r\n  loadRes: (value) =>\r\n    State.update({\r\n      estimate: value,\r\n      amountOut: value === null ? \"\" : value.estimate,\r\n    }),\r\n});\r\nconst formatToken = (v) => Math.floor(v * 10_000) / 10_000;\r\nconst loadBalance = () => {\r\n  asyncFetch(`https://api3.nearblocks.io/v1/account/${accountId}`).then(\r\n    (res) => {\r\n      asyncFetch(`https://api.fastnear.com/v1/account/${accountId}/ft`).then(\r\n        (resFastNear) => {\r\n          let lonkBalance = \"\";\r\n          for (let token of resFastNear.body.tokens) {\r\n            if (token.contract_id == \"token.lonkingnearbackto2024.near\") {\r\n              lonkBalance = token.balance;\r\n            }\r\n          }\r\n          console.log(lonkBalance);\r\n          const getBalance = (token_id, tokenMeta) => {\r\n            let amount;\r\n\r\n            if (!accountId) {\r\n              return \"0\";\r\n            }\r\n            if (token_id === \"NEAR\") amount = res.body.account[0].amount;\r\n            else {\r\n              amount = lonkBalance;\r\n            }\r\n\r\n            return !amount\r\n              ? \"0\"\r\n              : shrinkToken(amount, tokenMeta.decimals).toFixed();\r\n          };\r\n          const balanceTokenIn = getBalance(state.tokenIn.id, state.tokenIn);\r\n          const balanceTokenOut = getBalance(state.tokenOut.id, state.tokenOut);\r\n\r\n          const notEnough = new Big(state.amountIn || 0).gt(\r\n            new Big(balanceTokenIn).minus(\r\n              state.tokenIn.id === \"NEAR\" ? new Big(0.5) : new Big(0)\r\n            )\r\n          );\r\n\r\n          State.update({\r\n            notEnough: notEnough,\r\n            balanceTokenIn: formatToken(balanceTokenIn),\r\n            balanceTokenOut: formatToken(balanceTokenOut),\r\n            reloadPools: true,\r\n            tokenIn: state.tokenIn,\r\n            tokenOut: state.tokenOut,\r\n          });\r\n        }\r\n      );\r\n    }\r\n  );\r\n};\r\nuseEffect(() => {\r\n  loadBalance();\r\n}, []);\r\n\r\nlet timerInterval;\r\n\r\nif (!state.timerIntervalSet) {\r\n  State.update({\r\n    timerIntervalSet: true,\r\n  });\r\n  timerInterval = setTimeout(() => {\r\n    const count = state.count;\r\n\r\n    if (count === 1) {\r\n      loadBalance();\r\n    }\r\n    State.update({\r\n      count: count === 1 ? 5 : count - 1,\r\n      timerIntervalSet: false,\r\n    });\r\n\r\n    clearTimeout(timerInterval);\r\n  }, 1000);\r\n}\r\n\r\nconst Container = styled.div`\r\n  width: 490px;\r\nbackground: #182733;\r\n  color: white;\r\npadding:30px;\r\nborder-radius:10px;\r\n  .swap-title {\r\n    font-size: 20px;\r\n    font-weight: 700;\r\n  }\r\n\r\n  @media (max-width: 736px) {\r\n    width: 100%;\r\n\r\n    .swap-title {\r\n      font-size: 16px;\r\n      font-weight: 600;\r\n      line-height: 19px;\r\n      letter-spacing: 0em;\r\n      text-align: left;\r\n      color: white;\r\n    }\r\n  }\r\n`;\r\n\r\nconst Refresh = styled.span`\r\n  margin-left: 8px;\r\n  font-size: 12px;\r\n`;\r\n\r\nconst RefreshText = styled.span`\r\n  margin-left: 4px;\r\n  font-size: 12px;\r\n  color: #7c7f96;\r\n`;\r\n\r\nconst RateLine = styled.div`\r\n  display: flex;\r\n  align-items: center;\r\n  margin-top: 16px;\r\n  justify-content: space-between;\r\n`;\r\n\r\nconst RefreshWrapper = styled.div`\r\n  display: flex;\r\n  align-items: center;\r\n  cursor: pointer;\r\n`;\r\n\r\nconst RateWrapper = styled.div`\r\n  display: flex;\r\n  align-items: center;\r\n  font-size: 12px;\r\n  color: #7c7f96;\r\n`;\r\n\r\nconst canSwap =\r\n  Number(state.amountIn || 0) > 0 &&\r\n  Number(state.amountOut || 0) > 0 &&\r\n  !state.loading &&\r\n  Number(state.slippagetolerance) > 0;\r\n\r\nconst register = Near.view(\r\n  state.tokenOut.id === \"NEAR\" ? \"wrap.near\" : state.tokenOut.id,\r\n  \"storage_balance_of\",\r\n  {\r\n    account_id: accountId,\r\n  }\r\n);\r\n\r\nconst callTx = () => {\r\n  const tx = [];\r\n\r\n  const nearDeposit = {\r\n    contractName: \"wrap.near\",\r\n    methodName: \"near_deposit\",\r\n    deposit: expandToken(state.amountIn, 24).toFixed(),\r\n    gas: expandToken(50, 12),\r\n  };\r\n  const nearWithdraw = {\r\n    contractName: \"wrap.near\",\r\n    methodName: \"near_withdraw\",\r\n    deposit: new Big(\"1\").toFixed(),\r\n    args: {\r\n      amount: expandToken(state.amountIn, 24).toFixed(),\r\n    },\r\n  };\r\n\r\n  if (state.estimate.pool === \"wrap\") {\r\n    if (state.tokenIn.id === \"NEAR\") {\r\n      tx.push(nearDeposit);\r\n    } else {\r\n      tx.push(nearWithdraw);\r\n    }\r\n\r\n    return Near.call(tx);\r\n  }\r\n\r\n  if (register === null) {\r\n    tx.push({\r\n      contractName:\r\n        state.tokenOut.id === \"NEAR\" ? \"wrap.near\" : state.tokenOut.id,\r\n      methodName: \"storage_deposit\",\r\n      deposit: expandToken(0.1, 24).toFixed(),\r\n      gas: expandToken(50, 12),\r\n      args: {\r\n        registration_only: true,\r\n        account_id: accountId,\r\n      },\r\n    });\r\n  }\r\n\r\n  if (state.tokenIn.id === \"NEAR\") {\r\n    tx.push(nearDeposit);\r\n  }\r\n\r\n  const minAmountOut = expandToken(\r\n    new Big(state.amountOut)\r\n      .mul(1 - Number(state.slippagetolerance) / 100)\r\n      .toFixed(state.tokenOut.decimals, 0),\r\n    state.tokenOut.decimals\r\n  ).toFixed();\r\n\r\n  tx.push({\r\n    methodName: \"ft_transfer_call\",\r\n    contractName: state.tokenIn.id === \"NEAR\" ? \"wrap.near\" : state.tokenIn.id,\r\n    gas: expandToken(180, 12),\r\n    deposit: new Big(\"1\").toFixed(),\r\n    args: {\r\n      receiver_id: \"v2.ref-finance.near\",\r\n      amount: expandToken(state.amountIn, state.tokenIn.decimals).toFixed(0, 0),\r\n      msg: JSON.stringify({\r\n        actions: [\r\n          {\r\n            pool_id: Number(state.estimate.pool.id),\r\n            token_in:\r\n              state.tokenIn.id === \"NEAR\" ? \"wrap.near\" : state.tokenIn.id,\r\n            token_out:\r\n              state.tokenOut.id === \"NEAR\" ? \"wrap.near\" : state.tokenOut.id,\r\n            amount_in: expandToken(\r\n              state.amountIn,\r\n              state.tokenIn.decimals\r\n            ).toFixed(0, 0),\r\n            min_amount_out: minAmountOut,\r\n          },\r\n        ],\r\n      }),\r\n    },\r\n  });\r\n\r\n  if (state.tokenOut.id === \"NEAR\") {\r\n    tx.push({\r\n      contractName: \"wrap.near\",\r\n      methodName: \"near_withdraw\",\r\n      deposit: new Big(\"1\").toFixed(),\r\n      args: {\r\n        amount: minAmountOut,\r\n      },\r\n    });\r\n  }\r\n\r\n  Near.call(tx);\r\n};\r\n\r\nconst inputOnChange = (e) => {\r\n  const targetValue = e.target.value;\r\n  if (targetValue !== \"\" && !targetValue.match(/^\\d*(\\.\\d*)?$/)) {\r\n    return;\r\n  }\r\n\r\n  let amountIn = targetValue.replace(/^0+/, \"0\"); // remove prefix 0\r\n  setTimeout(() => {\r\n    State.update({\r\n      amountIn,\r\n    });\r\n  }, 30);\r\n};\r\n\r\nreturn (\r\n  <Container>\r\n    <div className=\"swap-title\">Swap</div>\r\n    {\r\n      <Widget\r\n        src=\"weige.near/widget/ref-swap-getEstimate\"\r\n        props={{\r\n          loadRes: state.loadRes,\r\n          tokenIn: state.tokenIn,\r\n          tokenOut: state.tokenOut,\r\n          amountIn: state.amountIn || 0,\r\n          reloadPools: state.reloadPools,\r\n          setReloadPools: (value) =>\r\n            State.update({\r\n              reloadPools: value,\r\n            }),\r\n        }}\r\n      />\r\n    }\r\n\r\n    {\r\n      <Widget\r\n        src={`kurodenjiro.near/widget/ref-token-input`}\r\n        props={{\r\n          amount: state.amountIn,\r\n          balance: state.balanceTokenIn,\r\n          disableInput: false,\r\n          inputOnChange: inputOnChange,\r\n          setAmount: (value) => {\r\n            State.update({ amountIn: value });\r\n          },\r\n          token: state.tokenIn,\r\n          handleSelect: (metadata) =>\r\n            State.update({\r\n              tokenIn: metadata,\r\n            }),\r\n        }}\r\n      />\r\n    }\r\n    {Exchange}\r\n    {\r\n      <Widget\r\n        src={`kurodenjiro.near/widget/ref-token-input`}\r\n        props={{\r\n          amount: state.amountOut,\r\n          balance: state.balanceTokenOut,\r\n          disableInput: true,\r\n          setAmount: (value) => State.update({ amountOut: value }),\r\n          token: state.tokenOut,\r\n          handleSelect: (metadata) =>\r\n            State.update({\r\n              tokenOut: metadata,\r\n            }),\r\n        }}\r\n      />\r\n    }\r\n\r\n    <RateLine>\r\n      <RefreshWrapper\r\n        onClick={() => {\r\n          clearTimeout(timerInterval);\r\n          State.update({\r\n            reloadPools: true,\r\n            count: 5,\r\n          });\r\n        }}\r\n      >\r\n        <Refresh>{state.count - 1}</Refresh>\r\n        <RefreshText>Refresh</RefreshText>\r\n      </RefreshWrapper>\r\n\r\n      <RateWrapper>{`1 ${state.tokenIn.symbol} \u2248 ${\r\n        Number(state.amountIn) === 0\r\n          ? \"-\"\r\n          : new Big(state.amountOut || 0).div(state.amountIn || 1).toFixed(4, 0)\r\n      } ${state.tokenOut.symbol}`}</RateWrapper>\r\n    </RateLine>\r\n    <Widget\r\n      src={`weige.near/widget/SlippageTolerance`}\r\n      props={{\r\n        showSetting: state.showSetting,\r\n        updateSetting: () =>\r\n          State.update({\r\n            showSetting: !state.showSetting,\r\n          }),\r\n        slippagetolerance: state.slippagetolerance,\r\n        setSlippagetolerance: (value) => {\r\n          if (value !== \"\" && !value.match(/^\\d*(\\.\\d*)?$/)) {\r\n            return;\r\n          }\r\n          if (Number(value) > 99.9999) return;\r\n\r\n          let slippagetolerance = value.replace(/^0+/, \"0\"); // remove prefix 0\r\n\r\n          State.update({\r\n            slippagetolerance,\r\n          });\r\n        },\r\n      }}\r\n    />\r\n\r\n    <Widget\r\n      src=\"weige.near/widget/ref-swap-button\"\r\n      props={{\r\n        accountId,\r\n        notEnough: state.notEnough,\r\n        canSwap,\r\n        callTx,\r\n        requestSignIn: props.requestSignIn,\r\n        noPool: state.estimate?.sig === \"no_pool\",\r\n      }}\r\n    />\r\n  </Container>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/kurodenjiro.near/widget/ref-swap", "fact_widget_deployments_id": "cbbacd6135656026c5c18a175f409550", "inserted_timestamp": "2024-04-08T22:34:32.624Z", "modified_timestamp": "2024-04-08T22:34:32.624Z", "__row_index": 18}