{"tx_hash": "2TQdFcMtdwRWcKGX6h3VyMGdmHuxZihUcWduUtMr4Dti", "action_id_social": "Bieud9gKouxtZbCdzTswf3iEjjvxufMw1vqumMLvAGs6-0-widget", "block_id": 106790696, "block_timestamp": "2023-11-29T07:02:42.984Z", "signer_id": "kurodenjiro.near", "widget_name": "trendingpost", "source_code": "//2 scan all post from hashtag\r\n//3 scan all comment from post\r\n// 4 scan all like from post\r\n// 5 scan all retweet from post\r\nconst respBlock = fetch(\"https://api.nearblocks.io/v1/stats\");\r\n\r\nconst newBlock = Math.round(\r\n  parseInt(respBlock.body.stats[0].block) -\r\n    (30 * 24 * 3600) / parseInt(respBlock.body.stats[0].avg_block_time)\r\n);\r\nconst newBlock3Days = Math.round(\r\n  parseInt(respBlock.body.stats[0].block) -\r\n    (3 * 24 * 3600) / parseInt(respBlock.body.stats[0].avg_block_time)\r\n);\r\nconst newBlock7Days = Math.round(\r\n  parseInt(respBlock.body.stats[0].block) -\r\n    (7 * 24 * 3600) / parseInt(respBlock.body.stats[0].avg_block_time)\r\n);\r\nconst allPost = Social.index(\"hashtag\", \"near\", {\r\n  from: newBlock,\r\n  limit: 300,\r\n  order: \"asc\",\r\n});\r\n\r\nlet postEngagement = [];\r\n\r\nif (allPost.length > 0) {\r\n  allPost.forEach((item) => {\r\n    const allComment = Social.index(\r\n      \"comment\",\r\n      {\r\n        type: \"social\",\r\n        path: `${item.accountId}/post/main`,\r\n        blockHeight: item.blockHeight,\r\n      },\r\n      {\r\n        limit: 9999,\r\n        order: \"desc\",\r\n      }\r\n    );\r\n    const allLike = Social.index(\"like\", {\r\n      type: \"social\",\r\n      path: `${item.accountId}/post/main`,\r\n      blockHeight: item.blockHeight,\r\n    });\r\n    const allRepost = Social.index(\r\n      \"repost\",\r\n      {\r\n        type: \"social\",\r\n        path: `${item.accountId}/post/main`,\r\n        blockHeight: item.blockHeight,\r\n      },\r\n      {\r\n        limit: 9999,\r\n        order: \"desc\",\r\n      }\r\n    );\r\n\r\n    const allComment3Days = Social.index(\r\n      \"comment\",\r\n      {\r\n        type: \"social\",\r\n        path: `${item.accountId}/post/main`,\r\n        blockHeight: item.blockHeight,\r\n      },\r\n      {\r\n        from: newBlock3Days,\r\n        limit: 9999,\r\n        order: \"asc\",\r\n      }\r\n    );\r\n    const allLike3Days = Social.index(\r\n      \"like\",\r\n      {\r\n        type: \"social\",\r\n        path: `${item.accountId}/post/main`,\r\n        blockHeight: item.blockHeight,\r\n      },\r\n      {\r\n        from: newBlock3Days,\r\n        limit: 9999,\r\n        order: \"asc\",\r\n      }\r\n    );\r\n    const allRepost3Days = Social.index(\r\n      \"repost\",\r\n      {\r\n        type: \"social\",\r\n        path: `${item.accountId}/post/main`,\r\n        blockHeight: item.blockHeight,\r\n      },\r\n      { from: newBlock3Days, limit: 9999, order: \"asc\" }\r\n    );\r\n\r\n    const allComment7Days = Social.index(\r\n      \"comment\",\r\n      {\r\n        type: \"social\",\r\n        path: `${item.accountId}/post/main`,\r\n        blockHeight: item.blockHeight,\r\n      },\r\n      {\r\n        from: newBlock7Days,\r\n        limit: 9999,\r\n        order: \"asc\",\r\n      }\r\n    );\r\n    const allLike7Days = Social.index(\r\n      \"like\",\r\n      {\r\n        type: \"social\",\r\n        path: `${item.accountId}/post/main`,\r\n        blockHeight: item.blockHeight,\r\n      },\r\n      {\r\n        from: newBlock7Days,\r\n        limit: 9999,\r\n        order: \"asc\",\r\n      }\r\n    );\r\n    const allRepost7Days = Social.index(\r\n      \"repost\",\r\n      {\r\n        type: \"social\",\r\n        path: `${item.accountId}/post/main`,\r\n        blockHeight: item.blockHeight,\r\n      },\r\n      { from: newBlock7Days, limit: 9999, order: \"asc\" }\r\n    );\r\n\r\n    const res = fetch(\r\n      `https://api.near.social/time?blockHeight=${item.blockHeight}`\r\n    );\r\n    const dateCreated = res.body;\r\n\r\n    if (allComment.length + allLike.length + allRepost.length > 0) {\r\n      postEngagement.push({\r\n        accountId: item.accountId,\r\n        blockHeight: item.blockHeight,\r\n        allLike: allLike.length,\r\n        allComment: allComment.length,\r\n        allRepost: allRepost.length,\r\n        EP:\r\n          (allComment.length * 3 + allLike.length + allRepost.length * 2) /\r\n            Math.floor(\r\n              (Date.now() - new Date(dateCreated)) / 1000 / (3600 * 24)\r\n            ) || 0,\r\n        EP3D:\r\n          (allComment3Days.length * 3 +\r\n            allLike3Days.length +\r\n            allRepost3Days.length * 2) /\r\n            3 || 0,\r\n        EP7D:\r\n          (allComment7Days.length * 3 +\r\n            allLike7Days.length +\r\n            allRepost7Days.length * 2) /\r\n            7 || 0,\r\n        dateCreated: dateCreated,\r\n      });\r\n    }\r\n  });\r\n}\r\n\r\nconst compare = (b, a) => {\r\n  if (a.EP < b.EP) {\r\n    return -1;\r\n  }\r\n  if (a.EP > b.EP) {\r\n    return 1;\r\n  }\r\n  return 0;\r\n};\r\nconst sort = postEngagement.sort(compare);\r\nreturn (\r\n  <div>\r\n    <table class=\"table\">\r\n      <thead>\r\n        <tr>\r\n          <th scope=\"col\">Post ID</th>\r\n          <th scope=\"col\">Account ID</th>\r\n          <th scope=\"col\">EP. </th>\r\n          <th scope=\"col\">EP. 3Days </th>\r\n          <th scope=\"col\">EP. 7Days </th>\r\n          <th scope=\"col\">Comment</th>\r\n          <th scope=\"col\">LIKES</th>\r\n          <th scope=\"col\">REPOST</th>\r\n          <th scope=\"col\">Created.</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        {sort.map((item) => (\r\n          <tr>\r\n            <th scope=\"row\">\r\n              <a\r\n                href={`https://near.social/mob.near/widget/MainPage.N.Post.Page?accountId=${item.accountId}&blockHeight=${item.blockHeight}`}\r\n              >\r\n                {item.blockHeight}\r\n              </a>\r\n            </th>\r\n            <td maxWidth=\"100px\">\r\n              {item.accountId.includes(\".near\")\r\n                ? item.accountId\r\n                : item.accountId.slice(0, 7) +\r\n                  \"...\" +\r\n                  item.accountId.slice(\r\n                    item.accountId.length - 10,\r\n                    item.accountId.length - 1\r\n                  )}\r\n            </td>\r\n            <td>{item.EP && item.EP.toFixed(4)}</td>\r\n            <td>{item.EP3D && item.EP3D.toFixed(4)}</td>\r\n            <td>{item.EP7D && item.EP7D.toFixed(4)}</td>\r\n            <td>{item.allComment}</td>\r\n            <td>{item.allLike}</td>\r\n            <td>{item.allRepost}</td>\r\n            <td>\r\n              {new Date(item.dateCreated).toLocaleString(\"en-GB\", {\r\n                hour12: false,\r\n              })}\r\n            </td>\r\n          </tr>\r\n        ))}\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/kurodenjiro.near/widget/trendingpost", "fact_widget_deployments_id": "bae7e844b891e52a941ef15eeecae766", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}