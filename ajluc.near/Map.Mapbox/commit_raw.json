{"tx_hash": "2nfkaRZjWGEznKrEAgRTktD2VJaxTcyPaNxiR31bpMuk", "action_id_social": "5QwEoACJXDSB48fZrrhbY5Rer3WKst4jLmwvbKLcY1HT-0-widget", "block_id": 104409377, "block_timestamp": "2023-10-28T19:41:43.485Z", "signer_id": "ajluc.near", "widget_name": "Map.Mapbox", "source_code": "const API_URL = props.API_URL || \"\";\nconst ACCESS_TOKEN =\n  props.accessToken ||\n  \"pk.eyJ1IjoiZWpsYnJhZW0iLCJhIjoiY2xrbmIwaW53MGE0NTNtbGsydWd2MmpyZSJ9.m1ZfEqv2fGet2zblGknT8A\";\nconst styleUrl = props.styleUrl || \"mapbox://styles/mapbox/streets-v12\"; // see https://docs.mapbox.com/api/maps/styles/#mapbox-styles\nconst center = props.center || [-87.6298, 41.8781]; // starting position [lng, lat]\nconst zoom = props.zoom || 9; // starting zoom\nconst accountId = context.accountId;\nconst markers = props.markers || {};\nconst onMapClick = props.onMapClick || (() => {});\nconst onMarkerClick = props.onMarkerClick || (() => {});\nconst edit = props.edit || false;\n\nconst markerAsset =\n  props.markerAsset || \"https://i.ibb.co/w6QRm4h/Liberty-Map-Pin-Dark.png\";\n\nconst myMarkers = props.myMarkers || [];\nconst myMarkerAsset =\n  props.myMarkerAsset ||\n  \"https://cdn4.iconfinder.com/data/icons/small-n-flat/24/map-marker-512.png\";\n\nconst code = `\n<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"utf-8\">\n    <meta name=\"viewport\" content=\"initial-scale=1,maximum-scale=1,user-scalable=no\">\n    \n    <link href=\"https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css\" rel=\"stylesheet\">\n    \n    <script src=\"https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js\"></script>\n    \n    <style>\n      body { margin: 0; padding: 0; }\n      #map { position: absolute; top: 0; bottom: 0; width: 100%; }\n\n    //   .marker {\n    //     background-image: url('${markerAsset}');\n    //     background-size: cover;\n    //     width: 30px;\n    //     height: 45px;\n    //     cursor: pointer;\n    //   }\n      \n    //   #mymarker {\n    //     background-image: url('${myMarkerAsset}') !important;\n    //   }\n\n      h6 {\n        margin:0;\n        font-size: 16px;\n      }\n\n      .mapboxgl-popup-content{\n        background: rgb(25, 26, 26);\n        color: white;\n        border: 1px solid;\n        border-radius: 9px;\n        padding: 10px;\n      }\n\n      .mapboxgl-popup-close-button{\n        color: white;\n      }\n\n      .mapboxgl-ctrl-logo {\n        display: none !important;\n      }\n      a {\n        outline: 0;\n      }\n    </style>\n  </head>\n  <body>\n\n    <div id=\"map\"></div>\n\n    <script>\n    const accountId = \"${accountId}\";\n    const isSetMarkerActive = ${edit};\n    const markersById = {};\n    const myMarkers = ${JSON.stringify(myMarkers)};\n    let selectedMarkerElement = null;\n\n    mapboxgl.accessToken = \"${ACCESS_TOKEN}\";\n\n    const map = new mapboxgl.Map({\n        container: 'map', // container ID\n        style: '${styleUrl}',\n        center: [${center[0]}, ${center[1]}], \n        zoom: ${zoom}\n    });\n\n\n\n    function handleMarkerClick(marker) {\n      map.flyTo({\n        center: [marker.lng, marker.lat],\n        essential: true\n      });\n\n      if (selectedMarkerElement) {\n        selectedMarkerElement.style.boxShadow = '';\n      }\n\n      const markerInstance = markersById[marker.id];\n      // markersById[marker.accountId];\n      \n      if (markerInstance) {\n          const el = markerInstance.getElement();\n          // el.style.boxShadow = '0px 0px 10px 3px rgba(0,0,0,0.5)';\n          selectedMarkerElement = el;\n      }\n  \n      // Post message with marker data\n      window.parent.postMessage({\n          handler: 'marker-click',\n          data: marker\n      }, '*');\n    }\n\n    //  NEW Function to populate markers to the map\n\n    map.on('load', () => {\n        map.addSource('earthquakes', {\n            type: 'geojson',\n            data: 'https://ajluc.github.io/hack-o-ween/markers3.geojson',\n            cluster: true,\n            clusterMaxZoom: 14, // Max zoom to cluster points on\n            clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)\n        });\n\n        map.addLayer({\nid: 'clusters',\ntype: 'circle',\nsource: 'earthquakes',\nfilter: ['has', 'point_count'],\npaint: {\n// Use step expressions (https://docs.mapbox.com/style-spec/reference/expressions/#step)\n// with three steps to implement three types of circles:\n//   * Blue, 20px circles when point count is less than 100\n//   * Yellow, 30px circles when point count is between 100 and 750\n//   * Pink, 40px circles when point count is greater than or equal to 750\n'circle-color': [\n'step',\n['get', 'point_count'],\n'#51bbd6',\n100,\n'#f1f075',\n750,\n'#f28cb1'\n],\n'circle-radius': [\n'step',\n['get', 'point_count'],\n20,\n100,\n30,\n750,\n40\n]\n}\n});\n\nmap.addLayer({\nid: 'cluster-count',\ntype: 'symbol',\nsource: 'earthquakes',\nfilter: ['has', 'point_count'],\nlayout: {\n'text-field': ['get', 'point_count_abbreviated'],\n'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],\n'text-size': 12\n}\n});\n \nmap.addLayer({\nid: 'unclustered-point',\ntype: 'circle',\nsource: 'earthquakes',\nfilter: ['!', ['has', 'point_count']],\npaint: {\n'circle-color': '#11b4da',\n'circle-radius': 4,\n'circle-stroke-width': 1,\n'circle-stroke-color': '#fff'\n}\n});\n \n// inspect a cluster on click\nmap.on('click', 'clusters', (e) => {\nconst features = map.queryRenderedFeatures(e.point, {\nlayers: ['clusters']\n});\nconst clusterId = features[0].properties.cluster_id;\nmap.getSource('earthquakes').getClusterExpansionZoom(\nclusterId,\n(err, zoom) => {\nif (err) return;\n \nmap.easeTo({\ncenter: features[0].geometry.coordinates,\nzoom: zoom\n});\n}\n);\n});\n\n// inspect a cluster on click\nmap.on('click', 'clusters', (e) => {\nconst features = map.queryRenderedFeatures(e.point, {\nlayers: ['clusters']\n});\nconst clusterId = features[0].properties.cluster_id;\nmap.getSource('earthquakes').getClusterExpansionZoom(\nclusterId,\n(err, zoom) => {\nif (err) return;\n \nmap.easeTo({\ncenter: features[0].geometry.coordinates,\nzoom: zoom\n});\n}\n);\n});\n\n\n\n    });\n\n\n\n\n\n\n    // Function to populate markers to the map\n    // function populateMarkers() {\n    //     const markersData = ${JSON.stringify(markers)};\n        \n    //     markersData.forEach(marker => {\n        \n    //       try {\n    //         const el = document.createElement('div');\n    //         el.className = 'marker';\n    //         el.dataset.id = marker.id;\n        \n    //         if (myMarkers.some((it) => it.id === marker.id)) el.id = 'mymarker';\n            \n    //         markersById[marker.id] = new mapboxgl.Marker(el)\n    //             .setLngLat([marker.lng, marker.lat])\n    //             .addTo(map);\n\n    //             el.addEventListener('click', () => {\n    //           event.stopPropagation();\n\n    //           handleMarkerClick(marker); \n    //         });\n    //       } catch (e) {\n    //         console.log(e);\n    //       }\n    //     });\n    // }\n\n    // populateMarkers();\n\n\n\n\n    map.on('click', function(event) {\n      const { lngLat } = event;\n\n      if (selectedMarkerElement) {\n        // selectedMarkerElement.style.boxShadow = '';\n        selectedMarkerElement = null;\n      }\n\n      if (isSetMarkerActive) {\n\n        // THIS USED TO REMOVE A MARKER IF IT ALREADY EXISTED... like you're moving an existing marker\n        // if (markersById[accountId]) {\n        //   markersById[accountId].remove();\n        // }\n          \n        const _el = document.getElementById(\"mymarker\");\n        const myel = _el ? _el : document.createElement('div');\n        myel.className = 'marker';\n        myel.id = 'mymarker';\n\n        const newMarker = new mapboxgl.Marker(myel)\n          .setLngLat([lngLat.lng, lngLat.lat])\n          .addTo(map);\n\n        // markersById[accountId] = newMarker;\n      }\n\n      window.parent.postMessage({\n        handler: 'map-click',\n        data: {\n          coordinates: lngLat\n        }\n      }, '*');\n    });\n    </script>\n  </body>\n</html>\n  `;\n\nconst Container = styled.div`\n  height: 100%;\n  display: flex;\n\n  /* reset */\n  button,\n  fieldset,\n  input {\n    all: unset;\n  }\n`;\n\nreturn (\n  <Container>\n    <iframe\n      id=\"myMap\"\n      className=\"w-100 h-100\"\n      srcDoc={code}\n      onMessage={(e) => {\n        switch (e.handler) {\n          case \"map-click\": {\n            onMapClick(e.data);\n            break;\n          }\n          case \"marker-click\": {\n            onMarkerClick(e.data);\n            break;\n          }\n        }\n      }}\n    />\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/ajluc.near/widget/Map.Mapbox", "fact_widget_deployments_id": "61538f595a8340c6bff15acfc5675721", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 2}