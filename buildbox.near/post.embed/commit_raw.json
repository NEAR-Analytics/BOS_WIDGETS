{"tx_hash": "ApRWhXwGCScFj4jMUaXFGotiVHpo29kXU4Cd3aXJGLPA", "action_id_social": "7mbUShcmBosKzpDnuKcuc3wLuNBeQLpnE7YcjjNSoxEu-0-widget", "block_id": 112024623, "block_timestamp": "2024-02-03T17:07:35.756Z", "signer_id": "buildbox.near", "widget_name": "post.embed", "source_code": "// will need to create the post embedding\n\n// This widget is used for embedding whitelisted set of widgets into a post body.\n\nconst EmbedMap = new Map([\n  [\n    \"mob.near/widget/MainPage.N.Post.Page\",\n    \"mob.near/widget/MainPage.N.Post.Embed\",\n  ],\n  [\n    \"mob.near/widget/MainPage.N.Post.Embed\",\n    \"mob.near/widget/MainPage.N.Post.Embed\",\n  ],\n  [\n    \"**/buildbox/project/**\",\n    \"buildbox.near/widget/project.embed\",\n  ]\n]);\n\n\nconst href = props.href;\n\nconst assertString = (s) => {\n  if (typeof s !== \"string\") {\n    return null;\n  }\n};\n\n// checks for use of \"**\" in widgetSrc string\nconst containsGlob = (path) => /\\*\\*/.test(path);\n\nconst findWithKey = (key, href) => {\n  let fragments = key.split(\"**\").filter((f) => f != \"\");\n  const hasFragment = (str, fragment) => str.search(fragment) != -1;\n  while (fragments.length > 0) {\n    if (hasFragment(href, fragments[0])) {\n      fragments.shift();\n    } else {\n      return null;\n    }\n  }\n  return true;\n};\n\nconst parseUrl = (url) => {\n  assertString(url);\n  if (url.startsWith(\"/\")) {\n    url = `https://near.social${url}`;\n  }\n  try {\n    return new URL(url);\n  } catch {\n    return null;\n  }\n};\n\nconst parseGlob = (path) => {\n  assertString(path);\n  const keysWithGlobs = [...EmbedMap.keys()].filter((key) => containsGlob(key));\n  console.log(\"keysWithGlobs\", keysWithGlobs)\n  const keysThatMatch = keysWithGlobs.filter((key) => findWithKey(key, href));\n  if (keysThatMatch.length >= 1) {\n    try {\n      return keysThatMatch[0];\n    } catch {\n      return null;\n    }\n  }\n  return null;\n};\n\nconst parsed = useMemo(() => {\n  // try parsing embed link to URL\n  const url = parseUrl(href);\n  if (!!url) {\n    return {\n      widgetSrc: url.pathname.substring(1),\n      props: Object.fromEntries([...url.searchParams.entries()]),\n    };\n  }\n\n  // try parsing embed link to glob if url failed\n  const widgetSrc = parseGlob(href);\n  console.log(\"parsed\", widgetSrc)\n  if (!!widgetSrc) {\n    return {\n      widgetSrc,\n      props: {\n        href,\n      },\n    };\n  }\n\n  // neither valid url nor valid glob\n  return null;\n}, [href]);\n\nfunction filterByWidgetSrc(obj, widgetSrcValue) {\n  let result = [];\n\n  function recurse(currentObj) {\n    if (typeof currentObj === \"object\" && currentObj !== null) {\n      if (\n        currentObj.metadata &&\n        currentObj.metadata.widgetSrc === widgetSrcValue\n      ) {\n        result.push(currentObj);\n      }\n      Object.values(currentObj).forEach((value) => recurse(value));\n    }\n  }\n\n  recurse(obj);\n  return result;\n}\n\nconst Wrapper = styled.div`\n  border-radius: 1rem;\n  width: 100%;\n  overflow: hidden;\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  white-space: normal;\n  margin-top: 12px;\n`;\n\nif (!parsed || !EmbedMap.has(parsed.widgetSrc)) {\n  return (\n    <Wrapper>\n      <div\n        className=\"d-flex justify-content-center align-items-center\"\n        style={{ height: \"200px\" }}\n      >\n        <div className=\"text-center\">\n          <p>You do not have a plugin installed to render this embedding.</p>\n          <Link\n            to={`/embeds.near/widget/Plugin.Index?type=embed&widgetSrc=${parsed.widgetSrc}`}\n            className=\"btn btn-primary mb-3\"\n          >\n            <i className=\"bi bi-plug\" /> Install one from the marketplace\n            &#8594;\n          </Link>\n          <div>\n            <span>\n              {`or `}\n              <a href={href} target=\"_blank\" rel=\"noopener noreferrer\">\n                click here\n              </a>\n              {` to view`}\n            </span>\n          </div>\n        </div>\n      </div>\n    </Wrapper>\n  );\n}\n\nconst widgetSrc = EmbedMap.get(parsed.widgetSrc);\n\nreturn (\n  <Wrapper>\n    <Widget loading=\"\" src={widgetSrc} props={parsed.props} />\n  </Wrapper>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/buildbox.near/widget/post.embed", "fact_widget_deployments_id": "d03cada37932f12e5ffe17c6d3dca1dc", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}