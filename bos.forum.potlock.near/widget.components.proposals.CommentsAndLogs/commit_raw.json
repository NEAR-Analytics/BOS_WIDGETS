{"tx_hash": "Q5QraYsc3NZtukkGrX2RgLxp73sJwrULVFdjzen2gwk", "action_id_social": "8cxjVTEMAtLSd42GRkagpe56NVztnVUmpmmfktdxeY4H-0-widget", "block_id": 122371334, "block_timestamp": "2024-07-01T05:45:15.088Z", "signer_id": "bos.forum.potlock.near", "widget_name": "widget.components.proposals.CommentsAndLogs", "source_code": "const { PROPOSAL_TIMELINE_STATUS, isNumber, getLinkUsingCurrentGateway } =\n  VM.require(`bos.forum.potlock.near/widget/core.common`) || {\n    PROPOSAL_TIMELINE_STATUS: {},\n    isNumber: () => {},\n    getLinkUsingCurrentGateway: () => {},\n  };\nconst { href } = VM.require(`devhub.near/widget/core.lib.url`);\nhref || (href = () => {});\nconst snapshotHistory = props.snapshotHistory;\nconst latestSnapshot = props.latestSnapshot;\nconst Wrapper = styled.div`\n  position: relative;\n  .log-line {\n    position: absolute;\n    left: 7%;\n    top: -30px;\n    bottom: 0;\n    z-index: 1;\n    width: 1px;\n    background-color: var(--bs-border-color);\n    z-index: 1;\n  }\n  .text-wrap {\n    overflow: hidden;\n    white-space: normal;\n  }\n  .fw-bold {\n    font-weight: 600 !important;\n  }\n  .inline-flex {\n    display: -webkit-inline-box !important;\n    align-items: center !important;\n    gap: 0.25rem !important;\n    margin-right: 2px;\n    flex-wrap: wrap;\n  }\n`;\nconst CommentContainer = styled.div`\n  border: 1px solid lightgrey;\n  overflow: auto;\n`;\nconst Header = styled.div`\n  position: relative;\n  background-color: #f4f4f4;\n  height: 50px;\n  .menu {\n    position: absolute;\n    right: 10px;\n    top: 4px;\n    font-size: 30px;\n  }\n`;\n// check snapshot history all keys and values for differences\nfunction getDifferentKeysWithValues(obj1, obj2) {\n  return Object.keys(obj1)\n    .filter((key) => {\n      if (key !== \"editor_id\" && obj2.hasOwnProperty(key)) {\n        const value1 = obj1[key];\n        const value2 = obj2[key];\n        if (Array.isArray(value1) && Array.isArray(value2)) {\n          const sortedValue1 = [...value1].sort();\n          const sortedValue2 = [...value2].sort();\n          return JSON.stringify(sortedValue1) !== JSON.stringify(sortedValue2);\n        } else if (typeof value1 === \"object\" && typeof value2 === \"object\") {\n          return JSON.stringify(value1) !== JSON.stringify(value2);\n        } else {\n          return value1 !== value2;\n        }\n      }\n      return false;\n    })\n    .map((key) => ({\n      key,\n      originalValue: obj1[key],\n      modifiedValue: obj2[key],\n    }));\n}\nState.init({\n  data: null,\n  socialComments: null,\n  changedKeysListWithValues: null,\n});\nfunction sortTimelineAndComments() {\n  const comments = Social.index(\"comment\", props.item, { subscribe: true });\n  if (state.changedKeysListWithValues === null) {\n    const changedKeysListWithValues = snapshotHistory\n      .slice(1)\n      .map((item, index) => {\n        const startingPoint = snapshotHistory[index]; // Set comparison to the previous item\n        return {\n          editorId: item.editor_id,\n          ...getDifferentKeysWithValues(startingPoint, item),\n        };\n      });\n    State.update({ changedKeysListWithValues });\n  }\n  // sort comments and timeline logs by time\n  const snapShotTimeStamp = Array.isArray(snapshotHistory)\n    ? snapshotHistory.map((i) => {\n        return { blockHeight: null, timestamp: parseFloat(i.timestamp / 1e6) };\n      })\n    : [];\n  const commentsTimeStampPromise = Array.isArray(comments)\n    ? Promise.all(\n        comments.map((item) => {\n          return asyncFetch(\n            `https://api.near.social/time?blockHeight=${item.blockHeight}`\n          ).then((res) => {\n            const timeMs = parseFloat(res.body);\n            return {\n              blockHeight: item.blockHeight,\n              timestamp: timeMs,\n            };\n          });\n        })\n      ).then((res) => res)\n    : Promise.resolve([]);\n  commentsTimeStampPromise.then((commentsTimeStamp) => {\n    const combinedArray = [...snapShotTimeStamp, ...commentsTimeStamp];\n    combinedArray.sort((a, b) => a.timestamp - b.timestamp);\n    State.update({ data: combinedArray, socialComments: comments });\n  });\n}\nif ((snapshotHistory ?? []).length > 0) {\n  sortTimelineAndComments();\n}\nconst Comment = ({ commentItem }) => {\n  const { accountId, blockHeight } = commentItem;\n  const item = {\n    type: \"social\",\n    path: `${accountId}/post/comment`,\n    blockHeight,\n  };\n  const content = JSON.parse(Social.get(item.path, blockHeight) ?? \"null\");\n  const link = getLinkUsingCurrentGateway(\n    `bos.forum.potlock.near/widget/app?page=proposal&id=${props.id}&accountId=${accountId}&blockHeight=${blockHeight}`\n  );\n  const hightlightComment =\n    parseInt(props.blockHeight ?? \"\") === blockHeight &&\n    props.accountId === accountId;\n  return (\n    <div style={{ zIndex: 99, background: \"white\" }}>\n      <div className=\"d-flex gap-2 flex-1\">\n        <div className=\"d-none d-sm-flex\">\n          <Widget\n            src={`bos.forum.potlock.near/widget/components.molecule.Profile`}\n            props={{\n              accountId: accountId,\n            }}\n          />\n        </div>\n        <CommentContainer\n          style={{ border: hightlightComment ? \"2px solid black\" : \"\" }}\n          className=\"rounded-2 flex-1\"\n        >\n          <Header className=\"d-flex gap-3 align-items-center p-2 px-3\">\n            <div className=\"text-muted\">\n              <a\n                rel=\"noopener noreferrer\"\n                target=\"_blank\"\n                href={`https://near.social/near/widget/ProfilePage?accountId=${accountId}`}\n              >\n                <span className=\"fw-bold text-black\">{accountId}</span>\n              </a>\n              commented \uff65{\" \"}\n              <Widget\n                src={`near/widget/TimeAgo`}\n                props={{\n                  blockHeight: blockHeight,\n                }}\n              />\n            </div>\n            {context.accountId && (\n              <div className=\"menu\">\n                <Widget\n                  src={`near/widget/Posts.Menu`}\n                  props={{\n                    accountId: accountId,\n                    blockHeight: blockHeight,\n                    contentPath: `/post/comment`,\n                    contentType: \"comment\",\n                  }}\n                />\n              </div>\n            )}\n          </Header>\n          <div className=\"p-2 px-3\">\n            <Widget\n              src={`devhub.near/widget/devhub.components.molecule.MarkdownViewer`}\n              props={{\n                text: content.text,\n              }}\n            />\n            <div className=\"d-flex gap-2 align-items-center mt-4\">\n              <Widget\n                src={`devhub.near/widget/devhub.entity.proposal.LikeButton`}\n                props={{\n                  item: item,\n                  notifyAccountId: accountId,\n                }}\n              />\n              <Widget\n                src={`near/widget/CopyUrlButton`}\n                props={{\n                  url: link,\n                }}\n              />\n            </div>\n          </div>\n        </CommentContainer>\n      </div>\n    </div>\n  );\n};\nfunction capitalizeFirstLetter(string) {\n  const updated = string.replace(\"_\", \" \");\n  return updated.charAt(0).toUpperCase() + updated.slice(1).toLowerCase();\n}\nfunction parseTimelineKeyAndValue(timeline, originalValue, modifiedValue) {\n  const oldValue = originalValue[timeline];\n  const newValue = modifiedValue[timeline];\n  switch (timeline) {\n    case \"status\": {\n      if (\n        (newValue === PROPOSAL_TIMELINE_STATUS.APPROVED ||\n          newValue === PROPOSAL_TIMELINE_STATUS.APPROVED_CONDITIONALLY) &&\n        latestSnapshot.linked_rfp\n      ) {\n        return (\n          <span className=\"inline-flex\">\n            moved proposal to{\" \"}\n            <Widget\n              src={`devhub.near/widget/devhub.entity.proposal.StatusTag`}\n              props={{\n                timelineStatus: newValue,\n              }}\n            />\n            \uff65 this proposal is selected for RFP{\" \"}\n            <LinkToRfp id={latestSnapshot.linked_rfp}>\n              #{latestSnapshot.linked_rfp}\n            </LinkToRfp>\n          </span>\n        );\n      } else\n        return (\n          oldValue !== newValue && (\n            <span className=\"inline-flex\">\n              moved proposal from{\" \"}\n              <Widget\n                src={`devhub.near/widget/devhub.entity.proposal.StatusTag`}\n                props={{\n                  timelineStatus: oldValue,\n                }}\n              />\n              to{\" \"}\n              <Widget\n                src={`devhub.near/widget/devhub.entity.proposal.StatusTag`}\n                props={{\n                  timelineStatus: newValue,\n                }}\n              />\n              stage\n            </span>\n          )\n        );\n    }\n    case \"sponsor_requested_review\":\n      return !oldValue && newValue && <span>completed review</span>;\n    case \"reviewer_completed_attestation\":\n      return !oldValue && newValue && <span>completed attestation</span>;\n    case \"kyc_verified\":\n      return !oldValue && newValue && <span>verified KYC/KYB</span>;\n    case \"test_transaction_sent\":\n      return (\n        !oldValue &&\n        newValue && (\n          <span>\n            confirmed sponsorship and shared funding steps with recipient\n          </span>\n        )\n      );\n    case \"payouts\":\n      return <span>updated the funding payment links.</span>;\n    default:\n      return null;\n  }\n}\nconst AccountProfile = ({ accountId }) => {\n  return (\n    <span className=\"inline-flex fw-bold text-black\">\n      <Widget\n        src={`bos.forum.potlock.near/widget/components.molecule.Profile`}\n        props={{\n          accountId: accountId,\n          size: \"sm\",\n          showAccountId: true,\n        }}\n      />\n    </span>\n  );\n};\nconst LinkToRfp = ({ id, children }) => {\n  return (\n    <a\n      className=\"text-decoration-underline flex-1\"\n      href={href({\n        widgetSrc: `bos.forum.potlock.near/widget/app`,\n        params: {\n          page: \"rfp\",\n          id: id,\n        },\n      })}\n      target=\"_blank\"\n      rel=\"noopener noreferrer\"\n    >\n      {children}\n    </a>\n  );\n};\nconst parseProposalKeyAndValue = (key, modifiedValue, originalValue) => {\n  switch (key) {\n    case \"name\":\n      return <span>changed title</span>;\n    case \"summary\":\n    case \"description\":\n      return <span>changed {key}</span>;\n    case \"labels\":\n      return <span>changed labels to {(modifiedValue ?? []).join(\", \")}</span>;\n    case \"category\":\n      return (\n        <span>\n          changed category from {originalValue} to {modifiedValue}\n        </span>\n      );\n    case \"linked_proposals\":\n      return <span>updated linked proposals</span>;\n    case \"linked_rfp\": {\n      const isUnlinked = isNumber(originalValue) && !isNumber(modifiedValue);\n      const actionText = isUnlinked ? \"unlinked\" : \"linked\";\n      const rfpId = originalValue ?? modifiedValue;\n      return (\n        <span>\n          {actionText} an RFP <LinkToRfp id={rfpId}>#{rfpId}</LinkToRfp>\n        </span>\n      );\n    }\n    case \"requested_sponsorship_usd_amount\":\n      return (\n        <span>\n          changed sponsorship amount from {originalValue} to {modifiedValue}\n        </span>\n      );\n    case \"requested_sponsorship_paid_in_currency\":\n      return (\n        <span>\n          changed sponsorship currency from {originalValue} to {modifiedValue}\n        </span>\n      );\n    case \"receiver_account\":\n      return (\n        <span className=\"inline-flex\">\n          changed receiver account from{\" \"}\n          <AccountProfile accountId={originalValue} />\n          to <AccountProfile accountId={modifiedValue} />\n        </span>\n      );\n    case \"supervisor\":\n      return !originalValue && modifiedValue ? (\n        <span className=\"inline-flex\">\n          added\n          <AccountProfile accountId={modifiedValue} />\n          as project coordinator\n        </span>\n      ) : (\n        <span className=\"inline-flex\">\n          changed project coordinator from{\" \"}\n          <AccountProfile accountId={originalValue} />\n          to <AccountProfile accountId={modifiedValue} />\n        </span>\n      );\n    case \"timeline\": {\n      const modifiedKeys = Object.keys(modifiedValue);\n      const originalKeys = Object.keys(originalValue);\n      return modifiedKeys.map((i, index) => {\n        const text = parseTimelineKeyAndValue(i, originalValue, modifiedValue);\n        return (\n          text && (\n            <span key={index} className=\"inline-flex\">\n              {text}\n              {text && \"\uff65\"}\n            </span>\n          )\n        );\n      });\n    }\n    default:\n      return null;\n  }\n};\nconst LogIconContainer = styled.div`\n  margin-left: 50px;\n  z-index: 99;\n  @media screen and (max-width: 768px) {\n    margin-left: 10px;\n  }\n`;\nconst Log = ({ timestamp }) => {\n  const updatedData = useMemo(\n    () =>\n      state.changedKeysListWithValues.find((obj) =>\n        Object.values(obj).some(\n          (value) =>\n            value && parseFloat(value.modifiedValue / 1e6) === timestamp\n        )\n      ),\n    [state.changedKeysListWithValues, timestamp]\n  );\n  const editorId = updatedData.editorId;\n  const valuesArray = Object.values(updatedData ?? {});\n  // if valuesArray length is 2 that means it only has timestamp and editorId\n  if (!updatedData || valuesArray.length === 2) {\n    return <></>;\n  }\n  return valuesArray.map((i, index) => {\n    if (i.key && i.key !== \"timestamp\") {\n      return (\n        <LogIconContainer\n          className=\"d-flex gap-3 align-items-center\"\n          key={index}\n        >\n          <img\n            src=\"https://ipfs.near.social/ipfs/bafkreiffqrxdi4xqu7erf46gdlwuodt6dm6rji2jtixs3iionjvga6rhdi\"\n            height={30}\n          />\n          <div\n            className={\n              \"flex-1 gap-1 w-100 text-wrap text-muted align-items-center \" +\n              (i.key === \"timeline\" &&\n              Object.keys(i.originalValue ?? {}).length > 1\n                ? \"\"\n                : \"inline-flex\")\n            }\n          >\n            <span className=\"inline-flex fw-bold text-black\">\n              <AccountProfile accountId={editorId} showAccountId={true} />{\" \"}\n            </span>\n            {parseProposalKeyAndValue(i.key, i.modifiedValue, i.originalValue)}\n            {i.key !== \"timeline\" && \"\uff65\"}\n            <Widget\n              src={`near/widget/TimeAgo`}\n              props={{\n                blockTimestamp: timestamp * 1000000,\n              }}\n            />\n          </div>\n        </LogIconContainer>\n      );\n    }\n  });\n};\nif (Array.isArray(state.data)) {\n  return (\n    <Wrapper>\n      <div\n        className=\"log-line\"\n        style={{ height: state.data.length > 2 ? \"110%\" : \"150%\" }}\n      ></div>\n      <div className=\"d-flex flex-column gap-4\">\n        {state.data.map((i, index) => {\n          if (i.blockHeight) {\n            const item = state.socialComments.find(\n              (t) => t.blockHeight === i.blockHeight\n            );\n            return <Comment commentItem={item} />;\n          } else {\n            return <Log timestamp={i.timestamp} key={index} />;\n          }\n        })}\n      </div>\n    </Wrapper>\n  );\n}\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bos.forum.potlock.near/widget/widget.components.proposals.CommentsAndLogs", "fact_widget_deployments_id": "e484f0852de6cef4898aa64265e1f4b5", "inserted_timestamp": "2024-07-01T06:54:47.770Z", "modified_timestamp": "2024-07-01T06:54:47.770Z", "__row_index": 0}