{"tx_hash": "2NFyqvEqM24thXktzJDV6dUk2NtbTyVvGPiZPJ9JuyHx", "action_id_social": "6CqsmSDKkZY4txyaGibvGGdtCWK85fhpxZLXCcKwgnVx-0-widget", "block_id": 122373367, "block_timestamp": "2024-07-01T06:29:01.653Z", "signer_id": "bos.forum.potlock.near", "widget_name": "widget.components.rfps.Feed", "source_code": "const { fetchGraphQL } = VM.require(\n  `bos.forum.potlock.near/widget/core.common`\n) || { fetchGraphQL: () => {} };\nconst { href } = VM.require(`devhub.near/widget/core.lib.url`);\nhref || (href = () => {});\nconst { readableDate } = VM.require(`devhub.near/widget/core.lib.common`) || {\n  readableDate: () => {},\n};\nconst { getGlobalLabels } = VM.require(\n  `bos.forum.potlock.near/widget/components.core.lib.contract`\n) || { getGlobalLabels: () => {} };\nconst Container = styled.div`\n  .full-width-div {\n    width: 100vw;\n    position: relative;\n    left: 50%;\n    right: 50%;\n    margin-left: -50vw;\n    margin-right: -50vw;\n  }\n  .card.no-border {\n    border-left: none !important;\n    border-right: none !important;\n    margin-bottom: -3.5rem;\n  }\n  @media screen and (max-width: 768px) {\n    font-size: 13px;\n  }\n  .text-sm {\n    font-size: 13px;\n  }\n  .bg-blue {\n    background-image: linear-gradient(to bottom, #4b7a93, #213236);\n    color: white;\n  }\n  .border-bottom {\n    border-bottom: 1px solid grey;\n  }\n  .cursor-pointer {\n    cursor: pointer;\n  }\n  .rfp-card {\n    border-left: none !important;\n    border-right: none !important;\n    border-bottom: none !important;\n    &:hover {\n      background-color: #f4f4f4;\n    }\n  }\n  .blue-btn {\n    background-color: #3c697d !important;\n    border: none;\n    color: white;\n    &:active {\n      color: white;\n    }\n  }\n  .bg-grey {\n    background: #e2e6ec;\n  }\n  @media screen and (max-width: 768px) {\n    .blue-btn {\n      padding: 0.5rem 0.8rem !important;\n      min-height: 32px;\n    }\n  }\n  a.no-space {\n    display: inline-block;\n  }\n  .text-wrap {\n    overflow: hidden;\n    white-space: normal;\n  }\n  .fw-semi-bold {\n    font-weight: 500;\n  }\n`;\nconst Heading = styled.div`\n  font-size: 24px;\n  font-weight: 700;\n  width: 100%;\n  .text-normal {\n    font-weight: normal !important;\n  }\n  @media screen and (max-width: 768px) {\n    font-size: 18px;\n  }\n`;\nconst rfpLabelOptions = getGlobalLabels();\nconst FeedItem = ({ rfp, index }) => {\n  const accountId = rfp.author_id;\n  const profile = Social.get(`${accountId}/profile/**`, \"final\");\n  // We will have to get the rfp from the contract to get the block height.\n  const blockHeight = parseInt(rfp.social_db_post_block_height);\n  const item = {\n    type: \"social\",\n    path: `forum.potlock.near/post/main`,\n    blockHeight: blockHeight,\n  };\n  return (\n    <a\n      href={href({\n        widgetSrc: `bos.forum.potlock.near/widget/app`,\n        params: {\n          page: \"rfp\",\n          id: rfp.rfp_id,\n        },\n      })}\n      onClick={(e) => e.stopPropagation()}\n      style={{ textDecoration: \"none\" }}\n    >\n      <div\n        className={\n          \"rfp-card d-flex justify-content-between gap-2 text-muted cursor-pointer p-3 w-100 flex-wrap flex-sm-nowrap \" +\n          (index !== 0 && \" border\")\n        }\n      >\n        <div className=\"d-flex gap-4 w-100\">\n          <Widget\n            src={`bos.forum.potlock.near/widget/components.molecule.Profile`}\n            props={{\n              accountId: rfp.author_id,\n            }}\n          />\n          <div className=\"d-flex flex-column gap-2 w-100 text-wrap\">\n            <div className=\"d-flex gap-2 align-items-center flex-wrap w-100\">\n              <div className=\"h6 mb-0 text-black\">{rfp.name}</div>\n              <Widget\n                src={`bos.forum.potlock.near/widget/components.molecule.MultiSelectCategoryDropdown`}\n                props={{\n                  selected: rfp.labels,\n                  disabled: true,\n                  hideDropdown: true,\n                  onChange: () => {},\n                  availableOptions: rfpLabelOptions,\n                }}\n              />\n            </div>\n            <div className=\"d-flex gap-2 align-items-center flex-wrap flex-sm-nowrap text-sm w-100\">\n              <div>#{rfp.rfp_id} \uff65 Created</div>\n              <Widget\n                src={`near/widget/TimeAgo`}\n                props={{\n                  blockHeight,\n                  blockTimestamp: rfp.timestamp,\n                }}\n              />\n            </div>\n            <div className=\"d-flex gap-4 flex-wrap flex-sm-nowrap text-sm w-100 text-muted my-2\">\n              <div\n                className=\"d-flex flex-column gap-1\"\n                style={{ maxWidth: \"70%\" }}\n              >\n                <div className=\"fw-semi-bold\">Summay</div>\n                <div>{rfp.summary}</div>\n              </div>\n              <div style={{ width: \"1px\" }} className=\"bg-grey\"></div>\n              <div className=\"d-flex flex-column gap-1\">\n                <div className=\"fw-semi-bold\">Submission Deadline</div>\n                <h6 className=\"mb-0 text-black\">\n                  {readableDate(rfp.submission_deadline / 1000000)}\n                </h6>\n              </div>\n            </div>\n            <div className=\"d-flex gap-2 align-items-center text-sm\">\n              <div>\n                <img\n                  src=\"https://ipfs.near.social/ipfs/bafkreif4p376f3qvpb2ewwsmi6fkcm3jalhuuzuxbgvehgl552agqw47ju\"\n                  height={30}\n                  width={30}\n                />\n                {rfp.linked_proposals.length ?? 0}\n                proposals\n              </div>\n              <div className=\"d-flex align-items-center\">\n                <Widget\n                  src={`devhub.near/widget/devhub.entity.proposal.CommentIcon`}\n                  props={{\n                    item,\n                    showOverlay: false,\n                    onClick: () => {},\n                  }}\n                />\n                comments\n              </div>\n            </div>\n          </div>\n        </div>\n        <div className=\"align-self-center\" style={{ minWidth: \"fit-content\" }}>\n          <Widget\n            src={`bos.forum.potlock.near/widget/components.rfps.StatusTag`}\n            props={{\n              timelineStatus: rfp.timeline.status,\n            }}\n          />\n        </div>\n      </div>\n    </a>\n  );\n};\nconst getRfp = (rfp_id) => {\n  return Near.asyncView(\"forum.potlock.near\", \"get_rfp\", {\n    rfp_id,\n  });\n};\nconst FeedPage = () => {\n  State.init({\n    data: [],\n    cachedItems: {},\n    stage: \"\",\n    sort: \"\",\n    label: \"\",\n    input: \"\",\n    loading: false,\n    loadingMore: false,\n    aggregatedCount: null,\n    currentlyDisplaying: 0,\n    isFiltered: false,\n  });\n  const queryName = \"megha19_near_forum_potlock_rfps_with_latest_snapshot\";\n  const query = `query GetLatestSnapshot($offset: Int = 0, $limit: Int = 10, $where: ${queryName}_bool_exp = {}) {\n    ${queryName}(\n      offset: $offset\n      limit: $limit\n      order_by: {rfp_id: desc}\n      where: $where\n    ) {\n      author_id\n      block_height\n      name\n      summary\n      editor_id\n      rfp_id\n      timeline\n      views\n      labels\n      submission_deadline\n      linked_proposals\n    }\n    ${queryName}_aggregate(\n      order_by: {rfp_id: desc}\n      where: $where\n    )  {\n      aggregate {\n        count\n      }\n    }\n  }`;\n  function separateNumberAndText(str) {\n    const numberRegex = /\\d+/;\n    if (numberRegex.test(str)) {\n      const number = str.match(numberRegex)[0];\n      const text = str.replace(numberRegex, \"\").trim();\n      return { number: parseInt(number), text };\n    } else {\n      return { number: null, text: str.trim() };\n    }\n  }\n  const buildWhereClause = () => {\n    let where = {};\n    if (state.label) {\n      where = { labels: { _contains: state.label }, ...where };\n    }\n    if (state.stage) {\n      // timeline is stored as jsonb\n      where = {\n        timeline: { _cast: { String: { _regex: `${state.stage}` } } },\n        ...where,\n      };\n    }\n    if (state.input) {\n      const { number, text } = separateNumberAndText(state.input);\n      if (number) {\n        where = { rfp_id: { _eq: number }, ...where };\n      }\n      if (text) {\n        where = {\n          _or: [\n            { name: { _iregex: `${text}` } },\n            { summary: { _iregex: `${text}` } },\n            { description: { _iregex: `${text}` } },\n          ],\n          ...where,\n        };\n      }\n    }\n    State.update({ isFiltered: Object.keys(where).length > 0 });\n    return where;\n  };\n  const buildOrderByClause = () => {\n    /**\n     * TODO\n     * Most commented -> edit contract and indexer\n     * Unanswered -> 0 comments\n     */\n  };\n  const makeMoreItems = () => {\n    if (state.aggregatedCount <= state.currentlyDisplaying) return;\n    fetchRfps(state.data.length);\n  };\n  const fetchRfps = (offset) => {\n    if (!offset) {\n      offset = 0;\n    }\n    if (state.loading) return;\n    const FETCH_LIMIT = 10;\n    const variables = {\n      limit: FETCH_LIMIT,\n      offset,\n      where: buildWhereClause(),\n    };\n    fetchGraphQL(query, \"GetLatestSnapshot\", variables).then(async (result) => {\n      if (result.status === 200) {\n        if (result.body.data) {\n          const data = result.body.data?.[queryName];\n          const totalResult = result.body.data?.[`${queryName}_aggregate`];\n          State.update({ aggregatedCount: totalResult.aggregate.count });\n          // Parse timeline\n          fetchBlockHeights(data, offset);\n        }\n      }\n    });\n  };\n  const renderItem = (item, index) => (\n    <div\n      key={item.rfp_id}\n      className={\n        (index !== state.data.length - 1 && \"border-bottom \") + index === 0 &&\n        \" rounded-top-2 rfp-item-container\"\n      }\n    >\n      <FeedItem rfp={item} index={index} />\n    </div>\n  );\n  const cachedRenderItem = (item, index) => {\n    if (props.term) {\n      return renderItem(item, {\n        searchKeywords: [props.term],\n      });\n    }\n    const key = JSON.stringify(item);\n    if (!(key in state.cachedItems)) {\n      state.cachedItems[key] = renderItem(item, index);\n      State.update();\n    }\n    return state.cachedItems[key];\n  };\n  useEffect(() => {\n    fetchRfps();\n  }, [state.input, state.sort, state.label, state.stage]);\n  const mergeItems = (newItems) => {\n    const items = [\n      ...new Set([...newItems, ...state.data].map((i) => JSON.stringify(i))),\n    ].map((i) => JSON.parse(i));\n    // Sorting in the front end\n    if (state.sort === \"rfp_id\" || state.sort === \"\") {\n      items.sort((a, b) => b.rfp_id - a.rfp_id);\n    } else if (state.sort === \"views\") {\n      items.sort((a, b) => b.views - a.views);\n    }\n    return items;\n  };\n  const fetchBlockHeights = (data, offset) => {\n    let promises = data.map((item) => getRfp(item.rfp_id));\n    Promise.all(promises).then((blockHeights) => {\n      data = data.map((item, index) => ({\n        ...item,\n        timeline: JSON.parse(item.timeline),\n        social_db_post_block_height:\n          blockHeights[index].social_db_post_block_height,\n      }));\n      if (offset) {\n        let newData = mergeItems(data);\n        State.update({\n          data: newData,\n          currentlyDisplaying: newData.length,\n          loading: false,\n        });\n      } else {\n        State.update({\n          data,\n          currentlyDisplaying: data.length,\n          loading: false,\n        });\n      }\n    });\n  };\n  const loader = (\n    <div className=\"d-flex justify-content-center align-items-center w-100\">\n      <Widget src={`devhub.near/widget/devhub.components.molecule.Spinner`} />\n    </div>\n  );\n  const renderedItems = state.data ? state.data.map(cachedRenderItem) : null;\n  const isAllowedToWriteRfp = Near.view(\n    \"forum.potlock.near\",\n    \"is_allowed_to_write_rfps\",\n    {\n      editor: context.accountId,\n    }\n  );\n  return (\n    <Container className=\"w-100 py-4 px-2 d-flex flex-column gap-3\">\n      <div className=\"d-flex justify-content-between flex-wrap gap-2 align-items-center\">\n        <Heading>\n          RFPs\n          <span className=\"text-muted text-normal\">\n            ({state.aggregatedCount ?? state.data.length}){\" \"}\n          </span>\n        </Heading>\n        <div className=\"d-flex flex-wrap gap-4 align-items-center\">\n          <Widget\n            src={`devhub.near/widget/devhub.feature.proposal-search.by-input`}\n            props={{\n              search: state.input,\n              className: \"w-xs-100\",\n              onSearch: (input) => {\n                State.update({ input });\n                fetchRfps();\n              },\n              onEnter: () => {\n                fetchRfps();\n              },\n            }}\n          />\n          <Widget\n            src={`devhub.near/widget/devhub.feature.proposal-search.by-sort`}\n            props={{\n              onStateChange: (select) => {\n                State.update({ sort: select.value });\n              },\n            }}\n          />\n          <Widget\n            src={`bos.forum.potlock.near/widget/components.molecule.FilterByLabel`}\n            props={{\n              onStateChange: (select) => {\n                State.update({ label: select.value });\n              },\n              availableOptions: rfpLabelOptions,\n            }}\n          />\n          <div className=\"d-flex gap-4 align-items-center\">\n            <Widget\n              src={`bos.forum.potlock.near/widget/components.rfps.StageDropdown`}\n              props={{\n                onStateChange: (select) => {\n                  State.update({ stage: select.value });\n                },\n              }}\n            />\n          </div>\n        </div>\n        {isAllowedToWriteRfp && (\n          <div className=\"mt-2 mt-xs-0\">\n            <Link\n              to={href({\n                widgetSrc: `bos.forum.potlock.near/widget/app`,\n                params: { page: \"create-rfp\" },\n              })}\n            >\n              <Widget\n                src={`devhub.near/widget/devhub.components.molecule.Button`}\n                props={{\n                  label: (\n                    <div className=\"d-flex gap-2 align-items-center\">\n                      <div>\n                        <i className=\"bi bi-plus-circle-fill\"></i>\n                      </div>\n                      Create RFP\n                    </div>\n                  ),\n                  classNames: { root: \"blue-btn\" },\n                }}\n              />\n            </Link>\n          </div>\n        )}\n      </div>\n      <div style={{ minHeight: \"50vh\" }}>\n        {!Array.isArray(state.data) ? (\n          loader\n        ) : (\n          <div className=\"card no-border rounded-0 mt-4 py-3 full-width-div\">\n            <div className=\"container-xl\">\n              <div>\n                <Widget\n                  src={`bos.forum.potlock.near/widget/components.pages.announcement`}\n                  loading=\"\"\n                />\n              </div>\n              <div className=\"mt-4 border rounded-2\">\n                {state.aggregatedCount === 0 ? (\n                  <div className=\"m-2\">\n                    {state.isFiltered ? (\n                      <div class=\"alert alert-danger\" role=\"alert\">\n                        No RFP found for selected filter.\n                      </div>\n                    ) : (\n                      <div class=\"alert alert-secondary\" role=\"alert\">\n                        No RFP has been created yet.\n                      </div>\n                    )}\n                  </div>\n                ) : state.aggregatedCount > 0 ? (\n                  <InfiniteScroll\n                    pageStart={0}\n                    loadMore={makeMoreItems}\n                    hasMore={state.aggregatedCount > state.data.length}\n                    loader={loader}\n                    useWindow={false}\n                    threshold={100}\n                  >\n                    {renderedItems}\n                  </InfiniteScroll>\n                ) : (\n                  loader\n                )}\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </Container>\n  );\n};\nreturn FeedPage(props);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bos.forum.potlock.near/widget/widget.components.rfps.Feed", "fact_widget_deployments_id": "45abd6cafa02081c1eb96fafa6630966", "inserted_timestamp": "2024-07-01T07:54:38.137Z", "modified_timestamp": "2024-07-01T07:54:38.137Z", "__row_index": 1}