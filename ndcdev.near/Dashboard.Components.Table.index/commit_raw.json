{"tx_hash": "DBJArr9jbzuJnNxRissTNrq9EdsG8VDDuLtBa8TNiXnv", "action_id_social": "5Dz6HAt4eNBz1YyRn48Afez13VdB1ZwoCpjpZoW42hBt-0-widget", "block_id": 112487562, "block_timestamp": "2024-02-09T19:58:38.039Z", "signer_id": "ndcdev.near", "widget_name": "Dashboard.Components.Table.index", "source_code": "const { ScrollableWrapper } = VM.require(\n  `ndcdev.near/widget/Dashboard.Components.Table.styled`,\n);\n\nconst { ndcDAOs, API } = props;\nconst Loading = () => <Widget src=\"flashui.near/widget/Loading\" />;\n\nif (!ScrollableWrapper) return <Loading />;\n\nconst defaultDAOOption = \"All DAOs\";\nconst CURRENCIES = {\n  NEAR: \"Near\",\n  \"USDC.e\": \"a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48.factory.bridge.near\",\n  \"USDT.e\": \"dac17f958d2ee523a2206206994597c13d831ec7.factory.bridge.near\",\n};\nconst RETENTIONS = [\"1 month\", \"2 months\", \"3 months\", \"4 months\"];\nconst DAPPS_USED_PERIOD = [\"All Time\"];\n\nconst FILTER_IDS = {\n  dao: \"dao\",\n  userRetention: \"userRetention\",\n  dapUsed: \"dapUsed\",\n  aquisitionCost: \"aquisitionCost\",\n};\n\nconst FILTER_OPENS = Object.keys(FILTER_IDS).map((item) => {\n  return { [item]: false };\n});\n\nconst [dataSet, setDataSet] = useState({});\nconst [loading, setLoading] = useState(false);\n\nconst [allDAOs, setAllDAOs] = useState([]);\nconst [allDapps, setAllDapps] = useState([]);\nconst [selectedDAOs, setSelectedDAOs] = useState([]);\nconst [selectedRetention, setSelectedRetention] = useState(0);\nconst [selectedCurrency, setSelectedCurrency] = useState(\n  Object.keys(CURRENCIES)[0],\n);\n\nconst [filtersIsOpen, setFiltersIsOpen] = useState(FILTER_OPENS);\nconst onFilterClick = (value) =>\n  setFiltersIsOpen({ ...FILTER_OPENS, [value]: !filtersIsOpen[value] });\n\nconst FILTERS = [\n  {\n    id: FILTER_IDS.dao,\n    text: \"DAO\",\n    hintText: \"NDC grassroots DAOs\",\n    options: [defaultDAOOption, ...ndcDAOs],\n    values: selectedDAOs,\n    defaultValue: defaultDAOOption,\n    multiple: true,\n    filterIsOpen: filtersIsOpen[FILTER_IDS.dao],\n    onFilterClick,\n    onChange: (value) => filterDAO(value),\n    onClear: () => {\n      setSelectedDAOs([]);\n    },\n  },\n  {\n    id: FILTER_IDS.userRetention,\n    text: \"User Retention\",\n    hintText:\n      \"The percentage of accounts who continue interacting on chain recently: Accounts onboarded/Accounts left\",\n    options: RETENTIONS,\n    values: [RETENTIONS[selectedRetention]],\n    filterIsOpen: filtersIsOpen[FILTER_IDS.userRetention],\n    onFilterClick,\n    onChange: (value) => setSelectedRetention(RETENTIONS.indexOf(value)),\n  },\n  {\n    id: FILTER_IDS.dapUsed,\n    text: \"DApp's Used\",\n    hintText:\n      \"Median number of dApps used by accounts retained for more then a week\",\n    options: DAPPS_USED_PERIOD,\n    values: [DAPPS_USED_PERIOD[0]],\n    filterIsOpen: filtersIsOpen[FILTER_IDS.dapUsed],\n    onFilterClick,\n    onChange: (value) => {},\n  },\n  {\n    id: FILTER_IDS.aquisitionCost,\n    text: \"Acquisition Cost\",\n    hintText:\n      \"Budget divided by the number of accounts interacting  through the funded initiative\",\n    options: Object.keys(CURRENCIES),\n    values: [selectedCurrency],\n    filterIsOpen: filtersIsOpen[FILTER_IDS.aquisitionCost],\n    onFilterClick,\n    onChange: (value) => setSelectedCurrency(value),\n  },\n];\n\nconst sortByDAOName = (keys) =>\n  Object.keys(keys)\n    .sort()\n    .reduce((obj, key) => {\n      obj[key] = keys[key];\n      return obj;\n    }, {});\n\nconst filterDAO = (value) => {\n  let newSelection;\n\n  if (value === defaultDAOOption) {\n    const all = [defaultDAOOption, ...ndcDAOs];\n    const isCurrentSelectionFull = selectedDAOs.length === all.length;\n    newSelection = isCurrentSelectionFull ? [] : all;\n  } else if (selectedDAOs.includes(value)) {\n    newSelection = selectedDAOs.filter(\n      (daoId) => daoId !== value && daoId !== defaultDAOOption,\n    );\n  } else {\n    newSelection = [...selectedDAOs, value];\n  }\n\n  setSelectedDAOs(newSelection);\n};\n\nconst fetchDapps = () => {\n  setLoading(true);\n\n  API.get_dapps().then((resp) => {\n    if (!resp.body) {\n      setLoading(false);\n      return;\n    }\n\n    const dapps = resp.body;\n    if (dapps)\n      setAllDapps(\n        Object.values(dapps)\n          .map((dapps) => dapps.map((d) => d.account_id))\n          .reduce((a, b) => [...a, ...b], []),\n      );\n  });\n};\n\nconst fetchData = () => {\n  setLoading(true);\n  const filtredDAOs = selectedDAOs.length ? selectedDAOs : ndcDAOs;\n  let newDataSet = {};\n\n  const promises = filtredDAOs.flatMap((daoId) => {\n    newDataSet[daoId] = {\n      balance: 0,\n      interactedAccounts: 0,\n      dappsUsed: 0,\n      retention: {\n        start: 0,\n        end: 0,\n      },\n    };\n\n    return [\n      API.get_retentions(daoId).then((resp) => {\n        if (!resp.body) return;\n\n        const data = resp.body;\n\n        if (data) {\n          const retentionIndex =\n            selectedRetention > data.length - 1\n              ? data.length - 1\n              : selectedRetention;\n          newDataSet[daoId].retention = {\n            start: parseInt(data[retentionIndex].unique_users_start),\n            end: parseInt(data[retentionIndex].unique_users_end),\n          };\n        }\n      }),\n      API.get_balance(daoId).then((resp) => {\n        if (!resp.body) return;\n\n        const data = resp.body;\n        if (data)\n          newDataSet[daoId].balance =\n            data.find((d) => d.contract === CURRENCIES[selectedCurrency])\n              ?.amount ?? 0;\n      }),\n      API.get_contract_relations(daoId).then((resp) => {\n        if (!resp.body) return;\n\n        const interactedAccounts = resp.body;\n        if (interactedAccounts) {\n          newDataSet[daoId].interactedAccounts = interactedAccounts.length;\n          newDataSet[daoId].dappsUsed = allDapps.filter((dapp) =>\n            interactedAccounts.includes(dapp),\n          ).length;\n        }\n      }),\n    ];\n  });\n\n  Promise.all(promises).then(() => {\n    const orderedByDAOState = sortByDAOName(newDataSet);\n    setDataSet(orderedByDAOState);\n    setLoading(false);\n  });\n};\n\nuseEffect(() => {\n  fetchDapps();\n}, []);\n\nuseEffect(() => {\n  fetchData();\n}, [selectedDAOs, selectedRetention, selectedCurrency, allDapps]);\n\nreturn (\n  <ScrollableWrapper>\n    <div className=\"d-flex gap-2 w-100\">\n      {FILTERS.map((filter) => (\n        <Widget\n          key={filter.id}\n          src={`ndcdev.near/widget/Dashboard.Components.Table.Filters.index`}\n          props={{ ...filter }}\n        />\n      ))}\n    </div>\n    {loading ? (\n      <Loading />\n    ) : (\n      <Widget\n        src={`ndcdev.near/widget/Dashboard.Components.Table.Cells.index`}\n        props={{ dataSet }}\n      />\n    )}\n  </ScrollableWrapper>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/ndcdev.near/widget/Dashboard.Components.Table.index", "fact_widget_deployments_id": "ecb8a681ab29a448cf5cb6ea7e0b16c7", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 3}