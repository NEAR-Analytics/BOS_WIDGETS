{"tx_hash": "FErCSz5XuHDx2fB8bn6nYZUX2oFQPuYPDiUqmd4bfQZD", "action_id_social": "1v6rxnuqBkXj1kvSDtJfYei1G9Pvbs7E2q19YxUXKvV-0-widget", "block_id": 112455113, "block_timestamp": "2024-02-09T09:59:03.754Z", "signer_id": "ndcdev.near", "widget_name": "Dashboard.Pages.Home", "source_code": "const { ndcDAOs } = VM.require(`ndcdev.near/widget/Dashboard.Config`);\nconst { Container, ChartContainer } = VM.require(\n  `ndcdev.near/widget/Dashboard.Pages.styled`,\n);\n\nif (!ndcDAOs || !Container || !ChartContainer)\n  return <Widget src=\"flashui.near/widget/Loading\" />;\n\nconst PERIODS = [\"daily\", \"weekly\", \"monthly\"];\nconst defaultDAOOption = \"All DAOs\";\nconst dailyTotal = { labels: [], data: [] };\nconst dailyTotalUsers = { labels: [], data: [] };\n\nconst [loading, setLoading] = useState(false);\nconst [period, setPeriod] = useState(PERIODS[0]);\nconst [selectedDAOs, setSelectedDAOs] = useState([]);\nconst [dataState, setDataState] = useState({\n  totalTx: 0,\n  totalAccounts: 0,\n  uniqueAccounts: 0,\n  dailyTotalTx: [],\n  uniqueActiveUsers: [],\n});\n\nconst baseUrl = \"https://api.pikespeak.ai\";\n\nconst get = async (url) => {\n  try {\n    return asyncFetch(`${baseUrl}/${url}`, {\n      method: \"GET\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"x-api-key\": \"36f2b87a-7ee6-40d8-80b9-5e68e587a5b5\",\n      },\n    });\n  } catch (e) {\n    console.log(e);\n  }\n};\n\nconst API = {\n  get_accounts: (accountId) =>\n    get(`event-historic/account/relationships/${accountId}?search=${accountId}\n  `),\n  get_unique_accounts_by_period: (accountId) =>\n    get(`contract-analysis/unique-users-by-period/${accountId}`),\n  get_activity_by_period: (accountId) =>\n    get(`contract-analysis/metrics/${accountId}`),\n  get_retentions: (accountId) =>\n    get(`contract-analysis/retention/${accountId}`),\n  get_dapps_spends: (accountId) =>\n    get(`/contract-analysis/crossdapp-near-spending/${accountId}`),\n  get_aquisition_cost: (accountId) =>\n    get(`/contract-analysis/metrics/${accountId}`),\n  get_contract_relations: (accountId) =>\n    get(\n      `/event-historic/account/relationships/${accountId}?search=${accountId}`,\n    ),\n  get_balance: (accountId) => get(`/account/balance/${accountId}`),\n  get_dapps: () => get(`/contract-analysis/classification?isDapp=true`),\n  // get_dapps_categories: () => get(`/contract-analysis/classification-categories`),\n};\n\nconst fetchData = () => {\n  setLoading(true);\n  let newState = {\n    totalTx: 0,\n    totalAccounts: 0,\n    uniqueAccounts: 0,\n    dailyTotalTx: [],\n    uniqueActiveUsers: [],\n  };\n\n  const daos = selectedDAOs.length ? selectedDAOs : ndcDAOs;\n\n  const promises = daos.flatMap((accountId) => [\n    API.get_accounts(accountId).then((resp) => {\n      if (!resp.body) return;\n\n      newState.totalAccounts += resp.body.length;\n    }),\n    API.get_unique_accounts_by_period(accountId).then((resp) => {\n      if (!resp.body) return;\n\n      newState.uniqueAccounts += parseInt(resp.body[period].data.length);\n      newState.uniqueActiveUsers.push(...resp.body[period].data);\n      newState.totalTx += resp.body[period].data.reduce(\n        (memo, current) => memo + parseInt(current.tx_count),\n        0,\n      );\n      newState.dailyTotalTx.push(\n        ...resp.body[period].data.map((item) => ({\n          date: item.day,\n          count: parseInt(item.tx_count),\n        })),\n      );\n    }),\n  ]);\n\n  Promise.all(promises).then(() => {\n    setDataState(newState);\n    setLoading(false);\n  });\n};\n\nuseEffect(() => {\n  fetchData();\n}, [selectedDAOs, period]);\n\ndataState.dailyTotalTx\n  .sort((a, b) => new Date(a.date) - new Date(b.date))\n  .forEach((element) => {\n    dailyTotal.labels.push(element.date);\n    dailyTotal.data.push(element.count);\n  });\n\ndataState.uniqueActiveUsers\n  .sort((a, b) => new Date(a.day) - new Date(b.day))\n  .forEach((element) => {\n    dailyTotalUsers.labels.push(element.day);\n    dailyTotalUsers.data.push(element.unique_users);\n  });\n\n\nconst onSelectChange = (value) => {\n  const isDefaultOption = value === defaultDAOOption;\n\n  const updateSelectedDAOs = () => {\n    if (isDefaultOption) {\n      const all = [...ndcDAOs, defaultDAOOption];\n      if (selectedDAOs.length === all.length) {\n        return []\n      }\n      return all;\n    } else if (selectedDAOs.includes(value)) {\n      return selectedDAOs.filter(dao => dao !== value && dao !== defaultDAOOption);\n    } else {\n    \n      return [...selectedDAOs, value];\n    }\n  };\n\n  setSelectedDAOs(updateSelectedDAOs());\n}\n\nconst SelectContainer = styled.div`\n  @media screen and (max-width: 768px){\n    flex-direction: column;\n  }\n`\n\nreturn (\n  <Container>\n    <div className=\"section\">\n      <SelectContainer className=\"d-flex w-100 gap-3 justify-content-between\">\n        <div className=\"select-dao\">\n          <Widget\n            src={`ndcdev.near/widget/Dashboard.Components.Select.index`}\n            props={{\n              options: ndcDAOs,\n              defaultValue: defaultDAOOption,\n              multiple: true,\n              values: selectedDAOs,\n              containerClass: \"selected-container\",\n              onClear: () => setSelectedDAOs([]),\n              onChange: onSelectChange,\n            }}\n          />\n        </div>\n        <div className=\"select-period\">\n          <Widget\n            src={`ndcdev.near/widget/Dashboard.Components.Select.index`}\n            props={{\n              options: PERIODS,\n              isOpen: selectOpen,\n              values: period,\n              onChange: setPeriod,\n              containerClass: \"selected-container\",\n            }}\n          />\n        </div>\n      </SelectContainer>\n    </div>\n    <Widget\n      src={`ndcdev.near/widget/Dashboard.Components.MetricsDisplay.index`}\n      props={{\n        totalTx: dataState.totalTx,\n        totalAccounts: dataState.totalAccounts,\n        uniqueAccounts: dataState.uniqueAccounts,\n        loading,\n      }}\n    />\n    <ChartContainer>\n      <Widget\n        src={`ndcdev.near/widget/Dashboard.Components.Chart.index`}\n        props={{\n          title: \"DAILY NUMBER OF TRANSACTIONS\",\n          data: dailyTotal,\n          loading,\n        }}\n      />\n      <Widget\n        src={`ndcdev.near/widget/Dashboard.Components.Chart.index`}\n        props={{\n          title: \"UNIQUE ACTIVE USERS\",\n          data: dailyTotalUsers,\n          loading,\n        }}\n      />\n    </ChartContainer>\n    <div className=\"section py-5 flex-column\">\n      <Widget\n        src={`ndcdev.near/widget/Dashboard.Components.Table.index`}\n        props={{ ndcDAOs, API }}\n      />\n    </div>\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/ndcdev.near/widget/Dashboard.Pages.Home", "fact_widget_deployments_id": "911ab11ec7f91c48619e08b3057e4739", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 4}