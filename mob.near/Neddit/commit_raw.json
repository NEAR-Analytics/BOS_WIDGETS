{"tx_hash": "3i8jRR7QHJqEGc6fXPVWz5nDMifFFYeUNZszCmTYMSEn", "action_id_social": "5TXJMNMEhJrfqEs7EdZruzmzUGeUgSrJeD6vo8wFMsKF-0-widget", "block_id": 105221939, "block_timestamp": "2023-11-08T12:46:06.416Z", "signer_id": "mob.near", "widget_name": "Neddit", "source_code": "const [subneddit, setSubneddit] = useState(props.n || \"all\");\n\nconsole.log(subneddit);\n\nconst renderPage = (content) => (\n  <div key=\"root\">\n    <Widget\n      key=\"selector\"\n      src=\"mob.near/widget/Neddit.Subneddit.Selector\"\n      props={{\n        subneddit,\n        onChange: setSubneddit,\n      }}\n    />\n    <Widget\n      loading=\"\"\n      key=\"compose\"\n      src=\"mob.near/widget/Neddit.Compose\"\n      props={{ subneddit }}\n    />\n    {content}\n  </div>\n);\nconst renderLoading = () => renderPage(\"Loading\");\nconst fetchLimit = props.fetchLimit ? parseInt(props.fetchLimit) : 500;\nconst renderLimit = props.renderLimit ? parseInt(props.renderLimit) : 10;\nconst initialRenderLimit = props.initialRenderLimit\n  ? parseInt(props.initialRenderLimit)\n  : renderLimit;\nconst halflife = props.halflife\n  ? parseFloat(props.halflife)\n  : (24 * 60 * 60) / 1.3;\n\nconst [displayCount, setDisplayCount] = useState(initialRenderLimit);\n\nlet rawIndex = Social.index(\"neddit\", subneddit, {\n  order: \"desc\",\n  limit: fetchLimit,\n});\n\nif (rawIndex === null) {\n  return renderLoading();\n}\n\nconst posts = rawIndex\n  .map(({ accountId, blockHeight, value }) => {\n    if (value.type !== \"md\") {\n      return null;\n    }\n    return {\n      accountId,\n      blockHeight,\n      item: {\n        type: \"social\",\n        path: value?.item?.path ?? `${accountId}/post/main`,\n        blockHeight: value?.item?.blockHeight ?? blockHeight,\n      },\n    };\n  })\n  .filter((a) => !!a);\n\nconst likes = fetch(\"https://api.near.social/api/experimental/likes\", {\n  method: \"POST\",\n  headers: {\n    \"Content-Type\": \"application/json\",\n  },\n  body: JSON.stringify({\n    item: posts.map((p) => p.item),\n  }),\n}).body;\n\nif (!likes) {\n  return renderLoading();\n}\n\nconst latestBlockHeight = posts[0].blockHeight ?? 0;\n\nconst score = (i) => {\n  const post = posts[i];\n  const age = latestBlockHeight - post.blockHeight;\n  const numLikes = likes[i].length + 0.1;\n  return numLikes / Math.exp(1 + age / halflife);\n};\n\nconst order = [...Array(posts.length).keys()];\norder.sort((a, b) => score(b) - score(a));\n\nconst render = (post) => {\n  const accountId = post.item.path.split(\"/\")[0];\n  const blockHeight = post.item.blockHeight;\n  const link = `/mob.near/widget/Neddit.Post.Page?accountId=${accountId}&blockHeight=${blockHeight}`;\n  return (\n    <div key={JSON.stringify(post)}>\n      <Widget\n        loading={<div className=\"w-100\" style={{ height: \"200px\" }} />}\n        src=\"mob.near/widget/Neddit.Post\"\n        props={{\n          accountId,\n          blockHeight,\n          fullPostLink: link,\n          hideComments: true,\n          hideButtons: true,\n          customButtons: (\n            <div className=\"buttons d-flex justify-content-between\">\n              <Widget\n                loading=\"\"\n                src=\"mob.near/widget/N.LikeButton\"\n                props={{\n                  notifyAccountId: accountId,\n                  item: post.item,\n                }}\n              />\n              <Widget\n                loading=\"\"\n                src=\"mob.near/widget/MainPage.N.Post.ShareButton\"\n                props={{ accountId, blockHeight, postType: \"post\", link }}\n              />\n            </div>\n          ),\n        }}\n      />\n    </div>\n  );\n};\n\nreturn renderPage(\n  <InfiniteScroll\n    key=\"content\"\n    pageStart={0}\n    loadMore={() => {\n      setDisplayCount(displayCount + renderLimit);\n    }}\n    threshold={props.threshold ?? 800}\n    hasMore={displayCount <= posts.length}\n    loader={loader}\n  >\n    {order.slice(0, displayCount).map((i) => render(posts[i]))}\n  </InfiniteScroll>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/mob.near/widget/Neddit", "fact_widget_deployments_id": "06e55947913bfd52495847b3ec95085b", "inserted_timestamp": "2023-11-08T14:40:51.715Z", "modified_timestamp": "2023-11-08T14:40:51.715Z", "__row_index": 1}