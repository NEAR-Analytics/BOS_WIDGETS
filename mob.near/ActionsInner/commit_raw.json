{"tx_hash": "CbzV3ZeRhHDFKDGKKrmyzHB5H2wLe8VPSdQ92PFLD4QT", "action_id_social": "mWZEUe42My2VRvB3HyACsY1YjArKJSFQh7JNEevGVCE-0-widget", "block_id": 113255999, "block_timestamp": "2024-02-21T01:32:54.632Z", "signer_id": "mob.near", "widget_name": "ActionsInner", "source_code": "const accountId = props.accountId;\nif (!accountId) {\n  return \"\";\n}\nconst [actions, setActions] = useState(false);\n\nconst Limit = 50;\n\nconst actionsFilter = useMemo(\n  () =>\n    [\n      \"account_id\",\n      \"args_account_id\",\n      \"args_new_account_id\",\n      \"args_nft_contract_id\",\n      \"args_owner_id\",\n      \"args_receiver_id\",\n      \"args_sender_id\",\n      \"predecessor_id\",\n      \"signer_id\",\n    ].map((key) => ({\n      [key]: accountId,\n      status: \"SUCCESS\",\n    })),\n  [accountId]\n);\n\nconst toCamel = (s) => {\n  return s.replace(/([-_][a-z])/gi, ($1) => {\n    return $1.toUpperCase().replace(\"-\", \"\").replace(\"_\", \"\");\n  });\n};\n\nfunction processAction(action) {\n  action = Object.fromEntries(\n    Object.entries(action).map(([k, v]) => [toCamel(k), v])\n  );\n  action.time = new Date(action.blockTimestamp * 1000);\n  action.id = `${action.receiptId}:${action.actionIndex}`;\n  return action;\n}\n\nconst processActions = (newActions) => {\n  newActions = newActions.flatMap(processAction);\n  newActions.reverse();\n\n  setActions((prevActions) =>\n    [\n      ...newActions.filter(\n        (event) =>\n          !prevActions ||\n          prevActions.length === 0 ||\n          event.time.getTime() > prevActions[0].time.getTime()\n      ),\n      ...(prevActions || []),\n    ].slice(0, Limit)\n  );\n};\n\nfunction connect() {\n  console.log(\"Triggered connect\");\n  const ws = new WebSocket(\"wss://actions.near.stream/ws\");\n\n  ws.onopen = () => {\n    console.log(`Connection to WS has been established`);\n    ws.send(\n      JSON.stringify({\n        secret: `near-social-actions-${new Date().getTime()}}`,\n        filter: actionsFilter,\n        fetch_past_actions: Limit,\n      })\n    );\n  };\n  ws.onclose = () => {\n    console.log(`WS Connection has been closed`);\n    connect();\n  };\n  ws.onmessage = (e) => {\n    const data = JSON.parse(e.data);\n    processActions(data.actions);\n  };\n  ws.onerror = (err) => {\n    console.log(\"WebSocket error\", err);\n  };\n\n  return ws;\n}\n\nuseEffect(() => {\n  setActions(false);\n  const ws = connect();\n\n  return () => {\n    // shutdown\n    console.log(\"Shutdown\");\n    ws.close();\n  };\n}, [accountId]);\n\nconst Wrapper = styled.div`\n.header {\n  margin-bottom: 1em;\n}\n.action {\n  margin-bottom: 1em;\n  overflow: hidden;\n}\n`;\n\nconst renderAction = (action) => {\n  return (\n    <div>\n      <div>\n        Time:{\" \"}\n        <Widget\n          loading=\"Xs\"\n          src=\"mob.near/widget/TimeAgoMs\"\n          props={{ timeMs: action.blockTimestamp * 1000 }}\n        />{\" \"}\n        ago\n      </div>\n      <div>Type: {action.action}</div>\n      {action.methodName && <div>Method: {action.methodName}</div>}\n      <div>Receipt: {action.receiptId}</div>\n      <div className=\"text-nowrap\">\n        Predecessor:{\" \"}\n        <Widget\n          src=\"mob.near/widget/N.ProfileLine\"\n          props={{ accountId: action.predecessorId }}\n        />\n      </div>\n    </div>\n  );\n};\n\nreturn (\n  <Wrapper>\n    <div className=\"header\">\n      Actions of\n      <Widget src=\"mob.near/widget/N.ProfileLine\" props={{ accountId }} />\n    </div>\n    <div className=\"actions\">\n      {actions\n        ? actions.map((action) => (\n            <div key={action.id} className=\"action\">\n              {renderAction(action)}\n            </div>\n          ))\n        : \"Loading\"}\n    </div>\n  </Wrapper>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/mob.near/widget/ActionsInner", "fact_widget_deployments_id": "895fc08d24dd79103df911f244bb3bf0", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}