{"tx_hash": "J7EJSdUMve7VamseAJnpvCDK71ZE5Cs7WhLdvGcaAB4F", "action_id_social": "4GPYjp75n3r3tajJra6SugUA6Eg9sWp7yHBXMtYDcryZ-0-widget", "block_id": 115742797, "block_timestamp": "2024-03-29T21:30:07.438Z", "signer_id": "mob.near", "widget_name": "Tokens.Inner", "source_code": "const accountId = props.accountId;\nif (!accountId) {\n  return \"\";\n}\n\nconst [tokens, setTokens] = useState(false);\nconst [loading, setLoading] = useState(true);\n\nconst { bigToString, MutedDecimals } = VM.require(\n  \"mob.near/widget/Token.utils\"\n);\n\n// const priceData = Near.view(\"priceoracle.near\", \"get_price_data\");\nconst refPrices = JSON.parse(\n  fetch(\"https://indexer.ref.finance/list-token-price\").body || \"{}\"\n);\nconst accountBalance = fetch(\"https://rpc.mainnet.near.org\", {\n  method: \"POST\",\n  request_type: \"json\",\n  headers: {\n    \"Content-Type\": \"application/json; charset=utf-8\",\n  },\n  body: JSON.stringify({\n    jsonrpc: \"2.0\",\n    id: \"0\",\n    method: \"query\",\n    params: {\n      request_type: \"view_account\",\n      finality: \"optimistic\",\n      account_id: accountId,\n    },\n  }),\n}).body.result.amount;\n\nuseEffect(() => {\n  setTokens(false);\n  setLoading(true);\n  asyncFetch(`https://api.fastnear.com/v1/account/${accountId}/ft`)\n    .then((res) => {\n      if (!res.ok) {\n        console.error(\"Failed to fetch ft_with_balances\", res);\n        return;\n      }\n      setTokens(\n        Object.fromEntries(\n          (res.body.tokens || [])\n            .filter(({ balance }) => !!balance)\n            .map(({ contract_id, balance }) => [contract_id, balance])\n        )\n      );\n    })\n    .finally(() => setLoading(false));\n}, [accountId]);\n\nconst sortedTokens = useMemo(() => {\n  if (!tokens) {\n    return tokens;\n  }\n  tokens[\"near\"] = accountBalance;\n  // const prices = Object.fromEntries(\n  //   (priceData?.prices || []).map(({ asset_id, price }) => [asset_id, price])\n  // );\n  const computeUsdBalance = (tokenId, balance) => {\n    if (balance === null) {\n      return \"0\";\n    }\n    const price =\n      tokenId === \"near\"\n        ? refPrices[\"wrap.near\"]\n        : refPrices[tokenId] || {\n            price: \"0\",\n            decimal: 1,\n          };\n    return Big(price.price)\n      .mul(Big(balance))\n      .div(Big(10).pow(price.decimal))\n      .toFixed(6);\n  };\n  const st = Object.entries(tokens).map(([tokenId, balance]) => ({\n    tokenId,\n    balance,\n    usdBalance: computeUsdBalance(tokenId, balance),\n  }));\n  st.sort((a, b) => parseFloat(b.balance) - parseFloat(a.balance));\n  st.sort((a, b) => parseFloat(b.usdBalance) - parseFloat(a.usdBalance));\n  return st;\n}, [tokens, refPrices, accountBalance]);\n\nconst Wrapper = styled.div`\n.header {\n  margin-bottom: 1em;\n}\n.token {\n  overflow: hidden;\n}\n`;\n\nconst renderToken = ({ tokenId, balance, usdBalance }) => {\n  return (\n    <Widget\n      loading=\"\"\n      src=\"mob.near/widget/Tokens.TokenWithBalance\"\n      props={{ tokenId, balance, usdBalance }}\n    />\n  );\n};\n\nconst usdSum = sortedTokens\n  ? sortedTokens\n      .map(({ usdBalance }) => parseFloat(usdBalance || \"0\"))\n      .reduce((s, v) => s + v, 0)\n  : 0;\n\nreturn (\n  <Wrapper>\n    <div className=\"header\">\n      Fungible Tokens of\n      <Widget src=\"mob.near/widget/N.ProfileLine\" props={{ accountId }} />\n      {usdSum > 0 && (\n        <div>\n          Total USD sum:\n          <span className=\"font-monospace fw-bold d-inline-flex\">\n            <span className=\"text-secondary\">~$</span>\n            <MutedDecimals value={bigToString(usdSum)} />\n          </span>\n        </div>\n      )}\n    </div>\n    <div className=\"actions\">\n      {sortedTokens\n        ? sortedTokens\n            .filter((t) => t.balance !== null)\n            .map((t) => (\n              <div key={t.tokenId} className=\"token\">\n                {renderToken(t)}\n              </div>\n            ))\n        : \"Loading\"}\n    </div>\n  </Wrapper>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/mob.near/widget/Tokens.Inner", "fact_widget_deployments_id": "dfbf7f85f750fcd3b85d07e76712a307", "inserted_timestamp": "2024-03-29T22:34:44.557Z", "modified_timestamp": "2024-03-29T23:29:38.060Z", "__row_index": 0}