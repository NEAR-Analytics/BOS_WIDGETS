{"tx_hash": "AN81kzeiqRGR6F2VdS29j3uL7BBtJMXza56FB7SxZS81", "action_id_social": "2ytiTg8Z8Te6dbDZTNSvQyN75Y4N2ckVyA9dnBvuVjGY-0-widget", "block_id": 112256365, "block_timestamp": "2024-02-06T20:06:32.109Z", "signer_id": "thomasguntenaar.near", "widget_name": "devhub.entity.community.Discussions", "source_code": "const { handle } = props;\nconst { getCommunity, setCommunitySocialDB } = VM.require(\n  \"thomasguntenaar.near/widget/core.adapter.devhub-contract\"\n);\n\ngetCommunity = getCommunity || (() => <></>);\nsetCommunitySocialDB = setCommunitySocialDB || (() => <></>);\n\nconst communityData = getCommunity({ handle });\n\nconst MainContent = styled.div`\n  padding-left: 2rem;\n  flex: 3;\n  @media screen and (max-width: 960px) {\n    padding-left: 0rem;\n  }\n  .post:hover {\n    background-color: inherit !important;\n  }\n`;\n\nconst SidebarContainer = styled.div`\n  flex: 1;\n`;\n\nconst Heading = styled.div`\n  font-size: 19px;\n  font-weight: 600;\n`;\n\nconst SubHeading = styled.div`\n  font-size: 15px;\n  font-weight: 600;\n`;\n\nconst Container = styled.div`\n  flex-wrap: no-wrap;\n  max-width: 100%;\n\n  .max-width-100 {\n    max-width: 100%;\n  }\n  @media screen and (max-width: 960px) {\n    flex-wrap: wrap;\n  }\n\n  .card {\n    border-radius: 1rem !important;\n  }\n`;\n\nconst Tag = styled.div`\n  border-top-right-radius: 50px;\n  border-bottom-right-radius: 50px;\n  border-top-left-radius: 50px;\n  border-bottom-left-radius: 50px;\n  padding-inline: 0.8rem;\n  padding-block: 0.3rem;\n  display: flex;\n  gap: 0.5rem;\n  border-width: 1px;\n  border-style: solid;\n  font-size: 14px;\n  color: rgba(0, 236, 151, 1);\n  font-weight: 800;\n`;\n\nconst [sort, setSort] = useState(\"timedesc\");\n\nfunction fetchGraphQL(operationsDoc, operationName, variables) {\n  return asyncFetch(`${GRAPHQL_ENDPOINT}/v1/graphql`, {\n    method: \"POST\",\n    headers: { \"x-hasura-role\": \"dataplatform_near\" },\n    body: JSON.stringify({\n      query: operationsDoc,\n      variables: variables,\n      operationName: operationName,\n    }),\n  });\n}\nlet lastPostSocialApi = Social.index(\"post\", \"main\", {\n  limit: 1,\n  order: \"desc\",\n});\n\nif (lastPostSocialApi == null) {\n  return \"Loading...\";\n}\n\n// console.log(\"context\", context.accountId);\n// let test = Social.get(`${context.accountId}/post/main`, {\n//   options: { with_block_height: true },\n// });\n// console.log(\"test\", test);\n\nfunction repostOnDiscussions(blockHeight) {\n  Near.call([\n    {\n      contractName: \"devhub.near\",\n      methodName: \"create_discussion\",\n      args: {\n        handle,\n        data: {\n          [`discussions.${handle}.community.devhub.near`]: {\n            index: {\n              repost: JSON.stringify([\n                {\n                  key: \"main\",\n                  value: {\n                    type: \"repost\",\n                    item: {\n                      type: \"social\",\n                      path: context.accountId + \"/post/main\",\n                      blockHeight,\n                    },\n                  },\n                },\n              ]),\n            },\n          },\n        },\n      },\n      gas: Big(10).pow(14),\n    },\n  ]);\n}\n\nfunction setSocialDbAndRepost(v) {\n  // Post to users social db\n  const result = Social.set(`${context.accountId}/post/main`, v, {\n    onCommit: (data) => {\n      // TODO remove\n      console.log(\"onCommit\");\n      console.log(\"data\", data);\n\n      Social.get(`${context.accountId}/post/main`, v, {\n        onCommit: (data) => {\n          // TODO data.blockHeight\n          repostOnDiscussions(data.blockHeight);\n        },\n      });\n      // const lastPostQuery = `\n      //     query IndexerQuery {\n      //       dataplatform_near_social_feed_posts( limit: 1, order_by: { block_height: desc }) {\n      //           block_height\n      //       }\n      //     }\n      //     `;\n\n      // fetchGraphQL(lastPostQuery, \"IndexerQuery\", {})\n      //   .then((feedIndexerResponse) => {\n      //     // TODO remove\n      //     console.log(\"feedIndexerResponse\", feedIndexerResponse);\n      //     if (\n      //       feedIndexerResponse &&\n      //       feedIndexerResponse.body.data.dataplatform_near_social_feed_posts\n      //         .length > 0\n      //     ) {\n      //       const nearSocialBlockHeight = lastPostSocialApi[0].blockHeight;\n      //       const feedIndexerBlockHeight =\n      //         feedIndexerResponse.body.data\n      //           .dataplatform_near_social_feed_posts[0].block_height;\n      //       // TODO necessary?\n      //       const lag = nearSocialBlockHeight - feedIndexerBlockHeight;\n      //       let shouldFallback = lag > 2 || !feedIndexerBlockHeight;\n      //       if (shouldFallback === true) {\n      //         console.log(\n      //           \"Falling back to Social index feed. Block difference is: \",\n      //           nearSocialBlockHeight - feedIndexerBlockHeight\n      //         );\n      //       }\n\n      //       repostOnDiscussions(nearSocialBlockHeight);\n      //     } else {\n      //       console.log(\n      //         \"Falling back to Social index feed. No QueryApi data received.\"\n      //       );\n      //     }\n      //   })\n      //   .catch((error) => {\n      //     console.log(\n      //       \"Error while fetching QueryApi feed (falling back to index feed): \",\n      //       error\n      //     );\n      //   });\n    },\n  });\n  console.log(\"result\", result);\n}\n\nreturn (\n  <div className=\"w-100\" style={{ maxWidth: \"100%\" }}>\n    <Container className=\"d-flex gap-3 m-3 pl-2\">\n      <MainContent className=\"max-width-100\">\n        <div className=\"d-flex flex-column gap-4\">\n          {context.accountId && (\n            <div className=\"card p-4\">\n              <Widget\n                src={\"thomasguntenaar.near/widget/devhub.entity.community.Compose\"}\n                props={{\n                  onSubmit: (v) => {\n                    setSocialDbAndRepost(v);\n                  },\n                }}\n              />\n            </div>\n          )}\n          <div className=\"d-flex flex-wrap justify-content-between\">\n            <Heading>Announcements</Heading>\n            <div className=\"d-flex align-items-center gap-2\">\n              <select\n                name=\"sort\"\n                id=\"sort\"\n                class=\"form-select\"\n                value={sort}\n                onChange={(e) => {\n                  setSort(e.target.value);\n                }}\n              >\n                <option selected value=\"timedesc\">\n                  Latest\n                </option>\n                <option value=\"recentcommentdesc\">Last Commented</option>\n              </select>\n            </div>\n          </div>\n          <Widget\n            src=\"thomasguntenaar.near/widget/devhub.components.organism.Feed\"\n            props={{\n              showFlagAccountFeature: true,\n              action: \"repost\",\n              filteredAccountIds: [\n                `discussions.${handle}.community.devhub.near`,\n              ],\n              sort: sort,\n            }}\n          />\n        </div>\n      </MainContent>\n      <SidebarContainer>\n        <div className=\"d-flex flex-column gap-3\">\n          <div className=\"card p-4\">\n            <div className=\"mb-2\">{communityData?.description}</div>\n            <div className=\"d-flex gap-2 flex-wrap\">\n              <Tag>{communityData?.tag} </Tag>\n            </div>\n          </div>\n          <div className=\"card p-4 d-flex flex-column gap-2\">\n            <SubHeading>Community Admins</SubHeading>\n            {(communityData?.admins ?? []).map((accountId) => (\n              <div\n                key={accountId}\n                className=\"d-flex\"\n                style={{ fontWeight: 500 }}\n              >\n                <Widget\n                  src=\"thomasguntenaar.near/widget/devhub.components.molecule.ProfileCard\"\n                  props={{ accountId }}\n                />\n              </div>\n            ))}\n          </div>\n        </div>\n      </SidebarContainer>\n    </Container>\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/thomasguntenaar.near/widget/devhub.entity.community.Discussions", "fact_widget_deployments_id": "240090626be97ea8a5461fa0adb1fc4c", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 14}