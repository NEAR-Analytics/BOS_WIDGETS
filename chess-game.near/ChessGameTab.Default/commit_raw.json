{"tx_hash": "E6C8ueNZE6pr2V8kWyhpSxiYQDyy6vnL4qfGvAts16Jm", "action_id_social": "HvXG6LjRRTDPJ9ubU8nwYvouUtNgVfzMfVovQmhbtgy3-0-widget", "block_id": 113690359, "block_timestamp": "2024-02-27T14:36:13.750Z", "signer_id": "chess-game.near", "widget_name": "ChessGameTab.Default", "source_code": "const { accountId } = context;\nconst { isRegistered } = props;\nif (!accountId) {\n  return \"You need to login with your Near wallet first!\";\n}\nconst game_id =\n  props.game_id && typeof props.game_id === \"string\"\n    ? JSON.parse(decodeURIComponent(props.game_id))\n    : props.game_id;\n\nconst contractId = \"app.chess-game.near\";\nconst gameWidget = \"chess-game.near/widget/ChessGame\";\nconst buttonWidget = \"chess-game.near/widget/ChessGameButton\";\nconst challengeWidget = \"chess-game.near/widget/ChessGameChallenge\";\nconst aiWidget = \"chess-game.near/widget/ChessGameAi\";\n\nconst minBlockDiffCancel = 60 * 60 * 24 * 3;\n\nconst Content = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: stretch;\n  gap: 0.4rem 0;\n\n  h2, h3, h4 {\n    align-self: center;\n  }\n`;\nconst GameSelector = styled.div`\n  display: flex;\n  flex-wrap: wrap;\n  align-items: center;\n  justify-content: center;\n  gap: 1rem;\n\n  > * {\n    flex: 1 1 1000px;\n  }\n`;\n\nState.init({\n  gameIds: null,\n  game_id: state.game_id ?? game_id,\n});\n\nconst selectGame = (gameId) => {\n  State.update({\n    game_id: gameId,\n  });\n};\nconst resign = () => {\n  Near.call(contractId, \"resign\", {\n    game_id: state.game_id,\n  });\n  // TODO await tx before navigation\n  selectGame(null);\n};\nconst cancel = () => {\n  Near.call(contractId, \"cancel\", {\n    game_id: state.game_id,\n  });\n  // TODO await tx before navigation\n  selectGame(null);\n};\n\nif (state.game_id) {\n  const res = fetch(\"https://rpc.mainnet.near.org\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      jsonrpc: \"2.0\",\n      id: \"dontcare\",\n      method: \"status\",\n      params: [],\n    }),\n  });\n  if (!res.ok || res.body.error) {\n    return `Something went wrong: ${res.body.error}`;\n  }\n  const currentBlockHeight = res.body.result.sync_info.latest_block_height;\n  const currentBlockTime = new Date(\n    res.body.result.sync_info.latest_block_time\n  );\n  const gameInfo = Near.view(contractId, \"game_info\", {\n    game_id: state.game_id,\n  });\n  if (!gameInfo) return;\n  const blockDiffCancel =\n    gameInfo.last_block_height - currentBlockHeight + minBlockDiffCancel;\n  const cancelDate = new Date(\n    currentBlockTime.valueOf() + blockDiffCancel * 1_100\n  );\n  return (\n    <Content>\n      <Widget\n        src={buttonWidget}\n        props={{\n          onClick: () => selectGame(null),\n          alignSelf: \"center\",\n          content: \"Close\",\n        }}\n      />\n      <Widget\n        src={buttonWidget}\n        props={{\n          onClick: resign,\n          alignSelf: \"center\",\n          content: \"Resign\",\n        }}\n      />\n      <Widget\n        src={buttonWidget}\n        props={{\n          onClick: cancel,\n          alignSelf: \"center\",\n          content: \"Cancel\",\n          disabled: cancelDate.valueOf() > Date.now(),\n        }}\n      />\n      <Widget src={gameWidget} props={{ game_id: state.game_id, cancelDate }} />\n    </Content>\n  );\n}\n\nif (isRegistered) {\n  Near.asyncView(contractId, \"get_game_ids\", {\n    account_id: accountId,\n  }).then((gameIds) =>\n    State.update({\n      gameIds,\n    })\n  );\n} else {\n  State.update({\n    gameIds: [],\n  });\n}\nif (!state.gameIds) {\n  return <Widget src=\"chess-game.near/widget/ChessGameLoading\" />;\n}\n\nconst renderGameIds = (gameIds) =>\n  gameIds.map((gameId) => {\n    const gameInfo = Near.view(contractId, \"game_info\", {\n      game_id: gameId,\n    });\n    const usesOldSerialization = gameInfo.black.type == null;\n    return (\n      <Widget\n        src={buttonWidget}\n        props={{\n          onClick: () => selectGame(gameId),\n          flexDirection: \"column\",\n          content: (\n            <>\n              <div>ID: {gameId[0]}</div>\n              {gameInfo && (\n                <div>\n                  VS:{\" \"}\n                  {usesOldSerialization ? (\n                    gameInfo.black.Ai ? (\n                      <>AI ({gameInfo.black.Ai})</>\n                    ) : (\n                      <>\n                        Player\n                        {gameInfo.black.Human === accountId ? (\n                          <> ({gameInfo.white.Human})</>\n                        ) : (\n                          <> ({gameInfo.black.Human})</>\n                        )}\n                      </>\n                    )\n                  ) : gameInfo.black.type === \"Ai\" ? (\n                    <>AI ({gameInfo.black.value})</>\n                  ) : (\n                    <>\n                      Player\n                      {gameInfo.black.value === accountId ? (\n                        <> ({gameInfo.white.value})</>\n                      ) : (\n                        <> ({gameInfo.black.value})</>\n                      )}\n                    </>\n                  )}\n                </div>\n              )}\n            </>\n          ),\n        }}\n      />\n    );\n  });\n\nreturn (\n  <Content>\n    <h2>Select Game:</h2>\n    <GameSelector>\n      {state.gameIds.length > 0 ? (\n        renderGameIds(state.gameIds)\n      ) : (\n        <span>\n          No open games found.\n          <br />\n          Challenge your first opponent or create an AI game!\n        </span>\n      )}\n    </GameSelector>\n  </Content>\n);\n", "metadata": {"fork_of": "chess-game.near/widget/ChessGameTab.Default@103559320"}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/chess-game.near/widget/ChessGameTab.Default", "fact_widget_deployments_id": "e9a029b1336f7d5631a9fd4ff2bde591", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 1}