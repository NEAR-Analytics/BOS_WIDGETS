{"tx_hash": "2ZUeJdzp4q8T5rWibhTxQryqPnwPqb42zdG1saHZmW95", "action_id_social": "HD2VAvQHh4qvwEAs6QbyVHJ7N4waEgLwfc3zLqZa24Ng-0-widget", "block_id": 116597430, "block_timestamp": "2024-04-11T08:12:38.379Z", "signer_id": "bluebiu.near", "widget_name": "AAVE.Modal.CollateralModal", "source_code": "const {\n  config,\n  data,\n  onRequestClose,\n  onActionSuccess,\n  chainId,\n  flag,\n  formatHealthFactor,\n  calcHealthFactor,\n  yourTotalBorrow,\n  account,\n  theme,\n} = props;\nconsole.log(\"props:\", props);\nif (!data) {\n  return <div />;\n}\nconst ROUND_DOWN = 0;\nfunction isValid(a) {\n  if (!a) return false;\n  if (isNaN(Number(a))) return false;\n  if (a === \"\") return false;\n  return true;\n}\n\nconst {\n  icon,\n  underlyingAsset,\n  decimals,\n  symbol,\n  underlyingBalance,\n  underlyingBalanceUSD,\n  aTokenAddress,\n  availableLiquidity,\n  healthFactor,\n} = data;\n\nconst WithdrawContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  gap: 20px;\n`;\n\nconst TokenTexture = styled.div`\n  font-size: 20px;\n  font-weight: bold;\n  color: white;\n`;\n\nconst TokenWrapper = styled.div`\n  display: flex;\n  img {\n    margin-right: 4px;\n  }\n`;\n\nconst GrayTexture = styled.div`\n  font-size: 12px;\n  font-weight: 500;\n  color: #7c7c86;\n`;\n\nconst PurpleTexture = styled.div`\n  font-size: 14px;\n  font-weight: 500;\n  color: #8a8db9;\n`;\n\nconst WhiteTexture = styled.div`\n  font-size: 14px;\n  font-weight: bold;\n  color: white;\n`;\n\nconst GreenTexture = styled.div`\n  font-size: 14px;\n  font-weight: bold;\n  color: #2cffa7;\n`;\n\nconst TransactionOverviewContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  gap: 20px;\n`;\n\nconst Input = styled.input`\n  background: transparent;\n  border: none;\n  outline: none;\n\n  font-size: 20px;\n  font-weight: bold;\n  color: white;\n  flex: 1;\n  width: 160px;\n\n  &[type=\"number\"]::-webkit-outer-spin-button,\n  &[type=\"number\"]::-webkit-inner-spin-button {\n    -webkit-appearance: none;\n    margin: 0;\n  }\n  &[type=\"number\"] {\n    -moz-appearance: textfield;\n  }\n`;\n\nconst Max = styled.span`\n  color: #8247e5;\n  cursor: pointer;\n`;\nconst Icon = styled.img`\n  width: 16px;\n  height: 16px;\n`;\n\nconst Tips = styled.div`\n  font-size: 14px;\n  color: rgba(188, 0, 0, 1);\n`;\n\nState.init({\n  amount: \"\",\n  amountInUSD: \"0.00\",\n  allowanceAmount: 0,\n  needApprove: false,\n  loading: false,\n  newHealthFactor: \"-\",\n  gas: \"-\",\n});\n\nfunction setColl() {\n  State.update({\n    loading: true,\n  });\n\n  const CollContract = new ethers.Contract(\n    config.aavePoolV3Address,\n    [\n      {\n        inputs: [\n          { internalType: \"address\", name: \"asset\", type: \"address\" },\n          { internalType: \"bool\", name: \"useAsCollateral\", type: \"bool\" },\n        ],\n        name: \"setUserUseReserveAsCollateral\",\n        outputs: [],\n        stateMutability: \"nonpayable\",\n        type: \"function\",\n      },\n    ],\n    Ethers.provider().getSigner()\n  );\n\n  CollContract.setUserUseReserveAsCollateral(data.underlyingAsset, flag)\n    .then((tx) => {\n      tx.wait()\n        .then((res) => {\n          const { status } = res;\n          if (status === 1) {\n            onActionSuccess({\n              msg: `Success`,\n              callback: () => {\n                onRequestClose();\n                State.update({\n                  loading: false,\n                });\n              },\n            });\n            console.log(\"tx succeeded\", res);\n          } else {\n            console.log(\"tx failed\", res);\n            State.update({\n              loading: false,\n            });\n          }\n        })\n        .catch(() => State.update({ loading: false }));\n    })\n    .catch(() => State.update({ loading: false }));\n}\n\nuseEffect(() => {\n  let type = flag ? \"INC_COLLATERAL\" : \"DEC_COLLATERAL\";\n  const newHealthFactor = formatHealthFactor(\n    calcHealthFactor(type, symbol, underlyingBalance)\n  );\n\n  State.update({ newHealthFactor });\n}, []);\nconst refuseClose =\n  yourTotalBorrow &&\n  !isNaN(Number(state.newHealthFactor)) &&\n  Big(state.newHealthFactor).lt(1);\n\nreturn (\n  <Widget\n    src={`${config.ownerId}/widget/AAVE.Modal.BaseModal`}\n    props={{\n      title: `Collateral`,\n      onRequestClose: props.onRequestClose,\n      children: (\n        <WithdrawContainer>\n          <Widget\n            src={`${config.ownerId}/widget/AAVE.Modal.RoundedCard`}\n            props={{\n              title: \"Transaction Overview\",\n              config,\n              children: (\n                <TransactionOverviewContainer>\n                  <Widget\n                    src={`${config.ownerId}/widget/AAVE.Modal.FlexBetween`}\n                    props={{\n                      left: <PurpleTexture>Supply balance</PurpleTexture>,\n                      right: (\n                        <WhiteTexture>\n                          <Icon src={icon} alt=\"\" />\n                          {Number(underlyingBalance).toFixed(7)}\n                          {symbol}\n                        </WhiteTexture>\n                      ),\n                    }}\n                  />\n                  <Widget\n                    src={`${config.ownerId}/widget/AAVE.Modal.FlexBetween`}\n                    props={{\n                      left: <PurpleTexture>Health Factor</PurpleTexture>,\n                      right: (\n                        <div style={{ textAlign: \"right\" }}>\n                          <GreenTexture>\n                            {formatHealthFactor(healthFactor)}\n\n                            <img\n                              src={`${config.ipfsPrefix}/bafkreiesqu5jyvifklt2tfrdhv6g4h6dubm2z4z4dbydjd6if3bdnitg7q`}\n                              width={16}\n                              height={16}\n                            />\n                            {state.newHealthFactor}\n                          </GreenTexture>\n                          <WhiteTexture>\n                            Liquidation at &lt; {config.FIXED_LIQUIDATION_VALUE}\n                          </WhiteTexture>\n                        </div>\n                      ),\n                    }}\n                  />\n                </TransactionOverviewContainer>\n              ),\n            }}\n          />\n          {refuseClose ? (\n            <Tips>\n              You can not switch usage as collateral mode for this currency,\n              because it will cause collateral call\n            </Tips>\n          ) : null}\n\n          <Widget\n            src={`${config.ownerId}/widget/AAVE.PrimaryButton`}\n            props={{\n              config,\n              theme,\n              loading: state.loading,\n              children: `${flag ? \"Enable\" : \"Disable\"} ${\n                data.symbol\n              } as Collateral`,\n              disabled: refuseClose,\n              onClick: setColl,\n            }}\n          />\n        </WithdrawContainer>\n      ),\n      config,\n    }}\n  />\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/AAVE.Modal.CollateralModal", "fact_widget_deployments_id": "07b6812c1ef16f7b21c94a70954e3175", "inserted_timestamp": "2024-04-11T09:40:41.370Z", "modified_timestamp": "2024-04-11T09:40:41.370Z", "__row_index": 3}