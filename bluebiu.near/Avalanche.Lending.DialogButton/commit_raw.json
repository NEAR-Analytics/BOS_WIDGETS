{"tx_hash": "DNQ1rqA4mLv5eGzu3MmTqYNbzuPja2QRe73RoURy7pvq", "action_id_social": "iDsixPuR64mUG2Px4GLsx3QgHhUdRqHP4BBxgPgNC9p-0-widget", "block_id": 108461664, "block_timestamp": "2023-12-21T06:47:01.376Z", "signer_id": "bluebiu.near", "widget_name": "Avalanche.Lending.DialogButton", "source_code": "// TODO:  approve a token when withdrawing and borrow  wethGateway\n\nconst ERC20_ABI = [\n  {\n    constant: true,\n    inputs: [\n      {\n        name: \"_owner\",\n        type: \"address\",\n      },\n      {\n        name: \"_spender\",\n        type: \"address\",\n      },\n    ],\n    name: \"allowance\",\n    outputs: [\n      {\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    payable: false,\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    constant: false,\n    inputs: [\n      {\n        name: \"_spender\",\n        type: \"address\",\n      },\n      {\n        name: \"_value\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"approve\",\n    outputs: [\n      {\n        name: \"\",\n        type: \"bool\",\n      },\n    ],\n    payable: false,\n    stateMutability: \"nonpayable\",\n    type: \"function\",\n  },\n];\nconst Button = styled.button`\n  background-color: var(--switch-color);\n  line-height: 52px;\n  border-radius: 10px;\n  color: #fff;\n  font-size: 18px;\n  font-weight: 500;\n  border: none;\n  width: 100%;\n  transition: 0.5s;\n  margin-top: 10px;\n  &:hover {\n    opacity: 0.8;\n  }\n  &:disabled {\n    opacity: 0.5;\n  }\n  &.borrow {\n    background-color: var(--repay-border-color);\n    border: 1px solid var(--repay-border-color);\n  }\n  &.repay {\n    background-color: var(--repay-bg-hover-color);\n    border: 1px solid var(--repay-border-color);\n  }\n`;\nState.init({\n  approving: false,\n  isApproved: false,\n});\n\nconst {\n  disabled,\n  actionText,\n  amount,\n  data,\n  chainId,\n  onSuccess,\n  toast,\n  addAction,\n} = props;\n\nconst account = Ethers.send(\"eth_requestAccounts\", [])[0];\n\nconst tokenSymbol = data.underlyingToken.symbol;\n\nif (actionText.includes(\"Collateral\")) {\n  const isEnter = actionText === \"Enable as Collateral\";\n  return (\n    <>\n      {!!state.loading && (\n        <Widget\n          src={data.config.handlerCollateral}\n          props={{\n            actionText,\n            unitrollerAddress: data.config.unitrollerAddress,\n            marketAddress: data.address,\n            loading: state.loading,\n            onSuccess: (res) => {\n              const { status, transactionHash } = res;\n              toast?.dismiss(state.toastId);\n              if (status !== 1) throw new Error(\"\");\n              State.update({\n                loading: false,\n              });\n              toast?.success({\n                title: `${tokenSymbol} ${\n                  isEnter ? \"enable\" : \"disable\"\n                } as collateral request successed!`,\n                tx: transactionHash,\n                chainId,\n              });\n              onSuccess?.(data.dapp);\n            },\n            onError: (tx) => {\n              State.update({\n                loading: false,\n              });\n              toast?.fail({\n                title: `${tokenSymbol} ${\n                  isEnter ? \"enable\" : \"disable\"\n                } as collateral request failed!`,\n                tx: tx ? tx.hash : \"\",\n                chainId,\n              });\n            },\n            account,\n            data,\n          }}\n        />\n      )}\n      <Button\n        disabled={state.loading || disabled}\n        onClick={() => {\n          const toastId = toast?.loading({\n            title: `Submitting ${tokenSymbol} ${\n              isEnter ? \"enable\" : \"disable\"\n            } as collateral request...`,\n          });\n          State.update({\n            loading: true,\n            toastId,\n          });\n        }}\n      >\n        {state.loading && (\n          <Widget\n            src=\"bluebiu.near/widget/0vix.LendingLoadingIcon\"\n            props={{\n              size: 16,\n            }}\n          />\n        )}\n        Confirm\n      </Button>\n    </>\n  );\n}\nif (!amount) {\n  return (\n    <Button disabled={true} className={actionText.toLowerCase()}>\n      Enter An Amount\n    </Button>\n  );\n}\n\nconst getAAVE2TokenAddress = () => {\n  return data.underlyingToken.description === \"native\"\n    ? data.aTokenAddress\n    : data.underlyingAsset.address;\n};\n\nconst getAAVE2ApproveAddress = () => {\n  return data.underlyingToken.description === \"native\"\n    ? data.wethGateway\n    : data.lendingPoolAddress;\n};\n\nconst getAllowance = () => {\n  const TokenContract = new ethers.Contract(\n    data.type === \"aave2\"\n      ? getAAVE2TokenAddress()\n      : data.underlyingToken.address,\n    ERC20_ABI,\n    Ethers.provider().getSigner()\n  );\n  TokenContract.allowance(\n    account,\n    data.type == \"aave2\" ? getAAVE2ApproveAddress() : data.address\n  ).then((allowanceRaw) => {\n    State.update({\n      isApproved: !Big(\n        ethers.utils.formatUnits(\n          allowanceRaw._hex,\n          data.underlyingToken.decimals\n        )\n      ).lt(amount || \"0\"),\n    });\n  });\n};\nif (\n  [\"Deposit\", \"Repay\"].includes(actionText) &&\n  data.underlyingToken.address !== \"native\" &&\n  data.underlyingToken.description !== \"native\"\n) {\n  getAllowance();\n} else {\n  State.update({ isApproved: true });\n  onLoad?.(true);\n}\nif (!state.isApproved) {\n  const handleApprove = () => {\n    const toastId = toast?.loading({\n      title: `Approve ${Big(amount).toFixed(2)} ${tokenSymbol}`,\n    });\n    State.update({\n      approving: true,\n    });\n\n    const TokenContract = new ethers.Contract(\n      data.type === \"aave2\"\n        ? getAAVE2TokenAddress()\n        : data.underlyingToken.address,\n      ERC20_ABI,\n      Ethers.provider().getSigner()\n    );\n    TokenContract.approve(\n      data.type == \"aave2\" ? getAAVE2ApproveAddress() : data.address,\n      ethers.utils.parseUnits(amount, data.underlyingToken.decimals)\n    )\n      .then((tx) => {\n        tx.wait().then((res) => {\n          const { status, transactionHash } = res;\n          toast?.dismiss(toastId);\n          if (status !== 1) throw new Error(\"\");\n          State.update({\n            isApproved: true,\n            approving: false,\n          });\n          toast?.success({\n            title: \"Approve Successfully!\",\n            text: `Approve ${Big(amount).toFixed(2)} ${tokenSymbol}`,\n            tx: transactionHash,\n            chainId,\n          });\n        });\n      })\n      .catch((err) => {\n        State.update({\n          isApproved: false,\n          approving: false,\n        });\n        toast?.dismiss(toastId);\n        toast?.fail({\n          title: \"Approve Failed!\",\n          text: err?.message?.includes(\"user rejected transaction\")\n            ? \"User rejected transaction\"\n            : `Approve ${Big(amount).toFixed(2)} ${tokenSymbol}`,\n        });\n        onLoad?.(false);\n      });\n  };\n  return (\n    <Button onClick={handleApprove} disabled={state.approving}>\n      {state.approving && (\n        <Widget\n          src=\"bluebiu.near/widget/0vix.LendingLoadingIcon\"\n          props={{\n            size: 16,\n          }}\n        />\n      )}\n      Approve\n    </Button>\n  );\n}\n\nreturn (\n  <>\n    {state.pending && (\n      <Widget\n        src={data.config.handlerCToken}\n        props={{\n          market: data,\n          actionText,\n          amount: Big(amount).toFixed(data.underlyingToken.decimals),\n          loading: state.pending,\n          onSuccess: (res) => {\n            const { status, transactionHash } = res;\n            toast?.dismiss(state.toastId);\n            State.update({\n              pending: false,\n            });\n            addAction?.({\n              type: \"Lending\",\n              action: actionText,\n              token: data.underlyingToken,\n              amount,\n              template: data.dappName,\n              add: false,\n              status,\n              transactionHash,\n            });\n            if (status === 1) {\n              onSuccess?.(data.dapp);\n              toast?.success({\n                title: `${tokenSymbol} ${actionText.toLowerCase()} request successed!`,\n                tx: transactionHash,\n                chainId,\n              });\n            } else {\n              toast?.fail({\n                title: `${tokenSymbol} ${actionText.toLowerCase()} request failed!`,\n                tx: transactionHash,\n                chainId,\n              });\n            }\n          },\n          onError: (tx) => {\n            State.update({\n              pending: false,\n            });\n            toast?.dismiss(state.toastId);\n            toast?.fail({\n              title: tx?.message?.includes(\"user rejected transaction\")\n                ? \"User rejected transaction\"\n                : `${tokenSymbol} ${actionText.toLowerCase()} request failed!`,\n              tx: tx ? tx.hash : \"\",\n              chainId,\n            });\n          },\n          account,\n        }}\n      />\n    )}\n    <Button\n      disabled={state.pending || disabled}\n      className={actionText.toLowerCase()}\n      onClick={() => {\n        const toastId = toast?.loading({\n          title: `Submitting ${tokenSymbol} ${actionText.toLowerCase()} request...`,\n        });\n        State.update({\n          pending: true,\n          toastId,\n        });\n      }}\n    >\n      {state.pending && (\n        <Widget\n          src=\"bluebiu.near/widget/0vix.LendingLoadingIcon\"\n          props={{\n            size: 16,\n          }}\n        />\n      )}\n      {actionText}\n    </Button>\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Avalanche.Lending.DialogButton", "fact_widget_deployments_id": "d2071636d8b9a5f36e9e3b8089759ec2", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 14}