{"tx_hash": "5FPAcmiwNgsJvBfiiHBkUSJhwy4bj9HmjUtXxDkSi63t", "action_id_social": "9kYSd2yDY4VHgZit5CyMpPKQECKZHyDeT4iMovXzNgCM-0-widget", "block_id": 110624272, "block_timestamp": "2024-01-17T11:08:51.639Z", "signer_id": "bluebiu.near", "widget_name": "Swap.Data.ElkAmountOut", "source_code": "const ROUTER_ABI = [\n  {\n    inputs: [\n      {\n        internalType: \"uint256\",\n        name: \"amountOut\",\n        type: \"uint256\",\n      },\n      {\n        internalType: \"uint256\",\n        name: \"amountInMax\",\n        type: \"uint256\",\n      },\n      {\n        internalType: \"address[]\",\n        name: \"path\",\n        type: \"address[]\",\n      },\n      {\n        internalType: \"address\",\n        name: \"to\",\n        type: \"address\",\n      },\n      {\n        internalType: \"uint256\",\n        name: \"deadline\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"swapExactTokensForTokens\",\n    outputs: [\n      {\n        internalType: \"uint256[]\",\n        name: \"amounts\",\n        type: \"uint256[]\",\n      },\n    ],\n    stateMutability: \"nonpayable\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"uint256\",\n        name: \"amountOutMin\",\n        type: \"uint256\",\n      },\n      { internalType: \"address[]\", name: \"path\", type: \"address[]\" },\n      { internalType: \"address\", name: \"to\", type: \"address\" },\n      { internalType: \"uint256\", name: \"deadline\", type: \"uint256\" },\n    ],\n    name: \"swapExactxDAIForTokens\",\n    outputs: [\n      { internalType: \"uint256[]\", name: \"amounts\", type: \"uint256[]\" },\n    ],\n    stateMutability: \"payable\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      { internalType: \"uint256\", name: \"amountIn\", type: \"uint256\" },\n      {\n        internalType: \"uint256\",\n        name: \"amountOutMin\",\n        type: \"uint256\",\n      },\n      { internalType: \"address[]\", name: \"path\", type: \"address[]\" },\n      { internalType: \"address\", name: \"to\", type: \"address\" },\n      { internalType: \"uint256\", name: \"deadline\", type: \"uint256\" },\n    ],\n    name: \"swapExactTokensForxDAI\",\n    outputs: [\n      { internalType: \"uint256[]\", name: \"amounts\", type: \"uint256[]\" },\n    ],\n    stateMutability: \"nonpayable\",\n    type: \"function\",\n  },\n];\nconst PAIR_ABI = [\n  {\n    constant: true,\n    inputs: [],\n    name: \"getReserves\",\n    outputs: [\n      { internalType: \"uint112\", name: \"_reserve0\", type: \"uint112\" },\n      { internalType: \"uint112\", name: \"_reserve1\", type: \"uint112\" },\n      {\n        internalType: \"uint32\",\n        name: \"_blockTimestampLast\",\n        type: \"uint32\",\n      },\n    ],\n    payable: false,\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n];\nconst FACTORY_ABI = [\n  {\n    inputs: [\n      { internalType: \"address\", name: \"token1\", type: \"address\" },\n      { internalType: \"address\", name: \"token2\", type: \"address\" },\n    ],\n    name: \"getPair\",\n    outputs: [{ internalType: \"address\", name: \"\", type: \"address\" }],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n];\n\nconst {\n  updater,\n  routerAddress,\n  factoryAddress,\n  wethAddress,\n  inputCurrency,\n  outputCurrency,\n  inputCurrencyAmount,\n  onLoad,\n  slippage,\n  account,\n} = props;\n\nuseEffect(() => {\n  if (!updater) return;\n\n  if (\n    (!inputCurrency.address && !inputCurrency.isNative) ||\n    (!outputCurrency.address && !outputCurrency.isNative) ||\n    !inputCurrencyAmount\n  ) {\n    return;\n  }\n\n  const wrapType =\n    inputCurrency.isNative && outputCurrency.address === wethAddress\n      ? 1\n      : inputCurrency.address === wethAddress && outputCurrency.isNative\n      ? 2\n      : 0;\n\n  if (wrapType) {\n    onLoad({\n      outputCurrencyAmount: inputCurrencyAmount,\n      noPair: false,\n    });\n    return;\n  }\n\n  const amount = ethers.utils.parseUnits(\n    Big(inputCurrencyAmount || 0).toFixed(inputCurrency.decimals),\n    inputCurrency.decimals\n  );\n\n  const path = [\n    inputCurrency.address === \"native\" ? wethAddress : inputCurrency.address,\n    outputCurrency.address === \"native\" ? wethAddress : outputCurrency.address,\n  ];\n\n  const RouterContract = new ethers.Contract(\n    routerAddress,\n    ROUTER_ABI,\n    Ethers.provider().getSigner()\n  );\n\n  const getReverse = () => {\n    const FactoryContract = new ethers.Contract(\n      factoryAddress,\n      FACTORY_ABI,\n      Ethers.provider().getSigner()\n    );\n    FactoryContract.getPair(...path)\n      .then((res) => {\n        if (res === \"0x0000000000000000000000000000000000000000\")\n          throw new Error(\"\");\n        const PairContract = new ethers.Contract(\n          res,\n          PAIR_ABI,\n          Ethers.provider().getSigner()\n        );\n        PairContract.getReserves()\n          .then((res) => {\n            const isReverse =\n              Number(inputCurrency.address) > Number(outputCurrency.address);\n\n            const token0 = Big(\n              ethers.utils.formatUnits(\n                res[0],\n                isReverse ? outputCurrency.decimals : inputCurrency.decimals\n              )\n            );\n            const token1 = Big(\n              ethers.utils.formatUnits(\n                res[1],\n                isReverse ? inputCurrency.decimals : outputCurrency.decimals\n              )\n            );\n\n            const poolPrice = token1.div(token0);\n\n            const amountOut = Big(inputCurrencyAmount)\n              .mul(poolPrice)\n              .toFixed(20);\n\n            const amountoutPrice = isReverse\n              ? Big(inputCurrencyAmount).div(amountOut)\n              : Big(amountOut).div(inputCurrencyAmount);\n\n            const priceImpact = poolPrice\n              .minus(amountoutPrice)\n              .div(poolPrice)\n              .mul(100)\n              .toString();\n            getTransaction({\n              priceImpact,\n              amountOut,\n            });\n          })\n          .catch((err) => {\n            console.log(\"err\", err);\n            onLoad({\n              noPair: true,\n              outputCurrencyAmount: \"\",\n            });\n          });\n      })\n      .catch((err) => {\n        onLoad({\n          noPair: true,\n          outputCurrencyAmount: \"\",\n        });\n      });\n  };\n\n  const getTransaction = ({ amountOut, priceImpact }) => {\n    let method = \"\";\n    const deadline = Math.ceil(Date.now() / 1000) + 60;\n    const _amountOut = Big(amountOut)\n      .mul(Big(10).pow(outputCurrency.decimals))\n      .mul(1 - (slippage || 0.05))\n      .toFixed(0);\n    const options = {};\n    const params = [_amountOut, path, account, deadline];\n    if (inputCurrency.isNative) {\n      method = \"swapExactxDAIForTokens\";\n      options.value = amount;\n    } else if (outputCurrency.isNative) {\n      method = \"swapExactTokensForxDAI\";\n      params.unshift(amount);\n    } else {\n      method = \"swapExactTokensForTokens\";\n      params.unshift(amount);\n    }\n    const returnData = {\n      outputCurrencyAmount: Big(amountOut).gt(0.01)\n        ? Big(amountOut).toPrecision(10)\n        : Big(amountOut).toFixed(10),\n      priceImpact,\n    };\n\n    const getTx = (_gas) => {\n      RouterContract.populateTransaction[method](...params, {\n        ...options,\n        gasLimit: _gas,\n      })\n        .then((res) => {\n          onLoad({\n            ...returnData,\n            noPair: false,\n            gas: _gas,\n            unsignedTx: res,\n          });\n        })\n        .catch((err) => {\n          onLoad({\n            ...returnData,\n            noPair: false,\n            gas: _gas,\n          });\n        });\n    };\n\n    const estimateGas = () => {\n      RouterContract.estimateGas[method](...params, options)\n        .then((_gas) => {\n          getTx(_gas);\n        })\n        .catch((err) => {\n          onLoad({\n            ...returnData,\n            noPair: false,\n          });\n        });\n    };\n\n    estimateGas();\n  };\n  getReverse();\n}, [updater]);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Swap.Data.ElkAmountOut", "fact_widget_deployments_id": "875fe0107e017bcd63b0792198c230af", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}