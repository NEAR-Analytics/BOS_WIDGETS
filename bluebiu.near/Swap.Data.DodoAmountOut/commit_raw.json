{"tx_hash": "Bp93c9jfBcgj9GSzmCLkCrzQF4wekN5FQByax1EWEMrq", "action_id_social": "2R2G6HsxcYRy1EHDbovYJLMMBzJY64PdCz12nA526VF3-0-widget", "block_id": 118158985, "block_timestamp": "2024-05-03T12:44:52.991Z", "signer_id": "bluebiu.near", "widget_name": "Swap.Data.DodoAmountOut", "source_code": "const {\n  updater,\n  routerAddress,\n  DVMFactory,\n  DPPFactory,\n  DSPFactory,\n  wethAddress,\n  inputCurrency,\n  outputCurrency,\n  inputCurrencyAmount,\n  onLoad,\n  slippage,\n  account,\n  multicall,\n  multicallAddress,\n  rpc,\n} = props;\n\nuseEffect(() => {\n  if (!updater) return;\n\n  if (\n    (!inputCurrency.address && !inputCurrency.isNative) ||\n    (!outputCurrency.address && !outputCurrency.isNative) ||\n    !inputCurrencyAmount\n  ) {\n    return;\n  }\n\n  const wrapType =\n    inputCurrency.isNative && outputCurrency.address === wethAddress\n      ? 1\n      : inputCurrency.address === wethAddress && outputCurrency.isNative\n      ? 2\n      : 0;\n\n  if (wrapType) {\n    const WethContract = new ethers.Contract(\n      wethAddress,\n      [\n        {\n          constant: false,\n          inputs: [],\n          name: \"deposit\",\n          outputs: [],\n          payable: true,\n          stateMutability: \"payable\",\n          type: \"function\",\n        },\n        {\n          constant: false,\n          inputs: [{ internalType: \"uint256\", name: \"wad\", type: \"uint256\" }],\n          name: \"withdraw\",\n          outputs: [],\n          payable: false,\n          stateMutability: \"nonpayable\",\n          type: \"function\",\n        },\n      ],\n      Ethers.provider().getSigner()\n    );\n    let params = [];\n    let options = {};\n    let method = \"\";\n    if (wrapType === 1) {\n      method = \"deposit\";\n      options.value = ethers.utils.parseEther(\n        Big(inputCurrencyAmount).toFixed(18).toString()\n      );\n    } else {\n      method = \"withdraw\";\n      params = [\n        ethers.utils.parseEther(\n          Big(inputCurrencyAmount).toFixed(18).toString()\n        ),\n      ];\n    }\n    const returnData = {\n      inputCurrency,\n      inputCurrencyAmount,\n      outputCurrency,\n      outputCurrencyAmount: inputCurrencyAmount,\n      noPair: false,\n      routes: null,\n      routerStr: \"\",\n      gas: \"\",\n    };\n    const getTx = (_gas) => {\n      WethContract.populateTransaction[method](...params, {\n        ...options,\n        gasLimit: _gas || 4000000,\n      })\n        .then((res) => {\n          onLoad({\n            ...returnData,\n            gas: _gas,\n            unsignedTx: res,\n          });\n        })\n        .catch((err) => {\n          onLoad({\n            ...returnData,\n          });\n        });\n    };\n    const estimateGas = () => {\n      WethContract.estimateGas[method](...params, options)\n        .then((_gas) => {\n          getTx(_gas);\n        })\n        .catch((err) => {\n          console.log(err);\n          getTx();\n        });\n    };\n    estimateGas();\n    return;\n  }\n\n  const amount = ethers.utils.parseUnits(\n    Big(inputCurrencyAmount || 0).toFixed(inputCurrency.decimals),\n    inputCurrency.decimals\n  );\n\n  const path = [\n    inputCurrency.address === \"native\"\n      ? \"0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE\"\n      : inputCurrency.address,\n    outputCurrency.address === \"native\"\n      ? \"0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE\"\n      : outputCurrency.address,\n  ];\n  const getAmountsOut = () => {\n    const params = encodeURIComponent(\n      `chainId=${inputCurrency.chainId}&fromAmount=${amount}&fromTokenAddress=${\n        path[0]\n      }&toTokenAddress=${path[1]}&rpc=${rpc}&slippage=${\n        slippage * 100 || 0.5\n      }&userAddr=${account}`\n    );\n    asyncFetch(`/dapdap/dodo/swap?params=${params}`)\n      .then((res) => {\n        const data = res.body?.data?.data;\n        if (data?.resAmount) {\n          const wallet = Ethers.provider().getSigner();\n          const returnData = {\n            inputCurrency,\n            inputCurrencyAmount,\n            outputCurrency,\n            outputCurrencyAmount: data.resAmount,\n            priceImpact: data.priceImpact,\n            noPair: false,\n            routerAddress: data.targetApproveAddr,\n          };\n          wallet\n            .estimateGas({\n              to: data.to,\n              data: data.data,\n              value: inputCurrency.isNative ? amount : 0,\n            })\n            .then((gasRes) => {\n              const tx = {\n                from: account,\n                to: data.to,\n                value: inputCurrency.isNative ? amount : 0,\n                data: data.data,\n                gasLimit: gasRes,\n              };\n              onLoad({\n                ...returnData,\n                gas: gasRes,\n                unsignedTx: tx,\n              });\n            })\n            .catch((err) => {\n              console.log(\"err\");\n              onLoad(returnData);\n            });\n        } else {\n          onLoad({\n            inputCurrency,\n            inputCurrencyAmount,\n            outputCurrency,\n            outputCurrencyAmount: \"\",\n            noPair: true,\n          });\n        }\n      })\n      .catch((err) => {\n        onLoad({\n          inputCurrency,\n          inputCurrencyAmount,\n          outputCurrency,\n          outputCurrencyAmount: \"\",\n          noPair: true,\n        });\n      });\n  };\n\n  getAmountsOut();\n}, [updater]);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Swap.Data.DodoAmountOut", "fact_widget_deployments_id": "6f58713105b54b11e2f37ac105f3a24c", "inserted_timestamp": "2024-05-03T14:40:05.342Z", "modified_timestamp": "2024-05-03T14:40:05.342Z", "__row_index": 5}