{"tx_hash": "6kWWCLnsmbdNQiGa5yDWoQLR3XpLP6qRPXUdNNT42qUr", "action_id_social": "EJt6mAz1K4knHqja3MY7PG3zUzgQ8YwRyub1X2tbV7AV-0-widget", "block_id": 121954337, "block_timestamp": "2024-06-25T08:48:24.650Z", "signer_id": "bluebiu.near", "widget_name": "Liquidity.Data.Gamma", "source_code": "\nconst {\n  pairs,\n  sender,\n  addresses,\n  allData,\n  onLoad,\n  // chainType,\n  curChain,\n  multicallAddress,\n  LAST_SNAP_SHOT_DATA_URL,\n  prices\n} = props\nlet loading = false\nlet dataList = []\nconst MULTICALL_ABI = [\n  {\n    inputs: [\n      { internalType: \"bool\", name: \"requireSuccess\", type: \"bool\" },\n      {\n        components: [\n          { internalType: \"address\", name: \"target\", type: \"address\" },\n          { internalType: \"bytes\", name: \"callData\", type: \"bytes\" },\n        ],\n        internalType: \"struct Multicall2.Call[]\",\n        name: \"calls\",\n        type: \"tuple[]\",\n      },\n    ],\n    name: \"tryAggregate\",\n    outputs: [\n      {\n        components: [\n          { internalType: \"bool\", name: \"success\", type: \"bool\" },\n          { internalType: \"bytes\", name: \"returnData\", type: \"bytes\" },\n        ],\n        internalType: \"struct Multicall2.Result[]\",\n        name: \"returnData\",\n        type: \"tuple[]\",\n      },\n    ],\n    stateMutability: \"nonpayable\",\n    type: \"function\",\n  },\n];\nconst ERC20_ABI = [\n  {\n    \"inputs\": [\n      {\n        \"internalType\": \"address\",\n        \"name\": \"account\",\n        \"type\": \"address\"\n      }\n    ],\n    \"name\": \"balanceOf\",\n    \"outputs\": [\n      {\n        \"internalType\": \"uint256\",\n        \"name\": \"\",\n        \"type\": \"uint256\"\n      }\n    ],\n    \"stateMutability\": \"view\",\n    \"type\": \"function\"\n  },\n  {\n    \"inputs\": [],\n    \"name\": \"rewardRate\",\n    \"outputs\": [\n      {\n        \"internalType\": \"uint256\",\n        \"name\": \"\",\n        \"type\": \"uint256\"\n      }\n    ],\n    \"stateMutability\": \"view\",\n    \"type\": \"function\"\n  },\n  {\n    \"inputs\": [],\n    \"name\": \"rewardToken\",\n    \"outputs\": [\n      {\n        \"internalType\": \"contract IERC20\",\n        \"name\": \"\",\n        \"type\": \"address\"\n      }\n    ],\n    \"stateMutability\": \"view\",\n    \"type\": \"function\"\n  },\n  {\n    \"inputs\": [],\n    \"name\": \"globalState\",\n    \"outputs\": [\n      {\n        \"internalType\": \"uint160\",\n        \"name\": \"price\",\n        \"type\": \"uint160\"\n      },\n      {\n        \"internalType\": \"int24\",\n        \"name\": \"tick\",\n        \"type\": \"int24\"\n      },\n      {\n        \"internalType\": \"uint16\",\n        \"name\": \"fee\",\n        \"type\": \"uint16\"\n      },\n      {\n        \"internalType\": \"uint16\",\n        \"name\": \"timepointIndex\",\n        \"type\": \"uint16\"\n      },\n      {\n        \"internalType\": \"uint16\",\n        \"name\": \"communityFeeToken0\",\n        \"type\": \"uint16\"\n      },\n      {\n        \"internalType\": \"uint16\",\n        \"name\": \"communityFeeToken1\",\n        \"type\": \"uint16\"\n      },\n      {\n        \"internalType\": \"bool\",\n        \"name\": \"unlocked\",\n        \"type\": \"bool\"\n      }\n    ],\n    \"stateMutability\": \"view\",\n    \"type\": \"function\"\n  },\n];\n\nconst MulticallContract = new ethers.Contract(\n  multicallAddress,\n  MULTICALL_ABI,\n  Ethers.provider().getSigner()\n);\nconst multicallv2 = (abi, calls, options, onSuccess, onError) => {\n  const { requireSuccess, ...overrides } = options || {};\n  const itf = new ethers.utils.Interface(abi);\n  const calldata = calls.map((call) => ({\n    target: call.address.toLowerCase(),\n    callData: itf.encodeFunctionData(call.name, call.params),\n  }));\n  MulticallContract.callStatic\n    .tryAggregate(requireSuccess || true, calldata, overrides)\n    .then((res) => {\n      onSuccess(\n        res.map((call, i) => {\n          const [result, data] = call;\n          return result && data !== \"0x\"\n            ? itf.decodeFunctionResult(calls[i].name, data)\n            : null;\n        })\n      );\n    })\n    .catch((err) => {\n      onError?.(err);\n    });\n};\nconst fetchFusionsData = () => {\n  asyncFetch(\"https://api.lynex.fi/api/v1/fusions\").then((res) => {\n    if (!res.ok) return;\n    State.update({\n      fusionsData: res?.body?.data,\n    });\n  });\n}\nconst formatPercent = (value) => {\n  return `${Number(value * 100).toLocaleString(\"en\", {\n    maximumFractionDigits: 2,\n  })}%`;\n};\n\nfunction formatedData() {\n  onLoad({\n    loading,\n    dataList\n  })\n}\nfunction getDataList() {\n  console.log('===pairs', pairs)\n  pairs.forEach(pair => {\n    const vaultAddress = addresses[pair.id]\n    const data = allData[vaultAddress]\n    dataList.push({\n      ...data,\n      ...pair,\n      vaultAddress,\n    })\n  })\n  formatedData('dataList')\n}\n\nfunction getLiquidity() {\n  const calls = [];\n  dataList.forEach(data => {\n    calls.push({\n      address: data.vaultAddress,\n      name: \"balanceOf\",\n      params: [sender],\n    });\n  })\n  multicallv2(\n    ERC20_ABI,\n    calls,\n    {},\n    (res) => {\n      for (let i = 0, len = res.length; i < len; i++) {\n        if (res[i]) {\n          dataList[i].liquidity = Big(ethers.utils.formatUnits(res[i][0]._hex)).toFixed()\n        }\n      }\n      formatedData('getLiquidity')\n    },\n    (error) => {\n      setTimeout(() => {\n        getLiquidity();\n      }, 500);\n    }\n  )\n}\nfunction getTotalApr() {\n  const chain_id = curChain.chain_id\n  if ([8453, 10, 5000, 81457].includes(chain_id)) {\n    dataList = dataList.map(data => {\n      data.totalApr = formatPercent(data.returns.weekly.feeApr)\n      return data\n    })\n    formatedData('getTotalApr')\n  }\n  if (chain_id === 59144) {\n    asyncFetch(\"https://api.lynex.fi/api/v1/fusions\").then((res) => {\n      if (!res.ok) return;\n      const fusionsData = res?.body?.data\n      dataList = dataList.map(data => {\n        const fusionData = fusionsData.find(fusionData => fusionData.address === data.vaultAddress)\n        data.totalApr = Big(fusionData?.gauge?.minApr ?? 0).toFixed(2) + '%'\n        return data\n      })\n      formatedData('getTotalApr')\n    });\n  }\n  if (chain_id === 56) {\n    const calls = [];\n    dataList.forEach(data => {\n      data?.gaugeV2Address && calls.push({\n        address: data?.gaugeV2Address,\n        name: \"rewardRate\",\n      });\n    })\n    multicallv2(\n      ERC20_ABI,\n      calls,\n      {},\n      res => {\n        for (let i = 0, len = res.length; i < len; i++) {\n          dataList[i]['totalApr'] = (dataList[i].tvlUSD > 0 ? Big(ethers.utils.formatUnits(res[i][0]._hex))\n            .mul(365 * 24 * 60 * 60)\n            .mul(prices['THE'])\n            .div(dataList[i].tvlUSD)\n            .times(100)\n            .toFixed(2) : '0.00') + '%'\n        }\n        formatedData('getTotalApr')\n      },\n      error => {\n        setTimeout(() => {\n          getTotalApr()\n        }, 500)\n      }\n    )\n  }\n  if ([137, 1101, 3776].includes(chain_id)) {\n    asyncFetch(\"https://api.angle.money/v2/merkl?chainIds[]=\" + chain_id)\n      .then(res => {\n        if (!res.ok) return;\n        const { pools } = res.body[chain_id]\n        dataList = dataList.map(data => {\n          const pool = pools[ethers.utils.getAddress(data.poolAddress)]\n          console.log('=pool', pool)\n          if (pool && Object.keys(pool.aprs).length > 0) {\n            Object.keys(pool.aprs).forEach(key => {\n              if (key.indexOf(ethers.utils.getAddress(data.vaultAddress)) > -1) {\n                data.totalApr = Big(data.returns.weekly.feeApr).times(100).plus(pool.aprs[key]).toFixed(2) + '%'\n              }\n            })\n          } else {\n            data.totalApr = formatPercent(data?.returns?.weekly?.feeApr ?? 0)\n          }\n          return data\n        })\n        formatedData('getTotalApr')\n      })\n  }\n}\nfunction getFeeTiers() {\n  const chain_id = curChain.chain_id\n  if ([59144, 56, 137, 1101].includes(chain_id)) {\n    const calls = [];\n    dataList.forEach(data => {\n      calls.push({\n        address: data.poolAddress,\n        name: \"globalState\",\n      });\n    })\n    multicallv2(\n      ERC20_ABI,\n      calls,\n      {},\n      res => {\n        for (let i = 0, len = res.length; i < len; i++) {\n          dataList[i]['fee'] = Big(res[i][2]).div(10000).toFixed(4)\n        }\n        formatedData('getFeeTiers')\n      },\n      error => {\n        setTimeout(() => {\n          getFeeTiers()\n        }, 500)\n      }\n    )\n  } else {\n    asyncFetch(LAST_SNAP_SHOT_DATA_URL)\n      .then(res => {\n        if (res.ok) {\n          dataList.forEach((data, index) => {\n            const findIndex = res.body.findIndex(source => data.vaultAddress === source.address)\n            if (findIndex > -1) {\n              dataList[index]['fee'] = Big(res.body[findIndex]?.pool?.fee ?? 0).div(10000).toFixed(2)\n            }\n          })\n          formatedData('getFeeTiers')\n        }\n      })\n      .catch(error => {\n        console.log('error', error)\n      })\n  }\n}\n\nuseEffect(() => {\n  getDataList()\n  getLiquidity()\n  getFeeTiers()\n  getTotalApr()\n}, [])", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Liquidity.Data.Gamma", "fact_widget_deployments_id": "b62f467fcf546bc731665ef7d9d20027", "inserted_timestamp": "2024-06-25T09:54:32.359Z", "modified_timestamp": "2024-06-25T09:54:32.359Z", "__row_index": 1}