{"tx_hash": "LnRbYsFN1117EgMvD6Pk7YTYcd6gJG5CNo7migo5ed8", "action_id_social": "Ep9CPwnHMscoUZLxb2yMmerdcZhvuqVwVNx9uvyYvciM-0-widget", "block_id": 118189668, "block_timestamp": "2024-05-03T23:37:59.644Z", "signer_id": "bluebiu.near", "widget_name": "Blast.BridgeAuthority.HandlerSwap", "source_code": "const {\n  amount,\n  account,\n  currency,\n  routerAddress,\n  routerEthAddress,\n  target,\n  loading,\n  onSuccess,\n  onError,\n  quote,\n} = props;\nif (!loading) return \"\";\n\nconst {\n  getExtraData,\n} = VM.require('bluebiu.near/widget/Blast.BridgeAuthority.Util');\n\nconst L1BlastBridgeProxyAbi = [\n  {\n    \"inputs\": [\n      {\n        \"internalType\": \"address\",\n        \"name\": \"_localToken\",\n        \"type\": \"address\"\n      },\n      {\n        \"internalType\": \"address\",\n        \"name\": \"_remoteToken\",\n        \"type\": \"address\"\n      },\n      {\n        \"internalType\": \"uint256\",\n        \"name\": \"_amount\",\n        \"type\": \"uint256\"\n      },\n      {\n        \"internalType\": \"uint32\",\n        \"name\": \"_minGasLimit\",\n        \"type\": \"uint32\"\n      },\n      {\n        \"internalType\": \"bytes\",\n        \"name\": \"_extraData\",\n        \"type\": \"bytes\"\n      }\n    ],\n    \"name\": \"bridgeERC20\",\n    \"outputs\": [],\n    \"stateMutability\": \"nonpayable\",\n    \"type\": \"function\"\n  }\n]\n\nconst L1WETHSwapAbi = [\n  {\n    \"constant\": false,\n    \"inputs\": [\n      {\n        \"name\": \"wad\",\n        \"type\": \"uint256\"\n      }\n    ],\n    \"name\": \"withdraw\",\n    \"outputs\": [],\n    \"payable\": false,\n    \"stateMutability\": \"nonpayable\",\n    \"type\": \"function\"\n  }\n]\n\nconst L2BlastBridgeAbi = [\n  {\n    \"inputs\": [\n      {\n        \"internalType\": \"address\",\n        \"name\": \"_localToken\",\n        \"type\": \"address\"\n      },\n      {\n        \"internalType\": \"address\",\n        \"name\": \"_remoteToken\",\n        \"type\": \"address\"\n      },\n      {\n        \"internalType\": \"uint256\",\n        \"name\": \"_amount\",\n        \"type\": \"uint256\"\n      },\n      {\n        \"internalType\": \"uint32\",\n        \"name\": \"_minGasLimit\",\n        \"type\": \"uint32\"\n      },\n      {\n        \"internalType\": \"bytes\",\n        \"name\": \"_extraData\",\n        \"type\": \"bytes\"\n      }\n    ],\n    \"name\": \"bridgeERC20\",\n    \"outputs\": [],\n    \"stateMutability\": \"nonpayable\",\n    \"type\": \"function\"\n  }\n]\n\nconst signer = Ethers.provider().getSigner()\n\nfunction computeGas(params) {\n  return Ethers.provider().getGasPrice().then(gasPrice => {\n    return signer.estimateGas({\n      ...params,\n      gasPrice\n    }).then(res => {\n      return new Big(res.toString()).mul(1.2).toString().split('.')[0]\n    })\n  })\n}\n\n\nconst rawAmount = new Big(amount).mul(Math.pow(10, currency.decimals)).toString()\nif (target.id === 81457) {\n  let pRes, wethPRes\n  if (currency.symbol === 'WETH') {\n    const L1WETHSWAPContract = new ethers.Contract(\n      '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',\n      L1WETHSwapAbi,\n      signer\n    )\n\n    wethPRes = L1WETHSWAPContract.withdraw(rawAmount).then(tx => tx.wait())\n  }\n\n\n  // const L1BlastBridgeProxy = '0x3a05E5d33d7Ab3864D53aaEc93c8301C1Fa49115'\n  if (currency.isNative || wethPRes) {\n    \n    const params = {\n      from: account,\n      to: routerAddress,\n      value: rawAmount,\n    }\n    if (wethPRes) {\n      pRes = wethPRes.then(() => {\n        return computeGas(params).then(gasLimit => {\n          return signer.sendTransaction({\n            ...params,\n            gasLimit,\n          }).then(tx => {\n            return tx.wait()\n          })\n        })\n      })\n    } else {\n      pRes = computeGas(params).then(gasLimit => {\n        return signer.sendTransaction({\n          ...params,\n          gasLimit,\n        }).then(tx => {\n          return tx.wait()\n        })\n      })\n    }\n    \n  } else {\n    const L1BridgeContract = new ethers.Contract(\n      routerAddress,\n      L1BlastBridgeProxyAbi,\n      signer\n    )\n\n    pRes = L1BridgeContract.bridgeERC20(\n      currency.address,\n      currency.targetAddress,\n      rawAmount,\n      800000,\n      getExtraData(amount),\n      {\n        // gasLimit: 100000\n      }\n    ).then(tx => tx.wait())\n  }\n\n  pRes.then(res => {\n    onSuccess(res);\n  }).catch(err => {\n    console.log('err:', err)\n    onError(err);\n  })\n\n\n\n} else {\n  const L2BlastBridge = '0x4300000000000000000000000000000000000005'\n\n  let pRes\n  let nonce, blockNumber\n  if (currency.isNative) {\n    const params = {\n      from: account,\n      to: L2BlastBridge,\n      value: rawAmount,\n    }\n\n    pRes = signer.sendTransaction(params).then(tx => {\n      nonce = tx.nonce\n      return tx.wait()\n    })\n  } else {\n    const L2BridgeContract = new ethers.Contract(\n      routerAddress,\n      L2BlastBridgeAbi,\n      signer\n    )\n\n    pRes = L2BridgeContract.bridgeERC20(\n      currency.address,\n      '0x6B175474E89094C44Da98b954EedeAC495271d0F',\n      rawAmount,\n      800000,\n      getExtraData(amount),\n      {\n        // gasLimit: 800000\n      }\n    ).then(tx => tx.wait())\n  }\n\n  pRes.then(res => {\n    blockNumber = res.blockNumber\n    // Storage.privateSet(res.transactionHash, {\n    //   nonce,\n    //   blockNumber,\n    // });\n    onSuccess(res);\n  }).catch(err => {\n    onError(err);\n  })\n\n}\n\n\nreturn \"\";", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Blast.BridgeAuthority.HandlerSwap", "fact_widget_deployments_id": "aeb542c04b6406066710d572750b227d", "inserted_timestamp": "2024-05-04T01:52:47.360Z", "modified_timestamp": "2024-05-04T01:52:47.360Z", "__row_index": 0}