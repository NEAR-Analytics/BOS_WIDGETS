{"tx_hash": "7HgWC2DCLQ8pWHXXYtPwYH6yqLNk2UBq5KL7Ybm8PbEM", "action_id_social": "FVPR7mA9MQDqoSxRNvbwWCQnXwke9EoxRW6wFnQPgm2a-0-widget", "block_id": 111929929, "block_timestamp": "2024-02-02T11:50:30.135Z", "signer_id": "bluebiu.near", "widget_name": "Lending.LiquityMarketExpand", "source_code": "const StyledBox = styled.div`\n  border-radius: 0px 0px 16px 16px;\n  background: #2e3142;\n  height: 0px;\n  animation: fadeOut 0.4s 0.1s ease both;\n  &.expand {\n    animation: fadeIn 0.4s 0.1s ease both;\n  }\n\n  @keyframes fadeIn {\n    0% {\n      opacity: 0;\n      transform: translateY(-20px);\n      height: 0px;\n      border: none;\n    }\n    100% {\n      opacity: 1;\n      transform: translateY(0);\n      height: 292px;\n      border: 1px solid #373a53;\n      border-top: none;\n    }\n  }\n\n  @keyframes fadeOut {\n    0% {\n      opacity: 1;\n      transform: translateY(0);\n      height: 292px;\n      border: 1px solid #373a53;\n      border-top: none;\n    }\n    100% {\n      opacity: 0;\n      transform: translateY(-20px);\n      height: 0px;\n      border: none;\n    }\n  }\n`;\n\nconst StyledWrapper = styled.div`\n  display: none;\n\n  &.expand {\n    display: block;\n  }\n`;\n\nconst StyledHeader = styled.div`\n  height: 50px;\n  padding-left: 520px;\n  border-bottom: 1px solid #373a53;\n`;\n\nconst StyledTabs = styled.div`\n  display: flex;\n  align-items: center;\n`;\n\nconst StyledTab = styled.div`\n  width: 250px;\n  height: 50px;\n  border-bottom: 5px solid transparent;\n  color: #979abe;\n  text-align: center;\n  font-family: Gantari;\n  font-size: 16px;\n  font-style: normal;\n  font-weight: 400;\n  line-height: 50px;\n  cursor: pointer;\n  position: relative;\n  transition: 0.3s;\n  &::after {\n    content: \"\";\n    position: absolute;\n    width: 1px;\n    height: 100%;\n    background-color: #373a53;\n    right: 0px;\n    top: 0px;\n  }\n  &.active {\n    border-bottom-color: #fff;\n    color: #ffffff;\n  }\n`;\n\nconst StyledContent = styled.div`\n  display: flex;\n  padding-top: 16px;\n`;\nconst StyledInfo = styled.div`\n  width: 520px;\n  display: flex;\n  justify-content: center;\n  padding-bottom: 16px;\n`;\nconst StyledInfoContent = styled.div`\n  width: 390px;\n  .icon {\n    width: 16px;\n    margin: 0 4px;\n  }\n`;\nconst StyledInfoTitle = styled.div`\n  display: flex;\n  align-items: center;\n  color: #fff;\n  font-family: Gantari;\n  font-size: 16px;\n  font-style: normal;\n  font-weight: 400;\n  line-height: normal;\n  padding-bottom: 16px;\n  .icon {\n    width: 16px;\n    margin: 0 4px;\n  }\n`;\nconst StyledInfoItem = styled.div`\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  margin-bottom: 10px;\n  color: #979abe;\n  font-family: Gantari;\n  font-size: 14px;\n  font-style: normal;\n  font-weight: 400;\n  line-height: normal;\n\n  & .white {\n    color: #fff;\n  }\n  .symbol {\n    margin-left: 4px;\n  }\n  .right {\n    display: flex;\n    align-items: center;\n  }\n`;\nconst StyledInfoTips = styled.div`\n  width: 390px;\n  height: 52px;\n  display: flex;\n  align-items: center;\n  padding: 0 10px;\n  background-color: rgba(235, 244, 121, 0.1);\n  border-radius: 12px;\n  gap: 8px;\n  color: #ebf479;\n  font-family: Gantari;\n  font-size: 14px;\n  font-style: normal;\n  font-weight: 400;\n  line-height: normal;\n  margin-top: 26px;\n  .text {\n    display: flex;\n    align-items: center;\n  }\n  .icon {\n    width: 16px;\n    margin-left: 4px;\n  }\n`;\n\nconst StyledDetailPanel = styled.div`\n  width: 500px;\n  padding: 12px;\n  box-sizing: border-box;\n  border-radius: 12px;\n  border: 1px solid #373a53;\n  color: #979abe;\n  font-family: Gantari;\n  font-size: 14px;\n  font-style: normal;\n  font-weight: 400;\n  line-height: normal;\n  display: flex;\n  flex-direction: column;\n  gap: 10px;\n  margin-top: 12px;\n  & .white {\n    color: #fff;\n  }\n`;\nconst StyledDetailItem = styled.div`\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n`;\nconst StyledBorrowLimit = styled.div`\n  display: flex;\n  align-items: center;\n  gap: 12px;\n`;\nconst StyledButtonWrapper = styled.div`\n  display: flex;\n  align-items: center;\n  gap: 22px;\n  margin-top: 12px;\n  height: 46px;\n`;\nconst StyledGasBox = styled.div`\n  display: flex;\n  align-items: center;\n  gap: 4px;\n  color: #979abe;\n  font-family: Gantari;\n  font-size: 14px;\n  font-style: normal;\n  font-weight: 400;\n  line-height: normal;\n`;\n\nconst AdjustBox = styled.div`\n  padding: 5px 0;\n  display: flex;\n  align-items: center;\n  .txt {\n    margin-left: 5px;\n    color: white;\n  }\n`;\n\nconst {\n  expand,\n  addAction,\n  toast,\n  chainId,\n  nativeCurrency,\n  onSuccess,\n  dexConfig,\n  account,\n  prices,\n  tokenBal,\n  IS_ETHOS_DAPP,\n  multicall,\n  multicallAddress,\n} = props;\n\nconst data = props.data || {};\nconst vesselStatus = data.vesselStatus; //ACTIVE INACTIVE\nlet TABS = [];\nswitch (vesselStatus) {\n  case \"ACTIVE\":\n    TABS = [\"Adjust\", \"Close\"];\n    break;\n  case \"INACTIVE\":\n    TABS = [\"Borrow\"];\n    break;\n}\nconsole.log(\"TABS: \", TABS);\nState.init({\n  tab: TABS[0],\n  isCollIncrease: true, // increase or decrease COLL\n  yourLTV: 0,\n  borrowingFee: 0,\n  _maxFeePercentage: 0, //ethos need\n});\n\nuseEffect(() => {\n  State.update({\n    tab: TABS[0],\n  });\n}, [TABS]);\n\nuseEffect(() => {\n  const debounce = (fn, wait) => {\n    let timer;\n    return () => {\n      clearTimeout(timer);\n      timer = setTimeout(fn, wait);\n    };\n  };\n\n  const getTrade = () => {\n    State.update({\n      loading: true,\n    });\n  };\n\n  const debouncedGetTrade = debounce(getTrade, 500);\n\n  State.update({\n    debouncedGetTrade,\n    getTrade,\n  });\n}, []);\n\n//ethos\nfunction getVesselManager(_amount) {\n  const abi = [\n    {\n      inputs: [{ internalType: \"uint256\", name: \"_LUSDDebt\", type: \"uint256\" }],\n      name: \"getBorrowingFee\",\n      outputs: [{ internalType: \"uint256\", name: \"\", type: \"uint256\" }],\n      stateMutability: \"view\",\n      type: \"function\",\n    },\n    {\n      inputs: [],\n      name: \"getBorrowingRateWithDecay\",\n      outputs: [{ internalType: \"uint256\", name: \"\", type: \"uint256\" }],\n      stateMutability: \"view\",\n      type: \"function\",\n    },\n  ];\n  const _LUSDDebt = ethers.utils.parseUnits(_amount);\n\n  const calls = [\n    {\n      address: dexConfig.VesselManager,\n      name: \"getBorrowingRateWithDecay\",\n      params: [],\n    },\n    {\n      address: dexConfig.VesselManager,\n      name: \"getBorrowingFee\",\n      params: [_LUSDDebt],\n    },\n  ];\n\n  multicall({\n    abi,\n    calls,\n    options: {},\n    multicallAddress,\n    provider: Ethers.provider(),\n  })\n    .then((res) => {\n      const [[_maxFeePercentageRaw], [_borrowingFeeRaw]] = res;\n      State.update({\n        _maxFeePercentage: _maxFeePercentageRaw,\n        borrowingFee: _borrowingFeeRaw,\n      });\n    })\n    .catch((err) => {\n      console.log(\"error:\", err);\n    });\n}\n\nconst onBorrowAmountChange = (amount) => {\n  if (isNaN(Number(amount))) return;\n  const isZero = Big(amount || 0).eq(0);\n  if (isZero) {\n    State.update({\n      borrowAmount: amount,\n      buttonClickable: false,\n      isBigerThanBalance: false,\n    });\n    return;\n  }\n  if (IS_ETHOS_DAPP) {\n    getVesselManager(amount);\n  }\n  const params = { borrowAmount: amount };\n\n  if (Big(amount).gt(Big(state.borrowTokenBal || 0))) {\n    params.isBigerThanBalance = true;\n  }\n  State.update(params);\n  state.debouncedGetTrade();\n};\n\nconst onAmountChange = (amount) => {\n  if (isNaN(Number(amount))) return;\n  const isZero = Big(amount || 0).eq(0);\n  if (isZero) {\n    State.update({\n      amount,\n      buttonClickable: false,\n      isBigerThanBalance: false,\n    });\n    return;\n  }\n  const params = { amount };\n  params.isBigerThanBalance = Big(amount || 0).gt(\n    data.userUnderlyingBalance || 0\n  );\n  params.buttonClickable = !params.isBigerThanBalance;\n  if (state.tab === \"Borrow\") {\n    const price = prices[data.underlyingToken.symbol];\n\n    const TotalDebt = Big(amount).mul(price).mul(Big(data[\"MAX_LTV\"])).div(100);\n\n    const borrowTokenBal = TotalDebt.minus(20)\n      .minus(TotalDebt.minus(20).mul(0.02))\n      .toFixed();\n\n    params.borrowTokenBal = borrowTokenBal;\n  }\n\n  State.update(params);\n\n  state.debouncedGetTrade();\n};\n\nuseEffect(() => {\n  if (state.tab === \"Close\") return;\n  if (state.tab === \"Borrow\") {\n    if (\n      !state.amount ||\n      !state.borrowAmount ||\n      isNaN(Number(state.amount)) ||\n      isNaN(Number(state.borrowAmount)) ||\n      Big(state.amount || 0).eq(0) ||\n      Big(state.borrowAmount || 0).eq(0)\n    ) {\n      State.update({\n        yourLTV: 0,\n      });\n      return;\n    }\n  }\n  if (state.tab === \"Adjust\") {\n    if (!state.amount || isNaN(Number(state.amount))) {\n      State.update({\n        yourLTV: 0,\n      });\n      return;\n    }\n  }\n\n  const _maxLTV = Big(data.MAX_LTV).div(100);\n  const _price = prices[data.underlyingToken.symbol];\n\n  let _yourLTV;\n  if (state.tab === \"Borrow\") {\n    const _der = Big(state.amount).mul(Big(_price)).mul(_maxLTV);\n    _yourLTV = Big(state.borrowAmount).div(_der).toFixed(4);\n  }\n\n  //vesselDeposit\n  if (state.tab === \"Adjust\") {\n    const _assetAmount = data.vesselDeposit;\n    const _der = Big(state.amount)\n      .plus(_assetAmount)\n      .mul(Big(_price))\n      .mul(_maxLTV);\n    _yourLTV = Big(data.vesselDebt - 20)\n      .div(_der)\n      .toFixed(4);\n  }\n  // console.log( _maxLTV.toFixed(), _price, _der.toFixed(), _yourLTV);\n  State.update({\n    yourLTV: Big(_yourLTV).mul(100).toFixed(2),\n  });\n}, [state.amount, state.borrowAmount]);\n\nreturn !state.tab ? null : (\n  <StyledBox className={expand ? \"expand\" : \"\"}>\n    <StyledWrapper className={expand ? \"expand\" : \"\"}>\n      <StyledHeader>\n        <StyledTabs>\n          {TABS.map((tab) => (\n            <StyledTab\n              key={tab}\n              className={tab === state.tab ? \"active\" : \"\"}\n              onClick={() => {\n                State.update({ tab, amount: \"\" });\n              }}\n            >\n              {tab}\n            </StyledTab>\n          ))}\n        </StyledTabs>\n      </StyledHeader>\n      <StyledContent>\n        <StyledInfo>\n          {state.tab === \"Borrow\" && (\n            <StyledInfoContent>\n              <StyledInfoTitle>\n                Borrowing from\n                <img src={data.underlyingToken.icon} className=\"icon\" alt=\"\" />\n                {data.underlyingToken.symbol}\n              </StyledInfoTitle>\n              <StyledInfoItem>\n                <div>Your LTV</div>\n                <div className=\"white\">{state.yourLTV}%</div>\n              </StyledInfoItem>\n              <StyledInfoItem>\n                <div>Borrowing Fee</div>\n                <div className=\"white\">\n                  {state.borrowingFee\n                    ? ethers.utils.formatUnits(state.borrowingFee)\n                    : \"-\"}{\" \"}\n                  {data.BORROW_TOKEN}\n                </div>\n              </StyledInfoItem>\n\n              <StyledInfoTips>\n                <img\n                  src=\"https://ipfs.near.social/ipfs/bafkreia4fvn2zeymgsn57arq2u6mytztrcedil6og7ujbinvpvt3n3bmrm\"\n                  alt=\"\"\n                />\n                <div className=\"txt\">\n                  Deposit collateral and/or borrow more\n                  <img src={data.BORROW_URL} className=\"icon\" alt=\"\" />{\" \"}\n                  {data.BORROW_TOKEN}.\n                </div>\n              </StyledInfoTips>\n            </StyledInfoContent>\n          )}\n          {state.tab === \"Adjust\" && (\n            <StyledInfoContent>\n              <StyledInfoTitle>Adjust Your Position</StyledInfoTitle>\n              <StyledInfoItem>\n                <div>Your LTV</div>\n                <div className=\"white\">{state.yourLTV}%</div>\n              </StyledInfoItem>\n              <StyledInfoItem>\n                <div>Your Collateral</div>\n                <div className=\"white\">\n                  {data.vesselDeposit}\n                  {data.underlyingToken?.symbol}\n                </div>\n              </StyledInfoItem>\n\n              <StyledInfoTips>\n                <img\n                  src=\"https://ipfs.near.social/ipfs/bafkreia4fvn2zeymgsn57arq2u6mytztrcedil6og7ujbinvpvt3n3bmrm\"\n                  alt=\"\"\n                />\n                <div>Manage the collateral health of your vault.</div>\n              </StyledInfoTips>\n            </StyledInfoContent>\n          )}\n          {state.tab === \"Close\" && (\n            <StyledInfoContent>\n              <StyledInfoTitle>Close Your Position</StyledInfoTitle>\n              <StyledInfoItem>\n                <div>You will repay</div>\n                <div className=\"right\">\n                  <img src={data.BORROW_URL} className=\"icon\" alt=\"\" />\n                  <span className=\"white\">{data.vesselDebt}</span>\n                  <span className=\"symbol\">{data.BORROW_TOKEN}</span>\n                </div>\n              </StyledInfoItem>\n              <StyledInfoItem>\n                <div>You have</div>\n                <div className=\"right\">\n                  <img src={data.BORROW_URL} className=\"icon\" alt=\"\" />\n                  <span className=\"white\">{tokenBal}</span>\n                  <span className=\"symbol\">{data.BORROW_TOKEN}</span>\n                </div>\n              </StyledInfoItem>\n              <StyledInfoItem>\n                <div>You will receive</div>\n                <div className=\"right\">\n                  <img\n                    src={data.underlyingToken.icon}\n                    className=\"icon\"\n                    alt=\"\"\n                  />\n                  <span className=\"white\">{deposits}</span>\n                  <span className=\"symbol\">{data.underlyingToken.symbol}</span>\n                </div>\n              </StyledInfoItem>\n              <StyledInfoTips>\n                <img\n                  src=\"https://ipfs.near.social/ipfs/bafkreia4fvn2zeymgsn57arq2u6mytztrcedil6og7ujbinvpvt3n3bmrm\"\n                  alt=\"\"\n                />\n                <div>\n                  By closing your position, you receive your collateral from the\n                  Nebula Vault.\n                </div>\n              </StyledInfoTips>\n            </StyledInfoContent>\n          )}\n        </StyledInfo>\n        <div>\n          {state.tab === \"Borrow\" ? (\n            <>\n              <Widget\n                src=\"bluebiu.near/widget/Lending.MarketInput\"\n                props={{\n                  icon: data.underlyingToken?.icon,\n                  symbol: data.underlyingToken?.symbol,\n                  balance: data?.userUnderlyingBalance,\n                  price: prices[data.underlyingToken.symbol],\n                  amount: state.amount,\n                  onChange: (val) => {\n                    onAmountChange(val);\n                  },\n                }}\n              />\n              <Widget\n                src=\"bluebiu.near/widget/Lending.MarketInput\"\n                props={{\n                  icon: data.BORROW_URL,\n                  symbol: data.BORROW_TOKEN,\n                  balance: state.borrowTokenBal,\n                  price: prices[data.BORROW_TOKEN] || 0,\n                  amount: state.borrowAmount,\n                  onChange: (val) => {\n                    onBorrowAmountChange(val);\n                  },\n                }}\n              />\n            </>\n          ) : null}\n          {state.tab === \"Adjust\" ? (\n            <>\n              <Widget\n                src=\"bluebiu.near/widget/Lending.MarketInput\"\n                props={{\n                  icon: data.underlyingToken?.icon,\n                  symbol: data.underlyingToken?.symbol,\n                  balance: data?.userUnderlyingBalance,\n                  price: prices[data.underlyingToken.symbol],\n                  amount: state.amount,\n                  onChange: (val) => {\n                    onAmountChange(val);\n                  },\n                }}\n              />\n              <AdjustBox>\n                <Widget\n                  src=\"bluebiu.near/widget/Avalanche.Lending.Switch\"\n                  props={{\n                    onChange: (e) => {\n                      State.update({\n                        isCollIncrease: !state.isCollIncrease,\n                      });\n                    },\n                    active: state.isCollIncrease,\n                  }}\n                />\n                <span className=\"txt\">\n                  {state.isCollIncrease ? \"INCREASE\" : \"DECREASE\"}\n                </span>\n              </AdjustBox>\n            </>\n          ) : null}\n\n          <StyledButtonWrapper>\n            <StyledGasBox>\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                width=\"18\"\n                height=\"18\"\n                viewBox=\"0 0 18 18\"\n                fill=\"none\"\n              >\n                <path\n                  d=\"M11.3496 14.1934V8.67643H11.7636C11.9886 8.67643 12.1776 8.84743 12.1776 9.05443V12.5644C12.1776 13.4644 12.9696 14.1934 13.9506 14.1934C14.9316 14.1934 15.7236 13.4644 15.7236 12.5644V5.81443C15.7236 5.46343 15.5616 5.13943 15.3096 4.91443L13.8606 3.59143C13.5996 3.34843 13.1766 3.34843 12.9156 3.59143C12.6546 3.83443 12.6546 4.22143 12.9156 4.46443L13.8516 5.32843L13.1586 5.99443C12.9336 6.21043 12.9336 6.55243 13.1586 6.76843C13.2666 6.87643 13.4196 6.93043 13.5726 6.93043H14.3556V12.5734C14.3556 12.7804 14.1756 12.9514 13.9416 12.9514C13.7166 12.9514 13.5276 12.7804 13.5276 12.5734V9.06343C13.5276 8.16343 12.7356 7.43443 11.7546 7.43443H11.3496V4.42843C11.3496 3.87043 10.8636 3.42943 10.2516 3.42943H4.51856C3.91556 3.42943 3.42056 3.87943 3.42056 4.42843V14.1934H3.28556C2.90756 14.1934 2.60156 14.4724 2.60156 14.8234C2.60156 15.1744 2.90756 15.4534 3.28556 15.4534H11.4846C11.8626 15.4534 12.1686 15.1744 12.1686 14.8234C12.1686 14.4724 11.8626 14.1934 11.4846 14.1934H11.3496ZM5.39156 4.67143H9.37856C9.71156 4.67143 9.98156 4.91443 9.98156 5.22043V7.87543C9.98156 8.18143 9.71156 8.42443 9.37856 8.42443H5.39156C5.05856 8.42443 4.78856 8.18143 4.78856 7.87543V5.22043C4.78856 4.91443 5.05856 4.67143 5.39156 4.67143Z\"\n                  fill=\"#979ABE\"\n                />\n              </svg>\n              <div style={{ display: \"flex\", alignItems: \"center\" }}>\n                ~\n                {props.prices[nativeCurrency?.symbol]\n                  ? `$${Big(state.gas || 0)\n                      .div(Big(10).pow(nativeCurrency.decimals || 18))\n                      .toFixed(2)}`\n                  : \"-\"}\n              </div>\n            </StyledGasBox>\n            {state.tab === \"Borrow\" || state.tab === \"Close\" ? (\n              <div style={{ flexGrow: 1 }}>\n                <Widget\n                  src=\"bluebiu.near/widget/Lending.LiquityMarketButton\"\n                  props={{\n                    disabled:\n                      state.tab === \"Close\" ? false : !state.buttonClickable,\n                    actionText: state.tab,\n                    ...props,\n                    data: {\n                      ...data,\n                      config: dexConfig,\n                    },\n                    isBigerThanBalance: state.isBigerThanBalance,\n                    addAction,\n                    toast,\n                    chainId,\n                    unsignedTx: state.unsignedTx,\n                    isError: state.isError,\n                    // loading: state.loading,\n                    // gas: state.gas,\n                    yourLTV: state.yourLTV,\n                    _assetAmount: state.amount,\n                    _debtTokenAmount: state.borrowAmount,\n                    _maxFeePercentage: state._maxFeePercentage,\n                    onApprovedSuccess: () => {\n                      if (!state.gas) state.getTrade();\n                    },\n                    onSuccess: () => {\n                      onSuccess?.();\n                    },\n                  }}\n                />\n              </div>\n            ) : null}\n            {state.tab === \"Adjust\" ? (\n              <div style={{ flexGrow: 1 }}>\n                <Widget\n                  src=\"bluebiu.near/widget/Lending.LiquityAdjustButton\"\n                  props={{\n                    disabled: !state.buttonClickable,\n                    actionText: state.tab,\n                    ...props,\n                    data: {\n                      ...data,\n                      config: dexConfig,\n                    },\n                    isBigerThanBalance: state.isBigerThanBalance,\n                    _maxFeePercentage: state._maxFeePercentage,\n                    isCollIncrease: state.isCollIncrease,\n                    unsignedTx: state.unsignedTx,\n                    isError: state.isError,\n                    // loading: state.loading,\n                    // gas: state.gas,\n                    yourLTV: state.yourLTV,\n                    _assetAmount: state.amount,\n                    _debtTokenAmount: state.borrowAmount,\n                    onApprovedSuccess: () => {\n                      if (!state.gas) state.getTrade();\n                    },\n                    onSuccess: () => {\n                      onSuccess?.();\n                    },\n                  }}\n                />\n              </div>\n            ) : null}\n          </StyledButtonWrapper>\n        </div>\n      </StyledContent>\n    </StyledWrapper>\n  </StyledBox>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Lending.LiquityMarketExpand", "fact_widget_deployments_id": "7a6bba1cb7deb66daa862a2dc3cf796d", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 1}