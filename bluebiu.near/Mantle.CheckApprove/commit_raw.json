{"tx_hash": "4nrg88pddGPui2ct7inZgV92dN2wdscByeWXDntVRCqd", "action_id_social": "5iLr9awgaKnaSgmKQrowRuPabCp8ZRYFvPkWqb6f9Yno-0-widget", "block_id": 99600702, "block_timestamp": "2023-08-25T04:39:22.404Z", "signer_id": "bluebiu.near", "widget_name": "Mantle.CheckApprove", "source_code": "const {\n  tokenIn,\n  selectedDex,\n  config,\n  sender,\n  loadApprove,\n  amountIn,\n  isApprovedOut,\n} = props;\nconst selectedDexItem = config.dapps.find((dapp) => dapp.name === selectedDex);\nconst Erc20Abi = [\n  {\n    constant: true,\n    inputs: [\n      {\n        name: \"_owner\",\n        type: \"address\",\n      },\n    ],\n    name: \"balanceOf\",\n    outputs: [\n      {\n        name: \"balance\",\n        type: \"uint256\",\n      },\n    ],\n    payable: false,\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    constant: true,\n    inputs: [\n      {\n        name: \"_owner\",\n        type: \"address\",\n      },\n      {\n        name: \"_spender\",\n        type: \"address\",\n      },\n    ],\n    name: \"allowance\",\n    outputs: [\n      {\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    payable: false,\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    constant: false,\n    inputs: [\n      {\n        name: \"_spender\",\n        type: \"address\",\n      },\n      {\n        name: \"_value\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"approve\",\n    outputs: [\n      {\n        name: \"\",\n        type: \"bool\",\n      },\n    ],\n    payable: false,\n    stateMutability: \"nonpayable\",\n    type: \"function\",\n  },\n];\n\nconst queryString = `${tokenIn.address}-${selectedDex}-${isApprovedOut}`;\n\nState.init({\n  isApproved: true,\n});\n\nif (queryString !== state.cacheString) {\n  State.update({\n    cacheString: queryString,\n  });\n} else {\n  return <div></div>;\n}\n\nif (!sender) return <div></div>;\n\nconst TokenContract = new ethers.Contract(\n  tokenIn.address,\n  Erc20Abi,\n  Ethers.provider().getSigner()\n);\n\nconst handleApprove = (amountIn, tokenIn) => {\n  TokenContract.approve(\n    selectedDexItem.swapRouter,\n    ethers.utils.parseUnits(amountIn, tokenIn.decimals)\n  )\n    .then((tx) => {\n      tx.wait().then((res) => {\n        const { status, transactionHash } = res;\n        console.log(\"status: \", status);\n\n        loadApprove({\n          isApproved: status === 1,\n          handleApprove: handleApprove,\n        });\n      });\n    })\n    .catch((e) => {\n      console.log(e, \"error:\");\n    });\n};\n\nconst getAllowance = () => {\n  TokenContract.allowance(sender, selectedDexItem.swapRouter).then(\n    (allowanceRaw) => {\n      const parsedAllowance = Big(Number(allowanceRaw._hex))\n        .div(Big(10).pow(tokenIn.decimals))\n        .toFixed();\n      console.log(\n        \"allowanceRaw: \",\n        Number(allowanceRaw._hex),\n        parsedAllowance,\n        amountIn\n      );\n\n      const isApproved = Number(parsedAllowance) >= Number(amountIn);\n\n      loadApprove({\n        isApproved: isApproved,\n        handleApprove: handleApprove,\n      });\n      State.update({\n        isApproved: isApproved,\n      });\n    }\n  );\n};\n\nif (tokenIn.symbol !== config.NATIVE_TOKEN_SYMBOL) {\n  console.log(\"check allowance 11\");\n\n  getAllowance();\n}\n\nreturn <div></div>;\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Mantle.CheckApprove", "fact_widget_deployments_id": "81a1cd99bfdb227527058a7e87a67f61", "inserted_timestamp": "2023-08-25T06:25:49.782Z", "modified_timestamp": "2023-08-25T06:25:49.782Z", "__row_index": 1}