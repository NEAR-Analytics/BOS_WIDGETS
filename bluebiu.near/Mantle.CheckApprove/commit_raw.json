{"tx_hash": "8XUT1MtVvUynjXN51CW6cuei2Cc793tUJrZMoLDPcTFh", "action_id_social": "G6AtXVWrmPZp57FmejLHXsKPKgfkMZrsWTDhaS6kb2pc-0-widget", "block_id": 99479952, "block_timestamp": "2023-08-23T14:45:03.312Z", "signer_id": "bluebiu.near", "widget_name": "Mantle.CheckApprove", "source_code": "const {\n  tokenIn,\n  selectedDex,\n  config,\n  sender,\n  loadApprove,\n  amountIn,\n  isApprovedOut,\n} = props;\nconst selectedDexItem = config.dapps.find((dapp) => dapp.name === selectedDex);\nconst Erc20Abi = [\n  {\n    constant: true,\n    inputs: [\n      {\n        name: \"_owner\",\n        type: \"address\",\n      },\n    ],\n    name: \"balanceOf\",\n    outputs: [\n      {\n        name: \"balance\",\n        type: \"uint256\",\n      },\n    ],\n    payable: false,\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    constant: true,\n    inputs: [\n      {\n        name: \"_owner\",\n        type: \"address\",\n      },\n      {\n        name: \"_spender\",\n        type: \"address\",\n      },\n    ],\n    name: \"allowance\",\n    outputs: [\n      {\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    payable: false,\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    constant: false,\n    inputs: [\n      {\n        name: \"_spender\",\n        type: \"address\",\n      },\n      {\n        name: \"_value\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"approve\",\n    outputs: [\n      {\n        name: \"\",\n        type: \"bool\",\n      },\n    ],\n    payable: false,\n    stateMutability: \"nonpayable\",\n    type: \"function\",\n  },\n];\n\nconst queryString = `${tokenIn.address}-${selectedDex}-${isApprovedOut}`;\n\nState.init({\n  isApproved: true,\n});\n\nif (queryString !== state.cacheString) {\n  State.update({\n    cacheString: queryString,\n  });\n} else {\n  return <div></div>;\n}\n\nif (!sender) return <div></div>;\n\nconst TokenContract = new ethers.Contract(\n  tokenIn.address,\n  Erc20Abi,\n  Ethers.provider().getSigner()\n);\n\nconst handleApprove = (amountIn, tokenIn) => {\n  TokenContract.approve(\n    selectedDexItem.factory,\n    ethers.utils.parseUnits(amountIn, tokenIn.decimals)\n  )\n    .then((tx) => {\n      tx.wait().then((res) => {\n        const { status, transactionHash } = res;\n        console.log(\"status: \", status);\n\n        loadApprove({\n          isApproved: status === 1,\n          handleApprove: handleApprove,\n        });\n      });\n    })\n    .catch(() => {});\n};\n\nconst getAllowance = () => {\n  TokenContract.allowance(sender, selectedDexItem.factory).then(\n    (allowanceRaw) => {\n      console.log(\"allowanceRaw: \", allowanceRaw);\n      loadApprove({\n        isApproved: !Big(Number(allowanceRaw._hex)).eq(0),\n        handleApprove: handleApprove,\n      });\n      State.update({\n        isApproved: !Big(Number(allowanceRaw._hex)).eq(0),\n      });\n    }\n  );\n};\n\nif (tokenIn.symbol !== config.NATIVE_TOKEN_SYMBOL) {\n  console.log(\"check allowance 11\");\n\n  getAllowance();\n}\n\nreturn <div></div>;\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Mantle.CheckApprove", "fact_widget_deployments_id": "5d4cbe5c4ca88cbb9b4033b701a84e99", "inserted_timestamp": "2023-08-23T16:39:11.484Z", "modified_timestamp": "2023-08-23T16:39:11.484Z", "__row_index": 0}