{"tx_hash": "9xAqse7CBWzLKUzyTFwtwJGKRQSkB8hYkrs2AHzmYh23", "action_id_social": "B9igAnTn49EHscnehMt9hvPLuijSzdXTzhXPaoSSDd6k-0-widget", "block_id": 120037706, "block_timestamp": "2024-05-30T03:18:33.193Z", "signer_id": "bluebiu.near", "widget_name": "Staking.Beefy.Data", "source_code": "const {\n  CHAIN_LIST,\n  curChain,\n  multicallAddress,\n  multicall,\n  account,\n  prices,\n  update,\n  onLoad,\n  pairs,\n  chainId,\n} = props;\n\nconst { formatUnits, parseUnits } = ethers.utils;\n\nconst ABI = [\n  {\n    inputs: [\n      {\n        internalType: \"address\",\n        name: \"account\",\n        type: \"address\",\n      },\n    ],\n    name: \"balanceOf\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [],\n    name: \"totalSupply\",\n    outputs: [{ internalType: \"uint256\", name: \"\", type: \"uint256\" }],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [],\n    name: \"getPricePerFullShare\",\n    outputs: [{ internalType: \"uint256\", name: \"\", type: \"uint256\" }],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n];\n\nuseEffect(() => {\n  if (!account || !update || !multicallAddress) return;\n  const pairIds = pairs.map((pair) => pair.id);\n  let count = 0;\n  let _lpsDataRes = {};\n  let _apyDataRes = {};\n  let _totalSupplyRes = [];\n  let _yourDepositsRes = [];\n  let _pricePerFullShareRes = [];\n\n  function formatData(params) {\n    console.log(params, count);\n\n    if (count < 5) return;\n    count = 0;\n    console.log(\"_lpsDataRes--\", _lpsDataRes);\n    for (let i = 0; i < pairs.length; i++) {\n      const lpsData = _lpsDataRes[pairs[i].id];\n      const apyData = _apyDataRes[pairs[i].id];\n      pairs[i].detail = { ...lpsData, ...apyData };\n\n      pairs[i].deposits = _yourDepositsRes[i]\n        ? Big(formatUnits(_yourDepositsRes[i][0]))\n            .times(formatUnits(_pricePerFullShareRes[i][0]))\n            .toFixed(7, 0)\n        : 0;\n\n      const _beefyTVL = Big(formatUnits(_totalSupplyRes[i][0]))\n        .times(formatUnits(_pricePerFullShareRes[i][0]))\n        .times(lpsData.price || 0)\n        .toString();\n      const _gammaTVL = Big(lpsData.price || 0)\n        .times(lpsData.totalSupply)\n        .toString();\n      pairs[i].beefyTVL = _beefyTVL;\n      pairs[i].gammaTVL = _gammaTVL;\n      pairs[i].APY = Big(apyData.totalApy).times(100).toFixed(2);\n      const _pow = 1 / 365;\n      pairs[i].DAILY = Number(\n        (Math.pow(Big(1).plus(apyData.totalApy).toString(), _pow) - 1) * 100\n      ).toFixed(4);\n    }\n\n    onLoad({\n      dataList: pairs,\n    });\n  }\n  function getLpsData() {\n    asyncFetch(\"https://api.beefy.finance/lps/breakdown\")\n      .then((res) => {\n        pairIds.forEach((pairId) => {\n          _lpsDataRes[pairId] = res.body[pairId];\n        });\n      })\n      .catch((err) => {\n        console.log(\"catch-getLpsData-error--\", err);\n      })\n      .finally(() => {\n        count++;\n        formatData(\"getLpsData\");\n      });\n  }\n  function getApyData() {\n    asyncFetch(\"https://api.beefy.finance/apy/breakdown\")\n      .then((res) => {\n        pairIds.forEach((pairId) => {\n          _apyDataRes[pairId] = res.body[pairId];\n        });\n      })\n      .catch((err) => {\n        console.log(\"catch-getLpsData-error--\", err);\n      })\n      .finally(() => {\n        count++;\n        formatData(\"getLpsData\");\n      });\n  }\n\n  function getTotalSupply() {\n    const calls = pairs.map((item) => ({\n      address: item.vaultAddress,\n      name: \"totalSupply\",\n      //   params: [],\n    }));\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getTotalSupply--\", res);\n        _totalSupplyRes = res;\n        count++;\n        formatData(\"getTotalSupply\");\n      })\n      .catch((err) => {\n        console.log(\"getTotalSupply-error--\", err);\n      });\n  }\n  function getPricePerFullShare() {\n    const calls = pairs.map((item) => ({\n      address: item.vaultAddress,\n      name: \"getPricePerFullShare\",\n      //   params: [],\n    }));\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getPricePerFullShare--\", res);\n        _pricePerFullShareRes = res;\n        count++;\n        formatData(\"getPricePerFullShare\");\n      })\n      .catch((err) => {\n        console.log(\"getPricePerFullShare-error--\", err);\n      });\n  }\n  function getYourDeposits() {\n    const calls = pairs.map((item) => ({\n      address: item.vaultAddress,\n      name: \"balanceOf\",\n      params: [account],\n    }));\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getYourDeposits--\", res);\n        _yourDepositsRes = res;\n        count++;\n        formatData(\"getYourDeposits\");\n      })\n      .catch((err) => {\n        console.log(\"getYourDeposits-error--\", err);\n      });\n  }\n\n  getLpsData();\n  getApyData();\n  getTotalSupply();\n  getPricePerFullShare();\n  getYourDeposits();\n}, [account, update]);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Staking.Beefy.Data", "fact_widget_deployments_id": "68001c31afe4d33697b0dada2fefad84", "inserted_timestamp": "2024-05-30T04:44:15.027Z", "modified_timestamp": "2024-05-30T04:44:15.027Z", "__row_index": 1}