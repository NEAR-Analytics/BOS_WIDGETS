{"tx_hash": "G6ByuRvD7m3Eo2Wq17tM1thZMeymAPpNeB74ur3C18Tw", "action_id_social": "9EUQmv4LcgM9UbzHRHu8xRXebSNxWoXXWSLd7dK4yFEg-0-widget", "block_id": 119783340, "block_timestamp": "2024-05-26T13:36:44.066Z", "signer_id": "bluebiu.near", "widget_name": "Staking.Teahouse.Data", "source_code": "const {\n  CHAIN_LIST,\n  curChain,\n  multicallAddress,\n  multicall,\n  account,\n  prices,\n  update,\n  onLoad,\n  pairs,\n  chainId,\n  addresses,\n} = props;\n\nconst { formatUnits, parseUnits } = ethers.utils;\n\nconst ABI = [\n  {\n    inputs: [],\n    name: \"totalSupply\",\n    outputs: [{ internalType: \"uint256\", name: \"\", type: \"uint256\" }],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [],\n    name: \"vaultAllUnderlyingAssets\",\n    outputs: [\n      { internalType: \"uint256\", name: \"amount0\", type: \"uint256\" },\n      { internalType: \"uint256\", name: \"amount1\", type: \"uint256\" },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n];\n\nuseEffect(() => {\n  if (!account || !update || !multicallAddress) return;\n\n  let count = 0;\n  let _pairsDataRes = {};\n  let _totalSupplyRes = [];\n  let _underlyingAssetsRes = [];\n\n  function formatData(params) {\n    console.log(params, count);\n\n    if (count < 3) return;\n    count = 0;\n\n    for (let i = 0; i < pairs.length; i++) {\n      const _addr = pairs[i].vaultAddress.toLocaleLowerCase();\n\n      const { token0, token1 } = _pairsDataRes[_addr];\n      let token0TVL = Big(token0.tvl).times(token0.shareTokenPrice);\n      let token1TVL = Big(token1.tvl).times(token1.shareTokenPrice);\n      let _apr = 0;\n      let _aum = 0;\n      if (token0TVL.gt(token1TVL)) {\n        _apr = token0.shareTokenApr;\n        let _token0 = pairs[i].token0;\n\n        _aum = Big(formatUnits(token0.tvl, pairs[i].decimals0))\n          .times(prices[_token0] || 0)\n          .toString();\n      } else {\n        _apr = token1.shareTokenApr;\n        let _token1 = pairs[i].token1;\n\n        _aum = Big(formatUnits(token1.tvl, pairs[i].decimals1))\n          .times(prices[_token1] || 0)\n          .toString();\n      }\n      pairs[i].APR = Big(_apr).div(10000).toFixed(2, 0);\n      pairs[i].AUM = _aum;\n\n      pairs[i].totalSupply = _totalSupplyRes[i][0].toString();\n\n      pairs[i].totalAmount0 = _underlyingAssetsRes[i][0].toString();\n      pairs[i].totalAmount1 = _underlyingAssetsRes[i][1].toString();\n    }\n\n    onLoad({\n      dataList: pairs,\n    });\n  }\n  function getPairsData() {\n    asyncFetch(\"https://vault-api.teahouse.finance/vaults/type/permissionless\")\n      .then((res) => {\n        const _curChainRes = res.body.vaults.filter(\n          (item) => item.network === curChain.name.toLocaleLowerCase()\n        );\n        _curChainRes.forEach(({ address, latestInfo }) => {\n          let _addr = address.toLocaleLowerCase();\n          _pairsDataRes[_addr] = latestInfo;\n        });\n      })\n      .catch((err) => {\n        console.log(\"catch-getPairsData-error--\", err);\n      })\n      .finally(() => {\n        count++;\n        formatData(\"getPairsData\");\n      });\n  }\n  function fetchPosition(vaultAddress) {\n    return asyncFetch(\n      `https://vault-api.teahouse.finance/vaults/permissionless/position/${chainId}/${vaultAddress}/${account}`\n    )\n      .then((res) => {\n        return res;\n      })\n      .catch((err) => {\n        console.log(\"fetchPosition-error--\", err);\n      });\n  }\n  function getUserPositions() {\n    const calls = pairs.map((item) => fetchPosition(item.vaultAddress));\n\n    Promise.all(calls)\n      .then((res) => {\n        console.log(\"getUserPositions--\", res);\n      })\n      .catch((err) => {\n        console.log(\"getUserPositions-error--\", err);\n      });\n  }\n  function getTotalSupply() {\n    const calls = pairs.map((item) => ({\n      address: item.vaultAddress,\n      name: \"totalSupply\",\n      //   params: [],\n    }));\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getTotalSupply--\", res);\n        _totalSupplyRes = res;\n        count++;\n        formatData(\"getTotalSupply\");\n      })\n      .catch((err) => {\n        console.log(\"getTotalSupply-error--\", err);\n      });\n  }\n  function getAllUnderlyingAssets() {\n    const calls = pairs.map((item) => ({\n      address: item.vaultAddress,\n      name: \"vaultAllUnderlyingAssets\",\n      //   params: [],\n    }));\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getAllUnderlyingAssets--\", res);\n        _underlyingAssetsRes = res;\n        count++;\n        formatData(\"getAllUnderlyingAssets\");\n      })\n      .catch((err) => {\n        console.log(\"getAllUnderlyingAssets-error--\", err);\n      });\n  }\n\n  getPairsData();\n  getTotalSupply();\n  getAllUnderlyingAssets();\n  //   getUserPositions();\n}, [account, update]);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Staking.Teahouse.Data", "fact_widget_deployments_id": "eaa6f53d1a04092d3e23adbec9dfcae5", "inserted_timestamp": "2024-05-26T15:50:53.287Z", "modified_timestamp": "2024-05-26T15:50:53.287Z", "__row_index": 0}