{"tx_hash": "5XMoAeb7v89Ju89s88Hs7sbjRY2vFpLCyYWDfDnoUnPH", "action_id_social": "9S6HaXa3qVD7quTSCzHMRK1HsD8RNxRC7SfkBbLQU9u6-0-widget", "block_id": 119105310, "block_timestamp": "2024-05-17T07:48:06.078Z", "signer_id": "bluebiu.near", "widget_name": "Lending.Data.Sturdy", "source_code": "const {\n  multicallAddress,\n  multicall,\n  account,\n  prices,\n  dexConfig,\n  update,\n  onLoad,\n} = props;\nconst { rawMarkets, TOKENS } = dexConfig;\n\nconst ABI = [\n  {\n    inputs: [],\n    name: \"totalSupply\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"address\",\n        name: \"account\",\n        type: \"address\",\n      },\n    ],\n    name: \"balanceOf\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [],\n    name: \"totalBorrow\",\n    outputs: [\n      {\n        internalType: \"uint128\",\n        name: \"amount\",\n        type: \"uint128\",\n      },\n      {\n        internalType: \"uint128\",\n        name: \"shares\",\n        type: \"uint128\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [],\n    name: \"totalAssets\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"address\",\n        name: \"_address\",\n        type: \"address\",\n      },\n    ],\n    name: \"getUserSnapshot\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"_userAssetShares\",\n        type: \"uint256\",\n      },\n      {\n        internalType: \"uint256\",\n        name: \"_userBorrowShares\",\n        type: \"uint256\",\n      },\n      {\n        internalType: \"uint256\",\n        name: \"_userCollateralBalance\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"uint256\",\n        name: \"_shares\",\n        type: \"uint256\",\n      },\n    ],\n    name: \"convertToAssets\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"_assets\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [],\n    name: \"cleanLiquidationFee\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [],\n    name: \"maxLTV\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n];\n\nconst RATE_ABI = [\n  {\n    inputs: [],\n    name: \"MAX_FULL_UTIL_RATE\",\n    outputs: [\n      {\n        internalType: \"uint256\",\n        name: \"\",\n        type: \"uint256\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n  {\n    inputs: [\n      {\n        internalType: \"uint256\",\n        name: \"_deltaTime\",\n        type: \"uint256\",\n      },\n      {\n        internalType: \"uint256\",\n        name: \"_utilization\",\n        type: \"uint256\",\n      },\n      {\n        internalType: \"uint64\",\n        name: \"_oldFullUtilizationInterest\",\n        type: \"uint64\",\n      },\n    ],\n    name: \"getNewRate\",\n    outputs: [\n      {\n        internalType: \"uint64\",\n        name: \"_newRatePerSec\",\n        type: \"uint64\",\n      },\n      {\n        internalType: \"uint64\",\n        name: \"_newFullUtilizationInterest\",\n        type: \"uint64\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n];\nconst { formatUnits, parseUnits } = ethers.utils;\nuseEffect(() => {\n  if (!account || !update || !multicallAddress) return;\n  let count = 0;\n  let _balanceRes = [];\n  let _totalBorrowRes = [];\n  let _totalAssetsRes = [];\n  let _liquidationFeeRes = [];\n  let _maxLTVRes = [];\n  let _totalSupplyRes = [];\n  let _yourBorrows = [];\n  let _yourCollaterals = [];\n  let _yourLends = [];\n  let _maxRateRes = [];\n  // let _ratePerSecRes = [];\n\n  function formatData(params) {\n    console.log(params, count);\n    if (count < 9) return;\n    count = 0;\n    for (let i = 0; i < rawMarkets.length; i++) {\n      rawMarkets[i].totalSupplied = formatUnits(\n        _totalSupplyRes[i][0],\n        rawMarkets[i].TOKEN_B.decimals\n      ).toString();\n      rawMarkets[i].totalBorrows = _totalBorrowRes[i]\n        ? _totalBorrowRes[i][0]\n        : 0;\n      rawMarkets[i].totalAssets = _totalAssetsRes[i]\n        ? _totalAssetsRes[i][0]\n        : 0;\n\n      rawMarkets[i].liquidationFee = formatUnits(_liquidationFeeRes[i][0], 5);\n      rawMarkets[i].maxLTV = formatUnits(_maxLTVRes[i][0], 5);\n\n      const yourBorrow = _yourBorrows[i]\n        ? formatUnits(_yourBorrows[i][0], rawMarkets[i].TOKEN_B.decimals)\n        : 0;\n      rawMarkets[i].yourBorrow = yourBorrow;\n      rawMarkets[i].yourBorrowUSD = Big(yourBorrow)\n        .times(Big(prices[rawMarkets[i].TOKEN_B.symbol] || 1))\n        .toFixed();\n\n      const yourCollateral = _yourCollaterals[i]\n        ? formatUnits(_yourCollaterals[i][0], rawMarkets[i].TOKEN_A.decimals)\n        : 0;\n      rawMarkets[i].yourCollateral = yourCollateral;\n      rawMarkets[i].yourCollateralUSD = Big(yourCollateral)\n        .times(Big(prices[rawMarkets[i].TOKEN_A.symbol] || 1))\n        .toFixed();\n      const yourLends = _yourLends[i]\n        ? formatUnits(_yourLends[i][0], rawMarkets[i].TOKEN_B.decimals)\n        : 0;\n\n      rawMarkets[i].yourLends = yourLends;\n      rawMarkets[i].yourLendsUSD = Big(yourLends)\n        .times(Big(prices[rawMarkets[i].TOKEN_B.symbol] || 1))\n        .toFixed();\n\n      rawMarkets[i].MAX_FULL_UTIL_RATE = _maxRateRes[i] ? _maxRateRes[i][0] : 0;\n    }\n    for (let i = 0; i < rawMarkets.length; i++) {\n      rawMarkets[i].Utilization = Big(rawMarkets[i].totalBorrows)\n        .div(Big(rawMarkets[i].totalAssets))\n        .toFixed(4);\n    }\n    getNewRates(rawMarkets);\n\n    // for (let i = 0; i < rawMarkets.length; i++) {\n    //   rawMarkets[i].ratePerSecRes = _ratePerSecRes[i][0];\n    // }\n    for (let i = 0; i < _balanceRes.length; i++) {\n      TOKENS[i].balance = formatUnits(\n        _balanceRes[i] ? _balanceRes[i][0] : 0,\n        TOKENS[i].decimals\n      );\n    }\n\n    const yourTotalCollateraledUSD = rawMarkets.reduce((total, item) => {\n      return Big(total).plus(Big(item.yourCollateralUSD)).toFixed();\n    }, 0);\n    const yourTotalBorrowUSD = rawMarkets.reduce((total, item) => {\n      return Big(total).plus(Big(item.yourBorrowUSD)).toFixed();\n    }, 0);\n    const yourTotalDepositUSD = rawMarkets.reduce((total, item) => {\n      return Big(total).plus(Big(item.yourLendsUSD)).toFixed();\n    }, 0);\n    onLoad({\n      markets: rawMarkets,\n      TOKENS,\n      yourTotalCollateraledUSD,\n      yourTotalBorrowUSD,\n      yourTotalDepositUSD,\n    });\n  }\n\n  function getTotalBorrow() {\n    const calls = rawMarkets.map((item) => ({\n      address: item.POOL_MANAGER,\n      name: \"totalBorrow\",\n      // params: [],\n    }));\n\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getTotalBorrow_res\", res);\n        _totalBorrowRes = res;\n        count++;\n        formatData(\"getTotalBorrow\");\n      })\n      .catch((err) => {\n        console.log(\"getTotalAssets_error:\", err);\n      });\n  }\n  function getTotalAssets() {\n    const calls = rawMarkets.map((item) => ({\n      address: item.POOL_MANAGER,\n      name: \"totalAssets\",\n      // params: [],\n    }));\n\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getTotalAssets--\", res);\n        _totalAssetsRes = res;\n        count++;\n        formatData(\"getTotalAssets\");\n      })\n      .catch((err) => {\n        console.log(\"getTotalAssets_error:\", err);\n      });\n  }\n\n  function getLiquidationFee() {\n    const calls = rawMarkets.map((item) => ({\n      address: item.POOL_MANAGER,\n      name: \"cleanLiquidationFee\",\n      // params: [],\n    }));\n\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"get cleanLiquidationFee--\", res);\n        _liquidationFeeRes = res;\n        count++;\n        formatData(\"getLiquidationFee\");\n      })\n      .catch((err) => {\n        console.log(\"getcleanLiquidationFee_error:\", err);\n      });\n  }\n\n  function getMaxLTV() {\n    const calls = rawMarkets.map((item) => ({\n      address: item.POOL_MANAGER,\n      name: \"maxLTV\",\n      // params: [],\n    }));\n\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"get getMaxLTV--\", res);\n        _maxLTVRes = res;\n        count++;\n        formatData(\"getMaxLTV\");\n      })\n      .catch((err) => {\n        console.log(\"get MaxLTV_error:\", err);\n      });\n  }\n  function getTotalSupply() {\n    const calls = rawMarkets.map((item) => ({\n      address: item.POOL_MANAGER,\n      name: \"totalSupply\",\n    }));\n\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getTotalSupply--\", res);\n        _totalSupplyRes = res;\n        count++;\n        formatData(\"getTotalSupply\");\n      })\n      .catch((err) => {\n        console.log(\"getTotalSupply-error:\", err);\n      });\n  }\n\n  function getUserSnapshot() {\n    const calls = rawMarkets.map((item) => ({\n      address: item.POOL_MANAGER,\n      name: \"getUserSnapshot\",\n      params: [account],\n    }));\n\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getUserSnapshot--\", res);\n        return res;\n      })\n      .then((snapshot) => {\n        const calls = rawMarkets.map((item, index) => {\n          const snapshotItem = snapshot[index] ? snapshot[index] : [0, 0, 0];\n          const [rest, borrowShares, collateralShares] = snapshotItem;\n          return {\n            address: item.POOL_MANAGER,\n            name: \"convertToAssets\",\n            params: [borrowShares],\n          };\n        });\n\n        multicall({\n          abi: ABI,\n          calls,\n          options: {},\n          multicallAddress,\n          provider: Ethers.provider(),\n        }).then((res) => {\n          // console.log(\"convertToAssets--\", res);\n          _yourBorrows = res;\n          count++;\n          formatData(\"getUserSnapshot\");\n        });\n        return snapshot;\n      })\n      .then((snapshot) => {\n        const calls = rawMarkets.map((item, index) => {\n          const snapshotItem = snapshot[index] ? snapshot[index] : [0, 0, 0];\n          const [rest, borrowShares, collateralShares] = snapshotItem;\n          return {\n            address: item.POOL_MANAGER,\n            name: \"convertToAssets\",\n            params: [collateralShares],\n          };\n        });\n\n        multicall({\n          abi: ABI,\n          calls,\n          options: {},\n          multicallAddress,\n          provider: Ethers.provider(),\n        }).then((res) => {\n          console.log(\"convertToAssets--\", res);\n          _yourCollaterals = res;\n          count++;\n          formatData(\"convertToAssets\");\n        });\n      })\n      .catch((err) => {\n        console.log(\"getUserSnapshot-error:\", err);\n      });\n  }\n  function getUserLends() {\n    const calls = rawMarkets.map((item) => ({\n      address: item.POOL_MANAGER,\n      name: \"balanceOf\",\n      params: [account],\n    }));\n\n    multicall({\n      abi: ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getUserLends--\", res);\n        return res;\n      })\n      .then((lendShare) => {\n        const calls = rawMarkets.map((item, index) => {\n          const _lendShare = lendShare[index] ? lendShare[index][0] : 0;\n          return {\n            address: item.POOL_MANAGER,\n            name: \"convertToAssets\",\n            params: [_lendShare],\n          };\n        });\n\n        multicall({\n          abi: ABI,\n          calls,\n          options: {},\n          multicallAddress,\n          provider: Ethers.provider(),\n        }).then((res) => {\n          console.log(\"convertToAssets--\", res);\n          _yourLends = res;\n          count++;\n          formatData(\"getUserLends\");\n        });\n      })\n\n      .catch((err) => {\n        console.log(\"getUserSnapshot-error:\", err);\n      });\n  }\n\n  function getWalletBalance() {\n    let nativeOToken = \"\";\n\n    const calls = TOKENS.map((token) => ({\n      address: token.address,\n      name: \"balanceOf\",\n      params: [account],\n    }));\n\n    multicall({\n      abi: [\n        {\n          constant: true,\n          inputs: [\n            {\n              name: \"_owner\",\n              type: \"address\",\n            },\n          ],\n          name: \"balanceOf\",\n          outputs: [\n            {\n              name: \"balance\",\n              type: \"uint256\",\n            },\n          ],\n          payable: false,\n          stateMutability: \"view\",\n          type: \"function\",\n        },\n      ],\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"get_wallet_bal_res:\", res);\n        _balanceRes = res;\n        count++;\n        formatData(\"getWalletBalance\");\n      })\n      .catch((err) => {\n        console.log(\"getWalletBalance_error\", err);\n      });\n  }\n  function getRate() {\n    // RATE_CONTRACT\n\n    const contract = new ethers.Contract(\n      \"0xAE610460522F3e71c40Ad6a2c70f486341B88Daf\",\n      [\n        {\n          inputs: [],\n          name: \"MAX_FULL_UTIL_RATE\",\n          outputs: [\n            {\n              internalType: \"uint256\",\n              name: \"\",\n              type: \"uint256\",\n            },\n          ],\n          stateMutability: \"view\",\n          type: \"function\",\n        },\n        {\n          inputs: [\n            {\n              internalType: \"uint256\",\n              name: \"_deltaTime\",\n              type: \"uint256\",\n            },\n            {\n              internalType: \"uint256\",\n              name: \"_utilization\",\n              type: \"uint256\",\n            },\n            {\n              internalType: \"uint64\",\n              name: \"_oldFullUtilizationInterest\",\n              type: \"uint64\",\n            },\n          ],\n          name: \"getNewRate\",\n          outputs: [\n            {\n              internalType: \"uint64\",\n              name: \"_newRatePerSec\",\n              type: \"uint64\",\n            },\n            {\n              internalType: \"uint64\",\n              name: \"_newFullUtilizationInterest\",\n              type: \"uint64\",\n            },\n          ],\n          stateMutability: \"view\",\n          type: \"function\",\n        },\n      ],\n      Ethers.provider().getSigner()\n    );\n    contract\n      .getNewRate(0, 0, 0)\n      .then((res) => {\n        console.log(111, res, res[1].toString());\n\n        // _totalBorrowRes = res;\n        count++;\n        formatData(\"getRate\");\n      })\n      .catch((err) => {\n        console.log(222, err);\n      });\n  }\n\n  function getMaxRates() {\n    const calls = rawMarkets.map((item) => ({\n      address: item.RATE_CONTRACT,\n      name: \"MAX_FULL_UTIL_RATE\",\n      // params: [],\n    }));\n\n    multicall({\n      abi: RATE_ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getMaxRates--\", res);\n        _maxRateRes = res;\n        count++;\n        formatData(\"getMaxRates\");\n      })\n      .catch((err) => {\n        console.log(\"getRates-error:\", err);\n      });\n  }\n  function getNewRates(rawMarkets) {\n    const calls = rawMarkets.map((item) => {\n      return {\n        address: item.RATE_CONTRACT,\n        name: \"getNewRate\",\n        params: [0, parseUnits(item.Utilization, 5), item.MAX_FULL_UTIL_RATE],\n      };\n    });\n\n    multicall({\n      abi: RATE_ABI,\n      calls,\n      options: {},\n      multicallAddress,\n      provider: Ethers.provider(),\n    })\n      .then((res) => {\n        console.log(\"getNewRates--\", res);\n\n        for (let index = 0; index < res.length; index++) {\n          let _ratePerSec = res[index][0].toString();\n          const { borrowAPR, lendAPR } = caLcSiLoAPYS(\n            _ratePerSec,\n            rawMarkets[index].Utilization,\n            rawMarkets[index].protocolFee\n          );\n          rawMarkets[index].borrowAPR = borrowAPR;\n          rawMarkets[index].lendAPR = lendAPR;\n        }\n        onLoad({\n          markets: rawMarkets,\n        });\n      })\n      .catch((err) => {\n        console.log(\"getNewRates-error:\", err);\n      });\n  }\n\n  function caLcSiLoAPYS(ratePerSec, utilizationRate, protocolFee) {\n    const FEE_PRECISION = 100_000;\n    const RATE_PRECISION = Math.pow(10, 18);\n    const SECONDS_PER_YEAR = 60 * 60 * 24 * 365;\n\n    const interestPerSecond = Big(ratePerSec).div(RATE_PRECISION);\n    const fee = Big(protocolFee).div(FEE_PRECISION).toNumber();\n\n    const borrowAPR = interestPerSecond.times(SECONDS_PER_YEAR).toString();\n    // const borrowAPY =\n    //   (1 + interestPerSecond) ** SECONDS_PER_YEAR.toNumber() - 1;\n    const lendAPR = Big(borrowAPR)\n      .times(1 - fee)\n      .times(utilizationRate)\n      .toString();\n    // const lendAPY = borrowAPY * (1 - fee) * utilizationRate;\n    return {\n      borrowAPR,\n      lendAPR,\n      //  borrowAPY, lendAPY,\n    };\n  }\n  caLcSiLoAPYS(7503944640, 0.8184, 0.1);\n  getTotalBorrow();\n  getTotalAssets();\n  getLiquidationFee();\n  getMaxLTV();\n  getTotalSupply();\n  getUserSnapshot();\n  getUserLends();\n  getWalletBalance();\n  getMaxRates();\n}, [account, update]);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/bluebiu.near/widget/Lending.Data.Sturdy", "fact_widget_deployments_id": "5c7f04fe924e262534132c44f48cfca1", "inserted_timestamp": "2024-05-17T09:54:04.833Z", "modified_timestamp": "2024-05-17T09:54:04.833Z", "__row_index": 4}