{"tx_hash": "GDGvieBAnGfzsMCq61P6PwHYD462BnRmqcNfpWYwwKbZ", "action_id_social": "2RsuiAJwkcv6xgyD2GB2FhGwBQ1QgpEg3M82c2Y3gkuC-0-widget", "block_id": 97113495, "block_timestamp": "2023-07-23T02:43:24.636Z", "signer_id": "knwtechs.near", "widget_name": "Merchant.info", "source_code": "if (!props.collectionAddress || !props.abi) {\n  return (\n    <tr>\n      <td colspan=\"6\" class=\"text-white\">\n        Data unavailable\n      </td>\n    </tr>\n  );\n}\n\nconst contract = props.collectionAddress;\nconst abi = props.abi;\n\nconst iface = new ethers.utils.Interface(abi);\n\nconst collectionContract = new ethers.Contract(\n  contract,\n  abi,\n  Ethers.provider().getSigner()\n);\n\nState.init({\n  circulating_supply: 0,\n  max_supply: 0,\n  price: 0,\n  total_earnings: 0,\n  uri: \"\",\n});\n\nconst getTotalEarnings = () => {\n  const tierValue = 0;\n  const tierHex = \"0x\" + tierValue.toString(16).padStart(64, \"0\");\n  const filter = {\n    address: props.collectionAddress,\n    topics: [\n      ethers.utils.id(\"SubscriptionUpdate(uint256,address,uint256)\"),\n      tierHex,\n    ],\n    fromBlock: 0,\n    toBlock: \"latest\",\n  };\n  Ethers.provider()\n    .getLogs(filter)\n    .then((logs) => {\n      const tot = state.price * logs.length;\n      State.update({ total_earnings: tot });\n    })\n    .catch((err) => console.log(err));\n};\n\nconst getCirculatingSupply = () => {\n  const encodedData = iface.encodeFunctionData(\"getTierSupply\", [0, false]);\n\n  return Ethers.provider()\n    .call({\n      to: contract,\n      data: encodedData,\n    })\n    .then((circulating) => {\n      const circulating_supply = iface\n        .decodeFunctionResult(\"getTierSupply\", circulating)\n        .toString();\n      State.update({ circulating_supply: circulating_supply });\n    });\n};\n\nconst getMaxSupply = () => {\n  const encodedData = iface.encodeFunctionData(\"getTierSupply\", [0, true]);\n\n  return Ethers.provider()\n    .call({\n      to: contract,\n      data: encodedData,\n    })\n    .then((total) => {\n      const max_supply = iface\n        .decodeFunctionResult(\"getTierSupply\", total)\n        .toString();\n      State.update({ max_supply: max_supply == -1 ? \"-\" : max_supply });\n    });\n};\n\nconst getCollectionName = () => {\n  const encodedData = iface.encodeFunctionData(\"collectionName\", []);\n\n  return Ethers.provider()\n    .call({\n      to: contract,\n      data: encodedData,\n    })\n    .then((n) => {\n      const name = iface.decodeFunctionResult(\"collectionName\", n)[0];\n      State.update({ name: name });\n    });\n};\n\nconst getCollectionImage = () => {\n  try {\n    const encodedData = iface.encodeFunctionData(\"uri\", [0]);\n\n    return Ethers.provider()\n      .call({\n        to: contract,\n        data: encodedData,\n      })\n      .then((url) => {\n        const uri = iface.decodeFunctionResult(\"uri\", url);\n        const real_uri = uri[0].slice(0, uri[0].length - 1);\n        const metas = fetch(real_uri);\n        if (metas.ok) {\n          const jsonmeta = metas.body;\n          State.update({ uri: jsonmeta.image });\n        } else {\n          console.log(metas);\n        }\n      });\n  } catch (err) {\n    console.log(err);\n  }\n};\n\nconst getPrice = () => {\n  const encodedData = iface.encodeFunctionData(\"getTierPrice\", [0]);\n\n  return Ethers.provider()\n    .call({\n      to: contract,\n      data: encodedData,\n    })\n    .then((p) => {\n      const price = iface.decodeFunctionResult(\"getTierPrice\", p);\n      const _price = Big(price.toString()).div(Big(10).pow(18)).toString();\n      State.update({ price: _price });\n    });\n};\n\nif (Ethers.provider()) {\n  getTotalEarnings();\n  getCirculatingSupply();\n  getMaxSupply();\n  getCollectionName();\n  getPrice();\n  getCollectionImage();\n} else return <Web3Connect connectLabel=\"Connect with Web3\" />;\n\nreturn (\n  <tr>\n    <th scope=\"row\" class=\"text-white\" style={{ verticalAlign: \"middle\" }}>\n      <img src={state.uri} class=\"img-fluid\" style={{ maxWidth: \"5vw\" }} />\n    </th>\n    <th class=\"text-white align-center\" style={{ verticalAlign: \"middle\" }}>\n      {state.name}\n    </th>\n    <td class=\"text-white\" style={{ verticalAlign: \"middle\" }}>\n      {state.circulating_supply}\n    </td>\n    <td class=\"text-white\" style={{ verticalAlign: \"middle\" }}>\n      {state.max_supply > 0 ? state.max_supply : \"-\"}\n    </td>\n    <td class=\"text-white\" style={{ verticalAlign: \"middle\" }}>\n      {state.price} \u039e\n    </td>\n    <td class=\"text-white\" style={{ verticalAlign: \"middle\" }}>\n      {state.total_earnings} \u039e\n    </td>\n    <td class=\"text-white\" style={{ verticalAlign: \"middle\" }}>\n      {new Date().toLocaleDateString()}\n    </td>\n  </tr>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/knwtechs.near/widget/Merchant.info", "fact_widget_deployments_id": "ea67ca58f7277b16bd1156c8343f17b0", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}