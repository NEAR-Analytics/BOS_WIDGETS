{"tx_hash": "BG5AEUXgsBsefrnHUe967ZuoQHtVoBhHPenMUCKJRhpE", "action_id_social": "5w7pvsFwe8GmqsQDq5LPTnDr6rsW55MAjn3EeM538WB6-0-widget", "block_id": 97116065, "block_timestamp": "2023-07-23T03:31:07.267Z", "signer_id": "knwtechs.near", "widget_name": "Customer.view", "source_code": "const USER = \"knwtechs.near\";\n\nif (!Ethers.provider() || !props.sender) {\n  return (\n    <div class=\"row d-flex justify-content-center pt-4\">\n      <div class=\"col-8 col-md-4 text-center\">\n        <Web3Connect connectLabel=\"Connect with Web3\" />\n      </div>\n    </div>\n  );\n}\n\nif (!props.factory) {\n  return (\n    <Widget\n      src={`${USER}/widget/Common.error`}\n      props={{ message: \"Factory address missing.\" }}\n    />\n  );\n}\n\nconst collectionABI = fetch(\n  \"https://raw.githubusercontent.com/knwtechs/subscript.io-contracts/main/artifacts/contracts/SubscriptionsCollection.sol/SubscriptionsCollection.json\"\n);\n\nif (!collectionABI.ok) {\n  return (\n    <Widget\n      src={`${USER}/widget/Common.error`}\n      props={{ message: \"Collection ABI unavailable.\" }}\n    />\n  );\n}\n\nconst factoryABI = fetch(\n  \"https://raw.githubusercontent.com/knwtechs/subscript.io-contracts/main/artifacts/contracts/SubscriptionsFactory.sol/SubscriptionsFactory.json\"\n);\n\nif (!factoryABI.ok) {\n  return (\n    <Widget\n      src={`${USER}/widget/Common.error`}\n      props={{ message: \"Factory ABI unavailable.\" }}\n    />\n  );\n}\nconst factoryAddress = props.factory;\n\nconst subscriptionsFactoryContract = new ethers.Contract(\n  factoryAddress,\n  JSON.parse(factoryABI.body)[\"abi\"],\n  Ethers.provider().getSigner()\n);\n\nState.init({\n  widgets: [],\n});\n\nconst getSubscriptionEvents = (user) => {\n  const filter = {\n    address: factoryAddress,\n    topics: [\n      ethers.utils.id(\"NewSubscription(address,address,uint256)\"),\n      null,\n      ethers.utils.hexZeroPad(ethers.utils.getAddress(user), 32),\n    ],\n    fromBlock: 0,\n    toBlock: \"latest\",\n  };\n\n  Ethers.provider()\n    .getLogs(filter)\n    .then((logs) => {\n      const widgets = [];\n      for (let i = 0; i < logs.length; i++) {\n        const parsedLog = subscriptionsFactoryContract.interface.parseLog(\n          logs[i]\n        );\n        widgets.push(\n          <Widget\n            src={`${USER}/widget/Customer.token`}\n            props={{\n              collectionAddress: parsedLog.args[0],\n              abi: JSON.parse(collectionABI.body)[\"abi\"],\n              owner: props.sender,\n            }}\n          />\n        );\n      }\n      State.update({ widgets: widgets });\n    })\n    .catch((err) => console.log(err));\n};\n\ngetSubscriptionEvents(props.sender);\n\nreturn (\n  <div class=\"container-fluid h-100\">\n    <div class=\"row d-flex justify-content-center mt-2\">\n      {state.widgets.map((w) => (\n        <div class=\"col-10 col-md-4 mt-2\">{w}</div>\n      ))}\n    </div>\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/knwtechs.near/widget/Customer.view", "fact_widget_deployments_id": "5de1e2530a4d2c97d65e6c4d9a58b709", "inserted_timestamp": "2000-01-01T00:00:00.000Z", "modified_timestamp": "2000-01-01T00:00:00.000Z", "__row_index": 5}