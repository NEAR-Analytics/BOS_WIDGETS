{"tx_hash": "6XLY7TELDqBguXiXLXKEAUiAw7dQR2BfRso9M3NQASPS", "action_id_social": "3Df6CuJLxbUc2aVbVK7ZDzZH2RnJQSTu5j9uA2d1NaiA-0-widget", "block_id": 97112515, "block_timestamp": "2023-07-23T02:25:14.778Z", "signer_id": "knwtechs.near", "widget_name": "Integration.renew", "source_code": "// PROPS\nif (!props.collectionAddress)\n  return (\n    <Widget\n      src={\"knwtechs.near/widget/Common.error\"}\n      props={{ message: \"`collectionAddress` undefined.\" }}\n    />\n  );\nconst tier = Big(props.tier ?? 0).toString();\nconst style = props.style ?? {\n  backgroundColor: \"blue\",\n  fontWeight: 500,\n  minWidth: \"10vw\",\n  textTransform: \"capitalize\",\n};\n\nState.init({\n  loading: false,\n});\n\n// CHECK FOR WALLET CONNECTION\nif (state.sender === undefined) {\n  const accounts = Ethers.send(\"eth_requestAccounts\", []);\n  if (accounts.length) {\n    State.update({ sender: accounts[0] });\n  } else {\n    return (\n      <Widget\n        src={\"knwtechs.near/widget/Common.error\"}\n        props={{ message: \"Please login first.\" }}\n      />\n    );\n  }\n}\n\n// CONTRACT INSTANCE\nconst collectionABI = fetch(\n  \"https://raw.githubusercontent.com/knwtechs/subscript.io-contracts/main/artifacts/contracts/SubscriptionsCollection.sol/SubscriptionsCollection.json\"\n);\nif (!collectionABI.ok) {\n  return \"Contract unavailable.\";\n}\n\nconst subscriptionsCollectionContract = new ethers.Contract(\n  props.collectionAddress,\n  JSON.parse(collectionABI.body)[\"abi\"],\n  Ethers.provider().getSigner()\n);\n\nsubscriptionsCollectionContract\n  .getTierPrice(tier)\n  .then((price) => State.update({ price: price.toString() }));\n\nconst subscribe = () => {\n  console.log({\n    to: state.sender,\n    tier,\n    price: state.price,\n  });\n\n  try {\n    State.update({ loading: true });\n    subscriptionsCollectionContract\n      .renewSubscription(tier, {\n        value: state.price,\n      })\n      .catch((err) => {\n        State.update({ loading: false });\n        console.log(err);\n      })\n      .then((tx) => {\n        console.log(\"Waiting for confirmation: \", tx);\n        tx.wait().then((receipt) => {\n          console.log(\"TX Confirmed: \", receipt);\n          State.update({ loading: false });\n        });\n      });\n  } catch (err) {\n    State.update({ loading: false });\n    console.log(err);\n  }\n};\n\nreturn (\n  <>\n    <button\n      style={style}\n      onClick={subscribe}\n      id={props.id ?? \"subscribeButton\"}\n    >\n      {state.loading ? (\n        <div class=\"spinner-border text-light\" role=\"status\"></div>\n      ) : (\n        \"renew\"\n      )}\n    </button>\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/knwtechs.near/widget/Integration.renew", "fact_widget_deployments_id": "e2f1dd422cc00b80abc027b2bb9d4e82", "inserted_timestamp": "2000-01-01T00:00:00.000Z", "modified_timestamp": "2000-01-01T00:00:00.000Z", "__row_index": 0}