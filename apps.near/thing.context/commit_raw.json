{"tx_hash": "CXqnCyex6jhLduCPHo9tWj1ffKdAqRbiikS5pdm9YRRw", "action_id_social": "5hFfdghR5A4GJvTRv1LfqHLdcrpyuriTxHjVyHCrnMXk-0-widget", "block_id": 117748013, "block_timestamp": "2024-04-27T16:13:14.373Z", "signer_id": "apps.near", "widget_name": "thing.context", "source_code": "// adapted from the `PublicTags` widget by zavodil.near\n\nconst accountId = props.accountId ?? context.accountId ?? \"every.near\";\n\nconst src = props.src ?? \"apps.near/widget/demo\";\nconst [creatorId, namespace, thingId] = src.split(\"/\");\n\nconst blockheight = props.blockheight ?? \"final\";\n\nconst thingExists = Social.get(`${creatorId}/${namespace}/${thingId}`, \"final\");\n\nconst tagsObject = Social.get(\n  `${creatorId}/${namespace}/${thingId}/metadata/tags/*`,\n  blockheight\n);\n\nState.init({\n  tagsObject,\n});\n\nconst normalizeTag = (tag) =>\n  tag\n    .replaceAll(/[- \\.]/g, \"_\")\n    .replaceAll(/[^\\w]+/g, \"\")\n    .replaceAll(/_+/g, \"-\")\n    .replace(/^-+/, \"\")\n    .replace(/-+$/, \"\")\n    .toLowerCase()\n    .trim(\"-\");\n\nconst contextObject = Social.get(\n  `*/${creatorId}/${namespace}/${thingId}/metadata/tags/*`,\n  blockheight\n);\n\nconst tagsCount = {};\nconst tagsAuthors = {};\n\nconst processTagsObject = (obj) => {\n  Object.keys(obj).forEach((key) => {\n    if (obj[key] === null) {\n      const tag = key;\n      tagsCount[tag] = (tagsCount[tag] || 0) - 1;\n    } else if (typeof obj[key] === \"object\") {\n      processTagsObject(obj[key]);\n    } else {\n      const tag = key;\n      tagsCount[tag] = (tagsCount[tag] || 0) + 1;\n    }\n  });\n};\n\nconst getTags = () => {\n  processTagsObject(tagsObject);\n  const tags = Object.entries(tagsCount);\n  tags.sort((a, b) => b[1] - a[1]);\n  return tags.map((t) => {\n    return {\n      name: t[0],\n      count: t[1],\n    };\n  });\n};\n\nconst setTags = (tags) => {\n  const newTagsObject = {};\n\n  tags.forEach((tag) => {\n    newTagsObject[normalizeTag(tag.name)] = \"\";\n  });\n\n  State.update((prevState) => ({\n    ...prevState,\n    tagsObject: {\n      ...prevState.tagsObject[creatorId][namespace][thingId].tags,\n      ...newTagsObject,\n    },\n  }));\n};\n\nconst publicTags = getTags();\n\nreturn (\n  <>\n    <div className=\"m-2\">\n      {publicTags &&\n        publicTags.map((tag) => (\n          <a\n            href={`/#/hack.near/widget/every.context?tag=${tag.name}`}\n            className=\"text-white btn p-0 lh-1 m-1\"\n            key={tag}\n          >\n            <span\n              className=\"badge bg-primary position-relative\"\n              style={\n                tag.count > 1\n                  ? {\n                      marginRight: \"0.9em\",\n                      paddingRight: \"0.85em\",\n                    }\n                  : { marginRight: \"0.25em\" }\n              }\n            >\n              #{tag.name}\n              {tag.count > 1 && (\n                <span\n                  className={`ms-1 badge translate-middle rounded-pill bg-dark position-absolute top-50 start-100`}\n                >\n                  {tag.count}\n                </span>\n              )}\n            </span>\n          </a>\n        ))}\n    </div>\n    {thingExists && (\n      <div className=\"m-1 row\">\n        <div className=\"m-1 col-8\">\n          <Typeahead\n            id={`tag-selector-${Date.now()}`}\n            multiple\n            labelKey=\"name\"\n            onChange={setTags}\n            options={publicTags}\n            placeholder=\"dev, art, gov, edu, social\"\n            positionFixed\n            allowNew\n          />\n        </div>\n        <div className=\"m-1 col-3\">\n          {accountId === creatorId ? (\n            <CommitButton\n              disabled={state.tagsObject === null}\n              data={{\n                [namespace]: {\n                  metadata: {\n                    tags: state.tagsObject,\n                  },\n                },\n              }}\n            >\n              <i className=\"bi bi-plus-lg\" />\n            </CommitButton>\n          ) : (\n            <CommitButton\n              disabled={state.tagsObject === null}\n              data={{\n                [creatorId]: {\n                  [namespace]: {\n                    [thingId]: {\n                      metadata: {\n                        tags: state.tagsObject,\n                      },\n                    },\n                  },\n                },\n              }}\n            >\n              <i className=\"bi bi-plus-lg\"></i>\n            </CommitButton>\n          )}\n        </div>\n      </div>\n    )}\n  </>\n);\n", "metadata": {"fork_of": "hack.near/widget/thing.context@107099401"}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/apps.near/widget/thing.context", "fact_widget_deployments_id": "5cfbdbe432863c779330fa0d166b9e8e", "inserted_timestamp": "2024-04-27T17:40:14.338Z", "modified_timestamp": "2024-04-27T17:40:14.338Z", "__row_index": 0}