{"tx_hash": "y2VRuwVhz2adcZuZjpScMzqtDhfryzbBX4TKePnJ1zg", "action_id_social": "DM4P9Y4syKisBXfMZo1nrKyMv3xD7CjvSdzbY7skX7Ub-0-widget", "block_id": 100578962, "block_timestamp": "2023-09-07T09:01:48.035Z", "signer_id": "juaner.near", "widget_name": "ref-lending", "source_code": "const Container = styled.div`\n  box-sizing: border-box;\n  padding: 0px 20px 20px 0px;\n  font-family: Gantari;\n  .box_tabel {\n    border-radius: 12px;\n    background: #25283a;\n  }\n  .mt_16 {\n    margin-top: 16px;\n  }\n  .tokenIcon {\n    width: 26px;\n    height: 26px;\n    border-radius: 100px;\n    margin-right: 4px;\n  }\n  .rewardIcon {\n    width: 16px;\n    height: 16px;\n    border-radius: 100px;\n  }\n  .text_grey_color {\n    color: #7e8a93;\n  }\n  .mr_10 {\n    margin-right: 10px;\n  }\n  .ml_5 {\n    margin-left: 5px;\n  }\n  .topArea {\n    padding: 0 25px 38px 25px;\n  }\n  .flex {\n    display: flex;\n    align-items: center;\n    flex-wrap: wrap;\n  }\n  .block {\n    display: flex;\n    flex-direction: column;\n    padding-right: 30px;\n    margin-right: 30px;\n    min-width: 120px;\n    margin-top: 12px;\n    border-right: 1px solid #373a53;\n  }\n  .block .t {\n    font-size: 14px;\n    color: #7c7f96;\n  }\n  .block .v {\n    font-weight: 700;\n    font-size: 20px;\n    color: #fff;\n  }\n  .noBorder {\n    border: none !important;\n  }\n  .mt_26 {\n    margin-top: 26px;\n  }\n  .flex_center {\n    display: flex;\n    align-items: center;\n  }\n  .flex-end {\n    display: flex;\n    align-items: center;\n    justify-content: end;\n    height: 50px;\n  }\n\n  .claim_button {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    height: 26px;\n    background: #00ffa3;\n    border-radius: 6px;\n    margin-left: 16px;\n    font-weight: 700;\n    font-size: 12px;\n    cursor: pointer;\n    padding: 0 12px 0 12px;\n    margin-left: 18px;\n  }\n  .header {\n    display: flex;\n    justify-content: space-between;\n    aligin-items: center;\n\n    .title {\n      font-size: 20px;\n      color: #fff;\n    }\n  }\n\n  .switch {\n    display: flex;\n    padding: 2px;\n    background-color: rgba(255, 255, 255, 0.1);\n    border-radius: 10px;\n    width: 152px;\n    box-sizing: border-box;\n\n    .switch_item {\n      width: 50%;\n      font-size: 14px;\n      color: rgb(148 163 184);\n      line-height: 36px;\n      border-radius: 10px;\n      text-align: center;\n      cursor: pointer;\n      transition: 0.5s;\n      &:hover {\n        color: rgb(203 213 225);\n      }\n    }\n    .active {\n      background-color: rgba(255, 255, 255, 0.1);\n      color: #fff;\n    }\n  }\n\n  .separator {\n    width: 100%;\n    height: 1px;\n    background-color: #373a53;\n  }\n\n  .table_sorter {\n    display: flex;\n    align-items: center;\n    .arrows {\n      margin-left: 4px;\n    }\n    .arrow-wrap {\n      padding: 2px;\n    }\n    .arrow {\n      border: 4px solid transparent;\n      cursor: pointer;\n      transition: 0.5s;\n    }\n    .arrow-up {\n      border-bottom-color: rgb(124, 127, 150);\n      :hover {\n        border-bottom-color: #fff;\n      }\n      &.active {\n        border-bottom-color: #fff;\n      }\n    }\n    .arrow-down {\n      border-top-color: rgb(124, 127, 150);\n      :hover {\n        border-top-color: #fff;\n      }\n      &.active {\n        border-top-color: #fff;\n      }\n    }\n  }\n  .assets_switch {\n    display: none;\n  }\n  .hide_tables {\n    display: block;\n  }\n  .dash_panel_mb_action {\n    display: none;\n  }\n  .dash_panel_data {\n    display: flex;\n  }\n  .mb_table {\n    display: none;\n    @media (max-width: 900px) {\n      display: block;\n      width: 100%;\n      margin-top: 10px;\n      .mb_row {\n        margin-bottom: 10px;\n        background-color: #25283a;\n        border-radius: 12px;\n      }\n      .mb_row_header {\n        display: flex;\n        justify-content: space-between;\n        padding: 10px 20px;\n        align-items: center;\n        border-bottom: 1px solid #373a53;\n      }\n      .mb_row_token {\n        color: #fff;\n      }\n      .double_lines {\n        color: #fff;\n        text-align: right;\n      }\n      .mb_row_item {\n        display: flex;\n        justify-content: space-between;\n        padding: 10px 20px 0px;\n        &:first-child {\n          padding-top: 20px;\n        }\n      }\n      .mb_row_label {\n        color: #7c7f96;\n        font-size: 13px;\n      }\n      .mb_row_value {\n        color: #fff;\n        font-size: 15px;\n      }\n      .mb_row_actions {\n        display: flex;\n        gap: 10px;\n        padding: 20px;\n      }\n      .action_btn {\n        flex-grow: 1;\n      }\n    }\n  }\n  @media (max-width: 900px) {\n    padding: 0px 0px 20px 0px;\n    .title.fw-bold {\n      font-weight: 400 !important;\n    }\n    .hide_tables {\n      display: none;\n    }\n    .separator {\n      display: none;\n    }\n    .box_tabel {\n      background: transparent;\n      .mt_16 {\n        margin-top: 0px;\n      }\n    }\n    .header {\n      .title {\n        display: none;\n      }\n      .switch {\n        width: 100%;\n        background-color: transparent;\n        padding-top: 5px;\n        border-bottom: 1px solid #373a53;\n        border-radius: 10px 10px 0px 0px;\n        .active {\n          background-color: transparent;\n          position: relative;\n          &::after {\n            content: \"\";\n            position: absolute;\n            width: 48px;\n            height: 2px;\n            background-color: #00ffa3;\n            bottom: -2px;\n            left: calc(50% - 24px);\n          }\n        }\n      }\n    }\n    .dash_panel {\n      background-color: #25283a;\n      border-radius: 10px;\n    }\n    .dash_panel_content {\n      flex-direction: column;\n      padding: 0px 10px;\n    }\n    .dash_panel_data {\n      display: flex;\n      flex-wrap: wrap;\n      .block {\n        border-right: none;\n        width: 50%;\n        margin-right: 0px;\n        padding-left: 14%;\n        padding-right: 0px;\n      }\n    }\n    .dash_panel_pc_action {\n      display: none;\n    }\n    .dash_panel_mb_action {\n      width: 100%;\n      margin-right: 0px;\n      align-items: center;\n      flex-direction: row;\n      border-top: 1px dashed #373a53;\n      border-right: none;\n      padding: 10px 0px 20px 0px;\n      justify-content: center;\n      .unclaimed_rewards,\n      .claim_button_wrapper {\n        width: 50%;\n        padding-left: 14%;\n      }\n      .claim_button {\n        width: 108px;\n        height: 34px;\n        margin-left: 0px;\n      }\n    }\n    .dash_panel_market_data {\n      padding-bottom: 20px;\n    }\n    .assets_switch {\n      margin-top: 10px;\n      width: 100%;\n      background-color: #25283a;\n      border-radius: 10px;\n      display: flex;\n      padding: 4px;\n      height: 44px;\n      color: #7c7f96;\n      .assets_switch_item {\n        width: 50%;\n        font-size: 16px;\n        line-height: 36px;\n        text-align: center;\n      }\n      .active {\n        background-color: #4c506b;\n        border-radius: 8px;\n        color: #fff;\n      }\n    }\n  }\n`;\nconst wnearbase64 =\n  \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAABmJLR0QA/wD/AP+gvaeTAAADvElEQVRYhbWYTUtjVxjH/9fRaFBaK3Q0ahCE3HTR0kWLL0g72nEh6NaAL+BivkIXHUpblWr9Ai78CIKgQqC1xYJNVnWwdiFCF9OS4CRRM2o7TRyw+XWRJk2uebuJ/uFC7jnP89xfzrnPOee5hmwIqJc0LOmxpA8keSW1SnpD0p+SLiT9JumZpF1Je4Zh3Nh5RiUQHcAKEMWeov/5td8FRBPwFZCwCWFVAvgCaKwWxAsc1ghh1RHwrl2QR8DlHYNk9BcwWinIMJC8J5CMEsDH5UDeAa7uGSSjC8DMfb6RA9Ik6WdJ79ma09r0q6R+wzBeS1JdTsdnhUACgYA8Ho8cDofGx8d1fn5u62mrq6tyuVwyTVPBYNDa/b6kT/NaSK8jBdPX4/EgKXsNDQ1xfX1d0Tz4/f48X9M0C5n9DTzMhVkpFjA3WOaam5srCxKPx+ns7LzlW0TLGZB6IGIHRhIrK0X5AZiZmSnoV0RRoF7AaKmguYFmZ2ezv+vq6tja2iros7m5iSSamppYWlqqBAZgRMA3lcJEo1Gmpqay9y0tLRwe5i/SZ2dntLe309bWxt7eHuFwuFKYrwX8UClMLBYjkUjQ19eXbevp6SEa/X//9Pl89Pb2cnx8DGAH5jsBf9iBATg5OaGrqyvbPjg4SDKZJBQKMTo6yunpadbfBsxzkd4rbMEAHBwc0NzcnO3z+XykUqlb/jZgrgTcVAMDsLGxgWEY2f7l5eVaYG6qHpmM5ufns/2GYbC+vl4tzJWA32uBSaVSTE9PZ22cTif7+/vVwDwX8H01MJFIhJGRESKRyK0Mc7vdRCIRuzDf1il9eLalo6MjDQwMqLu7Wx0dHXI6ndre3pbb7ZYkhcNhTUxMKJFI2An7TMBjOyOzu7tLa2srLpeLeDyeZ2vNsMnJSUKhUKUjM2xrb1pYWMDhcCAJv99f0N6aYdY9qoheAA8k2d+1nzx5Uuofsri4WHSDLaKl7GQB7RQ5z1iDud1uLi9Ln9WtGVYG5hXwdt7bA3xZyNI0zbx1ZGdnpyRIRslkkv7+/jwQr9dbyPTprVcZaKRAnRQIBDBNE5fLxdraWkUgGcViMcbGxmhoaMDr9RIMBq0mB4CjYG6RLtzuq16y6iXgKZnspAu4WsvZckoAH5UEyQEaAM7vCeSCcgVcASAT+OWOQQ4oNzUlgBqBz0mXE7XoFfCUYi+rTaiHwDLpldKOXgBLWNeRIjLKm+RBPZD0SNInkj5U+svVW5LelHQl6aXSX672Jf0o6SfDMP6pNP6/QZPF1Du0/sIAAAAASUVORK5CYII=\";\n\nconst toAPY = (v) => Math.round(v * 100) / 100;\nconst shrinkToken = (value, decimals, fixed) => {\n  return new Big(value || 0).div(new Big(10).pow(decimals || 0)).toFixed(fixed);\n};\n// get all assets data from burrow contracts\nconst {\n  assets,\n  rewards,\n  account,\n  balances,\n  selectedTokenId,\n  selectedTokenMeta,\n  total_supplied_usd,\n  total_burrowed_usd,\n  type,\n  showModal,\n} = state;\n\nState.init({\n  assetType: \"supply\",\n});\n\nconst hasData = assets.length > 0 && rewards.length > 0 && account;\nconst rewardsMap = rewards\n  ? rewards.reduce((acc, cur) => {\n      return {\n        ...acc,\n        [cur.token_id]: cur,\n      };\n    }, {})\n  : {};\nconst assetsMap = assets\n  ? assets.reduce((acc, cur) => {\n      return {\n        ...acc,\n        [cur.token_id]: cur,\n      };\n    }, {})\n  : {};\nconst onLoad = (data) => {\n  State.update(data);\n};\n// get unclaimed rewards\nconst unclaimedRewardsMap = account\n  ? account.farms?.reduce((prev, curr) => {\n      for (const reward of curr.rewards) {\n        const t = prev[reward.reward_token_id];\n        if (t) {\n          prev[reward.reward_token_id] = Big(t)\n            .plus(Big(reward.unclaimed_amount))\n            .toFixed();\n        } else {\n          prev[reward.reward_token_id] = Big(reward.unclaimed_amount).toFixed();\n        }\n      }\n      return prev;\n    }, {})\n  : {};\nlet unclaimedRewards$ = Big(0);\nconst unclaimedRewardsIcons = Object.keys(unclaimedRewardsMap).map((id) => {\n  const asset = assets.find((a) => a.token_id === id);\n  const decimals = asset.metadata.decimals + asset.config.extra_decimals;\n  const unclaimed = shrinkToken(unclaimedRewardsMap[id], decimals);\n  unclaimedRewards$ = unclaimedRewards$.plus(\n    Big(unclaimed).mul(asset.price.usd || 0)\n  );\n  return {\n    id,\n    icon: asset.metadata.icon,\n  };\n});\n// get net apy\nconst getNetAPY = (assets, account) => {\n  const extraDaily = getExtraDaily(assets, account);\n  const [gainCollateral, totalCollateral] = getGains(\n    account,\n    assets,\n    \"collateral\"\n  );\n  const [gainSupplied, totalSupplied] = getGains(account, assets, \"supplied\");\n  const [gainBorrowed] = getGains(account, assets, \"borrowed\");\n\n  const gainExtra = extraDaily * 365;\n\n  const netGains = gainCollateral + gainSupplied + gainExtra - gainBorrowed;\n  const netTotals = totalCollateral + totalSupplied;\n  const netAPY = (netGains / netTotals) * 100;\n\n  return netAPY || 0;\n};\nfunction getExtraDaily(assets, account) {\n  const farms = account.farms.filter(\n    (farm) => !!(farm.farm_id[\"Supplied\"] || farm.farm_id[\"Borrowed\"])\n  );\n  const farmsRewards = farms\n    .map((farm) => {\n      const token_id = farm.farm_id.Borrowed || farm.farm_id.Supplied;\n      const asset = assets.find((asset) => asset.token_id == token_id);\n      const assetDecimals =\n        asset.metadata.decimals + asset.config.extra_decimals;\n      const rewards = farm.rewards.map((reward) => {\n        const { reward_token_id, boosted_shares, asset_farm_reward } = reward;\n        const assetReward = assets.find(\n          (asset) => asset.token_id == reward_token_id\n        );\n        const rewardAssetDecimals =\n          assetReward.metadata.decimals + assetReward.config.extra_decimals;\n        const boostedShares = Number(\n          shrinkToken(boosted_shares, assetDecimals)\n        );\n        const totalBoostedShares = Number(\n          shrinkToken(asset_farm_reward.boosted_shares, assetDecimals)\n        );\n        const totalRewardsPerDay = Number(\n          shrinkToken(asset_farm_reward.reward_per_day, rewardAssetDecimals)\n        );\n        const dailyAmount =\n          (boostedShares / totalBoostedShares) * totalRewardsPerDay;\n        return { dailyAmount, reward_token_id, token_id };\n      });\n      return rewards;\n    })\n    .flat();\n  const extraDaily$ = farmsRewards.reduce((acc, cur) => {\n    const { dailyAmount, reward_token_id } = cur;\n    const assetReward = assets.find(\n      (asset) => asset.token_id == reward_token_id\n    );\n    const price = assetReward.price.usd || 0;\n    return acc + dailyAmount * price;\n  }, 0);\n  return extraDaily$ || 0;\n}\nfunction getGains(account, assets, source) {\n  return account[source]\n    .map((accountAsset) => {\n      const { token_id, balance, apr } = accountAsset;\n      const asset = assets.find((asset) => asset.token_id == token_id);\n      const netTvlMultiplier = asset.config.net_tvl_multiplier / 10000;\n      const balanceUSD = toUsd(balance, asset);\n      return [balanceUSD * (withNetTvlMultiplier ? netTvlMultiplier : 1), apr];\n    })\n    .reduce(\n      ([gain, sum], [balance, apr]) => [gain + balance * apr, sum + balance],\n      [0, 0]\n    );\n}\nconst toUsd = (balance, asset) =>\n  asset?.price?.usd\n    ? Number(\n        shrinkToken(\n          balance,\n          asset.metadata.decimals + asset.config.extra_decimals\n        )\n      ) * asset.price.usd\n    : 0;\nlet apyNetValue;\nif (assets && account && rewards) {\n  const netAPY = getNetAPY(assets, account);\n  const r = rewards[0].apyRewardTvl || 0;\n  apyNetValue = Big(netAPY || 0)\n    .plus(r)\n    .toFixed(2);\n}\n\nconst handleClaimAll = () => {\n  Near.call({\n    contractName: \"contract.main.burrow.near\",\n    methodName: \"account_farm_claim_all\",\n  });\n};\n// get portfolio borrowed assets\nfunction closeModal() {\n  State.update({\n    showModal: false,\n  });\n}\n\nreturn (\n  <Container>\n    {/* load data */}\n    {!hasData && (\n      <Widget src=\"juaner.near/widget/ref_burrow-data\" props={{ onLoad }} />\n    )}\n\n    <Widget\n      src=\"juaner.near/widget/ref-lending-header\"\n      props={{ total_supplied_usd, total_burrowed_usd }}\n    />\n    <div class=\"assets_switch\">\n      <div\n        class={`assets_switch_item ${\n          state.assetType === \"supply\" ? \"active\" : \"\"\n        }`}\n        onClick={() => {\n          State.update({\n            assetType: \"supply\",\n          });\n        }}\n      >\n        Supply\n      </div>\n      <div\n        class={`assets_switch_item ${\n          state.assetType === \"borrow\" ? \"active\" : \"\"\n        }`}\n        onClick={() => {\n          State.update({\n            assetType: \"borrow\",\n          });\n        }}\n      >\n        Borrow\n      </div>\n    </div>\n    {/* supply area */}\n    <div\n      className={`box_tabel mt_16 ${\n        state.assetType === \"borrow\" && \"hide_tables\"\n      }`}\n    >\n      {/*yours */}\n      <>\n        <Widget\n          src=\"juaner.near/widget/ss-your-supply\"\n          props={{ onLoadState: onLoad }}\n        />\n        <div class=\"separator\" />\n      </>\n\n      {/*market */}\n      <Widget src=\"juaner.near/widget/ref-market-supply-assets\" />\n    </div>\n    {/* burrow area */}\n    <div\n      className={`box_tabel mt_16 ${\n        state.assetType === \"supply\" && \"hide_tables\"\n      }`}\n    >\n      {/* yours */}\n\n      <>\n        <Widget\n          src=\"juaner.near/widget/ss-your-burrow\"\n          props={{ onLoadState: onLoad }}\n        />\n\n        <div class=\"separator\" />\n      </>\n\n      {/*market */}\n      <Widget src=\"juaner.near/widget/ref-market-burrow-assets\" />\n    </div>\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/juaner.near/widget/ref-lending", "fact_widget_deployments_id": "222b7dfdbb3d01b14284f582d612889b", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 4}