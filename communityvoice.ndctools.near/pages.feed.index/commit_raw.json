{"tx_hash": "8u1ms9J9mBFsumHBiQaMYRnXbkMCnBCxMLGF5hRcDdJN", "action_id_social": "2htq4jpCgEE1qKkL57bv3ctDbZXenThVKDpWzH1VfDSK-0-widget", "block_id": 100364009, "block_timestamp": "2023-09-04T08:56:43.203Z", "signer_id": "communityvoice.ndctools.near", "widget_name": "pages.feed.index", "source_code": "const { Config, Post } = props;\n\nconst communities = [\n  {\n    id: \"og\",\n    name: \"OGs\",\n    rules: {\n      posting: {\n        SBTs: [\"community.i-am-human.near\"],\n      },\n      commenting: {},\n    },\n  },\n  {\n    id: \"general\",\n    name: \"General\",\n    rules: {\n      commenting: {\n        SBTs: [\"fractal.i-am-human.near\"],\n      },\n    },\n  },\n  {\n    id: \"public\",\n    name: \"Public\",\n    rules: {},\n  },\n];\n\nState.init({\n  community: \"general\",\n});\n\nconst activeCommunity = communities.find((c) => c.id === state.community);\n\nconst index = [\n  {\n    action: Config.postDataKey,\n    key: state.community,\n    options: {\n      limit: 10,\n      order: \"desc\",\n    },\n    cacheOptions: {\n      ignoreCache: true,\n    },\n  },\n];\n\nconst handleCreatePost = (body) => {\n  Post.create(\n    {\n      body: body,\n      type: \"md\",\n      community: state.community,\n      tags: [],\n    },\n    () => console.log(\"posted successfully\"),\n    () => console.log(\"user canceled\"),\n    (e) => console.log(\"error\", e),\n  );\n};\n\nconst handleCommentsModal = (postAuthor, postBlockHeight, newState) => {\n  State.update({\n    commentsModal: {\n      open: newState,\n      props: {\n        postAuthor,\n        postBlockHeight,\n      },\n    },\n  });\n};\n\n// -- Gating based on Community Rules\nlet canPost = true;\n\nif (Array.isArray(activeCommunity.rules.posting.SBTs)) {\n  // user should have the SBTs\n  activeCommunity.rules.posting.SBTs.forEach((SBT) => {\n    const allSBTs = Near.view(Config.SBTRegistry, \"sbt_tokens_by_owner\", {\n      account: context.accountId,\n    });\n\n    if (allSBTs === null) return \"\";\n    const hasSBT = (allSBTs || []).find((s) => s[0] === SBT)[1].length > 0;\n    canPost = canPost && hasSBT;\n  });\n}\n// -- End\nreturn (\n  <div className=\"d-flex gap-4 p-4 w-100\">\n    <div className=\"d-flex flex-column gap-4 flex-fill\">\n      <select\n        onChange={({ target: { value } }) => {\n          State.update({ community: value });\n        }}\n      >\n        {communities.map((c, i) => {\n          return (\n            <option value={c.id} selected={state.community === c.id}>\n              {c.name}\n            </option>\n          );\n        })}\n      </select>\n      <Widget\n        src=\"nearui.near/widget/Social.PostCompose\"\n        props={{\n          onPost: handleCreatePost,\n          disabled: !canPost,\n        }}\n      />\n      {state.commentsModal.open && (\n        <Widget\n          src=\"communityvoice.ndctools.near/widget/pages.feed.comments\"\n          props={{\n            onClose: () => State.update({ commentsModal: undefined }),\n            Config,\n            Post,\n            community: activeCommunity,\n            ...state.commentsModal.props,\n          }}\n        />\n      )}\n      <Widget\n        src=\"mob.near/widget/MergedIndexFeed\"\n        props={{\n          index,\n          renderItem: (p) => {\n            return (\n              <Widget\n                src=\"communityvoice.ndctools.near/widget/pages.feed.post\"\n                props={{\n                  ...p,\n                  Config,\n                  Post,\n                  communities,\n                  onCommentsModal: (a, b) => handleCommentsModal(a, b, true),\n                }}\n              />\n            );\n          },\n        }}\n      />\n    </div>\n    <div className=\"d-lg-block d-none\" style={{ width: 300 }}>\n      <Markdown\n        text={\n          \"```json \\n// Selected Group \\n\" +\n          JSON.stringify(activeCommunity, null, 2) +\n          \"\\n```\"\n        }\n      />\n      <h5>Can post: {canPost.toString()}</h5>\n    </div>\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/communityvoice.ndctools.near/widget/pages.feed.index", "fact_widget_deployments_id": "21a0b8b2f77618b2f48e2e358fdc98d6", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}