{"tx_hash": "GJfAFed2hic41CCBAbJ7UgHVaRTgJhC1DaZRAf8T4EPr", "action_id_social": "FGZooRdRTZjmxcPa6p9YeoqdeVmS2h4VsYypxtP5WW4y-0-widget", "block_id": 98945364, "block_timestamp": "2023-08-16T15:07:20.010Z", "signer_id": "y3k.near", "widget_name": "widgets.external.horizon_project_stats", "source_code": "const header_map = {\n  DAA: \"Daily Active Accounts\",\n  MAA: \"Monthly Active Accounts\",\n  MVT: \"Monthly Average Transactions\",\n  DVT: \"Daily Average Transactions\",\n};\n\nconst stateJSON = JSON.stringify({\n  selectedMetric: header_map[props.selectedMetric] || header_map[\"MAA\"],\n  project_name: props.project_name || \"near\",\n});\n\nconst generateIframeCode = (stateJSON) => `\n<script src=\"https://unpkg.com/react@18/umd/react.development.js\" crossorigin></script>\n<script src=\"https://unpkg.com/react-dom@18/umd/react-dom.development.js\" crossorigin></script>\n<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n\n\n<canvas id=\"myChart\" style=\"position: relative; height:80vh; width:80vw\"></canvas>\n\n<script>\n\n\n\n\n\nconst initialState = JSON.parse('${stateJSON}');\nconsole.log(initialState)\n\n\n\nconst colorGenerator = () => {\n  const colors = [\n    \"rgb(255, 99, 132)\",\n    \"rgb(75, 192, 192)\",\n    \"rgb(153, 102, 255)\",\n    \"rgb(255, 159, 64)\",\n    \"rgb(54, 162, 235)\",\n    \"rgb(201, 203, 207)\",\n    \"rgb(255, 205, 86)\",\n    \"rgb(255, 99, 71)\",\n    \"rgb(147, 112, 219)\",\n    \"rgb(0, 128, 128)\",\n    \"rgb(100, 149, 237)\",\n    \"rgb(127, 255, 0)\",\n  ];\n\n  let index = 0;\n\n  return () => {\n    if (index >= colors.length) {\n      index = 0;\n    }\n\n    return colors[index++];\n  };\n};\n\nconst getBackgroundColor = colorGenerator();\n\n\nfunction filterByProjectName(arr, project_name) {\n  return arr.filter((obj) => obj.PROJECT_NAME === project_name);\n}\n\nfunction sortByActivityDate(arr) {\n  return arr.sort(\n    (a, b) => new Date(a.ACTIVITY_DATE) - new Date(b.ACTIVITY_DATE)\n  );\n}\n\n\n\nfunction parseUTCDate(dateString) {\n  const [year, month, day] = dateString\n    .split(\"-\")\n    .map((str) => parseInt(str, 10));\n  // Subtract 1 from the month, as JavaScript months are zero-based\n  const utcTimestamp = Date.UTC(year, month - 1, day);\n  return new Date(utcTimestamp);\n}\nconst months = [\n  \"January\",\n  \"February\",\n  \"March\",\n  \"April\",\n  \"May\",\n  \"June\",\n  \"July\",\n  \"August\",\n  \"September\",\n  \"October\",\n  \"November\",\n  \"December\",\n];\n\n\nfunction updateProcessedData(filteredSortedData, selectedMetric) {\n  const processedData = [];\n\n  filteredSortedData.forEach((datum) => {\n    if (!datum.ACTIVITY_DATE) {\n      return;\n    }\n\n    const activity_date = parseUTCDate(datum.ACTIVITY_DATE);\n    const isoDate = activity_date.toISOString().slice(0, 10);\n    const month =\n      months[\n        parseInt(isoDate.split(\"-\")[1]) - 1\n      ];\n\n    let monthData;\n\n    // Check if the selectedMetric is DAA or DVT, and include dates accordingly\n    if (selectedMetric === \"DAA\" || selectedMetric === \"DVT\") {\n      monthData = processedData.find((data) => data.label === isoDate); // Using the ISO date as the label\n      if (!monthData) {\n        monthData = {\n          label: isoDate, // Using the ISO date as the label\n          data: {},\n          backgroundColor: getBackgroundColor(),\n        };\n        processedData.push(monthData);\n      }\n    } else {\n      monthData = processedData.find((data) => data.label === month);\n      if (!monthData) {\n        monthData = {\n          label: month,\n          data: {},\n          backgroundColor: getBackgroundColor(),\n        };\n        processedData.push(monthData);\n      }\n    }\n\n    monthData.data[isoDate] = datum[selectedMetric];\n  });\n\n  return processedData;\n}\n\n\n\n\nasync function fetchData() {\n\n  let response = await fetch(\n  \"https://api.flipsidecrypto.com/api/v2/queries/367eedd4-b79d-4cf8-929a-178bbcb0a4e4/data/latest\",\n    {\n        subscribe: true,\n        method: \"GET\",\n        headers: {\n        Accept: \"*/*\",\n        },\n    }\n    );\n  \nlet data = await response.json();\n\nconst filteredData = filterByProjectName(data, initialState.project_name) || [];\nconst filteredSortedData = sortByActivityDate(filteredData) || [];\n\n\n\n\nlet newProcessedData = updateProcessedData(\n  filteredSortedData,\n  initialState.selectedMetric\n);\n\nconsole.log(initialState.selectedMetric)\n\nnewProcessedData = sortByActivityDate(newProcessedData) || [];\nconsole.log(\"newProcessedData\")\nconsole.log(newProcessedData)\n\n  var ctx = document.getElementById('myChart').getContext('2d');\n  var myChart = new Chart(ctx, {\n      type: 'bar',\n      data: {\n          labels: months,\n          datasets: newProcessedData\n      },\n      options: {\n  scales: {\n      y: {\n        stacked: true,\n        grid: {\n        color: \"rgb(41,51,64)\", // This will change the gridline color\n        borderColor: \"rgb(240,255,240)\",\n        },\n        ticks: {\n          color: \"rgb(0,0,0)\", // This will change the axis text label color\n        },\n      },\n      x: {\n        stacked: true,\n        grid: {\n        color: \"rgb(41,51,64)\", // This will change the gridline color\n        },\n        ticks: {\n          color: \"rgb(0,0,0)\", // This will change the axis text label color\n        },\n      },\n    },\n      }\n  });\n}\n\nfetchData();\n\n</script>\n\n`;\n\nreturn (\n  <div>\n    <iframe\n      iframeResizer\n      className=\"w-100\"\n      style={{ height: \"300px\" }}\n      srcDoc={generateIframeCode(stateJSON)} // Use the function to generate the code\n    />\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/y3k.near/widget/widgets.external.horizon_project_stats", "fact_widget_deployments_id": "cb7d1b8359a2eb4d0373e57ab26b21a7", "inserted_timestamp": "2023-08-16T16:50:28.384Z", "modified_timestamp": "2023-08-16T16:50:28.384Z", "__row_index": 0}