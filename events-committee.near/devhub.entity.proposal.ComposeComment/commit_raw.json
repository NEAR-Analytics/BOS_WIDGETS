{"tx_hash": "FSNmrMkko64toHu8pJnLXVhpLt949x7jSGbMCkqnWva", "action_id_social": "BWYRbWJjFu4vMmYCDZoBqECh8prTAJMjbDXzoDwchEeG-0-widget", "block_id": 118099497, "block_timestamp": "2024-05-02T15:41:02.004Z", "signer_id": "events-committee.near", "widget_name": "devhub.entity.proposal.ComposeComment", "source_code": "const proposalId = props.id;\nconst draftKey = \"COMMENT_DRAFT\" + proposalId;\nconst draftComment = Storage.privateGet(draftKey);\n\nconst ComposeEmbeddCSS = `\n  .CodeMirror {\n    border: none !important;\n    min-height: 50px !important;\n  }\n\n  .editor-toolbar {\n    border: none !important;\n  }\n\n  .CodeMirror-scroll{\n    min-height: 50px !important;\n  }\n`;\nconst notifyAccountId = props.notifyAccountId;\nconst accountId = context.accountId;\nconst item = props.item;\nconst [allowGetDraft, setAllowGetDraft] = useState(true);\nconst [comment, setComment] = useState(null);\n\nuseEffect(() => {\n  if (draftComment && allowGetDraft) {\n    setComment(draftComment);\n    setAllowGetDraft(false);\n  }\n}, [draftComment]);\n\nuseEffect(() => {\n  const handler = setTimeout(() => {\n    if (comment !== draftComment) Storage.privateSet(draftKey, comment);\n  }, 2000);\n\n  return () => {\n    clearTimeout(handler);\n  };\n}, [comment, draftKey]);\n\nif (!accountId) {\n  return (\n    <div\n      style={{\n        marginLeft: 10,\n        backgroundColor: \"#ECF8FB\",\n        border: \"1px solid #E2E6EC\",\n      }}\n      className=\"d-flex align-items-center gap-1 p-4 rounded-2 flex-wrap flex-md-nowrap\"\n    >\n      <Link to=\"https://near.org/signup\">\n        <Widget\n          src={\"events-committee.near/widget/devhub.components.molecule.Button\"}\n          props={{\n            classNames: { root: \"grey-btn\" },\n            label: \"Sign up\",\n          }}\n        />\n      </Link>\n      <div className=\"fw-bold\">to join this conversation.</div>\n      <div>Already have an account?</div>\n      <a className=\"text-decoration-underline\" href=\"https://near.org/signin\">\n        Log in to comment\n      </a>\n    </div>\n  );\n}\n\nfunction extractMentions(text) {\n  const mentionRegex =\n    /@((?:(?:[a-z\\d]+[-_])*[a-z\\d]+\\.)*(?:[a-z\\d]+[-_])*[a-z\\d]+)/gi;\n  mentionRegex.lastIndex = 0;\n  const accountIds = new Set();\n  for (const match of text.matchAll(mentionRegex)) {\n    if (\n      !/[\\w`]/.test(match.input.charAt(match.index - 1)) &&\n      !/[/\\w`]/.test(match.input.charAt(match.index + match[0].length)) &&\n      match[1].length >= 2 &&\n      match[1].length <= 64\n    ) {\n      accountIds.add(match[1].toLowerCase());\n    }\n  }\n  return [...accountIds];\n}\n\nfunction extractTagNotifications(text, item) {\n  return extractMentions(text || \"\")\n    .filter((accountId) => accountId !== context.accountId)\n    .map((accountId) => ({\n      key: accountId,\n      value: {\n        type: \"mention\",\n        item,\n      },\n    }));\n}\n\nfunction composeData() {\n  const data = {\n    post: {\n      comment: JSON.stringify({\n        type: \"md\",\n        text: comment,\n        item,\n      }),\n    },\n    index: {\n      comment: JSON.stringify({\n        key: item,\n        value: {\n          type: \"md\",\n        },\n      }),\n    },\n  };\n\n  const notifications = extractTagNotifications(comment, {\n    type: \"social\",\n    path: `${accountId}/post/comment`,\n  });\n\n  if (notifyAccountId && notifyAccountId !== context.accountId) {\n    notifications.push({\n      key: notifyAccountId,\n      value: {\n        type: \"devhub/reply\",\n        item,\n        proposal: proposalId,\n      },\n    });\n  }\n\n  if (notifications.length) {\n    data.index.notify = JSON.stringify(\n      notifications.length > 1 ? notifications : notifications[0]\n    );\n  }\n\n  Social.set(data, {\n    force: true,\n    onCommit: () => {\n      setComment(\"\");\n    },\n    onCancel: () => {},\n  });\n}\n\nuseEffect(() => {\n  if (props.transactionHashes && comment) {\n    setComment(\"\");\n  }\n}, [props.transactionHashes]);\n\nreturn (\n  <div className=\"d-flex gap-2\">\n    <Widget\n      src={\"events-committee.near/widget/devhub.entity.proposal.Profile\"}\n      props={{\n        accountId: accountId,\n      }}\n    />\n    <div className=\"d-flex flex-column gap-2 w-100\">\n      <b className=\"mt-1\">Add a comment</b>\n      <Widget\n        src={\"events-committee.near/widget/devhub.components.molecule.Compose\"}\n        props={{\n          data: comment,\n          onChange: setComment,\n          autocompleteEnabled: true,\n          placeholder: \"Add your comment here...\",\n          height: \"160\",\n          embeddCSS: ComposeEmbeddCSS,\n          showProposalIdAutoComplete: true,\n        }}\n      />\n      <div className=\"d-flex gap-2 align-content-center justify-content-end\">\n        <Widget\n          src={\"events-committee.near/widget/devhub.components.molecule.Button\"}\n          props={{\n            label: \"Comment\",\n            disabled: !comment,\n            classNames: { root: \"green-btn btn-sm\" },\n            onClick: () => {\n              composeData();\n            },\n          }}\n        />\n      </div>\n    </div>\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/events-committee.near/widget/devhub.entity.proposal.ComposeComment", "fact_widget_deployments_id": "ec0053d5290af0377ed4b7ded9863112", "inserted_timestamp": "2024-05-02T17:39:26.862Z", "modified_timestamp": "2024-05-02T17:39:26.862Z", "__row_index": 41}