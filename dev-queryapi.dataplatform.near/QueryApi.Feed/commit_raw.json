{"tx_hash": "2yEVXAd6QtpC2s32WVTa19jPwgBQSMGk9e4pTqKgwQ4R", "action_id_social": "AqegponQbJ63qfXb5obfmh63EKXds4B8ddNuEqhYRpXU-0-widget", "block_id": 97329664, "block_timestamp": "2023-07-25T21:49:03.347Z", "signer_id": "dev-queryapi.dataplatform.near", "widget_name": "QueryApi.Feed", "source_code": "const GRAPHQL_ENDPOINT = \"https://near-queryapi.api.pagoda.co\";\nconst APP_OWNER = \"dataplatform.near\";\n\nlet lastPostSocialApi = Social.index(\"post\", \"main\", {\n  limit: 1,\n  order: \"desc\",\n});\n\nState.init({\n  shouldFallback: props.shouldFallback ?? false,\n});\n\nfunction fetchGraphQL(operationsDoc, operationName, variables) {\n  return asyncFetch(`${GRAPHQL_ENDPOINT}/v1/graphql`, {\n    method: \"POST\",\n    headers: { \"x-hasura-role\": \"dataplatform_near\" },\n    body: JSON.stringify({\n      query: operationsDoc,\n      variables: variables,\n      operationName: operationName,\n    }),\n  });\n}\n\nconst lastPostQuery = `\nquery IndexerQuery {\n  dataplatform_near_social_feed_posts( limit: 1, order_by: { block_height: desc }) {\n      block_height \n  }\n}\n`;\n\nfetchGraphQL(lastPostQuery, \"IndexerQuery\", {})\n  .then((feedIndexerResponse) => {\n    if (feedIndexerResponse && feedIndexerResponse.body.data.dataplatform_near_social_feed_posts.length > 0) {\n      const nearSocialBlockHeight = lastPostSocialApi[0].blockHeight;\n      const feedIndexerBlockHeight =\n        feedIndexerResponse.body.data.dataplatform_near_social_feed_posts[0]\n          .block_height;\n\n      const lag = nearSocialBlockHeight - feedIndexerBlockHeight;\n\n      let shouldFallback = lag > 2 || !feedIndexerBlockHeight;\n\n      // console.log(`Social API block height: ${nearSocialBlockHeight}`);\n      // console.log(`Feed block height: ${feedIndexerBlockHeight}`);\n      // console.log(`Lag: ${lag}`);\n      // console.log(`Fallback to old widget? ${shouldFallback}`);\n\n      State.update({ shouldFallback });\n    } else {\n      console.log(\"Falling back to old widget.\");\n      State.update({ shouldFallback: true });\n    }\n  })\n  .catch((error) => {\n    console.log(\"Error while fetching GraphQL(falling back to old widget): \", error);\n    State.update({ shouldFallback: true });\n  });\n\nreturn (\n  <>\n    {state.shouldFallback == true ? (\n      <Widget src=\"near/widget/Posts\" />\n    ) : (\n      <Widget\n        src={`${APP_OWNER}/widget/QueryApi.Examples.Feed.Posts`}\n        props={{\n          GRAPHQL_ENDPOINT,\n          APP_OWNER,\n        }}\n      />\n    )}\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/dev-queryapi.dataplatform.near/widget/QueryApi.Feed", "fact_widget_deployments_id": "f73960fbb5d309f68b0f2d8c207cf8d2", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 3}