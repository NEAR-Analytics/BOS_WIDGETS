{"tx_hash": "HiRQ89175aERSiSMxdNBgtn3c39dsJctPKmz5ULuVHsb", "action_id_social": "3TnWWRcWCKFkNXDohMtfxWj6k54yqL9PJtmhjQiyyuKo-0-widget", "block_id": 106746188, "block_timestamp": "2023-11-28T16:48:35.805Z", "signer_id": "meta-pool-official.near", "widget_name": "ImprovementProposals.ProposalsTable", "source_code": "let proposals = props.proposals;\r\nconst authorId = props.authorId || \"manzanal.near\";\r\nconst contractId = props.contractId || \"mpip.meta-pool-dao.near\";\r\nState.init({});\r\n\r\n// sort proposals by mpip_id descending\r\nif (proposals && proposals !== null) {\r\n  proposals.sort((p1, p2) => p2.mpip_id - p1.mpip_id);\r\n}\r\n\r\nconst yoctoToNear = (amountYocto) =>\r\n  new Big(amountYocto).div(new Big(10).pow(24)).toFixed(0);\r\n\r\nconst calculateTimeDifference = (date1, date2) => {\r\n  const millisecondsInDay = 24 * 60 * 60 * 1000;\r\n  const millisecondsInMinute = 60 * 1000;\r\n  const millisecondsInHour = 60 * 60 * 1000;\r\n\r\n  const diffMilliseconds = Math.abs(date1 - date2);\r\n\r\n  if (diffMilliseconds >= millisecondsInDay) {\r\n    const diffDays = Math.floor(diffMilliseconds / millisecondsInDay);\r\n    return diffDays + \" day(s)\";\r\n  } else {\r\n    if (diffMilliseconds >= millisecondsInHour) {\r\n      const diffHours = Math.floor(diffMilliseconds / millisecondsInHour);\r\n      return diffHours + \" hour(s)\";\r\n    }\r\n    const diffMinutes = Math.floor(diffMilliseconds / millisecondsInMinute);\r\n    return diffMinutes + \" minute(s)\";\r\n  }\r\n};\r\n\r\nconst formatStatus = (status) => {\r\n  switch (status) {\r\n    case \"VotingProcess\":\r\n      return \"IN PROGRESS\";\r\n    case \"Draft\":\r\n      return \"DRAFT\";\r\n    case \"Active\":\r\n      return \"ACTIVE\";\r\n    case \"Accepted\":\r\n      return \"SUCCEEDED\";\r\n    case \"Rejected\":\r\n      return \"REJECTED\";\r\n    case \"Canceled\":\r\n      return \"CANCELED\";\r\n  }\r\n};\r\n\r\nconst statusColor = (status) => {\r\n  return status === \"Accepted\" || status == \"Executed\"\r\n    ? \"#28a930\"\r\n    : status === \"VotingProcess\"\r\n    ? \"#58a1ff\"\r\n    : status === \"Rejected\" || status == \"Canceled\"\r\n    ? \"#dc3545\"\r\n    : \"#6c757d\";\r\n};\r\n\r\nconst getProposalState = (mpip_id) => {\r\n  const state = Near.view(contractId, \"get_proposal_state\", {\r\n    mpip_id,\r\n  });\r\n  // for MPIP #1, overwrite to Accepted\r\n  return formatStatus(mpip_id == 1 ? \"Accepted\" : state);\r\n};\r\n\r\nconst getProposalStateColor = (mpip_id) => {\r\n  const state = Near.view(contractId, \"get_proposal_state\", {\r\n    mpip_id,\r\n  });\r\n   // for MPIP #1, overwrite to Accepted\r\n  const color = statusColor(mpip_id == 1 ? \"Accepted\" : state);\r\n  console.log(\"COLOR\", color);\r\n  return color;\r\n};\r\n\r\nconst getProposalVotes = (mpip_id) => {\r\n  const proposalVotes = Near.view(contractId, \"get_proposal_votes\", {\r\n    mpip_id,\r\n  });\r\n  if (!proposalVotes.has_voted.length) return \"0\";\r\n  const voting_power = proposalVotes.has_voted.reduce(\r\n    (accumulator, vote) => accumulator + parseInt(vote.voting_power),\r\n    0\r\n  );\r\n  return yoctoToNear(voting_power);\r\n};\r\n\r\nconst getVotingTimeRemaining = (proposal) => {\r\n  if (proposal.vote_start_timestamp && proposal.vote_end_timestamp) {\r\n    const now = new Date().getTime();\r\n    if (now > Number(proposal.vote_end_timestamp)) {\r\n      return \"Voting has ended\";\r\n    }\r\n\r\n    const timeRemaining = calculateTimeDifference(\r\n      now,\r\n      Number(proposal.vote_end_timestamp)\r\n    );\r\n    return `Voting ends in ${timeRemaining}`;\r\n  }\r\n  return \"Voting has not started yet\";\r\n};\r\n\r\nconst Link = styled.a`\r\n  font-style: normal;\r\n  font-weight: 600;\r\n  font-size: 0.95em;\r\n  line-height: 1em;\r\n  text-align: center;\r\n  color: #66a0ff;\r\n  display: flex;\r\n  flex-direction: row;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 0.5em;\r\n\r\n  svg {\r\n    transition: transform 0.2s ease-in-out;\r\n  }\r\n\r\n  &:hover {\r\n    svg {\r\n      transform: translateX(5px) scale(1.1);\r\n    }\r\n  }\r\n`;\r\n\r\nconst Label = styled.span`\r\n  font-style: normal;\r\n  font-weight: 600;\r\n  font-size: 0.875rem;\r\n  line-height: 1em;\r\n  text-align: center;\r\n  color: #4a5568;\r\n  word-break: break-word \r\n  @media screen and (max-width: 768px) {\r\n    font-size: 0.7em;\r\n    line-height: 0.8em;\r\n  }\r\n`;\r\nconst Value = styled.span`\r\n  font-style: normal;\r\n  font-weight: 600;\r\n  font-size: 1rem;\r\n  line-height: 1em;\r\n  text-align: center;\r\n  color: ${(p) => (p.color ? p.color : \"#000\")};\r\n  word-break: break-word \r\n  @media screen and (max-width: 768px) {\r\n    font-size: 0.8em;\r\n    line-height: 0.8em;\r\n  }\r\n`;\r\n\r\nconst Cell = styled.div`\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: ${(p) => (p.end ? \"end\" : \"start\")} ;\r\n  align-items: ${(p) => (p.end ? \"end\" : \"start\")} ;\r\n  padding: 0.75em;\r\n  gap: 0.75em;\r\n`;\r\n\r\nconst Container = styled.div`\r\n  width: 100%;\r\n  margin-bottom: 2em;\r\n`;\r\nif (!proposals || proposals === null || proposals.length == 0) {\r\n  return (\r\n    <Container class=\"table-responsive\">\r\n      <table class=\"table table-striped\">\r\n        <tbody>No proposals created</tbody>\r\n      </table>\r\n    </Container>\r\n  );\r\n}\r\n\r\nreturn (\r\n  <Container class=\"table-responsive\">\r\n    <table class=\"table table-striped\">\r\n      <tbody>\r\n        {proposals.map((proposal) => (\r\n          <tr className=\"align-middle\">\r\n            <td class=\"text-start\">\r\n              <a\r\n                href={`/meta-pool-official.near/widget/ImprovementProposals?tab=proposal&mpip_id=${proposal.mpip_id}`}\r\n                onClick={() =>\r\n                  props.update({\r\n                    tab: \"proposal\",\r\n                    mpip_id,\r\n                  })\r\n                }\r\n              >\r\n                <Cell>\r\n                  <Label>\r\n                    {\" \"}\r\n                    Prop {proposal.mpip_id} - {proposal.title}\r\n                  </Label>\r\n                  <Value>{proposal.short_description}</Value>\r\n                </Cell>\r\n              </a>\r\n            </td>\r\n            <td class=\"text-end\">\r\n              <Cell end>\r\n                <Label>Status</Label>\r\n                <Value color={getProposalStateColor(proposal.mpip_id)}>\r\n                  {getProposalState(proposal.mpip_id)}\r\n                </Value>\r\n              </Cell>\r\n            </td>\r\n            <td class=\"text-end\">\r\n              <Cell end>\r\n                <Label>{getVotingTimeRemaining(proposal)}</Label>\r\n                <Value> {getProposalVotes(proposal.mpip_id)}VP</Value>\r\n              </Cell>\r\n            </td>\r\n          </tr>\r\n        ))}\r\n      </tbody>\r\n    </table>\r\n  </Container>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/meta-pool-official.near/widget/ImprovementProposals.ProposalsTable", "fact_widget_deployments_id": "570d24c680b514590a5dee09e2ba2c95", "inserted_timestamp": "2023-11-28T18:43:13.001Z", "modified_timestamp": "2023-11-28T18:43:13.001Z", "__row_index": 1}