{"tx_hash": "78Ppd5t3ERk1kwQc2CorgderCSnWwspUiV1ffutfZ9Uf", "action_id_social": "BSdhTk4XecwdC4JnH8yg6HT4ShfZP2ex587fwDuuCp5x-0-widget", "block_id": 99480939, "block_timestamp": "2023-08-23T15:03:51.884Z", "signer_id": "root.benjiman.near", "widget_name": "Keypom-Key-Data", "source_code": "console.log(\"Hello from node.js\");\n\nconst GRAPHQL_ENDPOINT = \"https://near-queryapi.api.pagoda.co\";\n\nconst paginationQuery = (offset, limit) => `\nquery MyQuery {\n  root_benjiman_near_all_keypom_key_additions_keys(\n    offset: ${offset}\n    limit: ${limit}\n    order_by: {block_timestamp: desc}\n  ) {\n    funder_id\n    receipt_id\n    block_height\n    block_timestamp\n    public_key\n  }\n}\n`;\n\nconst countQuery = `\nquery MyQuery {\n    root_benjiman_near_all_keypom_key_additions_keys_aggregate {\n      aggregate {\n        count\n      }\n    }\n  }\n`;\n\n//\nfunction getNumKeypomKeys() {\n  return fetch(`${GRAPHQL_ENDPOINT}/v1/graphql`, {\n    method: \"POST\",\n    headers: { \"x-hasura-role\": \"root_benjiman_near\" },\n    body: JSON.stringify({\n      query: countQuery,\n    }),\n  }).body.data.root_benjiman_near_all_keypom_key_additions_keys_aggregate\n    .aggregate.count;\n}\n\nfunction fetchKeypomKeyDataFromDb(offset, limit) {\n  console.log(`fetching offset: ${offset}, limit: ${limit}`);\n  let data = fetch(`${GRAPHQL_ENDPOINT}/v1/graphql`, {\n    method: \"POST\",\n    headers: { \"x-hasura-role\": \"root_benjiman_near\" },\n    body: JSON.stringify({\n      query: paginationQuery(offset, limit),\n    }),\n  });\n  return data.body.data.root_benjiman_near_all_keypom_key_additions_keys;\n}\n\nState.init({ keyData: [] });\n\nconst paginateKeys = (limit, keysPerQuery) => {\n  let keyData = [];\n  for (let i = 0; i < limit; i += keysPerQuery) {\n    let fetchedKeyData = fetchKeypomKeyDataFromDb(i, keysPerQuery);\n    console.log(\"fetchedKeyData: \", fetchedKeyData.length);\n\n    keyData = keyData.concat(fetchedKeyData);\n  }\n\n  return keyData;\n};\n// First get the number of keypom keys and then paginate 1000 at a time using fetch and .then instead of async await\nconst getKeyData = () => {\n  let numKeys = getNumKeypomKeys();\n  return paginateKeys(numKeys, 10000);\n};\n\nconst keyData = getKeyData();\n\nlet dataSet = {};\nlet totalNumberOfExperiences = 1;\nfor (var data of keyData) {\n  let date = new Date(0);\n  date.setUTCMilliseconds(data.block_timestamp / 1e6);\n  let dateForSet = date.toLocaleDateString();\n  console.log(\"dateForSet: \", dateForSet);\n  dataSet[dateForSet] = dataSet[dateForSet] || 0;\n  dataSet[dateForSet] = totalNumberOfExperiences;\n\n  totalNumberOfExperiences += 1;\n}\n\n//return <div>{JSON.stringify(data)}</div>;\nconst colsToShow = [\"Experiences\"];\nconst definition = {\n  title: {\n    text: \"Keypom Experiences Created Over Time\",\n    subtext: `Executed by the Keypom core team`,\n  },\n  tooltip: {\n    trigger: \"axis\",\n  },\n  legend: {\n    data: colsToShow,\n    top: \"50\",\n  },\n  grid: {\n    left: \"3%\",\n    right: \"4%\",\n    bottom: \"3%\",\n    top: \"100\",\n    containLabel: true,\n  },\n  toolbox: {\n    feature: {\n      saveAsImage: {},\n    },\n  },\n  xAxis: {\n    type: \"category\",\n    boundaryGap: false,\n    data: Object.keys(dataSet),\n  },\n  yAxis: {\n    type: \"value\",\n  },\n  series: colsToShow.map((col) => ({\n    name: col,\n    type: \"line\",\n    data: Object.values(dataSet),\n  })),\n};\n\nreturn (\n  <div>\n    <Widget src={`nearpavel.near/widget/EChart`} props={{ definition }} />\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/root.benjiman.near/widget/Keypom-Key-Data", "fact_widget_deployments_id": "bfbcf40151576eade5d7d36e48c27cec", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 1}