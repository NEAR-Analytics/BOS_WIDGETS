{"tx_hash": "6oW1u3F6rnFrrEwMSvryvPs5X4yhcSrFDCEeUVHJswfe", "action_id_social": "GEVwU6DKNeVjZUyK97hqm4GiNvgDGY5JBQndRzXBGK8z-0-widget", "block_id": 116350384, "block_timestamp": "2024-04-07T22:42:24.921Z", "signer_id": "geforcy.near", "widget_name": "devhub.components.organism.Feed", "source_code": "const { Feed } = VM.require(\"devs.near/widget/Feed\");\nFeed = Feed || (() => <></>);\nconst setPostExists = props.setPostExists ?? (() => {});\nconst showFlagAccountFeature = props.showFlagAccountFeature ?? false;\n\nconst filteredAccountIds = props.filteredAccountIds ?? [];\n\nconst GRAPHQL_ENDPOINT =\n  props.GRAPHQL_ENDPOINT ?? \"https://near-queryapi.api.pagoda.co\";\n\nlet lastPostSocialApi = Social.index(\"post\", \"main\", {\n  limit: 1,\n  order: props.sort ? props.sort : \"desc\",\n});\n\nif (lastPostSocialApi == null) {\n  return \"Loading...\";\n}\n\nState.init({\n  // If QueryAPI Feed is lagging behind Social API, fallback to old widget.\n  shouldFallback: false,\n});\n\nfunction fetchGraphQL(operationsDoc, operationName, variables) {\n  return asyncFetch(`${GRAPHQL_ENDPOINT}/v1/graphql`, {\n    method: \"POST\",\n    headers: { \"x-hasura-role\": \"dataplatform_near\" },\n    body: JSON.stringify({\n      query: operationsDoc,\n      variables: variables,\n      operationName: operationName,\n    }),\n  });\n}\n\nconst lastPostQuery = `\nquery IndexerQuery {\n  dataplatform_near_social_feed_posts( limit: 1, order_by: { block_height: desc }) {\n      block_height\n  }\n}\n`;\n\nfetchGraphQL(lastPostQuery, \"IndexerQuery\", {})\n  .then((feedIndexerResponse) => {\n    if (\n      feedIndexerResponse &&\n      feedIndexerResponse.body.data.dataplatform_near_social_feed_posts.length >\n        0\n    ) {\n      const nearSocialBlockHeight = lastPostSocialApi[0].blockHeight;\n      const feedIndexerBlockHeight =\n        feedIndexerResponse.body.data.dataplatform_near_social_feed_posts[0]\n          .block_height;\n\n      const lag = nearSocialBlockHeight - feedIndexerBlockHeight;\n      let shouldFallback = lag > 2 || !feedIndexerBlockHeight;\n      if (shouldFallback === true) {\n        console.log(\n          \"Falling back to Social index feed. Block difference is: \",\n          nearSocialBlockHeight - feedIndexerBlockHeight\n        );\n        State.update({ shouldFallback });\n      }\n    } else {\n      console.log(\n        \"Falling back to Social index feed. No QueryApi data received.\"\n      );\n      State.update({ shouldFallback: true });\n    }\n  })\n  .catch((error) => {\n    console.log(\n      \"Error while fetching QueryApi feed (falling back to index feed): \",\n      error\n    );\n    State.update({ shouldFallback: true });\n  });\n\nreturn (\n  <div>\n    {state.shouldFallback ? (\n      <Feed\n        index={[\n          {\n            action: props.action ? props.action : \"post\",\n            key: \"main\",\n            options: {\n              limit: 10,\n              subscribe: props.onNewUnseenPosts ? true : false,\n              order: props.sort ? props.sort : \"desc\",\n              accountId: filteredAccountIds,\n            },\n            cacheOptions: {\n              ignoreCache: true,\n            },\n          },\n        ]}\n        Item={(item) => {\n          setPostExists(true);\n\n          return (\n            <Widget\n              src=\"near/widget/v1.Posts.Post\"\n              loading={<div className=\"w-100\" style={{ height: \"200px\" }} />}\n              props={{\n                accountId: item.accountId,\n                blockHeight: item.blockHeight,\n                filteredAccountIds: filteredAccountIds,\n              }}\n            />\n          );\n        }}\n      />\n    ) : (\n      <Widget\n        src={`geforcy.near/widget/devhub.components.organism.Feed.NearQueryApi`}\n        props={{\n          GRAPHQL_ENDPOINT,\n          showFlagAccountFeature: true,\n          filteredAccountIds: filteredAccountIds,\n          setPostExists: setPostExists,\n          showFlagAccountFeature: showFlagAccountFeature,\n          onNewUnseenPosts: props.onNewUnseenPosts,\n          sort: props.sort,\n        }}\n      />\n    )}\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/geforcy.near/widget/devhub.components.organism.Feed", "fact_widget_deployments_id": "e2028b3e7e88c27c38aabd91eca080f0", "inserted_timestamp": "2024-04-08T00:45:59.861Z", "modified_timestamp": "2024-04-08T00:45:59.861Z", "__row_index": 25}