{"tx_hash": "GxwzEMHQNRAimgRz8uDJGM43jkS7XmtfLZhVoLALVtY6", "action_id_social": "7Rxokz6B83EBaX5TXQmK6A6EXuEyZw2UgRYmxDuoXARZ-0-widget", "block_id": 98078076, "block_timestamp": "2023-08-04T19:23:00.991Z", "signer_id": "f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb", "widget_name": "sayALot.generalHandler", "source_code": "//===============================================INITIALIZATION=====================================================\r\nlet { sharedBlockHeight, tagShared, isTest, accountId } = props;\r\n\r\nif (!accountId) accountId = context.accountId;\r\n\r\nconst tabs = {\r\n  SHOW_ARTICLES_LIST: { id: 0 },\r\n  SHOW_ARTICLE: { id: 1 },\r\n  ARTICLE_WORKSHOP: { id: 2 },\r\n};\r\n\r\nState.init({\r\n  displayedTabId: tabs.SHOW_ARTICLES_LIST.id,\r\n  articleToRenderData: {},\r\n  filterBy: tagShared\r\n    ? { parameterName: \"tag\", parameterValue: tagShared }\r\n    : { parameterName: \"\" },\r\n  authorsProfiles: [],\r\n});\r\n\r\n//=============================================END INITIALIZATION===================================================\r\n\r\n//==================================================CONSTS==========================================================\r\n\r\n//const authorForWidget = \"sayalot.near\";\r\nconst authorForWidget =\r\n  \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\";\r\nconst thisWidgetName = \"sayALot.generalHandler\";\r\n\r\nlet writersWhiteList = [\r\n  \"neardigitalcollective.near\",\r\n  \"blaze.near\",\r\n  \"jlw.near\",\r\n  \"kazanderdad.near\",\r\n  \"joep.near\",\r\n  \"sarahkornfeld.near\",\r\n  \"yuensid.near\",\r\n  \"shubham007.near\",\r\n  \"fiftycent.near\",\r\n  \"ozymandius.near\",\r\n  \"chloe.near\",\r\n];\r\n\r\nconst sayALotWorkers = [\r\n  \"silkking.near\",\r\n  \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n  \"blaze.near\",\r\n  \"ayelen.near\",\r\n  \"kenrou-it.near\",\r\n];\r\n\r\nif (isTest) {\r\n  writersWhiteList = sayALotWorkers;\r\n}\r\n\r\nconst widgets = {\r\n  thisWidget: `${authorForWidget}/widget/${thisWidgetName}`,\r\n  create: `${authorForWidget}/widget/NDC.Create`,\r\n  styledComponents: \"rubycop.near/widget/NDC.StyledComponents\",\r\n  header: `${authorForWidget}/widget/NDC.NavBar`,\r\n  showArticlesList: `${authorForWidget}/widget/SayALot.AllArticlesList`,\r\n  generalCard: `f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb/widget/NDC.GeneralCard`,\r\n  oneArticle: `${authorForWidget}/widget/NDC.General.ArticleView`,\r\n  reactions: \"sayalot.near/widget/SayALot_Reactions\",\r\n  addComment: \"rubycop.near/widget/NDC.Nomination.AddComment\",\r\n  candidatePage: \"#/rubycop.near/widget/NDC.Nomination.Candidate.Page\",\r\n};\r\n\r\nconst profile = props.profile ?? Social.getr(`${accountId}/profile`);\r\nif (profile === null) {\r\n  return \"Loading\";\r\n}\r\n\r\nlet authorProfile = {};\r\nif (state.filterBy.parameterName == \"author\") {\r\n  authorProfile = Social.getr(`${state.filterBy.parameterValue}/profile`);\r\n  if (!authorProfile) return \"Loading...\";\r\n}\r\n\r\nconst brand = {\r\n  homePageId: tabs.SHOW_ARTICLES_LIST.id,\r\n  brandName: \"Say a lot\",\r\n  logoHref:\r\n    \"https://ipfs.near.social/ipfs/bafkreiaqxa4st4vp4rtq2iyobdgqe5tpfg55mmyvfg25upd2qplcxylyfi\",\r\n  logoRemWidth: 6,\r\n  logoRemHeight: 6,\r\n};\r\n\r\nconst navigationPills = [\r\n  { id: tabs.SHOW_ARTICLES_LIST.id, title: \"Articles\" },\r\n  { id: tabs.SHOW_ARTICLES_LIST.id, title: \"Authors\" },\r\n];\r\n\r\nconst navigationButtons = [\r\n  { id: tabs.ARTICLE_WORKSHOP.id, title: \"+Create article\" },\r\n];\r\n\r\nconst initialBody = `# h1 Heading 8-) \r\n## h2 Heading \r\n### h3 Heading \r\n#### h4 Heading \r\n##### h5 Heading \r\n###### h6 Heading \r\n \r\n \r\n## Horizontal Rules \r\n \r\n___ \r\n \r\n--- \r\n \r\n*** \r\n \r\n \r\n## Typographic replacements \r\n \r\nEnable typographer option to see result. \r\n \r\n(c) (C) (r) (R) (tm) (TM) (p) (P) +- \r\n \r\ntest.. test... test..... test?..... test!.... \r\n \r\n!!!!!! ???? ,,  -- --- \r\n \r\n\"Smartypants, double quotes\" and 'single quotes' \r\n \r\n \r\n## Emphasis \r\n \r\nThis is bold text \r\n \r\nThis is bold text \r\n \r\n*This is italic text* \r\n \r\n_This is italic text_ \r\n \r\nStrikethrough \r\n \r\n \r\n## Blockquotes \r\n \r\n \r\n> Blockquotes can also be nested... \r\n>> ...by using additional greater-than signs right next to each other... \r\n> > > ...or with spaces between arrows. \r\n \r\n \r\n## Lists \r\n \r\nUnordered \r\n \r\n+ Create a list by starting a line with \\`+\\`, \\`-\\`, or \\`*\\` \r\n+ Sub-lists are made by indenting 2 spaces: \r\n  - Marker character change forces new list start: \r\n    * Ac tristique libero volutpat at \r\n    + Facilisis in pretium nisl aliquet \r\n    - Nulla volutpat aliquam velit \r\n+ Very easy! \r\n \r\nOrdered \r\n \r\n1. Lorem ipsum dolor sit amet \r\n2. Consectetur adipiscing elit \r\n3. Integer molestie lorem at massa \r\n \r\n \r\n1. You can use sequential numbers... \r\n1. ...or keep all the numbers as \\`1.\\` \r\n \r\nStart numbering with offset: \r\n \r\n57. foo \r\n1. bar \r\n \r\n \r\n## Code \r\n \r\nInline \\`code\\` \r\n \r\nIndented code \r\n \r\n    // Some comments \r\n    line 1 of code \r\n    line 2 of code \r\n    line 3 of code \r\n \r\n \r\nBlock code \"fences\" \r\n \r\n\\`\\`\\` \r\nSample text here... \r\n\\`\\`\\` \r\n \r\nSyntax highlighting \r\n \r\n\\`\\`\\` js \r\nvar foo = function (bar) { \r\n  return bar++; \r\n}; \r\n \r\nconsole.log(foo(5)); \r\n\\`\\`\\` \r\n \r\n## Tables \r\n \r\n| Option | Description | \r\n| ------ | ----------- | \r\n| data   | path to data files to supply the data that will be passed into templates. | \r\n| engine | engine to be used for processing templates. Handlebars is the default. | \r\n| ext    | extension to be used for dest files. | \r\n \r\nRight aligned columns \r\n \r\n| Option | Description | \r\n| ------:| -----------:| \r\n| data   | path to data files to supply the data that will be passed into templates. | \r\n| engine | engine to be used for processing templates. Handlebars is the default. | \r\n| ext    | extension to be used for dest files. | \r\n \r\n \r\n## Links \r\n \r\nlink text \r\n \r\nlink with title \r\n \r\nAutoconverted link https://github.com/nodeca/pica (enable linkify to see) \r\n \r\n \r\n## Images \r\n \r\n!Minion \r\n!Stormtroopocat \r\n \r\nLike links, Images also have a footnote style syntax \r\n \r\n![Alt text][id] \r\n \r\nWith a reference later in the document defining the URL location: \r\n \r\n[id]: https://octodex.github.com/images/dojocat.jpg  \"The Dojocat\" \r\n \r\n### Emojies \r\n \r\n> Classic markup: :wink: :crush: :cry: :tear: :laughing: :yum: \r\n> \r\n> Shortcuts (emoticons): :-) :-( 8-) ;) \r\n \r\nsee how to change output with twemoji. \r\n \r\n \r\n### Subscript / Superscript \r\n \r\n- 19^th^ \r\n- H~2~O \r\n \r\n \r\n### \\<ins> \r\n \r\n++Inserted text++ \r\n \r\n \r\n### \\<mark> \r\n \r\n==Marked text== \r\n \r\n \r\n### Footnotes \r\n \r\nFootnote 1 link[^first]. \r\n \r\nFootnote 2 link[^second]. \r\n \r\nInline footnote^[Text of inline footnote] definition. \r\n \r\nDuplicated footnote reference[^second]. \r\n \r\n[^first]: Footnote can have markup \r\n \r\n    and multiple paragraphs. \r\n \r\n[^second]: Footnote text. \r\n \r\n \r\n### [Definition lists](https://github.com/markdown-it/markdown-it-deflist) \r\n \r\nTerm 1 \r\n \r\n:   Definition 1 \r\nwith lazy continuation. \r\n \r\nTerm 2 with *inline markup* \r\n \r\n:   Definition 2 \r\n \r\n        { some code, part of Definition 2 } \r\n \r\n    Third paragraph of definition 2. \r\n \r\n_Compact style:_ \r\n \r\nTerm 1 \r\n  ~ Definition 1 \r\n \r\nTerm 2 \r\n  ~ Definition 2a \r\n  ~ Definition 2b \r\n`;\r\n\r\nconst initialCreateState = {\r\n  articleId: \"\",\r\n  articleBody: initialBody,\r\n  tags: {},\r\n  saveComplete: false,\r\n};\r\n\r\n//=================================================END CONSTS=======================================================\r\n\r\n//=================================================GET DATA=========================================================\r\nconst addressForArticles = isTest ? \"test_sayALotArticle\" : \"sayALotArticle\";\r\nconst articleBlackList = [91092435, 91092174, 91051228, 91092223, 91051203];\r\n\r\nfunction getLastEditionsByArticle() {\r\n  const allArticles = Social.index(addressForArticles, \"main\", {\r\n    order: \"desc\",\r\n    accountId:\r\n      state.filterBy.parameterName == \"author\" && state.filterBy.parameterValue,\r\n  });\r\n\r\n  const oldFormatArticlesTestBasicDataArray = [\r\n    [\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      97325392,\r\n    ],\r\n    [\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      97317287,\r\n    ],\r\n    [\"ayelen.near\", 96927579],\r\n    [\"kenrou-it.near\", 96924422],\r\n    [\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      96879470,\r\n    ],\r\n    [\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      96878182,\r\n    ],\r\n    [\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      96643643,\r\n    ],\r\n    [\"silkking.near\", 96491128],\r\n  ];\r\n\r\n  const oldFormatArticlesMainBasicDataArray = [\r\n    [\"ozymandius.near\", 97329049],\r\n    [\"fiftycent.near\", 97322138],\r\n    [\"blaze.near\", 97255023],\r\n    [\"jlw.near\", 97250015],\r\n    [\"kazanderdad.near\", 96692435],\r\n    [\"blaze.near\", 96414482],\r\n    [\"blaze.near\", 96412953],\r\n    [\"sarahkornfeld.near\", 96402919],\r\n    [\"sarahkornfeld.near\", 96402476],\r\n    [\"sarahkornfeld.near\", 96402330],\r\n    [\"sarahkornfeld.near\", 96401880],\r\n    [\"ozymandius.near\", 95810612],\r\n    [\"blaze.near\", 95766756],\r\n    [\"blaze.near\", 95766700],\r\n    [\"jlw.near\", 95705034],\r\n    [\"blaze.near\", 95413943],\r\n    [\"blaze.near\", 94936576],\r\n    [\"yuensid.near\", 94866690],\r\n    [\"sarahkornfeld.near\", 94863580],\r\n    [\"blaze.near\", 94801223],\r\n    [\"sarahkornfeld.near\", 94344236],\r\n    [\"sarahkornfeld.near\", 94188387],\r\n    [\"jlw.near\", 93986868],\r\n    [\"blaze.near\", 92999498],\r\n  ];\r\n\r\n  const oldFormatArticlesBasicDataArray = isTest\r\n    ? oldFormatArticlesTestBasicDataArray\r\n    : oldFormatArticlesMainBasicDataArray;\r\n\r\n  if (state.filterBy.parameterName == \"author\") {\r\n    oldFormatArticlesBasicDataArray = oldFormatArticlesBasicDataArray.filter(\r\n      (articleBasicData) =>\r\n        articleBasicData[0] === state.filterBy.parameterValue\r\n    );\r\n  }\r\n\r\n  let oldFormatArticlesArray = oldFormatArticlesBasicDataArray.map(\r\n    (oldFormatBasicArticleData) => {\r\n      let article = Social.get(\r\n        `${oldFormatBasicArticleData[0]}/${addressForArticles}/main`,\r\n        oldFormatBasicArticleData[1]\r\n      );\r\n\r\n      let articleParsed = undefined;\r\n      if (article) {\r\n        articleParsed = JSON.parse(article);\r\n        articleParsed.blockHeight = oldFormatBasicArticleData[1];\r\n      }\r\n\r\n      return articleParsed;\r\n    }\r\n  );\r\n\r\n  let newFormatArticlesData = allArticles\r\n    .filter((articleIndex) => articleIndex.value.id)\r\n    .filter(\r\n      (articleIndex) =>\r\n        articleIndex.value.id.split(\"-\")[0] === articleIndex.accountId\r\n    )\r\n    .filter((articleIndex) => writersWhiteList.includes(articleIndex.accountId))\r\n    .filter(\r\n      (articleIndex) => !articleBlackList.includes(articleIndex.blockHeight)\r\n    );\r\n\r\n  let lastestEditArticlesDataArray = newFormatArticlesData.filter(\r\n    (articleData) => {\r\n      const latestEditForThisArticle = newFormatArticlesData.find(\r\n        (newArticleData) => newArticleData.value.id === articleData.value.id\r\n      );\r\n      return (\r\n        JSON.stringify(articleData) === JSON.stringify(latestEditForThisArticle)\r\n      );\r\n    }\r\n  );\r\n\r\n  let finalNewFormatArticles = lastestEditArticlesDataArray.map(\r\n    (latestEditArticle) => {\r\n      const article = Social.get(\r\n        `${latestEditArticle.accountId}/${addressForArticles}/main`,\r\n        latestEditArticle.blockHeight\r\n      );\r\n\r\n      let articleParsed = undefined;\r\n      if (article) {\r\n        articleParsed = JSON.parse(article);\r\n        articleParsed.blockHeight = latestEditArticle.blockHeight;\r\n        articleParsed.realArticleId = latestEditArticle.value.articleId;\r\n      }\r\n\r\n      return articleParsed;\r\n    }\r\n  );\r\n\r\n  let finalOldFormatArticles = oldFormatArticlesArray.filter(\r\n    (oldFormatArticle) => {\r\n      return !finalNewFormatArticles.find(\r\n        (newFormatArticle) =>\r\n          newFormatArticle.articleId === oldFormatArticle.articleId\r\n      );\r\n    }\r\n  );\r\n\r\n  let finalArticlesWithoutUsersFilters = finalNewFormatArticles.concat(\r\n    finalOldFormatArticles\r\n  );\r\n\r\n  let finalArticles = finalArticlesWithoutUsersFilters.filter((article) => {\r\n    return article.tags.includes(state.filterBy.parameterValue);\r\n  });\r\n\r\n  return state.filterBy.parameterName == \"tag\"\r\n    ? finalArticles\r\n    : finalArticlesWithoutUsersFilters;\r\n}\r\n\r\nconst finalArticles = getLastEditionsByArticle() ?? [];\r\n\r\nif (\r\n  state.renderLastOfThisAccountId &&\r\n  state.renderLastOfThisAccountId.length > 0\r\n) {\r\n  const renderLastOfThisAccountId = state.renderLastOfThisAccountId;\r\n  State.update({\r\n    renderLastOfThisAccountId: \"\",\r\n    articleToRenderData: finalArticles.find(\r\n      (article) => article.author == renderLastOfThisAccountId\r\n    ),\r\n  });\r\n}\r\n//===============================================END GET DATA=======================================================\r\n\r\n//=================================================FUNCTIONS========================================================\r\n//==Post creation funtcions\r\nconst getCreateData = (articleId, accountId, articleBody, tagsArray) => {\r\n  const args = {\r\n    articleId: articleId,\r\n    author: accountId,\r\n    lastEditor: accountId,\r\n    timeLastEdit: Date.now(),\r\n    timeCreate: Date.now(),\r\n    body: articleBody,\r\n    version: 0,\r\n    navigation_id: null,\r\n    tags: tagsArray,\r\n  };\r\n  return args;\r\n};\r\n\r\nconst composeData = (articleId, accountId, articleBody, tagsArray) => {\r\n  let data;\r\n  if (isTest) {\r\n    data = {\r\n      test_sayALotArticle: {\r\n        main: JSON.stringify(\r\n          getCreateData(articleId, accountId, articleBody, tagsArray)\r\n        ),\r\n      },\r\n      index: {\r\n        test_sayALotArticle: JSON.stringify({\r\n          key: \"main\",\r\n          value: {\r\n            type: \"md\",\r\n            id: `${context.accountId}-${Date.now()}`,\r\n          },\r\n        }),\r\n      },\r\n    };\r\n  } else {\r\n    data = {\r\n      sayALotArticle: {\r\n        main: JSON.stringify(getArticleData()),\r\n      },\r\n      index: {\r\n        sayALotArticle: JSON.stringify({\r\n          key: \"main\",\r\n          value: {\r\n            type: \"md\",\r\n            id: `${context.accountId}-${Date.now()}`,\r\n          },\r\n        }),\r\n      },\r\n    };\r\n  }\r\n\r\n  if (tagsArray.length) {\r\n    data.index.tag = JSON.stringify(\r\n      tagsArray.map((tag) => ({\r\n        key: tag,\r\n        value: item,\r\n      }))\r\n    );\r\n  }\r\n\r\n  return data;\r\n};\r\n\r\nconst createHandler = (e, articleId, accountId, articleBody, tagsArray) => {\r\n  State.update({\r\n    createErrorId: \"\",\r\n    createErrorBody: \"\",\r\n  });\r\n  if (state.articleId && state.articleBody) {\r\n    // TODO check it automaticle\r\n    const isArticleIdDublicated = false;\r\n\r\n    if (!isArticleIdDublicated) {\r\n      const newData = composeData(articleId, accountId, articleBody, tagsArray);\r\n\r\n      State.update({ createIsSaving: true });\r\n\r\n      Social.set(newData, {\r\n        force: true,\r\n        onCommit: () => {\r\n          State.update({\r\n            createIsSaving: false,\r\n            displayedTabId: tabs.SHOW_ARTICLE.id,\r\n            renderLastOfThisAccountId: accountId,\r\n          });\r\n        },\r\n        onCancel: () => {\r\n          State.update({ createIsSaving: false });\r\n        },\r\n      });\r\n    } else {\r\n      State.update({\r\n        createErrorId: errTextDublicatedId,\r\n      });\r\n    }\r\n  } else {\r\n    if (!articleId || articleId == \"\") {\r\n      State.update({\r\n        createErrorId: errTextNoId,\r\n      });\r\n    }\r\n    if (!articleBody || articleBody == \"\") {\r\n      State.update({ createErrorBody: errTextNoBody });\r\n    }\r\n  }\r\n};\r\n\r\n//==End post creation functions\r\n\r\nfunction stateUpdate(obj) {\r\n  State.update(obj);\r\n}\r\n\r\nfunction handleOpenArticle(articleToRenderData) {\r\n  State.update({\r\n    displayedTabId: tabs.SHOW_ARTICLE.id,\r\n    articleToRenderData,\r\n  });\r\n}\r\n\r\nfunction handleFilterArticles(filter) {\r\n  State.update({\r\n    displayedTabId: tabs.SHOW_ARTICLES_LIST.id,\r\n    filterBy: { parameterName: filter.filterBy, parameterValue: filter.value },\r\n  });\r\n}\r\n\r\nfunction handleBackButton() {\r\n  State.update({\r\n    displayedTabId: tabs.SHOW_ARTICLES_LIST.id,\r\n    articleToRenderData: {},\r\n  });\r\n}\r\n\r\nfunction handleGoHomeButton() {\r\n  State.update({\r\n    displayedTabId: tabs.SHOW_ARTICLES_LIST.id,\r\n    articleToRenderData: {},\r\n    filterBy: { parameterName: \"\", parameterValue: {} },\r\n  });\r\n}\r\n\r\nfunction handleArticlesListNavigation(filterBy) {\r\n  () => stateUpdate({ displayedTabId: brand.homePageId, listBy: filterBy });\r\n}\r\n\r\n//===============================================END FUNCTIONS======================================================\r\nreturn (\r\n  <>\r\n    <Widget\r\n      src={widgets.header}\r\n      props={{\r\n        isTest,\r\n        stateUpdate,\r\n        handleGoHomeButton,\r\n        handleArticlesListNavigation,\r\n        brand,\r\n        pills: navigationPills,\r\n        navigationButtons,\r\n        displayedTabId: state.displayedTabId,\r\n        writersWhiteList,\r\n        handleFilterArticles,\r\n      }}\r\n    />\r\n    {state.displayedTabId == tabs.SHOW_ARTICLES_LIST.id && (\r\n      <Widget\r\n        src={widgets.showArticlesList}\r\n        props={{\r\n          isTest,\r\n          finalArticles,\r\n          tabs,\r\n          widgets,\r\n          addressForArticles,\r\n          handleOpenArticle,\r\n          handleFilterArticles,\r\n          authorForWidget,\r\n        }}\r\n      />\r\n    )}\r\n    {state.displayedTabId == tabs.SHOW_ARTICLE.id && (\r\n      <Widget\r\n        src={widgets.oneArticle}\r\n        props={{\r\n          isTest,\r\n          widgets,\r\n          handleBackButton,\r\n          handleFilterArticles,\r\n          articleToRenderData: state.articleToRenderData,\r\n          authorForWidget,\r\n        }}\r\n      />\r\n    )}\r\n\r\n    {state.displayedTabId == tabs.ARTICLE_WORKSHOP.id && (\r\n      <Widget\r\n        src={widgets.create}\r\n        props={{\r\n          isTest,\r\n          addressForArticles,\r\n          authorForWidget,\r\n          initialCreateState,\r\n          createHandler,\r\n          createIsSaving: state.createIsSaving,\r\n          createErrorId: createErrorId,\r\n          createErrorBody: createErrorBody,\r\n        }}\r\n      />\r\n    )}\r\n  </>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb/widget/sayALot.generalHandler", "fact_widget_deployments_id": "f0d9b57e4e68358747a404bd3b701603", "inserted_timestamp": "2023-08-04T21:24:25.360Z", "modified_timestamp": "2023-08-04T21:24:25.360Z", "__row_index": 52}