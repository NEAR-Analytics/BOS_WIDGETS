{"tx_hash": "AKg6Lkmro7BpZeZ8qQzfMoKy5kJP8bzMQevK2zPptfiS", "action_id_social": "SKXoBEQGCRQLrsFMHki6xosavDjycPqfRqQMfqXdnLm-0-widget", "block_id": 104708293, "block_timestamp": "2023-11-01T19:14:02.256Z", "signer_id": "f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb", "widget_name": "CommunityVoice", "source_code": "// Community Voice\n\n//===============================================INITIALIZATION=====================================================\nlet { sharedBlockHeight, tagShared, isTest, accountId } = props;\nsharedBlockHeight = Number(sharedBlockHeight);\n\nconst sbtWhiteList = [\n  \"fractal.i-am-human.near - class 1\",\n  \"community.i-am-human.near - class 1\",\n  \"community.i-am-human.near - class 2\",\n  \"community.i-am-human.near - class 3\",\n  \"public\",\n];\n\nconst initSbtsNames = [sbtWhiteList[0]];\n\nconst sbtsNames = state.sbt;\n\nconst initLibsCalls = {\n  article: [\n    {\n      functionName: \"getArticles\",\n      key: \"articles\",\n      props: {\n        env: isTest ? \"test\" : \"prod\",\n        sbtsNames: sbtWhiteList,\n      },\n    },\n    {\n      functionName: \"canUserCreateArticle\",\n      key: \"canLoggedUserCreateArticle\",\n      props: {\n        accountId: context.accountId,\n        sbtsNames: sbtWhiteList,\n      },\n    },\n  ],\n};\n\naccountId = context.accountId;\n\nconst tabs = {\n  SHOW_ARTICLES_LIST: { id: 0 },\n  SHOW_ARTICLE: { id: 1 },\n  ARTICLE_WORKSHOP: { id: 2 },\n  SHOW_ARTICLES_LIST_BY_AUTHORS: { id: 3 },\n};\n\nfunction getInitialFilter() {\n  if (sharedBlockHeight) {\n    return {\n      parameterName: \"getPost\",\n      parameterValue: sharedBlockHeight,\n    };\n  } else if (tagShared) {\n    return {\n      parameterName: \"tag\",\n      parameterValue: tagShared,\n    };\n  } else if (authorShared) {\n    return {\n      parameterName: \"author\",\n      parameterValue: authorShared,\n    };\n  } else {\n    return {\n      parameterName: \"\",\n    };\n  }\n}\n\nfunction getInitialTabId() {\n  if (sharedBlockHeight) {\n    return tabs.SHOW_ARTICLE.id;\n  } else {\n    return tabs.SHOW_ARTICLES_LIST.id;\n  }\n}\n\nState.init({\n  displayedTabId: getInitialTabId(),\n  articleToRenderData: {},\n  filterBy: getInitialFilter(),\n  authorsProfiles: [],\n  functionsToCallByLibrary: initLibsCalls,\n  sbtsNames: initSbtsNames,\n  sbts: initSbtsNames,\n  firstRender: sharedBlockHeight,\n});\n\nlet newLibsCalls = state.functionsToCallByLibrary;\n\nState.update({ libsCalls: newLibsCalls });\n\n//=============================================END INITIALIZATION===================================================\n\n//==================================================CONSTS==========================================================\n\n// const authorForWidget = \"sayalot.near\";\nconst authorForWidget =\n  \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\";\n// const authorForWidget = \"kenrou-it.near\";\n// const authorForWidget = \"silkking.near\";\n\nconst thisWidgetName = \"CommunityVoice\";\n\nconst widgets = {\n  communityVoice: `${authorForWidget}/widget/${thisWidgetName}`,\n  create: `${authorForWidget}/widget/CommunityVoice.Create`,\n  header: `${authorForWidget}/widget/SayALot.NavBar`,\n  showArticlesList: `${authorForWidget}/widget/CommunityVoice.AllArticlesList`,\n  showArticlesListSortedByAuthors: `${authorForWidget}/widget/SayALot.AllArticlesSortByAuthors`,\n  articlesByAuthorCard: `${authorForWidget}/widget/SayALot.ArticlesByAuthorCard`,\n  generalCard: `${authorForWidget}/widget/CommunityVoice.GeneralCard`,\n  articleView: `${authorForWidget}/widget/CommunityVoice.ArticleView`,\n  reactions: `${authorForWidget}/widget/CommunityVoice.Reactions`,\n  addComment: `${authorForWidget}/widget/CommunityVoice.AddComment`,\n  commentView: `${authorForWidget}/widget/SayALot.CommentView`,\n  libSBT: `${authorForWidget}/widget/lib.SBT`,\n  libComment: `${authorForWidget}/widget/lib.comment`,\n  libArticle: `${authorForWidget}/widget/lib.article`,\n  libEmojis: `${authorForWidget}/widget/lib.emojis`,\n  libUpVotes: `${authorForWidget}/widget/lib.upVotes`,\n  upVoteButton: `${authorForWidget}/widget/CommunityVoice.UpVoteButton`,\n  styledComponents: \"rubycop.near/widget/NDC.StyledComponents\",\n  newStyledComponents: {\n    Element: {\n      Badge: \"nearui.near/widget/Element.Badge\",\n      User: \"nearui.near/widget/Element.User\",\n    },\n    Feedback: {\n      Spinner: \"nearui.near/widget/Feedback.Spinner\",\n    },\n    Input: {\n      Button: \"nearui.near/widget/Input.Button\",\n      Checkbox: \"nearui.near/widget/Input.Checkbox\",\n      Select: \"nearui.near/widget/Input.Select\",\n    },\n  },\n};\n\nconst libSrcArray = [widgets.libArticle];\n\nconst profile = props.profile ?? Social.getr(`${accountId}/profile`);\nif (profile === null) {\n  return \"Loading\";\n}\n\nlet authorProfile = {};\nif (state.filterBy.parameterName == \"author\") {\n  authorProfile = Social.getr(`${state.filterBy.parameterValue}/profile`);\n}\n\nconst brand = {\n  homePageId: tabs.SHOW_ARTICLES_LIST.id,\n  brandName: \"Community Voice\",\n  logoHref:\n    \"https://ipfs.near.social/ipfs/bafkreifhkslni6dlocxya35vjft3fefk2am5uzkagmjjzobdjqlhrnbjz4\",\n  logoRemWidth: 12,\n  logoRemHeight: 4,\n};\n\nconst navigationPills = [\n  { id: tabs.SHOW_ARTICLES_LIST.id, title: \"Articles\" },\n  { id: tabs.SHOW_ARTICLES_LIST_BY_AUTHORS.id, title: \"Authors\" },\n];\n\nconst navigationButtons = [\n  // { id: tabs.ARTICLE_WORKSHOP.id, title: \"+Create article\" },\n];\n\nconst sbts = state.sbts;\n\nconst initialBodyAtCreation = state.editArticleData.body;\nconst canLoggedUserCreateArticle = state.canLoggedUserCreateArticle[sbts[0]];\n\n//=================================================END CONSTS=======================================================\n\n//=================================================GET DATA=========================================================\nconst finalArticles = state.articles;\n\nfunction getArticlesToRender() {\n  if (sharedBlockHeight && finalArticles && state.firstRender) {\n    let finalArticlesSbts = Object.keys(finalArticles);\n    let allArticles = [];\n\n    finalArticlesSbts.forEach((sbt) => {\n      allArticles = [...allArticles, ...finalArticles[sbt]];\n    });\n\n    return allArticles;\n  } else {\n    return finalArticles[sbts[0]];\n  }\n}\n\nconst articlesToRender = getArticlesToRender() ?? [];\n\nfunction filterArticlesByTag(tag, articles) {\n  return articles.filter((article) => {\n    return article.tags.includes(tag);\n  });\n}\n\nfunction filterArticlesByAuthor(author, articles) {\n  return articles.filter((article) => {\n    return article.author === author;\n  });\n}\n\nfunction filterOnePost(blockHeight, articles) {\n  if (articles) {\n    return articles.filter((article) => article.blockHeight === blockHeight);\n  } else {\n    return [];\n  }\n}\n\nif (state.filterBy.parameterName === \"tag\") {\n  articlesToRender = filterArticlesByTag(\n    state.filterBy.parameterValue,\n    articlesToRender\n  );\n} else if (state.filterBy.parameterName === \"author\") {\n  articlesToRender = filterArticlesByAuthor(\n    state.filterBy.parameterValue,\n    articlesToRender\n  );\n} else if (state.filterBy.parameterName === \"getPost\") {\n  articlesToRender = filterOnePost(\n    state.filterBy.parameterValue,\n    articlesToRender\n  );\n\n  if (articlesToRender.length > 0) {\n    State.update({ articleToRenderData: articlesToRender[0] });\n  }\n}\n//===============================================END GET DATA=======================================================\n\n//=============================================STYLED COMPONENTS====================================================\nconst CallLibrary = styled.div`\n  display: block;\n`;\n\nconst ShareInteractionGeneralContainer = styled.div`\n    position: fixed;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    top: 0;\n    left: 0;\n    height: 100vh;\n    width: 100vw;\n    backdrop-filter: blur(10px);\n    z-index: 1;\n`;\n\nconst ShareInteractionMainContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  background: white;\n  padding: 1rem;\n  border-radious: 12px;\n`;\n\nconst ClosePopUpContainer = styled.div`\n  display: flex;  \n  flex-direction: row-reverse;\n`;\n\nconst CloseIcon = styled.div`\n  cursor: pointer;\n`;\n\nconst PopUpDescription = styled.p`\n  color: #474D55;\n`;\n\nconst ShowLinkShared = styled.div`\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  background-color: #F2F6FA;\n  padding: 1rem 2rem;\n  border-radius: 17px;\n`;\n\nconst LinkShared = styled.span`\n  color: #0065FF;\n  word-wrap: anywhere;\n`;\n\nconst ClipboardContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  margin-left: 0.5rem;\n  min-width: 2.5rem;\n`;\n\nconst ClipboardIcon = styled.i`\n  color: ${state.linkCopied ? \"#0065FF\" : \"black\"};\n  transition: color 0.3s linear;\n  cursor: pointer;\n`;\n\nconst CopiedFeedback = styled.span`\n  font-size: 0.7rem;\n  color: #6c757d;\n`;\n\nconst SmallButton = styled.button`\nposition: relative;\n  border: 0;\n  background: transparent;\n  width: 35px;\n  height: 35px;\n`;\n//===========================================END STYLED COMPONENTS==================================================\n\n//================================================COMPONENTS========================================================\nconst renderShareInteraction = () => {\n  return (\n    <ShareInteractionGeneralContainer>\n      <ShareInteractionMainContainer>\n        <ClosePopUpContainer>\n          <CloseIcon\n            className=\"bi bi-x\"\n            onClick={() =>\n              State.update({ showShareModal: false, linkCopied: false })\n            }\n          ></CloseIcon>\n        </ClosePopUpContainer>\n        <h3>Share</h3>\n        <PopUpDescription>Use this link to share the article</PopUpDescription>\n        <ShowLinkShared>\n          <LinkShared>{getLink()}</LinkShared>\n          <ClipboardContainer>\n            <ClipboardIcon\n              className=\"bi-clipboard\"\n              onClick={() => {\n                clipboard.writeText(getLink());\n                State.update({ linkCopied: true });\n              }}\n            ></ClipboardIcon>\n            {state.linkCopied && <CopiedFeedback>Copied!</CopiedFeedback>}\n          </ClipboardContainer>\n        </ShowLinkShared>\n      </ShareInteractionMainContainer>\n    </ShareInteractionGeneralContainer>\n  );\n};\n\nconst renderSelectorLabel = () => {\n  return (\n    <>\n      <span>Post & Filter Topics by SBT</span>\n\n      <SmallButton>\n        <OverlayTrigger\n          placement=\"top\"\n          overlay={\n            <Tooltip>\n              <p className=\"m-0\">Topics for Community SBT Holders.</p>\n              <p className=\"m-0\">Anyone can post to Public.</p>\n            </Tooltip>\n          }\n        >\n          <i className=\"bi bi-info-circle\"></i>\n        </OverlayTrigger>\n      </SmallButton>\n    </>\n  );\n};\n//==============================================END COMPONENTS======================================================\n\n//=================================================FUNCTIONS========================================================\n\nfunction getValidEditArticleDataTags() {\n  let tags = state.editArticleData.tags;\n  let newFormatTags = {};\n\n  tags &&\n    tags.map((tag) => {\n      newFormatTags[tag] = \"\";\n    });\n  return newFormatTags;\n}\n\nfunction createSbtOptions() {\n  return sbtWhiteList.map((option, i) => {\n    const title = \"\";\n\n    if (option === \"fractal.i-am-human.near - class 1\") {\n      title = \"General\";\n    } else if (option === \"community.i-am-human.near - class 1\") {\n      title = \"OG\";\n    } else if (option === \"community.i-am-human.near - class 2\") {\n      title = \"Contributor\";\n    } else if (option === \"community.i-am-human.near - class 3\") {\n      title = \"Core Contributor\";\n    } else {\n      title = \"Public\";\n    }\n\n    if (i == 0) {\n      //The first options is always the default one\n      return { title, default: true, value: option };\n    } else {\n      return { title, value: option };\n    }\n  });\n}\n\nconst initialCreateState = {\n  title: state.editArticleData.title ?? \"\",\n  articleBody: state.editArticleData.body ?? initialBodyAtCreation,\n  tags: state.editArticleData.tags ? getValidEditArticleDataTags() : {},\n  libsCalls: { comment: {}, article: {}, emojis: {}, upVotes: {} },\n  sbts: [sbtWhiteList[0]],\n};\n\nfunction stateUpdate(obj) {\n  State.update(obj);\n}\n\nfunction handleOpenArticle(articleToRenderData) {\n  State.update({\n    displayedTabId: tabs.SHOW_ARTICLE.id,\n    articleToRenderData,\n    editArticleData: undefined,\n  });\n}\n\nfunction handleEditArticle(articleData) {\n  State.update({\n    displayedTabId: tabs.ARTICLE_WORKSHOP.id,\n    editArticleData: articleData,\n  });\n}\n\nfunction handleFilterArticles(filter) {\n  State.update({\n    filterBy: {\n      parameterName: filter.filterBy,\n      parameterValue: filter.value,\n    },\n    displayedTabId: tabs.SHOW_ARTICLES_LIST.id,\n    editArticleData: undefined,\n  });\n}\n\nfunction handleBackButton() {\n  props.editArticleData\n    ? State.update({\n        displayedTabId: tabs.SHOW_ARTICLE.id,\n        editArticleData: undefined,\n        filterBy: {\n          parameterName: \"\",\n          parameterValue: undefined,\n          handleBackClicked: true,\n        },\n        firstRender: false,\n      })\n    : State.update({\n        displayedTabId: tabs.SHOW_ARTICLES_LIST.id,\n        articleToRenderData: {},\n        editArticleData: undefined,\n        filterBy: {\n          parameterName: \"\",\n          parameterValue: undefined,\n          handleBackClicked: true,\n        },\n        firstRender: false,\n      });\n}\n\nfunction handleGoHomeButton() {\n  State.update({\n    displayedTabId: tabs.SHOW_ARTICLES_LIST.id,\n    articleToRenderData: {},\n    filterBy: { parameterName: \"\", parameterValue: {} },\n    editArticleData: undefined,\n  });\n}\n\nfunction handlePillNavigation(navegateTo) {\n  State.update({ displayedTabId: navegateTo, editArticleData: undefined });\n}\n\nfunction callLibs(\n  src,\n  stateUpdate,\n  functionsToCallByLibrary,\n  extraProps,\n  callerWidget\n) {\n  return (\n    <Widget\n      src={src}\n      props={{\n        isTest,\n        stateUpdate,\n        functionsToCallByLibrary,\n        callLibs,\n        widgets,\n        callerWidget,\n        ...extraProps,\n      }}\n    />\n  );\n}\n\nfunction handleSbtSelection(selectedSbt) {\n  State.update({\n    sbts: [selectedSbt],\n  });\n}\n\nfunction handleShareButton(showShareModal, sharedElement) {\n  //showShareModal is a boolean\n  //sharedElement is and object like the example: {\n  //   type: string,\n  //   value: number||string,\n  // }\n  State.update({ showShareModal, sharedElement });\n}\n\nfunction getLink() {\n  return `https://near.social/${widgets.communityVoice}?${\n    isTest && \"isTest=t&\"\n  }${state.sharedElement.type}=${state.sharedElement.value}`;\n}\n\n//===============================================END FUNCTIONS======================================================\nif (!context.accountId) {\n  return (\n    <>\n      <Widget\n        src={widgets.header}\n        props={{\n          isTest,\n          stateUpdate,\n          handleGoHomeButton,\n          handlePillNavigation,\n          brand,\n          pills: navigationPills,\n          navigationButtons,\n          displayedTabId: state.displayedTabId,\n          handleFilterArticles,\n          filterParameter: state.filterBy.parameterName,\n          handleBackButton,\n          tabs,\n          sbtsNames,\n        }}\n      />\n      <h2>Log in to see the articles</h2>\n    </>\n  );\n}\n\nreturn (\n  <>\n    {state.showShareModal && renderShareInteraction()}\n    <Widget\n      src={widgets.header}\n      props={{\n        isTest,\n        stateUpdate,\n        handleGoHomeButton,\n        handlePillNavigation,\n        brand,\n        pills: navigationPills,\n        navigationButtons,\n        displayedTabId: state.displayedTabId,\n        handleFilterArticles,\n        filterParameter: state.filterBy.parameterName,\n        handleBackButton,\n        tabs,\n        sbtsNames,\n      }}\n    />\n    {state.displayedTabId == tabs.SHOW_ARTICLES_LIST.id && (\n      <div className=\"my-3 col-lg-8 col-md-8 col-sm-12\">\n        <Widget\n          src={widgets.newStyledComponents.Input.Select}\n          props={{\n            label: renderSelectorLabel(),\n            value: sbts[0],\n            onChange: handleSbtSelection,\n            options: createSbtOptions(),\n          }}\n        />\n      </div>\n    )}\n    {articlesToRender && state.displayedTabId == tabs.SHOW_ARTICLES_LIST.id && (\n      <Widget\n        src={widgets.showArticlesList}\n        props={{\n          isTest,\n          articlesToRender,\n          tabs,\n          widgets,\n          addressForArticles,\n          handleOpenArticle,\n          handleFilterArticles,\n          authorForWidget,\n          initialCreateState,\n          editArticleData: state.editArticleData,\n          handleEditArticle,\n          showCreateArticle: canLoggedUserCreateArticle,\n          sbtWhiteList,\n          sbts,\n          handleShareButton,\n          canLoggedUserCreateArticles,\n          filterBy: state.filterBy,\n          callLibs,\n        }}\n      />\n    )}\n    {state.articleToRenderData.title &&\n      state.displayedTabId == tabs.SHOW_ARTICLE.id && (\n        <Widget\n          src={widgets.articleView}\n          props={{\n            isTest,\n            widgets,\n            handleFilterArticles,\n            articleToRenderData: state.articleToRenderData,\n            authorForWidget,\n            handleEditArticle,\n            handleShareButton,\n            callLibs,\n          }}\n        />\n      )}\n\n    {state.displayedTabId == tabs.SHOW_ARTICLES_LIST_BY_AUTHORS.id && (\n      <Widget\n        src={widgets.showArticlesListSortedByAuthors}\n        props={{\n          isTest,\n          finalArticles,\n          tabs,\n          widgets,\n          handleOpenArticle,\n          handleFilterArticles,\n          authorForWidget,\n        }}\n      />\n    )}\n\n    {state.displayedTabId == tabs.ARTICLE_WORKSHOP.id && (\n      <Widget\n        src={widgets.create}\n        props={{\n          isTest,\n          addressForArticles,\n          authorForWidget,\n          stateUpdate,\n          widgets,\n          initialBody: initialBodyAtCreation,\n          initialCreateState,\n          editArticleData: state.editArticleData,\n          callLibs,\n          handleFilterArticles,\n          handleEditArticle,\n          sbtWhiteList,\n          sbts,\n          canLoggedUserCreateArticles,\n        }}\n      />\n    )}\n\n    <CallLibrary>\n      {libSrcArray.map((src) => {\n        return callLibs(\n          src,\n          stateUpdate,\n          state.functionsToCallByLibrary,\n          { baseAction: \"communityVoiceArticle\" },\n          \"CommunityVoice\"\n        );\n      })}\n    </CallLibrary>\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb/widget/CommunityVoice", "fact_widget_deployments_id": "b9e879c2f4f141a76e1a36368d9ec871", "inserted_timestamp": "2023-11-01T21:20:08.786Z", "modified_timestamp": "2023-11-01T21:20:08.786Z", "__row_index": 1}