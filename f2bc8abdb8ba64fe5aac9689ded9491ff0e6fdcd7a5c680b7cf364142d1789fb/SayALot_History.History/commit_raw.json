{"tx_hash": "FnecwaiVWeqj5XAJ26wqMku99YjjSybj2EMUwhDhLu1S", "action_id_social": "3A9w8PKDpKgyEs48Cjj1XvsYMuiPu4hoAeQzfRZq55As-0-widget", "block_id": 97392902, "block_timestamp": "2023-07-26T17:49:45.696Z", "signer_id": "f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb", "widget_name": "SayALot_History.History", "source_code": "/*\r\n---props---\r\ncount(count: number)?: function,\r\n*/\r\n\r\nconst isDebug = props.isDebug;\r\nconst addressForArticles = isDebug ? \"test_sayALotArticle\" : \"sayALotArticle\";\r\n\r\nconst author = props.author;\r\n\r\nconst authorForWidget =\r\n  \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\";\r\nconst { articleId } = props;\r\n\r\nconst writersWhiteList = props.writersWhiteList ?? [\r\n  \"neardigitalcollective.near\",\r\n  \"blaze.near\",\r\n  \"jlw.near\",\r\n  \"kazanderdad.near\",\r\n  \"joep.near\",\r\n  \"sarahkornfeld.near\",\r\n  \"yuensid.near\",\r\n  \"shubham007.near\",\r\n  \"fiftycent.near\",\r\n  \"chloe.near\",\r\n  \"ozymandius.near\",\r\n];\r\n\r\nconst sayALotWorkers = [\r\n  \"silkking.near\",\r\n  \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n  \"blaze.near\",\r\n  \"ayelen.near\",\r\n  \"kenrou-it.near\",\r\n];\r\n\r\nif (isDebug) {\r\n  writersWhiteList = sayALotWorkers;\r\n}\r\n\r\n// if (typeof props.widgetPath !== \"string\")\r\n//   return \"send {widgetPath} as string in props\";\r\n\r\nState.init({\r\n  selectedTab: \"code\",\r\n  selectedBlockHeight: null,\r\n});\r\n\r\n// // ========== GET INDEX ARRAY FOR ARTICLES ==========\r\n// const postsIndex = Social.index(addressForArticles, \"main\", {\r\n//   order: \"desc\",\r\n//   accountId: undefined,\r\n// });\r\n// // ========== GET ALL ARTICLES ==========\r\n// const resultArticles =\r\n//   postsIndex &&\r\n//   postsIndex.reduce((acc, { accountId, blockHeight }) => {\r\n//     const postData = Social.get(\r\n//       `${accountId}/${addressForArticles}/main`,\r\n//       blockHeight\r\n//     );\r\n//     const postDataWithBlockHeight = { ...JSON.parse(postData), blockHeight };\r\n//     return [...acc, postDataWithBlockHeight];\r\n//   }, []);\r\n// if (resultArticles === null) return \"loading...\";\r\n// // ========== FIND ALL VERSIONS OF ONE ARTICLE ==========\r\n// const filteredArticles =\r\n//   resultArticles.length &&\r\n//   resultArticles.reduce((acc, article) => {\r\n//     if (article.articleId === articleId) {\r\n//       return [...acc, article];\r\n//     } else {\r\n//       return acc;\r\n//     }\r\n//   }, []);\r\n\r\nconst articleBlackList = [91092435, 91092174, 91051228, 91092223, 91051203];\r\n\r\nfunction getLastEditionsByArticle() {\r\n  const allArticles = Social.index(addressForArticles, \"main\", {\r\n    order: \"desc\",\r\n    accountId: author,\r\n  });\r\n\r\n  const oldFormatArticlesTestBasicDataArray = [\r\n    [\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      97325392,\r\n    ],\r\n    [\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      97317287,\r\n    ],\r\n    [\"ayelen.near\", 96927579],\r\n    [\"kenrou-it.near\", 96924422],\r\n    [\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      96879470,\r\n    ],\r\n    [\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      96878182,\r\n    ],\r\n    [\r\n      \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n      96643643,\r\n    ],\r\n    [\"silkking.near\", 96491128],\r\n  ];\r\n\r\n  const oldFormatArticlesMainBasicDataArray = [\r\n    [\"ozymandius.near\", 97329049],\r\n    [\"fiftycent.near\", 97322138],\r\n    [\"blaze.near\", 97255023],\r\n    [\"jlw.near\", 97250015],\r\n    [\"kazanderdad.near\", 96692435],\r\n    [\"blaze.near\", 96414482],\r\n    [\"blaze.near\", 96412953],\r\n    [\"sarahkornfeld.near\", 96402919],\r\n    [\"sarahkornfeld.near\", 96402476],\r\n    [\"sarahkornfeld.near\", 96402330],\r\n    [\"sarahkornfeld.near\", 96401880],\r\n    [\"ozymandius.near\", 95810612],\r\n    [\"blaze.near\", 95766756],\r\n    [\"blaze.near\", 95766700],\r\n    [\"jlw.near\", 95705034],\r\n    [\"blaze.near\", 95413943],\r\n    [\"blaze.near\", 94936576],\r\n    [\"yuensid.near\", 94866690],\r\n    [\"sarahkornfeld.near\", 94863580],\r\n    [\"blaze.near\", 94801223],\r\n    [\"sarahkornfeld.near\", 94344236],\r\n    [\"sarahkornfeld.near\", 94188387],\r\n    [\"jlw.near\", 93986868],\r\n    [\"blaze.near\", 92999498],\r\n  ];\r\n\r\n  const oldFormatArticlesBasicDataArray = isDebug\r\n    ? oldFormatArticlesTestBasicDataArray\r\n    : oldFormatArticlesMainBasicDataArray;\r\n\r\n  if (author) {\r\n    oldFormatArticlesBasicDataArray = oldFormatArticlesBasicDataArray.filter(\r\n      (articleBasicData) => articleBasicData[0] === author\r\n    );\r\n  }\r\n\r\n  let oldFormatArticlesArray = oldFormatArticlesBasicDataArray.map(\r\n    (oldFormatBasicArticleData) => {\r\n      let article = Social.get(\r\n        `${oldFormatBasicArticleData[0]}/${addressForArticles}/main`,\r\n        oldFormatBasicArticleData[1]\r\n      );\r\n\r\n      let articleParsed = JSON.parse(article);\r\n      articleParsed.blockHeight = oldFormatBasicArticleData[1];\r\n\r\n      return articleParsed;\r\n    }\r\n  );\r\n\r\n  let newFormatArticlesData = allArticles\r\n    .filter((articleIndex) => articleIndex.value.id)\r\n    .filter(\r\n      (articleIndex) =>\r\n        articleIndex.value.id.split(\"-\")[0] === articleIndex.accountId\r\n    )\r\n    .filter((articleIndex) => writersWhiteList.includes(articleIndex.accountId))\r\n    .filter(\r\n      (articleIndex) => !articleBlackList.includes(articleIndex.blockHeight)\r\n    );\r\n\r\n  let lastestEditArticlesDataArray = newFormatArticlesData.filter(\r\n    (articleData) => {\r\n      const latestEditForThisArticle = newFormatArticlesData.find(\r\n        (newArticleData) => newArticleData.value.id\r\n      );\r\n      return (\r\n        JSON.stringify(articleData) === JSON.stringify(latestEditForThisArticle)\r\n      );\r\n    }\r\n  );\r\n\r\n  let finalNewFormatArticles = lastestEditArticlesDataArray.map(\r\n    (latestEditArticle) => {\r\n      const article = Social.get(\r\n        `${latestEditArticle.accountId}/${addressForArticles}/main`,\r\n        latestEditArticle.blockHeight\r\n      );\r\n\r\n      let articleParsed = JSON.parse(article);\r\n      articleParsed.blockHeight = latestEditArticle.blockHeight;\r\n\r\n      return articleParsed;\r\n    }\r\n  );\r\n\r\n  let finalOldFormatArticles = oldFormatArticlesArray.filter(\r\n    (oldFormatArticle) => {\r\n      return !finalNewFormatArticles.find(\r\n        (newFormatArticle) =>\r\n          newFormatArticle.articleId === oldFormatArticle.articleId\r\n      );\r\n    }\r\n  );\r\n\r\n  let finalArticles = finalNewFormatArticles.concat(finalOldFormatArticles);\r\n\r\n  return finalArticles;\r\n}\r\nconst finalArticles = getLastEditionsByArticle();\r\n// ========== GET ARRAY OF BLOCK HEIGHT AND LAST EDITOR ==========\r\nlet blocksChanges =\r\n  finalArticles &&\r\n  finalArticles.map((item) => ({\r\n    blockHeight: item.blockHeight,\r\n    lastEditor: item.lastEditor,\r\n  }));\r\n\r\nif (props.count) props.count(blocksChanges.length);\r\n// if (blocksChanges) blocksChanges = blocksChanges?.sort((a, b) => b - a);\r\n\r\nif (!state.selectedBlockHeight) state.selectedBlockHeight = blocksChanges[0];\r\n\r\nfunction getDatastringFromBlockHeight(blockHeight) {\r\n  const block = Near.block(blockHeight);\r\n  const date = new Date(block.header.timestamp_nanosec / 1e6);\r\n  return date.toDateString() + \" \" + date.toLocaleTimeString();\r\n}\r\n\r\nconst renderBlockChangesLink = (blockHeight) => {\r\n  return (\r\n    <div>\r\n      <button\r\n        className={`list-group-item list-group-item-action ${\r\n          state.selectedBlockHeight.blockHeight != blockHeight\r\n            ? \"\"\r\n            : \"list-group-item-info\"\r\n        }`}\r\n        onClick={() => {\r\n          State.update({ selectedBlockHeight: blockHeight });\r\n        }}\r\n      >\r\n        #{blockHeight.blockHeight} *{\" \"}\r\n        {getDatastringFromBlockHeight(blockHeight.blockHeight)}\r\n      </button>\r\n    </div>\r\n  );\r\n};\r\n\r\nfunction blockHeightToWidgetCode(blockHeightObject) {\r\n  const index = blocksChanges.findIndex(\r\n    (el) => el.blockHeight == blockHeightObject.blockHeight\r\n  );\r\n  const prevBlockHeightObject = blocksChanges[index + 1];\r\n  return (\r\n    <Widget\r\n      style={{ minHeight: \"200px\" }}\r\n      key={blockHeightObject.blockHeight}\r\n      src={`neardigitalcollective.near/widget/WikiOnSocialDB_History.ArticleHistoryCard`}\r\n      props={{\r\n        pathToCurrentArticle: `${blockHeightObject.lastEditor}/${addressForArticles}/main`,\r\n        currentBlockHeight: blockHeightObject.blockHeight,\r\n        pathToPrevArticle: `${prevBlockHeightObject.lastEditor}/${addressForArticles}/main`,\r\n        prevBlockHeight: prevBlockHeightObject.blockHeight,\r\n      }}\r\n    />\r\n  );\r\n}\r\n\r\nfunction blockHeightToWidgetRender(blockHeightObject, allArticles) {\r\n  const index = blocksChanges.findIndex(\r\n    (el) => el.blockHeight == blockHeightObject.blockHeight\r\n  );\r\n  return <Markdown text={allArticles[index].body} />;\r\n}\r\n\r\n//styles forked from calebjacob.near/widget/Activity\r\nconst Tabs = styled.div`\r\n  display: flex;\r\n  padding: 0 12px;\r\n  height: 48px;\r\n  border-bottom: 1px solid #ECEEF0;\r\n`;\r\n\r\nconst TabsButton = styled.button`\r\n  font-weight: 400;\r\n  font-size: 14px;\r\n  line-height: 17px;\r\n  padding: 0 12px;\r\n  position: relative;\r\n  color: ${(p) => (p.selected ? \"#11181C\" : \"#687076\")};\r\n  background: none;\r\n  border: none;\r\n  outline: none;\r\n\r\n  &:hover {\r\n    color: #11181C;\r\n  }\r\n\r\n  &::after {\r\n    content: '';\r\n    display: ${(p) => (p.selected ? \"block\" : \"none\")};\r\n    position: absolute;\r\n    bottom: 0;\r\n    left: 12px;\r\n    right: 12px;\r\n    height: 3px;\r\n    background: #0091FF;\r\n  }\r\n`;\r\n\r\nreturn (\r\n  <div>\r\n    <h3 class=\"text-center\">Widget History</h3>\r\n    {!blocksChanges ? (\r\n      <div>incorrent widget path</div>\r\n    ) : (\r\n      <div>\r\n        <div div class=\"card mb-3\">\r\n          <h3 class=\"card-header\">{blocksChanges.length} Commits</h3>\r\n          <div class=\"list-group\">\r\n            {blocksChanges\r\n              .slice(0, 5)\r\n              .map((height) => renderBlockChangesLink(height))}\r\n            <div class=\"collapse\" id=\"collapseExample\">\r\n              {blocksChanges\r\n                .slice(5)\r\n                .map((height) => renderBlockChangesLink(height))}\r\n            </div>\r\n            {blocksChanges.length > 5 && (\r\n              <button\r\n                class=\"list-group-item active\"\r\n                type=\"button\"\r\n                data-bs-toggle=\"collapse\"\r\n                data-bs-target=\"#collapseExample\"\r\n                aria-expanded=\"false\"\r\n                aria-controls=\"collapseExample\"\r\n              >\r\n                Show all\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        <Tabs>\r\n          <TabsButton\r\n            type=\"button\"\r\n            onClick={() =>\r\n              State.update({\r\n                selectedTab: \"code\",\r\n              })\r\n            }\r\n            selected={state.selectedTab == \"code\"}\r\n          >\r\n            Code\r\n          </TabsButton>\r\n\r\n          <TabsButton\r\n            type=\"button\"\r\n            onClick={() =>\r\n              State.update({\r\n                selectedTab: \"render\",\r\n              })\r\n            }\r\n            selected={state.selectedTab == \"render\"}\r\n          >\r\n            Render\r\n          </TabsButton>\r\n        </Tabs>\r\n\r\n        {state.selectedTab == \"code\" && (\r\n          <div>{blockHeightToWidgetCode(state.selectedBlockHeight)}</div>\r\n        )}\r\n\r\n        {state.selectedTab == \"render\" && (\r\n          <div>\r\n            {blockHeightToWidgetRender(\r\n              state.selectedBlockHeight,\r\n              finalArticles\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n    )}\r\n  </div>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb/widget/SayALot_History.History", "fact_widget_deployments_id": "91f2949406c28340de0a06c2c3cef089", "inserted_timestamp": "2000-01-01T00:00:00.000Z", "modified_timestamp": "2000-01-01T00:00:00.000Z", "__row_index": 5}