{"tx_hash": "JN1pJJpUg31izeKpCzvZ1igF59uyFYoJ5KrMdASp6Bb", "action_id_social": "APmPZ11JhxjDqNNv3E2gDttgxeWsEa3UmqaveEHH8k5f-0-widget", "block_id": 114204636, "block_timestamp": "2024-03-06T12:55:29.884Z", "signer_id": "baam25.near", "widget_name": "store", "source_code": "const accountId = props.accountId || context.accountId;\nconst store = props.store;\nconst customStyle = props.customStyle || \"\";\nconst description = props.description || \"\";\nconst showHeader = props.showHeader === null ? true : props.showHeader;\nconst header = props.header;\n// Paginaton\nconst perPage = props.perPage || 48;\nconst AFFILIATE_ACCOUNT = props.affiliateAccount || \"baam25.near\";\n\nconst nearLogo =\n  \"https://ipfs.near.social/ipfs/bafkreib2cfbayerbbnoya6z4qcywnizqrbkzt5lbqe32whm2lubw3sywr4\";\n\nif (!store) return \"pass storeId\";\n\nconst [page, setPage] = useState(0);\nconst [filter, setFilter] = useState(\"Filter\");\n\nconst YoctoToNear = (amountYocto) => {\n  return new Big(amountYocto || 0).div(new Big(10).pow(24)).toString();\n};\nconst _price = (nft) => {\n  if (nft) {\n    return nft.listings[0]?.price;\n  }\n};\nconst _address = (address, _limit) => {\n  const limit = _limit || 20;\n  if (address.length > limit) return address.slice(0, 10) + \"...\";\n  else return address;\n};\n\nconst data = fetch(\"https://graph.mintbase.xyz\", {\n  method: \"POST\",\n  headers: {\n    \"mb-api-key\": \"anon\",\n    \"Content-Type\": \"application/json\",\n  },\n  body: JSON.stringify({\n    query: `query MyQuery {\n      mb_views_nft_tokens(\n        where: {nft_contract_id: {_eq: \"${store}\"}}\n        order_by: {title: asc}\n      ) {\n        token_id\n        title\n        owner\n        media\n        metadata_id\n        listings(where: {unlisted_at: {_is_null: true}, accepted_at: {_is_null: true}}) {\n          price\n        }\n      }\n      mb_views_nft_owned_tokens_aggregate(\n        distinct_on: owner\n        where: {nft_contract_id: {_eq: \"${store}\"}}\n      ) {\n        aggregate {\n          count(distinct: true)\n        }\n      }\n      nft_earnings(where: {nft_contract_id: {_eq: \"${store}\"}}) {\n        amount\n      }\n    }\n  `,\n  }),\n});\nlet nfts = data?.body?.data?.mb_views_nft_tokens;\nif (!nfts) return \"Loading\";\nconst nft_earnings = data?.body?.data?.nft_earnings;\nconst owners =\n  data?.body?.data?.mb_views_nft_owned_tokens_aggregate?.aggregate.count;\n\nlet floorPrice = 0;\nif (nfts.length) {\n  const lowestPrice = nfts.reduce((minObj, obj) => {\n    const currentPrice = _price(obj);\n    const minObjPrice = _price(minObj);\n    // Exclude null and undefined values\n    if (currentPrice != null && currentPrice !== undefined) {\n      // If minObj is null or currentPrice is lower than minObj.price, update minObj\n      if (minObj === null || currentPrice < minObjPrice) {\n        return obj;\n      }\n    }\n    // Otherwise, keep minObj unchanged\n    return minObj;\n  }, null);\n  floorPrice = YoctoToNear(_price(lowestPrice).toString());\n}\n\nconst sortByName = () => {\n  nfts.sort((a, b) => {\n    const nameA = a.title; // Ignore case during comparison\n    const nameB = b.title;\n    if (nameA < nameB) {\n      return -1;\n    }\n    if (nameA > nameB) {\n      return 1;\n    }\n    // names must be equal\n    return 0;\n  });\n};\n\n// Filter\nswitch (filter) {\n  case \"Name\":\n    sortByName();\n    break;\n  case \"Price: Low To High\":\n    nfts.sort((a, b) => {\n      const aPrice = a.listings[0].price;\n      const bPrice = b.listings[0].price;\n      if (aPrice === undefined && bPrice === undefined) {\n        return 0; // no change in order for null values\n      }\n      if (aPrice === undefined) {\n        return 1; // move object with null price to the end\n      }\n      if (bPrice === undefined) {\n        return -1; // move object with null price to the end\n      }\n      return aPrice - bPrice; // compare numeric values for non-null prices\n    });\n    break;\n  case \"Price: High To Low\":\n    nfts.sort((a, b) => {\n      const aPrice = a.listings[0].price || 0;\n      const bPrice = b.listings[0].price || 0;\n      return bPrice - aPrice;\n    });\n    break;\n  case \"Owned by me\":\n    nfts = nfts.filter((nft) => nft.owner === accountId);\n    break;\n  default:\n    sortByName();\n    break;\n}\n// GET Volume\nlet volume = new Big(0);\nif (nft_earnings?.length) {\n  nft_earnings.forEach((nft) => {\n    volume = volume.plus(new Big(nft.amount));\n  });\n}\nlet buy = (price, token_id) => {\n  const gas = 200000000000000;\n  const deposit = new Big(price).toFixed(0);\n  Near.call(\n    marketId,\n    \"buy\",\n    {\n      nft_contract_id: store,\n      token_id: token_id,\n    },\n    gas,\n    deposit\n  );\n};\n\nif (!data.ok) {\n  return \"Loading\";\n}\n\nconst size = \"20em\";\n\nconst Container = styled.div`\n  --primary-color: #aeaeae;\n  --primary-light: #aeaeae75;\n  display: flex;\n  flex-direction: column;\n  .store {\n    padding-left: 1rem;\n  }\n  .card-wrapper {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 1.5rem;\n    justify-content: space-between;\n    @media only screen and (max-width: 480px) {\n      justify-content: center;\n    }\n  }\n  ${customStyle}\n`;\nconst NFTcard = styled.a`\n  display: flex;\n  width: 250px;\n  flex-direction: column;\n  border: 2px solid var(--primary-color);\n  border-radius: 10px;\n  box-shadow: 0px 0px 5px var(--primary-light);\n  transition: all 300ms ease-in-out;\n  cursor: pointer;\n  overflow: hidden;\n  text-decoration: none;\n  height: 100%;\n  :hover {\n    box-shadow: 0px 0px 30px var(--primary-light);\n    text-decoration: none;\n  }\n  img {\n    height: 250px;\n    object-fit: cover;\n    position: relative;\n    :before {\n      content: \" \";\n      display: block;\n      position: absolute;\n      height: 250px;\n      width: 250px;\n      background-image: url(\"https://i.stack.imgur.com/ATB3o.gif\");\n    }\n  }\n  .desc {\n    display: flex;\n    flex-direction: column;\n    gap: 10px;\n    padding: 1rem;\n  }\n  .tilte {\n    color: black;\n  }\n\n  .listed {\n    font-size: 10px;\n    color: #6c757d;\n    margin-left: auto;\n  }\n  .price {\n    font-size: 12px;\n    color: var(--primary-color);\n    margin-left: auto;\n    font-weight: bold;\n  }\n`;\n\nconst Stats = styled.div`\n  display: flex;\n  flex-wrap: wrap;\n  align-items: center;\n  gap: 1rem;\n  padding: 1rem;\n  .filter {\n    margin-left: auto;\n    position: relative;\n    @media only screen and (max-width: 480px) {\n      width: 100%;\n    }\n  }\n`;\nconst Total = styled.div`\n  font-size: 16px;\n  flex-direction: column;\n  text-align: center;\n  padding: 10px;\n  border: 1px solid var(--primary-color);\n  border-radius: 6px;\n  div:last-child {\n    color: var(--primary-color);\n    font-weight: 600;\n  }\n`;\nconst Button = styled.button`\n  border-radius: 6px;\n  background: transparent;\n  width: 100%;\n  padding: 6px;\n  color: var(--primary-color);\n  border-color: var(--primary-color);\n  transition: all 300ms ease-in-out;\n  :hover {\n    background: var(--primary-color);\n    color: white;\n  }\n`;\nconst Trigger = styled.div`\n  border: 2px solid var(--primary-color);\n  border-radius: 1rem;\n  padding: 10px 1rem;\n  img {\n    width: 12px;\n  }\n`;\nconst Owner = styled.a`\n  color: var(--primary-color) !important;\n  font-size: 12px;\n  font-weight: 500;\n  text-decoration: none;\n`;\nconst Price = styled.div`\n  display: flex;\n  gap: 4px;\n  align-items: center;\n  font-weight: 600;\n  justify-content: center;\n  img {\n    width: 14px;\n  }\n`;\nconst stats = {\n  Items: nfts.length,\n  \"Total Owners\": owners,\n  \"Floor Price\": (\n    <Price>\n      {floorPrice} <img src={nearLogo} alt=\"near-logo\" />\n    </Price>\n  ),\n  Volume: (\n    <Price>\n      {YoctoToNear(volume.toString())} <img src={nearLogo} alt=\"near-logo\" />\n    </Price>\n  ),\n};\nconst filterItems = [\n  {\n    name: \"Name\",\n    onSelect: () => setFilter(\"Name\"),\n  },\n  {\n    name: \"Price: Low To High\",\n    onSelect: () => setFilter(\"Price: Low To High\"),\n  },\n  {\n    name: \"Price: High To Low\",\n    onSelect: () => setFilter(\"Price: High To Low\"),\n  },\n  {\n    name: \"Owned by me\",\n    onSelect: () => setFilter(\"Owned by me\"),\n  },\n];\n\nconst ProfileOverlay = ({ owner }) => (\n  <Widget\n    src=\"near/widget/AccountProfileOverlay\"\n    props={{\n      accountId: owner,\n      children: (\n        <Owner\n          href={\"https://near.org/near/widget/ProfilePage?accountId=\" + owner}\n          className=\"address\"\n          target=\"_blank\"\n        >\n          {_address(owner)}{\" \"}\n        </Owner>\n      ),\n    }}\n  />\n);\n\nreturn (\n  <Container>\n    {showHeader && (header ?? <h1 className=\"store\">{store}</h1>)}\n    {description && description}\n    <Stats>\n      {Object.keys(stats).map((label) => (\n        <Total key={label}>\n          <div> {label}</div> <div>{stats[label]}</div>\n        </Total>\n      ))}\n      <div className=\"filter\">\n        <Widget\n          src=\"near/widget/DIG.DropdownMenu\"\n          props={{\n            items: filterItems,\n            trigger: (\n              <Trigger>\n                {filter}\n                <img\n                  src=\"https://ipfs.near.social/ipfs/bafkreib55nddf64vsdxlhms5xpe6uirgizr2jbxbjecafcp3ehwqmaswd4\"\n                  alt=\"arrow\"\n                />\n              </Trigger>\n            ),\n          }}\n        />\n      </div>\n    </Stats>\n    <div className=\"card-wrapper\">\n      {nfts.length === 0 && (\n        <p\n          style={{\n            margin: \"auto\",\n            paddingTop: \"1rem\",\n            fontSize: \"20px\",\n            fontWeight: \"bold\",\n          }}\n        >\n          No Owned NFTs\n        </p>\n      )}\n      {nfts.slice(page * perPage, (page + 1) * perPage).map((nft) => {\n        let priceYocto = _price(nft);\n        if (priceYocto) {\n          priceYocto = priceYocto\n            .toLocaleString()\n            .replace(/,/g, \"\")\n            .replace(/\\s/g, \"\");\n        }\n        const priceNear = YoctoToNear(priceYocto);\n        return (\n          <div className=\"d-flex flex-column between wrap gap-1 w-15 p-3\">\n            <NFTcard\n              href={`https://mintbase.xyz/meta/${nft.metadata_id.replace(\n                \":\",\n                \"%3A\"\n              )}`}\n              target=\"_blank\"\n            >\n              <img\n                src={\n                  \"https://image-cache-service-z3w7d7dnea-ew.a.run.app/media?url=\" +\n                  nft.media\n                }\n                alt={nft.title}\n              />\n              <div className=\"desc\">\n                <div className=\"tilte\">{nft.title}</div>\n                <div className=\"owner\">\n                  <ProfileOverlay owner={nft.owner} />\n                </div>\n                {!priceYocto && <div className=\"listed\">not listed</div>}\n                {priceYocto && (\n                  <Button\n                    disabled={!accountId}\n                    onClick={(e) => {\n                      e.preventDefault();\n                      if (!accountId) return;\n                      buy(priceYocto, nft.token_id);\n                    }}\n                  >\n                    Buy {priceNear} N\n                  </Button>\n                )}\n              </div>\n            </NFTcard>\n          </div>\n        );\n      })}\n    </div>\n    <Widget\n      src=\"baam25.near/widget/pagination\"\n      props={{\n        onClick: (page) => setPage(page),\n        data: nfts,\n        page: page,\n        perPage: perPage,\n        bgColor: \"var(--primary-color)\",\n      }}\n    />\n  </Container>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/baam25.near/widget/store", "fact_widget_deployments_id": "4e9f0078eef8c5692bdd2f64cf8a62dc", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}