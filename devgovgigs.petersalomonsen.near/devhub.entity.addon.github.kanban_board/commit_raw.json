{"tx_hash": "6n9morZaUGgqjTtzN1gCakFutTXgrrq3KvQyy4q7fwUX", "action_id_social": "3HUiXcFkFSzUNg6AHvUrHQ4SY3t1udvDvtNKhNX4377S-0-widget", "block_id": 115997781, "block_timestamp": "2024-04-02T18:09:57.619Z", "signer_id": "devgovgigs.petersalomonsen.near", "widget_name": "devhub.entity.addon.github.kanban_board", "source_code": "const { DataRequest } = VM.require(\n  \"devgovgigs.petersalomonsen.near/widget/core.lib.data-request\"\n);\nDataRequest || (DataRequest = { paginated: () => {} });\n\nconst resPerPage = 100;\n\nfunction extractOwnerAndRepo(url) {\n  // Remove any leading or trailing slashes and split the URL by \"/\"\n  const parts = url\n    .trim()\n    .replace(/^\\/+|\\/+$/g, \"\")\n    .split(\"/\");\n\n  // Check if the URL matches the GitHub repository format\n  if (parts.length === 5 && parts[2] === \"github.com\") {\n    const owner = parts[3];\n    const repo = parts[4];\n    return { owner, repo };\n  } else {\n    return null;\n  }\n}\n\nconst GithubKanbanBoard = ({\n  columns,\n  title,\n  description,\n  repoURL,\n  ticketState,\n  dataTypesIncluded,\n  metadata,\n}) => {\n  State.init({\n    fetchedIssuesCount: {},\n    fetchedPullsCount: {},\n    ticketsByColumn: {},\n    cachedItems: {},\n    displayCount: 40,\n    issuesLastPage: false,\n    pullRequestsLastPage: false,\n  });\n\n  const ticketStateFilter = ticketState ?? \"all\";\n\n  function fetchPullRequests(columnId, labelSearchTerms) {\n    const pageNumber = !state.fetchedPullsCount[columnId]\n      ? 1\n      : state.fetchedPullsCount[columnId] / resPerPage + 1;\n    const { repo, owner } = extractOwnerAndRepo(repoURL);\n    // labels query doesn't exists for pull requests\n    const res = fetch(\n      `https://api.github.com/repos/${owner}/${repo}/pulls?state=${ticketStateFilter}&per_page=${resPerPage}&page=${pageNumber}`\n    );\n    if (res !== null) {\n      res.body = res.body.filter((ticket) =>\n        (labelSearchTerms ?? []).every((searchTerm) =>\n          searchTerm.length > 0\n            ? ticket.labels.some((label) =>\n                label.name.toLowerCase().includes(searchTerm.toLowerCase())\n              )\n            : false\n        )\n      );\n\n      if (!res.body.length || res.body.length < resPerPage) {\n        State.update({\n          pullRequestsLastPage: true,\n        });\n      }\n      State.update((lastKnownState) => ({\n        ...lastKnownState,\n        fetchedPullsCount: {\n          ...lastKnownState.fetchedPullsCount,\n          [columnId]:\n            lastKnownState.fetchedPullsCount[columnId] ?? 0 + resPerPage,\n        },\n        ticketsByColumn: {\n          ...lastKnownState.ticketsByColumn,\n          [columnId]: [\n            ...(lastKnownState?.ticketsByColumn?.[columnId] ?? []),\n            ...res.body,\n          ],\n        },\n      }));\n    }\n  }\n\n  function fetchIssues(columnId, labels) {\n    const pageNumber = !state.fetchedIssuesCount[columnId]\n      ? 1\n      : state.fetchedIssuesCount[columnId] / resPerPage + 1;\n    const { repo, owner } = extractOwnerAndRepo(repoURL);\n    const res = fetch(\n      `https://api.github.com/repos/${owner}/${repo}/issues?state=${ticketStateFilter}&per_page=${resPerPage}&page=${pageNumber}&labels=${labels}`\n    );\n    if (res !== null) {\n      if (!res.body.length || res.body.length < resPerPage) {\n        State.update({\n          issuesLastPage: true,\n        });\n      }\n      State.update((lastKnownState) => ({\n        ...lastKnownState,\n        fetchedIssuesCount: {\n          ...lastKnownState.fetchedIssuesCount,\n          [columnId]:\n            lastKnownState.fetchedIssuesCount[columnId] ?? 0 + resPerPage,\n        },\n        ticketsByColumn: {\n          ...lastKnownState.ticketsByColumn,\n          [columnId]: [\n            ...(lastKnownState?.ticketsByColumn?.[columnId] ?? []),\n            ...res.body,\n          ],\n        },\n      }));\n    }\n  }\n\n  if (\n    repoURL &&\n    Object.keys(state.ticketsByColumn).length !== Object.keys(columns).length\n  ) {\n    Object.keys(columns).map((item) => {\n      const columnId = item;\n      const columnData = columns[columnId];\n      const labels = (columnData?.labelSearchTerms ?? []).join(\",\");\n      dataTypesIncluded.issue && fetchIssues(columnId, labels);\n      dataTypesIncluded.pullRequest &&\n        fetchPullRequests(columnId, columnData?.labelSearchTerms);\n    });\n  }\n\n  const renderItem = (ticket) => (\n    <Widget\n      src={`devgovgigs.petersalomonsen.near/widget/devhub.entity.addon.${metadata.ticket.type}`}\n      props={{ metadata: metadata.ticket, payload: ticket }}\n      key={ticket.id}\n    />\n  );\n\n  const cachedRenderItem = (item, index) => {\n    const key = JSON.stringify(item);\n\n    if (!(key in state.cachedItems)) {\n      state.cachedItems[key] = renderItem(item, index);\n      State.update();\n    }\n    return state.cachedItems[key];\n  };\n\n  const makeMoreItems = (columnId, labelSearchTerms) => {\n    const addDisplayCount = 20;\n    const newDisplayCount = state.displayCount + addDisplayCount;\n    State.update({\n      displayCount: newDisplayCount,\n    });\n    const labels = (labelSearchTerms ?? []).join(\",\");\n    if (\n      dataTypesIncluded.issue &&\n      state.fetchedIssuesCount[columnId] < 2 * newDisplayCount\n    ) {\n      fetchIssues(columnId, labels);\n    }\n    if (\n      dataTypesIncluded.pullRequest &&\n      state.fetchedPullsCount[columnId] < 2 * newDisplayCount\n    ) {\n      fetchPullRequests(columnId, labelSearchTerms);\n    }\n  };\n\n  return (\n    <div>\n      <div className=\"d-flex flex-column align-items-center gap-2 pb-4\">\n        <h5 className=\"h5 d-inline-flex gap-2 m-0\">\n          <span>{title}</span>\n        </h5>\n\n        <p className=\"m-0 py-1 text-secondary text-center\">{description}</p>\n      </div>\n\n      <div className=\"d-flex gap-3 w-100\" style={{ overflowX: \"auto\" }}>\n        {Object.keys(columns).length === 0 ? (\n          <div\n            className={[\n              \"d-flex align-items-center justify-content-center\",\n              \"w-100 text-black-50 opacity-50\",\n            ].join(\" \")}\n            style={{ height: 384 }}\n          >\n            No columns were created so far.\n          </div>\n        ) : null}\n        {Object.values(columns ?? {})?.map((column) => {\n          const tickets = state.ticketsByColumn[column.id]\n            ? state.ticketsByColumn[column.id].slice(0, state.displayCount)\n            : [];\n          const renderedItems = tickets.map(cachedRenderItem);\n\n          return (\n            <div\n              className=\"col-3\"\n              style={{ minWidth: \"300px\" }}\n              key={`column-${column.id}-view`}\n            >\n              <div className=\"card rounded-4\">\n                <div\n                  style={{ height: \"75vh\", overflow: \"auto\" }}\n                  className={[\n                    \"card-body d-flex flex-column gap-3 p-2\",\n                    \"border border-1 rounded-4\",\n                  ].join(\" \")}\n                  id={column.id}\n                >\n                  <span className=\"d-flex flex-column py-1\">\n                    <h6 className=\"card-title h6 m-0\">{column.title}</h6>\n                    <p class=\"text-secondary m-0\">{column.description}</p>\n                  </span>\n\n                  {(state.fetchedIssuesCount[column.id] > 0 ||\n                    state.fetchedPullsCount[column.id] > 0) && (\n                    <InfiniteScroll\n                      loadMore={() =>\n                        makeMoreItems(column.id, column?.labelSearchTerms)\n                      }\n                      hasMore={\n                        (dataTypesIncluded.issue && !state.issuesLastPage) ||\n                        (dataTypesIncluded.pullRequest &&\n                          !state.pullRequestsLastPage)\n                      }\n                      loader={<>Loading...</>}\n                      useWindow={false}\n                      threshold={80}\n                    >\n                      <div class=\"d-flex flex-column gap-2\">\n                        {renderedItems}\n                      </div>\n                    </InfiniteScroll>\n                  )}\n                </div>\n              </div>\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n};\n\nreturn GithubKanbanBoard(props);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/devgovgigs.petersalomonsen.near/widget/devhub.entity.addon.github.kanban_board", "fact_widget_deployments_id": "e01d779229e50f4cbb87cc2b2c5266f9", "inserted_timestamp": "2024-04-02T19:31:01.311Z", "modified_timestamp": "2024-04-02T19:31:01.311Z", "__row_index": 34}