{"tx_hash": "8opvxymbDYvupYjJMpwi69wN8vw2iAy3kggwUEhCR2mL", "action_id_social": "5cdSE1V4ZucKjv8Q5WXV2VWK336fYEBd41hpkSjL1mVe-0-widget", "block_id": 97737351, "block_timestamp": "2023-07-31T04:39:33.150Z", "signer_id": "sking.near", "widget_name": "DAO.PermissionsHelper", "source_code": "const daoId = props.daoId ?? \"multi.sputnik-dao.near\";\nconst accountId = props.accountId ?? context.accountId ?? \"infinity.near\";\n\nconst proposalKinds = {\n  ChangeConfig: \"config\",\n  ChangePolicy: \"policy\",\n  AddMemberToRole: \"add_member_to_role\",\n  RemoveMemberFromRole: \"remove_member_from_role\",\n  FunctionCall: \"call\",\n  UpgradeSelf: \"upgrade_self\",\n  UpgradeRemote: \"upgrade_remote\",\n  Transfer: \"transfer\",\n  SetStakingContract: \"set_vote_token\",\n  AddBounty: \"add_bounty\",\n  BountyDone: \"bounty_done\",\n  Vote: \"vote\",\n  FactoryInfoUpdate: \"factory_info_update\",\n  ChangePolicyAddOrUpdateRole: \"policy_add_or_update_role\",\n  ChangePolicyRemoveRole: \"policy_remove_role\",\n  ChangePolicyUpdateDefaultVotePolicy: \"policy_update_default_vote_policy\",\n  ChangePolicyUpdateParameters: \"policy_update_parameters\",\n};\n\nconst actions = {\n  AddProposal: \"AddProposal\",\n  VoteApprove: \"VoteApprove\",\n  VoteReject: \"VoteReject\",\n  VoteRemove: \"VoteRemove\",\n};\n\n// -- Get all the roles from the DAO policy\nlet roles = Near.view(daoId, \"get_policy\");\nroles = roles === null ? [] : roles.roles;\n\nconst getUserRoles = (user) => {\n  const userRoles = [];\n  for (const role of roles) {\n    if (role.kind === \"Everyone\") {\n      continue;\n    }\n    if (!role.kind.Group) continue;\n    if (user && role.kind.Group && role.kind.Group.includes(user)) {\n      userRoles.push(role.name);\n    }\n  }\n  return userRoles;\n};\n\nconst isUserAllowedTo = (user, kind, action) => {\n  // -- Filter the user roles\n  const userRoles = [];\n  for (const role of roles) {\n    if (role.kind === \"Everyone\") {\n      userRoles.push(role);\n      continue;\n    }\n    if (!role.kind.Group) continue;\n    if (user && role.kind.Group && role.kind.Group.includes(user)) {\n      userRoles.push(role);\n    }\n  }\n\n  // -- Check if the user is allowed to perform the action\n  let allowed = false;\n\n  userRoles\n    .filter(({ permissions }) => {\n      const allowedRole =\n        permissions.includes(`${kind.toString()}:${action.toString()}`) ||\n        permissions.includes(`${kind.toString()}:*`) ||\n        permissions.includes(`*:${action.toString()}`) ||\n        permissions.includes(\"*:*\");\n      allowed = allowed || allowedRole;\n      return allowedRole;\n    })\n    .map((role) => role.name);\n\n  return allowed;\n};\n\nconsole.log(\n  \"Is User Allowed To 'Add a Proposal' of type 'FunctionCall'?\",\n  isUserAllowedTo(accountId, proposalKinds.FunctionCall, actions.AddProposal)\n);\n\nconsole.log(\n  \"Is User Allowed To 'Vote Yes' on a proposal of type 'FunctionCall'?\",\n  isUserAllowedTo(accountId, proposalKinds.FunctionCall, actions.VoteApprove)\n);\n\nconsole.log(\n  \"Is User Allowed To 'Add a Proposal' of type 'AddMemberToRole'?\",\n  isUserAllowedTo(accountId, proposalKinds.AddMemberToRole, actions.AddProposal)\n);\n\nconst userRoles = accountId ? getUserRoles(accountId) : [];\n\nconsole.log(\"Is User a Council\", userRoles.includes(\"council\"));\n\nconsole.log(\"Is User part of the DAO\", userRoles.length > 0);\n\nreturn (\n  <div className=\"d-flex flex-column gap-2\">\n    <div>\n      <b>Is {accountId} Allowed To 'Add a Proposal' of type 'FunctionCall'?</b>\n      <div className=\"text-muted\">\n        {isUserAllowedTo(\n          accountId,\n          proposalKinds.FunctionCall,\n          actions.AddProposal\n        ).toString()}\n      </div>\n    </div>\n    <div>\n      <b>\n        Is {accountId} Allowed To 'Vote Yes' on a proposal of type\n        'FunctionCall'?\n      </b>\n      <div className=\"text-muted\">\n        {isUserAllowedTo(\n          accountId,\n          proposalKinds.FunctionCall,\n          actions.VoteApprove\n        ).toString()}\n      </div>\n    </div>\n    <div>\n      <b>\n        Is {accountId} Allowed To 'Add a Proposal' of type 'AddMemberToRole'?\n      </b>\n      <div className=\"text-muted\">\n        {isUserAllowedTo(\n          accountId,\n          proposalKinds.AddMemberToRole,\n          actions.AddProposal\n        ).toString()}\n      </div>\n    </div>\n    <h3>{accountId} roles: </h3>\n    <ul>\n      {userRoles.map((role) => {\n        return <li>{role}</li>;\n      })}\n    </ul>\n  </div>\n);\n", "metadata": {"platform": "jutsu.ai"}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/sking.near/widget/DAO.PermissionsHelper", "fact_widget_deployments_id": "137c4bc8caf0e9679f395cdf8e995cc7", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}