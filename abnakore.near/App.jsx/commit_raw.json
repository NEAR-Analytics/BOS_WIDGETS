{"tx_hash": "2UYwP2x28CP1M6qVsXKTpHW1uy1pkqfxt2gdM3TboiPh", "action_id_social": "EGiGN3PF2cKZaBu1acUQ9gpE4RZUb9ijKfdXniJALLoA-0-widget", "block_id": 112800312, "block_timestamp": "2024-02-14T07:40:54.161Z", "signer_id": "abnakore.near", "widget_name": "App.jsx", "source_code": "// Get the user's accountId\nconst accountId = context.accountId;\n\n// Declaring variables\nconst voteId = props.vote && props.vote;\n// !!!\n// const voteId = 0;\nconst [passcodeEntered, setPasscodeEntered] = useState(\"\");\nconst [candidate, setCandidate] = useState(0);\nconst [party, setparty] = useState(0);\n\n// All the votes\nconst [allVotes, setAllVotes] = useState([]);\nconst [voteToRender, setVoteToRender] = useState([]);\nconst [opened, setOpened] = useState(false);\n\n// Pages that will be displayed in the aside\nconst [pages, setPages] = useState([\n  {\n    name: \"Voting Page\",\n    link: `https://near.org/abnakore.near/widget/App.jsx?vote=${voteToRender.id}`,\n  },\n  {\n    name: \"Result\",\n    link: `https://near.org/abnakore.near/widget/Result.jsx?vote=${voteToRender.id}`,\n  },\n  //   { name: \"Log out\", link: \"https://near.org/signin\" },\n]);\n\n// Add admin pages if the user is the creator of the vote\nuseEffect(() => {\n  console.log(\n    \"Is Admin?\",\n    voteToRender.creator,\n    accountId,\n    voteToRender.creator === accountId,\n    props\n  );\n  if (voteToRender.creator === accountId) {\n    setPages([\n      {\n        name: \"Voting Page\",\n        link: `https://near.org/abnakore.near/widget/App.jsx?vote=${voteToRender.id}`,\n      },\n      {\n        name: \"Result\",\n        link: `https://near.org/abnakore.near/widget/Result.jsx?vote=${voteToRender.id}`,\n      },\n      {\n        name: \"Admin Home\",\n        link: `https://near.org/abnakore.near/widget/AdminHome?vote=${voteToRender.id}`,\n      },\n      {\n        name: \"Manage Candidates\",\n        link: `https://near.org/abnakore.near/widget/ManageCandidates?vote=${voteToRender.id}`,\n      },\n      {\n        name: \"Mange Parties\",\n        link: `https://near.org/abnakore.near/widget/ManageParties?vote=${voteToRender.id}`,\n      },\n    ]);\n  } else {\n    setPages([\n      {\n        name: \"Voting Page\",\n        link: `https://near.org/abnakore.near/widget/App.jsx?vote=${voteToRender.id}`,\n      },\n      {\n        name: \"Result\",\n        link: `https://near.org/abnakore.near/widget/Result.jsx?vote=${voteToRender.id}`,\n      },\n    ]);\n  }\n}, [voteToRender.creator === accountId]);\n\n// Get all the votes\nconst votesData = Social.get(`abnakore.near/votes`);\nuseEffect(() => {\n  if (votesData === undefined) {\n    // Set the votes to an empty list if there is no votes\n    setAllVotes([]);\n  } else {\n    setAllVotes(JSON.parse(votesData));\n  }\n  setVoteToRender(allVotes[voteId]);\n}, [votesData === null]);\n\n// Set the vote to be rendered\nuseEffect(() => {\n  setVoteToRender(allVotes[voteId]);\n}, [allVotes]);\n\n// List of candidates and their curresponding number of votes\n// const [candidates, setCandidates] = useState(voteToRender.candidates);\n\n// Get the candidates data\n// const cands = Social.get(`abnakore.near/candidates`);\n\n// useEffect(() => {\n//   if (cands === undefined) {\n//     // Set the candidate to an empty list if there is no candidate\n//     setCandidates([]);\n//   } else {\n//     setCandidates(JSON.parse(cands));\n//   }\n// }, [cands === null]);\n\nconst [state, setState] = useState({\n  show_message: false,\n  show_error_on_dropdown: false,\n  show_error_on_passwordInput: false,\n});\n\n// Hashing function\nfunction hash(text) {\n  var hashed = \"\";\n  for (var i = 0; i < text.length; i++) {\n    // console.log(text.charAt(i), \"=\", text.charCodeAt(i));\n    hashed += text.charCodeAt(i);\n  }\n  //   console.log(hashed);\n  return hashed;\n}\n\n// Check the entered passcode if it is correct\nfunction checkPasscode() {\n  const hashedPasscode = hash(passcodeEntered);\n  if (hashedPasscode === voteToRender.passcode) {\n    console.log(\"true\");\n    setOpened(true);\n    return true;\n  } else {\n    console.log(\"false\");\n    setState({\n      ...state,\n      show_error_on_passwordInput: true,\n    });\n    return false;\n  }\n}\n\n// Users that already voted\nconst [voted, setVoted] = useState([1]);\n\n// Function for voting\nfunction vote() {\n  if (candidate > 0 && party > 0) {\n    // console.log(accountId);\n    // console.log(voted);\n    // setCandidates([...candidates]);\n    setState({\n      ...state,\n      show_message: true,\n    });\n    // Update\n    // !!!\n    setVoteToRender((vote) => ({\n      ...vote,\n      candidates: vote.candidates.map((c, i) =>\n        i === candidate - 1 ? { ...c, votes: c.votes + 1 } : c\n      ),\n      voters: vote.voters.concat(accountId),\n    }));\n  } else {\n    // Set an error on the dropdown\n    setState({\n      ...state,\n      show_error_on_dropdown: true,\n    });\n  }\n}\n\n// Update the value of the dropdowns when changed\nfunction updateDropdown(e) {\n  setCandidate(e.target.value);\n  setparty(e.target.value);\n  // Remove the error on the dropdown\n  setState({\n    ...state,\n    show_error_on_dropdown: false,\n  });\n}\n\n// Get the current date and time\nfunction getDateTime() {\n  var now = new Date();\n  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());\n  return now.toISOString().slice(0, 16);\n}\n\n//  Format the date and time (January 7, 2024 at 5:57 PM)\nfunction formatDateTime(dateTimeString) {\n  // Assuming you have a date-time input with the format \"YYYY-MM-DDTHH:mm\" as a string\n  const dateTime = new Date(dateTimeString);\n\n  // Formatting the date and time in 12-hour format\n  const formattedDateTime = dateTime.toLocaleString(\"en-US\", {\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n    hour: \"numeric\",\n    minute: \"numeric\",\n    hour12: true, // Set to true for 12-hour format\n  });\n\n  return formattedDateTime;\n}\n\n// check if the vote is ongoing\nfunction isOngoing() {\n  return voteToRender.closeTime !== \"\"\n    ? Date.parse(voteToRender.openTime) <= Date.parse(getDateTime()) &&\n        Date.parse(voteToRender.closeTime) > Date.parse(getDateTime())\n    : Date.parse(voteToRender.openTime) <= Date.parse(getDateTime());\n}\nconst [ongoing, setOngoing] = useState(isOngoing());\n\n// // Re check if it is ongoing every 1 sec\nuseEffect(() => {\n  const interval = setInterval(() => {\n    setOngoing(isOngoing());\n  }, 1000);\n  return () => clearInterval(interval);\n}, [voteToRender]);\n\nconst secText = styled.h3`\n    text-align: center;\n`;\nreturn (\n  <>\n    {accountId ? (\n      <Widget\n        src=\"abnakore.near/widget/Wrapper\"\n        props={{\n          body: (\n            <div className=\"main-body\">\n              {/* Check if the vote exists(i.e allVotes[voteId] exists) */}\n              {voteToRender ? (\n                <div className=\"two-sides\">\n                  {/* The Aside bar that helps in quick navigation btw pages */}\n                  <Widget\n                    src=\"abnakore.near/widget/Aside\"\n                    props={{ objs: pages, active: \"/\" }}\n                  />\n\n                  {/* Check if the vote is ongoing */}\n                  {ongoing === true ? (\n                    // Check if the vote has password\n                    voteToRender.passcode === \"\" || opened ? (\n                      // Check if the vote reached to its voters limit\n                      voteToRender.limit === \"\" ||\n                      (voteToRender.limit !== \"\" &&\n                        voteToRender.limit > voteToRender.voters.length) ? (\n                        <div className=\"body-contents\">\n                          <i>\n                            <svg\n                              width=\"64px\"\n                              height=\"64px\"\n                              viewBox=\"0 0 24 24\"\n                              fill=\"none\"\n                              xmlns=\"http://www.w3.org/2000/svg\"\n                            >\n                              <g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"></g>\n                              <g\n                                id=\"SVGRepo_tracerCarrier\"\n                                stroke-linecap=\"round\"\n                                stroke-linejoin=\"round\"\n                              ></g>\n                              <g id=\"SVGRepo_iconCarrier\">\n                                <path\n                                  d=\"M4 6H20M4 12H20M4 18H20\"\n                                  stroke=\"#fefefe\"\n                                  stroke-width=\"2\"\n                                  stroke-linecap=\"round\"\n                                  stroke-linejoin=\"round\"\n                                ></path>\n                              </g>\n                            </svg>\n                          </i>\n                          <h1>{voteToRender.name}</h1>\n                          <p\n                            style={{\n                              textAlign: \"center\",\n                              padding: \"10px 20px\",\n                            }}\n                          >\n                            {voteToRender.desc}\n                          </p>\n                          <p\n                            style={{\n                              color: \"green\",\n                              display: voteToRender.voters.includes(accountId)\n                                ? \"block\"\n                                : \"none\",\n                            }}\n                          >\n                            You Have Succesfully Voted\n                          </p>\n                          <div className=\"card\">\n                            <div className=\"flex\">\n                              <select\n                                disabled={\n                                  voteToRender.voters.includes(accountId)\n                                    ? true\n                                    : false\n                                }\n                                className={`drop-down ${\n                                  state.show_error_on_dropdown ? \"error\" : \"\"\n                                }`}\n                                value={candidate}\n                                onChange={updateDropdown}\n                                name=\"candidate\"\n                                required\n                              >\n                                <option className=\"option\" value={0}>\n                                  Select by Candidate\n                                </option>\n                                {voteToRender.candidates.map((candidate, i) => (\n                                  <option\n                                    className=\"option\"\n                                    key={candidate.id}\n                                    value={i + 1}\n                                  >\n                                    {candidate.name}\n                                  </option>\n                                ))}\n                              </select>\n                              OR\n                              <select\n                                disabled={\n                                  voteToRender.voters.includes(accountId)\n                                    ? true\n                                    : false\n                                }\n                                className={`drop-down ${\n                                  state.show_error_on_dropdown ? \"error\" : \"\"\n                                }`}\n                                value={party}\n                                onChange={updateDropdown}\n                                name=\"party\"\n                                required\n                              >\n                                <option className=\"option\" value={0}>\n                                  Select by Party\n                                </option>\n                                {voteToRender.parties\n                                  .filter((party) =>\n                                    voteToRender.candidates\n                                      .map((c) => c.party)\n                                      .includes(party.acronym)\n                                  )\n                                  .map((party, i) => (\n                                    <option\n                                      className=\"option\"\n                                      key={party.acronym}\n                                      value={i + 1}\n                                    >\n                                      {party.name} ({party.acronym})\n                                    </option>\n                                  ))}\n                              </select>\n                            </div>\n                            <button\n                              disabled={\n                                voteToRender.voters.includes(accountId)\n                                  ? true\n                                  : false\n                              }\n                              onClick={vote}\n                            >\n                              Vote\n                            </button>\n\n                            <p\n                              id=\"thanks\"\n                              className={`read-the-docs ${\n                                state.show_message ? \"\" : \"hide\"\n                              }`}\n                            >\n                              Thank you for voting\n                              {voteToRender.candidates[candidate - 1].name}\n                            </p>\n                          </div>\n                        </div>\n                      ) : (\n                        <div className=\"body-contents\">\n                          <secText>\n                            Sorry the max number of voters({voteToRender.limit})\n                            has been reached\n                          </secText>\n                        </div>\n                      )\n                    ) : (\n                      <div className=\"body-contents\">\n                        <div className=\"form\">\n                          <secText>Please Enter Passcode</secText>\n                          <p\n                            className=\"error\"\n                            style={{\n                              color: \"red\",\n                              display: state.show_error_on_passwordInput\n                                ? \"block\"\n                                : \"none\",\n                              textAlign: \"center\",\n                            }}\n                          >\n                            The Password you entered is incorrect\n                          </p>\n                          <Widget\n                            src=\"abnakore.near/widget/Input.jsx\"\n                            props={{\n                              type: \"password\",\n                              placeholder: \"Enter Passcode\",\n                              required: true,\n                              otherAttributes: {\n                                value: passcodeEntered,\n                                autoFocus: true,\n                                onKeyPress: (e) => {\n                                  if (e.key === \"Enter\") {\n                                    checkPasscode();\n                                  }\n                                },\n                                onChange: (e) => {\n                                  setPasscodeEntered(e.target.value);\n                                },\n                              },\n                            }}\n                          />\n                          <button onClick={checkPasscode}>Submit</button>\n                        </div>\n                      </div>\n                    )\n                  ) : (\n                    <div className=\"body-contents\">\n                      {voteToRender.closeTime !== \"\"\n                        ? Date.parse(voteToRender.openTime) <=\n                            Date.parse(getDateTime()) &&\n                          Date.parse(voteToRender.closeTime) >\n                            Date.parse(getDateTime())\n                        : Date.parse(voteToRender.openTime) <=\n                          Date.parse(getDateTime())}\n                      {/* If the vote has not been started */}\n                      {Date.parse(voteToRender.openTime) >\n                      Date.parse(getDateTime()) ? (\n                        <>\n                          <h1>\n                            This vote will start on: <br />\n                          </h1>\n                          <h3>{formatDateTime(voteToRender.openTime)}</h3>\n                        </>\n                      ) : (\n                        <>\n                          <h1>\n                            The vote has been ended on: <br />\n                          </h1>\n                          <h3>{formatDateTime(voteToRender.closeTime)}</h3>\n                        </>\n                      )}\n                    </div>\n                  )}\n                </div>\n              ) : (\n                <div className=\"body-contents\">\n                  <h1>Vote Doesn't exist</h1>\n                </div>\n              )}\n            </div>\n          ),\n        }}\n      />\n    ) : (\n      <Widget src=\"abnakore.near/widget/SignIn.jsx\" props={props} />\n    )}\n  </>\n);\n", "metadata": {"fork_of": "abnakore.near/widget/App.jsx@110746268"}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/abnakore.near/widget/App.jsx", "fact_widget_deployments_id": "198de62807a688c119ad703735423029", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 13}