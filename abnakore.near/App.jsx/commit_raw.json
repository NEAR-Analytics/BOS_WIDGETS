{"tx_hash": "7gfXsSk3bPDn3w45DGzgf8wfjnVGav8Kmnq6y8YYPrKp", "action_id_social": "2i6xw7rPjUS6WbEht7ABFehCn93f9QZyKCyXrP9XdVpq-0-widget", "block_id": 118891922, "block_timestamp": "2024-05-14T08:54:03.570Z", "signer_id": "abnakore.near", "widget_name": "App.jsx", "source_code": "// Get the user's accountId\nconst accountId = context.accountId;\n// https://lh3.googleusercontent.com/bard/APmgjFuZWsaz_o97xrT2glKR2ZkehWocnVMZLDGaMQYqaiBpc4_jJibMhhrERiLR5G9cfexuxPUngtq3XeWlWme_tbHMdep04y7fNOJlPNJy7K2BM2NRQy78oFzQCSzgBDZf7dUuiuN2_dbRV6aiVJOe3_4tXyBNvj7NErzEFPRgwGNsyKdTgq3T-1rJCvv76lN75HuL09zHeDdw_SQXHjVHWT2FzY563BaiDVpiIQMiP0q8JNGHjC9TlFhb2EX0LlLQTZJhjYxE4vuVcQWcf2B1AydA72UvTB3pQGMM-sNdzNyJUQddmd0RanSejz9BeosxU-b3fZxAcikT2UJzZ_Q\n\n// Declaring variables\nconst voteId = props.vote && props.vote;\n// const voteId = 113239184;\n\n// All the votes\nconst allVotes = Social.index(\"voteChainTest\", \"vote\")\n  ? Social.index(\"voteChainTest\", \"vote\")\n  : [];\nconst otherCandidates = Social.index(\"voteChainTest\", \"candidate\")\n  ? Social.index(\"voteChainTest\", \"candidate\")\n  : [];\nconst otherParties = Social.index(\"voteChainTest\", \"party\")\n  ? Social.index(\"voteChainTest\", \"party\")\n  : [];\nconst votes = Social.index(\"voteChainTest\", \"votes\")\n  ? Social.index(\"voteChainTest\", \"votes\")\n  : [];\n\n// Get the watchlist\nconst watchlistData = Social.get(`${accountId}/voteChain_watchlist`);\nconst [watchlist, setWatchlist] = useState([]);\nuseEffect(() => {\n  if (watchlistData === undefined) {\n    setWatchlist([]);\n  } else {\n    setWatchlist(JSON.parse(watchlistData));\n  }\n}, [watchlistData]);\n\n// Set the value of votetorender by adding other parties and candidates to it\nfunction getValue() {\n  console.log(otherCandidates, \"this\");\n  var temp = allVotes.find((vote) => vote.blockHeight === voteId);\n  var votesOnThis = votes.filter(\n    (vote) => vote.value.voteId === voteId && vote.value.by && vote.value.party\n  );\n  console.log(temp, \"temp\");\n  return {\n    ...temp,\n    value: {\n      ...temp.value,\n      parties: temp.value.parties.concat(\n        otherParties\n          .filter(\n            (party) =>\n              party.value.voteId === voteId &&\n              party.value.name &&\n              party.value.acronym\n          )\n          .map((party) => ({\n            name: party.value.name,\n            acronym: party.value.acronym,\n          }))\n      ),\n      candidates: temp.value.candidates\n        .concat(\n          // Add other candidates to the list of all candidates\n          otherCandidates\n            .filter(\n              (candidate) =>\n                // Get only the candidates of the vote and vreified\n                candidate.value.voteId === voteId &&\n                candidate.value.name &&\n                candidate.value.party &&\n                candidate.value.role\n            )\n            .map((c) => c.value)\n        )\n        .map(\n          // This put the number of votes of the candidate\n          (cand, i) => ({\n            ...cand,\n            votes: votesOnThis.filter((vote) => vote.value.party === cand.party)\n              .length,\n          })\n        ),\n      voters: votesOnThis.map((vote) => vote.value.by),\n    },\n  };\n}\nconst [voteToRender, setVoteToRender] = useState(getValue());\n\n// Get all the votes\nuseEffect(() => {\n  // Set the vote to be rendered\n  setVoteToRender(getValue());\n  console.log(voteToRender, allVotes, \"votesData\");\n}, [allVotes]);\n\n// Pages that will be displayed in the aside\nconst [pages, setPages] = useState([]);\n// Add admin pages if the user is the creator of the vote\nuseEffect(() => {\n  console.log(\n    \"Is Admin?\",\n    voteToRender.value.creator,\n    voteToRender.blockHeight,\n    accountId,\n    voteToRender.value.creator === accountId,\n    props\n  );\n  if (voteToRender.value.creator === accountId) {\n    setPages([\n      {\n        name: \"Voting Page\",\n        link: `https://near.org/abnakore.near/widget/App.jsx?vote=${voteToRender.blockHeight}`,\n      },\n      {\n        name: \"Result\",\n        link: `https://near.org/abnakore.near/widget/Result.jsx?vote=${voteToRender.blockHeight}`,\n      },\n      {\n        name: \"Admin Home\",\n        link: `https://near.org/abnakore.near/widget/AdminHome?vote=${voteToRender.blockHeight}`,\n      },\n      {\n        name: \"Manage Candidates\",\n        link: `https://near.org/abnakore.near/widget/ManageCandidates?vote=${voteToRender.blockHeight}`,\n      },\n      {\n        name: \"Mange Parties\",\n        link: `https://near.org/abnakore.near/widget/ManageParties?vote=${voteToRender.blockHeight}`,\n      },\n    ]);\n  } else {\n    setPages([\n      {\n        name: \"Voting Page\",\n        link: `https://near.org/abnakore.near/widget/App.jsx?vote=${voteToRender.blockHeight}`,\n      },\n      {\n        name: \"Result\",\n        link: `https://near.org/abnakore.near/widget/Result.jsx?vote=${voteToRender.blockHeight}`,\n      },\n    ]);\n  }\n}, [voteToRender]);\n\n// other variables\nconst [opened, setOpened] = useState(false);\nconst [state, setState] = useState({\n  show_message: false,\n  show_error_on_dropdown: false,\n  show_error_on_passwordInput: false,\n});\nconst [passcodeEntered, setPasscodeEntered] = useState(\"\");\nconst [candidate, setCandidate] = useState(\"\");\nconst [party, setparty] = useState(0);\n\n// Hashing function\nfunction hash(text) {\n  var hashed = \"\";\n  for (var i = 0; i < text.length; i++) {\n    // console.log(text.charAt(i), \"=\", text.charCodeAt(i));\n    hashed += text.charCodeAt(i);\n  }\n  //   console.log(hashed);\n  return hashed;\n}\n\n// Check the entered passcode if it is correct\nfunction checkPasscode() {\n  const hashedPasscode = hash(passcodeEntered);\n  if (hashedPasscode === voteToRender.value.passcode) {\n    console.log(\"true\");\n    setOpened(true);\n    return true;\n  } else {\n    console.log(\"false\");\n    setState({\n      ...state,\n      show_error_on_passwordInput: true,\n    });\n    return false;\n  }\n}\n\n// Function for voting\nfunction vote() {\n  console.log(candidate, party, \"CP\");\n  if (candidate !== \"\" && party !== \"\") {\n    setState({\n      ...state,\n      show_message: true,\n    });\n\n    // Update\n    // !!!\n    // Social.set({\n    //   index: {\n    //     voteChainTest: JSON.stringify({\n    //       key: \"votes\",\n    //       value: {\n    //         by: accountId,\n    //         voteId: voteId,\n    //         party: party,\n    //       },\n    //     }),\n    //   },\n    // });\n    return {\n      index: {\n        voteChainTest: JSON.stringify({\n          key: \"votes\",\n          value: {\n            by: accountId,\n            voteId: voteId,\n            party: party,\n          },\n        }),\n      },\n    };\n  } else {\n    // Set an error on the dropdown\n    setState({\n      ...state,\n      show_error_on_dropdown: true,\n    });\n    return;\n  }\n}\n\n// Update the value of the dropdowns when changed\nfunction updateDropdown(e) {\n  setCandidate(e.target.value);\n  setparty(e.target.value);\n  console.log(\n    e.target.value,\n    voteToRender.value.candidates[e.target.value],\n    candidate\n  );\n  // Remove the  error on the dropdown\n  setState({\n    ...state,\n    show_error_on_dropdown: false,\n  });\n}\n\n// Get the current date and time\nfunction getDateTime() {\n  var now = new Date();\n  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());\n  return now.toISOString().slice(0, 16);\n}\n\n//  Format the date and time (January 7, 2024 at 5:57 PM)\nfunction formatDateTime(dateTimeString) {\n  // Assuming you have a date-time input with the format \"YYYY-MM-DDTHH:mm\" as a string\n  const dateTime = new Date(dateTimeString);\n\n  // Formatting the date and time in 12-hour format\n  const formattedDateTime = dateTime.toLocaleString(\"en-US\", {\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n    hour: \"numeric\",\n    minute: \"numeric\",\n    hour12: true, // Set to true for 12-hour format\n  });\n\n  return formattedDateTime;\n}\n\n// check if the vote is ongoing\nfunction isOngoing() {\n  return voteToRender.value.closeTime !== \"\"\n    ? Date.parse(voteToRender.value.openTime) <= Date.parse(getDateTime()) &&\n        Date.parse(voteToRender.value.closeTime) > Date.parse(getDateTime())\n    : Date.parse(voteToRender.value.openTime) <= Date.parse(getDateTime());\n}\nconst [ongoing, setOngoing] = useState(isOngoing());\n// Re check if it is ongoing every 1 sec\nuseEffect(() => {\n  const interval = setInterval(() => {\n    setOngoing(isOngoing());\n  }, 1000);\n  return () => clearInterval(interval);\n}, [voteToRender]);\n\n// Add the vote to watchlist\nfunction addToWatchlist() {\n  if (watchlist.includes(voteId)) {\n    // remove from watchlist\n    Social.set({\n      voteChain_watchlist: watchlist.filter((item) => item !== voteId),\n    });\n  } else {\n    // Add to watchlist\n    Social.set({ voteChain_watchlist: watchlist.concat(voteId) });\n  }\n}\n\nconst secText = styled.h3`\n  text-align: center;\n`;\nreturn (\n  <>\n    {accountId ? (\n      <Widget\n        src=\"abnakore.near/widget/Wrapper\"\n        props={{\n          body: (\n            <div className=\"main-body\">\n              {/* Check if the vote exists(i.e allVotes[voteId] exists) */}\n              {voteToRender ? (\n                <div className=\"two-sides\">\n                  {/* The Aside bar that helps in quick navigation btw pages */}\n                  <Widget\n                    src=\"abnakore.near/widget/Aside\"\n                    props={{ objs: pages, active: \"/\" }}\n                  />\n\n                  {/* Check if the vote is ongoing */}\n                  {ongoing === true ? (\n                    // Check if the vote has password\n                    voteToRender.value.passcode === \"\" || opened ? (\n                      // Check if the vote reached to its voters limit\n                      voteToRender.value.limit === \"\" ||\n                      (voteToRender.value.limit !== \"\" &&\n                        voteToRender.value.limit >\n                          voteToRender.value.voters.length) ? (\n                        <div className=\"body-contents\">\n                          <button onClick={addToWatchlist}>\n                            {watchlist.includes(voteId)\n                              ? \"Remove from watchlist\"\n                              : \"Add to watchlist\"}\n                          </button>\n                          <i>\n                            <svg\n                              width=\"64px\"\n                              height=\"64px\"\n                              viewBox=\"0 0 24 24\"\n                              fill=\"none\"\n                              xmlns=\"http://www.w3.org/2000/svg\"\n                            >\n                              <g id=\"SVGRepo_bgCarrier\" stroke-width=\"0\"></g>\n                              <g\n                                id=\"SVGRepo_tracerCarrier\"\n                                stroke-linecap=\"round\"\n                                stroke-linejoin=\"round\"\n                              ></g>\n                              <g id=\"SVGRepo_iconCarrier\">\n                                <path\n                                  d=\"M4 6H20M4 12H20M4 18H20\"\n                                  stroke=\"#fefefe\"\n                                  stroke-width=\"2\"\n                                  stroke-linecap=\"round\"\n                                  stroke-linejoin=\"round\"\n                                ></path>\n                              </g>\n                            </svg>\n                          </i>\n                          <h1>{voteToRender.value.name}</h1>\n                          <p\n                            style={{\n                              textAlign: \"justify\",\n                              padding: \"10px 20px\",\n                            }}\n                          >\n                            {voteToRender.value.desc}\n                          </p>\n                          <p\n                            style={{\n                              color: \"green\",\n                              display: voteToRender.value.voters.includes(\n                                accountId\n                              )\n                                ? \"block\"\n                                : \"none\",\n                            }}\n                          >\n                            You Have Succesfully Voted\n                          </p>\n                          <div className=\"card\">\n                            <div className=\"flex\">\n                              <select\n                                disabled={\n                                  voteToRender.value.voters.includes(accountId)\n                                    ? true\n                                    : false\n                                }\n                                className={`drop-down ${\n                                  state.show_error_on_dropdown ? \"error\" : \"\"\n                                }`}\n                                value={candidate}\n                                onChange={updateDropdown}\n                                name=\"candidate\"\n                                required\n                              >\n                                <option className=\"option\" value={\"\"}>\n                                  Select by Candidate\n                                </option>\n                                {voteToRender.value.candidates.map(\n                                  (candidate, i) => (\n                                    <option\n                                      className=\"option\"\n                                      key={candidate.id}\n                                      value={candidate.party}\n                                    >\n                                      {candidate.name}\n                                    </option>\n                                  )\n                                )}\n                              </select>\n                              OR\n                              <select\n                                disabled={\n                                  voteToRender.value.voters.includes(accountId)\n                                    ? true\n                                    : false\n                                }\n                                className={`drop-down ${\n                                  state.show_error_on_dropdown ? \"error\" : \"\"\n                                }`}\n                                value={party}\n                                onChange={updateDropdown}\n                                name=\"party\"\n                                required\n                              >\n                                <option className=\"option\" value={\"\"}>\n                                  Select by Party\n                                </option>\n                                {voteToRender.value.parties\n                                  .filter((party) =>\n                                    voteToRender.value.candidates\n                                      .map((c) => c.party)\n                                      .includes(party.acronym)\n                                  )\n                                  .map((party, i) => (\n                                    <option\n                                      className=\"option\"\n                                      key={party.acronym}\n                                      value={party.acronym}\n                                    >\n                                      {party.name} ({party.acronym})\n                                    </option>\n                                  ))}\n                              </select>\n                            </div>\n                            <CommitButton\n                              disabled={\n                                voteToRender.value.voters.includes(accountId)\n                                  ? true\n                                  : false\n                              }\n                              data={vote}\n                              //   onClick={vote}\n                            >\n                              Vote\n                            </CommitButton>\n\n                            <p\n                              id=\"thanks\"\n                              className={`${state.show_message ? \"\" : \"hide\"}`}\n                            >\n                              Thank you for voting\n                            </p>\n                          </div>\n                        </div>\n                      ) : (\n                        <div className=\"body-contents\">\n                          <secText>\n                            Sorry the max number of voters(\n                            {voteToRender.value.limit}) has been reached\n                          </secText>\n                        </div>\n                      )\n                    ) : (\n                      <div className=\"body-contents\">\n                        <div className=\"form\">\n                          <secText>Please Enter Passcode</secText>\n                          <p\n                            className=\"error\"\n                            style={{\n                              color: \"red\",\n                              display: state.show_error_on_passwordInput\n                                ? \"block\"\n                                : \"none\",\n                              textAlign: \"center\",\n                            }}\n                          >\n                            The Password you entered is incorrect\n                          </p>\n                          <Widget\n                            src=\"abnakore.near/widget/Input.jsx\"\n                            props={{\n                              type: \"password\",\n                              placeholder: \"Enter Passcode\",\n                              required: true,\n                              otherAttributes: {\n                                value: passcodeEntered,\n                                autoFocus: true,\n                                onKeyPress: (e) => {\n                                  if (e.key === \"Enter\") {\n                                    checkPasscode();\n                                  }\n                                },\n                                onChange: (e) => {\n                                  setPasscodeEntered(e.target.value);\n                                },\n                              },\n                            }}\n                          />\n                          <button onClick={checkPasscode}>Submit</button>\n                        </div>\n                      </div>\n                    )\n                  ) : (\n                    <div className=\"body-contents\">\n                      {voteToRender.value.closeTime !== \"\"\n                        ? Date.parse(voteToRender.value.openTime) <=\n                            Date.parse(getDateTime()) &&\n                          Date.parse(voteToRender.value.closeTime) >\n                            Date.parse(getDateTime())\n                        : Date.parse(voteToRender.value.openTime) <=\n                          Date.parse(getDateTime())}\n                      {/* If the vote has not been started */}\n                      {Date.parse(voteToRender.value.openTime) >\n                      Date.parse(getDateTime()) ? (\n                        <>\n                          <h1>\n                            This vote will start on: <br />\n                          </h1>\n                          <h3>{formatDateTime(voteToRender.value.openTime)}</h3>\n                        </>\n                      ) : (\n                        <>\n                          <h1>\n                            The vote has been ended on: <br />\n                          </h1>\n                          <h3>\n                            {formatDateTime(voteToRender.value.closeTime)}\n                          </h3>\n                        </>\n                      )}\n                    </div>\n                  )}\n                </div>\n              ) : (\n                <div className=\"body-contents\">\n                  <h1>Vote Doesn't exist</h1>\n                </div>\n              )}\n            </div>\n          ),\n        }}\n      />\n    ) : (\n      <Widget src=\"abnakore.near/widget/SignIn.jsx\" props={props} />\n    )}\n  </>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/abnakore.near/widget/App.jsx", "fact_widget_deployments_id": "24821d005b26770a31e797122c2e8d92", "inserted_timestamp": "2024-05-14T10:51:19.511Z", "modified_timestamp": "2024-05-14T10:51:19.511Z", "__row_index": 0}