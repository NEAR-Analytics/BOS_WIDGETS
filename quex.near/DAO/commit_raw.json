{"tx_hash": "877QNnr4LirgnALKyJkzWqRfbSQfBhAwhMpqHidUvxcw", "action_id_social": "J4gN4oHsCqwKUTv6XJv6ENeErHq8mmxPsZHpeh3L2DtX-0-widget", "block_id": 105363706, "block_timestamp": "2023-11-10T09:49:32.841Z", "signer_id": "quex.near", "widget_name": "DAO", "source_code": "State.init({ txHistory: [], viewNonce: 0 });\nif (!context.accountId) {\n  return (\n    <>\n      Please create an account on{\" \"}\n      <a href=\"https://wallet.near.org/\">https://wallet.near.org/</a> and login\n    </>\n  );\n}\n\nfunction getNearBalance(accountId) {\n  const options = {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      jsonrpc: \"2.0\",\n      id: \"dontcare\",\n      method: \"query\",\n      params: {\n        request_type: \"view_account\",\n        finality: \"final\",\n        account_id: accountId,\n      },\n    }),\n  };\n  asyncFetch(\"https://rpc.mainnet.near.org\", options).then((res) => {\n    const { amount, storage_usage } = res.body.result;\n    const COMMON_MIN_BALANCE = 0.05;\n\n    let newBalance = \"-\";\n    if (amount) {\n      const availableBalance = Big(amount || 0).minus(\n        Big(storage_usage).mul(Big(10).pow(19))\n      );\n      const balance = availableBalance\n        .div(Big(10).pow(24))\n        .minus(COMMON_MIN_BALANCE);\n      newBalance = balance.lt(0) ? \"0\" : balance.toFixed(5, BIG_ROUND_DOWN);\n    }\n    State.update({\n      nearBalance: newBalance,\n    });\n  });\n}\n\nconst getPublicKeyUrl = \"https://quex.nearspace.info/pk\";\nconst contractId = \"hack.quex.near\";\ngetNearBalance(contractId);\n\nconst ChatBox = styled.div`\n.message-chat {\n  width: 100%;\n  overflow: hidden;\n}\n\n.chat-body {\n  width: calc(100% + 17px);\n  min-height: 290px;\n  background-color: #fbfcff;\n  margin-bottom: 30px;\n  padding: 30px 5px 5px 5px;\n  overflow-y: scroll;\n}\n\n.message {\n  position: relative;\n  width: 100%;\n}\n\n.message br {\n  clear: both;\n}\n\n.message .message-body {\n  position: relative;\n  width: auto;\n  max-width: calc(100% - 150px);\n  float: left;\n  background-color: #fff;\n  border-radius: 4px;\n  border: 1px solid #dbe3e8;\n  margin: 0 5px 20px 15px;\n  color: #788288;\n}\n\n.message:after {\n  content: \"\";\n  position: absolute;\n  top: 11px;\n  left: 63px;\n  float: left;\n  z-index: 100;\n  border-left: none;\n }\n\n.message:before {\n  content: \"\";\n  position: absolute;\n  top: 10px;\n  left: 62px;\n  float: left;\n  z-index: 99;\n  \n  border-left: none;\n  }\n\n.message .medium-image {\n  float: left;\n  margin-left: 10px;\n}\n\n.message .message-info {\n  width: 100%;\n  height: 22px;\n}\n\n.message .message-info > h5 > i {\n  font-size: 11px;\n  font-weight: 700;\n  margin: 0 2px 0 0;\n  color: #a2b8c5;\n}\n\n.message .message-info > h5 {\n  color: #a2b8c5;\n  margin: 8px 0 0 0;\n  font-size: 12px;\n  float: right;\n  padding-right: 10px;\n}\n\n.message .message-info > h4 {\n  font-size: 14px;\n  font-weight: 600;\n  margin: 7px 13px 0 10px;\n  color: #65addd;\n  float: left;\n}\n\n.message hr {\n  margin: 4px 2%;\n  width: 96%;\n  opacity: 0.75;\n}\n\n.message .message-text {\n  text-align: left;\n  padding: 3px 13px 10px 13px;\n  font-size: 14px;\n}\n\n.message.my-message .message-body {\n  float: right;\n  margin: 0 15px 20px 5px;\n}\n\n.message.my-message:after {\n  content: \"\";\n  position: absolute;\n  top: 11px;\n  left: auto;\n  right: 63px;\n  float: left;\n  z-index: 100;\n  border-top: 10px solid transparent;\n  border-left: 13px solid #fff;\n  border-bottom: 10px solid transparent;\n  border-right: none;\n}\n\n.message.my-message:before {\n  content: \"\";\n  position: absolute;\n  top: 10px;\n  left: auto;\n  right: 62px;\n  float: left;\n  z-index: 99;\n  border-top: 11px solid transparent;\n  border-left: 13px solid #dbe3e8;\n  border-bottom: 11px solid transparent;\n  border-right: none;\n}\n\n.message.my-message .medium-image {\n  float: right;\n  margin-left: 5px;\n  margin-right: 10px;\n}\n\n.message.my-message .message-info > h5 {\n  float: left;\n  padding-left: 10px;\n  padding-right: 0;\n}\n\n.message.my-message .message-info > h4 {\n  float: right;\n}\n\n.message.info .message-body {\n  background-color: #2da9e9;\n  border: 1px solid #2da9e9;\n  color: #fff;\n}\n\n\n.message.success .message-body {\n  background-color: #0ec8a2;\n  border: 1px solid #0ec8a2;\n  color: #fff;\n}\n\n\n.message.warning .message-body {\n  background-color: #ff9e2a;\n  border: 1px solid #ff9e2a;\n  color: #fff;\n}\n\n\n\n.message.danger .message-body {\n  background-color: #f95858;\n  border: 1px solid #f95858;\n  color: #fff;\n}\n\n.message.dark .message-body {\n  background-color: #314557;\n  border: 1px solid #314557;\n  color: #fff;\n}\n\n\n.message.info .message-info > h4, .message.success .message-info > h4,\n.message.warning .message-info > h4, .message.danger .message-info > h4,\n.message.dark .message-info > h4 {\n  color: #fff;\n}\n\n.message.info .message-info > h5, .message.info .message-info > h5 > i,\n.message.success .message-info > h5, .message.success .message-info > h5 > i,\n.message.warning .message-info > h5, .message.warning .message-info > h5 > i,\n.message.danger .message-info > h5, .message.danger .message-info > h5 > i,\n.message.dark .message-info > h5, .message.dark .message-info > h5 > i {\n  color: #fff;\n  opacity: 0.9;\n}\n\n.chat-footer {\n  position: relative;\n  width: 100%;\n  padding: 0 80px;\n}\n\n.chat-footer .send-message-text {\n  position: relative;\n  display: block;\n  width: 100%;\n  min-height: 55px;\n  max-height: 75px;\n  background-color: #fff;\n  border-radius: 5px;\n  padding: 5px 95px 5px 10px;\n  font-size: 13px;\n  resize: vertical;\n  outline: none;\n  border: 1px solid #e0e6eb;\n}\n\n.chat-footer .send-message-button {\n  display: block;\n  position: absolute;\n  width: 35px;\n  height: 35px;\n  right: 100px;\n  top: 0;\n  bottom: 0;\n  margin: auto;\n  border: 1px solid rgba(0,0,0,0.05);\n  outline: none;\n  font-weight: 600;\n  border-radius: 50%;\n  padding: 0;\n}\n\n.chat-footer .send-message-button > i {\n  font-size: 16px;\n  margin: 0 0 0 -2px;\n}\n\n.chat-footer label.upload-file input[type=\"file\"] {\n  position: fixed;\n  top: -1000px;\n}\n\n.chat-footer .upload-file {\n  display: block;\n  position: absolute;\n  right: 150px;\n  height: 30px;\n  font-size: 20px;\n  top: 0;\n  bottom: 0;\n  margin: auto;\n  opacity: 0.25;\n}\n\n.chat-footer .upload-file:hover {\n  opacity: 1;\n}\n`;\n\nif (!state.publicKey) {\n  const publicKeyRequest = fetch(getPublicKeyUrl);\n  if (!publicKeyRequest.ok) {\n    return \"Loading Public Key\";\n  } else {\n    State.update({ publicKey: JSON.parse(publicKeyRequest.body)?.pk ?? \"NaN\" });\n  }\n}\n\nconst messages = Near.view(contractId, \"getMessages\", {\n  account_id: context.accountId,\n  viewNonce: state.viewNonce,\n});\nconsole.log(\"getMessages\", messages, context.accountId);\n\nconst serverUrl = \"https://quex.nearspace.info\";\n\nif (props.transactionHashes) {\n  const txToLoad = props.transactionHashes;\n  if (state.txHistory.includes(txToLoad)) {\n    console.log(\"Already loaded\");\n  } else {\n    console.log(\"txhash\", txToLoad);\n\n    const txHistory = state.txHistory;\n    txHistory.push(txToLoad);\n    State.update({ isLoading: true, txToLoad });\n\n    asyncFetch(`${serverUrl}/?txhash=${txToLoad}&pk=${state.publicKey}`).then(\n      (fetchData) => {\n        const txData = fetchData.body;\n        console.log(txData);\n        let viewNonce = state.viewNonce;\n        State.update({\n          response: txData,\n          isLoading: false,\n          txToLoad: \"\",\n          viewNonce: viewNonce + 1,\n          msg: \"\",\n        });\n      }\n    );\n  }\n}\n\nconst Send = () => {\n  Near.call(\n    contractId,\n    \"addRequest\",\n    { msg: state.msg },\n    100000000000000,\n    100000000000000000000000\n  );\n};\n\nconst message1 = (text) => {\n  /* {[\"funded\", \"funded.\"].includes(message[1].toLowerCase()) ? (\n            <span class=\"text-success fw-bold\">\n              CONGRATS! YOU GOT FUNDING! CHECK YOU WALLET!\n            </span>\n          ) : (\n            message[1]\n          )}*/\n  return (\n    <div class=\"message info\">\n      <div class=\"message-body\">\n        <div class=\"message-info\">\n          <h4> Stephen </h4>\n        </div>\n        <hr />\n        <div class=\"message-text\">{text}</div>\n      </div>\n    </div>\n  );\n};\n\nconst message2 = (text) => {\n  return (\n    <div class=\"message my-message\">\n      <div class=\"message-body\">\n        <div class=\"message-body-inner\">\n          <div class=\"message-info\">\n            <h4> {context.accountId} </h4>\n          </div>\n          <hr />\n          <div class=\"message-text\">{text}</div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nreturn (\n  <div>\n    <h1 class=\"pb-3\">\n      <a href=\"/quex.near/widget/Index\">Quex AI AGENT</a>\n    </h1>\n    <div class=\"alert alert-success\">\n      Current Treasury: {state.nearBalance} NEAR\n    </div>\n    <div class=\"alert alert-info\">\n      I am Stephen, an application manager at the Near Protocol Grant program.\n      My role is to validate the grant proposal and provide a response of\n      \"funded\" if the proposal meets our criteria or \"declined\" if it does not.\n      To ensure the proposal aligns with our program's requirements, it must be\n      innovative, decentralized, and valuable to the NEAR ecosystem. I'll ask\n      additional questions about the proposal one by one. Before asking these\n      questions, I will respond with a single word, and I'll make sure the\n      proposal follows our grant program criteria. If a message does not\n      describe the proposal, I'll reply with \"Please, focus on your proposal,\"\n      ask one more question, and then make a decision.\n    </div>\n    <ChatBox class=\"message-chat\">\n      <div class=\"chat-body\">\n        {message1(\"Hi there! How can I help?\")}\n\n        {(messages ?? []).map((message) =>\n          message[0] == \"Bot\" ? message1(message[1]) : message2(message[1])\n        )}\n      </div>\n    </ChatBox>\n    <div class=\"pb-0 mb-0\">\n      <div>Message:</div>\n      <textarea\n        style={{ width: \"500px\", height: \"120px\" }}\n        onChange={(e) => State.update({ msg: e.target.value })}\n      />\n    </div>\n    <div>\n      <small>Use English only</small>\n    </div>\n    <div>\n      <button\n        value=\"Send\"\n        onClick={Send}\n        onChange={(e) => State.update({ msg: e.target.value })}\n      >\n        Send\n      </button>\n    </div>\n    <div class=\"pt-4\">\n      {state.isLoading && <>Loading...</>}\n      {state.isLoading && state.txToLoad && (\n        <>Your pending tx: {state.txToLoad}</>\n      )}\n      {state.response && (\n        <>\n          Verification for debug: {JSON.parse(state.response)[\"logs\"]}\n          Response: <hr />\n          <a\n            target=\"_blank\"\n            href={`https://explorer.near.org/transactions/${\n              JSON.parse(state.response)[\"id\"]\n            }`}\n          >\n            Response Id {JSON.parse(state.response)[\"id\"]}\n          </a>\n        </>\n      )}\n    </div>\n  </div>\n);\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/quex.near/widget/DAO", "fact_widget_deployments_id": "63c80184dd59b7814d3e9d7368bdd3b8", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 1}