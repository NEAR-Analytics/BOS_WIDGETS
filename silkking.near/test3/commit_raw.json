{"tx_hash": "7A8keum4xby9PtUp8Wi9YFQnecvzZJ77zt93D3Du78L1", "action_id_social": "ExLyzZ9gvAhVSRrqH2upg6mxkE9CdCGMuv6B98kbbPKt-0-widget", "block_id": 107215962, "block_timestamp": "2023-12-05T15:46:27.443Z", "signer_id": "silkking.near", "widget_name": "Test3", "source_code": "State.init({ notifications: {} });\r\n\r\nconst widgets = {\r\n  libNotifications: `${context.accountId}/widget/lib.notifications`,\r\n};\r\n\r\nconst imports = { notifications: [\"notify\", \"clg\"] };\r\n\r\nfunction stateUpdate(obj) {\r\n  State.update(obj);\r\n}\r\n\r\n// let libsLoaded = true;\r\n// Object.keys(imports).forEach((library) => {\r\n//   imports[library].forEach((functionCalled) => {\r\n//     if (!state[library][functionCalled]) {\r\n//       libsLoaded = false;\r\n//     }\r\n//   });\r\n// });\r\n\r\n// if (!libsLoaded) {\r\n//   return (\r\n//     <Widget\r\n//       src={`${widgets.libNotifications}`}\r\n//       props={{\r\n//         stateUpdate,\r\n//         imports: imports[\"notifications\"],\r\n//         fatherState: state.notifications,\r\n//       }}\r\n//     />\r\n//   );\r\n// }\r\n\r\nfunction onCommit() {\r\n  State.update({ articleCommited: true, notifications: undefined });\r\n}\r\n\r\nfunction findLastArticle(articles) {\r\n  return articles.find((article) => article.accountId === context.accountId);\r\n}\r\n\r\nconst articles = Social.index(\"test_sayALotArticle_v0.0.2\", \"main\", {\r\n  order: \"desc\",\r\n});\r\n\r\nconst lastArticleFromThisAuthor = articles && findLastArticle(articles);\r\n\r\nif (\r\n  articles &&\r\n  JSON.stringify(state.lastArticleFromThisAuthor) !==\r\n    JSON.stringify(lastArticleFromThisAuthor)\r\n) {\r\n  State.update({ lastArticleFromThisAuthor });\r\n}\r\n\r\nif (state.articleCommited) {\r\n  State.update({\r\n    articleCreated: state.lastArticleFromThisAuthor,\r\n    articleCommited: false,\r\n  });\r\n}\r\n\r\nconsole.log(state);\r\n\r\nfunction notify(type, accountId, url) {\r\n  console.log(\"Goodbai\");\r\n  if (state.notifications.notify) {\r\n    console.log(1);\r\n    state.notifications.notify(type, accountId, url);\r\n  } else {\r\n    console.log(2);\r\n  }\r\n}\r\n\r\nlet notifying = false;\r\nif (state.articleCreated !== undefined && !notifying) {\r\n  notifying = true;\r\n  console.log(\"inside if\", state);\r\n  notify(\r\n    \"mention\",\r\n    `${context.accountId}`,\r\n    `https://near.social/${context.accountId}/widget/SayALot?isTest=t&sharedBlockHeight=${articleCreated.blockHeight}`\r\n  );\r\n}\r\n\r\nfunction makePost() {\r\n  Social.set(\r\n    {\r\n      [\"test_sayALotArticle_v0.0.2\"]: {\r\n        main: `{\"title\":\"Test again TT.TT 3\",\"author\":\"${\r\n          context.accountId\r\n        }\",\"lastEditor\":\"${\r\n          context.accountId\r\n        }\",\"timeLastEdit\":${Date.now()},\"timeCreate\":${Date.now()},\"body\": \"@${\r\n          context.accountId\r\n        }\",\"version\":0,\"navigation_id\":null,\"tags\":{},\"id\":\"${\r\n          context.accountId\r\n        }-${Date.now()}\",\"sbts\":[\"public\"]}`,\r\n      },\r\n      index: {\r\n        [\"test_sayALotArticle_v0.0.2\"]: `{\"key\":\"main\",\"value\":{\"type\":\"md\",\"id\":\"${\r\n          context.accountId\r\n        }-${Date.now()}\"}}`,\r\n      },\r\n    },\r\n    {\r\n      force: true,\r\n      onCommit,\r\n      onCancel,\r\n    }\r\n  );\r\n}\r\n\r\nreturn (\r\n  <div>\r\n    {\r\n      <Widget\r\n        src={`${widgets.libNotifications}`}\r\n        props={{\r\n          stateUpdate,\r\n          imports: imports[\"notifications\"],\r\n          fatherState: state.notifications,\r\n        }}\r\n      />\r\n    }\r\n    <button onClick={makePost}>Make post + Notify mention</button>\r\n    <button onClick={notify}>Notify mention</button>\r\n  </div>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/silkking.near/widget/Test3", "fact_widget_deployments_id": "7773c89628c778bc1dd9cc899f5f1b3c", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}