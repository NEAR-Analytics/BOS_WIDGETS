{"tx_hash": "AFMMg4n46vDj8Bm35ZBzP9DXTC5t88BWDboMoo37TeN4", "action_id_social": "21NzBEdJGsuEureSZE2wMhxu9thUHEy322ULCQdauwPN-0-widget", "block_id": 103817160, "block_timestamp": "2023-10-20T16:35:20.207Z", "signer_id": "silkking.near", "widget_name": "SayALot.lib.article", "source_code": "const { isTest, stateUpdate, functionsToCallByLibrary, callLibs } = props;\r\nconst functionsToCall = functionsToCallByLibrary.article;\r\n\r\n//TODO check if env is still needed since we are not using the whitelist anymore because of the human verification system\r\n\r\nconst prodAction = \"sayALotArticle_v0.0.2\";\r\nconst testAction = `test_${prodAction}`;\r\nconst action = isTest ? testAction : prodAction;\r\n\r\n// const authorForWidget =\r\n//   \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\";\r\n// const authorForWidget = \"sayalot.near\";\r\nconst authorForWidget = \"silkking.near\";\r\nconst libSrcArray = [`${authorForWidget}/widget/SayALot.lib.SBT`];\r\n\r\nState.init({\r\n  libCalls: [],\r\n  libsCalls: { SBT: [] },\r\n  sbt: \"fractal.i-am-human.near - class 1\",\r\n});\r\n\r\nlet resultFunctionsToCallByLibrary = Object.assign(\r\n  {},\r\n  functionsToCallByLibrary\r\n);\r\nlet resultFunctionsToCall = [];\r\n\r\nfunction libStateUpdate(obj) {\r\n  State.update(obj);\r\n}\r\n\r\nfunction setAreValidUsers(accountIds, sbtsNames) {\r\n  const newLibsCalls = Object.assign({}, state.libsCalls);\r\n\r\n  accountIds.forEach((accountId, index) => {\r\n    const isCallPushed =\r\n      newLibsCalls.SBT.find((libCall) => {\r\n        return (\r\n          libCall.functionName === \"isValidUser\" &&\r\n          libCall.props.accountId === accountId\r\n        );\r\n      }) !== undefined;\r\n    const isCallReturned = state[`isValidUser-${accountId}`] !== undefined;\r\n\r\n    if (isCallPushed || isCallReturned) {\r\n      return;\r\n    }\r\n\r\n    newLibsCalls.SBT.push({\r\n      functionName: \"isValidUser\",\r\n      key: `isValidUser-${accountId}`,\r\n      props: {\r\n        accountId,\r\n        sbtsNames,\r\n      },\r\n    });\r\n  });\r\n  State.update({ libsCalls: newLibsCalls });\r\n}\r\n\r\n// const initLibCalls = [\r\n//   {\r\n//     functionName: \"get1\",\r\n//     key: \"test\",\r\n//     props: {},\r\n//   },\r\n//   {\r\n//     functionName: \"getWritersWhitelist\",\r\n//     key: \"writersWhitelist\",\r\n//     props: { env: \"test\" },\r\n//   },\r\n// ];\r\n\r\nfunction canUserCreateArticle(props) {\r\n  const { env, accountId, sbtsNames } = props;\r\n\r\n  setAreValidUsers([accountId], sbtsNames);\r\n  const result = state[`isValidUser-${accountId}`];\r\n\r\n  resultFunctionsToCall = resultFunctionsToCall.filter((call) => {\r\n    const discardCondition =\r\n      call.functionName === \"canUserCreateArticle\" && result !== undefined;\r\n    return !discardCondition;\r\n  });\r\n\r\n  return result;\r\n\r\n  // return getWritersWhitelist(env).includes(accountId);\r\n}\r\n\r\nfunction canUserEditArticle(props) {\r\n  const { article } = props;\r\n\r\n  return article.author === context.accountId;\r\n}\r\n\r\nfunction createArticle(props) {\r\n  const { article, onCommit, onCancel } = props;\r\n\r\n  saveHandler(article, onCommit, onCancel);\r\n\r\n  resultFunctionsToCall = resultFunctionsToCall.filter((call) => {\r\n    return call.functionName !== \"createArticle\";\r\n  });\r\n\r\n  return article;\r\n}\r\n\r\nfunction composeData(article) {\r\n  let data;\r\n  data = {\r\n    [action]: {\r\n      main: JSON.stringify(article),\r\n    },\r\n    index: {\r\n      [action]: JSON.stringify({\r\n        key: \"main\",\r\n        value: {\r\n          type: \"md\",\r\n          id: article.id ?? `${context.accountId}-${Date.now()}`,\r\n        },\r\n      }),\r\n    },\r\n  };\r\n\r\n  // if (tagsArray.length) {\r\n  //   data.index.tag = JSON.stringify(\r\n  //     tagsArray.map((tag) => ({\r\n  //       key: tag,\r\n  //       value: item,\r\n  //     }))\r\n  //   );\r\n  // }\r\n\r\n  return data;\r\n}\r\n\r\nconst saveHandler = (article, onCommit, onCancel) => {\r\n  if (article.title && article.body) {\r\n    const newData = composeData(article);\r\n\r\n    Social.set(newData, {\r\n      force: true,\r\n      onCommit,\r\n      onCancel,\r\n    });\r\n    // onCancel: () => {\r\n    //   State.update({ saving: false });\r\n    // },\r\n  }\r\n};\r\n\r\nfunction getArticlesIndexes() {\r\n  return Social.index(action, \"main\", {\r\n    order: \"desc\",\r\n    subscribe: true,\r\n  });\r\n}\r\n\r\nfunction getArticleBlackListByBlockHeight() {\r\n  return [\r\n    91092435, 91092174, 91051228, 91092223, 91051203, 98372095, 96414482,\r\n    96412953, 103131250,\r\n  ];\r\n}\r\n\r\nfunction getArticleBlackListByRealArticleId() {\r\n  return [\r\n    \"blaze.near-1690410074090\",\r\n    \"blaze.near-1690409577184\",\r\n    \"blaze.near-1690803928696\",\r\n    \"blaze.near-1690803872147\",\r\n    \"blaze.near-1690574978421\",\r\n    \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb-1691703303485\",\r\n    \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb-1691702619510\",\r\n    \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb-1691702487944\",\r\n    \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb-1691707918243\",\r\n    \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb-1691707889297\",\r\n  ];\r\n}\r\n\r\nfunction filterInvalidArticlesIndexes(env, articlesIndexes) {\r\n  return (\r\n    articlesIndexes\r\n      .filter((articleIndex) => articleIndex.value.id) // Has id\r\n      .filter(\r\n        (articleIndex) =>\r\n          articleIndex.value.id.split(\"-\")[0] === articleIndex.accountId\r\n      ) // id begins with same accountId as index object\r\n      // .filter((articleIndex) =>\r\n      //   getWritersWhitelist(env).includes(articleIndex.accountId)\r\n      // ) // Account is in whitelist\r\n      .filter(\r\n        (articleIndex) =>\r\n          !getArticleBlackListByBlockHeight().includes(articleIndex.blockHeight) // Blockheight is not in blacklist\r\n      )\r\n      .filter(\r\n        (articleIndex) =>\r\n          !getArticleBlackListByRealArticleId().includes(articleIndex.value.id) // Article id is not in blacklist\r\n      )\r\n  );\r\n}\r\n\r\nfunction getLatestEdits(newFormatArticlesIndexes) {\r\n  return newFormatArticlesIndexes.filter((articleIndex) => {\r\n    const latestEditForThisArticle = newFormatArticlesIndexes.find(\r\n      (newArticleData) => newArticleData.value.id === articleIndex.value.id\r\n    );\r\n    return (\r\n      JSON.stringify(articleIndex) === JSON.stringify(latestEditForThisArticle)\r\n    );\r\n  });\r\n}\r\n\r\nfunction getArticle(articleIndex) {\r\n  const article = Social.get(\r\n    `${articleIndex.accountId}/${action}/main`,\r\n    articleIndex.blockHeight\r\n  );\r\n\r\n  let articleParsed = undefined;\r\n  if (article) {\r\n    articleParsed = JSON.parse(article);\r\n    articleParsed.blockHeight = articleIndex.blockHeight;\r\n    articleParsed.id = articleIndex.value.id;\r\n  }\r\n\r\n  if (articleParsed) {\r\n    return articleParsed;\r\n  }\r\n}\r\n\r\nfunction getOldArticleBasicDataArray(env) {\r\n  if (env === \"test\") {\r\n    return [\r\n      {\r\n        accountId:\r\n          \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n        blockHeight: 97325392,\r\n      },\r\n      {\r\n        accountId:\r\n          \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n        blockHeight: 97317287,\r\n      },\r\n      { accountId: \"ayelen.near\", blockHeight: 96927579 },\r\n      { accountId: \"kenrou-it.near\", blockHeight: 96924422 },\r\n      {\r\n        accountId:\r\n          \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n        blockHeight: 96879470,\r\n      },\r\n      {\r\n        accountId:\r\n          \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n        blockHeight: 96878182,\r\n      },\r\n      {\r\n        accountId:\r\n          \"f2bc8abdb8ba64fe5aac9689ded9491ff0e6fdcd7a5c680b7cf364142d1789fb\",\r\n        blockHeight: 96643643,\r\n      },\r\n      { accountId: \"silkking.near\", blockHeight: 96491128 },\r\n    ];\r\n  } else {\r\n    return [\r\n      { accountId: \"ozymandius.near\", blockHeight: 97329049 },\r\n      { accountId: \"fiftycent.near\", blockHeight: 97322138 },\r\n      { accountId: \"blaze.near\", blockHeight: 97255023 },\r\n      { accountId: \"jlw.near\", blockHeight: 97250015 },\r\n      { accountId: \"kazanderdad.near\", blockHeight: 96692435 },\r\n      // { accountId: \"blaze.near\", blockHeight: 96414482 },\r\n      // { accountId: \"blaze.near\", blockHeight: 96412953 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 96402919 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 96402476 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 96402330 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 96401880 },\r\n      { accountId: \"ozymandius.near\", blockHeight: 95810612 },\r\n      { accountId: \"blaze.near\", blockHeight: 95766756 },\r\n      { accountId: \"blaze.near\", blockHeight: 95766700 },\r\n      { accountId: \"jlw.near\", blockHeight: 95705034 },\r\n      { accountId: \"blaze.near\", blockHeight: 95413943 },\r\n      { accountId: \"blaze.near\", blockHeight: 94936576 },\r\n      { accountId: \"yuensid.near\", blockHeight: 94866690 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 94863580 },\r\n      { accountId: \"blaze.near\", blockHeight: 94801223 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 94344236 },\r\n      { accountId: \"sarahkornfeld.near\", blockHeight: 94188387 },\r\n      { accountId: \"jlw.near\", blockHeight: 93986868 },\r\n      { accountId: \"blaze.near\", blockHeight: 92999498 },\r\n    ];\r\n  }\r\n}\r\n\r\nfunction getNewFormatValidArticles(env) {\r\n  const articlesIndexes = getArticlesIndexes();\r\n\r\n  const validArticlesIndexes = filterInvalidArticlesIndexes(\r\n    env,\r\n    articlesIndexes\r\n  );\r\n\r\n  const validLatestEdits = getLatestEdits(validArticlesIndexes);\r\n\r\n  return validLatestEdits.map(getArticle);\r\n}\r\n\r\nfunction getOldFormatArticles(env) {\r\n  const oldBasicDataArray = getOldArticleBasicDataArray(env);\r\n  return oldBasicDataArray.map(getArticle);\r\n}\r\n\r\nfunction getLastEditArticles(props) {\r\n  const { env, sbtsNames } = props;\r\n  const oldFormatArticles = getOldFormatArticles(env);\r\n  const newFormatArticles = getNewFormatValidArticles(env);\r\n\r\n  const finalOldFormatArticles = oldFormatArticles.filter(\r\n    (oldFormatArticle) => {\r\n      return !newFormatArticles.find(\r\n        (newFormatArticle) => newFormatArticle.title === oldFormatArticle.title\r\n      );\r\n    }\r\n  );\r\n\r\n  const lastEditionArticles = newFormatArticles.concat(finalOldFormatArticles);\r\n\r\n  const validFormatLastEditionArticles =\r\n    convertArticlesTagsToValidFormat(lastEditionArticles);\r\n\r\n  const validFormatLastEditionArticlesAuthors =\r\n    validFormatLastEditionArticles.map((article) => {\r\n      return article.author;\r\n    });\r\n\r\n  setAreValidUsers(validFormatLastEditionArticlesAuthors, sbtsNames);\r\n  // const validAuthors = validFormatLastEditionArticlesAuthors.filter(\r\n  //   (author) => {\r\n  //     return state[`isValidUser-${author}`] === true;\r\n  //   }\r\n  // );\r\n  resultFunctionsToCall = resultFunctionsToCall.filter((call) => {\r\n    const discardCondition =\r\n      call.functionName === \"getLastEditArticles\" &&\r\n      state[`isValidUser-${call.props.accountId}`] !== undefined;\r\n    return !discardCondition;\r\n  });\r\n\r\n  const finalArticles = filterValidArticles(validFormatLastEditionArticles);\r\n\r\n  const finalArticlesMapped = {};\r\n  sbtsNames.forEach((sbtName) => {\r\n    const sbtArticles = finalArticles.filter((article) => {\r\n      if (!article.sbts) return false;\r\n      return article.sbts.indexOf(sbtName) !== -1;\r\n    });\r\n    finalArticlesMapped[sbtName] = sbtArticles;\r\n  });\r\n\r\n  return finalArticlesMapped;\r\n}\r\n\r\nfunction convertArticlesTagsToValidFormat(articlesArray) {\r\n  let validFormatArticlesArray = [];\r\n  articlesArray.map((article) => {\r\n    if (article) {\r\n      let tags = article.tags;\r\n\r\n      if (tags && !tags.length && tags + \"\" != \"0\") {\r\n        tags = Object.keys(tags);\r\n      } else if (tags === undefined) {\r\n        tags = [];\r\n      }\r\n      article.tags = tags;\r\n\r\n      validFormatArticlesArray.push(article);\r\n    }\r\n  });\r\n  return validFormatArticlesArray;\r\n}\r\n\r\nfunction filterValidator(articles) {\r\n  return articles.filter((article) => {\r\n    return (\r\n      article.sbts.find((articleSbt) => {\r\n        return state[`isValidUser-${article.author}`][articleSbt];\r\n      }) !== undefined\r\n    );\r\n\r\n    // return authors.includes(article.author);\r\n  });\r\n}\r\n\r\nfunction filterValidArticles(articles) {\r\n  let filteredArticles = filterValidator(filteredArticles ?? articles);\r\n\r\n  return filteredArticles;\r\n}\r\n\r\nfunction callFunction(call) {\r\n  if (call.functionName === \"canUserCreateArticle\") {\r\n    return canUserCreateArticle(call.props);\r\n  } else if (call.functionName === \"createArticle\") {\r\n    return createArticle(call.props);\r\n  } else if (call.functionName === \"canUserEditArticle\") {\r\n    return canUserEditArticle(call.props);\r\n  } else if (call.functionName === \"getLastEditArticles\") {\r\n    return getLastEditArticles(call.props);\r\n  }\r\n}\r\n\r\nif (functionsToCall && functionsToCall.length > 0) {\r\n  const updateObj = Object.assign({}, functionsToCallByLibrary);\r\n  resultFunctionsToCall = [...functionsToCall];\r\n  functionsToCall.forEach((call) => {\r\n    updateObj[call.key] = callFunction(call);\r\n  });\r\n\r\n  resultFunctionsToCallByLibrary.article = resultFunctionsToCall;\r\n  updateObj.functionsToCallByLibrary = resultFunctionsToCallByLibrary;\r\n  stateUpdate(updateObj);\r\n}\r\n\r\nreturn (\r\n  <>\r\n    {libSrcArray.map((src) => {\r\n      return callLibs(src, libStateUpdate, state.libsCalls, \"lib.article\");\r\n    })}\r\n  </>\r\n);\r\n", "metadata": null, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/silkking.near/widget/SayALot.lib.article", "fact_widget_deployments_id": "6b01b0e9374f2d1082db4969bf5827ab", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}