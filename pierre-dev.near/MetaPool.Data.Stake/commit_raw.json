{"tx_hash": "7FBkHCg2hXAoRSNULRaV3vLJMcxrnBagBoUjjngKQYbT", "action_id_social": "GwYNMzyNDefqarLiuLpShYLWjZRbW7dqDqGDFadSAnYZ-0-widget", "block_id": 96916488, "block_timestamp": "2023-07-20T13:15:28.978Z", "signer_id": "pierre-dev.near", "widget_name": "MetaPool.Data.Stake", "source_code": "const accountId = props.accountId || context.accountId;\nconst StNEAR_DECIMALS = 24;\nconst subgraphApiUrl =\n  context.networkId === \"mainnet\"\n    ? \"https://api.thegraph.com/subgraphs/name/linear-protocol/linear\"\n    : \"https://api.thegraph.com/subgraphs/name/linear-protocol/linear-testnet\";\n\nconst { config, onLoad } = props;\nif (!config) {\n  return \"Component cannot be loaded. Missing `config` props\";\n}\n\nfunction getStnearPrice() {\n  return Big(\n    Near.view(config.contractId, \"get_st_near_price\", \"{}\") ?? \"0\"\n  ).div(Big(10).pow(StNEAR_DECIMALS));\n}\n\nfunction querySubgraph(query, variables) {\n  const res = fetch(subgraphApiUrl, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      query,\n      variables,\n    }),\n  });\n  if (res && res.ok) {\n    return res.body;\n  } else {\n    return {};\n  }\n}\n\nfunction queryStakingData(accountId, excludingFees) {\n  const { data } = querySubgraph(`\n    {\n      users (first: 1, where: {id: \"${accountId}\"} ){\n        firstStakingTime\n        mintedLinear\n        stakedNear\n        unstakedLinear\n        unstakeReceivedNear\n        feesPaid\n        transferedInShares\n        transferedInValue\n        transferedOutShares\n        transferedOutValue\n      }\n    }\n  `);\n  if (!data) {\n    return undefined;\n  }\n  const user = data.users[0];\n  if (!user) {\n    return undefined;\n  }\n\n  const stnearPrice = getStnearPrice();\n  if (Number(stnearPrice) === 0) {\n    return undefined;\n  }\n\n  const {\n    firstStakingTime,\n    stakedNear,\n    mintedLinear,\n    unstakedLinear,\n    unstakeReceivedNear,\n    feesPaid,\n    transferedInShares,\n    transferedInValue,\n    transferedOutShares,\n    transferedOutValue,\n  } = user;\n\n  const transferIn = stnearPrice\n    .mul(transferedInShares)\n    .minus(transferedInValue);\n  const transferOut = stnearPrice\n    .mul(transferedOutShares)\n    .minus(transferedOutValue);\n  const netTransfer = transferIn.minus(transferOut);\n\n  const currentLinear = Big(mintedLinear).minus(unstakedLinear);\n  const rewards = currentLinear\n    .mul(stnearPrice)\n    .minus(stakedNear)\n    .plus(unstakeReceivedNear)\n    .plus(netTransfer);\n\n  return {\n    // turn nanoseconds into milliseconds\n    firstStakingTime: firstStakingTime\n      ? parseInt(firstStakingTime / 1_000_000)\n      : undefined,\n    // add fees if necessary\n    stakingRewards: (excludingFees ? rewards : rewards.plus(feesPaid)).toFixed(\n      0\n    ),\n  };\n}\n\nif (onLoad) {\n  const data = queryStakingData(accountId);\n  if (data) {\n    onLoad(data);\n  }\n}\n\nreturn <div style={{ display: \"none\" }} />;\n", "metadata": {"description": "StNEAR Stake Data. You can query staking rewards and the time of user's first staking to StNEAR with the `onLoad()` function.", "image": {"ipfs_cid": "bafkreici2aqxke5ogocdqlhlfqxygwicwynmyaa4b4jqiioqpltj25fhfu"}, "name": "Stake Data | StNEAR", "tags": {"component": "", "data": "", "defi": "", "stake": "", "stnear": "", "widget": ""}}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/pierre-dev.near/widget/MetaPool.Data.Stake", "fact_widget_deployments_id": "221d4e8300d4c3a311d1c801da3cc9ad", "inserted_timestamp": "2024-03-07T05:24:05.087Z", "modified_timestamp": "2024-03-07T05:24:05.087Z", "__row_index": 0}