{"tx_hash": "ANV5wPeEAeA24yjWye9kxLPqC2AQCDi5CEvCruSyYQj4", "action_id_social": "834eDVSXWGnCynLUHbEYHayKUcmZep6XabJhATNeubNL-0-widget", "block_id": 120471948, "block_timestamp": "2024-06-05T05:52:10.460Z", "signer_id": "linearprotocol.near", "widget_name": "LiNEAR.Data.Stake", "source_code": "// MIT License: https://github.com/linear-protocol/linear-bos-components/blob/main/LICENSE\n\nconst accountId = props.accountId || context.accountId;\nconst LiNEAR_DECIMALS = 24;\nconst subgraphApiUrl =\n  context.networkId === \"mainnet\"\n    ? \"https://gateway-arbitrum.network.thegraph.com/api/70c104a4cbe006bc60a3701a27d959bf/subgraphs/id/H5F5XGL2pYCBY89Ycxzafq2RkLfqJvM47X533CwwPNjg\"\n    : \"https://api.studio.thegraph.com/query/76854/linear-testnet/version/latest\";\n\nconst { config, onLoad } = props;\nif (!config) {\n  return \"Component cannot be loaded. Missing `config` props\";\n}\n\nfunction getLinearPrice() {\n  return Big(Near.view(config.contractId, \"ft_price\", \"{}\") ?? \"0\").div(\n    Big(10).pow(LiNEAR_DECIMALS)\n  );\n}\n\nfunction querySubgraph(query, variables) {\n  const res = fetch(subgraphApiUrl, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      query,\n      variables,\n    }),\n  });\n  if (res && res.ok) {\n    return res.body;\n  } else {\n    return {};\n  }\n}\n\nfunction queryStakingData(accountId, excludingFees) {\n  const { data } = querySubgraph(`\n    {\n      users (first: 1, where: {id: \"${accountId}\"} ){\n        firstStakingTime\n        mintedLinear\n        stakedNear\n        unstakedLinear\n        unstakeReceivedNear\n        feesPaid\n        transferedInShares\n        transferedInValue\n        transferedOutShares\n        transferedOutValue\n      }\n    }\n  `);\n  if (!data) {\n    return undefined;\n  }\n  const user = data.users[0];\n  if (!user) {\n    return undefined;\n  }\n\n  const linearPrice = getLinearPrice();\n  if (Number(linearPrice) === 0) {\n    return undefined;\n  }\n\n  const {\n    firstStakingTime,\n    stakedNear,\n    mintedLinear,\n    unstakedLinear,\n    unstakeReceivedNear,\n    feesPaid,\n    transferedInShares,\n    transferedInValue,\n    transferedOutShares,\n    transferedOutValue,\n  } = user;\n\n  const transferIn = linearPrice\n    .mul(transferedInShares)\n    .minus(transferedInValue);\n  const transferOut = linearPrice\n    .mul(transferedOutShares)\n    .minus(transferedOutValue);\n  const netTransfer = transferIn.minus(transferOut);\n\n  const currentLinear = Big(mintedLinear).minus(unstakedLinear);\n  const rewards = currentLinear\n    .mul(linearPrice)\n    .minus(stakedNear)\n    .plus(unstakeReceivedNear)\n    .plus(netTransfer);\n\n  return {\n    // turn nanoseconds into milliseconds\n    firstStakingTime: firstStakingTime\n      ? parseInt(firstStakingTime / 1_000_000)\n      : undefined,\n    // add fees if necessary\n    stakingRewards: (excludingFees ? rewards : rewards.plus(feesPaid)).toFixed(\n      0\n    ),\n  };\n}\n\nif (onLoad) {\n  const data = queryStakingData(accountId);\n  if (data) {\n    onLoad(data);\n  }\n}\n\nreturn <div style={{ display: \"none\" }} />;\n", "metadata": {"description": "LiNEAR Stake Data. You can query staking rewards and the time of user's first staking to LiNEAR with the `onLoad()` function.", "image": {"ipfs_cid": "bafkreici2aqxke5ogocdqlhlfqxygwicwynmyaa4b4jqiioqpltj25fhfu"}, "name": "Stake Data | LiNEAR", "tags": {"component": "", "data": "", "defi": "", "linear": "", "stake": "", "widget": ""}}, "branch": null, "widget_modules_used": null, "widget_url": "https://near.social/#/linearprotocol.near/widget/LiNEAR.Data.Stake", "fact_widget_deployments_id": "139d2b24c156c4bc62407be60088c908", "inserted_timestamp": "2024-06-05T07:09:13.127Z", "modified_timestamp": "2024-06-05T07:09:13.127Z", "__row_index": 0}